{"file_contents":{"server/llm/prompts_chat.ts":{"content":"export interface CommandParseContext {\n  activeBotKey: string | null;\n  availableBotKeys: string[];\n}\n\nexport function buildCommandParsePrompt(userMessage: string, context: CommandParseContext): string {\n  const botList = context.availableBotKeys.length > 0\n    ? context.availableBotKeys.join(\", \")\n    : \"(none)\";\n  const activeBot = context.activeBotKey || \"(none)\";\n\n  return `You are the \"command parser\" for a bot manager app. Convert the user's natural language request into one of the allowed commands (JSON) below.\nOutput JSON only. No explanatory sentences.\n\n[Output Schema]\n{\n  \"type\": \"list_bots | switch_bot | bot_status | run_now | pause_bot | resume_bot | add_source | remove_source | pipeline_run | chat\",\n  \"botKey\": \"bot key (null if none)\",\n  \"args\": {},\n  \"confidence\": 0.0~1.0,\n  \"needsConfirm\": true/false,\n  \"confirmText\": \"one-line execution summary to show the user\"\n}\n\n[Allowed Commands]\n1) list_bots: View my bot list. args: {}\n2) switch_bot: Switch the active bot for conversation. args: {}. botKey required.\n3) bot_status: Bot status/schedule/source summary. args: {}. botKey needed (uses active bot if not specified).\n4) run_now: Run a SINGLE step only (collect/analyze/draft/report). args: { \"job\": \"collect\" | \"analyze\" | \"draft\" | \"report\", \"lookbackHours\": number (report only), \"maxItems\": number (report only) }. botKey needed (uses active bot if not specified).\n5) pause_bot: Pause bot schedule. args: {}. botKey required.\n6) resume_bot: Resume bot schedule. args: {}. botKey required.\n7) add_source: Add RSS source. args: { \"url\": \"RSS URL\", \"name\": \"source name (optional)\" }. botKey needed (uses active bot if not specified).\n8) remove_source: Remove source. args: { \"sourceName\": \"source name or URL\" }. botKey needed (uses active bot if not specified).\n9) pipeline_run: Run the FULL pipeline (collect → analyze → report) in one command. Use this when the user wants to collect data AND analyze AND generate a report in a single request. If the user also mentions a schedule time, include it in args. args: { \"scheduleTimeLocal\": \"HH:MM\" (optional), \"scheduleRule\": \"DAILY\" | \"WEEKDAYS\" | \"WEEKENDS\" (optional, default DAILY), \"lookbackHours\": number (optional), \"maxItems\": number (optional) }. botKey needed (uses active bot if not specified).\n10) chat: General conversation or when the request does not match any command above. args: { \"reply\": \"natural language response\" }\n\n[Pipeline Detection Rules]\n- If the user mentions TWO or MORE of: collecting/gathering data, analyzing, generating report → use pipeline_run\n- Korean examples: \"수집하고 분석해서 리포트\", \"자료 모아서 정리해줘\", \"데이터 수집 후 보고서 만들어줘\"\n- Schedule parsing: \"아침 9시\" → scheduleTimeLocal: \"09:00\", \"오후 3시\" → \"15:00\", \"저녁 7시\" → \"19:00\", \"매일 아침\" → scheduleRule: \"DAILY\"\n- If ONLY one step is mentioned (e.g., just \"수집해줘\" or just \"리포트 만들어줘\"), use run_now instead\n\n[Rules]\n- If botKey is not specified and there is an active bot, use the active bot's key\n- confidence: 0.9 or higher if the request is clear, 0.5~0.7 if ambiguous\n- needsConfirm: true for data-changing commands (run_now, pause_bot, resume_bot, add_source, remove_source, pipeline_run). false for read-only commands (list_bots, bot_status). false for switch_bot.\n- confirmText: Keep it concise and user-friendly. For pipeline_run, use format like \"자료 수집 → 분석 → 리포트 생성 (09:00 매일)\"\n- For ambiguous or disallowed requests, use type=\"chat\"\n\n[Current State]\nActive bot: ${activeBot}\nAvailable bots: ${botList}\n\n[User Message]\n${userMessage}`;\n}\n\nexport function buildClarificationPrompt(userMessage: string, context: CommandParseContext): string {\n  const activeBot = context.activeBotKey || \"(none)\";\n  const botList = context.availableBotKeys.length > 0\n    ? context.availableBotKeys.join(\", \")\n    : \"(none)\";\n\n  return `You are a helper for a bot manager app. The user's request is ambiguous and you cannot determine the exact command.\nAsk a brief clarifying question in 1-2 sentences.\n\n[Current State]\nActive bot: ${activeBot}\nAvailable bots: ${botList}\n\n[User Message]\n${userMessage}\n\n[Available Commands]\nBot list, switch bot, bot status, run collect/analyze/draft/report, pause, resume, add source, remove source\n\nAsk a brief clarifying question:`;\n}\n","path":null,"size_bytes":4366,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"server/llm/prompts.ts":{"content":"export function buildAnalyzePrompt(input: {\n  title: string;\n  body: string;\n  sourceName: string;\n  sourceRules: string;\n  topic?: string;\n}) {\n  const topicLabel = (input.topic || \"general\").replace(/_/g, \" \");\n  return `\nYou are a research analyst specializing in ${topicLabel}.\nYour goal is to analyze content, extract key insights, and assess relevance.\nSource community rules are the top priority.\n\n[Input]\n- Source: ${input.sourceName}\n- Topic: ${topicLabel}\n- Rules(JSON): ${input.sourceRules}\n- Title: ${input.title}\n- Body:\n${input.body}\n\n[Output Format] Output only the JSON below (no explanations).\n{\n  \"category\": \"question|rant|tool_request|business|legal|ethics|showcase|other\",\n  \"summary_short\": \"One-line summary\",\n  \"summary_long\": \"3~6 line summary\",\n  \"relevance_score\": 0-100,\n  \"reply_worthiness_score\": 0-100,\n  \"link_fit_score\": 0-100,\n  \"risk_flags\": [\"promo_ban\",\"link_ban\",\"heated_topic\",\"new_account_risk\",\"unknown_rules\"],\n  \"recommended_action\": \"observe|draft|skip\",\n  \"suggested_angle\": \"What perspective would be helpful for the reply\"\n}\n\n[Score Guide]\n- relevance_score: Rate high if content is directly relevant to ${topicLabel}\n- reply_worthiness_score: Rate high if the question is specific and answers appear lacking\n- link_fit_score: Rate high for content seeking resource recommendations, rate low for debates\n- risk_flags: Must flag if rules restrict links/promotions (empty array if not applicable)\n- recommended_action:\n  - If relevance>=60 AND reply_worthiness>=60, then draft\n  - If risk is too high, then observe or skip\n`.trim();\n}\n\nexport interface SourceRules {\n  allowLinks?: boolean;\n  promoLevel?: \"none\" | \"subtle\" | \"moderate\";\n  preferredTone?: \"informative\" | \"curious\" | \"supportive\";\n  platform?: string;\n}\n\nconst TONE_PRESETS = {\n  informative: {\n    A: { tone: \"informative\", desc: \"Information sharing - fact-based, helpful information without links\" },\n    B: { tone: \"analytical\", desc: \"Analytical - objective comparison/analysis from a technical perspective\" },\n    C: { tone: \"educational\", desc: \"Educational - friendly and explanatory tone\" },\n  },\n  curious: {\n    A: { tone: \"curious\", desc: \"Light questioning - expressing interest, requesting additional info\" },\n    B: { tone: \"engaging\", desc: \"Conversational - naturally encouraging discussion\" },\n    C: { tone: \"supportive\", desc: \"Supportive - positive feedback and encouragement\" },\n  },\n  supportive: {\n    A: { tone: \"helpful\", desc: \"Helpful - providing specific advice and tips\" },\n    B: { tone: \"encouraging\", desc: \"Encouraging - praising work and cheering progress\" },\n    C: { tone: \"comparative\", desc: \"Comparative - subtly comparing alternatives/tools (minimal promotion)\" },\n  },\n};\n\nexport function buildDraftPrompt(input: {\n  title: string;\n  body: string;\n  analysisJson: string;\n  allowLink: boolean;\n  baseUrl: string;\n  sourceRules?: SourceRules;\n}) {\n  const rules = input.sourceRules || {};\n  const preferredTone = rules.preferredTone || \"informative\";\n  const promoLevel = rules.promoLevel || \"none\";\n  const platform = rules.platform || \"community\";\n  const tonePreset = TONE_PRESETS[preferredTone] || TONE_PRESETS.informative;\n\n  const promoGuidance = {\n    none: \"Do not mention maker. Provide pure information only.\",\n    subtle: \"Mention only about 1 in 10 times, very naturally at the level of 'by the way.'\",\n    moderate: \"May mention maker.am if contextually appropriate, but without sounding like an ad.\",\n  }[promoLevel];\n\n  return `\nYou are a knowledgeable contributor on this platform.\nPlatform: ${platform}\nWrite short, natural responses that fit the context.\nVary sentence structure so it doesn't look copy-pasted.\nNo aggressive/exaggerated advertising.\n\n[Reference: 3 lines about maker]\n- maker.am aims to facilitate trading of digital assets such as AI-generated art/prompts/templates.\n- The core focus is simplifying the sell/buy/license/settlement workflow.\n- Never mention features that don't exist.\n\n[Input]\nTitle: ${input.title}\nBody:\n${input.body}\n\nAnalysis(JSON):\n${input.analysisJson}\n\nLink allowed: ${input.allowLink ? \"YES\" : \"NO\"}\nBase URL: ${input.baseUrl}\nPromo guide: ${promoGuidance}\n\n[Tone Presets - ${preferredTone}]\n- Variant A: ${tonePreset.A.tone} - ${tonePreset.A.desc}\n- Variant B: ${tonePreset.B.tone} - ${tonePreset.B.desc}\n- Variant C: ${tonePreset.C.tone} - ${tonePreset.C.desc}\n\n[Output]\nOutput only the JSON below.\n{\n  \"drafts\": [\n    {\"variant\":\"A\",\"tone\":\"${tonePreset.A.tone}\",\"includes_link\":true/false,\"text\":\"...\"},\n    {\"variant\":\"B\",\"tone\":\"${tonePreset.B.tone}\",\"includes_link\":true/false,\"text\":\"...\"},\n    {\"variant\":\"C\",\"tone\":\"${tonePreset.C.tone}\",\"includes_link\":true/false,\"text\":\"...\"}\n  ],\n  \"notes\": \"1~2 lines of caution\"\n}\n\n[Link Rules]\n- If link allowed is NO, never include any links/domains/call-to-action phrases.\n- Even if YES, adjust according to the promo guide.\n`.trim();\n}\n\nexport function buildRewritePrompt(input: { text: string; style: string }) {\n  return `\nRewrite the following text in a \"${input.style}\" style, keeping it short and natural.\nNo exaggeration/advertising/imperative expressions. Make the sentence flow smooth.\nOutput only the result.\n\n[Original]\n${input.text}\n`.trim();\n}\n\n// ============================================\n// AI Art Community Contribution Mode (0% promotion - pure help only)\n// ============================================\n\nexport function buildAiArtCommunityAnalyzePrompt(input: {\n  title: string;\n  body: string;\n  sourceName: string;\n}) {\n  return `\nYou are a neutral moderator of the AI art community.\nEvaluate whether the post below is \"worth participating in with a helpful reply.\"\n\nCriteria:\n- Questions, workflow discussions, tool comparisons, tip requests, experience sharing posts -> High reply value\n- Controversies (copyright, ethics, politics, hate, flame bait) -> High risk\n- Obvious ads/spam -> Low reply value\n\nImportant rules:\n- Do not evaluate promotion potential or link insertion potential.\n- Judge only from a \"community contribution perspective.\"\n\nOutput only JSON:\n{\n  \"category\": \"tool|workflow|prompt|question|discussion|news|other\",\n  \"relevance_score\": 0-100,\n  \"reply_worthiness_score\": 0-100,\n  \"link_fit_score\": 0,\n  \"risk_flags\": [\"copyright\",\"toxic\",\"politics\",\"spam\",\"drama\"] whichever apply,\n  \"recommended_action\": \"draft|observe|skip\",\n  \"suggested_angle\": \"One line describing what perspective would make a helpful reply\",\n  \"summary_short\": \"One-line summary\",\n  \"summary_long\": \"3~4 line summary\"\n}\n\nNote: link_fit_score is always 0 in community contribution mode. Links are not included.\nIf recommended_action is \"draft,\" the post is worth replying to; \"observe\" means watch; \"skip\" means ignore.\n\n[Title]\n${input.title}\n\n[Body]\n${input.body}\n\n[Source]\n${input.sourceName}\n`.trim();\n}\n\nexport function buildAiArtCommunityDraftPrompt(input: {\n  title: string;\n  body: string;\n  suggestedAngle: string;\n}) {\n  return `\nYou are a regular user active in the AI art community.\nWrite a \"helpful reply\" to the post below.\n\nAbsolute rules:\n- Do not include any links.\n- Do not mention any service, website, product, or brand.\n- Do not use a promotional, marketing, or recommendation tone.\n- Just share experience/knowledge/tips like a fellow community member.\n\nWriting guide:\n- 1 sentence of empathy or problem summary\n- 2~4 sentences of specific tips/methods/perspectives\n- 1~2 sentences of caveats or alternatives if possible\n- Length: 4~8 sentences\n- Tone: friendly, calm, practical\n- Write in English (for HN/Reddit/Moltbook)\n\n[Post Title]\n${input.title}\n\n[Post Content]\n${input.body}\n\n[Reply Direction Hint]\n${input.suggestedAngle}\n\n[Output Format]\nOutput only JSON:\n{\n  \"drafts\": [\n    {\"variant\":\"A\",\"tone\":\"helpful\",\"includes_link\":false,\"text\":\"Experience-based helpful reply\"},\n    {\"variant\":\"B\",\"tone\":\"analytical\",\"includes_link\":false,\"text\":\"Technical analysis/comparison reply\"},\n    {\"variant\":\"C\",\"tone\":\"supportive\",\"includes_link\":false,\"text\":\"Empathetic + encouraging reply\"}\n  ],\n  \"notes\": \"1~2 lines of caution when replying to this post\"\n}\n\nFollow these rules strictly when drafting the reply.\n`.trim();\n}\n\n// ============================================\n// Analysis Result Types\n// ============================================\n\nexport interface AnalysisResult {\n  category: string;\n  summary_short: string;\n  summary_long: string;\n  relevance_score: number;\n  reply_worthiness_score: number;\n  link_fit_score: number;\n  risk_flags: string[];\n  recommended_action: string;\n  suggested_angle: string;\n}\n\nexport interface DraftResult {\n  drafts: Array<{\n    variant: string;\n    tone: string;\n    includes_link: boolean;\n    text: string;\n  }>;\n  notes: string;\n}\n\n// Daily Brief Prompts\n\nexport function buildAIArtBriefPrompt(items: any[], date: string): string {\n  const itemsData = items.map((item) => ({\n    title: item.title,\n    source: item.source,\n    url: item.url,\n    key_takeaway: item.key_takeaway,\n    why_it_matters: item.why_it_matters,\n    category: item.category,\n    risk_flags: item.risk_flags,\n    confidence: item.confidence,\n  }));\n\n  return `You are a researcher analyzing the AI Art marketplace and creator community.\nYour goal is to write a Daily Brief summarizing **trends, tools, and community developments** in the AI art ecosystem.\nFocus on technical advancements, new tools, community reactions, and market opportunities.\nInclude sources (URLs) and avoid exaggeration/speculation/definitive statements.\n\nInput Data:\nThe following is a list of AI Art-related posts collected and analyzed over the past 24 hours:\n\n${JSON.stringify(itemsData, null, 2)}\n\nToday's date: ${date}\n\nOutput Format:\n\nAI Art Daily Brief - ${date}\n\nThis report is intended for informational purposes about AI art ecosystem trends.\n\nTL;DR (One-line summary of today)\n- Summarize today's key AI Art scene developments in one sentence.\n\nKey Trends (3~5)\nFollow this format for each trend:\n\n1) Trend Title\n- What happened: Fact-based summary (2~3 sentences)\n- Why it matters: Explain the impact on creators/market\n- Related area: Image generation/Video/Music/Tools/Platforms/Community (whichever applies)\n- Opportunity/Risk: Opportunities creators can leverage or points of caution\n- Source: Source - URL\n\nTools/Technology Updates\n- Summarize new AI art tools, model updates, and platform changes\n- 2~3 lines per item\n\nCommunity Highlights\n- Summarize trending works, debates, and discussions from Reddit, HN, etc.\n- 2~3 lines per item\n\nWeekly Checkpoints\n- Notable events, contests, upcoming tool launches, etc. (~5 items)\n\nSources\n- List of post links used in this report\n\nWriting Rules:\n- Focus on AI art creation, editing, and workflow-related content\n- Provide practical insights from a creator's perspective\n- Balance coverage of technical advancements and community reactions\n- Exclude investment/finance-related content\n- Write factually without exaggeration`;\n}\n\nexport function buildInvestingBriefPrompt(items: any[], date: string): string {\n  const itemsData = items.map((item) => ({\n    title: item.title,\n    source: item.source,\n    url: item.url,\n    key_takeaway: item.key_takeaway,\n    why_it_matters: item.why_it_matters,\n    impact_scope: item.impact_scope,\n    risk_flags: item.risk_flags,\n    confidence: item.confidence,\n  }));\n\n  return `You are a senior macro & markets research analyst.\nWrite a daily market brief for investors based only on the provided analyzed items.\nPrioritize credibility, macro context, policy impact, and cross-market linkages.\nAvoid hype, price predictions, and trading advice.\nUse neutral, analytical tone.\n\nImportant - Data Filtering:\nThe following content must be excluded from the input data:\n- AI art, image generation, creative tool-related content\n- Reddit community discussions, Show HN project introductions\n- Technology news not directly related to investing/finance/macroeconomics\n\nOnly cover content directly related to stocks, interest rates, currencies, crypto, commodities, and macroeconomics.\n\nInput Data:\nThe following is a list of investment-related articles collected and analyzed over the past 24~48 hours:\n\n${JSON.stringify(itemsData, null, 2)}\n\nToday's date: ${date}\n\nOutput Format (must be in English):\n\nDaily Market Brief - ${date}\n\nThis report is for informational purposes only and does not constitute investment advice.\n\nTL;DR (One-line summary of today)\n- Summarize today's market sentiment in 1~2 lines\n\nMarket Drivers (3~5 Key Issues)\nFor each issue:\n\n1) Issue Title\n- What happened: Fact-based summary (2~3 sentences)\n- Why it matters: Explain the structural impact on markets (2~3 sentences)\n- Impact scope: Specify relevant asset classes such as stocks/bonds/crypto/currencies/commodities\n- Risk/Uncertainty: 1~2 lines on possible risks or counter-scenarios\n- Source: Source Name - URL\n\nCross-Market View (Cross-asset linkages)\n- Explain connections between stocks, rates, dollar, crypto, and commodities\n- Analyze how today's issues could have ripple effects across other asset classes\n\nRisk Radar (Key Risks)\n- Summarize 2~3 short-term risks\n- Each item 2~3 lines, focused on \"why it's a risk\"\n\nChecklist (Today/This Week Checkpoints)\n- Policy schedules, data releases, geopolitical events, etc.\n- E.g.: CPI release, FOMC speeches, major earnings, options expiry, regulatory issues, etc.\n\nSources\n- List of key sources used\n\nWriting Rules:\n- No investment directives/definitive statements like \"buy,\" \"sell,\" \"will rise,\" \"will fall\"\n- Use conditional/scenario language like \"may,\" \"there is a possibility\"\n- Focus on explaining \"why the market is reacting to this news\"\n- Prioritize policy/rates/capital flows/risk\n- Clearly distinguish facts / interpretation / risk\n- Reduce weight for items with risk_flags like rumor, low_credibility, opinion_only\n- Do not promote items with low confidence to key issues\n- No exaggerated, emotional, or clickbait tone\n- Prioritize structural factors such as numbers/policy/earnings/rates/regulations\n- Exclude or minimize YouTube/community speculation\n\nSelection Criteria (Internal judgment):\n- Priority: Market structural changes (rates, policy, regulation, liquidity) > Corporate earnings/sector impact > Macro/geopolitical/energy risk > Crypto institutional/ETF/regulation/fundamentals\n- Prefer articles that explain causes and effects over those focused on short-term price predictions`;\n}\n\n// Import ProfileConfig from schema - define locally for compatibility\n// Note: Using local definition to avoid module resolution issues with tsx\nexport interface ReportConfig {\n  scheduleRule?: \"DAILY\" | \"WEEKDAYS\" | \"WEEKENDS\";\n  sections?: {\n    tldr?: boolean;\n    drivers?: boolean;\n    risk?: boolean;\n    checklist?: boolean;\n    sources?: boolean;\n  };\n  verbosity?: \"short\" | \"normal\" | \"detailed\";\n  markdownLevel?: \"minimal\" | \"normal\";\n  filters?: {\n    minImportanceScore?: number;\n    maxRiskLevelAllowed?: number;\n    allowPromotionLinks?: boolean;\n  };\n}\n\nfunction getVerbosityInstructions(verbosity: string): string {\n  switch (verbosity) {\n    case \"short\":\n      return \"Write concisely. Keep each section to 2~3 lines. Deliver only the essentials.\";\n    case \"detailed\":\n      return \"Write in detail. Include rich background explanations, analysis, and context.\";\n    default:\n      return \"Write at an appropriate length. Cover important content in detail and supplementary content briefly.\";\n  }\n}\n\nfunction getMarkdownInstructions(level: string): string {\n  switch (level) {\n    case \"minimal\":\n      return `Write in a conversational tone like a news anchor. Specific rules:\n- Do not use heavy markdown syntax like ## **\n- Use only a simple title (# or a short text label) for section separation\n- No bold (**), italic (*), or tables\n- Use only simple dashes (-) for lists\n- Write in flowing sentences. It should read like a \"briefing,\" not a \"document\"\n- No emojis or special symbols. Use only plain text and dashes (-)`;\n    default:\n      return \"Use standard markdown: freely use headings, bold, lists, etc.\";\n  }\n}\n\nfunction getSectionInstructions(sections: ReportConfig[\"sections\"], topic: string): string {\n  const defaultSections = { tldr: true, drivers: true, risk: true, checklist: true, sources: true };\n  const s = { ...defaultSections, ...sections };\n  \n  const sectionMaps: Record<string, Record<string, string>> = {\n    investing: {\n      tldr: \"TL;DR (One-line summary of today)\",\n      drivers: \"Market Drivers (3~5 Key Issues) + Cross-Market View\",\n      risk: \"Risk Radar (Key Risks)\",\n      checklist: \"Checklist (Today/This Week Checkpoints)\",\n      sources: \"Sources (Source List)\",\n    },\n    ai_art: {\n      tldr: \"TL;DR (One-line summary of today)\",\n      drivers: \"Key Trends (3~5) + Tools/Technology Updates + Community Highlights\",\n      risk: \"Cautions/Risks\",\n      checklist: \"Weekly Checkpoints\",\n      sources: \"Sources (Source List)\",\n    },\n  };\n  const defaultSectionMap = {\n    tldr: \"TL;DR (One-line summary of today)\",\n    drivers: \"Key Developments (3~5 Key Topics)\",\n    risk: \"Risks & Cautions\",\n    checklist: \"Action Items / Checkpoints\",\n    sources: \"Sources (Source List)\",\n  };\n  const sectionMap = sectionMaps[topic] || defaultSectionMap;\n\n  const includedSections = Object.entries(sectionMap)\n    .filter(([key]) => s[key as keyof typeof s])\n    .map(([, label]) => `- ${label}`)\n    .join(\"\\n\");\n\n  const excludedSections = Object.entries(sectionMap)\n    .filter(([key]) => !s[key as keyof typeof s])\n    .map(([, label]) => label);\n\n  let instructions = `Sections to include:\\n${includedSections}`;\n  if (excludedSections.length > 0) {\n    instructions += `\\n\\nSections to exclude (do not write):\\n${excludedSections.map(s => `- ${s}`).join(\"\\n\")}`;\n  }\n  \n  return instructions;\n}\n\nconst TOPIC_META: Record<string, { label: string; role: string; focus: string; disclaimer: string; excludeFilter?: string }> = {\n  investing: {\n    label: \"Daily Market Brief\",\n    role: \"a senior macro & markets research analyst\",\n    focus: \"market trends, policy impact, macro context, and cross-market linkages. Prioritize credibility and analytical rigor.\",\n    disclaimer: \"This report is for informational purposes only and does not constitute investment advice.\",\n    excludeFilter: \"Exclude AI art, image generation, creative tools, Reddit community discussions, and Show HN projects. Only cover stocks, interest rates, currencies, crypto, commodities, and macroeconomics.\",\n  },\n  ai_art: {\n    label: \"AI Art Daily Brief\",\n    role: \"a researcher analyzing the AI Art marketplace and creator community\",\n    focus: \"trends, tools, and community developments in the AI art ecosystem. Focus on technical advancements, new tools, community reactions, and market opportunities.\",\n    disclaimer: \"This report is intended for informational purposes about AI art ecosystem trends.\",\n    excludeFilter: \"Exclude investment/finance-related content. Focus on AI art creation, editing, and workflow-related content.\",\n  },\n  content_research: {\n    label: \"Content Research Brief\",\n    role: \"a content strategist and research analyst\",\n    focus: \"content trends, creative ideas, research insights, and emerging topics. Focus on actionable insights for content creators and researchers.\",\n    disclaimer: \"This report summarizes content research trends and insights.\",\n  },\n  market_brief: {\n    label: \"Market Brief\",\n    role: \"a market research analyst\",\n    focus: \"market movements, economic indicators, sector performance, and notable business developments.\",\n    disclaimer: \"This report is for informational purposes only.\",\n  },\n  research_watch: {\n    label: \"Research Watch Brief\",\n    role: \"an academic research analyst\",\n    focus: \"notable research papers, technical breakthroughs, methodology advances, and emerging research directions.\",\n    disclaimer: \"This report summarizes recent research developments.\",\n  },\n  competitor_watch: {\n    label: \"Competitor Watch Brief\",\n    role: \"a competitive intelligence analyst\",\n    focus: \"competitor moves, product launches, strategic shifts, market positioning changes, and industry signals.\",\n    disclaimer: \"This report summarizes competitive intelligence insights.\",\n  },\n  community_research: {\n    label: \"Community Research Brief\",\n    role: \"a community research analyst monitoring online discussions and trends\",\n    focus: \"community discussions, emerging topics, user sentiment, notable threads, and actionable insights from online communities and forums.\",\n    disclaimer: \"This report summarizes community research insights.\",\n  },\n  online_business: {\n    label: \"Online Business Market Research Report\",\n    role: \"a market research analyst specializing in e-commerce, online retail, and small brand strategy\",\n    focus: \"customer complaints and hesitation signals, recurring market patterns, competitive positioning gaps, actionable improvement areas, and content strategy hints. Prioritize practical, execution-ready insights over abstract trends. Tone: practical, calm, judgment-focused, no exaggeration.\",\n    disclaimer: \"This report is for informational reference only. All strategic decisions should be reviewed by the user before execution.\",\n    excludeFilter: \"Exclude generic motivational content, get-rich-quick schemes, and affiliate marketing promotions. Focus on real customer signals, market data, and operational insights.\",\n  },\n  korea_marketplace: {\n    label: \"Korea Marketplace Research Report\",\n    role: \"a market research analyst specializing in Korean open marketplaces (Coupang, Naver SmartStore) and small-to-mid seller strategy\",\n    focus: \"recurring customer complaints, pricing pressure signals, review-based improvement opportunities, seller operational pain points, and niche demand gaps. Prioritize practical, execution-ready insights. Do not promote products, guarantee profits, or use motivational language. Tone: calm, analytical, judgment-focused.\",\n    disclaimer: \"이 리포트는 정보 참고용입니다. 모든 전략적 판단은 사용자가 직접 검토한 후 실행해야 합니다.\",\n    excludeFilter: \"Exclude generic motivational content, get-rich-quick schemes, affiliate marketing promotions, and automated selling pitches. Focus on real customer signals, market data, and operational insights from Korean marketplace ecosystems.\",\n  },\n  work_productivity: {\n    label: \"Work & Productivity Brief\",\n    role: \"a productivity and operations research analyst\",\n    focus: \"productivity tips, operational know-how, practical ideas, tool recommendations, and workflow improvements for solo operators and small teams.\",\n    disclaimer: \"This report summarizes productivity and work-related insights.\",\n  },\n};\n\nexport function getTopicLabel(topic: string): string {\n  return getTopicMeta(topic).label;\n}\n\nfunction getTopicMeta(topic: string) {\n  return TOPIC_META[topic] || {\n    label: `${topic.replace(/_/g, \" \").replace(/\\b\\w/g, c => c.toUpperCase())} Brief`,\n    role: \"a research analyst\",\n    focus: `trends, developments, and key insights related to ${topic.replace(/_/g, \" \")}. Provide actionable, well-sourced analysis.`,\n    disclaimer: \"This report is for informational purposes only.\",\n  };\n}\n\nfunction buildUserRulesBlock(userRules?: Record<string, any>): string {\n  if (!userRules || Object.keys(userRules).length === 0) return \"\";\n  const lines: string[] = [];\n  for (const [key, value] of Object.entries(userRules)) {\n    const displayVal = typeof value === \"string\" ? value : JSON.stringify(value);\n    lines.push(`- ${key}: ${displayVal}`);\n  }\n  return `\\nUser Rules & Preferences (apply these to the output):\\n${lines.join(\"\\n\")}\\n`;\n}\n\nexport function buildDailyBriefPrompt(items: any[], date: string, topic: string, config?: ReportConfig, userRules?: Record<string, any>): string {\n  if (topic === \"investing\") {\n    return buildInvestingBriefPromptWithConfig(items, date, config, userRules);\n  }\n  return buildGenericBriefPrompt(items, date, topic, config, userRules);\n}\n\nfunction buildInvestingBriefPromptWithConfig(items: any[], date: string, config?: ReportConfig, userRules?: Record<string, any>): string {\n  const verbosity = config?.verbosity || \"normal\";\n  const markdownLevel = config?.markdownLevel || \"minimal\";\n  const sections = config?.sections;\n\n  const itemsData = items.map((item) => ({\n    title: item.title,\n    source: item.source,\n    url: item.url,\n    key_takeaway: item.key_takeaway,\n    why_it_matters: item.why_it_matters,\n    impact_scope: item.impact_scope,\n    risk_flags: item.risk_flags,\n    confidence: item.confidence,\n  }));\n\n  return `You are a senior macro & markets research analyst.\nWrite a daily market brief for investors based only on the provided analyzed items.\nPrioritize credibility, macro context, policy impact, and cross-market linkages.\nAvoid hype, price predictions, and trading advice.\nUse neutral, analytical tone.\n\nUser Settings:\n${getVerbosityInstructions(verbosity)}\n${getMarkdownInstructions(markdownLevel)}\n\n${getSectionInstructions(sections, \"investing\")}\n${buildUserRulesBlock(userRules)}\nImportant - Data Filtering:\nThe following content must be excluded from the input data:\n- AI art, image generation, creative tool-related content\n- Reddit community discussions, Show HN project introductions\n- Technology news not directly related to investing/finance/macroeconomics\n\nOnly cover content directly related to stocks, interest rates, currencies, crypto, commodities, and macroeconomics.\n\nInput Data:\nThe following is a list of investment-related articles collected and analyzed over the past 24~48 hours:\n\n${JSON.stringify(itemsData, null, 2)}\n\nToday's date: ${date}\n\nOutput Format (must be in English):\n\nDaily Market Brief - ${date}\n\nThis report is for informational purposes only and does not constitute investment advice.\n\n(Output only the configured sections)\n\nWriting Rules:\n- No investment directives/definitive statements like \"buy,\" \"sell,\" \"will rise,\" \"will fall\"\n- Use conditional/scenario language like \"may,\" \"there is a possibility\"\n- Focus on explaining \"why the market is reacting to this news\"\n- Prioritize policy/rates/capital flows/risk\n- Clearly distinguish facts / interpretation / risk\n- Reduce weight for items with risk_flags like rumor, low_credibility, opinion_only\n- Do not promote items with low confidence to key issues\n- No exaggerated, emotional, or clickbait tone`;\n}\n\nfunction buildGenericBriefPrompt(items: any[], date: string, topic: string, config?: ReportConfig, userRules?: Record<string, any>): string {\n  const verbosity = config?.verbosity || \"normal\";\n  const markdownLevel = config?.markdownLevel || \"minimal\";\n  const sections = config?.sections;\n  const meta = getTopicMeta(topic);\n\n  const itemsData = items.map((item) => ({\n    title: item.title,\n    source: item.source,\n    url: item.url,\n    key_takeaway: item.key_takeaway,\n    why_it_matters: item.why_it_matters,\n    category: item.category,\n    risk_flags: item.risk_flags,\n    confidence: item.confidence,\n  }));\n\n  const filterBlock = meta.excludeFilter ? `\\nImportant - Data Filtering:\\n${meta.excludeFilter}\\n` : \"\";\n\n  return `You are ${meta.role}.\nYour goal is to write a Daily Brief summarizing ${meta.focus}\nInclude sources (URLs) and avoid exaggeration/speculation/definitive statements.\n\nUser Settings:\n${getVerbosityInstructions(verbosity)}\n${getMarkdownInstructions(markdownLevel)}\n\n${getSectionInstructions(sections, topic)}\n${buildUserRulesBlock(userRules)}\n${filterBlock}\nInput Data:\nThe following is a list of posts collected and analyzed over the past 24 hours:\n\n${JSON.stringify(itemsData, null, 2)}\n\nToday's date: ${date}\n\nOutput Format:\n\n${meta.label} - ${date}\n\n${meta.disclaimer}\n\n(Output only the configured sections)\n\nWriting Rules:\n- Provide practical, actionable insights\n- Balance coverage of developments and their implications\n- Write factually without exaggeration\n- Reduce weight for items with risk_flags like rumor, low_credibility, opinion_only\n- Do not promote items with low confidence to key issues`;\n}\n","path":null,"size_bytes":27958,"size_tokens":null},"client/src/pages/item-detail.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport {\n  ArrowLeft,\n  ExternalLink,\n  Copy,\n  Check,\n  AlertTriangle,\n  ThumbsUp,\n  ThumbsDown,\n  SkipForward,\n  RefreshCw,\n  Link2Off,\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\ninterface ItemDetail {\n  id: number;\n  title: string;\n  url: string;\n  contentText: string;\n  status: string;\n  author: string;\n  insertedAt: string;\n  sourceName: string;\n  analysis?: {\n    category: string;\n    relevanceScore: number;\n    replyWorthinessScore: number;\n    linkFitScore: number;\n    riskFlagsJson: string[];\n    recommendedAction: string;\n    suggestedAngle: string;\n    summaryShort: string;\n    summaryLong: string;\n  };\n  drafts: {\n    id: number;\n    variant: string;\n    draftText: string;\n    includesLink: boolean;\n    tone: string;\n    adminDecision: string;\n    finalText?: string;\n  }[];\n}\n\nexport default function ItemDetailPage() {\n  const { t } = useLanguage();\n  const [, params] = useRoute(\"/items/:id\");\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const [selectedDraft, setSelectedDraft] = useState<string>(\"A\");\n  const [editedText, setEditedText] = useState<string>(\"\");\n  const [copied, setCopied] = useState(false);\n\n  const itemId = params?.id ? parseInt(params.id) : null;\n\n  const { data: item, isLoading } = useQuery<ItemDetail>({\n    queryKey: [\"/api/items\", itemId],\n    enabled: itemId !== null,\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async ({ draftId, finalText }: { draftId: number; finalText: string }) => {\n      return apiRequest(\"POST\", `/api/drafts/${draftId}/approve`, { finalText });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/items\", itemId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({ title: t(\"itemDetail.approvedSuccess\") });\n    },\n    onError: () => {\n      toast({ title: t(\"itemDetail.approveFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async (draftId: number) => {\n      return apiRequest(\"POST\", `/api/drafts/${draftId}/reject`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/items\", itemId] });\n      toast({ title: t(\"itemDetail.rejectedSuccess\") });\n    },\n    onError: () => {\n      toast({ title: t(\"itemDetail.rejectFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const skipMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", `/api/items/${itemId}/skip`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/items\", itemId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({ title: t(\"itemDetail.skipped\") });\n    },\n    onError: () => {\n      toast({ title: t(\"itemDetail.skipFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const reanalyzeMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", `/api/items/${itemId}/reanalyze`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/items\", itemId] });\n      toast({ title: t(\"itemDetail.reanalysis\") });\n    },\n    onError: () => {\n      toast({ title: t(\"itemDetail.reanalysisFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const currentDraft = item?.drafts?.find((d) => d.variant === selectedDraft);\n\n  const handleCopy = async (text: string) => {\n    await navigator.clipboard.writeText(text);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n    toast({ title: t(\"itemDetail.copiedToClipboard\") });\n  };\n\n  const handleApprove = () => {\n    if (currentDraft) {\n      const finalText = editedText || currentDraft.draftText;\n      approveMutation.mutate({ draftId: currentDraft.id, finalText });\n    }\n  };\n\n  const removeLinks = (text: string) => {\n    return text\n      .replace(/https?:\\/\\/[^\\s]+/g, \"\")\n      .replace(/maker\\.am/gi, \"\")\n      .replace(/\\s+/g, \" \")\n      .trim();\n  };\n\n  const riskFlagKey = (flag: string) => {\n    const key = `itemDetail.riskFlag.${flag}`;\n    const translated = t(key);\n    return translated !== key ? translated : flag;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <Skeleton className=\"h-8 w-48\" />\n        <Skeleton className=\"h-64 w-full\" />\n        <Skeleton className=\"h-64 w-full\" />\n      </div>\n    );\n  }\n\n  if (!item) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-lg font-medium\">{t(\"itemDetail.notFound\")}</p>\n          <Link href=\"/items\">\n            <Button variant=\"outline\" className=\"mt-4\">\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n              {t(\"itemDetail.backToItems\")}\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center gap-4\">\n        <Link href=\"/items\">\n          <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-back\">\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Button>\n        </Link>\n        <div className=\"flex-1 min-w-0\">\n          <h1 className=\"text-xl font-bold truncate\" data-testid=\"text-item-title\">\n            {item.title || t(\"common.untitled\")}\n          </h1>\n          <div className=\"flex flex-wrap items-center gap-2 mt-1 text-sm text-muted-foreground\">\n            <span>{item.sourceName}</span>\n            {item.author && <span>{t(\"itemDetail.by\", { author: item.author })}</span>}\n            <span>{format(new Date(item.insertedAt), \"MMM d, yyyy HH:mm\")}</span>\n          </div>\n        </div>\n        <a\n          href={item.url}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"shrink-0\"\n        >\n          <Button variant=\"outline\" size=\"sm\" data-testid=\"button-view-original\">\n            <ExternalLink className=\"h-4 w-4 mr-2\" />\n            {t(\"itemDetail.original\")}\n          </Button>\n        </a>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">{t(\"itemDetail.originalContent\")}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n              <p className=\"whitespace-pre-wrap text-sm\">{item.contentText}</p>\n            </div>\n          </CardContent>\n        </Card>\n\n        {item.analysis && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">{t(\"itemDetail.analysis\")}</CardTitle>\n              <CardDescription>{item.analysis.summaryShort}</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-3 gap-3\">\n                <div className=\"text-center p-3 rounded-md bg-muted\">\n                  <div className=\"text-2xl font-bold\">{item.analysis.relevanceScore}</div>\n                  <div className=\"text-xs text-muted-foreground\">{t(\"itemDetail.relevance\")}</div>\n                </div>\n                <div className=\"text-center p-3 rounded-md bg-muted\">\n                  <div className=\"text-2xl font-bold\">{item.analysis.replyWorthinessScore}</div>\n                  <div className=\"text-xs text-muted-foreground\">{t(\"itemDetail.replyScore\")}</div>\n                </div>\n                <div className=\"text-center p-3 rounded-md bg-muted\">\n                  <div className=\"text-2xl font-bold\">{item.analysis.linkFitScore}</div>\n                  <div className=\"text-xs text-muted-foreground\">{t(\"itemDetail.linkFit\")}</div>\n                </div>\n              </div>\n\n              <div className=\"flex flex-wrap gap-2\">\n                <Badge variant=\"secondary\">{item.analysis.category}</Badge>\n                <Badge variant={item.analysis.recommendedAction === \"draft\" ? \"default\" : \"outline\"}>\n                  {item.analysis.recommendedAction}\n                </Badge>\n              </div>\n\n              {item.analysis.riskFlagsJson && item.analysis.riskFlagsJson.length > 0 && (\n                <div className=\"flex flex-wrap gap-2\">\n                  {item.analysis.riskFlagsJson.map((flag) => (\n                    <Badge key={flag} variant=\"destructive\" className=\"flex items-center gap-1\">\n                      <AlertTriangle className=\"h-3 w-3\" />\n                      {riskFlagKey(flag)}\n                    </Badge>\n                  ))}\n                </div>\n              )}\n\n              <div className=\"text-sm\">\n                <span className=\"font-medium\">{t(\"itemDetail.suggestedAngle\")}</span>\n                <p className=\"text-muted-foreground mt-1\">{item.analysis.suggestedAngle}</p>\n              </div>\n\n              <div className=\"text-sm\">\n                <span className=\"font-medium\">{t(\"itemDetail.summary\")}</span>\n                <p className=\"text-muted-foreground mt-1 whitespace-pre-wrap\">{item.analysis.summaryLong}</p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {item.drafts && item.drafts.length > 0 && (\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <CardTitle className=\"text-base\">{t(\"itemDetail.draftReplies\")}</CardTitle>\n            <div className=\"flex gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => skipMutation.mutate()}\n                disabled={skipMutation.isPending || item.status === \"skipped\"}\n                data-testid=\"button-skip\"\n              >\n                <SkipForward className=\"h-4 w-4 mr-1\" />\n                {t(\"itemDetail.skip\")}\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => reanalyzeMutation.mutate()}\n                disabled={reanalyzeMutation.isPending}\n                data-testid=\"button-reanalyze\"\n              >\n                <RefreshCw className=\"h-4 w-4 mr-1\" />\n                {t(\"itemDetail.reanalyze\")}\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <Tabs value={selectedDraft} onValueChange={setSelectedDraft}>\n              <TabsList>\n                {item.drafts.map((draft) => (\n                  <TabsTrigger\n                    key={draft.variant}\n                    value={draft.variant}\n                    data-testid={`tab-draft-${draft.variant}`}\n                  >\n                    {t(\"itemDetail.variant\", { variant: draft.variant })}\n                    {draft.adminDecision === \"approved\" && (\n                      <Check className=\"h-3 w-3 ml-1 text-green-500\" />\n                    )}\n                  </TabsTrigger>\n                ))}\n              </TabsList>\n\n              {item.drafts.map((draft) => (\n                <TabsContent key={draft.variant} value={draft.variant} className=\"space-y-4 mt-4\">\n                  <div className=\"flex flex-wrap gap-2\">\n                    <Badge variant=\"outline\">{draft.tone}</Badge>\n                    {draft.includesLink && (\n                      <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                        <ExternalLink className=\"h-3 w-3\" />\n                        {t(\"itemDetail.includesLink\")}\n                      </Badge>\n                    )}\n                    {draft.adminDecision !== \"pending\" && (\n                      <Badge\n                        variant={draft.adminDecision === \"approved\" ? \"default\" : \"destructive\"}\n                      >\n                        {t(`common.decision.${draft.adminDecision}`)}\n                      </Badge>\n                    )}\n                  </div>\n\n                  <Textarea\n                    value={editedText || draft.draftText}\n                    onChange={(e) => setEditedText(e.target.value)}\n                    className=\"min-h-[200px] text-sm\"\n                    placeholder={t(\"itemDetail.editPlaceholder\")}\n                    data-testid=\"textarea-draft\"\n                  />\n\n                  <div className=\"flex flex-wrap gap-2\">\n                    <Button\n                      onClick={handleApprove}\n                      disabled={approveMutation.isPending || draft.adminDecision === \"approved\"}\n                      data-testid=\"button-approve\"\n                    >\n                      <ThumbsUp className=\"h-4 w-4 mr-2\" />\n                      {t(\"itemDetail.approve\")}\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => rejectMutation.mutate(draft.id)}\n                      disabled={rejectMutation.isPending || draft.adminDecision === \"rejected\"}\n                      data-testid=\"button-reject\"\n                    >\n                      <ThumbsDown className=\"h-4 w-4 mr-2\" />\n                      {t(\"itemDetail.reject\")}\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      onClick={() => handleCopy(editedText || draft.draftText)}\n                      data-testid=\"button-copy\"\n                    >\n                      {copied ? (\n                        <Check className=\"h-4 w-4 mr-2\" />\n                      ) : (\n                        <Copy className=\"h-4 w-4 mr-2\" />\n                      )}\n                      {t(\"itemDetail.copy\")}\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      onClick={() => handleCopy(removeLinks(editedText || draft.draftText))}\n                      data-testid=\"button-copy-no-link\"\n                    >\n                      <Link2Off className=\"h-4 w-4 mr-2\" />\n                      {t(\"itemDetail.copyNoLinks\")}\n                    </Button>\n                  </div>\n\n                  {draft.finalText && (\n                    <div className=\"p-4 rounded-md bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800\">\n                      <div className=\"text-sm font-medium text-green-800 dark:text-green-200 mb-2\">\n                        {t(\"itemDetail.approvedFinal\")}\n                      </div>\n                      <p className=\"text-sm whitespace-pre-wrap\">{draft.finalText}</p>\n                    </div>\n                  )}\n                </TabsContent>\n              ))}\n            </Tabs>\n          </CardContent>\n        </Card>\n      )}\n\n      {(!item.drafts || item.drafts.length === 0) && item.status !== \"new\" && (\n        <Card>\n          <CardContent className=\"py-8 text-center\">\n            <p className=\"text-muted-foreground\">{t(\"itemDetail.noDrafts\")}</p>\n            {item.analysis?.recommendedAction === \"draft\" && (\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                {t(\"itemDetail.draftsWillGenerate\")}\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":15706,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Bot, Layers, Rss, Settings, Zap, ArrowRight, TrendingUp, BookOpen, Building2, Newspaper, ChevronDown, Key, MessageSquare, PenTool, Laptop, Store, ShoppingCart, LogIn, User, Monitor, Users, Landmark, Check } from \"lucide-react\";\nimport { ShareButton } from \"@/components/share-button\";\nimport { LanguageSwitcher } from \"@/components/language-switcher\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\nfunction FAQItem({ q, a }: { q: string; a: string }) {\n  const [open, setOpen] = useState(false);\n  return (\n    <div className=\"border-b border-border last:border-b-0\">\n      <button\n        className=\"w-full flex items-center justify-between gap-4 py-4 text-left\"\n        onClick={() => setOpen(!open)}\n        data-testid={`button-faq-${q.slice(0, 20).replace(/\\s+/g, \"-\").toLowerCase()}`}\n      >\n        <span className=\"font-medium text-sm\">{q}</span>\n        <ChevronDown className={`h-4 w-4 shrink-0 text-muted-foreground transition-transform ${open ? \"rotate-180\" : \"\"}`} />\n      </button>\n      {open && (\n        <p className=\"pb-4 text-sm text-muted-foreground leading-relaxed\">{a}</p>\n      )}\n    </div>\n  );\n}\n\nfunction DemoLoginForm() {\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [error, setError] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const queryClient = useQueryClient();\n  const { t } = useLanguage();\n\n  async function handleDemoLogin(e: React.FormEvent) {\n    e.preventDefault();\n    setError(\"\");\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/demo-login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ username, password }),\n        credentials: \"include\",\n      });\n      if (!res.ok) {\n        setError(t(\"landing.demo.error\"));\n        return;\n      }\n      await queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      window.location.href = \"/\";\n    } catch {\n      setError(t(\"landing.demo.failed\"));\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <Card className=\"max-w-sm w-full\">\n      <CardContent className=\"pt-6 space-y-4\">\n        <div className=\"flex items-center gap-2 mb-1\">\n          <LogIn className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm font-medium\">{t(\"landing.demo.title\")}</span>\n        </div>\n        <form onSubmit={handleDemoLogin} className=\"space-y-3\">\n          <div className=\"space-y-1.5\">\n            <Label htmlFor=\"demo-username\" className=\"text-xs\">{t(\"landing.demo.id\")}</Label>\n            <Input\n              id=\"demo-username\"\n              data-testid=\"input-demo-username\"\n              value={username}\n              onChange={(e) => setUsername(e.target.value)}\n              placeholder={t(\"landing.demo.idPlaceholder\")}\n              autoComplete=\"username\"\n            />\n          </div>\n          <div className=\"space-y-1.5\">\n            <Label htmlFor=\"demo-password\" className=\"text-xs\">{t(\"landing.demo.password\")}</Label>\n            <Input\n              id=\"demo-password\"\n              data-testid=\"input-demo-password\"\n              type=\"password\"\n              value={password}\n              onChange={(e) => setPassword(e.target.value)}\n              placeholder={t(\"landing.demo.passwordPlaceholder\")}\n              autoComplete=\"current-password\"\n            />\n          </div>\n          {error && <p className=\"text-sm text-destructive\" data-testid=\"text-demo-error\">{error}</p>}\n          <Button type=\"submit\" className=\"w-full\" disabled={loading} data-testid=\"button-demo-login\">\n            {loading ? t(\"landing.demo.loggingIn\") : t(\"landing.demo.loginButton\")}\n          </Button>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function Landing() {\n  const { t } = useLanguage();\n\n  const useCases = [\n    {\n      icon: TrendingUp,\n      title: t(\"landing.useCase.dailyMarketBrief\"),\n      description: t(\"landing.useCase.dailyMarketBriefDesc\"),\n    },\n    {\n      icon: BookOpen,\n      title: t(\"landing.useCase.researchPaperTracker\"),\n      description: t(\"landing.useCase.researchPaperTrackerDesc\"),\n    },\n    {\n      icon: Building2,\n      title: t(\"landing.useCase.competitorSignalMonitor\"),\n      description: t(\"landing.useCase.competitorSignalMonitorDesc\"),\n    },\n    {\n      icon: Newspaper,\n      title: t(\"landing.useCase.communityResearch\"),\n      description: t(\"landing.useCase.communityResearchDesc\"),\n    },\n    {\n      icon: PenTool,\n      title: t(\"landing.useCase.contentIdeas\"),\n      description: t(\"landing.useCase.contentIdeasDesc\"),\n    },\n    {\n      icon: Laptop,\n      title: t(\"landing.useCase.workProductivity\"),\n      description: t(\"landing.useCase.workProductivityDesc\"),\n    },\n    {\n      icon: Store,\n      title: t(\"landing.useCase.onlineBusiness\"),\n      description: t(\"landing.useCase.onlineBusinessDesc\"),\n    },\n    {\n      icon: ShoppingCart,\n      title: t(\"landing.useCase.koreaMarketplace\"),\n      description: t(\"landing.useCase.koreaMarketplaceDesc\"),\n    },\n    {\n      icon: MessageSquare,\n      title: t(\"landing.useCase.chatControl\"),\n      description: t(\"landing.useCase.chatControlDesc\"),\n    },\n    {\n      icon: Key,\n      title: t(\"landing.useCase.byoLlm\"),\n      description: t(\"landing.useCase.byoLlmDesc\"),\n    },\n  ];\n\n  const faqItems = [\n    { q: t(\"landing.faq.q1\"), a: t(\"landing.faq.a1\") },\n    { q: t(\"landing.faq.q2\"), a: t(\"landing.faq.a2\") },\n    { q: t(\"landing.faq.q3\"), a: t(\"landing.faq.a3\") },\n    { q: t(\"landing.faq.q4\"), a: t(\"landing.faq.a4\") },\n    { q: t(\"landing.faq.q5\"), a: t(\"landing.faq.a5\") },\n    { q: t(\"landing.faq.q6\"), a: t(\"landing.faq.a6\") },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-background via-background to-muted\">\n      <nav className=\"fixed top-0 left-0 right-0 z-50 backdrop-blur-md bg-background/80 border-b border-border\">\n        <div className=\"max-w-6xl mx-auto px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Bot className=\"h-6 w-6 text-primary\" />\n            <span className=\"font-semibold text-lg\">Maker</span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <ShareButton />\n            <LanguageSwitcher />\n            <ThemeToggle />\n            <Button asChild data-testid=\"button-login-nav\">\n              <a href=\"/api/login\">{t(\"landing.nav.signIn\")}</a>\n            </Button>\n          </div>\n        </div>\n      </nav>\n\n      <main className=\"pt-24 pb-16\">\n        <section className=\"max-w-6xl mx-auto px-6 pt-12 pb-6\" data-testid=\"section-hero-type\">\n          <div className=\"select-none\" style={{ lineHeight: 0.95, letterSpacing: \"-0.03em\" }}>\n            <div\n              className=\"font-black text-foreground\"\n              style={{ fontSize: \"clamp(3rem, 12vw, 10rem)\" }}\n              data-testid=\"text-hero-iammaker\"\n            >\n              I.am.maker\n            </div>\n            <div\n              className=\"mt-2 font-black text-background bg-foreground px-3 py-1\"\n              style={{ fontSize: \"clamp(3rem, 12vw, 10rem)\" }}\n              data-testid=\"text-hero-makeram\"\n            >\n              maker.am\n            </div>\n          </div>\n        </section>\n\n        <section className=\"max-w-6xl mx-auto px-6 py-12\">\n          <div className=\"grid lg:grid-cols-2 gap-12 items-start\">\n            <div className=\"space-y-6\">\n              <h2 className=\"text-3xl lg:text-4xl font-bold leading-tight\" data-testid=\"text-hero-title\">\n                {t(\"landing.hero.title1\")}\n                <br />\n                <span className=\"text-primary\">{t(\"landing.hero.title2\")}</span>\n              </h2>\n              <p className=\"text-lg text-muted-foreground max-w-lg\" data-testid=\"text-hero-subtitle\">\n                {t(\"landing.hero.subtitle\")}\n              </p>\n              <div className=\"flex flex-wrap gap-4\">\n                <Button size=\"lg\" asChild data-testid=\"button-get-started\">\n                  <a href=\"/api/login\">\n                    {t(\"landing.hero.getStarted\")}\n                    <ArrowRight className=\"h-4 w-4 ml-2\" />\n                  </a>\n                </Button>\n              </div>\n              <div className=\"flex items-center gap-4 text-sm text-muted-foreground flex-wrap\">\n                <div className=\"flex items-center gap-1\">\n                  <Layers className=\"h-4 w-4\" />\n                  <span>{t(\"landing.hero.badge1\")}</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Settings className=\"h-4 w-4\" />\n                  <span>{t(\"landing.hero.badge2\")}</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Zap className=\"h-4 w-4\" />\n                  <span>{t(\"landing.hero.badge3\")}</span>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"relative space-y-6\">\n              <div className=\"bg-gradient-to-br from-primary/20 to-primary/5 rounded-md p-8 border border-border/50\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-3 p-4 bg-background rounded-md border border-border\">\n                    <Rss className=\"h-8 w-8 text-primary\" />\n                    <div>\n                      <div className=\"font-medium\">{t(\"landing.hero.chooseSources\")}</div>\n                      <div className=\"text-sm text-muted-foreground\">{t(\"landing.hero.chooseSourcesDesc\")}</div>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-3 p-4 bg-background rounded-md border border-border\">\n                    <Settings className=\"h-8 w-8 text-primary\" />\n                    <div>\n                      <div className=\"font-medium\">{t(\"landing.hero.scheduleFormat\")}</div>\n                      <div className=\"text-sm text-muted-foreground\">{t(\"landing.hero.scheduleFormatDesc\")}</div>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-3 p-4 bg-background rounded-md border border-border\">\n                    <Zap className=\"h-8 w-8 text-primary\" />\n                    <div>\n                      <div className=\"font-medium\">{t(\"landing.hero.aiAnalysis\")}</div>\n                      <div className=\"text-sm text-muted-foreground\">{t(\"landing.hero.aiAnalysisDesc\")}</div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <DemoLoginForm />\n            </div>\n          </div>\n        </section>\n\n        <section className=\"max-w-6xl mx-auto px-6 py-16\">\n          <h2 className=\"text-2xl font-bold text-center mb-4\" data-testid=\"text-how-it-works\">{t(\"landing.howItWorks.title\")}</h2>\n          <p className=\"text-center text-muted-foreground mb-12 max-w-lg mx-auto\">\n            {t(\"landing.howItWorks.subtitle\")}\n          </p>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Card className=\"hover-elevate\">\n              <CardContent className=\"pt-6 space-y-3\">\n                <div className=\"h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center\">\n                  <Layers className=\"h-6 w-6 text-primary\" />\n                </div>\n                <h3 className=\"font-semibold\">{t(\"landing.howItWorks.step1Title\")}</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  {t(\"landing.howItWorks.step1Desc\")}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"hover-elevate\">\n              <CardContent className=\"pt-6 space-y-3\">\n                <div className=\"h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center\">\n                  <Settings className=\"h-6 w-6 text-primary\" />\n                </div>\n                <h3 className=\"font-semibold\">{t(\"landing.howItWorks.step2Title\")}</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  {t(\"landing.howItWorks.step2Desc\")}\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"hover-elevate\">\n              <CardContent className=\"pt-6 space-y-3\">\n                <div className=\"h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center\">\n                  <Bot className=\"h-6 w-6 text-primary\" />\n                </div>\n                <h3 className=\"font-semibold\">{t(\"landing.howItWorks.step3Title\")}</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  {t(\"landing.howItWorks.step3Desc\")}\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        <section className=\"max-w-6xl mx-auto px-6 py-16\">\n          <h2 className=\"text-2xl font-bold text-center mb-4\" data-testid=\"text-use-cases\">{t(\"landing.useCases.title\")}</h2>\n          <p className=\"text-center text-muted-foreground mb-12 max-w-lg mx-auto\">\n            {t(\"landing.useCases.subtitle\")}\n          </p>\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {useCases.map((uc) => (\n              <Card key={uc.title} className=\"hover-elevate\" data-testid={`card-usecase-${uc.title.toLowerCase().replace(/\\s+/g, \"-\")}`}>\n                <CardContent className=\"pt-6 space-y-3\">\n                  <div className=\"h-10 w-10 rounded-md bg-primary/10 flex items-center justify-center\">\n                    <uc.icon className=\"h-5 w-5 text-primary\" />\n                  </div>\n                  <h3 className=\"font-semibold text-sm\">{uc.title}</h3>\n                  <p className=\"text-sm text-muted-foreground leading-relaxed\">{uc.description}</p>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </section>\n\n        <section className=\"max-w-3xl mx-auto px-6 py-16\" data-testid=\"section-faq\">\n          <h2 className=\"text-2xl font-bold text-center mb-4\">{t(\"landing.faq.title\")}</h2>\n          <p className=\"text-center text-muted-foreground mb-8\">\n            {t(\"landing.faq.subtitle\")}\n          </p>\n          <Card>\n            <CardContent className=\"pt-6\">\n              {faqItems.map((item) => (\n                <FAQItem key={item.q} q={item.q} a={item.a} />\n              ))}\n            </CardContent>\n          </Card>\n        </section>\n\n        <section className=\"max-w-6xl mx-auto px-6 py-16\" data-testid=\"section-pricing\">\n          <h2 className=\"text-2xl font-bold text-center mb-2\">{t(\"landing.pricing.title\")}</h2>\n          <p className=\"text-center text-muted-foreground mb-12\">{t(\"landing.pricing.subtitle\")}</p>\n          <div className=\"grid sm:grid-cols-2 lg:grid-cols-4 gap-6\">\n            {[\n              {\n                key: \"web\",\n                icon: User,\n                color: \"bg-blue-400 dark:bg-blue-500\",\n                features: [t(\"landing.pricing.web.f1\"), t(\"landing.pricing.web.f2\"), t(\"landing.pricing.web.f3\"), t(\"landing.pricing.web.f4\")],\n                active: true,\n              },\n              {\n                key: \"local\",\n                icon: Monitor,\n                color: \"bg-emerald-500 dark:bg-emerald-600\",\n                features: [t(\"landing.pricing.local.f1\"), t(\"landing.pricing.local.f2\"), t(\"landing.pricing.local.f3\")],\n                active: true,\n                href: \"https://github.com/Salepark/maker/releases/latest\",\n              },\n              {\n                key: \"teams\",\n                icon: Users,\n                color: \"bg-orange-400 dark:bg-orange-500\",\n                features: [t(\"landing.pricing.teams.f1\"), t(\"landing.pricing.teams.f2\"), t(\"landing.pricing.teams.f3\")],\n                active: false,\n              },\n              {\n                key: \"enterprise\",\n                icon: Landmark,\n                color: \"bg-slate-600 dark:bg-slate-500\",\n                features: [t(\"landing.pricing.enterprise.f1\"), t(\"landing.pricing.enterprise.f2\"), t(\"landing.pricing.enterprise.f3\")],\n                active: false,\n              },\n            ].map((plan) => (\n              <Card key={plan.key} className=\"flex flex-col\" data-testid={`card-pricing-${plan.key}`}>\n                <div className={`${plan.color} rounded-t-md flex items-center justify-center py-5`}>\n                  <plan.icon className=\"h-10 w-10 text-white\" />\n                </div>\n                <CardContent className=\"pt-5 pb-6 flex flex-col flex-1 gap-4\">\n                  <div>\n                    <h3 className=\"font-bold text-base\" data-testid={`text-pricing-price-${plan.key}`}>\n                      {t(`landing.pricing.${plan.key}.price`)}\n                    </h3>\n                    <span className=\"text-xs text-muted-foreground\">{t(`landing.pricing.${plan.key}.name`)}</span>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{t(`landing.pricing.${plan.key}.desc`)}</p>\n                  <ul className=\"space-y-2 flex-1\">\n                    {plan.features.map((f) => (\n                      <li key={f} className=\"flex items-start gap-2 text-sm\">\n                        <Check className={`h-4 w-4 shrink-0 mt-0.5 ${plan.active ? \"text-primary\" : \"text-muted-foreground\"}`} />\n                        <span>{f}</span>\n                      </li>\n                    ))}\n                  </ul>\n                  {plan.active ? (\n                    <Button asChild className=\"w-full\" data-testid={`button-pricing-${plan.key}`}>\n                      <a href={plan.href || \"/api/login\"} target={plan.href ? \"_blank\" : undefined} rel={plan.href ? \"noopener noreferrer\" : undefined}>\n                        {t(`landing.pricing.${plan.key}.button`)}\n                      </a>\n                    </Button>\n                  ) : (\n                    <Button variant=\"secondary\" disabled className=\"w-full\" data-testid={`button-pricing-${plan.key}`}>\n                      {t(`landing.pricing.${plan.key}.button`)}\n                    </Button>\n                  )}\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </section>\n\n        <section className=\"max-w-3xl mx-auto px-6 py-12 text-center\" data-testid=\"section-philosophy\">\n          <p className=\"text-lg italic text-muted-foreground leading-relaxed\">\n            {t(\"landing.philosophy.line1\")}\n            <br />\n            {t(\"landing.philosophy.line2\")}\n          </p>\n        </section>\n\n        <section className=\"max-w-3xl mx-auto px-6 py-12 text-center\">\n          <h2 className=\"text-2xl font-bold mb-4\">{t(\"landing.cta.title\")}</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            {t(\"landing.cta.subtitle\")}\n          </p>\n          <Button size=\"lg\" asChild data-testid=\"button-cta-bottom\">\n            <a href=\"/api/login\">\n              {t(\"landing.cta.button\")}\n              <ArrowRight className=\"h-4 w-4 ml-2\" />\n            </a>\n          </Button>\n        </section>\n      </main>\n\n      <footer className=\"border-t border-border py-8 text-center text-sm text-muted-foreground\">\n        <p>{t(\"landing.footer\")}</p>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":19560,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"server/llm/providers/custom.ts":{"content":"export async function generate(\n  prompt: string,\n  options: { apiKey: string; baseUrl?: string | null; model?: string | null; maxTokens?: number }\n): Promise<string> {\n  if (!options.baseUrl) {\n    throw new Error(\"Custom provider requires a baseUrl\");\n  }\n\n  const url = options.baseUrl + \"/v1/chat/completions\";\n  const model = options.model || \"default\";\n  const maxTokens = options.maxTokens || 1200;\n\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${options.apiKey}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      model,\n      max_tokens: maxTokens,\n      temperature: 0.2,\n      messages: [{ role: \"user\", content: prompt }],\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Custom LLM API error: ${response.status} - ${errorText}`);\n  }\n\n  const data = await response.json();\n\n  const text = data.choices?.[0]?.message?.content\n    || data.content?.[0]?.text\n    || (typeof data.text === \"string\" ? data.text : null);\n\n  if (!text) throw new Error(\"Empty response from custom LLM API\");\n  return text;\n}\n","path":null,"size_bytes":1159,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"server/jobs/report.ts":{"content":"import { storage } from \"../storage\";\nimport { callLLM, callLLMWithConfig, callLLMWithTimeout, hasSystemLLMKey, type LLMConfig } from \"../llm/client\";\nimport { buildDailyBriefPrompt, ReportConfig } from \"../llm/prompts\";\nimport { analyzeNewItemsBySourceIds } from \"./analyze_items\";\nimport { startRun, endRunOk, endRunError, endRunSkipped } from \"./runLogger\";\nimport { collectFromSourceIds } from \"../services/rss\";\n\nconst STOPWORDS = new Set([\n  \"the\", \"a\", \"an\", \"is\", \"are\", \"was\", \"were\", \"in\", \"on\", \"at\", \"to\", \"for\",\n  \"of\", \"and\", \"or\", \"but\", \"with\", \"from\", \"by\", \"as\", \"not\", \"no\", \"this\",\n  \"that\", \"it\", \"its\", \"has\", \"have\", \"had\", \"be\", \"been\", \"will\", \"would\",\n  \"can\", \"could\", \"do\", \"does\", \"did\", \"about\", \"more\", \"new\", \"all\", \"also\",\n  \"than\", \"just\", \"up\", \"out\", \"how\", \"what\", \"when\", \"where\", \"who\", \"why\",\n  \"into\", \"over\", \"after\", \"before\", \"between\", \"under\", \"through\",\n  \"이\", \"그\", \"저\", \"것\", \"및\", \"등\", \"중\", \"위\", \"대\", \"더\", \"수\", \"후\",\n  \"있다\", \"없다\", \"하다\", \"되다\", \"있는\", \"없는\", \"하는\", \"되는\",\n]);\n\nfunction extractKeywords(titles: string[], topN: number = 5): Record<string, number> {\n  const freq: Record<string, number> = {};\n  for (const title of titles) {\n    if (!title) continue;\n    const tokens = title.match(/[A-Za-z0-9]{2,}|[가-힣]{2,}/g) || [];\n    for (const token of tokens) {\n      const lower = token.toLowerCase();\n      if (STOPWORDS.has(lower) || lower.length < 2) continue;\n      freq[token] = (freq[token] || 0) + 1;\n    }\n  }\n  return Object.fromEntries(\n    Object.entries(freq)\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, topN)\n  );\n}\n\nfunction computeSourceDistribution(items: { sourceName: string }[]): Record<string, number> {\n  const dist: Record<string, number> = {};\n  for (const item of items) {\n    dist[item.sourceName] = (dist[item.sourceName] || 0) + 1;\n  }\n  return dist;\n}\n\ninterface ReportJobResult {\n  profileId: number;\n  reportId: number;\n  itemsCount: number;\n  topic: string;\n}\n\nasync function callLLMForProfile(prompt: string, userId: string, topic: string, maxRetries: number = 3, maxTokens: number = 4000): Promise<string> {\n  const botLLM = await storage.resolveLLMForProfile(userId, topic);\n  if (botLLM) {\n    console.log(`[ReportJob] Using bot-specific LLM: ${botLLM.providerType} / ${botLLM.model || 'default'}`);\n    return callLLMWithConfig(botLLM as LLMConfig, prompt, maxRetries, maxTokens);\n  }\n  if (hasSystemLLMKey()) {\n    console.log(`[ReportJob] No bot LLM configured, using system default`);\n    return callLLM(prompt, maxRetries, maxTokens);\n  }\n  throw new Error(\"No AI key configured. Please add an AI Provider in Settings or contact your administrator.\");\n}\n\nfunction isDueToday(scheduleCron: string, timezone: string, lastRunAt: Date | null): boolean {\n  try {\n    const now = new Date();\n\n    const options = { timeZone: timezone, hour12: false } as const;\n    const formatter = new Intl.DateTimeFormat('en-US', {\n      ...options,\n      hour: 'numeric',\n      minute: 'numeric',\n      weekday: 'short',\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n    });\n    const parts = formatter.formatToParts(now);\n\n    const currentHour = parseInt(parts.find(p => p.type === 'hour')?.value || '0');\n    const currentMinute = parseInt(parts.find(p => p.type === 'minute')?.value || '0');\n    const weekdayStr = parts.find(p => p.type === 'weekday')?.value || 'Mon';\n    const currentYear = parts.find(p => p.type === 'year')?.value || '';\n    const currentMonth = parts.find(p => p.type === 'month')?.value || '';\n    const currentDay = parts.find(p => p.type === 'day')?.value || '';\n    const todayKey = `${currentYear}-${currentMonth}-${currentDay}`;\n\n    const weekdayMap: Record<string, number> = {\n      'Sun': 0, 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5, 'Sat': 6\n    };\n    const currentDow = weekdayMap[weekdayStr] ?? 1;\n\n    const cronParts = scheduleCron.trim().split(/\\s+/);\n    if (cronParts.length < 5) return false;\n\n    const [cronMinute, cronHour, , , cronDow] = cronParts;\n\n    if (cronDow !== '*') {\n      if (cronDow.includes('-')) {\n        const [start, end] = cronDow.split('-').map(Number);\n        if (currentDow < start || currentDow > end) return false;\n      } else if (cronDow.includes(',')) {\n        const allowedDays = cronDow.split(',').map(Number);\n        if (!allowedDays.includes(currentDow)) return false;\n      } else {\n        if (currentDow !== parseInt(cronDow)) return false;\n      }\n    }\n\n    const targetHour = cronHour === '*' ? 0 : parseInt(cronHour);\n    const targetMinute = cronMinute === '*' ? 0 : parseInt(cronMinute);\n    const scheduledMinuteOfDay = targetHour * 60 + targetMinute;\n    const currentMinuteOfDay = currentHour * 60 + currentMinute;\n\n    if (currentMinuteOfDay < scheduledMinuteOfDay) return false;\n\n    if (lastRunAt) {\n      const lastRunFormatter = new Intl.DateTimeFormat('en-US', {\n        timeZone: timezone,\n        year: 'numeric',\n        month: '2-digit',\n        day: '2-digit',\n      });\n      const lastRunParts = lastRunFormatter.formatToParts(lastRunAt);\n      const lastRunYear = lastRunParts.find(p => p.type === 'year')?.value || '';\n      const lastRunMonth = lastRunParts.find(p => p.type === 'month')?.value || '';\n      const lastRunDay = lastRunParts.find(p => p.type === 'day')?.value || '';\n      const lastRunKey = `${lastRunYear}-${lastRunMonth}-${lastRunDay}`;\n\n      if (lastRunKey === todayKey) return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error('[ReportJob] Error in isDueToday:', error);\n    return false;\n  }\n}\n\nexport async function generateReportsForDueProfiles(): Promise<ReportJobResult[]> {\n  console.log(\"[ReportJob] Starting report generation for due profiles...\");\n  \n  const activeProfiles = await storage.getActiveReportProfiles();\n  \n  if (activeProfiles.length === 0) {\n    console.log(\"[ReportJob] No active report profiles found\");\n    return [];\n  }\n\n  console.log(`[ReportJob] Found ${activeProfiles.length} active report profiles`);\n\n  const results: ReportJobResult[] = [];\n  const now = new Date();\n\n  for (const profile of activeProfiles) {\n    try {\n      if (!isDueToday(profile.scheduleCron, profile.timezone, profile.lastRunAt ? new Date(profile.lastRunAt) : null)) {\n        continue;\n      }\n\n      console.log(`[ReportJob] Processing profile: ${profile.name} (id=${profile.id}, topic=${profile.topic})`);\n\n      const userBots = await storage.listBots(profile.userId);\n      const matchingBot = userBots.find(b => b.key === profile.topic);\n\n      const runId = await startRun({\n        userId: profile.userId,\n        botId: matchingBot?.id ?? null,\n        botKey: profile.topic,\n        jobType: \"report\",\n        trigger: \"schedule\",\n        meta: { profileId: profile.id, scheduleCron: profile.scheduleCron, tz: profile.timezone },\n      });\n\n      if (matchingBot && !matchingBot.isEnabled) {\n        console.log(`[ReportJob] Bot '${matchingBot.name}' is disabled, skipping profile ${profile.id}`);\n        await endRunSkipped(runId, \"BOT_DISABLED\");\n        continue;\n      }\n\n      const sourceIds = await storage.getProfileSourceIds(profile.id);\n      \n      if (sourceIds.length === 0) {\n        console.log(`[ReportJob] Profile ${profile.id} has no sources linked, skipping`);\n        await endRunSkipped(runId, \"NO_SOURCES\");\n        continue;\n      }\n\n      const lookbackHours = 72;\n      const periodStart = new Date(now.getTime() - lookbackHours * 60 * 60 * 1000);\n      const periodEnd = now;\n\n      const exists = await storage.outputExists(profile.id, periodStart, periodEnd);\n      if (exists) {\n        console.log(`[ReportJob] Report already exists for profile ${profile.id} in this period, skipping`);\n        await endRunSkipped(runId, \"ALREADY_EXISTS\");\n        continue;\n      }\n\n      let schedCollectResult = { totalCollected: 0, sourcesProcessed: sourceIds.length };\n      try {\n        schedCollectResult = await collectFromSourceIds(sourceIds);\n        console.log(`[ReportJob] Pre-report collection: ${schedCollectResult.totalCollected} items from ${schedCollectResult.sourcesProcessed} sources`);\n      } catch (collectErr) {\n        console.warn(`[ReportJob] Pre-report collection failed for profile ${profile.id} (continuing):`, collectErr);\n      }\n\n      const recentItems = await storage.getRecentItemsBySourceIds(sourceIds, lookbackHours, 30);\n      const sourceNames = [...new Set(recentItems.map(i => i.sourceName))];\n\n      const fastResult = await generateFastReport({\n        profileId: profile.id,\n        userId: profile.userId,\n        presetId: profile.presetId,\n        topic: profile.topic,\n        profileName: profile.name,\n        sourceIds,\n        collectResult: schedCollectResult,\n        sourceNames,\n        timezone: profile.timezone || \"Asia/Seoul\",\n      });\n\n      console.log(`[ReportJob] Fast report ${fastResult.reportId} created for profile ${profile.id}, scheduling background upgrade...`);\n\n      await endRunOk(runId, {\n        outputId: fastResult.reportId,\n        reportStage: \"fast\",\n        itemsCollected: fastResult.itemsCount,\n      });\n\n      results.push(fastResult);\n\n      scheduleBackgroundUpgrade(fastResult.reportId, profile.id, profile.userId, sourceIds);\n\n    } catch (error) {\n      console.error(`[ReportJob] Failed to generate report for profile ${profile.id}:`, error);\n    }\n  }\n\n  console.log(`[ReportJob] Completed. Generated ${results.length} reports (fast stage, upgrades in background)`);\n  return results;\n}\n\nexport async function generateReportForProfile(profileId: number, userId?: string): Promise<ReportJobResult | null> {\n  console.log(`[ReportJob] Manual generation for profile ${profileId} (fast-first)`);\n\n  const profile = await storage.getProfileById(profileId);\n\n  if (!profile) {\n    console.error(`[ReportJob] Profile ${profileId} not found`);\n    throw new Error(`Profile not found. Please create a bot from the Template Gallery first.`);\n  }\n\n  if (userId && profile.userId !== userId) {\n    console.error(`[ReportJob] Profile ${profileId} does not belong to user ${userId}`);\n    throw new Error(`Profile does not belong to this user.`);\n  }\n\n  const sourceIds = await storage.getProfileSourceIds(profile.id);\n  \n  if (sourceIds.length === 0) {\n    console.error(`[ReportJob] Profile ${profileId} has no sources linked`);\n    throw new Error(`No sources linked to this bot. Add sources first using 'add source' command or from the Sources page.`);\n  }\n\n  let collectResult = { totalCollected: 0, sourcesProcessed: 0 };\n  try {\n    console.log(`[ReportJob] Collecting fresh items for ${sourceIds.length} sources before report...`);\n    collectResult = await collectFromSourceIds(sourceIds);\n    console.log(`[ReportJob] Collected ${collectResult.totalCollected} new items from ${collectResult.sourcesProcessed} sources`);\n  } catch (e) {\n    console.warn(`[ReportJob] Pre-report collection failed (continuing with existing data):`, e);\n  }\n\n  const allSources = await storage.getSources();\n  const sourceNames = allSources\n    .filter((s: any) => sourceIds.includes(s.id))\n    .map((s: any) => s.name);\n\n  const fastResult = await generateFastReport({\n    profileId: profile.id,\n    userId: profile.userId,\n    presetId: profile.presetId,\n    topic: profile.topic,\n    profileName: profile.name,\n    sourceIds,\n    collectResult,\n    sourceNames,\n    timezone: profile.timezone || \"Asia/Seoul\",\n  });\n\n  if (fastResult.reportId && fastResult.itemsCount > 0) {\n    const botLLM = await storage.resolveLLMForProfile(profile.userId, profile.topic);\n    if (hasSystemLLMKey() || botLLM) {\n      scheduleBackgroundUpgrade(fastResult.reportId, profile.id, profile.userId, sourceIds);\n    }\n  }\n\n  console.log(`[ReportJob] Created fast report ${fastResult.reportId} for profile ${profile.id} (${fastResult.itemsCount} items, upgrade scheduled in background)`);\n\n  return fastResult;\n}\n\nfunction buildStatusReport(\n  profileName: string,\n  today: string,\n  recentItems: { title: string | null; sourceName: string; status: string }[],\n  sourceCount: number\n): string {\n  const lines: string[] = [];\n  lines.push(`# ${profileName} — ${today}`);\n  lines.push(\"\");\n  lines.push(`> 상태 리포트`);\n  lines.push(\"\");\n\n  if (recentItems.length === 0) {\n    lines.push(\"오늘은 연결된 소스에서 새로운 자료가 수집되지 않았습니다.\");\n    lines.push(\"\");\n    lines.push(\"**가능한 원인:**\");\n    lines.push(\"- 소스 피드에 새 게시물이 아직 없음\");\n    lines.push(\"- 소스 URL이 올바르지 않거나 일시적으로 접근 불가\");\n    lines.push(\"\");\n    lines.push(`연결된 소스: ${sourceCount}개`);\n  } else {\n    const statusCounts: Record<string, number> = {};\n    for (const item of recentItems) {\n      statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;\n    }\n\n    lines.push(`최근 24시간 내 ${recentItems.length}건의 자료가 수집되었습니다.`);\n    lines.push(\"\");\n\n    if (statusCounts[\"new\"]) {\n      lines.push(`- 수집 완료 (분석 대기): ${statusCounts[\"new\"]}건`);\n    }\n    if (statusCounts[\"analyzed\"]) {\n      lines.push(`- 분석 완료: ${statusCounts[\"analyzed\"]}건`);\n    }\n    if (statusCounts[\"skipped\"]) {\n      lines.push(`- 건너뜀: ${statusCounts[\"skipped\"]}건`);\n    }\n    lines.push(\"\");\n\n    lines.push(\"**주요 수집 자료:**\");\n    const displayItems = recentItems.slice(0, 8);\n    for (const item of displayItems) {\n      lines.push(`- ${item.title || \"(제목 없음)\"} (${item.sourceName})`);\n    }\n    if (recentItems.length > 8) {\n      lines.push(`- ...외 ${recentItems.length - 8}건`);\n    }\n    lines.push(\"\");\n    lines.push(\"심화 분석은 백그라운드에서 진행되며, 완료되면 자동으로 업데이트됩니다.\");\n  }\n\n  lines.push(\"\");\n  lines.push(\"---\");\n  lines.push(\"*메이커는 먼저 빠른 브리핑을 제공합니다. 심화 분석은 백그라운드에서 진행되며, 완료되면 자동으로 업데이트됩니다.*\");\n\n  return lines.join(\"\\n\");\n}\n\nfunction scheduleBackgroundUpgrade(reportId: number, profileId: number, userId: string, sourceIds: number[]) {\n  const maxItems = 12;\n  const BACKGROUND_TIMEOUT_MS = 55000;\n  setTimeout(async () => {\n    const bgStart = Date.now();\n    let bgRunId = -1;\n    let timedOut = false;\n    let runFinalized = false;\n\n    try {\n      bgRunId = await startRun({\n        userId,\n        botId: null,\n        botKey: `profile-${profileId}`,\n        jobType: \"report_upgrade\",\n        trigger: \"background\",\n        meta: { reportId, profileId },\n      });\n\n      console.log(`[ReportJob] Background upgrade starting for report ${reportId} (profile ${profileId})...`);\n\n      const upgradePromise = (async () => {\n        const newItems = await storage.getItemsByStatusAndSourceIds(\"new\", sourceIds, maxItems);\n        if (newItems.length > 0) {\n          console.log(`[ReportJob] Background: analyzing ${newItems.length} new items inline...`);\n          await analyzeNewItemsBySourceIds(sourceIds, maxItems, 1);\n        }\n        if (timedOut) return null;\n        return upgradeToFullReport(reportId, profileId, userId);\n      })();\n\n      const timeoutPromise = new Promise<null>((resolve) =>\n        setTimeout(() => {\n          timedOut = true;\n          resolve(null);\n        }, BACKGROUND_TIMEOUT_MS)\n      );\n\n      const result = await Promise.race([upgradePromise, timeoutPromise]);\n\n      if (timedOut || result === null) {\n        console.warn(`[ReportJob] Background upgrade timed out after ${BACKGROUND_TIMEOUT_MS}ms for report ${reportId}`);\n        runFinalized = true;\n        await endRunError(bgRunId, {\n          errorCode: \"BACKGROUND_TIMEOUT\",\n          errorMessage: `Background upgrade timed out after ${BACKGROUND_TIMEOUT_MS}ms`,\n          reportStage: \"fast\",\n        });\n        upgradePromise.catch(() => {});\n      } else {\n        console.log(`[ReportJob] Background upgrade complete for report ${reportId} in ${Date.now() - bgStart}ms`);\n        runFinalized = true;\n        await endRunOk(bgRunId, {\n          outputId: reportId,\n          reportStage: \"full\",\n          itemsCollected: result?.itemsCount ?? 0,\n        });\n      }\n    } catch (error: any) {\n      if (runFinalized) return;\n      console.error(`[ReportJob] Background upgrade failed for report ${reportId}:`, error);\n      await endRunError(bgRunId, {\n        errorCode: \"BACKGROUND_UPGRADE_FAILED\",\n        errorMessage: error?.message || \"Background upgrade failed\",\n        reportStage: \"fast\",\n      });\n    }\n  }, 2000);\n}\n\nexport interface FastReportParams {\n  profileId: number;\n  userId: string;\n  presetId: number;\n  topic: string;\n  profileName: string;\n  sourceIds: number[];\n  collectResult: { totalCollected: number; sourcesProcessed: number };\n  sourceNames: string[];\n  timezone?: string;\n}\n\nexport async function generateFastReport(params: FastReportParams): Promise<ReportJobResult> {\n  const {\n    profileId, userId, presetId, topic,\n    profileName, sourceIds, collectResult, sourceNames,\n    timezone = \"Asia/Seoul\",\n  } = params;\n\n  const now = new Date();\n  const lookbackHours = 72;\n  const periodStart = new Date(now.getTime() - lookbackHours * 60 * 60 * 1000);\n  const periodEnd = now;\n\n  const today = now.toLocaleDateString(\"ko-KR\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n    weekday: \"long\",\n    timeZone: timezone,\n  });\n\n  const timeStr = now.toLocaleTimeString(\"ko-KR\", {\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    hour12: false,\n    timeZone: timezone,\n  });\n\n  const fastStart = performance.now();\n\n  const recentItems = await storage.getRecentItemsBySourceIds(sourceIds, lookbackHours, 30);\n\n  const titles = recentItems.map(i => i.title || \"\");\n  const keywordSummary = extractKeywords(titles, 5);\n  const sourceDistribution = computeSourceDistribution(recentItems);\n\n  const lines: string[] = [];\n  lines.push(`# ${profileName}`);\n  lines.push(`> ${today} ${timeStr} 기준`);\n  lines.push(\"\");\n\n  if (recentItems.length > 0) {\n    const totalSources = Object.keys(sourceDistribution).length;\n    lines.push(`**${totalSources}개 소스**에서 총 **${recentItems.length}건**의 자료를 수집했습니다.`);\n  } else if (collectResult.totalCollected > 0) {\n    lines.push(`${collectResult.sourcesProcessed}개 소스에서 **${collectResult.totalCollected}건**의 새 자료를 수집했습니다.`);\n  } else {\n    lines.push(\"현재 수집된 자료가 없습니다. 소스 연결을 확인해주세요.\");\n  }\n  lines.push(\"\");\n\n  if (recentItems.length > 0) {\n    lines.push(\"## 주요 항목\");\n    lines.push(\"\");\n    const displayItems = recentItems.slice(0, 10);\n    for (const item of displayItems) {\n      lines.push(`- **${item.title || \"(제목 없음)\"}** — ${item.sourceName}`);\n    }\n    if (recentItems.length > 10) {\n      lines.push(`- ...외 ${recentItems.length - 10}건`);\n    }\n    lines.push(\"\");\n\n    const kwEntries = Object.entries(keywordSummary);\n    if (kwEntries.length > 0) {\n      lines.push(\"## 키워드 요약\");\n      lines.push(\"\");\n      for (const [kw, cnt] of kwEntries) {\n        lines.push(`- **${kw}**: ${cnt}회`);\n      }\n      lines.push(\"\");\n    }\n\n    lines.push(\"## 소스별 분포\");\n    lines.push(\"\");\n    for (const [name, cnt] of Object.entries(sourceDistribution)) {\n      lines.push(`- ${name}: ${cnt}건`);\n    }\n    lines.push(\"\");\n  }\n\n  lines.push(\"---\");\n  lines.push(\"*메이커는 먼저 빠른 브리핑을 제공합니다. 심화 분석은 백그라운드에서 진행되며, 완료되면 자동으로 업데이트됩니다.*\");\n\n  const content = lines.join(\"\\n\");\n\n  const report = await storage.createOutputRecord({\n    userId,\n    profileId,\n    presetId,\n    topic,\n    outputType: \"report\",\n    title: `${profileName} — 초기 브리핑 (${timeStr})`,\n    contentText: content,\n    reportStage: \"fast\",\n    periodStart,\n    periodEnd,\n  });\n\n  await storage.updateProfileLastRunAt(profileId, now);\n\n  try {\n    await storage.createReportMetric({\n      reportId: report.id,\n      profileId,\n      itemCount: recentItems.length,\n      keywordSummary,\n      sourceDistribution,\n    });\n  } catch (e) {\n    console.error(`[ReportJob] Failed to save report metrics:`, e);\n  }\n\n  const fastDuration = Math.round(performance.now() - fastStart);\n  console.log(`[ReportJob] Created FAST report ${report.id} for profile ${profileId} in ${fastDuration}ms`);\n\n  return {\n    profileId,\n    reportId: report.id,\n    itemsCount: recentItems.length,\n    topic,\n  };\n}\n\nexport async function upgradeToFullReport(outputId: number, profileId: number, userId?: string): Promise<ReportJobResult | null> {\n  console.log(`[ReportJob] Upgrading fast report ${outputId} to full report...`);\n  \n  const profile = await storage.getProfileById(profileId);\n  if (!profile) {\n    console.error(`[ReportJob] Profile ${profileId} not found for upgrade`);\n    return null;\n  }\n\n  const sourceIds = await storage.getProfileSourceIds(profile.id);\n  if (sourceIds.length === 0) return null;\n\n  const now = new Date();\n  const lookbackHours = 72;\n  const maxItems = 20;\n\n  let items = await storage.getItemsForReport(null, sourceIds, lookbackHours, maxItems);\n\n  const config = (profile.configJson || {}) as ReportConfig;\n  const minScore = config.filters?.minImportanceScore ?? 0;\n  if (minScore > 0) {\n    items = items.filter(item => (item.importanceScore || 0) >= minScore);\n  }\n\n  const today = new Date().toLocaleDateString(\"en-US\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n    weekday: \"long\",\n    timeZone: profile.timezone || \"Asia/Seoul\",\n  });\n\n  let content: string;\n  let reportStage: string;\n\n  if (items.length === 0) {\n    const newItems = await storage.getItemsByStatusAndSourceIds(\"new\", sourceIds, maxItems);\n    if (newItems.length > 0) {\n      console.log(`[ReportJob] Upgrade: No analyzed items but ${newItems.length} new items found, analyzing inline...`);\n      try {\n        const analyzedCount = await analyzeNewItemsBySourceIds(sourceIds, maxItems, 1);\n        if (analyzedCount > 0) {\n          items = await storage.getItemsForReport(null, sourceIds, lookbackHours, maxItems);\n          if (minScore > 0) {\n            items = items.filter(item => (item.importanceScore || 0) >= minScore);\n          }\n        }\n      } catch (analyzeError) {\n        console.error(`[ReportJob] Inline analysis failed during upgrade:`, analyzeError);\n      }\n    }\n  }\n\n  if (items.length === 0) {\n    const recentItems = await storage.getRecentItemsBySourceIds(sourceIds, lookbackHours, 20);\n    content = buildStatusReport(profile.name, today, recentItems, sourceIds.length);\n    reportStage = \"status\";\n  } else {\n    const briefItems = items.map((item) => ({\n      id: item.id,\n      title: item.title || \"Untitled\",\n      url: item.url,\n      source: item.sourceName,\n      topic: item.topic,\n      key_takeaway: \"\",\n      why_it_matters: \"\",\n      impact_scope: {\n        equities: item.importanceScore,\n        rates_fx: Math.floor(item.importanceScore * 0.7),\n        commodities: Math.floor(item.importanceScore * 0.5),\n        crypto: Math.floor(item.importanceScore * 0.8),\n      },\n      risk_flags: [],\n      confidence: item.importanceScore,\n      category: \"general\",\n    }));\n\n    let userRules: Record<string, any> = {};\n    try {\n      const bot = await storage.getBotByUserAndKey(profile.userId, profile.topic);\n      userRules = await storage.getEffectiveRules(profile.userId, bot?.id ?? null);\n    } catch (e) {\n      console.warn(`[ReportJob] Failed to fetch user rules:`, e);\n    }\n\n    const prompt = buildDailyBriefPrompt(briefItems, today, profile.topic, config, userRules);\n    const llmResult = await callLLMWithTimeout(\n      () => callLLMForProfile(prompt, profile.userId, profile.topic),\n      60000\n    );\n    if (llmResult) {\n      content = llmResult;\n      reportStage = \"full\";\n\n      try {\n        const trendBlock = await buildTrendBlock(profileId);\n        if (trendBlock) {\n          content += \"\\n\\n\" + trendBlock;\n        }\n      } catch (e) {\n        console.error(`[ReportJob] Failed to build trend block:`, e);\n      }\n    } else {\n      console.warn(`[ReportJob] LLM timed out during upgrade, keeping status report`);\n      const recentItems = await storage.getRecentItemsBySourceIds(sourceIds, lookbackHours, 20);\n      content = buildStatusReport(profile.name, today, recentItems, sourceIds.length);\n      reportStage = \"status\";\n    }\n  }\n\n  const updated = await storage.updateOutputContent(outputId, {\n    contentText: content,\n    title: reportStage === \"full\" ? `${profile.name} - ${today}` : `${profile.name} — 상태 리포트`,\n    reportStage,\n  });\n\n  if (!updated) {\n    console.error(`[ReportJob] Failed to upgrade report ${outputId}`);\n    return null;\n  }\n\n  if (items.length > 0) {\n    try {\n      await storage.linkOutputItems(outputId, items.map((i) => i.id));\n    } catch (e) {\n    }\n  }\n\n  console.log(`[ReportJob] Upgraded report ${outputId} to ${reportStage} (${items.length} items)`);\n\n  return {\n    profileId,\n    reportId: outputId,\n    itemsCount: items.length,\n    topic: profile.topic,\n  };\n}\n\nasync function buildTrendBlock(profileId: number): Promise<string | null> {\n  const metrics = await storage.getReportMetricsForProfile(profileId, 7);\n  if (metrics.length < 2) return null;\n\n  const latest = metrics[0];\n  const previous = metrics.slice(1);\n\n  const latestKw = (latest.keywordSummary || {}) as Record<string, number>;\n  const prevKwAgg: Record<string, number[]> = {};\n  for (const m of previous) {\n    const kw = (m.keywordSummary || {}) as Record<string, number>;\n    for (const [k, v] of Object.entries(kw)) {\n      if (!prevKwAgg[k]) prevKwAgg[k] = [];\n      prevKwAgg[k].push(v);\n    }\n  }\n\n  const lines: string[] = [];\n  lines.push(\"---\");\n  lines.push(\"## 7일 변화 요약\");\n  lines.push(\"\");\n\n  let hasChanges = false;\n\n  for (const [kw, count] of Object.entries(latestKw)) {\n    const prev = prevKwAgg[kw];\n    if (prev && prev.length >= 1) {\n      const avg = prev.reduce((a, b) => a + b, 0) / prev.length;\n      if (avg > 0) {\n        const changePercent = Math.round(((count - avg) / avg) * 100);\n        if (Math.abs(changePercent) >= 10) {\n          lines.push(`- **${kw}** ${changePercent >= 0 ? \"+\" : \"\"}${changePercent}%`);\n          hasChanges = true;\n        }\n      }\n    }\n  }\n\n  const allKws: Record<string, number> = {};\n  for (const m of metrics) {\n    const kw = (m.keywordSummary || {}) as Record<string, number>;\n    for (const k of Object.keys(kw)) {\n      allKws[k] = (allKws[k] || 0) + 1;\n    }\n  }\n  const recurringKws = Object.entries(allKws)\n    .filter(([, count]) => count >= Math.min(4, metrics.length))\n    .map(([kw]) => kw);\n\n  if (recurringKws.length > 0) {\n    lines.push(\"\");\n    lines.push(`반복 등장 키워드: ${recurringKws.join(\", \")}`);\n    hasChanges = true;\n  }\n\n  const latestSrc = (latest.sourceDistribution || {}) as Record<string, number>;\n  const prevSrcAgg: Record<string, number[]> = {};\n  for (const m of previous) {\n    const src = (m.sourceDistribution || {}) as Record<string, number>;\n    for (const [k, v] of Object.entries(src)) {\n      if (!prevSrcAgg[k]) prevSrcAgg[k] = [];\n      prevSrcAgg[k].push(v);\n    }\n  }\n\n  for (const [src, count] of Object.entries(latestSrc)) {\n    const prev = prevSrcAgg[src];\n    if (prev && prev.length >= 1) {\n      const avg = prev.reduce((a, b) => a + b, 0) / prev.length;\n      if (count > avg * 1.3) {\n        lines.push(`- ${src} 비중 증가`);\n        hasChanges = true;\n      }\n    }\n  }\n\n  if (!hasChanges) return null;\n\n  lines.push(\"\");\n  return lines.join(\"\\n\");\n}\n","path":null,"size_bytes":27651,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/lib/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"dark\" | \"light\";\n\ntype ThemeProviderContextType = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderContextType | undefined>(undefined);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"light\",\n}: {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n}) {\n  const [theme, setTheme] = useState<Theme>(() => {\n    const stored = localStorage.getItem(\"theme\") as Theme;\n    return stored || defaultTheme;\n  });\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n    localStorage.setItem(\"theme\", theme);\n  }, [theme]);\n\n  return (\n    <ThemeProviderContext.Provider value={{ theme, setTheme }}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n  if (context === undefined) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n};\n","path":null,"size_bytes":1124,"size_tokens":null},"server/storage.ts":{"content":"import { db } from \"./db\";\nimport { encrypt, decrypt } from \"./lib/crypto\";\nimport { \n  sources, items, analysis, drafts, posts, reports, chatMessages, chatThreads, settings,\n  presets, profiles, profileSources, outputs, outputItems,\n  bots, botSettings, sourceBotLinks, llmProviders, jobRuns,\n  permissions, auditLogs, reportMetrics, ruleMemories,\n  telegramLinks, linkCodes,\n  type Source, type Item, type Analysis, type Draft, type Post, type Report, \n  type InsertSource, type InsertItem, type InsertAnalysis, type InsertDraft, type InsertReport, \n  type ChatMessage, type InsertChatMessage, type ChatThread, type InsertChatThread, type Setting,\n  type Preset, type InsertPreset, type Profile, type InsertProfile, \n  type Output, type InsertOutput, type OutputItem,\n  type Bot, type InsertBot, type BotSettings, type InsertBotSettings, type SourceBotLink,\n  type LlmProvider, type InsertLlmProvider,\n  type JobRun, type InsertJobRun,\n  type Permission, type InsertPermission,\n  type RuleMemory,\n  type TelegramLink,\n} from \"@shared/schema\";\nimport { eq, desc, sql, and, count, gte, lt, lte, or, isNull, inArray } from \"drizzle-orm\";\n\nexport interface IStorage {\n  getStats(): Promise<{\n    total: number;\n    new: number;\n    analyzed: number;\n    drafted: number;\n    approved: number;\n    posted: number;\n    skipped: number;\n    lastCollectAt: string | null;\n    lastAnalyzeAt: string | null;\n  }>;\n\n  getSources(): Promise<(Source & { itemCount: number })[]>;\n  getSource(id: number): Promise<Source | undefined>;\n  createSource(data: InsertSource): Promise<Source>;\n  updateSource(id: number, data: Partial<InsertSource>): Promise<Source | undefined>;\n  deleteSource(id: number): Promise<void>;\n\n  getItems(status?: string): Promise<(Item & { sourceName: string; relevanceScore?: number; replyWorthinessScore?: number })[]>;\n  getRecentItems(limit?: number): Promise<(Item & { sourceName: string })[]>;\n  getObserveItems(limit?: number): Promise<any[]>;\n  getItem(id: number): Promise<(Item & { sourceName: string; analysis?: Analysis; drafts: Draft[] }) | undefined>;\n  getItemsByStatus(status: string, limit?: number): Promise<(Item & { sourceName: string; sourceTopic: string; rulesJson?: unknown })[]>;\n  getItemsByStatusAndSourceIds(status: string, sourceIds: number[], limit?: number): Promise<(Item & { sourceName: string; sourceTopic: string; rulesJson?: unknown })[]>;\n  createItem(data: InsertItem): Promise<Item>;\n  findItemByDedupeKey(sourceId: number, url: string): Promise<Item | undefined>;\n  updateItemStatus(id: number, status: string): Promise<void>;\n\n  createAnalysis(data: InsertAnalysis): Promise<Analysis>;\n  getAnalysisByItemId(itemId: number): Promise<Analysis | undefined>;\n\n  getDrafts(decision?: string): Promise<(Draft & { itemTitle: string; itemUrl: string; sourceName: string })[]>;\n  getDraftsByItemId(itemId: number): Promise<Draft[]>;\n  createDraft(data: InsertDraft): Promise<Draft>;\n  updateDraftDecision(id: number, decision: string, finalText?: string): Promise<void>;\n\n  getReports(limit?: number): Promise<Report[]>;\n  getReport(id: number): Promise<Report | undefined>;\n  createReport(data: InsertReport): Promise<Report>;\n  getAnalyzedItemsForBrief(lookbackHours: number, limit: number, topic?: string): Promise<any[]>;\n\n  createThread(userId: string, title?: string): Promise<ChatThread>;\n  getThread(threadId: number, userId: string): Promise<ChatThread | null>;\n  getUserThreads(userId: string): Promise<ChatThread[]>;\n  setThreadActiveBot(threadId: number, userId: string, botId: number | null): Promise<void>;\n  getOrCreateDefaultThread(userId: string): Promise<ChatThread>;\n  listThreadMessages(threadId: number, userId: string, limit?: number): Promise<ChatMessage[]>;\n  addThreadMessage(data: InsertChatMessage): Promise<ChatMessage>;\n  updateChatMessageStatus(id: number, userId: string, status: string): Promise<void>;\n  savePendingCommand(messageId: number, userId: string, commandJson: any): Promise<void>;\n  clearPendingCommand(messageId: number, userId: string): Promise<void>;\n\n  getChatMessages(userId: string, limit?: number): Promise<ChatMessage[]>;\n  createChatMessage(data: InsertChatMessage): Promise<ChatMessage>;\n\n  getSetting(key: string): Promise<string | undefined>;\n  setSetting(key: string, value: string): Promise<void>;\n\n  // Presets\n  listPresets(): Promise<Preset[]>;\n  getPresetById(id: number): Promise<Preset | undefined>;\n\n  // Profiles\n  listProfiles(userId: string): Promise<(Profile & { presetName: string })[]>;\n  getProfile(id: number, userId: string): Promise<(Profile & { presetName: string }) | undefined>;\n  getProfileById(id: number): Promise<Profile | undefined>;\n  getProfileByUserAndTopic(userId: string, topic: string): Promise<Profile | undefined>;\n  createProfile(data: InsertProfile): Promise<Profile>;\n  updateProfile(id: number, userId: string, patch: Partial<InsertProfile>): Promise<Profile | undefined>;\n  deleteProfile(id: number, userId: string): Promise<void>;\n  cloneProfile(id: number, userId: string): Promise<Profile | undefined>;\n\n  // Sources (updated for userId support)\n  listSources(userId: string, topic?: string): Promise<Source[]>;\n  getUserSource(id: number, userId: string): Promise<Source | undefined>;\n  createUserSource(userId: string, data: Omit<InsertSource, 'userId'>): Promise<Source>;\n  updateUserSource(userId: string, sourceId: number, patch: Partial<InsertSource>): Promise<Source | undefined>;\n  deleteUserSource(userId: string, sourceId: number): Promise<void>;\n\n  // Profile-Sources\n  getProfileSources(profileId: number, userId: string): Promise<Source[]>;\n  getProfileSourcesWithWeight(profileId: number, userId: string): Promise<(Source & { weight: number; isEnabled: boolean })[]>;\n  setProfileSources(profileId: number, userId: string, sourceData: Array<{ sourceId: number; weight?: number; isEnabled?: boolean }>): Promise<void>;\n  updateProfileSourceWeight(profileId: number, userId: string, sourceId: number, weight: number): Promise<void>;\n\n  // Report Job helpers\n  getActiveReportProfiles(): Promise<(Profile & { presetOutputType: string })[]>;\n  getProfileSourceIds(profileId: number): Promise<number[]>;\n  getItemsForReport(topic: string | null, sourceIds: number[], lookbackHours: number, limit: number): Promise<(Item & { importanceScore: number; sourceName: string })[]>;\n  listAnalyzedItemsForReport(params: {\n    topic?: string | null;\n    sourceIds: number[];\n    periodStart: Date;\n    periodEnd: Date;\n    limit?: number;\n  }): Promise<Array<{\n    id: number;\n    title: string | null;\n    url: string;\n    sourceName: string;\n    publishedAt: Date | null;\n    relevanceScore: number | null;\n    replyWorthinessScore: number | null;\n    summaryShort: string;\n  }>>;\n  \n  // Outputs (new unified table) management\n  createOutputRecord(data: InsertOutput): Promise<Output>;\n  outputExists(profileId: number, periodStart: Date, periodEnd: Date): Promise<boolean>;\n  linkOutputItems(outputId: number, itemIds: number[]): Promise<void>;\n  listOutputs(params: { userId: string; profileId?: number; from?: Date; to?: Date }): Promise<Output[]>;\n  getOutputById(params: { userId: string; outputId: number }): Promise<Output | null>;\n  updateOutputContent(outputId: number, patch: { contentText: string; title: string; reportStage: string }): Promise<Output | null>;\n  updateProfileLastRunAt(profileId: number, runAt: Date): Promise<void>;\n  getRecentItemsBySourceIds(sourceIds: number[], lookbackHours: number, limit: number): Promise<{ id: number; title: string | null; url: string; status: string; sourceName: string; sourceTopic: string; publishedAt: Date | null }[]>;\n\n  // ============================================\n  // BOTS - Step 8-1 Bot Management\n  // ============================================\n  listBots(userId: string): Promise<(Bot & { settings: BotSettings | null })[]>;\n  getBot(id: number, userId: string): Promise<(Bot & { settings: BotSettings | null }) | undefined>;\n  getBotByKey(userId: string, key: string): Promise<Bot | undefined>;\n  createBot(data: InsertBot): Promise<Bot>;\n  updateBot(id: number, userId: string, patch: Partial<InsertBot>): Promise<Bot | undefined>;\n  deleteBot(id: number, userId: string): Promise<void>;\n\n  // Bot Settings\n  getBotSettings(botId: number): Promise<BotSettings | undefined>;\n  createBotSettings(data: InsertBotSettings): Promise<BotSettings>;\n  updateBotSettings(botId: number, patch: Partial<Omit<InsertBotSettings, 'botId'>>): Promise<BotSettings | undefined>;\n  upsertBotSettings(userId: string, botId: number, input: Partial<Omit<InsertBotSettings, 'botId'>>): Promise<BotSettings>;\n\n  // Source-Bot Links\n  getBotSources(botId: number): Promise<(Source & { weight: number; isEnabled: boolean })[]>;\n  setBotSources(botId: number, userId: string, sourceData: Array<{ sourceId: number; weight?: number; isEnabled?: boolean }>): Promise<void>;\n  addSourceToBot(botId: number, userId: string, sourceId: number, weight?: number): Promise<void>;\n  removeSourceFromBot(botId: number, userId: string, sourceId: number): Promise<void>;\n\n  // Default bot creation on first login\n  ensureDefaultBots(userId: string): Promise<Bot[]>;\n\n  // ============================================\n  // LLM PROVIDERS - Phase 3 BYO LLM\n  // ============================================\n  createLlmProvider(data: InsertLlmProvider): Promise<LlmProvider>;\n  listLlmProviders(userId: string): Promise<LlmProvider[]>;\n  listAllLlmProviders?(): Promise<LlmProvider[]>;\n  getLlmProvider(id: number, userId: string): Promise<LlmProvider | undefined>;\n  updateLlmProvider(id: number, userId: string, patch: Partial<Omit<InsertLlmProvider, 'userId'>>): Promise<LlmProvider | undefined>;\n  deleteLlmProvider(id: number, userId: string): Promise<void>;\n  resolveLLMForBot(botId: number): Promise<{ providerType: string; apiKey: string; baseUrl: string | null; model: string | null } | null>;\n  resolveLLMForProfile(userId: string, topic: string): Promise<{ providerType: string; apiKey: string; baseUrl: string | null; model: string | null } | null>;\n  getBotByUserAndKey(userId: string, key: string): Promise<Bot | undefined>;\n  findSourceByUrl(url: string): Promise<Source | undefined>;\n  createBotFromPreset(params: {\n    userId: string;\n    key: string;\n    name: string;\n    settings: Partial<Omit<InsertBotSettings, 'botId'>>;\n    sourceData: Array<{ name: string; url: string; type?: string; topic: string }>;\n  }): Promise<Bot>;\n\n  // Job Runs\n  createJobRun(data: Omit<InsertJobRun, 'id'>): Promise<JobRun>;\n  finishJobRun(id: number, patch: Partial<InsertJobRun>): Promise<JobRun | null>;\n  listJobRunsForBot(userId: string, botId: number, limit?: number): Promise<JobRun[]>;\n  getLastJobRunForBot(userId: string, botId: number): Promise<JobRun | null>;\n  getLastJobRunByBotKey(userId: string, botKey: string): Promise<JobRun | null>;\n\n  // Report Metrics\n  createReportMetric(data: { reportId: number; profileId: number; itemCount: number; keywordSummary: Record<string, number>; sourceDistribution: Record<string, number> }): Promise<any>;\n  getReportMetricsForProfile(profileId: number, limit?: number): Promise<any[]>;\n\n  // Permissions\n  listPermissions(userId: string, scope: string, scopeId: number | null): Promise<Permission[]>;\n  upsertPermission(userId: string, scope: string, scopeId: number | null, permissionKey: string, valueJson: any): Promise<Permission>;\n  deletePermission(userId: string, scope: string, scopeId: number | null, permissionKey: string): Promise<void>;\n  listAllUserPermissions(userId: string): Promise<Permission[]>;\n\n  // Audit Log\n  createAuditLog(entry: { userId: string; botId?: number | null; threadId?: string | null; eventType: string; permissionKey?: string | null; payloadJson?: any }): Promise<void>;\n  listAuditLogs(userId: string, filters?: { botId?: number; eventType?: string; permissionKey?: string; limit?: number; since?: Date }): Promise<any[]>;\n\n  // Rule Memories\n  listRuleMemories(userId: string, scope: string, scopeId: number | null): Promise<RuleMemory[]>;\n  listAllUserRuleMemories(userId: string): Promise<RuleMemory[]>;\n  upsertRuleMemory(userId: string, scope: string, scopeId: number | null, key: string, valueJson: any): Promise<RuleMemory>;\n  deleteRuleMemory(userId: string, scope: string, scopeId: number | null, key: string): Promise<void>;\n  getEffectiveRules(userId: string, botId: number | null): Promise<Record<string, any>>;\n\n  getTelegramLinkByUserId(userId: string): Promise<TelegramLink | null>;\n  getTelegramLinkByChatId(chatId: string): Promise<TelegramLink | null>;\n  createTelegramLink(data: { userId: string; telegramChatId: string; telegramUsername?: string; threadId: number }): Promise<TelegramLink>;\n  deleteTelegramLink(userId: string): Promise<void>;\n  createLinkCode(userId: string, platform: string): Promise<string>;\n  consumeLinkCode(code: string): Promise<{ userId: string; platform: string } | null>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getStats() {\n    const result = await db\n      .select({\n        status: items.status,\n        count: count(),\n      })\n      .from(items)\n      .groupBy(items.status);\n\n    const stats: {\n      total: number;\n      new: number;\n      analyzed: number;\n      drafted: number;\n      approved: number;\n      posted: number;\n      skipped: number;\n      lastCollectAt: string | null;\n      lastAnalyzeAt: string | null;\n    } = {\n      total: 0,\n      new: 0,\n      analyzed: 0,\n      drafted: 0,\n      approved: 0,\n      posted: 0,\n      skipped: 0,\n      lastCollectAt: null,\n      lastAnalyzeAt: null,\n    };\n\n    for (const row of result) {\n      const c = Number(row.count);\n      stats.total += c;\n      if (row.status in stats) {\n        (stats as any)[row.status] = c;\n      }\n    }\n\n    const lastCollect = await db\n      .select({ insertedAt: items.insertedAt })\n      .from(items)\n      .orderBy(desc(items.insertedAt))\n      .limit(1);\n    \n    if (lastCollect.length > 0 && lastCollect[0].insertedAt) {\n      stats.lastCollectAt = lastCollect[0].insertedAt.toISOString();\n    }\n\n    const lastAnalyze = await db\n      .select({ createdAt: analysis.createdAt })\n      .from(analysis)\n      .orderBy(desc(analysis.createdAt))\n      .limit(1);\n    \n    if (lastAnalyze.length > 0 && lastAnalyze[0].createdAt) {\n      stats.lastAnalyzeAt = lastAnalyze[0].createdAt.toISOString();\n    }\n\n    return stats;\n  }\n\n  async getSources(): Promise<(Source & { itemCount: number })[]> {\n    const result = await db\n      .select({\n        source: sources,\n        itemCount: sql<number>`COALESCE(COUNT(${items.id}), 0)`.as(\"item_count\"),\n      })\n      .from(sources)\n      .leftJoin(items, eq(items.sourceId, sources.id))\n      .groupBy(sources.id)\n      .orderBy(desc(sources.createdAt));\n\n    return result.map((r) => ({\n      ...r.source,\n      itemCount: Number(r.itemCount),\n    }));\n  }\n\n  async getSource(id: number): Promise<Source | undefined> {\n    const [source] = await db.select().from(sources).where(eq(sources.id, id));\n    return source;\n  }\n\n  async createSource(data: InsertSource): Promise<Source> {\n    const [source] = await db.insert(sources).values(data).returning();\n    return source;\n  }\n\n  async updateSource(id: number, data: Partial<InsertSource>): Promise<Source | undefined> {\n    const [source] = await db.update(sources).set(data).where(eq(sources.id, id)).returning();\n    return source;\n  }\n\n  async deleteSource(id: number): Promise<void> {\n    await db.delete(sources).where(eq(sources.id, id));\n  }\n\n  async getItems(status?: string): Promise<(Item & { sourceName: string; relevanceScore?: number; replyWorthinessScore?: number })[]> {\n    let query = db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        relevanceScore: analysis.relevanceScore,\n        replyWorthinessScore: analysis.replyWorthinessScore,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .leftJoin(analysis, eq(analysis.itemId, items.id))\n      .orderBy(desc(items.insertedAt));\n\n    if (status && status !== \"all\") {\n      query = query.where(eq(items.status, status)) as any;\n    }\n\n    const result = await query;\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n      relevanceScore: r.relevanceScore ?? undefined,\n      replyWorthinessScore: r.replyWorthinessScore ?? undefined,\n    }));\n  }\n\n  async getRecentItems(limit: number = 10): Promise<(Item & { sourceName: string })[]> {\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .orderBy(desc(items.insertedAt))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n    }));\n  }\n\n  async getObserveItems(limit: number = 50): Promise<any[]> {\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        relevanceScore: analysis.relevanceScore,\n        replyWorthinessScore: analysis.replyWorthinessScore,\n        category: analysis.category,\n        summaryShort: analysis.summaryShort,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .leftJoin(analysis, eq(items.id, analysis.itemId))\n      .where(\n        and(\n          eq(items.status, \"skipped\"),\n          gte(analysis.relevanceScore, 60),\n          lt(analysis.replyWorthinessScore, 50)\n        )\n      )\n      .orderBy(desc(analysis.relevanceScore))\n      .limit(limit);\n\n    return result.map((r) => ({\n      id: r.item.id,\n      title: r.item.title,\n      url: r.item.url,\n      sourceName: r.sourceName || \"Unknown\",\n      status: r.item.status,\n      publishedAt: r.item.publishedAt,\n      relevanceScore: r.relevanceScore || 0,\n      replyWorthinessScore: r.replyWorthinessScore || 0,\n      category: r.category || \"other\",\n      summaryShort: r.summaryShort || \"\",\n    }));\n  }\n\n  async getItem(id: number): Promise<(Item & { sourceName: string; analysis?: Analysis; drafts: Draft[] }) | undefined> {\n    const [itemResult] = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .where(eq(items.id, id));\n\n    if (!itemResult) return undefined;\n\n    const [analysisResult] = await db.select().from(analysis).where(eq(analysis.itemId, id));\n    const draftsResult = await db.select().from(drafts).where(eq(drafts.itemId, id)).orderBy(drafts.variant);\n\n    return {\n      ...itemResult.item,\n      sourceName: itemResult.sourceName || \"Unknown\",\n      analysis: analysisResult,\n      drafts: draftsResult,\n    };\n  }\n\n  async getItemsByStatus(status: string, limit: number = 10): Promise<(Item & { sourceName: string; sourceTopic: string; rulesJson?: unknown })[]> {\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        sourceTopic: sources.topic,\n        rulesJson: sources.rulesJson,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .where(eq(items.status, status))\n      .orderBy(desc(items.insertedAt))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n      sourceTopic: r.sourceTopic || \"general\",\n      rulesJson: r.rulesJson,\n    }));\n  }\n\n  async getItemsByStatusAndSourceIds(status: string, sourceIds: number[], limit: number = 50): Promise<(Item & { sourceName: string; sourceTopic: string; rulesJson?: unknown })[]> {\n    if (sourceIds.length === 0) return [];\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        sourceTopic: sources.topic,\n        rulesJson: sources.rulesJson,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(\n        eq(items.status, status),\n        inArray(items.sourceId, sourceIds)\n      ))\n      .orderBy(desc(items.insertedAt))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n      sourceTopic: r.sourceTopic || \"general\",\n      rulesJson: r.rulesJson,\n    }));\n  }\n\n  async createItem(data: InsertItem): Promise<Item> {\n    const [item] = await db.insert(items).values(data).returning();\n    return item;\n  }\n\n  async findItemByDedupeKey(sourceId: number, url: string): Promise<Item | undefined> {\n    const [item] = await db.select().from(items)\n      .where(and(eq(items.sourceId, sourceId), eq(items.url, url)))\n      .limit(1);\n    return item;\n  }\n\n  async updateItemStatus(id: number, status: string): Promise<void> {\n    await db.update(items).set({ status }).where(eq(items.id, id));\n  }\n\n  async createAnalysis(data: InsertAnalysis): Promise<Analysis> {\n    const [result] = await db.insert(analysis).values(data).returning();\n    return result;\n  }\n\n  async getAnalysisByItemId(itemId: number): Promise<Analysis | undefined> {\n    const [result] = await db.select().from(analysis).where(eq(analysis.itemId, itemId));\n    return result;\n  }\n\n  async getDrafts(decision?: string): Promise<(Draft & { itemTitle: string; itemUrl: string; sourceName: string })[]> {\n    let query = db\n      .select({\n        draft: drafts,\n        itemTitle: items.title,\n        itemUrl: items.url,\n        sourceName: sources.name,\n      })\n      .from(drafts)\n      .innerJoin(items, eq(drafts.itemId, items.id))\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .orderBy(desc(drafts.createdAt));\n\n    if (decision && decision !== \"all\") {\n      query = query.where(eq(drafts.adminDecision, decision)) as any;\n    }\n\n    const result = await query;\n    return result.map((r) => ({\n      ...r.draft,\n      itemTitle: r.itemTitle || \"Untitled\",\n      itemUrl: r.itemUrl,\n      sourceName: r.sourceName || \"Unknown\",\n    }));\n  }\n\n  async getDraftsByItemId(itemId: number): Promise<Draft[]> {\n    return db.select().from(drafts).where(eq(drafts.itemId, itemId)).orderBy(drafts.variant);\n  }\n\n  async createDraft(data: InsertDraft): Promise<Draft> {\n    const [draft] = await db.insert(drafts).values(data).returning();\n    return draft;\n  }\n\n  async updateDraftDecision(id: number, decision: string, finalText?: string): Promise<void> {\n    // Update the draft's decision\n    await db.update(drafts).set({ adminDecision: decision, finalText }).where(eq(drafts.id, id));\n    \n    // Get the draft to find the associated item\n    const [draft] = await db.select({ itemId: drafts.itemId }).from(drafts).where(eq(drafts.id, id));\n    \n    if (draft && decision === \"approved\") {\n      // Update the item status to approved\n      await db.update(items).set({ status: \"approved\" }).where(eq(items.id, draft.itemId));\n    }\n  }\n\n  async getReports(limit: number = 20): Promise<Report[]> {\n    return db.select().from(reports).orderBy(desc(reports.createdAt)).limit(limit);\n  }\n\n  async getReport(id: number): Promise<Report | undefined> {\n    const [report] = await db.select().from(reports).where(eq(reports.id, id));\n    return report;\n  }\n\n  async createReport(data: InsertReport): Promise<Report> {\n    const [report] = await db.insert(reports).values(data).returning();\n    return report;\n  }\n\n  async getAnalyzedItemsForBrief(lookbackHours: number, limit: number, topic?: string): Promise<any[]> {\n    const cutoff = new Date(Date.now() - lookbackHours * 60 * 60 * 1000);\n    \n    const conditions = [gte(items.insertedAt, cutoff)];\n    \n    if (topic) {\n      conditions.push(eq(sources.topic, topic));\n    }\n    \n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        sourceUrl: sources.url,\n        sourceTopic: sources.topic,\n        analysisData: analysis,\n      })\n      .from(items)\n      .innerJoin(analysis, eq(items.id, analysis.itemId))\n      .innerJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(...conditions))\n      .orderBy(desc(analysis.relevanceScore))\n      .limit(limit);\n\n    return result.map((r) => ({\n      id: r.item.id,\n      title: r.item.title,\n      url: r.item.url,\n      source: r.sourceName || \"Unknown\",\n      topic: r.sourceTopic,\n      key_takeaway: r.analysisData.summaryShort,\n      why_it_matters: r.analysisData.suggestedAngle,\n      impact_scope: {\n        equities: r.analysisData.relevanceScore,\n        rates_fx: Math.floor(r.analysisData.relevanceScore * 0.7),\n        commodities: Math.floor(r.analysisData.relevanceScore * 0.5),\n        crypto: Math.floor(r.analysisData.relevanceScore * 0.8),\n      },\n      risk_flags: r.analysisData.riskFlagsJson || [],\n      confidence: r.analysisData.relevanceScore,\n      category: r.analysisData.category,\n    }));\n  }\n\n  async createThread(userId: string, title?: string): Promise<ChatThread> {\n    const [thread] = await db.insert(chatThreads).values({\n      userId,\n      title: title || null,\n    }).returning();\n    return thread;\n  }\n\n  async getThread(threadId: number, userId: string): Promise<ChatThread | null> {\n    const [thread] = await db.select().from(chatThreads)\n      .where(and(eq(chatThreads.id, threadId), eq(chatThreads.userId, userId)));\n    return thread || null;\n  }\n\n  async getUserThreads(userId: string): Promise<ChatThread[]> {\n    return db.select().from(chatThreads)\n      .where(eq(chatThreads.userId, userId))\n      .orderBy(desc(chatThreads.createdAt));\n  }\n\n  async setThreadActiveBot(threadId: number, userId: string, botId: number | null): Promise<void> {\n    await db.update(chatThreads)\n      .set({ activeBotId: botId })\n      .where(and(eq(chatThreads.id, threadId), eq(chatThreads.userId, userId)));\n  }\n\n  async getOrCreateDefaultThread(userId: string): Promise<ChatThread> {\n    const threads = await this.getUserThreads(userId);\n    if (threads.length > 0) return threads[0];\n    return this.createThread(userId, \"Default Thread\");\n  }\n\n  async listThreadMessages(threadId: number, userId: string, limit: number = 100): Promise<ChatMessage[]> {\n    const thread = await this.getThread(threadId, userId);\n    if (!thread) return [];\n    return db.select().from(chatMessages)\n      .where(and(eq(chatMessages.threadId, threadId), eq(chatMessages.userId, userId)))\n      .orderBy(desc(chatMessages.createdAt)).limit(limit);\n  }\n\n  async addThreadMessage(data: InsertChatMessage): Promise<ChatMessage> {\n    const [msg] = await db.insert(chatMessages).values(data).returning();\n    return msg;\n  }\n\n  async updateChatMessageStatus(id: number, userId: string, status: string): Promise<void> {\n    await db.update(chatMessages)\n      .set({ status })\n      .where(and(eq(chatMessages.id, id), eq(chatMessages.userId, userId)));\n  }\n\n  async savePendingCommand(messageId: number, userId: string, commandJson: any): Promise<void> {\n    await db.update(chatMessages)\n      .set({ commandJson, kind: \"pending_command\", status: \"pending_confirm\" })\n      .where(and(eq(chatMessages.id, messageId), eq(chatMessages.userId, userId)));\n  }\n\n  async clearPendingCommand(messageId: number, userId: string): Promise<void> {\n    await db.update(chatMessages)\n      .set({ status: \"done\" })\n      .where(and(eq(chatMessages.id, messageId), eq(chatMessages.userId, userId)));\n  }\n\n  async getChatMessages(userId: string, limit: number = 50): Promise<ChatMessage[]> {\n    return db.select().from(chatMessages)\n      .where(eq(chatMessages.userId, userId))\n      .orderBy(desc(chatMessages.createdAt)).limit(limit);\n  }\n\n  async createChatMessage(data: InsertChatMessage): Promise<ChatMessage> {\n    const [msg] = await db.insert(chatMessages).values(data).returning();\n    return msg;\n  }\n\n  async getSetting(key: string): Promise<string | undefined> {\n    const [row] = await db.select().from(settings).where(eq(settings.key, key));\n    return row?.value;\n  }\n\n  async setSetting(key: string, value: string): Promise<void> {\n    await db.insert(settings).values({ key, value }).onConflictDoUpdate({\n      target: settings.key,\n      set: { value, updatedAt: new Date() }\n    });\n  }\n\n  // ============================================\n  // PRESETS\n  // ============================================\n  async listPresets(): Promise<Preset[]> {\n    return db.select().from(presets).orderBy(presets.name);\n  }\n\n  async getPresetById(id: number): Promise<Preset | undefined> {\n    const [preset] = await db.select().from(presets).where(eq(presets.id, id));\n    return preset;\n  }\n\n  // ============================================\n  // PROFILES\n  // ============================================\n  async listProfiles(userId: string): Promise<(Profile & { presetName: string })[]> {\n    const result = await db\n      .select({\n        profile: profiles,\n        presetName: presets.name,\n      })\n      .from(profiles)\n      .leftJoin(presets, eq(profiles.presetId, presets.id))\n      .where(eq(profiles.userId, userId))\n      .orderBy(desc(profiles.createdAt));\n\n    return result.map((r) => ({\n      ...r.profile,\n      presetName: r.presetName || \"Unknown\",\n    }));\n  }\n\n  async getProfile(id: number, userId: string): Promise<(Profile & { presetName: string }) | undefined> {\n    const [result] = await db\n      .select({\n        profile: profiles,\n        presetName: presets.name,\n      })\n      .from(profiles)\n      .leftJoin(presets, eq(profiles.presetId, presets.id))\n      .where(and(eq(profiles.id, id), eq(profiles.userId, userId)));\n\n    if (!result) return undefined;\n\n    return {\n      ...result.profile,\n      presetName: result.presetName || \"Unknown\",\n    };\n  }\n\n  async getProfileById(id: number): Promise<Profile | undefined> {\n    const [result] = await db\n      .select()\n      .from(profiles)\n      .where(eq(profiles.id, id));\n    return result;\n  }\n\n  async getProfileByUserAndTopic(userId: string, topic: string): Promise<Profile | undefined> {\n    const [result] = await db\n      .select()\n      .from(profiles)\n      .where(and(eq(profiles.userId, userId), eq(profiles.topic, topic)))\n      .orderBy(desc(profiles.createdAt))\n      .limit(1);\n    return result;\n  }\n\n  async createProfile(data: InsertProfile): Promise<Profile> {\n    const [profile] = await db.insert(profiles).values(data).returning();\n    return profile;\n  }\n\n  async updateProfile(id: number, userId: string, patch: Partial<InsertProfile>): Promise<Profile | undefined> {\n    const [profile] = await db\n      .update(profiles)\n      .set(patch)\n      .where(and(eq(profiles.id, id), eq(profiles.userId, userId)))\n      .returning();\n    return profile;\n  }\n\n  async deleteProfile(id: number, userId: string): Promise<void> {\n    await db.delete(profiles).where(and(eq(profiles.id, id), eq(profiles.userId, userId)));\n  }\n\n  async cloneProfile(id: number, userId: string): Promise<Profile | undefined> {\n    const existing = await this.getProfile(id, userId);\n    if (!existing) return undefined;\n\n    const newProfile = await this.createProfile({\n      userId: existing.userId,\n      presetId: existing.presetId,\n      name: `${existing.name} (Copy)`,\n      topic: existing.topic,\n      variantKey: existing.variantKey,\n      timezone: existing.timezone,\n      scheduleCron: existing.scheduleCron,\n      configJson: existing.configJson as Record<string, unknown>,\n      isActive: existing.isActive,\n    });\n    \n    // Also clone profile sources with weights\n    const existingSources = await this.getProfileSourcesWithWeight(id, userId);\n    if (existingSources.length > 0) {\n      await this.setProfileSources(\n        newProfile.id, \n        userId, \n        existingSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }))\n      );\n    }\n\n    return newProfile;\n  }\n\n  // ============================================\n  // SOURCES (with userId support)\n  // ============================================\n  async listSources(userId: string, topic?: string): Promise<Source[]> {\n    // Return: system default sources (userId is null) + user's sources\n    const conditions = [\n      or(isNull(sources.userId), eq(sources.userId, userId))\n    ];\n    \n    if (topic) {\n      conditions.push(eq(sources.topic, topic));\n    }\n\n    return db\n      .select()\n      .from(sources)\n      .where(and(...conditions))\n      .orderBy(desc(sources.isDefault), sources.name);\n  }\n\n  async getUserSource(id: number, userId: string): Promise<Source | undefined> {\n    const [source] = await db\n      .select()\n      .from(sources)\n      .where(and(eq(sources.id, id), eq(sources.userId, userId)));\n    return source;\n  }\n\n  async createUserSource(userId: string, data: Omit<InsertSource, 'userId'>): Promise<Source> {\n    const [source] = await db.insert(sources).values({ ...data, userId }).returning();\n    return source;\n  }\n\n  async updateUserSource(userId: string, sourceId: number, patch: Partial<InsertSource>): Promise<Source | undefined> {\n    const [source] = await db\n      .update(sources)\n      .set(patch)\n      .where(and(eq(sources.id, sourceId), eq(sources.userId, userId)))\n      .returning();\n    return source;\n  }\n\n  async deleteUserSource(userId: string, sourceId: number): Promise<void> {\n    await db.delete(sources).where(and(eq(sources.id, sourceId), eq(sources.userId, userId)));\n  }\n\n  // ============================================\n  // PROFILE-SOURCES\n  // ============================================\n  async getProfileSources(profileId: number, userId: string): Promise<Source[]> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return [];\n\n    const result = await db\n      .select({ source: sources })\n      .from(profileSources)\n      .innerJoin(sources, eq(profileSources.sourceId, sources.id))\n      .where(eq(profileSources.profileId, profileId));\n\n    return result.map(r => r.source);\n  }\n\n  async getProfileSourcesWithWeight(profileId: number, userId: string): Promise<(Source & { weight: number; isEnabled: boolean })[]> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return [];\n\n    const result = await db\n      .select({ \n        source: sources, \n        weight: profileSources.weight,\n        isEnabled: profileSources.isEnabled\n      })\n      .from(profileSources)\n      .innerJoin(sources, eq(profileSources.sourceId, sources.id))\n      .where(eq(profileSources.profileId, profileId))\n      .orderBy(desc(profileSources.weight));\n\n    return result.map(r => ({ ...r.source, weight: r.weight, isEnabled: r.isEnabled }));\n  }\n\n  async setProfileSources(\n    profileId: number, \n    userId: string, \n    sourceData: Array<{ sourceId: number; weight?: number; isEnabled?: boolean }>\n  ): Promise<void> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return;\n\n    await db.delete(profileSources).where(eq(profileSources.profileId, profileId));\n\n    if (sourceData.length > 0) {\n      const sourceIds = sourceData.map(s => s.sourceId);\n      \n      const validSources = await db\n        .select({ id: sources.id })\n        .from(sources)\n        .where(and(\n          inArray(sources.id, sourceIds),\n          eq(sources.topic, profile.topic)\n        ));\n\n      const validSourceIds = new Set(validSources.map(s => s.id));\n\n      if (validSourceIds.size !== sourceIds.length) {\n        console.warn(`[setProfileSources] Topic mismatch: ${sourceIds.length - validSourceIds.size} sources filtered out for profile ${profileId} (topic: ${profile.topic})`);\n      }\n\n      const validData = sourceData.filter(s => validSourceIds.has(s.sourceId));\n\n      if (validData.length > 0) {\n        await db.insert(profileSources).values(\n          validData.map(s => ({ \n            profileId, \n            sourceId: s.sourceId,\n            weight: s.weight ?? 3,\n            isEnabled: s.isEnabled ?? true\n          }))\n        );\n      }\n    }\n  }\n  \n  async updateProfileSourceWeight(profileId: number, userId: string, sourceId: number, weight: number): Promise<void> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return;\n    \n    await db.update(profileSources)\n      .set({ weight: Math.min(5, Math.max(1, weight)) })\n      .where(and(\n        eq(profileSources.profileId, profileId),\n        eq(profileSources.sourceId, sourceId)\n      ));\n  }\n\n  // ============================================\n  // REPORT JOB HELPERS\n  // ============================================\n  async getActiveReportProfiles(): Promise<(Profile & { presetOutputType: string })[]> {\n    const result = await db\n      .select({\n        profile: profiles,\n        presetOutputType: presets.outputType,\n      })\n      .from(profiles)\n      .innerJoin(presets, eq(profiles.presetId, presets.id))\n      .where(and(\n        eq(profiles.isActive, true),\n        eq(presets.outputType, \"report\")\n      ));\n\n    return result.map((r) => ({\n      ...r.profile,\n      presetOutputType: r.presetOutputType,\n    }));\n  }\n\n  async getProfileSourceIds(profileId: number): Promise<number[]> {\n    const result = await db\n      .select({ sourceId: profileSources.sourceId })\n      .from(profileSources)\n      .where(eq(profileSources.profileId, profileId));\n\n    return result.map((r) => r.sourceId);\n  }\n\n  async getItemsForReport(\n    topic: string | null,\n    sourceIds: number[],\n    lookbackHours: number,\n    limit: number\n  ): Promise<(Item & { importanceScore: number; sourceName: string })[]> {\n    if (sourceIds.length === 0) return [];\n\n    const cutoff = new Date(Date.now() - lookbackHours * 60 * 60 * 1000);\n\n    const conditions = [\n      inArray(items.status, [\"analyzed\", \"drafted\", \"approved\"]),\n      inArray(items.sourceId, sourceIds),\n      gte(items.publishedAt, cutoff),\n    ];\n    if (topic) {\n      conditions.push(eq(items.topic, topic));\n    }\n\n    const result = await db\n      .select({\n        item: items,\n        importanceScore: analysis.importanceScore,\n        sourceName: sources.name,\n      })\n      .from(items)\n      .innerJoin(analysis, eq(items.id, analysis.itemId))\n      .innerJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(...conditions))\n      .orderBy(desc(analysis.importanceScore))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      importanceScore: r.importanceScore,\n      sourceName: r.sourceName,\n    }));\n  }\n\n  async listAnalyzedItemsForReport(params: {\n    topic: string;\n    sourceIds: number[];\n    periodStart: Date;\n    periodEnd: Date;\n    limit?: number;\n  }): Promise<Array<{\n    id: number;\n    title: string | null;\n    url: string;\n    sourceName: string;\n    publishedAt: Date | null;\n    relevanceScore: number | null;\n    replyWorthinessScore: number | null;\n    summaryShort: string;\n  }>> {\n    if (!params.sourceIds.length) return [];\n\n    const limit = params.limit ?? 50;\n\n    const rows = await db\n      .select({\n        id: items.id,\n        title: items.title,\n        url: items.url,\n        sourceName: sources.name,\n        publishedAt: items.publishedAt,\n        relevanceScore: analysis.relevanceScore,\n        replyWorthinessScore: analysis.replyWorthinessScore,\n        summaryShort: analysis.summaryShort,\n      })\n      .from(items)\n      .innerJoin(analysis, eq(analysis.itemId, items.id))\n      .innerJoin(sources, eq(sources.id, items.sourceId))\n      .where(\n        and(\n          ...(params.topic ? [eq(items.topic, params.topic)] : []),\n          inArray(items.sourceId, params.sourceIds),\n          eq(items.status, \"analyzed\"),\n          gte(items.publishedAt, params.periodStart),\n          lte(items.publishedAt, params.periodEnd)\n        )\n      )\n      .orderBy(desc(analysis.relevanceScore))\n      .limit(limit);\n\n    return rows;\n  }\n\n  // ============================================\n  // OUTPUTS (NEW UNIFIED TABLE) MANAGEMENT\n  // ============================================\n  \n  async outputExists(profileId: number, periodStart: Date, periodEnd: Date): Promise<boolean> {\n    const windowStart = new Date(periodEnd.getTime() - 23 * 60 * 60 * 1000);\n    const rows = await db\n      .select({ id: outputs.id })\n      .from(outputs)\n      .where(and(\n        eq(outputs.profileId, profileId),\n        gte(outputs.createdAt, windowStart),\n      ))\n      .limit(1);\n\n    return rows.length > 0;\n  }\n\n  async createOutputRecord(data: InsertOutput): Promise<Output> {\n    const [output] = await db.insert(outputs).values(data).returning();\n    return output;\n  }\n\n  async linkOutputItems(outputId: number, itemIds: number[]): Promise<void> {\n    if (itemIds.length === 0) return;\n\n    await db.insert(outputItems).values(\n      itemIds.map((itemId) => ({\n        outputId,\n        itemId,\n      }))\n    );\n  }\n\n  async listOutputs(params: { userId: string; profileId?: number; from?: Date; to?: Date }): Promise<Output[]> {\n    const conditions = [\n      eq(outputs.userId, params.userId),\n      eq(outputs.outputType, \"report\")\n    ];\n\n    if (params.profileId) {\n      conditions.push(eq(outputs.profileId, params.profileId));\n    }\n    if (params.from) {\n      conditions.push(gte(outputs.createdAt, params.from));\n    }\n    if (params.to) {\n      conditions.push(lte(outputs.createdAt, params.to));\n    }\n\n    return db\n      .select()\n      .from(outputs)\n      .where(and(...conditions))\n      .orderBy(desc(outputs.createdAt))\n      .limit(50);\n  }\n\n  async getOutputById(params: { userId: string; outputId: number }): Promise<Output | null> {\n    const rows = await db\n      .select()\n      .from(outputs)\n      .where(and(\n        eq(outputs.id, params.outputId),\n        eq(outputs.userId, params.userId),\n        eq(outputs.outputType, \"report\")\n      ))\n      .limit(1);\n\n    return rows[0] ?? null;\n  }\n\n  async updateOutputContent(outputId: number, patch: { contentText: string; title: string; reportStage: string }): Promise<Output | null> {\n    const [updated] = await db\n      .update(outputs)\n      .set({ ...patch, updatedAt: new Date() })\n      .where(eq(outputs.id, outputId))\n      .returning();\n    return updated ?? null;\n  }\n\n  async getRecentItemsBySourceIds(sourceIds: number[], lookbackHours: number, limit: number): Promise<{ id: number; title: string | null; url: string; status: string; sourceName: string; sourceTopic: string; publishedAt: Date | null }[]> {\n    if (sourceIds.length === 0) return [];\n    const cutoff = new Date(Date.now() - lookbackHours * 60 * 60 * 1000);\n    const result = await db\n      .select({\n        id: items.id,\n        title: items.title,\n        url: items.url,\n        status: items.status,\n        sourceName: sources.name,\n        sourceTopic: sources.topic,\n        publishedAt: items.publishedAt,\n      })\n      .from(items)\n      .innerJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(\n        inArray(items.sourceId, sourceIds),\n        gte(items.publishedAt, cutoff),\n      ))\n      .orderBy(desc(items.publishedAt))\n      .limit(limit);\n    return result;\n  }\n\n  async updateProfileLastRunAt(profileId: number, runAt: Date): Promise<void> {\n    await db\n      .update(profiles)\n      .set({ lastRunAt: runAt })\n      .where(eq(profiles.id, profileId));\n  }\n\n  // ============================================\n  // BOTS - Step 8-1 Bot Management\n  // ============================================\n\n  async listBots(userId: string): Promise<(Bot & { settings: BotSettings | null })[]> {\n    const botsData = await db\n      .select()\n      .from(bots)\n      .where(eq(bots.userId, userId))\n      .orderBy(desc(bots.createdAt));\n\n    const result: (Bot & { settings: BotSettings | null })[] = [];\n    for (const bot of botsData) {\n      const [settings] = await db\n        .select()\n        .from(botSettings)\n        .where(eq(botSettings.botId, bot.id))\n        .limit(1);\n      result.push({ ...bot, settings: settings ?? null });\n    }\n    return result;\n  }\n\n  async getBot(id: number, userId: string): Promise<(Bot & { settings: BotSettings | null }) | undefined> {\n    const [bot] = await db\n      .select()\n      .from(bots)\n      .where(and(eq(bots.id, id), eq(bots.userId, userId)))\n      .limit(1);\n\n    if (!bot) return undefined;\n\n    const [settings] = await db\n      .select()\n      .from(botSettings)\n      .where(eq(botSettings.botId, bot.id))\n      .limit(1);\n\n    return { ...bot, settings: settings ?? null };\n  }\n\n  async getBotByKey(userId: string, key: string): Promise<Bot | undefined> {\n    const [bot] = await db\n      .select()\n      .from(bots)\n      .where(and(eq(bots.userId, userId), eq(bots.key, key)))\n      .limit(1);\n    return bot;\n  }\n\n  async createBot(data: InsertBot): Promise<Bot> {\n    const [bot] = await db.insert(bots).values(data).returning();\n    return bot;\n  }\n\n  async updateBot(id: number, userId: string, patch: Partial<InsertBot>): Promise<Bot | undefined> {\n    const [updated] = await db\n      .update(bots)\n      .set(patch)\n      .where(and(eq(bots.id, id), eq(bots.userId, userId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteBot(id: number, userId: string): Promise<void> {\n    await db.delete(bots).where(and(eq(bots.id, id), eq(bots.userId, userId)));\n  }\n\n  // Bot Settings\n  async getBotSettings(botId: number): Promise<BotSettings | undefined> {\n    const [settings] = await db\n      .select()\n      .from(botSettings)\n      .where(eq(botSettings.botId, botId))\n      .limit(1);\n    return settings;\n  }\n\n  async createBotSettings(data: InsertBotSettings): Promise<BotSettings> {\n    const [settings] = await db.insert(botSettings).values(data).returning();\n    return settings;\n  }\n\n  async updateBotSettings(botId: number, patch: Partial<Omit<InsertBotSettings, 'botId'>>): Promise<BotSettings | undefined> {\n    const [updated] = await db\n      .update(botSettings)\n      .set({ ...patch, updatedAt: new Date() })\n      .where(eq(botSettings.botId, botId))\n      .returning();\n    return updated;\n  }\n\n  async upsertBotSettings(userId: string, botId: number, input: Partial<Omit<InsertBotSettings, 'botId'>>): Promise<BotSettings> {\n    const bot = await this.getBot(botId, userId);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    const existing = await this.getBotSettings(botId);\n    if (existing) {\n      const updated = await this.updateBotSettings(botId, input);\n      return updated!;\n    } else {\n      return this.createBotSettings({ botId, ...input } as InsertBotSettings);\n    }\n  }\n\n  // Source-Bot Links\n  async getBotSources(botId: number): Promise<(Source & { weight: number; isEnabled: boolean })[]> {\n    const links = await db\n      .select({\n        source: sources,\n        weight: sourceBotLinks.weight,\n        isEnabled: sourceBotLinks.isEnabled,\n      })\n      .from(sourceBotLinks)\n      .innerJoin(sources, eq(sourceBotLinks.sourceId, sources.id))\n      .where(eq(sourceBotLinks.botId, botId));\n\n    return links.map(({ source, weight, isEnabled }) => ({\n      ...source,\n      weight,\n      isEnabled,\n    }));\n  }\n\n  async setBotSources(botId: number, userId: string, sourceData: Array<{ sourceId: number; weight?: number; isEnabled?: boolean }>): Promise<void> {\n    // Verify bot belongs to user\n    const [bot] = await db.select().from(bots).where(and(eq(bots.id, botId), eq(bots.userId, userId))).limit(1);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    // Validate source ownership: only user's own sources or default sources\n    if (sourceData.length > 0) {\n      const sourceIds = sourceData.map(s => s.sourceId);\n      const validSources = await db.select({ id: sources.id })\n        .from(sources)\n        .where(and(\n          inArray(sources.id, sourceIds),\n          or(eq(sources.userId, userId), isNull(sources.userId))\n        ));\n      const validIds = new Set(validSources.map(s => s.id));\n      const invalid = sourceIds.filter(id => !validIds.has(id));\n      if (invalid.length > 0) {\n        throw new Error(`Source IDs not accessible: ${invalid.join(', ')}`);\n      }\n    }\n\n    // Delete existing links\n    await db.delete(sourceBotLinks).where(eq(sourceBotLinks.botId, botId));\n\n    // Insert new links\n    if (sourceData.length > 0) {\n      await db.insert(sourceBotLinks).values(\n        sourceData.map(({ sourceId, weight = 3, isEnabled = true }) => ({\n          botId,\n          sourceId,\n          weight,\n          isEnabled,\n        }))\n      );\n    }\n  }\n\n  async addSourceToBot(botId: number, userId: string, sourceId: number, weight: number = 3): Promise<void> {\n    const [bot] = await db.select().from(bots).where(and(eq(bots.id, botId), eq(bots.userId, userId))).limit(1);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    const [source] = await db.select().from(sources).where(and(\n      eq(sources.id, sourceId),\n      or(eq(sources.userId, userId), isNull(sources.userId))\n    )).limit(1);\n    if (!source) throw new Error(\"Source not found or access denied\");\n\n    const [existing] = await db.select().from(sourceBotLinks)\n      .where(and(eq(sourceBotLinks.botId, botId), eq(sourceBotLinks.sourceId, sourceId))).limit(1);\n    if (existing) return;\n\n    await db.insert(sourceBotLinks).values({ botId, sourceId, weight, isEnabled: true });\n  }\n\n  async removeSourceFromBot(botId: number, userId: string, sourceId: number): Promise<void> {\n    const [bot] = await db.select().from(bots).where(and(eq(bots.id, botId), eq(bots.userId, userId))).limit(1);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    await db.delete(sourceBotLinks).where(and(\n      eq(sourceBotLinks.botId, botId),\n      eq(sourceBotLinks.sourceId, sourceId)\n    ));\n  }\n\n  // Default bot creation on first login\n  async ensureDefaultBots(userId: string): Promise<Bot[]> {\n    const existingBots = await db.select().from(bots).where(eq(bots.userId, userId));\n    if (existingBots.length > 0) {\n      return existingBots;\n    }\n\n    const defaultBots = [\n      { key: \"ai_art\", name: \"AI Art Monitor\" },\n      { key: \"investing\", name: \"Investing Brief\" },\n    ];\n\n    const createdBots: Bot[] = [];\n    for (const botDef of defaultBots) {\n      const [bot] = await db.insert(bots).values({\n        userId,\n        key: botDef.key,\n        name: botDef.name,\n        isEnabled: true,\n      }).returning();\n\n      await db.insert(botSettings).values({\n        botId: bot.id,\n        timezone: \"Asia/Seoul\",\n        scheduleRule: \"DAILY\",\n        scheduleTimeLocal: \"07:00\",\n        format: \"clean\",\n        markdownLevel: \"minimal\",\n        verbosity: \"normal\",\n        sectionsJson: { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n        filtersJson: { minImportanceScore: 0, maxRiskLevel: 100 },\n      });\n\n      const defaultSources = await db\n        .select()\n        .from(sources)\n        .where(and(eq(sources.isDefault, true), eq(sources.topic, botDef.key)));\n\n      if (defaultSources.length > 0) {\n        await db.insert(sourceBotLinks).values(\n          defaultSources.map(s => ({\n            botId: bot.id,\n            sourceId: s.id,\n            weight: 3,\n            isEnabled: true,\n          }))\n        );\n      }\n\n      const matchingPreset = await db.select().from(presets).where(eq(presets.key, botDef.key === \"investing\" ? \"daily_market_brief\" : botDef.key === \"ai_art\" ? \"news_briefing\" : botDef.key)).limit(1);\n      const presetId = matchingPreset[0]?.id ?? null;\n\n      await db.insert(profiles).values({\n        userId,\n        presetId,\n        name: botDef.name,\n        topic: botDef.key,\n        timezone: \"Asia/Seoul\",\n        scheduleCron: \"0 7 * * *\",\n        configJson: {\n          sections: { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n          filters: { minImportanceScore: 0, maxRiskLevel: 100 },\n          verbosity: \"normal\",\n          markdownLevel: \"minimal\",\n        },\n        isActive: true,\n      });\n\n      createdBots.push(bot);\n    }\n\n    return createdBots;\n  }\n\n  // ============================================\n  // LLM PROVIDERS - Phase 3 BYO LLM\n  // ============================================\n\n  async createLlmProvider(data: InsertLlmProvider): Promise<LlmProvider> {\n    const [provider] = await db.insert(llmProviders).values(data).returning();\n    return provider;\n  }\n\n  async listLlmProviders(userId: string): Promise<LlmProvider[]> {\n    return db.select().from(llmProviders).where(eq(llmProviders.userId, userId)).orderBy(desc(llmProviders.createdAt));\n  }\n\n  async listAllLlmProviders(): Promise<LlmProvider[]> {\n    return db.select().from(llmProviders).orderBy(desc(llmProviders.createdAt));\n  }\n\n  async getLlmProvider(id: number, userId: string): Promise<LlmProvider | undefined> {\n    const [provider] = await db.select().from(llmProviders).where(and(eq(llmProviders.id, id), eq(llmProviders.userId, userId)));\n    return provider;\n  }\n\n  async updateLlmProvider(id: number, userId: string, patch: Partial<Omit<InsertLlmProvider, 'userId'>>): Promise<LlmProvider | undefined> {\n    const [updated] = await db.update(llmProviders)\n      .set(patch)\n      .where(and(eq(llmProviders.id, id), eq(llmProviders.userId, userId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteLlmProvider(id: number, userId: string): Promise<void> {\n    await db.delete(llmProviders).where(and(eq(llmProviders.id, id), eq(llmProviders.userId, userId)));\n  }\n\n  async resolveLLMForBot(botId: number): Promise<{ providerType: string; apiKey: string; baseUrl: string | null; model: string | null } | null> {\n    const [setting] = await db.select().from(botSettings).where(eq(botSettings.botId, botId));\n\n    if (setting?.llmProviderId) {\n      const [provider] = await db.select().from(llmProviders).where(eq(llmProviders.id, setting.llmProviderId));\n      if (provider) {\n        return {\n          providerType: provider.providerType,\n          apiKey: decrypt(provider.apiKeyEncrypted),\n          baseUrl: provider.baseUrl,\n          model: setting.modelOverride || provider.defaultModel,\n        };\n      }\n    }\n\n    const [bot] = await db.select().from(bots).where(eq(bots.id, botId));\n    if (bot?.userId) {\n      const userProviders = await db.select().from(llmProviders).where(eq(llmProviders.userId, bot.userId)).limit(1);\n      if (userProviders.length > 0) {\n        const provider = userProviders[0];\n        return {\n          providerType: provider.providerType,\n          apiKey: decrypt(provider.apiKeyEncrypted),\n          baseUrl: provider.baseUrl,\n          model: provider.defaultModel,\n        };\n      }\n    }\n\n    return null;\n  }\n\n  async findSourceByUrl(url: string): Promise<Source | undefined> {\n    const [source] = await db.select().from(sources).where(eq(sources.url, url));\n    return source;\n  }\n\n  async createBotFromPreset(params: {\n    userId: string;\n    key: string;\n    name: string;\n    settings: Partial<Omit<InsertBotSettings, 'botId'>>;\n    sourceData: Array<{ name: string; url: string; type?: string; topic: string }>;\n  }): Promise<Bot> {\n    return await db.transaction(async (tx) => {\n      const [bot] = await tx.insert(bots).values({\n        userId: params.userId,\n        key: params.key,\n        name: params.name,\n        isEnabled: true,\n      }).returning();\n\n      await tx.insert(botSettings).values({\n        botId: bot.id,\n        ...params.settings,\n      } as InsertBotSettings);\n\n      if (params.sourceData.length > 0) {\n        const sourceLinks: Array<{ botId: number; sourceId: number; weight: number; isEnabled: boolean }> = [];\n        for (const sd of params.sourceData) {\n          const [existing] = await tx.select().from(sources).where(eq(sources.url, sd.url)).limit(1);\n          let sourceId: number;\n          if (existing) {\n            sourceId = existing.id;\n          } else {\n            const [created] = await tx.insert(sources).values({\n              userId: null,\n              name: sd.name,\n              type: sd.type || \"rss\",\n              url: sd.url,\n              topic: sd.topic,\n              isDefault: false,\n              enabled: true,\n            }).returning();\n            sourceId = created.id;\n          }\n          sourceLinks.push({ botId: bot.id, sourceId, weight: 3, isEnabled: true });\n        }\n        if (sourceLinks.length > 0) {\n          await tx.insert(sourceBotLinks).values(sourceLinks);\n        }\n      }\n\n      return bot;\n    });\n  }\n\n  async getBotByUserAndKey(userId: string, key: string): Promise<Bot | undefined> {\n    const [bot] = await db.select().from(bots)\n      .where(and(eq(bots.userId, userId), eq(bots.key, key)));\n    return bot;\n  }\n\n  async resolveLLMForProfile(userId: string, topic: string): Promise<{ providerType: string; apiKey: string; baseUrl: string | null; model: string | null } | null> {\n    const bot = await this.getBotByUserAndKey(userId, topic);\n    if (!bot) return null;\n    return this.resolveLLMForBot(bot.id);\n  }\n\n  async createJobRun(data: Omit<InsertJobRun, 'id'>): Promise<JobRun> {\n    const [run] = await db.insert(jobRuns).values(data as any).returning();\n    return run;\n  }\n\n  async finishJobRun(id: number, patch: Partial<InsertJobRun>): Promise<JobRun | null> {\n    const [run] = await db.update(jobRuns).set(patch as any).where(eq(jobRuns.id, id)).returning();\n    return run || null;\n  }\n\n  async listJobRunsForBot(userId: string, botId: number, limit: number = 20): Promise<JobRun[]> {\n    return db.select().from(jobRuns)\n      .where(and(eq(jobRuns.userId, userId), eq(jobRuns.botId, botId)))\n      .orderBy(desc(jobRuns.startedAt))\n      .limit(limit);\n  }\n\n  async getLastJobRunForBot(userId: string, botId: number): Promise<JobRun | null> {\n    const [run] = await db.select().from(jobRuns)\n      .where(and(eq(jobRuns.userId, userId), eq(jobRuns.botId, botId)))\n      .orderBy(desc(jobRuns.startedAt))\n      .limit(1);\n    return run || null;\n  }\n\n  async getLastJobRunByBotKey(userId: string, botKey: string): Promise<JobRun | null> {\n    const [run] = await db.select().from(jobRuns)\n      .where(and(eq(jobRuns.userId, userId), eq(jobRuns.botKey, botKey)))\n      .orderBy(desc(jobRuns.startedAt))\n      .limit(1);\n    return run || null;\n  }\n\n  async createReportMetric(data: { reportId: number; profileId: number; itemCount: number; keywordSummary: Record<string, number>; sourceDistribution: Record<string, number> }): Promise<any> {\n    const [metric] = await db.insert(reportMetrics).values(data as any).returning();\n    return metric;\n  }\n\n  async getReportMetricsForProfile(profileId: number, limit: number = 7): Promise<any[]> {\n    return db.select().from(reportMetrics)\n      .where(eq(reportMetrics.profileId, profileId))\n      .orderBy(desc(reportMetrics.createdAt))\n      .limit(limit);\n  }\n\n  async listPermissions(userId: string, scope: string, scopeId: number | null): Promise<Permission[]> {\n    const conditions = [eq(permissions.userId, userId), eq(permissions.scope, scope)];\n    if (scopeId != null) {\n      conditions.push(eq(permissions.scopeId, scopeId));\n    } else {\n      conditions.push(isNull(permissions.scopeId));\n    }\n    return db.select().from(permissions).where(and(...conditions));\n  }\n\n  async upsertPermission(userId: string, scope: string, scopeId: number | null, permissionKey: string, valueJson: any): Promise<Permission> {\n    const existing = await db.select().from(permissions)\n      .where(and(\n        eq(permissions.userId, userId),\n        eq(permissions.scope, scope),\n        scopeId != null ? eq(permissions.scopeId, scopeId) : isNull(permissions.scopeId),\n        eq(permissions.permissionKey, permissionKey),\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const [updated] = await db.update(permissions)\n        .set({ valueJson, updatedAt: new Date() } as any)\n        .where(eq(permissions.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n\n    const [created] = await db.insert(permissions)\n      .values({ userId, scope, scopeId, permissionKey, valueJson, updatedAt: new Date() } as any)\n      .returning();\n    return created;\n  }\n\n  async deletePermission(userId: string, scope: string, scopeId: number | null, permissionKey: string): Promise<void> {\n    await db.delete(permissions).where(and(\n      eq(permissions.userId, userId),\n      eq(permissions.scope, scope),\n      scopeId != null ? eq(permissions.scopeId, scopeId) : isNull(permissions.scopeId),\n      eq(permissions.permissionKey, permissionKey),\n    ));\n  }\n\n  async listAllUserPermissions(userId: string): Promise<Permission[]> {\n    return db.select().from(permissions)\n      .where(eq(permissions.userId, userId))\n      .orderBy(permissions.scope, permissions.permissionKey);\n  }\n\n  async createAuditLog(entry: { userId: string; botId?: number | null; threadId?: string | null; eventType: string; permissionKey?: string | null; payloadJson?: any }): Promise<void> {\n    await db.insert(auditLogs).values({\n      userId: entry.userId,\n      botId: entry.botId ?? null,\n      threadId: entry.threadId ?? null,\n      eventType: entry.eventType,\n      permissionKey: entry.permissionKey ?? null,\n      payloadJson: entry.payloadJson ?? null,\n    } as any);\n  }\n\n  async listAuditLogs(userId: string, filters?: { botId?: number; eventType?: string; permissionKey?: string; limit?: number; since?: Date }): Promise<any[]> {\n    const conditions = [eq(auditLogs.userId, userId)];\n    if (filters?.botId) conditions.push(eq(auditLogs.botId, filters.botId));\n    if (filters?.eventType) conditions.push(eq(auditLogs.eventType, filters.eventType));\n    if (filters?.permissionKey) conditions.push(eq(auditLogs.permissionKey, filters.permissionKey));\n    if (filters?.since) conditions.push(gte(auditLogs.createdAt, filters.since));\n    return db.select().from(auditLogs)\n      .where(and(...conditions))\n      .orderBy(desc(auditLogs.createdAt))\n      .limit(filters?.limit ?? 50);\n  }\n\n  async listRuleMemories(userId: string, scope: string, scopeId: number | null): Promise<RuleMemory[]> {\n    const conditions = [eq(ruleMemories.userId, userId), eq(ruleMemories.scope, scope)];\n    if (scopeId != null) {\n      conditions.push(eq(ruleMemories.scopeId, scopeId));\n    } else {\n      conditions.push(isNull(ruleMemories.scopeId));\n    }\n    return db.select().from(ruleMemories).where(and(...conditions)).orderBy(ruleMemories.key);\n  }\n\n  async listAllUserRuleMemories(userId: string): Promise<RuleMemory[]> {\n    return db.select().from(ruleMemories)\n      .where(eq(ruleMemories.userId, userId))\n      .orderBy(ruleMemories.scope, ruleMemories.key);\n  }\n\n  async upsertRuleMemory(userId: string, scope: string, scopeId: number | null, key: string, valueJson: any): Promise<RuleMemory> {\n    const existing = await db.select().from(ruleMemories)\n      .where(and(\n        eq(ruleMemories.userId, userId),\n        eq(ruleMemories.scope, scope),\n        scopeId != null ? eq(ruleMemories.scopeId, scopeId) : isNull(ruleMemories.scopeId),\n        eq(ruleMemories.key, key),\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const [updated] = await db.update(ruleMemories)\n        .set({ valueJson, updatedAt: new Date() } as any)\n        .where(eq(ruleMemories.id, existing[0].id))\n        .returning();\n      return updated;\n    }\n\n    const [created] = await db.insert(ruleMemories)\n      .values({ userId, scope, scopeId, key, valueJson, updatedAt: new Date() } as any)\n      .returning();\n    return created;\n  }\n\n  async deleteRuleMemory(userId: string, scope: string, scopeId: number | null, key: string): Promise<void> {\n    await db.delete(ruleMemories).where(and(\n      eq(ruleMemories.userId, userId),\n      eq(ruleMemories.scope, scope),\n      scopeId != null ? eq(ruleMemories.scopeId, scopeId) : isNull(ruleMemories.scopeId),\n      eq(ruleMemories.key, key),\n    ));\n  }\n\n  async getEffectiveRules(userId: string, botId: number | null): Promise<Record<string, any>> {\n    const globalRules = await this.listRuleMemories(userId, \"global\", null);\n    const botRules = botId ? await this.listRuleMemories(userId, \"bot\", botId) : [];\n\n    const merged: Record<string, any> = {};\n    for (const rule of globalRules) {\n      merged[rule.key] = rule.valueJson;\n    }\n    for (const rule of botRules) {\n      merged[rule.key] = rule.valueJson;\n    }\n    return merged;\n  }\n\n  async getTelegramLinkByUserId(userId: string): Promise<TelegramLink | null> {\n    const [link] = await db.select().from(telegramLinks)\n      .where(and(eq(telegramLinks.userId, userId), eq(telegramLinks.isActive, true)))\n      .limit(1);\n    return link || null;\n  }\n\n  async getTelegramLinkByChatId(chatId: string): Promise<TelegramLink | null> {\n    const [link] = await db.select().from(telegramLinks)\n      .where(and(eq(telegramLinks.telegramChatId, chatId), eq(telegramLinks.isActive, true)))\n      .limit(1);\n    return link || null;\n  }\n\n  async createTelegramLink(data: { userId: string; telegramChatId: string; telegramUsername?: string; threadId: number }): Promise<TelegramLink> {\n    const existingByChatId = await this.getTelegramLinkByChatId(data.telegramChatId);\n    if (existingByChatId && existingByChatId.userId !== data.userId) {\n      await db.delete(telegramLinks).where(eq(telegramLinks.telegramChatId, data.telegramChatId));\n    }\n    await db.delete(telegramLinks).where(eq(telegramLinks.userId, data.userId));\n    const [link] = await db.insert(telegramLinks).values({\n      userId: data.userId,\n      telegramChatId: data.telegramChatId,\n      telegramUsername: data.telegramUsername || null,\n      threadId: data.threadId,\n      isActive: true,\n    }).returning();\n    return link;\n  }\n\n  async deleteTelegramLink(userId: string): Promise<void> {\n    await db.delete(telegramLinks).where(eq(telegramLinks.userId, userId));\n  }\n\n  async createLinkCode(userId: string, platform: string): Promise<string> {\n    await db.delete(linkCodes).where(and(eq(linkCodes.userId, userId), eq(linkCodes.platform, platform), isNull(linkCodes.usedAt)));\n    const code = Math.random().toString(36).substring(2, 8).toUpperCase();\n    const expiresAt = new Date(Date.now() + 10 * 60 * 1000);\n    await db.insert(linkCodes).values({ userId, code, platform, expiresAt });\n    return code;\n  }\n\n  async consumeLinkCode(code: string): Promise<{ userId: string; platform: string } | null> {\n    const [row] = await db.select().from(linkCodes)\n      .where(and(eq(linkCodes.code, code), isNull(linkCodes.usedAt), gte(linkCodes.expiresAt, new Date())))\n      .limit(1);\n    if (!row) return null;\n    await db.update(linkCodes).set({ usedAt: new Date() }).where(eq(linkCodes.id, row.id));\n    return { userId: row.userId, platform: row.platform };\n  }\n}\n\nimport { driver } from \"./db\";\nimport { SqliteStorage } from \"./storage-sqlite\";\n\nfunction createStorage(): IStorage {\n  if (driver === \"sqlite\") {\n    return new SqliteStorage();\n  }\n  return new DatabaseStorage();\n}\n\nexport const storage = createStorage();\n","path":null,"size_bytes":66580,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"node-cron\",\n  \"nodemailer\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"rss-parser\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1436,"size_tokens":null},"server/db.ts":{"content":"import { drizzle as drizzlePg } from \"drizzle-orm/node-postgres\";\nimport { drizzle as drizzleSqlite } from \"drizzle-orm/better-sqlite3\";\nimport Database from \"better-sqlite3\";\nimport pg from \"pg\";\nimport * as pgSchema from \"@shared/schema\";\nimport * as sqliteSchema from \"../shared/schema.sqlite\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport type DbDriver = \"pg\" | \"sqlite\";\n\nlet _driver: DbDriver = \"pg\";\nlet _db: any;\nlet _sqliteRaw: any;\n\nfunction initDb() {\n  const useSqlite = process.env.MAKER_DB === \"sqlite\";\n\n  if (useSqlite) {\n    const filePath = process.env.MAKER_SQLITE_PATH || \"./data/maker.db\";\n\n    const dir = path.dirname(filePath);\n    if (!fs.existsSync(dir)) {\n      fs.mkdirSync(dir, { recursive: true });\n    }\n\n    const sqlite = new Database(filePath);\n    sqlite.pragma(\"journal_mode = WAL\");\n    sqlite.pragma(\"foreign_keys = ON\");\n\n    _sqliteRaw = sqlite;\n    _db = drizzleSqlite(sqlite, { schema: sqliteSchema });\n    _driver = \"sqlite\";\n\n    console.log(`[DB] SQLite initialized: ${filePath}`);\n  } else {\n    const pool = new pg.Pool({\n      connectionString: process.env.DATABASE_URL,\n    });\n    _db = drizzlePg(pool, { schema: pgSchema });\n    _driver = \"pg\";\n  }\n}\n\ninitDb();\n\nexport const db = _db;\nexport const driver: DbDriver = _driver;\nexport const sqliteRaw = _sqliteRaw;\n","path":null,"size_bytes":1324,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"server/services/rss.ts":{"content":"import Parser from \"rss-parser\";\nimport { storage } from \"../storage\";\n\nconst parser = new Parser();\n\nasync function fetchRSS(feedUrl: string): Promise<string> {\n  const controller = new AbortController();\n  const timeout = setTimeout(() => controller.abort(), 8000);\n  try {\n    const response = await fetch(feedUrl, {\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',\n        'Accept': 'application/rss+xml, application/xml, text/xml, */*',\n      },\n      signal: controller.signal,\n    });\n    \n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n    \n    return response.text();\n  } finally {\n    clearTimeout(timeout);\n  }\n}\n\nexport async function collectFromSource(sourceId: number, feedUrl: string, sourceTopic?: string): Promise<number> {\n  let collected = 0;\n\n  try {\n    const xmlContent = await fetchRSS(feedUrl);\n    const feed = await parser.parseString(xmlContent);\n\n    for (const item of feed.items ?? []) {\n      const url = item.link ?? \"\";\n      if (!url) continue;\n\n      const title = item.title ?? \"\";\n      const content = (item.contentSnippet ?? item.content ?? \"\").toString();\n      const publishedAt = item.isoDate ? new Date(item.isoDate) : item.pubDate ? new Date(item.pubDate) : null;\n\n      try {\n        await storage.createItem({\n          sourceId,\n          externalId: item.guid ?? null,\n          url,\n          title,\n          author: item.creator ?? null,\n          contentText: content || title,\n          publishedAt,\n          status: \"new\",\n          ...(sourceTopic ? { topic: sourceTopic } : {}),\n        });\n        collected++;\n      } catch (error: any) {\n        if (error.code === \"23505\") {\n          continue;\n        }\n        console.error(\"Error creating item:\", error.message);\n      }\n    }\n  } catch (error) {\n    console.error(\"RSS fetch error:\", feedUrl, error);\n  }\n\n  return collected;\n}\n\nexport async function collectAllSources(): Promise<{ totalCollected: number; sourcesProcessed: number }> {\n  const sources = await storage.getSources();\n  let totalCollected = 0;\n  let sourcesProcessed = 0;\n\n  for (const source of sources) {\n    if (!source.enabled) continue;\n\n    console.log(`Collecting from: ${source.name} (${source.url})`);\n    const collected = await collectFromSource(source.id, source.url, source.topic);\n    totalCollected += collected;\n    sourcesProcessed++;\n    console.log(`Collected ${collected} new items from ${source.name}`);\n  }\n\n  return { totalCollected, sourcesProcessed };\n}\n\nasync function runWithConcurrency<T>(tasks: (() => Promise<T>)[], limit: number): Promise<PromiseSettledResult<T>[]> {\n  const results: PromiseSettledResult<T>[] = new Array(tasks.length);\n  let idx = 0;\n  async function next(): Promise<void> {\n    while (idx < tasks.length) {\n      const i = idx++;\n      try {\n        results[i] = { status: \"fulfilled\", value: await tasks[i]() };\n      } catch (e: any) {\n        results[i] = { status: \"rejected\", reason: e };\n      }\n    }\n  }\n  await Promise.all(Array.from({ length: Math.min(limit, tasks.length) }, () => next()));\n  return results;\n}\n\nexport async function collectFromSourceIds(sourceIds: number[]): Promise<{ totalCollected: number; sourcesProcessed: number }> {\n  const allSources = await storage.getSources();\n  const targetSources = allSources.filter(s => sourceIds.includes(s.id) && s.enabled);\n\n  const tasks = targetSources.map((source) => async () => {\n    console.log(`[BotCollect] Collecting from: ${source.name} (${source.url})`);\n    const collected = await collectFromSource(source.id, source.url, source.topic);\n    console.log(`[BotCollect] Collected ${collected} new items from ${source.name}`);\n    return collected;\n  });\n\n  const results = await runWithConcurrency(tasks, 5);\n\n  let totalCollected = 0;\n  let sourcesProcessed = 0;\n  for (const r of results) {\n    sourcesProcessed++;\n    if (r.status === \"fulfilled\") {\n      totalCollected += r.value;\n    }\n  }\n\n  return { totalCollected, sourcesProcessed };\n}\n","path":null,"size_bytes":4113,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/i18n/ko.ts":{"content":"export const ko: Record<string, string> = {\n  \"sidebar.dashboard\": \"대시보드\",\n  \"sidebar.myBots\": \"내 봇\",\n  \"sidebar.sources\": \"소스\",\n  \"sidebar.reports\": \"리포트\",\n  \"sidebar.drafts\": \"초안\",\n  \"sidebar.items\": \"아이템\",\n  \"sidebar.observe\": \"모니터링\",\n  \"sidebar.console\": \"콘솔\",\n  \"sidebar.guide\": \"가이드\",\n  \"sidebar.settings\": \"설정\",\n  \"sidebar.permissions\": \"권한 관리\",\n  \"sidebar.activeBots\": \"활성 봇\",\n  \"sidebar.navigation\": \"메뉴\",\n  \"sidebar.subtitle\": \"워크플로우 디자이너\",\n  \"sidebar.footer\": \"maker.am Bot v1.0\",\n\n  \"header.logout\": \"로그아웃\",\n\n  \"landing.nav.signIn\": \"로그인\",\n  \"landing.hero.title1\": \"나만의 자동화를\",\n  \"landing.hero.title2\": \"직접 설계하세요\",\n  \"landing.hero.subtitle\": \"소스를 선택하고, 스케줄을 설정하고, 출력 형식을 디자인하세요. 당신의 워크플로우, 당신의 규칙입니다.\",\n  \"landing.hero.getStarted\": \"시작하기\",\n  \"landing.hero.badge1\": \"템플릿은 출발점일 뿐\",\n  \"landing.hero.badge2\": \"자유롭게 커스터마이징\",\n  \"landing.hero.badge3\": \"AI 분석 & 리포트\",\n  \"landing.hero.chooseSources\": \"소스 선택\",\n  \"landing.hero.chooseSourcesDesc\": \"RSS, 뉴스, 커뮤니티 — 원하는 소스를 연결하세요\",\n  \"landing.hero.scheduleFormat\": \"스케줄 & 형식\",\n  \"landing.hero.scheduleFormatDesc\": \"실행 주기와 출력 형식을 자유롭게 조정하세요\",\n  \"landing.hero.aiAnalysis\": \"AI 분석 & 요약\",\n  \"landing.hero.aiAnalysisDesc\": \"AI가 수집된 콘텐츠를 분석하고 리포트를 생성합니다\",\n  \"landing.howItWorks.title\": \"이용 방법\",\n  \"landing.howItWorks.subtitle\": \"소스, 스케줄, 출력을 직접 결정하세요. 워크플로우의 주인은 당신입니다.\",\n  \"landing.howItWorks.step1Title\": \"템플릿으로 시작\",\n  \"landing.howItWorks.step1Desc\": \"템플릿은 출발점이지 정답이 아닙니다. 뉴스 모니터링, 시장 분석, 커뮤니티 참여 등 다양한 워크플로우를 빠르게 시작하세요.\",\n  \"landing.howItWorks.step2Title\": \"자유롭게 커스터마이징\",\n  \"landing.howItWorks.step2Desc\": \"소스, 스케줄, 리포트 형식, AI 모델 등 모든 것을 목적에 맞게 변경하세요. 도구는 저희가 제공하고, 선택은 당신이 합니다.\",\n  \"landing.howItWorks.step3Title\": \"자동 운영\",\n  \"landing.howItWorks.step3Desc\": \"설정이 완료되면 봇이 자동으로 수집, 분석, 리포트를 생성합니다. 채팅 콘솔로 언제든 봇을 제어하세요.\",\n  \"landing.useCases.title\": \"어떤 워크플로우를 만들 수 있나요?\",\n  \"landing.useCases.subtitle\": \"Maker로 사람들이 만드는 워크플로우입니다. 모든 템플릿은 출발점일 뿐 — 필요에 맞게 커스터마이징하세요.\",\n  \"landing.faq.title\": \"자주 묻는 질문\",\n  \"landing.faq.subtitle\": \"Maker와 사용 방법에 대한 일반적인 질문입니다.\",\n  \"landing.pricing.title\": \"Maker를 어떻게 실행하시겠습니까?\",\n  \"landing.pricing.subtitle\": \"필요에 맞는 유연한 플랜을 선택하세요.\",\n  \"landing.pricing.web.name\": \"개인용 (웹)\",\n  \"landing.pricing.web.price\": \"Free (Beta)\",\n  \"landing.pricing.web.desc\": \"웹에서 바로 시작\",\n  \"landing.pricing.web.f1\": \"개인 워크플로우 설계\",\n  \"landing.pricing.web.f2\": \"BYO LLM\",\n  \"landing.pricing.web.f3\": \"빠른 브리핑 & 리포트\",\n  \"landing.pricing.web.f4\": \"데이터는 클라우드\",\n  \"landing.pricing.web.button\": \"웹에서 시작하기\",\n  \"landing.pricing.local.name\": \"Local Edition — Personal\",\n  \"landing.pricing.local.price\": \"Local Edition\",\n  \"landing.pricing.local.desc\": \"당신의 컴퓨터에서 실행\",\n  \"landing.pricing.local.f1\": \"모든 데이터 로컬\",\n  \"landing.pricing.local.f2\": \"개인 자동화 엔진\",\n  \"landing.pricing.local.f3\": \"API 키 직접 관리\",\n  \"landing.pricing.local.button\": \"다운로드\",\n  \"landing.pricing.teams.name\": \"Local Edition — Teams\",\n  \"landing.pricing.teams.price\": \"Local Edition\",\n  \"landing.pricing.teams.desc\": \"조직 내부 자동화\",\n  \"landing.pricing.teams.f1\": \"내부 문서·리포트\",\n  \"landing.pricing.teams.f2\": \"팀 워크플로우\",\n  \"landing.pricing.teams.f3\": \"외부 전송 없음\",\n  \"landing.pricing.teams.button\": \"문의하기\",\n  \"landing.pricing.enterprise.name\": \"Enterprise\",\n  \"landing.pricing.enterprise.price\": \"Enterprise\",\n  \"landing.pricing.enterprise.desc\": \"맞춤형 자동화 플랫폼\",\n  \"landing.pricing.enterprise.f1\": \"온프레미스\",\n  \"landing.pricing.enterprise.f2\": \"보안·통합·SLA\",\n  \"landing.pricing.enterprise.f3\": \"전담 지원\",\n  \"landing.pricing.enterprise.button\": \"Contact Sales\",\n\n  \"landing.philosophy.line1\": \"We don't sell bots.\",\n  \"landing.philosophy.line2\": \"We sell control over automation.\",\n\n  \"landing.cta.title\": \"워크플로우를 설계할 준비가 되셨나요?\",\n  \"landing.cta.subtitle\": \"가입하고, AI 프로바이더를 추가하고, 몇 분 안에 첫 번째 봇을 만드세요.\",\n  \"landing.cta.button\": \"무료로 시작하기\",\n  \"landing.footer\": \"Maker Bot Manager\",\n\n  \"landing.useCase.dailyMarketBrief\": \"일일 시장 브리핑\",\n  \"landing.useCase.dailyMarketBriefDesc\": \"Reuters, Yahoo Finance, Reddit 등에서 시장 뉴스를 수집합니다. 매일 아침 시장 개장 전에 AI 요약 브리핑을 받으세요.\",\n  \"landing.useCase.researchPaperTracker\": \"연구 논문 트래커\",\n  \"landing.useCase.researchPaperTrackerDesc\": \"ArXiv, Google Research, 학술 블로그를 모니터링합니다. 수동 검색 없이 최신 AI/ML 논문을 파악하세요.\",\n  \"landing.useCase.competitorSignalMonitor\": \"경쟁사 시그널 모니터\",\n  \"landing.useCase.competitorSignalMonitorDesc\": \"TechCrunch, Product Hunt, 업계 뉴스를 추적합니다. 경쟁사가 새 기능을 출시하거나 투자를 유치할 때 알림을 받으세요.\",\n  \"landing.useCase.communityResearch\": \"커뮤니티 리서치\",\n  \"landing.useCase.communityResearchDesc\": \"Reddit, Hacker News, 니치 커뮤니티를 팔로우합니다. 당신의 분야에서 떠오르는 트렌드와 커뮤니티 감성을 이해하세요.\",\n  \"landing.useCase.contentIdeas\": \"콘텐츠 아이디어 & 리서치\",\n  \"landing.useCase.contentIdeasDesc\": \"Medium, Reddit 등에서 트렌딩 주제, 블로그 아이디어, 콘텐츠 영감을 자동으로 수집합니다. 블로거, 뉴스레터 작성자, 콘텐츠 기획자에게 적합합니다.\",\n  \"landing.useCase.workProductivity\": \"업무 & 생산성 리서치\",\n  \"landing.useCase.workProductivityDesc\": \"Reddit, Indie Hackers, Medium에서 생산성 팁, 비즈니스 아이디어, 실용적인 도구를 자동으로 수집합니다. 마케터, 기획자, 1인 창업자를 위한 일일 리서치 메모.\",\n  \"landing.useCase.onlineBusiness\": \"온라인 비즈니스 리서치\",\n  \"landing.useCase.onlineBusinessDesc\": \"이커머스 커뮤니티에서 고객 불만, 시장 시그널, 경쟁사 데이터를 수집합니다. 무엇을 팔지가 아니라, 고객이 왜 망설이는지에 초점을 맞춘 전략 리포트를 받으세요.\",\n  \"landing.useCase.koreaMarketplace\": \"한국 마켓플레이스 리서치\",\n  \"landing.useCase.koreaMarketplaceDesc\": \"쿠팡과 스마트스토어 셀러를 위한 리서치 워크플로우. 한국 마켓플레이스 생태계 전반의 고객 불만, 가격 압박, 리뷰 시그널을 모니터링하여 소싱과 전략 결정을 지원합니다.\",\n  \"landing.useCase.chatControl\": \"채팅 기반 제어\",\n  \"landing.useCase.chatControlDesc\": \"자연어 채팅 콘솔로 모든 봇을 관리하세요. 봇 전환, 작업 실행, 소스 추가 — 명령어만 입력하면 됩니다.\",\n  \"landing.useCase.byoLlm\": \"나만의 LLM 사용\",\n  \"landing.useCase.byoLlmDesc\": \"OpenAI, Anthropic, Google 또는 OpenAI 호환 프로바이더의 API 키를 사용하세요. 벤더 종속 없이, AI 비용을 완전히 제어할 수 있습니다.\",\n\n  \"landing.faq.q1\": \"AI API 키를 직접 제공해야 하나요?\",\n  \"landing.faq.a1\": \"네. Maker는 BYO(Bring Your Own) LLM 모델을 사용합니다. 설정에서 OpenAI, Anthropic, Google 등의 API 키를 추가하세요. AI 사용량과 비용을 완전히 제어할 수 있습니다.\",\n  \"landing.faq.q2\": \"어떤 소스를 연결할 수 있나요?\",\n  \"landing.faq.a2\": \"모든 공개 RSS 피드를 연결할 수 있습니다. 뉴스 사이트(Reuters, CNBC), 테크 블로그(TechCrunch, The Verge), 연구 저장소(ArXiv), 커뮤니티 플랫폼(Reddit, Hacker News) 등 RSS 피드가 있는 모든 사이트가 포함됩니다.\",\n  \"landing.faq.q3\": \"템플릿은 필수인가요?\",\n  \"landing.faq.a3\": \"아닙니다. 템플릿은 빠르게 시작할 수 있도록 도와주는 출발점입니다. 생성 후 소스, 스케줄, 리포트 섹션, 형식, AI 모델 등 모든 요소를 자유롭게 커스터마이징할 수 있습니다.\",\n  \"landing.faq.q4\": \"봇은 얼마나 자주 실행되나요?\",\n  \"landing.faq.a4\": \"스케줄을 직접 제어합니다. 매일, 평일만, 주간 등의 옵션이 있으며 시간대도 선택할 수 있습니다. 채팅 콘솔에서 수동 실행도 가능합니다.\",\n  \"landing.faq.q5\": \"봇은 어떤 출력물을 생성하나요?\",\n  \"landing.faq.a5\": \"봇은 소스에서 구조화된 리포트를 생성합니다. 리포트에는 요약, 핵심 인사이트, 트렌드 분석이 포함됩니다. 표시되는 섹션, 상세도, 마크다운 형식을 커스터마이징할 수 있습니다.\",\n  \"landing.faq.q6\": \"내 데이터는 안전한가요?\",\n  \"landing.faq.a6\": \"네. 각 사용자는 자신만의 봇, 소스, 리포트를 갖습니다. 데이터는 사용자별로 완전히 격리됩니다. API 키는 암호화되며 공유되지 않습니다.\",\n\n  \"landing.demo.title\": \"리뷰어 데모 로그인\",\n  \"landing.demo.id\": \"아이디\",\n  \"landing.demo.password\": \"비밀번호\",\n  \"landing.demo.idPlaceholder\": \"테스트 ID 입력\",\n  \"landing.demo.passwordPlaceholder\": \"비밀번호 입력\",\n  \"landing.demo.loginButton\": \"데모 로그인\",\n  \"landing.demo.loggingIn\": \"로그인 중...\",\n  \"landing.demo.error\": \"아이디 또는 비밀번호가 올바르지 않습니다.\",\n  \"landing.demo.failed\": \"로그인에 실패했습니다. 다시 시도해주세요.\",\n\n  \"dashboard.title\": \"워크플로우 디자이너\",\n  \"dashboard.subtitle\": \"자동화 워크플로우를 설계하는 도구입니다. 소스를 선택하고, 스케줄을 설정하고, 출력을 디자인하세요 — 모든 것을 당신이 결정합니다.\",\n  \"dashboard.systemWarning.title\": \"시스템 AI 키가 설정되지 않았습니다\",\n  \"dashboard.systemWarning.desc\": \"분석, 초안 작성, 리포트 생성이 일시 중지되었습니다. 콘텐츠 수집은 정상적으로 계속됩니다.\",\n  \"dashboard.systemWarning.link\": \"설정 > 프로바이더\",\n  \"dashboard.systemWarning.linkSuffix\": \" — BYO LLM 프로바이더를 추가하여 각 봇의 AI 기능을 활성화하세요.\",\n  \"dashboard.onboarding.title\": \"시작하기\",\n  \"dashboard.onboarding.subtitle\": \"첫 번째 자동화 워크플로우를 설정하려면 다음 단계를 따르세요.\",\n  \"dashboard.onboarding.step1\": \"1. AI 프로바이더 추가\",\n  \"dashboard.onboarding.step1Done\": \"완료\",\n  \"dashboard.onboarding.step1Desc\": \"AI 분석 및 리포트 생성을 활성화하려면 API 키(OpenAI, Anthropic, Google 등)를 추가하세요.\",\n  \"dashboard.onboarding.step1Button\": \"설정으로 이동\",\n  \"dashboard.onboarding.step2\": \"2. 봇 만들기\",\n  \"dashboard.onboarding.step2Desc\": \"아래에서 템플릿을 선택하고 소스, 스케줄, 출력 형식을 필요에 맞게 커스터마이징하세요.\",\n  \"dashboard.onboarding.step2Button\": \"템플릿 둘러보기\",\n  \"dashboard.onboarding.step3\": \"3. 리포트 보기\",\n  \"dashboard.onboarding.step3Desc\": \"봇이 자동으로 수집, 분석, 스케줄에 따라 리포트를 생성합니다. 리포트 페이지에서 결과를 확인하세요.\",\n  \"dashboard.onboarding.step3Button\": \"리포트 보기\",\n  \"dashboard.startWorkflow.title\": \"워크플로우 시작\",\n  \"dashboard.startWorkflow.subtitle\": \"템플릿은 출발점이지 정답이 아닙니다. 소스, 스케줄, 출력을 자유롭게 커스터마이징할 수 있습니다.\",\n  \"dashboard.startWorkflow.viewAll\": \"모든 템플릿 보기\",\n  \"dashboard.startWorkflow.startWith\": \"이 설정으로 시작\",\n  \"dashboard.myBots.title\": \"내 워크플로우 봇\",\n  \"dashboard.myBots.subtitle\": \"활성화된 봇입니다. 설정을 변경하거나 즉시 실행하세요.\",\n  \"dashboard.myBots.manageAll\": \"전체 관리\",\n  \"dashboard.myBots.open\": \"열기\",\n  \"dashboard.myBots.active\": \"활성\",\n  \"dashboard.myBots.paused\": \"일시정지\",\n  \"dashboard.system.title\": \"시스템 상태\",\n  \"dashboard.system.collect\": \"수집:\",\n  \"dashboard.system.analyze\": \"분석:\",\n  \"dashboard.system.draft\": \"초안:\",\n  \"dashboard.system.reports\": \"리포트:\",\n  \"dashboard.system.paused\": \"일시정지\",\n  \"dashboard.system.lastCollect\": \"마지막 수집:\",\n  \"dashboard.system.lastAnalyze\": \"마지막 분석:\",\n  \"dashboard.system.never\": \"없음\",\n  \"dashboard.stats.totalItems\": \"전체 아이템\",\n  \"dashboard.stats.new\": \"새 항목\",\n  \"dashboard.stats.analyzed\": \"분석됨\",\n  \"dashboard.stats.drafted\": \"초안\",\n  \"dashboard.stats.approved\": \"승인됨\",\n  \"dashboard.stats.posted\": \"게시됨\",\n  \"dashboard.stats.skipped\": \"건너뜀\",\n  \"dashboard.recentItems\": \"최근 아이템\",\n  \"dashboard.viewAll\": \"전체 보기\",\n\n  \"reports.title\": \"리포트\",\n  \"reports.subtitle\": \"봇이 분석한 콘텐츠로 생성된 리포트\",\n  \"reports.allReports\": \"모든 리포트\",\n  \"reports.generate\": \"생성\",\n  \"reports.recentReports\": \"최근 리포트\",\n  \"reports.selectReport\": \"리포트 선택\",\n  \"reports.selectReportHint\": \"왼쪽에서 리포트를 선택하여 내용을 확인하세요.\",\n  \"reports.noReports\": \"아직 리포트가 없습니다.\",\n  \"reports.generateReport\": \"리포트 생성\",\n  \"reports.selectBotHint\": \"위의 드롭다운에서 봇을 선택하여 리포트를 생성하세요.\",\n  \"reports.createBotFirst\": \"템플릿 갤러리에서 먼저 봇을 만드세요.\",\n  \"reports.copyToClipboard\": \"클립보드에 복사\",\n  \"reports.downloadMarkdown\": \"마크다운으로 다운로드\",\n  \"reports.copied\": \"클립보드에 복사됨\",\n  \"reports.downloaded\": \"리포트 다운로드됨\",\n  \"reports.generated\": \"리포트 생성 완료\",\n  \"reports.generatedDesc\": \"리포트가 성공적으로 생성되었습니다 ({{count}}개 아이템 분석)\",\n  \"reports.generationComplete\": \"리포트 생성 완료\",\n  \"reports.generationFailed\": \"생성 실패\",\n  \"reports.generationFailedDesc\": \"리포트 생성에 실패했습니다\",\n  \"reports.stage.fast\": \"초기 브리핑\",\n  \"reports.stage.status\": \"상태 리포트\",\n  \"reports.stage.full\": \"확장 리포트\",\n  \"reports.stage.updated\": \"업데이트됨\",\n  \"reports.created\": \"생성:\",\n  \"reports.updated\": \"업데이트:\",\n  \"reports.period\": \"기간:\",\n\n  \"chat.title\": \"컨트롤 콘솔\",\n  \"chat.subtitle\": \"한 문장으로 봇에게 지시하세요. 나머지는 봇이 처리합니다.\",\n  \"chat.noActiveBot\": \"활성 봇 없음\",\n  \"chat.tryNext\": \"다음 시도\",\n  \"chat.category.firstRun\": \"시작하기\",\n  \"chat.category.schedule\": \"스케줄\",\n  \"chat.botCategory.research\": \"사용자 리서치\",\n  \"chat.botCategory.outreach\": \"아웃리치\",\n  \"chat.botCategory.contribution\": \"커뮤니티\",\n  \"chat.botCategory.analysis\": \"분석\",\n  \"chat.botCategory.monitor\": \"모니터링\",\n  \"chat.botCategory.safetyPromo\": \"안전\",\n  \"chat.suggestions\": \"추천\",\n  \"chat.categories\": \"카테고리\",\n  \"chat.commands\": \"명령어\",\n  \"chat.botHintsDesc\": \"Maker 홍보를 위한 사전 조사, 자료 수집, 커뮤니티 기여 명령어\",\n  \"chat.state.noBot\": \"봇을 선택하거나 생성하여 시작하세요\",\n  \"chat.state.noSources\": \"데이터 수집을 시작하려면 소스를 추가하세요\",\n  \"chat.state.noCollection\": \"데이터를 수집하고 분석할 준비가 되었습니다\",\n  \"chat.state.ready\": \"모든 준비 완료! 봇에게 지시하세요\",\n  \"chat.state.scheduleIssue\": \"설정을 확인하세요 — 주의가 필요합니다\",\n  \"chat.pipeline.start\": \"시작\",\n  \"chat.pipeline.collect\": \"데이터 수집\",\n  \"chat.pipeline.analyze\": \"분석\",\n  \"chat.pipeline.report\": \"리포트\",\n  \"chat.pipeline.schedule\": \"스케줄\",\n  \"chat.pipeline.timeout\": \"시간 초과\",\n  \"chat.executionFailed\": \"실행 실패\",\n  \"chat.errorOccurred\": \"오류가 발생했습니다\",\n  \"chat.onboarding.welcome\": \"컨트롤 콘솔에 오신 것을 환영합니다\",\n  \"chat.onboarding.welcomeDesc\": \"봇과 대화하는 곳입니다. 명령어를 입력하거나 아래 추천을 선택하세요.\",\n  \"chat.onboarding.noBot\": \"아직 봇이 선택되지 않았습니다\",\n  \"chat.onboarding.noBotDesc\": \"시작하려면 봇을 생성하거나 선택하세요.\",\n  \"chat.onboarding.readyTitle\": \"봇이 준비되었습니다\",\n  \"chat.onboarding.readyDesc\": \"아래에 명령어를 입력하거나 추천에서 선택하세요.\",\n  \"chat.confirm\": \"확인\",\n  \"chat.cancel\": \"취소\",\n  \"chat.onboardingSubtitle\": \"아래 예문을 클릭하면 입력창에 자동으로 채워집니다. Enter를 누르세요.\",\n\n  \"chat.placeholder.noBot\": \"\\\"봇 목록 보여줘\\\" 또는 \\\"봇 상태 보여줘\\\"\",\n  \"chat.placeholder.noSources\": \"\\\"소스 추가 https://...\\\" 또는 \\\"봇 상태 보여줘\\\"\",\n  \"chat.placeholder.noCollection\": \"\\\"수집 실행\\\" 또는 \\\"매일 아침 9시 스케줄\\\"\",\n  \"chat.placeholder.ready\": \"\\\"봇 상태 보여줘\\\" 또는 \\\"수집하고 분석해서 리포트 작성해줘\\\"\",\n  \"chat.placeholder.scheduleIssue\": \"\\\"봇 상태 점검\\\" 또는 \\\"매일 아침 9시 스케줄\\\"\",\n\n  \"chat.hint.listBots\": \"봇 목록 보여줘\",\n  \"chat.hint.switchBot\": \"봇 전환 investing\",\n  \"chat.hint.checkSetup\": \"봇 상태 점검\",\n  \"chat.hint.addDefaultSources\": \"소스 추가 https://news.ycombinator.com/rss\",\n  \"chat.hint.addSourceUrl\": \"소스 추가 https://\",\n  \"chat.hint.botStatus\": \"봇 상태 보여줘\",\n  \"chat.hint.quickSummary\": \"수집하고 분석해서 리포트 작성해줘\",\n  \"chat.hint.statusBriefing\": \"봇 상태 브리핑\",\n  \"chat.hint.scheduleDailyNine\": \"매일 아침 9시 자동 실행 스케줄\",\n  \"chat.hint.changeScheduleEight\": \"스케줄 매일 아침 8시\",\n  \"chat.hint.weekdaysOnly\": \"스케줄 평일 아침 9시\",\n  \"chat.hint.checkReportIssue\": \"봇 상태 점검\",\n  \"chat.hint.nextRunTime\": \"봇 상태 보여줘\",\n  \"chat.hint.whatNext\": \"봇 상태 점검\",\n  \"chat.hint.pauseBot\": \"봇 일시정지\",\n\n  \"chat.botHint.collectCommunity\": \"수집 실행 — 자동화 관련 커뮤니티 글 모아줘\",\n  \"chat.botHint.findRedditNeeds\": \"수집 실행 — 자동화 니즈 Reddit 글 모아줘\",\n  \"chat.botHint.collectComplaints\": \"수집 실행 — 1인 창업자 반복 업무 불만 모아줘\",\n  \"chat.botHint.analyzePatterns\": \"분석 실행 — 사용자 관심 패턴 분석해줘\",\n  \"chat.botHint.organizeInvestor\": \"수집 실행 — 투자자 커뮤니티 글 모아줘\",\n  \"chat.botHint.collectQuestions\": \"수집 실행 — 생산성 도구 관련 질문 모아줘\",\n  \"chat.botHint.summarizeProblems\": \"분석 실행 — 문제 리포트 요약해줘\",\n  \"chat.botHint.draftContribution\": \"작성 실행 — 커뮤니티 기여 답변 초안 (홍보 없이)\",\n  \"chat.botHint.draftAutomationTip\": \"작성 실행 — 자동화 팁 기여 초안 작성해줘\",\n  \"chat.botHint.draftRssTip\": \"작성 실행 — RSS 활용법 글 초안 작성해줘\",\n  \"chat.botHint.analyzeTrends\": \"분석 실행 — 이번 주 자동화 트렌드 분석해줘\",\n  \"chat.botHint.analyzeDemand\": \"분석 실행 — 커뮤니티별 도구 수요 분석해줘\",\n  \"chat.botHint.analyzePersonas\": \"분석 실행 — 수집 자료에서 사용자 페르소나 정리해줘\",\n  \"chat.botHint.monitorReddit\": \"수집 실행 — Reddit/HN 자동화 언급 모니터\",\n  \"chat.botHint.trackCompetitors\": \"수집 실행 — 경쟁 도구 언급 추적해줘\",\n  \"chat.botHint.dailyBriefing\": \"수집하고 분석해서 리포트 작성해줘 — 매일 커뮤니티 브리핑\",\n  \"chat.botHint.noPromotion\": \"작성 실행 — 가치 제공 위주, 직접 홍보 없이\",\n  \"chat.botHint.authenticOnly\": \"작성 실행 — 진정성 있는 커뮤니티 기여만\",\n  \"chat.botHint.noLinksNoBrand\": \"작성 실행 — 문제 해결 중심, 링크/브랜드명 없이\",\n\n  \"settings.title\": \"설정\",\n  \"settings.subtitle\": \"스케줄러, LLM 프로바이더, 봇 설정 구성\",\n  \"settings.providers.title\": \"LLM 프로바이더\",\n  \"settings.providers.subtitle\": \"AI 프로바이더 API 키 연결\",\n  \"settings.providers.addButton\": \"프로바이더 추가\",\n  \"settings.providers.noProviders\": \"LLM 프로바이더가 설정되지 않았습니다. 봇의 AI 기능을 사용하려면 하나를 추가하세요.\",\n  \"settings.providers.name\": \"이름\",\n  \"settings.providers.namePlaceholder\": \"예: 내 Anthropic 키\",\n  \"settings.providers.type\": \"프로바이더 유형\",\n  \"settings.providers.apiKey\": \"API 키\",\n  \"settings.providers.apiKeyKeep\": \"(현재 키를 유지하려면 비워두세요)\",\n  \"settings.providers.apiKeyPlaceholder\": \"sk-...\",\n  \"settings.providers.apiKeyEditPlaceholder\": \"새 키를 입력하거나 비워두세요\",\n  \"settings.providers.baseUrl\": \"Base URL\",\n  \"settings.providers.baseUrlHint\": \"(선택사항, 커스텀 엔드포인트용)\",\n  \"settings.providers.defaultModel\": \"기본 모델\",\n  \"settings.providers.defaultModelHint\": \"(선택사항)\",\n  \"settings.providers.save\": \"저장\",\n  \"settings.providers.update\": \"수정\",\n  \"settings.providers.cancel\": \"취소\",\n  \"settings.providers.added\": \"LLM 프로바이더 추가됨\",\n  \"settings.providers.updated\": \"LLM 프로바이더 수정됨\",\n  \"settings.providers.deleted\": \"LLM 프로바이더 삭제됨\",\n  \"settings.providers.addFailed\": \"프로바이더 추가 실패\",\n  \"settings.providers.updateFailed\": \"프로바이더 수정 실패\",\n  \"settings.providers.deleteFailed\": \"프로바이더 삭제 실패\",\n  \"settings.telegram.title\": \"텔레그램 연동\",\n  \"settings.telegram.subtitle\": \"텔레그램에서 봇을 제어하세요\",\n  \"settings.telegram.notConfigured\": \"텔레그램 봇이 설정되지 않았습니다. TELEGRAM_BOT_TOKEN을 설정하세요.\",\n  \"settings.telegram.linked\": \"텔레그램 연결됨\",\n  \"settings.telegram.unlink\": \"연결 해제\",\n  \"settings.telegram.unlinked\": \"텔레그램 계정 연결이 해제되었습니다\",\n  \"settings.telegram.howToLink\": \"텔레그램 계정 연결\",\n  \"settings.telegram.step1\": \"아래 '연결 코드 생성' 버튼을 클릭하세요\",\n  \"settings.telegram.step2\": \"텔레그램에서 Maker 봇을 찾아 대화를 시작하세요\",\n  \"settings.telegram.step3\": \"생성된 /link 명령어를 텔레그램에 붙여넣으세요\",\n  \"settings.telegram.generateCode\": \"연결 코드 생성\",\n  \"settings.telegram.codeFailed\": \"연결 코드 생성 실패\",\n  \"settings.telegram.setupGuideTitle\": \"텔레그램 설정 방법\",\n  \"settings.telegram.setupGuide1\": \"1. 텔레그램에서 @BotFather를 검색하세요\",\n  \"settings.telegram.setupGuide2\": \"2. /newbot 명령어를 보내고 안내에 따라 봇을 생성하세요\",\n  \"settings.telegram.setupGuide3\": \"3. 받은 봇 토큰을 복사하세요\",\n  \"settings.telegram.setupGuide4\": \"4. 환경 변수(Secrets)에 TELEGRAM_BOT_TOKEN으로 추가하세요\",\n  \"settings.telegram.setupGuide5\": \"5. 앱을 재시작한 후 이 페이지에서 계정을 연결하세요\",\n  \"settings.telegram.commands\": \"텔레그램에서 사용 가능한 명령어\",\n  \"settings.telegram.cmdStart\": \"/start — 소개 및 설정 안내\",\n  \"settings.telegram.cmdLink\": \"/link CODE — Maker 계정 연결\",\n  \"settings.telegram.cmdUnlink\": \"/unlink — 계정 연결 해제\",\n  \"settings.telegram.cmdHelp\": \"/help — 사용 가능한 명령어 보기\",\n  \"settings.telegram.cmdNatural\": \"또는 자연어로 입력하세요. 예: \\\"내 봇 상태 확인해줘\\\"\",\n  \"settings.scheduler.title\": \"스케줄러 상태\",\n  \"settings.scheduler.subtitle\": \"자동 콘텐츠 수집 및 분석\",\n  \"settings.scheduler.running\": \"실행 중\",\n  \"settings.scheduler.stopped\": \"중지됨\",\n  \"settings.scheduler.start\": \"시작\",\n  \"settings.scheduler.stop\": \"중지\",\n  \"settings.scheduler.started\": \"스케줄러 시작됨\",\n  \"settings.scheduler.stoppedMsg\": \"스케줄러 중지됨\",\n  \"settings.scheduler.toggleFailed\": \"스케줄러 전환 실패\",\n  \"settings.scheduler.rssCollection\": \"RSS 수집\",\n  \"settings.scheduler.contentAnalysis\": \"콘텐츠 분석\",\n  \"settings.scheduler.draftGeneration\": \"초안 생성\",\n  \"settings.scheduler.interval\": \"간격:\",\n  \"settings.scheduler.last\": \"마지막:\",\n  \"settings.scheduler.runNow\": \"지금 실행\",\n  \"settings.scheduler.jobStarted\": \"{{job}} 작업 시작됨\",\n  \"settings.scheduler.jobFailed\": \"작업 실행 실패\",\n\n  \"sources.title\": \"소스\",\n  \"sources.subtitle\": \"RSS 피드 및 콘텐츠 소스 관리\",\n  \"sources.addSource\": \"소스 추가\",\n  \"sources.addFirst\": \"첫 번째 소스 추가\",\n  \"sources.noSources\": \"추가된 소스 없음\",\n  \"sources.noSourcesHint\": \"콘텐츠 수집을 시작하려면 RSS 피드를 추가하세요\",\n  \"sources.dialog.title\": \"새 소스 추가\",\n  \"sources.dialog.desc\": \"콘텐츠를 수집할 새 RSS 피드를 추가합니다\",\n  \"sources.dialog.name\": \"이름\",\n  \"sources.dialog.namePlaceholder\": \"내 피드\",\n  \"sources.dialog.feedUrl\": \"피드 URL\",\n  \"sources.dialog.feedUrlPlaceholder\": \"https://example.com/feed.xml\",\n  \"sources.dialog.topic\": \"주제\",\n  \"sources.dialog.trust\": \"신뢰도\",\n  \"sources.dialog.region\": \"지역\",\n  \"sources.dialog.creating\": \"생성 중...\",\n  \"sources.dialog.create\": \"소스 생성\",\n  \"sources.created\": \"소스가 성공적으로 생성되었습니다\",\n  \"sources.createFailed\": \"소스 생성 실패\",\n  \"sources.deleted\": \"소스 삭제됨\",\n  \"sources.deleteFailed\": \"소스 삭제 실패\",\n  \"sources.collectionStarted\": \"수집 시작됨\",\n  \"sources.collectionFailed\": \"수집 시작 실패\",\n  \"sources.delete.title\": \"소스 삭제\",\n  \"sources.delete.desc\": \"\\\"{{name}}\\\"을(를) 삭제하시겠습니까? 수집된 아이템은 삭제되지 않습니다.\",\n  \"sources.delete.cancel\": \"취소\",\n  \"sources.delete.confirm\": \"삭제\",\n  \"sources.active\": \"활성\",\n  \"sources.disabled\": \"비활성\",\n  \"sources.itemsCollected\": \"{{count}}개 아이템 수집됨\",\n  \"sources.created2\": \"{{date}}에 생성됨\",\n\n  \"profiles.title\": \"내 워크플로우 봇\",\n  \"profiles.subtitle\": \"봇의 소스, 스케줄, 출력을 설정하고 관리하세요\",\n  \"profiles.noBots\": \"아직 봇이 없습니다\",\n  \"profiles.noBotsDesc\": \"아래 템플릿에서 첫 번째 워크플로우를 시작하세요. 소스, 스케줄, 출력을 자유롭게 커스터마이징할 수 있습니다.\",\n  \"profiles.startTemplate\": \"템플릿으로 시작\",\n  \"profiles.createNew\": \"새 봇 만들기\",\n  \"profiles.createNewDesc\": \"템플릿에서 선택\",\n  \"profiles.galleryTitle\": \"워크플로우 레시피\",\n  \"profiles.gallerySubtitle\": \"이 템플릿들은 워크플로우를 만들기 위한 출발점이지 최종 답이 아닙니다.\",\n  \"profiles.noTemplates\": \"아직 사용 가능한 템플릿이 없습니다. 설정되면 여기에 표시됩니다.\",\n  \"profiles.sources\": \"소스: {{count}}개 기본 채널\",\n  \"profiles.output\": \"출력: {{type}}\",\n  \"profiles.startWith\": \"이 설정으로 시작\",\n  \"profiles.other\": \"기타\",\n  \"profiles.wizard.chooseTemplate\": \"템플릿 선택\",\n  \"profiles.wizard.chooseTemplateDesc\": \"시작할 템플릿을 선택하세요. 나중에 모든 것을 커스터마이징할 수 있습니다.\",\n  \"profiles.wizard.selectTopic\": \"주제 선택\",\n  \"profiles.wizard.selectTopicDesc\": \"이 템플릿은 여러 주제를 지원합니다. {{name}}의 집중 영역을 선택하세요.\",\n  \"profiles.wizard.configure\": \"봇 구성\",\n  \"profiles.wizard.configureDesc\": \"봇의 워크플로우를 설정하세요. 기본 소스는 일반 공개 채널입니다 — 더 전문적인 커버리지를 위해 자신만의 소스를 추가하세요.\",\n  \"profiles.wizard.botName\": \"봇 이름\",\n  \"profiles.wizard.topic\": \"주제\",\n  \"profiles.wizard.defaultSources\": \"기본 소스\",\n  \"profiles.wizard.customSourceUrl\": \"커스텀 소스 URL\",\n  \"profiles.wizard.customSourceUrlPlaceholder\": \"https://example.com/rss\",\n  \"profiles.wizard.customSourceName\": \"이름 (선택사항)\",\n  \"profiles.wizard.addSource\": \"추가\",\n  \"profiles.wizard.back\": \"뒤로\",\n  \"profiles.wizard.creating\": \"생성 중...\",\n  \"profiles.wizard.createBot\": \"봇 만들기\",\n  \"profiles.wizard.customTopicLabel\": \"또는 직접 분야를 입력하세요\",\n  \"profiles.wizard.customTopicPlaceholder\": \"예: health, finance, education\",\n  \"profiles.wizard.customTopicUse\": \"사용\",\n  \"profiles.wizard.customTopicDuplicate\": \"이 분야의 봇이 이미 존재합니다.\",\n  \"profiles.wizard.customTopicHint\": \"영문 소문자, 숫자, 밑줄만 가능합니다. 같은 분야 키는 재사용할 수 없습니다.\",\n  \"profiles.wizard.sourceDisclaimer\": \"소스 참고사항\",\n  \"profiles.botCreated\": \"봇이 성공적으로 생성되었습니다\",\n  \"profiles.botCreateFailed\": \"봇 생성에 실패했습니다\",\n  \"profiles.botDeleted\": \"봇 삭제됨\",\n  \"profiles.urlAlreadyAdded\": \"이 소스 URL은 이미 추가되었습니다\",\n  \"profiles.invalidUrl\": \"유효한 URL을 입력하세요\",\n  \"profiles.deleteConfirm\": \"이 봇을 삭제하시겠습니까?\",\n\n  \"botDetail.title\": \"봇 설정\",\n  \"botDetail.notFound\": \"봇을 찾을 수 없습니다\",\n  \"botDetail.back\": \"내 봇으로 돌아가기\",\n  \"botDetail.saveChanges\": \"변경 사항 저장\",\n  \"botDetail.saved\": \"봇 설정이 저장되었습니다\",\n  \"botDetail.saveFailed\": \"설정 저장 실패\",\n  \"botDetail.workflow.title\": \"이 봇의 워크플로우\",\n  \"botDetail.workflow.watching\": \"모니터링:\",\n  \"botDetail.workflow.sources\": \"{{count}}개 소스\",\n  \"botDetail.workflow.schedule\": \"스케줄:\",\n  \"botDetail.workflow.notSet\": \"미설정\",\n  \"botDetail.workflow.output\": \"출력:\",\n  \"botDetail.workflow.hint\": \"이 설정은 목적에 맞게 언제든 변경할 수 있습니다.\",\n  \"botDetail.general\": \"일반\",\n  \"botDetail.botName\": \"봇 이름\",\n  \"botDetail.enabled\": \"활성화\",\n  \"botDetail.active\": \"활성\",\n  \"botDetail.paused\": \"일시정지\",\n  \"botDetail.aiModel.title\": \"AI 모델\",\n  \"botDetail.aiModel.subtitle\": \"이 봇이 분석 및 리포트에 사용할 AI 프로바이더를 선택하세요\",\n  \"botDetail.aiModel.provider\": \"LLM 프로바이더\",\n  \"botDetail.aiModel.providerPlaceholder\": \"AI 프로바이더 선택\",\n  \"botDetail.aiModel.noProviders\": \"아직 AI 프로바이더가 없습니다. 먼저 설정에서 API 키를 추가하세요.\",\n  \"botDetail.aiModel.modelOverride\": \"모델 오버라이드\",\n  \"botDetail.aiModel.modelOverrideHint\": \"(선택사항)\",\n  \"botDetail.aiModel.modelOverridePlaceholder\": \"프로바이더 기본값을 사용하려면 비워두세요\",\n  \"botDetail.aiModel.availableModels\": \"{{type}}에서 사용 가능: {{models}}\",\n  \"botDetail.aiModel.modelMismatch\": \"이 모델 이름은 {{type}}의 알려진 목록에 없습니다. 올바른지 확인하세요.\",\n  \"botDetail.aiModel.providerDeleted\": \"이전에 할당된 프로바이더가 삭제되었습니다. 이 봇은 시스템 기본값으로 재설정되었습니다. 저장하여 확인하세요.\",\n  \"botDetail.schedule.title\": \"스케줄\",\n  \"botDetail.schedule.subtitle\": \"이 봇이 리포트를 생성하는 시점\",\n  \"botDetail.schedule.runDays\": \"실행 요일\",\n  \"botDetail.schedule.daily\": \"매일\",\n  \"botDetail.schedule.weekdays\": \"평일만 (월-금)\",\n  \"botDetail.schedule.weekends\": \"주말만 (토-일)\",\n  \"botDetail.schedule.runTime\": \"실행 시간\",\n  \"botDetail.schedule.timezone\": \"시간대\",\n  \"botDetail.format.title\": \"리포트 형식\",\n  \"botDetail.format.subtitle\": \"리포트 작성 방식 제어\",\n  \"botDetail.format.length\": \"리포트 길이\",\n  \"botDetail.format.short\": \"짧게 (간단한 요약)\",\n  \"botDetail.format.normal\": \"보통 (표준 상세도)\",\n  \"botDetail.format.detailed\": \"상세 (전체 분석)\",\n  \"botDetail.format.style\": \"작성 스타일\",\n  \"botDetail.format.conversational\": \"대화체 (뉴스 앵커 톤, 최소한의 기호)\",\n  \"botDetail.format.structured\": \"구조화 (마크다운 헤더 및 서식)\",\n  \"botDetail.format.sections\": \"리포트 섹션\",\n  \"botDetail.format.section.tldr\": \"TL;DR 요약\",\n  \"botDetail.format.section.drivers\": \"시장 동인 / 핵심 트렌드\",\n  \"botDetail.format.section.risk\": \"리스크 레이더\",\n  \"botDetail.format.section.checklist\": \"액션 체크리스트\",\n  \"botDetail.format.section.sources\": \"소스 참조\",\n  \"botDetail.filters.title\": \"필터\",\n  \"botDetail.filters.subtitle\": \"포함되는 콘텐츠 제어\",\n  \"botDetail.filters.minImportance\": \"최소 중요도 점수: {{score}}\",\n  \"botDetail.filters.hint\": \"이 임계값 미만의 아이템은 리포트에서 제외됩니다.\",\n  \"botDetail.filters.filtering\": \"현재 {{score}}/100 미만의 아이템을 필터링합니다.\",\n  \"botDetail.sources.title\": \"연결된 소스 ({{count}})\",\n  \"botDetail.sources.subtitle\": \"이 봇에 데이터를 공급하는 소스\",\n  \"botDetail.sources.none\": \"아직 연결된 소스가 없습니다.\",\n  \"botDetail.sources.noneHint\": \"아래에서 소스를 추가하여 이 봇의 데이터 수집을 시작하세요.\",\n  \"botDetail.sources.weight\": \"가중치: {{weight}}\",\n  \"botDetail.sources.available\": \"사용 가능한 소스\",\n  \"botDetail.sources.add\": \"추가\",\n  \"botDetail.sources.goToSources\": \"소스 페이지로 이동\",\n  \"botDetail.sources.linked\": \"소스가 봇에 연결되었습니다\",\n  \"botDetail.sources.linkFailed\": \"소스 연결 실패\",\n  \"botDetail.sources.removed\": \"소스가 봇에서 제거되었습니다\",\n  \"botDetail.sources.removeFailed\": \"소스 제거 실패\",\n\n  \"botDetail.schedule.daily2\": \"매일\",\n  \"botDetail.schedule.weekdays2\": \"평일\",\n  \"botDetail.schedule.weekends2\": \"주말\",\n  \"botDetail.format.conversational2\": \"대화체\",\n  \"botDetail.format.structured2\": \"구조화\",\n  \"botDetail.format.short2\": \"짧게\",\n  \"botDetail.format.normal2\": \"보통\",\n  \"botDetail.format.detailed2\": \"상세\",\n\n  \"sources.topic.tech\": \"테크\",\n  \"sources.topic.investing\": \"투자\",\n  \"sources.topic.crypto\": \"암호화폐\",\n  \"sources.topic.ai_art\": \"AI 아트\",\n  \"sources.topic.creative\": \"크리에이티브\",\n  \"sources.topic.community_research\": \"커뮤니티 리서치\",\n  \"sources.topic.market_brief\": \"시장 브리핑\",\n  \"sources.topic.research_watch\": \"연구 워치\",\n  \"sources.topic.competitor_watch\": \"경쟁사 워치\",\n  \"sources.topic.finance\": \"금융\",\n  \"sources.topic.compliance\": \"컴플라이언스\",\n  \"sources.topic.commerce\": \"커머스\",\n  \"sources.topic.engagement\": \"참여\",\n  \"sources.topic.health\": \"건강\",\n  \"sources.topic.science\": \"과학\",\n  \"sources.topic.education\": \"교육\",\n  \"sources.topic.content_research\": \"콘텐츠 리서치\",\n  \"sources.topic.work_productivity\": \"업무 & 생산성\",\n  \"sources.topic.online_business\": \"온라인 비즈니스\",\n  \"sources.topic.korea_marketplace\": \"한국 마켓플레이스\",\n  \"sources.topic.gaming\": \"게임\",\n  \"sources.topic.sustainability\": \"지속가능성\",\n  \"sources.topic.other\": \"기타\",\n  \"sources.validation.nameRequired\": \"이름을 입력하세요\",\n  \"sources.validation.validUrl\": \"유효한 URL을 입력하세요\",\n\n  \"profiles.category.information\": \"정보\",\n  \"profiles.category.business\": \"비즈니스\",\n  \"profiles.category.compliance\": \"컴플라이언스\",\n  \"profiles.category.research\": \"리서치\",\n  \"profiles.category.commerce\": \"커머스\",\n  \"profiles.category.engagement\": \"참여\",\n  \"profiles.category.finance\": \"금융\",\n  \"profiles.category.work\": \"업무\",\n\n  \"guide.title\": \"시작 가이드\",\n  \"guide.intro\": \"Maker는 당신을 대신해 작업을 처리하는 AI 자동화 어시스턴트를 직접 만들 수 있는 도구입니다. 코딩이 필요 없습니다 — 템플릿을 선택하고, 몇 번 클릭하면 나만의 AI 워크플로우를 만들 수 있습니다.\",\n  \"guide.capabilities\": \"Maker로 무엇을 할 수 있나요?\",\n  \"guide.capability1\": \"매일 아침 뉴스, 커뮤니티 게시물, 시장 데이터를 자동으로 수집\",\n  \"guide.capability2\": \"수집된 콘텐츠를 요약, 분석, 정리하여 리포트로 작성\",\n  \"guide.capability3\": \"블로그 포스트, 브리핑, 리포트 초안 자동 생성\",\n  \"guide.capability4\": \"투자 리서치, 트렌드 분석, 콘텐츠 큐레이션 자동화\",\n  \"guide.capability5\": \"나만의 규칙으로 \\\"AI 어시스턴트\\\" 운영\",\n  \"guide.corePoint\": \"핵심:\",\n  \"guide.coreDesc\": \"Maker는 봇을 빌려주는 서비스가 아닙니다 — 나만의 자동화를 설계하는 도구입니다.\",\n  \"guide.stepsHeading\": \"6단계로 시작하기\",\n  \"guide.step1.title\": \"회원가입 & 로그인\",\n  \"guide.step1.p1\": \"maker.am에서 가입 또는 로그인하세요.\",\n  \"guide.step1.p2\": \"대시보드가 보이면 준비 완료입니다.\",\n  \"guide.step2.title\": \"LLM API 등록\",\n  \"guide.step2.subtitle\": \"Claude, OpenAI 등\",\n  \"guide.step2.p1\": \"Maker는 AI 작업을 실행하기 위해 사용자의 API 키를 사용합니다.\",\n  \"guide.step2.li1\": \"사이드바에서 <strong>설정</strong>을 클릭하세요\",\n  \"guide.step2.li2\": \"<strong>LLM 프로바이더</strong> 섹션에서 <strong>프로바이더 추가</strong>를 클릭하세요\",\n  \"guide.step2.li3\": \"다음 항목을 입력하세요:\",\n  \"guide.step2.fieldName\": \"이름:\",\n  \"guide.step2.fieldNameEx\": \"예: 내 Claude API\",\n  \"guide.step2.fieldType\": \"프로바이더 유형:\",\n  \"guide.step2.fieldTypeEx\": \"Anthropic (Claude) / OpenAI 등 선택\",\n  \"guide.step2.fieldKey\": \"API 키:\",\n  \"guide.step2.fieldKeyEx\": \"발급받은 키를 붙여넣기\",\n  \"guide.step2.fieldUrl\": \"Base URL:\",\n  \"guide.step2.fieldUrlEx\": \"비워두기 (기본값 사용)\",\n  \"guide.step2.fieldModel\": \"기본 모델:\",\n  \"guide.step2.fieldModelEx\": \"비워두거나 예: claude-3-5-sonnet-latest\",\n  \"guide.step2.done\": \"저장을 클릭하면 Maker가 AI 모델을 사용할 수 있습니다.\",\n  \"guide.step3.title\": \"템플릿으로 봇 만들기\",\n  \"guide.step3.li1\": \"<strong>대시보드</strong> 또는 <strong>내 봇</strong>으로 이동하세요\",\n  \"guide.step3.li2\": \"<strong>봇 만들기 / 템플릿에서</strong>를 클릭하세요\",\n  \"guide.step3.li3\": \"템플릿을 선택하세요 (예: 커뮤니티 리서치, 투자 등)\",\n  \"guide.step3.li4\": \"봇 이름을 지정하고 생성하세요\",\n  \"guide.step3.hint1\": \"템플릿은 미리 설계된 자동화 레시피입니다.\",\n  \"guide.step3.hint2\": \"첫 번째 봇은 템플릿으로 시작하는 것을 추천합니다.\",\n  \"guide.step4.title\": \"소스 추가\",\n  \"guide.step4.p1\": \"AI가 정보를 수집할 곳을 정의하는 단계입니다.\",\n  \"guide.step4.li1\": \"사이드바에서 <strong>소스</strong>를 클릭하세요\",\n  \"guide.step4.li2\": \"소스를 추가, 수정, 삭제하세요\",\n  \"guide.step4.li3\": \"변경 사항을 저장하세요\",\n  \"guide.step4.hint1\": \"예: 뉴스 사이트, 블로그 RSS 피드, Reddit, Hacker News, TechCrunch 등\",\n  \"guide.step4.hint2\": \"여기서 설정한 소스를 기반으로 AI가 콘텐츠를 수집합니다.\",\n  \"guide.step5.title\": \"콘솔로 AI에게 명령\",\n  \"guide.step5.p1\": \"사이드바에서 <strong>콘솔</strong>로 이동하세요.\",\n  \"guide.step5.p2\": \"다음과 같은 명령을 입력해 보세요:\",\n  \"guide.step5.cmd1\": \"\\\"오늘 수집된 아이템 요약해줘\\\"\",\n  \"guide.step5.cmd2\": \"\\\"투자 관점에서 분석해줘\\\"\",\n  \"guide.step5.cmd3\": \"\\\"블로그 포스트 초안 작성해줘\\\"\",\n  \"guide.step5.p3\": \"Maker의 핵심 아이디어: <strong>\\\"AI에게 질문하지 말고, 일을 시키세요.\\\"</strong>\",\n  \"guide.step6.title\": \"결과 검토 & 승인\",\n  \"guide.step6.li1\": \"<strong>초안</strong> 또는 <strong>리포트</strong>로 이동하세요\",\n  \"guide.step6.li2\": \"AI가 생성한 초안을 검토하세요\",\n  \"guide.step6.li3\": \"수정하거나 그대로 사용하세요\",\n  \"guide.step6.li4\": \"승인 또는 내보내기\",\n  \"guide.step6.hint\": \"AI가 일하고, 당신이 결정합니다.\",\n  \"guide.faq.title\": \"자주 묻는 질문\",\n  \"guide.faq.q1\": \"Maker는 챗봇 서비스인가요?\",\n  \"guide.faq.a1\": \"아닙니다. Maker는 워크플로우 기반 자동화 도구입니다. 채팅 콘솔은 명령을 내리는 인터페이스일 뿐이며, 핵심 가치는 백그라운드에서 실행되는 자동화 워크플로우에 있습니다.\",\n  \"guide.faq.q2\": \"코딩을 알아야 하나요?\",\n  \"guide.faq.a2\": \"전혀 아닙니다. 템플릿, 몇 번의 클릭, 간단한 설정만으로 시작할 수 있습니다.\",\n  \"guide.faq.q3\": \"API 키는 안전한가요?\",\n  \"guide.faq.a3\": \"Maker는 AI 호출을 위해서만 API 키를 사용합니다. 키는 외부에 노출되지 않으며, 언제든 교체하거나 삭제할 수 있습니다.\",\n  \"guide.faq.q4\": \"Claude와 GPT를 동시에 사용할 수 있나요?\",\n  \"guide.faq.a4\": \"네. 설정에서 여러 LLM 프로바이더를 등록하고 필요에 따라 전환할 수 있습니다.\",\n  \"guide.faq.q5\": \"Maker는 누구에게 유용한가요?\",\n  \"guide.faq.a5\": \"일일 리서치, 요약, 분석이 필요한 모든 사람. 콘텐츠 크리에이터, 작가, 기획자. 트렌드 추적을 자동화하려는 투자자와 시장 분석가. AI를 Q&A 도구가 아닌 생산적인 어시스턴트로 활용하고 싶은 모든 사람.\",\n  \"guide.philosophy\": \"\\\"AI에게 질문하지 말고, 일을 시키세요.\\\"\",\n  \"guide.philosophyDesc\": \"Maker는 시간과 집중력을 절약하는 자동화 어시스턴트를 만드는 도구입니다.\",\n  \"guide.settingsButton\": \"설정\",\n  \"guide.botsButton\": \"내 봇\",\n\n  \"observe.title\": \"모니터링 목록\",\n  \"observe.subtitle\": \"높은 관련성, 낮은 응답 가치 - 시장 리서치와 콘텐츠 아이디어에 유용\",\n  \"observe.noItems\": \"모니터링할 항목 없음\",\n  \"observe.noItemsHint\": \"높은 관련성이지만 낮은 응답 가치의 항목이 여기에 표시됩니다\",\n  \"observe.relevance\": \"관련성:\",\n  \"observe.reply\": \"응답:\",\n  \"observe.viewOriginal\": \"원본 보기\",\n  \"observe.details\": \"상세\",\n\n  \"items.title\": \"아이템\",\n  \"items.subtitle\": \"RSS 피드에서 수집된 콘텐츠\",\n  \"items.searchPlaceholder\": \"아이템 검색...\",\n  \"items.filterStatus\": \"상태별 필터\",\n  \"items.allStatus\": \"전체 상태\",\n  \"items.status.new\": \"새 항목\",\n  \"items.status.analyzed\": \"분석됨\",\n  \"items.status.drafted\": \"초안\",\n  \"items.status.approved\": \"승인됨\",\n  \"items.status.posted\": \"게시됨\",\n  \"items.status.skipped\": \"건너뜀\",\n  \"items.count\": \"아이템 ({{count}})\",\n  \"items.noItems\": \"아이템을 찾을 수 없습니다\",\n  \"items.noItemsFilter\": \"상태 필터를 변경해 보세요\",\n  \"items.noItemsDefault\": \"콘텐츠 수집을 시작하려면 RSS 소스를 추가하세요\",\n  \"items.relevance\": \"관련성: {{score}}\",\n  \"items.replyScore\": \"응답 점수: {{score}}\",\n  \"items.by\": \"작성자: {{author}}\",\n\n  \"drafts.title\": \"초안\",\n  \"drafts.subtitle\": \"생성된 응답 초안 검토 및 승인\",\n  \"drafts.filterDecision\": \"결정별 필터\",\n  \"drafts.allDecisions\": \"전체 결정\",\n  \"drafts.decision.pending\": \"대기 중\",\n  \"drafts.decision.approved\": \"승인됨\",\n  \"drafts.decision.rejected\": \"거부됨\",\n  \"drafts.count\": \"초안 ({{count}})\",\n  \"drafts.variant\": \"변형 {{variant}}\",\n  \"drafts.approve\": \"승인\",\n  \"drafts.reject\": \"거부\",\n  \"drafts.copy\": \"복사\",\n  \"drafts.viewItem\": \"아이템 보기\",\n  \"drafts.noDrafts\": \"초안을 찾을 수 없습니다\",\n  \"drafts.noDraftsFilter\": \"필터를 변경해 보세요\",\n  \"drafts.noDraftsDefault\": \"분석 후 초안이 여기에 표시됩니다\",\n  \"drafts.approved\": \"초안이 승인되었습니다\",\n  \"drafts.rejected\": \"초안이 거부되었습니다\",\n  \"drafts.copiedToClipboard\": \"클립보드에 복사됨\",\n\n  \"itemDetail.notFound\": \"아이템을 찾을 수 없습니다\",\n  \"itemDetail.backToItems\": \"아이템 목록으로\",\n  \"itemDetail.by\": \"작성자: {{author}}\",\n  \"itemDetail.original\": \"원본\",\n  \"itemDetail.originalContent\": \"원본 콘텐츠\",\n  \"itemDetail.analysis\": \"분석\",\n  \"itemDetail.relevance\": \"관련성\",\n  \"itemDetail.replyScore\": \"응답 점수\",\n  \"itemDetail.linkFit\": \"링크 적합성\",\n  \"itemDetail.suggestedAngle\": \"제안 각도:\",\n  \"itemDetail.summary\": \"요약:\",\n  \"itemDetail.draftReplies\": \"응답 초안\",\n  \"itemDetail.skip\": \"건너뛰기\",\n  \"itemDetail.reanalyze\": \"재분석\",\n  \"itemDetail.variant\": \"변형 {{variant}}\",\n  \"itemDetail.includesLink\": \"링크 포함\",\n  \"itemDetail.editPlaceholder\": \"초안 텍스트를 수정하세요...\",\n  \"itemDetail.approve\": \"승인\",\n  \"itemDetail.reject\": \"거부\",\n  \"itemDetail.copy\": \"복사\",\n  \"itemDetail.copyNoLinks\": \"링크 없이 복사\",\n  \"itemDetail.approvedFinal\": \"승인된 최종 텍스트\",\n  \"itemDetail.noDrafts\": \"아직 초안이 생성되지 않았습니다\",\n  \"itemDetail.draftsWillGenerate\": \"초안이 자동으로 생성됩니다\",\n  \"itemDetail.approvedSuccess\": \"초안이 성공적으로 승인되었습니다\",\n  \"itemDetail.approveFailed\": \"초안 승인 실패\",\n  \"itemDetail.rejectedSuccess\": \"초안이 거부되었습니다\",\n  \"itemDetail.rejectFailed\": \"초안 거부 실패\",\n  \"itemDetail.skipped\": \"아이템 건너뛰기 완료\",\n  \"itemDetail.skipFailed\": \"아이템 건너뛰기 실패\",\n  \"itemDetail.reanalysis\": \"재분석 시작됨\",\n  \"itemDetail.reanalysisFailed\": \"재분석 시작 실패\",\n  \"itemDetail.copiedToClipboard\": \"클립보드에 복사됨\",\n  \"itemDetail.riskFlag.promo_ban\": \"홍보 금지\",\n  \"itemDetail.riskFlag.link_ban\": \"링크 금지\",\n  \"itemDetail.riskFlag.heated_topic\": \"논쟁적 주제\",\n  \"itemDetail.riskFlag.new_account_risk\": \"신규 계정 위험\",\n  \"itemDetail.riskFlag.unknown_rules\": \"알 수 없는 규칙\",\n\n  \"common.untitled\": \"제목 없음\",\n  \"common.status.new\": \"새 항목\",\n  \"common.status.analyzed\": \"분석됨\",\n  \"common.status.drafted\": \"초안\",\n  \"common.status.approved\": \"승인됨\",\n  \"common.status.posted\": \"게시됨\",\n  \"common.status.skipped\": \"건너뜀\",\n  \"common.decision.pending\": \"대기 중\",\n  \"common.decision.approved\": \"승인됨\",\n  \"common.decision.rejected\": \"거부됨\",\n\n  \"runs.title\": \"실행 이력\",\n  \"runs.empty\": \"아직 실행 기록이 없습니다\",\n  \"runs.viewAll\": \"전체 이력 보기\",\n  \"runs.lastRun\": \"마지막 실행\",\n  \"runs.status\": \"상태\",\n  \"runs.trigger\": \"트리거\",\n  \"runs.jobType\": \"유형\",\n  \"runs.duration\": \"소요 시간\",\n  \"runs.startedAt\": \"시작 시간\",\n  \"runs.items\": \"항목\",\n  \"runs.error\": \"오류\",\n  \"runs.status.ok\": \"성공\",\n  \"runs.status.error\": \"실패\",\n  \"runs.status.timeout\": \"시간 초과\",\n  \"runs.status.skipped\": \"건너뜀\",\n  \"runs.status.started\": \"실행 중\",\n  \"runs.trigger.schedule\": \"예약\",\n  \"runs.trigger.console\": \"콘솔\",\n  \"runs.trigger.manual\": \"수동\",\n  \"runs.jobType.report\": \"리포트\",\n  \"runs.jobType.pipeline\": \"파이프라인\",\n  \"runs.jobType.collect\": \"수집\",\n  \"runs.jobType.analyze\": \"분석\",\n  \"runs.neverRan\": \"실행 기록 없음\",\n  \"runs.ago\": \"{{time}} 전\",\n\n  \"diag.title\": \"봇 상태\",\n  \"diag.healthy\": \"모든 시스템 정상\",\n  \"diag.warnings\": \"경고 {{count}}건\",\n  \"diag.errors\": \"문제 {{count}}건 발견\",\n  \"diag.noBotsYet\": \"봇을 만들면 진단 정보를 확인할 수 있습니다\",\n  \"diag.checkAll\": \"전체 진단 보기\",\n\n  \"lang.en\": \"EN\",\n  \"lang.ko\": \"KO\",\n  \"lang.english\": \"English\",\n  \"lang.korean\": \"한국어\",\n\n  \"perm.title\": \"권한 관리\",\n  \"perm.subtitle\": \"봇이 접근하고 수행할 수 있는 작업을 제어합니다\",\n  \"perm.globalDefaults\": \"전역 기본값\",\n  \"perm.botOverrides\": \"봇별 재정의\",\n  \"perm.group.web_sources\": \"웹 & 소스\",\n  \"perm.group.ai_data\": \"AI & 데이터\",\n  \"perm.group.files\": \"파일\",\n  \"perm.group.calendar\": \"캘린더\",\n  \"perm.group.scheduling\": \"스케줄링\",\n  \"perm.enabled\": \"활성화됨\",\n  \"perm.disabled\": \"비활성화됨\",\n  \"perm.mode.AUTO_ALLOWED\": \"자동 허용\",\n  \"perm.mode.APPROVAL_REQUIRED\": \"승인 필요\",\n  \"perm.mode.AUTO_DENIED\": \"거부됨\",\n  \"perm.egress.NO_EGRESS\": \"데이터 미전송\",\n  \"perm.egress.METADATA_ONLY\": \"메타데이터만\",\n  \"perm.egress.FULL_CONTENT_ALLOWED\": \"전체 콘텐츠\",\n  \"perm.risk.LOW\": \"낮은 위험\",\n  \"perm.risk.MED\": \"보통 위험\",\n  \"perm.risk.HIGH\": \"높은 위험\",\n  \"perm.source.default\": \"기본값\",\n  \"perm.source.global\": \"전역 재정의\",\n  \"perm.source.bot\": \"봇별 재정의\",\n  \"perm.resetToDefault\": \"기본값으로 재설정\",\n  \"perm.saved\": \"권한이 저장되었습니다\",\n  \"perm.deleted\": \"권한이 기본값으로 재설정되었습니다\",\n  \"perm.error\": \"권한 업데이트에 실패했습니다\",\n  \"perm.egressLevel\": \"데이터 전송 수준\",\n  \"perm.overrideForBot\": \"이 봇에 대해 재정의\",\n  \"perm.usingGlobal\": \"전역 설정 사용 중\",\n  \"perm.noOverrides\": \"봇별 재정의가 설정되지 않았습니다\",\n\n  \"audit.title\": \"감사 로그\",\n  \"audit.subtitle\": \"권한 변경 및 보안 이벤트 추적\",\n  \"audit.noLogs\": \"아직 감사 이벤트가 없습니다\",\n  \"audit.eventType\": \"이벤트\",\n  \"audit.permKey\": \"권한\",\n  \"audit.time\": \"시간\",\n  \"audit.details\": \"상세\",\n  \"audit.PERMISSION_CHANGED\": \"권한 변경됨\",\n  \"audit.PERMISSION_DELETED\": \"권한 초기화됨\",\n  \"audit.PERMISSION_DENIED\": \"작업 거부됨\",\n  \"audit.APPROVAL_REQUESTED\": \"승인 요청됨\",\n  \"audit.APPROVAL_GRANTED_ONCE\": \"승인됨 (1회)\",\n  \"audit.APPROVAL_GRANTED_BOT\": \"승인됨 (봇)\",\n  \"audit.APPROVAL_GRANTED_GLOBAL\": \"승인됨 (전역)\",\n\n  \"pd.title\": \"권한 대시보드\",\n  \"pd.subtitle\": \"이 봇이 접근하고 수행할 수 있는 작업을 제어합니다\",\n  \"pd.summary\": \"권한 상태\",\n  \"pd.totalPermissions\": \"개 권한\",\n  \"pd.active\": \"활성화\",\n  \"pd.needsApproval\": \"승인 필요\",\n  \"pd.blocked\": \"비활성화\",\n  \"pd.group.data_collection\": \"데이터 수집\",\n  \"pd.group.ai_processing\": \"AI 처리\",\n  \"pd.group.local_system\": \"로컬 시스템\",\n  \"pd.group.automation\": \"자동화 제어\",\n  \"pd.currentStatus\": \"현재 상태\",\n  \"pd.description\": \"설명\",\n  \"pd.riskLevel\": \"위험 수준\",\n  \"pd.changeStatus\": \"상태 변경\",\n  \"pd.applyScope\": \"적용 범위\",\n  \"pd.thisBotOnly\": \"이 봇에만\",\n  \"pd.allBots\": \"전역 (모든 봇)\",\n  \"pd.highRisk\": \"높은 위험\",\n  \"pd.recentHistory\": \"최근 활동 (7일)\",\n  \"pd.noRecentHistory\": \"최근 활동이 없습니다\",\n  \"pd.approvedOnce\": \"1회 승인\",\n  \"pd.approvedBot\": \"봇 승인\",\n  \"pd.approvedGlobal\": \"전역 승인\",\n  \"pd.requested\": \"요청됨\",\n  \"pd.denied\": \"거부됨\",\n  \"pd.changed\": \"변경됨\",\n  \"pd.reset\": \"초기화됨\",\n  \"pd.resetToGlobal\": \"전역으로 초기화\",\n  \"pd.viewAll\": \"전체 보기\",\n  \"pd.localOnly\": \"로컬 전용\",\n  \"pd.webHidden\": \"데스크톱 전용 권한은 웹에서 숨겨집니다\",\n  \"pd.egressWebNote\": \"전체 콘텐츠 공유는 데스크톱에서만 가능합니다\",\n\n  \"approval.title\": \"권한이 필요합니다\",\n  \"approval.why\": \"왜 필요한가요?\",\n  \"approval.impact\": \"승인 시 변화\",\n  \"approval.risk\": \"잠재 위험\",\n  \"approval.scope\": \"승인 범위\",\n  \"approval.scopeOnce\": \"이번 한 번만 승인\",\n  \"approval.scopeBot\": \"이 봇에서 항상 허용\",\n  \"approval.scopeGlobal\": \"전역 허용 (모든 봇)\",\n  \"approval.approve\": \"승인\",\n  \"approval.deny\": \"거절\",\n  \"approval.approved\": \"권한이 승인되었습니다\",\n  \"approval.denied\": \"요청이 거절되었습니다\",\n  \"approval.youAreInControl\": \"통제권은 항상 당신에게 있습니다. 설정에서 언제든 변경할 수 있습니다.\",\n\n  \"pi.title\": \"권한 인텔리전스\",\n  \"pi.subtitle\": \"AI 활동 모니터링 및 위험 관리\",\n  \"pi.riskOverview\": \"위험 개요\",\n  \"pi.riskScore\": \"위험 점수\",\n  \"pi.riskLevel.low\": \"낮은 위험\",\n  \"pi.riskLevel.moderate\": \"보통\",\n  \"pi.riskLevel.elevated\": \"주의\",\n  \"pi.riskLevel.high\": \"높은 위험\",\n  \"pi.denials7d\": \"거부 (7일)\",\n  \"pi.events7d\": \"이벤트 (7일)\",\n  \"pi.noRiskData\": \"봇을 생성하면 위험 점수를 볼 수 있습니다\",\n  \"pi.timeline\": \"활동 타임라인\",\n  \"pi.timelineSub\": \"최근 7일간 권한 이벤트\",\n  \"pi.denied\": \"거부됨\",\n  \"pi.approved\": \"승인됨\",\n  \"pi.changed\": \"변경됨\",\n  \"pi.requested\": \"요청됨\",\n  \"pi.noActivity\": \"이 기간에 권한 활동이 없습니다\",\n  \"pi.totalEvents\": \"총 이벤트\",\n  \"pi.peakDay\": \"최고 일\",\n  \"pi.auditSearch\": \"이벤트 검색...\",\n  \"pi.filterEventType\": \"이벤트 유형\",\n  \"pi.filterPermKey\": \"권한\",\n  \"pi.filterDateRange\": \"기간\",\n  \"pi.allEvents\": \"모든 이벤트\",\n  \"pi.allPermissions\": \"모든 권한\",\n  \"pi.last7days\": \"최근 7일\",\n  \"pi.last30days\": \"최근 30일\",\n  \"pi.last90days\": \"최근 90일\",\n  \"pi.showingResults\": \"{{count}}개 이벤트 표시 중\",\n\n  \"dashboard.dailyReliability\": \"일일 신뢰도\",\n  \"dashboard.lastRun\": \"마지막 실행\",\n  \"dashboard.noRuns\": \"아직 실행 없음\",\n  \"dashboard.successRate7d\": \"7일 성공률\",\n  \"dashboard.avgTime\": \"평균 시간\",\n  \"dashboard.lastIssue\": \"마지막 문제\",\n  \"dashboard.noIssues\": \"없음\",\n\n  \"reports.stallNotice\": \"예상보다 오래 걸리고 있습니다\",\n  \"reports.stallDesc\": \"리포트가 아직 생성 중입니다. 잠시만 기다려주세요...\",\n  \"reports.fastDelivered\": \"빠른 브리핑이 전달되었습니다\",\n  \"reports.fullInBackground\": \"전체 분석은 백그라운드에서 계속됩니다.\",\n  \"reports.timeoutMessage\": \"빠른 브리핑이 전달되었습니다. 전체 분석은 백그라운드에서 계속됩니다.\",\n\n  \"memory.title\": \"메모리\",\n  \"memory.subtitle\": \"이 봇의 규칙과 선호 설정\",\n  \"memory.globalSubtitle\": \"전역 규칙과 선호 설정\",\n  \"memory.empty\": \"저장된 규칙이 없습니다\",\n  \"memory.emptyHint\": \"규칙을 추가하여 봇의 리포트 생성 방식을 커스터마이즈하세요\",\n  \"memory.addRule\": \"규칙 추가\",\n  \"memory.editRule\": \"규칙 수정\",\n  \"memory.deleteRule\": \"규칙 삭제\",\n  \"memory.deleteConfirm\": \"이 규칙을 삭제하시겠습니까?\",\n  \"memory.scope.global\": \"전역\",\n  \"memory.scope.bot\": \"봇\",\n  \"memory.key\": \"규칙 키\",\n  \"memory.value\": \"규칙 값\",\n  \"memory.keyPlaceholder\": \"예: REPORT_TONE, SUMMARY_LENGTH\",\n  \"memory.valuePlaceholder\": \"규칙 값을 입력하세요...\",\n  \"memory.saved\": \"규칙이 저장되었습니다\",\n  \"memory.deleted\": \"규칙이 삭제되었습니다\",\n  \"memory.saveFailed\": \"규칙 저장에 실패했습니다\",\n  \"memory.deleteFailed\": \"규칙 삭제에 실패했습니다\",\n  \"memory.globalLabel\": \"모든 봇에 적용\",\n  \"memory.botLabel\": \"이 봇에만 적용\",\n  \"memory.effectiveRules\": \"적용 규칙\",\n  \"memory.effectiveHint\": \"전역 + 봇 오버라이드 결합\",\n  \"memory.presetKeys.REPORT_TONE\": \"리포트 톤\",\n  \"memory.presetKeys.SUMMARY_LENGTH\": \"요약 길이\",\n  \"memory.presetKeys.LANGUAGE_PREF\": \"언어 선호\",\n  \"memory.presetKeys.EXCLUDE_KEYWORDS\": \"제외 키워드\",\n  \"memory.presetKeys.FOCUS_TOPICS\": \"집중 토픽\",\n  \"memory.presetKeys.CUSTOM\": \"커스텀 규칙\",\n  \"memory.ruleCount\": \"{{count}}개 규칙\",\n};\n","path":null,"size_bytes":55877,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"shared/models/auth.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { index, jsonb, pgTable, timestamp, varchar } from \"drizzle-orm/pg-core\";\n\n// Session storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)]\n);\n\n// User storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n","path":null,"size_bytes":1010,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"server/llm/client.ts":{"content":"import * as anthropicAdapter from \"./providers/anthropic\";\nimport * as openaiAdapter from \"./providers/openai\";\nimport * as googleAdapter from \"./providers/google\";\nimport * as customAdapter from \"./providers/custom\";\n\nexport interface LLMConfig {\n  providerType: string;\n  apiKey: string;\n  baseUrl?: string | null;\n  model?: string | null;\n}\n\nconst adapters: Record<string, typeof anthropicAdapter> = {\n  anthropic: anthropicAdapter,\n  openai: openaiAdapter,\n  google: googleAdapter,\n  custom: customAdapter,\n};\n\nfunction getAdapter(providerType: string) {\n  const adapter = adapters[providerType];\n  if (!adapter) throw new Error(`Unsupported LLM provider type: ${providerType}`);\n  return adapter;\n}\n\nexport async function callLLMWithConfig(\n  config: LLMConfig,\n  prompt: string,\n  maxRetries: number = 2,\n  maxTokens: number = 1200\n): Promise<string> {\n  const adapter = getAdapter(config.providerType);\n  let lastError: Error | null = null;\n\n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      return await adapter.generate(prompt, {\n        apiKey: config.apiKey,\n        baseUrl: config.baseUrl,\n        model: config.model,\n        maxTokens,\n      });\n    } catch (error) {\n      lastError = error instanceof Error ? error : new Error(String(error));\n      console.error(`LLM call attempt ${attempt + 1} failed:`, lastError.message);\n      if (attempt < maxRetries) {\n        await new Promise((resolve) => setTimeout(resolve, 1000 * (attempt + 1)));\n      }\n    }\n  }\n\n  throw lastError || new Error(\"LLM call failed after retries\");\n}\n\nexport async function callLLMWithConfigJson<T>(\n  config: LLMConfig,\n  prompt: string,\n  maxRetries: number = 2\n): Promise<T> {\n  let lastError: Error | null = null;\n\n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      const response = await callLLMWithConfig(config, prompt, 0);\n      let jsonStr = response.trim();\n      const jsonMatch = jsonStr.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n      if (jsonMatch) {\n        jsonStr = jsonMatch[1].trim();\n      }\n      const startIndex = jsonStr.indexOf(\"{\");\n      const endIndex = jsonStr.lastIndexOf(\"}\");\n      if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {\n        jsonStr = jsonStr.slice(startIndex, endIndex + 1);\n      }\n      return JSON.parse(jsonStr) as T;\n    } catch (error) {\n      lastError = error instanceof Error ? error : new Error(String(error));\n      console.error(`JSON parsing attempt ${attempt + 1} failed:`, lastError.message);\n      if (attempt < maxRetries) {\n        await new Promise((resolve) => setTimeout(resolve, 500));\n      }\n    }\n  }\n\n  throw lastError || new Error(\"JSON parsing failed after retries\");\n}\n\n// LLM은 '업그레이드 엔진' — 즉시 결과는 규칙 기반, LLM은 가치가 생기는 순간에만 호출\nexport async function callLLMWithTimeout<T>(\n  fn: () => Promise<T>,\n  timeoutMs = 20000\n): Promise<T | null> {\n  return Promise.race([\n    fn(),\n    new Promise<null>(resolve =>\n      setTimeout(() => {\n        console.warn(`[LLM] Call timed out after ${timeoutMs}ms, returning null for fallback`);\n        resolve(null);\n      }, timeoutMs)\n    ),\n  ]);\n}\n\n// ============================================\n// Legacy functions (backward compatible, used by system-level jobs)\n// These fall back to env-var LLM_API_KEY when no bot LLM is configured\n// ============================================\n\nexport function hasSystemLLMKey(): boolean {\n  return !!(process.env.LLM_API_KEY);\n}\n\nlet _userHasProviders = false;\nexport function setUserHasProviders(val: boolean) { _userHasProviders = val; }\nexport function hasAnyLLMAvailable(): boolean {\n  return hasSystemLLMKey() || _userHasProviders;\n}\n\nfunction getSystemConfig(): LLMConfig {\n  const apiKey = process.env.LLM_API_KEY || \"\";\n  if (!apiKey) throw new Error(\"LLM_API_KEY is not set. System-level AI features are unavailable. Each bot can still use its own LLM provider configured in Settings.\");\n  return {\n    providerType: \"anthropic\",\n    apiKey,\n    model: process.env.CLAUDE_MODEL || \"claude-sonnet-4-5-20250929\",\n  };\n}\n\nexport async function callLLM(prompt: string, maxRetries: number = 2, maxTokens: number = 1200): Promise<string> {\n  return callLLMWithConfig(getSystemConfig(), prompt, maxRetries, maxTokens);\n}\n\nexport async function callLLMWithJsonParsing<T>(prompt: string, maxRetries: number = 2): Promise<T> {\n  return callLLMWithConfigJson<T>(getSystemConfig(), prompt, maxRetries);\n}\n","path":null,"size_bytes":4482,"size_tokens":null},"client/src/pages/items.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { FileText, Search, Edit, CheckCircle, Send, XCircle, Clock, Filter, ExternalLink } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\ninterface Item {\n  id: number;\n  title: string;\n  url: string;\n  status: string;\n  author: string;\n  insertedAt: string;\n  sourceName: string;\n  relevanceScore?: number;\n  replyWorthinessScore?: number;\n}\n\nconst statusIcons: Record<string, React.ReactNode> = {\n  new: <Clock className=\"h-3 w-3\" />,\n  analyzed: <Search className=\"h-3 w-3\" />,\n  drafted: <Edit className=\"h-3 w-3\" />,\n  approved: <CheckCircle className=\"h-3 w-3\" />,\n  posted: <Send className=\"h-3 w-3\" />,\n  skipped: <XCircle className=\"h-3 w-3\" />,\n};\n\nconst statusColors: Record<string, string> = {\n  new: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  analyzed: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\",\n  drafted: \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n  approved: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  posted: \"bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200\",\n  skipped: \"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200\",\n};\n\nexport default function Items() {\n  const { t } = useLanguage();\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const itemsUrl = statusFilter === \"all\" \n    ? \"/api/items\" \n    : `/api/items?status=${statusFilter}`;\n  \n  const { data: items, isLoading } = useQuery<Item[]>({\n    queryKey: [itemsUrl],\n  });\n\n  const filteredItems = items?.filter((item) => {\n    if (searchQuery) {\n      const query = searchQuery.toLowerCase();\n      return (\n        item.title?.toLowerCase().includes(query) ||\n        item.author?.toLowerCase().includes(query)\n      );\n    }\n    return true;\n  });\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-items-title\">{t(\"items.title\")}</h1>\n        <p className=\"text-muted-foreground\">{t(\"items.subtitle\")}</p>\n      </div>\n\n      <div className=\"flex flex-col sm:flex-row gap-3\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder={t(\"items.searchPlaceholder\")}\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-items\"\n          />\n        </div>\n        <Select value={statusFilter} onValueChange={setStatusFilter}>\n          <SelectTrigger className=\"w-full sm:w-[180px]\" data-testid=\"select-status-filter\">\n            <Filter className=\"h-4 w-4 mr-2\" />\n            <SelectValue placeholder={t(\"items.filterStatus\")} />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">{t(\"items.allStatus\")}</SelectItem>\n            <SelectItem value=\"new\">{t(\"items.status.new\")}</SelectItem>\n            <SelectItem value=\"analyzed\">{t(\"items.status.analyzed\")}</SelectItem>\n            <SelectItem value=\"drafted\">{t(\"items.status.drafted\")}</SelectItem>\n            <SelectItem value=\"approved\">{t(\"items.status.approved\")}</SelectItem>\n            <SelectItem value=\"posted\">{t(\"items.status.posted\")}</SelectItem>\n            <SelectItem value=\"skipped\">{t(\"items.status.skipped\")}</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <FileText className=\"h-5 w-5\" />\n            {t(\"items.count\", { count: String(filteredItems?.length ?? 0) })}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <Skeleton key={i} className=\"h-20 w-full\" />\n              ))}\n            </div>\n          ) : filteredItems && filteredItems.length > 0 ? (\n            <div className=\"space-y-2\">\n              {filteredItems.map((item) => (\n                <Link key={item.id} href={`/items/${item.id}`}>\n                  <div\n                    className=\"p-4 rounded-md border hover:border-primary/50 hover-elevate cursor-pointer transition-colors\"\n                    data-testid={`card-item-${item.id}`}\n                  >\n                    <div className=\"flex items-start justify-between gap-4\">\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-medium text-sm line-clamp-2\">{item.title || t(\"common.untitled\")}</h3>\n                        <div className=\"flex flex-wrap items-center gap-x-3 gap-y-1 mt-2 text-xs text-muted-foreground\">\n                          <span>{item.sourceName}</span>\n                          {item.author && <span>{t(\"items.by\", { author: item.author })}</span>}\n                          <span>{format(new Date(item.insertedAt), \"MMM d, yyyy HH:mm\")}</span>\n                        </div>\n                        {(item.relevanceScore !== undefined || item.replyWorthinessScore !== undefined) && (\n                          <div className=\"flex items-center gap-2 mt-2\">\n                            {item.relevanceScore !== undefined && (\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {t(\"items.relevance\", { score: String(item.relevanceScore) })}\n                              </Badge>\n                            )}\n                            {item.replyWorthinessScore !== undefined && (\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {t(\"items.replyScore\", { score: String(item.replyWorthinessScore) })}\n                              </Badge>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"flex flex-col items-end gap-2\">\n                        <Badge className={`${statusColors[item.status]} flex items-center gap-1 text-xs`}>\n                          {statusIcons[item.status]}\n                          {t(`common.status.${item.status}`)}\n                        </Badge>\n                        <a\n                          href={item.url}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          onClick={(e) => e.stopPropagation()}\n                          className=\"text-muted-foreground hover:text-foreground\"\n                        >\n                          <ExternalLink className=\"h-4 w-4\" />\n                        </a>\n                      </div>\n                    </div>\n                  </div>\n                </Link>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <FileText className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg font-medium\">{t(\"items.noItems\")}</p>\n              <p className=\"text-sm mt-1\">\n                {statusFilter !== \"all\"\n                  ? t(\"items.noItemsFilter\")\n                  : t(\"items.noItemsDefault\")}\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":7971,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/pages/guide.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Rocket, Settings, Bot, Rss, MessageSquare, FileText, ChevronDown, Zap, Brain } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\nfunction FAQAccordionItem({ q, a, index }: { q: string; a: string; index: number }) {\n  const [open, setOpen] = useState(false);\n  return (\n    <div className=\"border-b border-border last:border-b-0\">\n      <button\n        className=\"w-full flex items-center justify-between gap-4 py-4 text-left\"\n        onClick={() => setOpen(!open)}\n        data-testid={`button-guide-faq-${index}`}\n      >\n        <span className=\"font-medium text-sm\" data-testid={`text-guide-faq-q-${index}`}>{q}</span>\n        <ChevronDown className={`h-4 w-4 shrink-0 text-muted-foreground transition-transform ${open ? \"rotate-180\" : \"\"}`} />\n      </button>\n      <div\n        className={`overflow-hidden transition-all ${open ? \"max-h-40 pb-4\" : \"max-h-0\"}`}\n      >\n        <p className=\"text-sm text-muted-foreground leading-relaxed\" data-testid={`text-guide-faq-a-${index}`}>{a}</p>\n      </div>\n    </div>\n  );\n}\n\nexport default function Guide() {\n  const { t } = useLanguage();\n\n  const stepIcons = [Rocket, Settings, Bot, Rss, MessageSquare, FileText];\n\n  const steps = [\n    {\n      number: \"1\",\n      icon: stepIcons[0],\n      title: t(\"guide.step1.title\"),\n      content: (\n        <div className=\"space-y-2 text-sm text-muted-foreground leading-relaxed\">\n          <p>{t(\"guide.step1.p1\")}</p>\n          <p>{t(\"guide.step1.p2\")}</p>\n        </div>\n      ),\n    },\n    {\n      number: \"2\",\n      icon: stepIcons[1],\n      title: t(\"guide.step2.title\"),\n      subtitle: t(\"guide.step2.subtitle\"),\n      content: (\n        <div className=\"space-y-3 text-sm text-muted-foreground leading-relaxed\">\n          <p>{t(\"guide.step2.p1\")}</p>\n          <ol className=\"list-decimal list-inside space-y-1 pl-1\">\n            <li dangerouslySetInnerHTML={{ __html: t(\"guide.step2.li1\") }} />\n            <li dangerouslySetInnerHTML={{ __html: t(\"guide.step2.li2\") }} />\n            <li>{t(\"guide.step2.li3\")}</li>\n          </ol>\n          <div className=\"rounded-md bg-muted/50 p-3 space-y-1 text-xs\">\n            <p><strong className=\"text-foreground\">{t(\"guide.step2.fieldName\")}</strong> {t(\"guide.step2.fieldNameEx\")}</p>\n            <p><strong className=\"text-foreground\">{t(\"guide.step2.fieldType\")}</strong> {t(\"guide.step2.fieldTypeEx\")}</p>\n            <p><strong className=\"text-foreground\">{t(\"guide.step2.fieldKey\")}</strong> {t(\"guide.step2.fieldKeyEx\")}</p>\n            <p><strong className=\"text-foreground\">{t(\"guide.step2.fieldUrl\")}</strong> {t(\"guide.step2.fieldUrlEx\")}</p>\n            <p><strong className=\"text-foreground\">{t(\"guide.step2.fieldModel\")}</strong> {t(\"guide.step2.fieldModelEx\")}</p>\n          </div>\n          <p>{t(\"guide.step2.done\")}</p>\n        </div>\n      ),\n    },\n    {\n      number: \"3\",\n      icon: stepIcons[2],\n      title: t(\"guide.step3.title\"),\n      content: (\n        <div className=\"space-y-3 text-sm text-muted-foreground leading-relaxed\">\n          <ol className=\"list-decimal list-inside space-y-1 pl-1\">\n            <li dangerouslySetInnerHTML={{ __html: t(\"guide.step3.li1\") }} />\n            <li dangerouslySetInnerHTML={{ __html: t(\"guide.step3.li2\") }} />\n            <li>{t(\"guide.step3.li3\")}</li>\n            <li>{t(\"guide.step3.li4\")}</li>\n          </ol>\n          <div className=\"rounded-md bg-muted/50 p-3 text-xs space-y-1\">\n            <p>{t(\"guide.step3.hint1\")}</p>\n            <p>{t(\"guide.step3.hint2\")}</p>\n          </div>\n        </div>\n      ),\n    },\n    {\n      number: \"4\",\n      icon: stepIcons[3],\n      title: t(\"guide.step4.title\"),\n      content: (\n        <div className=\"space-y-3 text-sm text-muted-foreground leading-relaxed\">\n          <p>{t(\"guide.step4.p1\")}</p>\n          <ol className=\"list-decimal list-inside space-y-1 pl-1\">\n            <li dangerouslySetInnerHTML={{ __html: t(\"guide.step4.li1\") }} />\n            <li>{t(\"guide.step4.li2\")}</li>\n            <li>{t(\"guide.step4.li3\")}</li>\n          </ol>\n          <div className=\"rounded-md bg-muted/50 p-3 text-xs space-y-1\">\n            <p>{t(\"guide.step4.hint1\")}</p>\n            <p>{t(\"guide.step4.hint2\")}</p>\n          </div>\n        </div>\n      ),\n    },\n    {\n      number: \"5\",\n      icon: stepIcons[4],\n      title: t(\"guide.step5.title\"),\n      content: (\n        <div className=\"space-y-3 text-sm text-muted-foreground leading-relaxed\">\n          <p dangerouslySetInnerHTML={{ __html: t(\"guide.step5.p1\") }} />\n          <p>{t(\"guide.step5.p2\")}</p>\n          <div className=\"rounded-md bg-muted/50 p-3 text-xs space-y-1\">\n            <p>{t(\"guide.step5.cmd1\")}</p>\n            <p>{t(\"guide.step5.cmd2\")}</p>\n            <p>{t(\"guide.step5.cmd3\")}</p>\n          </div>\n          <p dangerouslySetInnerHTML={{ __html: t(\"guide.step5.p3\") }} />\n        </div>\n      ),\n    },\n    {\n      number: \"6\",\n      icon: stepIcons[5],\n      title: t(\"guide.step6.title\"),\n      content: (\n        <div className=\"space-y-3 text-sm text-muted-foreground leading-relaxed\">\n          <ol className=\"list-decimal list-inside space-y-1 pl-1\">\n            <li dangerouslySetInnerHTML={{ __html: t(\"guide.step6.li1\") }} />\n            <li>{t(\"guide.step6.li2\")}</li>\n            <li>{t(\"guide.step6.li3\")}</li>\n            <li>{t(\"guide.step6.li4\")}</li>\n          </ol>\n          <div className=\"rounded-md bg-muted/50 p-3 text-xs\">\n            <p>{t(\"guide.step6.hint\")}</p>\n          </div>\n        </div>\n      ),\n    },\n  ];\n\n  const faqItems = [\n    { q: t(\"guide.faq.q1\"), a: t(\"guide.faq.a1\") },\n    { q: t(\"guide.faq.q2\"), a: t(\"guide.faq.a2\") },\n    { q: t(\"guide.faq.q3\"), a: t(\"guide.faq.a3\") },\n    { q: t(\"guide.faq.q4\"), a: t(\"guide.faq.a4\") },\n    { q: t(\"guide.faq.q5\"), a: t(\"guide.faq.a5\") },\n  ];\n\n  return (\n    <div className=\"p-6 max-w-3xl mx-auto space-y-8\">\n      <div className=\"space-y-2\">\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-guide-title\">{t(\"guide.title\")}</h1>\n        <p className=\"text-muted-foreground text-sm\" data-testid=\"text-guide-intro\">\n          {t(\"guide.intro\")}\n        </p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-lg\">\n            <Zap className=\"h-5 w-5 text-primary\" />\n            <span data-testid=\"text-guide-capabilities\">{t(\"guide.capabilities\")}</span>\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ul className=\"list-disc list-inside space-y-2 text-sm text-muted-foreground\">\n            <li>{t(\"guide.capability1\")}</li>\n            <li>{t(\"guide.capability2\")}</li>\n            <li>{t(\"guide.capability3\")}</li>\n            <li>{t(\"guide.capability4\")}</li>\n            <li>{t(\"guide.capability5\")}</li>\n          </ul>\n          <div className=\"mt-4 rounded-md bg-muted/50 p-3 text-sm text-foreground\" data-testid=\"text-guide-core\">\n            <strong>{t(\"guide.corePoint\")}</strong> {t(\"guide.coreDesc\")}\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"space-y-3\">\n        <h2 className=\"text-lg font-semibold\" data-testid=\"text-guide-steps-heading\">\n          {t(\"guide.stepsHeading\")}\n        </h2>\n        <div className=\"space-y-3\">\n          {steps.map((step) => (\n            <Card key={step.number} data-testid={`card-guide-step-${step.number}`}>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"flex items-center justify-center w-8 h-8 rounded-md bg-primary text-primary-foreground font-bold text-sm shrink-0\">\n                    {step.number}\n                  </div>\n                  <div className=\"flex-1 space-y-2\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <step.icon className=\"h-4 w-4 text-primary\" />\n                      <h3 className=\"font-semibold text-sm\">{step.title}</h3>\n                      {step.subtitle && (\n                        <span className=\"text-xs text-muted-foreground\">({step.subtitle})</span>\n                      )}\n                    </div>\n                    {step.content}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"space-y-3\">\n        <h2 className=\"text-lg font-semibold\" data-testid=\"text-guide-faq\">{t(\"guide.faq.title\")}</h2>\n        <Card>\n          <CardContent className=\"p-4\">\n            {faqItems.map((item, i) => (\n              <FAQAccordionItem key={i} q={item.q} a={item.a} index={i} />\n            ))}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardContent className=\"p-6 text-center space-y-3\">\n          <Brain className=\"h-8 w-8 text-primary mx-auto\" />\n          <p className=\"text-sm font-semibold text-foreground\" data-testid=\"text-guide-philosophy\">{t(\"guide.philosophy\")}</p>\n          <p className=\"text-xs text-muted-foreground\">\n            {t(\"guide.philosophyDesc\")}\n          </p>\n          <div className=\"flex justify-center gap-3 pt-2 flex-wrap\">\n            <Button asChild size=\"sm\" data-testid=\"button-guide-settings\">\n              <Link href=\"/settings\">{t(\"guide.settingsButton\")}</Link>\n            </Button>\n            <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-guide-bots\">\n              <Link href=\"/bots\">{t(\"guide.botsButton\")}</Link>\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"text-center text-xs text-muted-foreground pb-4\">\n        <p>maker.am</p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9843,"size_tokens":null},"server/replit_integrations/auth/storage.ts":{"content":"import { users as pgUsers, type User, type UpsertUser } from \"@shared/models/auth\";\nimport { users as sqliteUsers } from \"../../../shared/schema.sqlite\";\nimport { db, driver } from \"../../db\";\nimport { eq } from \"drizzle-orm\";\n\nexport interface IAuthStorage {\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n}\n\nconst users = driver === \"sqlite\" ? sqliteUsers : pgUsers;\n\nclass AuthStorage implements IAuthStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user as User | undefined;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    if (driver === \"sqlite\") {\n      const existing = await this.getUser(userData.id!);\n      if (existing) {\n        await db\n          .update(sqliteUsers)\n          .set({\n            email: userData.email,\n            firstName: userData.firstName,\n            lastName: userData.lastName,\n            profileImageUrl: userData.profileImageUrl,\n            updatedAt: new Date(),\n          })\n          .where(eq(sqliteUsers.id, userData.id!));\n        const [updated] = await db.select().from(sqliteUsers).where(eq(sqliteUsers.id, userData.id!));\n        return updated as unknown as User;\n      } else {\n        await db.insert(sqliteUsers).values({\n          id: userData.id!,\n          email: userData.email,\n          firstName: userData.firstName,\n          lastName: userData.lastName,\n          profileImageUrl: userData.profileImageUrl,\n          createdAt: new Date(),\n          updatedAt: new Date(),\n        });\n        const [created] = await db.select().from(sqliteUsers).where(eq(sqliteUsers.id, userData.id!));\n        return created as unknown as User;\n      }\n    }\n\n    const [user] = await db\n      .insert(pgUsers)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: pgUsers.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n}\n\nexport const authStorage = new AuthStorage();\n","path":null,"size_bytes":2096,"size_tokens":null},"client/src/pages/observe.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Link } from \"wouter\";\nimport { ExternalLink, TrendingUp, Eye, ArrowRight } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\ninterface ObserveItem {\n  id: number;\n  title: string;\n  url: string;\n  sourceName: string;\n  status: string;\n  publishedAt: string;\n  relevanceScore: number;\n  replyWorthinessScore: number;\n  category: string;\n  summaryShort: string;\n}\n\nexport default function Observe() {\n  const { t } = useLanguage();\n  const { data: items, isLoading } = useQuery<ObserveItem[]>({\n    queryKey: [\"/api/items/observe\"],\n  });\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold flex items-center gap-2\" data-testid=\"text-observe-title\">\n          <Eye className=\"h-6 w-6\" />\n          {t(\"observe.title\")}\n        </h1>\n        <p className=\"text-muted-foreground\">\n          {t(\"observe.subtitle\")}\n        </p>\n      </div>\n\n      {isLoading ? (\n        <div className=\"space-y-4\">\n          {[...Array(5)].map((_, i) => (\n            <Skeleton key={i} className=\"h-32 w-full\" />\n          ))}\n        </div>\n      ) : !items?.length ? (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <Eye className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <h3 className=\"text-lg font-medium\">{t(\"observe.noItems\")}</h3>\n            <p className=\"text-muted-foreground mt-1\">\n              {t(\"observe.noItemsHint\")}\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-4\">\n          {items.map((item) => (\n            <Card key={item.id} className=\"hover-elevate\" data-testid={`card-observe-${item.id}`}>\n              <CardHeader className=\"pb-2\">\n                <div className=\"flex items-start justify-between gap-4\">\n                  <div className=\"flex-1 min-w-0\">\n                    <CardTitle className=\"text-base line-clamp-2\">\n                      {item.title}\n                    </CardTitle>\n                    <CardDescription className=\"flex items-center gap-2 mt-1\">\n                      <span>{item.sourceName}</span>\n                      <span>•</span>\n                      <span>{format(new Date(item.publishedAt), \"MMM d, HH:mm\")}</span>\n                    </CardDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge variant=\"outline\" className=\"whitespace-nowrap\">\n                      {item.category}\n                    </Badge>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                  {item.summaryShort}\n                </p>\n                \n                <div className=\"flex items-center gap-4\">\n                  <div className=\"flex items-center gap-1 text-sm\">\n                    <TrendingUp className=\"h-4 w-4 text-green-500\" />\n                    <span className=\"font-medium\">{t(\"observe.relevance\")} {item.relevanceScore}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                    <span>{t(\"observe.reply\")} {item.replyWorthinessScore}</span>\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-2\">\n                  <Button variant=\"outline\" size=\"sm\" asChild data-testid={`button-view-original-${item.id}`}>\n                    <a href={item.url} target=\"_blank\" rel=\"noopener noreferrer\">\n                      <ExternalLink className=\"h-3 w-3 mr-1\" />\n                      {t(\"observe.viewOriginal\")}\n                    </a>\n                  </Button>\n                  <Button variant=\"ghost\" size=\"sm\" asChild data-testid={`button-details-${item.id}`}>\n                    <Link href={`/items/${item.id}`}>\n                      <ArrowRight className=\"h-3 w-3 mr-1\" />\n                      {t(\"observe.details\")}\n                    </Link>\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4543,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/hooks/use-auth.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/models/auth\";\n\nasync function fetchUser(): Promise<User | null> {\n  const response = await fetch(\"/api/auth/user\", {\n    credentials: \"include\",\n  });\n\n  if (response.status === 401) {\n    return null;\n  }\n\n  if (!response.ok) {\n    throw new Error(`${response.status}: ${response.statusText}`);\n  }\n\n  return response.json();\n}\n\nasync function logout(): Promise<void> {\n  window.location.href = \"/api/logout\";\n}\n\nexport function useAuth() {\n  const queryClient = useQueryClient();\n  const { data: user, isLoading } = useQuery<User | null>({\n    queryKey: [\"/api/auth/user\"],\n    queryFn: fetchUser,\n    retry: false,\n    staleTime: 1000 * 60 * 5, // 5 minutes\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: logout,\n    onSuccess: () => {\n      queryClient.setQueryData([\"/api/auth/user\"], null);\n    },\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n    logout: logoutMutation.mutate,\n    isLoggingOut: logoutMutation.isPending,\n  };\n}\n","path":null,"size_bytes":1091,"size_tokens":null},"client/src/lib/auth-utils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n\n// Redirect to login with a toast notification\nexport function redirectToLogin(toast?: (options: { title: string; description: string; variant: string }) => void) {\n  if (toast) {\n    toast({\n      title: \"Unauthorized\",\n      description: \"You are logged out. Logging in again...\",\n      variant: \"destructive\",\n    });\n  }\n  setTimeout(() => {\n    window.location.href = \"/api/login\";\n  }, 500);\n}\n","path":null,"size_bytes":517,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport {\n  FileText, Search, Edit, CheckCircle, Send, XCircle, Clock, RefreshCw,\n  Activity, AlertTriangle, Zap, Bot as BotIcon, ArrowRight, Settings,\n  Newspaper, Eye, Scale, GraduationCap, ShoppingBag, MessageSquare, TrendingUp, Users, Sparkles,\n  Layers, Rss, FileBarChart, Briefcase, BookOpen, Building2, Key, CircleDot, PenTool, Laptop, Store, ShoppingCart\n} from \"lucide-react\";\nimport { formatDistanceToNow, format } from \"date-fns\";\nimport { Link, useLocation } from \"wouter\";\n\ninterface DashboardStats {\n  total: number;\n  new: number;\n  analyzed: number;\n  drafted: number;\n  approved: number;\n  posted: number;\n  skipped: number;\n  lastCollectAt: string | null;\n  lastAnalyzeAt: string | null;\n}\n\ninterface RecentItem {\n  id: number;\n  title: string;\n  url: string;\n  status: string;\n  insertedAt: string;\n  sourceName: string;\n}\n\ninterface SchedulerStatus {\n  isRunning: boolean;\n  systemLLMAvailable: boolean;\n  collectInterval: string;\n  analyzeInterval: string;\n  draftInterval: string;\n  reportInterval: string;\n  dailyBriefSchedule: string;\n  lastCollect: string | null;\n  lastAnalyze: string | null;\n  lastDraft: string | null;\n  lastDailyBrief: string | null;\n  lastReportRun: string | null;\n}\n\ninterface BotSettings {\n  id: number;\n  botId: number;\n  timezone: string;\n  scheduleRule: string;\n  scheduleTimeLocal: string;\n  format: string;\n  markdownLevel: string;\n  verbosity: string;\n  sectionsJson: Record<string, boolean>;\n  filtersJson: Record<string, number>;\n}\n\ninterface BotData {\n  id: number;\n  userId: string;\n  key: string;\n  name: string;\n  isEnabled: boolean;\n  createdAt: string;\n  settings: BotSettings | null;\n}\n\ninterface PresetConfig {\n  suggestedSources?: { name: string; url: string; topic: string }[];\n}\n\ninterface Preset {\n  id: number;\n  key: string;\n  name: string;\n  outputType: string;\n  description: string | null;\n  variantsJson: string[];\n  defaultConfigJson: PresetConfig;\n  icon: string | null;\n  category: string | null;\n}\n\nconst iconMap: Record<string, typeof Newspaper> = {\n  Newspaper, Eye, Scale, GraduationCap, ShoppingBag, MessageSquare, TrendingUp, Users, Search, Briefcase, BookOpen, Building2, PenTool, Laptop, Store, ShoppingCart,\n};\n\nconst topicColors: Record<string, string> = {\n  investing: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  ai_art: \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n  tech: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  crypto: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\",\n  creative: \"bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200\",\n  community_research: \"bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200\",\n  market_brief: \"bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200\",\n  research_watch: \"bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200\",\n  competitor_watch: \"bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200\",\n  content_research: \"bg-violet-100 text-violet-800 dark:bg-violet-900 dark:text-violet-200\",\n  work_productivity: \"bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200\",\n  online_business: \"bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200\",\n  korea_marketplace: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n};\n\nconst statusIcons: Record<string, React.ReactNode> = {\n  new: <Clock className=\"h-3.5 w-3.5\" />,\n  analyzed: <Search className=\"h-3.5 w-3.5\" />,\n  drafted: <Edit className=\"h-3.5 w-3.5\" />,\n  approved: <CheckCircle className=\"h-3.5 w-3.5\" />,\n  posted: <Send className=\"h-3.5 w-3.5\" />,\n  skipped: <XCircle className=\"h-3.5 w-3.5\" />,\n};\n\nconst statusColors: Record<string, string> = {\n  new: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  analyzed: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\",\n  drafted: \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n  approved: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  posted: \"bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200\",\n  skipped: \"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200\",\n};\n\ninterface DiagBotResult {\n  botId: number;\n  botName: string;\n  botKey: string;\n  health: \"healthy\" | \"warning\" | \"error\";\n  items: { rule: string; severity: \"error\" | \"warning\" | \"info\"; messageEn: string; messageKo: string }[];\n}\n\nexport default function Dashboard() {\n  const { t, language } = useLanguage();\n  const [, setLocation] = useLocation();\n\n  const { data: stats, isLoading: statsLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/stats\"],\n  });\n\n  const { data: recentItems, isLoading: itemsLoading } = useQuery<RecentItem[]>({\n    queryKey: [\"/api/items/recent\"],\n  });\n\n  const { data: schedulerStatus } = useQuery<SchedulerStatus>({\n    queryKey: [\"/api/scheduler/status\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: botsResponse, isLoading: botsLoading } = useQuery<{ bots: BotData[] }>({\n    queryKey: [\"/api/bots\"],\n  });\n  const botsList = botsResponse?.bots ?? [];\n\n  const { data: presets = [] } = useQuery<Preset[]>({\n    queryKey: [\"/api/presets\"],\n  });\n\n  const { data: providersResponse } = useQuery<{ providers: { id: number }[] }>({\n    queryKey: [\"/api/llm-providers\"],\n    queryFn: () => fetch(\"/api/llm-providers\", { credentials: \"include\" }).then(r => r.json()),\n  });\n  const { data: diagResults } = useQuery<DiagBotResult[]>({\n    queryKey: [\"/api/diagnostics\"],\n    refetchInterval: 60000,\n    enabled: botsList.length > 0,\n  });\n\n  const { data: dailyLoop } = useQuery<{\n    lastRunAt: string | null;\n    successRate7d: number;\n    avgGenerationTimeMs: number;\n    lastFailureReason: string | null;\n    totalRuns7d: number;\n  }>({\n    queryKey: [\"/api/diagnostics/daily-loop\"],\n    refetchInterval: 60000,\n  });\n\n  const hasProviders = (providersResponse?.providers?.length ?? 0) > 0;\n  const isNewUser = botsList.length === 0;\n\n  const featuredPresets = presets.slice(0, 4);\n\n  const getPresetIcon = (iconName: string | null) => {\n    const IconComponent = iconName ? iconMap[iconName] : Sparkles;\n    return IconComponent || Sparkles;\n  };\n\n  const statCards = [\n    { label: t(\"dashboard.stats.totalItems\"), value: stats?.total ?? 0, icon: FileText, color: \"text-foreground\" },\n    { label: t(\"dashboard.stats.new\"), value: stats?.new ?? 0, icon: Clock, color: \"text-blue-500\" },\n    { label: t(\"dashboard.stats.analyzed\"), value: stats?.analyzed ?? 0, icon: Search, color: \"text-yellow-500\" },\n    { label: t(\"dashboard.stats.drafted\"), value: stats?.drafted ?? 0, icon: Edit, color: \"text-purple-500\" },\n    { label: t(\"dashboard.stats.approved\"), value: stats?.approved ?? 0, icon: CheckCircle, color: \"text-green-500\" },\n    { label: t(\"dashboard.stats.posted\"), value: stats?.posted ?? 0, icon: Send, color: \"text-emerald-500\" },\n    { label: t(\"dashboard.stats.skipped\"), value: stats?.skipped ?? 0, icon: XCircle, color: \"text-gray-500\" },\n  ];\n\n  return (\n    <div className=\"p-6 space-y-8 max-w-6xl mx-auto\">\n      <div className=\"space-y-2\" data-testid=\"section-hero\">\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-dashboard-title\">{t(\"dashboard.title\")}</h1>\n        <p className=\"text-muted-foreground max-w-2xl\" data-testid=\"text-hero-message\">\n          {t(\"dashboard.subtitle\")}\n        </p>\n      </div>\n\n      {schedulerStatus && !schedulerStatus.systemLLMAvailable && (\n        <Card className=\"border-amber-300 dark:border-amber-700\" data-testid=\"card-system-warning\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-start gap-3\">\n              <AlertTriangle className=\"h-5 w-5 text-amber-500 shrink-0 mt-0.5\" />\n              <div>\n                <p className=\"font-medium text-sm\" data-testid=\"text-llm-warning\">{t(\"dashboard.systemWarning.title\")}</p>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {t(\"dashboard.systemWarning.desc\")}\n                </p>\n                <p className=\"text-sm mt-2\">\n                  <Link href=\"/settings\" className=\"text-primary hover:underline\" data-testid=\"link-add-provider\">\n                    {t(\"dashboard.systemWarning.link\")}\n                  </Link>\n                  {t(\"dashboard.systemWarning.linkSuffix\")}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {dailyLoop && (\n        <Card data-testid=\"card-daily-reliability\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              <Activity className=\"h-4 w-4 text-primary\" />\n              <span className=\"font-semibold text-sm\">{t(\"dashboard.dailyReliability\")}</span>\n            </div>\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              <div data-testid=\"text-last-run\">\n                <p className=\"text-xs text-muted-foreground\">{t(\"dashboard.lastRun\")}</p>\n                <p className=\"text-sm font-medium\">\n                  {dailyLoop.lastRunAt\n                    ? formatDistanceToNow(new Date(dailyLoop.lastRunAt), { addSuffix: true })\n                    : t(\"dashboard.noRuns\")}\n                </p>\n              </div>\n              <div data-testid=\"text-success-rate\">\n                <p className=\"text-xs text-muted-foreground\">{t(\"dashboard.successRate7d\")}</p>\n                <p className={`text-sm font-medium ${dailyLoop.successRate7d >= 90 ? \"text-green-600 dark:text-green-400\" : dailyLoop.successRate7d >= 70 ? \"text-yellow-600 dark:text-yellow-400\" : \"text-red-600 dark:text-red-400\"}`}>\n                  {dailyLoop.successRate7d}%\n                </p>\n              </div>\n              <div data-testid=\"text-avg-time\">\n                <p className=\"text-xs text-muted-foreground\">{t(\"dashboard.avgTime\")}</p>\n                <p className=\"text-sm font-medium\">\n                  {dailyLoop.avgGenerationTimeMs > 0\n                    ? `${(dailyLoop.avgGenerationTimeMs / 1000).toFixed(1)}s`\n                    : \"-\"}\n                </p>\n              </div>\n              <div data-testid=\"text-last-issue\">\n                <p className=\"text-xs text-muted-foreground\">{t(\"dashboard.lastIssue\")}</p>\n                <p className=\"text-sm font-medium truncate\">\n                  {dailyLoop.lastFailureReason || t(\"dashboard.noIssues\")}\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {isNewUser && (\n        <Card data-testid=\"card-onboarding\">\n          <CardContent className=\"p-6\">\n            <h2 className=\"text-lg font-semibold mb-2\">{t(\"dashboard.onboarding.title\")}</h2>\n            <p className=\"text-sm text-muted-foreground mb-6\">\n              {t(\"dashboard.onboarding.subtitle\")}\n            </p>\n            <div className=\"grid gap-4 md:grid-cols-3\">\n              <div className=\"flex gap-3\">\n                <div className={`shrink-0 flex items-center justify-center h-9 w-9 rounded-md ${hasProviders ? 'bg-green-100 dark:bg-green-900' : 'bg-primary/10'}`}>\n                  <Key className={`h-5 w-5 ${hasProviders ? 'text-green-600 dark:text-green-400' : 'text-primary'}`} />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <h3 className=\"font-medium text-sm\">{t(\"dashboard.onboarding.step1\")}</h3>\n                    {hasProviders && (\n                      <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\">\n                        <CheckCircle className=\"h-3 w-3 mr-1\" />\n                        {t(\"dashboard.onboarding.step1Done\")}\n                      </Badge>\n                    )}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {t(\"dashboard.onboarding.step1Desc\")}\n                  </p>\n                  {!hasProviders && (\n                    <Link href=\"/settings\">\n                      <Button variant=\"outline\" size=\"sm\" className=\"mt-2\" data-testid=\"button-onboarding-provider\">\n                        {t(\"dashboard.onboarding.step1Button\")}\n                        <ArrowRight className=\"h-3 w-3 ml-1\" />\n                      </Button>\n                    </Link>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"flex gap-3\">\n                <div className=\"shrink-0 flex items-center justify-center h-9 w-9 rounded-md bg-primary/10\">\n                  <Layers className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <h3 className=\"font-medium text-sm\">{t(\"dashboard.onboarding.step2\")}</h3>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {t(\"dashboard.onboarding.step2Desc\")}\n                  </p>\n                  <Link href=\"/bots\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-2\" data-testid=\"button-onboarding-create-bot\">\n                      {t(\"dashboard.onboarding.step2Button\")}\n                      <ArrowRight className=\"h-3 w-3 ml-1\" />\n                    </Button>\n                  </Link>\n                </div>\n              </div>\n\n              <div className=\"flex gap-3\">\n                <div className=\"shrink-0 flex items-center justify-center h-9 w-9 rounded-md bg-primary/10\">\n                  <FileBarChart className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <h3 className=\"font-medium text-sm\">{t(\"dashboard.onboarding.step3\")}</h3>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {t(\"dashboard.onboarding.step3Desc\")}\n                  </p>\n                  <Link href=\"/reports\">\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-2\" data-testid=\"button-onboarding-reports\">\n                      {t(\"dashboard.onboarding.step3Button\")}\n                      <ArrowRight className=\"h-3 w-3 ml-1\" />\n                    </Button>\n                  </Link>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <div data-testid=\"section-start-template\">\n        <div className=\"flex items-center justify-between gap-4 mb-4 flex-wrap\">\n          <div>\n            <h2 className=\"text-lg font-semibold flex items-center gap-2\">\n              <Layers className=\"h-5 w-5 text-primary\" />\n              {t(\"dashboard.startWorkflow.title\")}\n            </h2>\n            <p className=\"text-sm text-muted-foreground\">\n              {t(\"dashboard.startWorkflow.subtitle\")}\n            </p>\n          </div>\n          <Link href=\"/bots\">\n            <Button variant=\"outline\" size=\"sm\" data-testid=\"link-view-all-templates\">\n              {t(\"dashboard.startWorkflow.viewAll\")}\n              <ArrowRight className=\"h-4 w-4 ml-1\" />\n            </Button>\n          </Link>\n        </div>\n\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          {featuredPresets.map((preset) => {\n            const Icon = getPresetIcon(preset.icon);\n            return (\n              <Card\n                key={preset.id}\n                className=\"overflow-visible hover-elevate cursor-pointer\"\n                onClick={() => setLocation(\"/bots\")}\n                data-testid={`card-template-${preset.key}`}\n              >\n                <CardContent className=\"p-4 space-y-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 rounded-md bg-primary/10 shrink-0\">\n                      <Icon className=\"h-5 w-5 text-primary\" />\n                    </div>\n                    <h3 className=\"font-medium text-sm\" data-testid={`text-template-name-${preset.key}`}>{preset.name}</h3>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground line-clamp-2\">{preset.description}</p>\n                  <div className=\"pt-1\">\n                    <span className=\"text-xs text-primary font-medium\" data-testid={`link-template-start-${preset.key}`}>\n                      {t(\"dashboard.startWorkflow.startWith\")} &rarr;\n                    </span>\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      </div>\n\n      {botsList.length > 0 && (\n        <div data-testid=\"section-my-bots\">\n          <div className=\"flex items-center justify-between gap-4 mb-4 flex-wrap\">\n            <div>\n              <h2 className=\"text-lg font-semibold flex items-center gap-2\">\n                <BotIcon className=\"h-5 w-5 text-primary\" />\n                {t(\"dashboard.myBots.title\")}\n              </h2>\n              <p className=\"text-sm text-muted-foreground\">\n                {t(\"dashboard.myBots.subtitle\")}\n              </p>\n            </div>\n            <Link href=\"/bots\">\n              <Button variant=\"outline\" size=\"sm\" data-testid=\"link-manage-bots\">\n                {t(\"dashboard.myBots.manageAll\")}\n                <ArrowRight className=\"h-4 w-4 ml-1\" />\n              </Button>\n            </Link>\n          </div>\n\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            {botsList.slice(0, 6).map((bot) => (\n              <Card key={bot.id} className=\"overflow-visible\" data-testid={`card-bot-${bot.id}`}>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-start justify-between gap-3 mb-3\">\n                    <div className=\"flex-1 min-w-0\">\n                      <h3 className=\"font-medium truncate\" data-testid={`text-bot-name-${bot.id}`}>{bot.name}</h3>\n                      <Badge className={`mt-1 ${topicColors[bot.key] || \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200\"}`}>\n                        {bot.key}\n                      </Badge>\n                    </div>\n                    <Badge variant={bot.isEnabled ? \"default\" : \"secondary\"} className=\"shrink-0\">\n                      {bot.isEnabled ? t(\"dashboard.myBots.active\") : t(\"dashboard.myBots.paused\")}\n                    </Badge>\n                  </div>\n                  {bot.settings && (\n                    <div className=\"text-xs text-muted-foreground mb-3 space-y-1\">\n                      <div className=\"flex items-center gap-1.5\">\n                        <Clock className=\"h-3 w-3\" />\n                        <span>{bot.settings.scheduleRule} at {bot.settings.scheduleTimeLocal}</span>\n                      </div>\n                    </div>\n                  )}\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"flex-1\"\n                      onClick={() => setLocation(`/bots/${bot.id}`)}\n                      data-testid={`button-open-bot-${bot.id}`}\n                    >\n                      {t(\"dashboard.myBots.open\")}\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setLocation(`/bots/${bot.id}`)}\n                      data-testid={`button-settings-bot-${bot.id}`}\n                    >\n                      <Settings className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {schedulerStatus && (\n        <Card data-testid=\"card-system-status\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <Activity className=\"h-4 w-4\" />\n              {t(\"dashboard.system.title\")}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"pt-0\">\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 text-sm\">\n              <div className=\"flex items-center gap-2\" data-testid=\"status-collect\">\n                <Zap className=\"h-3.5 w-3.5 text-green-500\" />\n                <span className=\"text-muted-foreground\">{t(\"dashboard.system.collect\")}</span>\n                <span className=\"font-medium\">{schedulerStatus.collectInterval}</span>\n              </div>\n              <div className=\"flex items-center gap-2\" data-testid=\"status-analyze\">\n                <Zap className={`h-3.5 w-3.5 ${schedulerStatus.systemLLMAvailable ? 'text-green-500' : 'text-amber-500'}`} />\n                <span className=\"text-muted-foreground\">{t(\"dashboard.system.analyze\")}</span>\n                <span className={`font-medium ${!schedulerStatus.systemLLMAvailable ? 'text-amber-600 dark:text-amber-400' : ''}`}>\n                  {schedulerStatus.systemLLMAvailable ? schedulerStatus.analyzeInterval : t(\"dashboard.system.paused\")}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\" data-testid=\"status-draft\">\n                <Zap className={`h-3.5 w-3.5 ${schedulerStatus.systemLLMAvailable ? 'text-green-500' : 'text-amber-500'}`} />\n                <span className=\"text-muted-foreground\">{t(\"dashboard.system.draft\")}</span>\n                <span className={`font-medium ${!schedulerStatus.systemLLMAvailable ? 'text-amber-600 dark:text-amber-400' : ''}`}>\n                  {schedulerStatus.systemLLMAvailable ? schedulerStatus.draftInterval : t(\"dashboard.system.paused\")}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\" data-testid=\"status-report\">\n                <Zap className={`h-3.5 w-3.5 ${schedulerStatus.systemLLMAvailable ? 'text-green-500' : 'text-amber-500'}`} />\n                <span className=\"text-muted-foreground\">{t(\"dashboard.system.reports\")}</span>\n                <span className={`font-medium ${!schedulerStatus.systemLLMAvailable ? 'text-amber-600 dark:text-amber-400' : ''}`}>\n                  {schedulerStatus.systemLLMAvailable ? schedulerStatus.reportInterval : t(\"dashboard.system.paused\")}\n                </span>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-6 text-sm mt-3 pt-3 border-t border-border flex-wrap\">\n              <div className=\"flex items-center gap-2\">\n                <RefreshCw className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-muted-foreground\">{t(\"dashboard.system.lastCollect\")}</span>\n                <span className=\"font-medium\" data-testid=\"text-last-collect\">\n                  {schedulerStatus.lastCollect \n                    ? formatDistanceToNow(new Date(schedulerStatus.lastCollect), { addSuffix: true })\n                    : t(\"dashboard.system.never\")}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Search className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-muted-foreground\">{t(\"dashboard.system.lastAnalyze\")}</span>\n                <span className=\"font-medium\" data-testid=\"text-last-analyze\">\n                  {schedulerStatus.lastAnalyze\n                    ? formatDistanceToNow(new Date(schedulerStatus.lastAnalyze), { addSuffix: true })\n                    : t(\"dashboard.system.never\")}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {diagResults && diagResults.length > 0 && (\n        <Card data-testid=\"card-dashboard-diagnostics\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              {t(\"diag.title\")}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"pt-0 grid gap-2\">\n            {diagResults.map(d => (\n                <div key={d.botId} className=\"space-y-1\">\n                  <Link href={`/bots/${d.botId}`}>\n                    <div className=\"flex items-center gap-2 hover-elevate p-2 rounded-md cursor-pointer\" data-testid={`diag-bot-${d.botId}`}>\n                      <Badge variant={d.health === \"error\" ? \"destructive\" : d.health === \"healthy\" ? \"secondary\" : \"outline\"}>\n                        {d.botName}\n                      </Badge>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {d.health === \"healthy\"\n                          ? (language === \"ko\" ? \"정상 작동 중\" : \"Running normally\")\n                          : d.items.map(i => language === \"ko\" ? i.messageKo : i.messageEn).join(\" · \")}\n                      </span>\n                      <ArrowRight className=\"h-3.5 w-3.5 text-muted-foreground ml-auto shrink-0\" />\n                    </div>\n                  </Link>\n                </div>\n              ))}\n          </CardContent>\n        </Card>\n      )}\n\n      <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4\">\n        {statCards.map((stat) => (\n          <Card key={stat.label} className=\"hover-elevate cursor-default\">\n            <CardContent className=\"p-4\">\n              {statsLoading ? (\n                <Skeleton className=\"h-10 w-full\" />\n              ) : (\n                <div className=\"flex flex-col items-center text-center\">\n                  <stat.icon className={`h-5 w-5 mb-1 ${stat.color}`} />\n                  <div className=\"text-2xl font-bold\" data-testid={`text-stat-${stat.label.toLowerCase().replace(\" \", \"-\")}`}>\n                    {stat.value}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">{stat.label}</div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n          <CardTitle className=\"text-lg\">{t(\"dashboard.recentItems\")}</CardTitle>\n          <Link href=\"/items\">\n            <Badge variant=\"outline\" className=\"cursor-pointer\" data-testid=\"link-view-all-items\">\n              {t(\"dashboard.viewAll\")}\n            </Badge>\n          </Link>\n        </CardHeader>\n        <CardContent>\n          {itemsLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3, 4, 5].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : recentItems && recentItems.length > 0 ? (\n            <div className=\"space-y-2\">\n              {recentItems.map((item) => (\n                <Link key={item.id} href={`/items/${item.id}`}>\n                  <div\n                    className=\"p-3 rounded-md border border-transparent hover:border-border hover-elevate cursor-pointer\"\n                    data-testid={`card-item-${item.id}`}\n                  >\n                    <div className=\"flex items-start justify-between gap-4\">\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-medium truncate text-sm\">{item.title || \"Untitled\"}</h3>\n                        <div className=\"flex items-center gap-2 mt-1\">\n                          <span className=\"text-xs text-muted-foreground\">{item.sourceName}</span>\n                          <span className=\"text-xs text-muted-foreground\">\n                            {format(new Date(item.insertedAt), \"MMM d, HH:mm\")}\n                          </span>\n                        </div>\n                      </div>\n                      <Badge className={`${statusColors[item.status]} flex items-center gap-1 text-xs`}>\n                        {statusIcons[item.status]}\n                        {item.status}\n                      </Badge>\n                    </div>\n                  </div>\n                </Link>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <FileText className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>No items collected yet</p>\n              <p className=\"text-sm\">Add RSS sources to start collecting content</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":28711,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"replit.md":{"content":"# Maker Bot Manager\n\n## Overview\n\nMaker is a workflow design tool that empowers users to create personal automation bots. It enables users to design custom workflows by selecting content sources (like RSS feeds), defining schedules, and specifying output formats. The platform processes content, utilizes AI for analysis, and generates customizable reports. Key features include multi-user bot management with strict topic isolation, preset templates for easy workflow creation, and the ability for users to \"Bring Your Own LLM\" for AI tasks. The project aims to provide a flexible platform for personalized automation rather than offering pre-built solutions.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend\nA React 18 TypeScript single-page application built with Wouter for routing, TanStack React Query for state management, shadcn/ui for UI components, and Tailwind CSS for styling. It features a multi-user interface with dedicated pages for bot management, reports, sources, and settings, including light/dark theme support.\n\n### Multi-User Bot Management\nThe system supports multiple user-defined bots, each focused on a specific topic. Bots can be created from a Template Gallery via a guided wizard, allowing customization of schedules, report sections, verbosity, markdown level, and content filters. This design ensures topic isolation.\n\n### Preset Gallery & Onboarding\nA Preset Gallery offers various templates across multiple categories, each with a default configuration. A wizard guides users through template selection, topic choice, and initial configuration. All settings are fully customizable post-creation.\n\n### Backend\nThe backend is a Node.js and TypeScript application using Express.js, providing RESTful JSON APIs. It manages database interactions, scheduled background jobs, LLM integration, and business logic.\n\n### Data Storage\nPostgreSQL serves as the primary database, managed with Drizzle ORM, storing user data, sessions, sources, collected items, analysis results, drafts, and generated outputs. The system also supports SQLite for local/desktop deployments.\n\n### Background Jobs\nScheduled tasks, managed by `node-cron`, handle content collection from RSS feeds, AI-based analysis of collected content, draft generation, and report generation.\n\n### LLM Integration\nA multi-provider LLM architecture allows users to integrate their own LLMs (e.g., Anthropic, OpenAI, Google AI, or custom OpenAI-compatible endpoints). API keys are encrypted, and users can assign specific LLM providers and models to their bots. Prompts are topic-based, and outputs are structured JSON.\n\n### Command Chat\nA natural language interface, powered by Claude AI, enables users to control bots via chat commands for tasks such as listing, switching, checking status, running, pausing, resuming bots, and managing sources. The core chat engine (`server/chat/chatEngine.ts`) provides reusable `processMessage` and `processConfirm` functions used by both the web UI and external adapters.\n\n### External Messaging Adapters\nModular adapter system (`server/adapters/`) for connecting Maker to external messaging platforms. Each adapter translates platform-specific messages into the shared chat engine pipeline.\n- **Telegram** (implemented): Webhook-based adapter at `/api/telegram/webhook`. Users link accounts via one-time codes (Settings → Telegram → Generate Link Code → `/link CODE` in Telegram). Supports all Command Chat features including confirmation buttons (inline keyboard). Schema: `telegram_links` and `link_codes` tables. Requires `TELEGRAM_BOT_TOKEN` secret.\n- **Discord** (planned): Next phase after Telegram validation.\n- **Slack** (planned): Next phase after Discord.\n- **KakaoTalk** (future): Deferred due to business channel requirements.\n\n### Report Generation & Pipeline\nThe system implements a multi-stage report pipeline designed for efficiency and cost optimization:\n- **Fast Report**: Instant, no LLM involvement, shows collected item previews.\n- **Status Report**: LLM-powered fallback for timeouts, showing partial analysis.\n- **Full Report**: Asynchronous, LLM-powered, providing comprehensive AI analysis.\nThis pipeline ensures immediate feedback and background processing for detailed reports, with built-in timeouts and graceful fallbacks.\n\n### Internationalization (i18n)\nThe application supports English and Korean using a homegrown i18n system. Language preferences are persisted, and all UI text is localized.\n\n### Multi-DB Architecture\nSupports both PostgreSQL (default for cloud deployment) and SQLite (for local desktop deployment) based on environment variables, with schema mirroring and driver abstraction.\n\n### Electron Desktop Packaging\nThe application is set up for desktop distribution using Electron, allowing the Express server to run locally with SQLite, and opening a BrowserWindow for the UI. SQLite data path: `app.getPath('userData')/maker.db` (Mac: `~/Library/Application Support/Maker/maker.db`, Win: `%AppData%/Maker/maker.db`). Auth in desktop mode uses auto-login with memorystore sessions (no OIDC). Desktop detection: `window.electronAPI` or `window.maker` exposed via preload.\n\n#### Local Mode Gating\n`isLocalMode = driver === \"sqlite\" && (NODE_ENV === \"development\" || MAKER_DESKTOP === \"true\")`. Electron's `main.ts` always sets `MAKER_DESKTOP=true` in the server process env. `isDev` in Electron uses `app.isPackaged` for reliable dev/prod detection.\n\n#### Local Dev Commands\n- `MAKER_DB=sqlite npm run dev` — Run server in SQLite mode (browser at http://localhost:5000)\n- `npm run dev:desktop` — Launch Electron desktop app (cross-env + tsx/register, works on all OS)\n\n#### Desktop Build & Package\n- `npm run build:desktop` — Bundle client+server+electron via `script/build-desktop.ts`\n- `npm run pack:desktop` — Package into .app/.exe/.AppImage via electron-builder\n- Config: `electron/electron-builder.yml` with `asarUnpack` for `better-sqlite3` native module\n- Output: `dist-electron/` directory\n- Full local setup guide: `LOCAL_SETUP.md`\n\n#### Desktop npm Scripts (in package.json)\n- `dev:desktop`: `cross-env MAKER_DB=sqlite MAKER_DESKTOP=true NODE_ENV=development electron -r tsx/register electron/main.ts`\n- `build:desktop`: `tsx script/build-desktop.ts`\n- `pack:desktop`: `electron-builder --config electron/electron-builder.yml`\n- Uses `cross-env` for Windows/Mac/Linux compatibility, `-r tsx/register` for TypeScript support in Electron\n\n### Job Run Logging & Diagnostics\nThe system includes infrastructure for tracking job executions in a `job_runs` table, providing detailed diagnostics and execution history for each bot. This includes API endpoints for checking bot health, last runs, and comprehensive diagnostics. The Daily Reliability card on the Dashboard shows 7-day success rate, average generation time, last run, and last failure reason via `GET /api/diagnostics/daily-loop`.\n\n### Report Pipeline Reliability (Phase X)\n- **Timeout Hardening**: Server-side 25s timeout on report generation API, client-side 12s stall toast, 30s absolute client cutoff via AbortController. Background upgrades have 55s timeout with full job_run logging.\n- **Fast Report Template**: Standardized format with title, collection summary, top 10 items, keyword summary (top 5 extracted via bilingual tokenizer), and source distribution.\n- **Memory Layer v0.1**: `report_metrics` table stores per-report `itemCount`, `keywordSummary` (JSON), and `sourceDistribution` (JSON). Trends API (`GET /api/reports/:profileId/trends`) computes trending keywords, recurring keywords (4+ day appearances), and source shifts.\n- **Trend Block**: Full reports automatically append a \"7일 변화 요약\" section showing keyword change percentages, recurring keywords, and source distribution shifts.\n\n### Permission System v1.0\nA comprehensive permission and policy system controlling bot capabilities:\n- **Schema**: `permissions` table (userId, scope global/bot, scopeId, permissionKey, valueJson) and `audit_logs` table for security event tracking. Both PG and SQLite schemas.\n- **Policy Engine** (`server/policy/`): `types.ts` defines 13 permission keys across 6 groups (web_sources, ai_data, files, calendar, scheduling, memory). `engine.ts` provides `getEffectivePermissions` (merge default → global → bot override), `checkPermission`, `checkEgress` (3-level LLM data control: NO_EGRESS < METADATA_ONLY < FULL_CONTENT_ALLOWED), and `logPermissionAction`.\n- **ApprovalMode**: AUTO_ALLOWED, APPROVAL_REQUIRED, AUTO_DENIED.\n- **Defaults**: WEB_RSS = AUTO_ALLOWED (ON), SOURCE_WRITE/SCHEDULE_WRITE/LLM_USE = APPROVAL_REQUIRED (ON), WEB_FETCH = APPROVAL_REQUIRED (OFF), FS_READ/FS_WRITE/CAL_READ/CAL_WRITE = APPROVAL_REQUIRED (OFF), FS_DELETE = AUTO_DENIED (OFF), LLM egress = METADATA_ONLY.\n- **API Routes**: GET/PUT/DELETE `/api/permissions`, GET `/api/permissions/effective`, POST `/api/permissions/check`, POST `/api/permissions/approve-once`, GET `/api/audit-logs`.\n- **Integration**: Policy checks enforced on RSS collect, LLM analyze (with egress level validation), and source management (create/update/delete) routes, with audit logging on denials.\n- **Permission Request UX**: When APPROVAL_REQUIRED is triggered, the API returns structured 403 with `requiresApproval: true` and bilingual message templates (title/why/impact/risk). Frontend shows a `PermissionRequestModal` with scope selection (once/bot/global). One-time approvals use an in-memory allowlist with 60s TTL. Bot/global approvals persist via the permissions API.\n- **UI**: Dedicated `/permissions` page with global defaults management (group cards, switches, approval mode selects, egress level control) and audit log tab. Bot-level Permission Dashboard card in bot detail page with summary bar, 4 groups, risk badges, detail modal, and recent audit history.\n- **Platform-Aware Filtering**: Permissions are filtered by platform (web vs desktop/Electron). On web: FS_READ, FS_WRITE, FS_DELETE, CAL_READ, CAL_WRITE are hidden (localOnly). LLM_EGRESS_LEVEL hides FULL_CONTENT_ALLOWED on web. On desktop: all permissions shown with \"Local Only\" badges on desktop-specific items. Detection via `window.electronAPI`.\n- **i18n**: Full EN/KR translations for all permission, audit log, and approval UI strings.\n\n### Long-Term Memory System (Phase 1: Rule Memory)\nA 3-layer memory architecture for persistent user preferences and knowledge:\n- **Rule Memory** (implemented): `rule_memories` table (userId, scope global/bot, scopeId, key, valueJson) for user preferences like report tone, summary length, exclusion keywords, focus topics. Both PG and SQLite schemas mirrored.\n- **Storage CRUD**: `listRuleMemories`, `listAllUserRuleMemories`, `upsertRuleMemory`, `deleteRuleMemory`, `getEffectiveRules` (merges global → bot override).\n- **API Routes**: GET `/api/memory/rules` (with scope/scopeId query params, scope=all for all rules), GET `/api/memory/rules/effective` (merged rules for a bot), PUT `/api/memory/rules` (upsert), DELETE `/api/memory/rules`.\n- **Permission Keys**: `MEMORY_WRITE` (AUTO_ALLOWED, LOW risk), `DATA_RETENTION` (APPROVAL_REQUIRED, MED risk) in `memory` group. Policy engine extended with these keys.\n- **Report Pipeline Integration**: `buildDailyBriefPrompt` accepts optional `userRules` parameter. Report job fetches effective rules via `getEffectiveRules(userId, botId)` and injects them as \"User Rules & Preferences\" block in the LLM prompt.\n- **UI**: `MemoryCard` component in bot detail page showing bot + global rules, add/edit/delete UI with preset key selection (REPORT_TONE, SUMMARY_LENGTH, LANGUAGE_PREF, EXCLUDE_KEYWORDS, FOCUS_TOPICS, CUSTOM), scope toggle (bot/global), and expandable \"Effective Rules\" panel.\n- **i18n**: Full EN/KR translations for all memory UI strings.\n- **Planned Phases**: Phase 2 (Knowledge Memory - text search index over collected data), Phase 3 (advanced features - retention policies, embeddings, NL commands).\n\n## External Dependencies\n\n### Environment Variables\n- `DATABASE_URL` (for PostgreSQL)\n- `MAKER_DB` (`sqlite` for local mode)\n- `MAKER_SQLITE_PATH` (custom SQLite path)\n- `LLM_API_KEY`\n- `SESSION_SECRET`\n- `CLAUDE_MODEL`\n- `APP_BASE_URL`\n- `TELEGRAM_BOT_TOKEN` (for Telegram integration)\n\n### Third-Party Services\n- Anthropic Claude API\n- PostgreSQL\n- SQLite\n- RSS Feeds\n- Replit Auth\n- Telegram Bot API (optional)\n\n### Key NPM Packages\n- `drizzle-orm`, `drizzle-kit`\n- `better-sqlite3`\n- `rss-parser`\n- `node-cron`\n- `express-session`, `connect-pg-simple`\n- `@tanstack/react-query`\n- `wouter`\n\n## Internal Documents\n- `docs/PHILOSOPHY_EN.md` — Maker 사업 철학 영문 공개 문서","path":null,"size_bytes":12671,"size_tokens":null},"server/replit_integrations/auth/routes.ts":{"content":"import type { Express } from \"express\";\nimport { authStorage } from \"./storage\";\nimport { isAuthenticated } from \"./replitAuth\";\nimport { storage } from \"../../storage\";\n\nconst DEMO_USER_ID = \"demo_reviewer_001\";\nconst DEMO_USERNAME = \"reviewer\";\nconst DEMO_PASSWORD = \"maker2025\";\n\nexport function registerAuthRoutes(app: Express): void {\n  app.get(\"/api/auth/user\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await authStorage.getUser(userId);\n\n      try {\n        await storage.ensureDefaultBots(userId);\n      } catch (e) {\n        console.error(\"Error ensuring default bots:\", e);\n      }\n\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  app.post(\"/api/demo-login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      if (username !== DEMO_USERNAME || password !== DEMO_PASSWORD) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      await authStorage.upsertUser({\n        id: DEMO_USER_ID,\n        email: \"reviewer@maker.demo\",\n        firstName: \"Reviewer\",\n        lastName: \"Account\",\n        profileImageUrl: null,\n      });\n\n      const demoUser: any = {\n        claims: {\n          sub: DEMO_USER_ID,\n          email: \"reviewer@maker.demo\",\n          first_name: \"Reviewer\",\n          last_name: \"Account\",\n        },\n        expires_at: Math.floor(Date.now() / 1000) + 7 * 24 * 60 * 60,\n      };\n\n      req.login(demoUser, (err: any) => {\n        if (err) {\n          console.error(\"Demo login session error:\", err);\n          return res.status(500).json({ message: \"Session creation failed\" });\n        }\n        req.session.save((saveErr: any) => {\n          if (saveErr) {\n            console.error(\"Demo login session save error:\", saveErr);\n            return res.status(500).json({ message: \"Session save failed\" });\n          }\n          res.json({ success: true });\n        });\n      });\n    } catch (error) {\n      console.error(\"Demo login error:\", error);\n      res.status(500).json({ message: \"Demo login failed\" });\n    }\n  });\n}\n","path":null,"size_bytes":2225,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/pages/sources.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Switch } from \"@/components/ui/switch\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Rss, Plus, Trash2, RefreshCw, ExternalLink, Power, PowerOff, Shield, Globe } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport { usePermissionApproval } from \"@/lib/permission-request-context\";\n\ninterface Source {\n  id: number;\n  name: string;\n  type: string;\n  url: string;\n  topic: string;\n  trustLevel: string;\n  region: string;\n  enabled: boolean;\n  createdAt: string;\n  itemCount: number;\n}\n\nconst sourceFormSchema = z.object({\n  name: z.string().min(1, \"Name is required\"),\n  url: z.string().url(\"Must be a valid URL\"),\n  type: z.string().default(\"rss\"),\n  topic: z.string().default(\"tech\"),\n  trustLevel: z.string().default(\"medium\"),\n  region: z.string().default(\"global\"),\n});\n\ntype SourceFormValues = z.infer<typeof sourceFormSchema>;\n\nconst TOPIC_VALUES = [\n  \"tech\", \"investing\", \"crypto\", \"ai_art\", \"creative\", \"community_research\",\n  \"market_brief\", \"research_watch\", \"competitor_watch\", \"finance\", \"compliance\",\n  \"commerce\", \"engagement\", \"health\", \"science\", \"education\", \"content_research\",\n  \"work_productivity\", \"online_business\", \"korea_marketplace\", \"gaming\",\n  \"sustainability\", \"other\",\n];\n\nconst TRUST_LEVELS = [\n  { value: \"high\", label: \"High\" },\n  { value: \"medium\", label: \"Medium\" },\n  { value: \"low\", label: \"Low\" },\n];\n\nconst REGIONS = [\n  { value: \"global\", label: \"Global\" },\n  { value: \"us\", label: \"US\" },\n  { value: \"crypto\", label: \"Crypto\" },\n  { value: \"macro\", label: \"Macro\" },\n  { value: \"asia\", label: \"Asia\" },\n];\n\nasync function rawApiRequest(method: string, url: string, data?: unknown): Promise<Response> {\n  return fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n}\n\nexport default function Sources() {\n  const { toast } = useToast();\n  const { t } = useLanguage();\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const { requestApproval } = usePermissionApproval();\n\n  const form = useForm<SourceFormValues>({\n    resolver: zodResolver(sourceFormSchema),\n    defaultValues: {\n      name: \"\",\n      url: \"\",\n      type: \"rss\",\n      topic: \"tech\",\n      trustLevel: \"medium\",\n      region: \"global\",\n    },\n  });\n\n  const { data: sources, isLoading } = useQuery<Source[]>({\n    queryKey: [\"/api/sources\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: SourceFormValues) => {\n      const res = await rawApiRequest(\"POST\", \"/api/sources\", data);\n      if (res.status === 403) {\n        const body = await res.json();\n        if (body.requiresApproval) {\n          requestApproval(body, async () => {\n            const retryRes = await rawApiRequest(\"POST\", \"/api/sources\", data);\n            if (retryRes.ok) {\n              queryClient.invalidateQueries({ queryKey: [\"/api/sources\"] });\n              setIsDialogOpen(false);\n              form.reset();\n              toast({ title: t(\"sources.created\") });\n            }\n          });\n          return;\n        }\n        throw new Error(body.error || \"Permission denied\");\n      }\n      if (!res.ok) throw new Error(\"Failed to create source\");\n      return res;\n    },\n    onSuccess: (res) => {\n      if (!res) return;\n      queryClient.invalidateQueries({ queryKey: [\"/api/sources\"] });\n      setIsDialogOpen(false);\n      form.reset();\n      toast({ title: t(\"sources.created\") });\n    },\n    onError: () => {\n      toast({ title: t(\"sources.createFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const toggleMutation = useMutation({\n    mutationFn: async ({ id, enabled }: { id: number; enabled: boolean }) => {\n      return apiRequest(\"PATCH\", `/api/sources/${id}`, { enabled });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sources\"] });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await rawApiRequest(\"DELETE\", `/api/sources/${id}`);\n      if (res.status === 403) {\n        const body = await res.json();\n        if (body.requiresApproval) {\n          requestApproval(body, async () => {\n            const retryRes = await rawApiRequest(\"DELETE\", `/api/sources/${id}`);\n            if (retryRes.ok || retryRes.status === 204) {\n              queryClient.invalidateQueries({ queryKey: [\"/api/sources\"] });\n              toast({ title: t(\"sources.deleted\") });\n            }\n          });\n          return;\n        }\n        throw new Error(body.error || \"Permission denied\");\n      }\n      if (!res.ok && res.status !== 204) throw new Error(\"Failed to delete source\");\n      return res;\n    },\n    onSuccess: (res) => {\n      if (!res) return;\n      queryClient.invalidateQueries({ queryKey: [\"/api/sources\"] });\n      toast({ title: t(\"sources.deleted\") });\n    },\n    onError: () => {\n      toast({ title: t(\"sources.deleteFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const collectMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await rawApiRequest(\"POST\", `/api/sources/${id}/collect`);\n      if (res.status === 403) {\n        const body = await res.json();\n        if (body.requiresApproval) {\n          requestApproval(body, async () => {\n            const retryRes = await rawApiRequest(\"POST\", `/api/sources/${id}/collect`);\n            if (retryRes.ok) {\n              queryClient.invalidateQueries({ queryKey: [\"/api/sources\"] });\n              queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n              toast({ title: t(\"sources.collectionStarted\") });\n            }\n          });\n          return;\n        }\n        throw new Error(body.error || \"Permission denied\");\n      }\n      if (!res.ok) throw new Error(\"Failed to collect\");\n      return res;\n    },\n    onSuccess: (res) => {\n      if (!res) return;\n      queryClient.invalidateQueries({ queryKey: [\"/api/sources\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({ title: t(\"sources.collectionStarted\") });\n    },\n    onError: () => {\n      toast({ title: t(\"sources.collectionFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const onSubmit = (data: SourceFormValues) => {\n    createMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-sources-title\">{t(\"sources.title\")}</h1>\n          <p className=\"text-muted-foreground\">{t(\"sources.subtitle\")}</p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-add-source\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              {t(\"sources.addSource\")}\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>{t(\"sources.dialog.title\")}</DialogTitle>\n              <DialogDescription>\n                {t(\"sources.dialog.desc\")}\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t(\"sources.dialog.name\")}</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder={t(\"sources.dialog.namePlaceholder\")}\n                          {...field}\n                          data-testid=\"input-source-name\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"url\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>{t(\"sources.dialog.feedUrl\")}</FormLabel>\n                      <FormControl>\n                        <Input\n                          placeholder={t(\"sources.dialog.feedUrlPlaceholder\")}\n                          {...field}\n                          data-testid=\"input-source-url\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"grid grid-cols-3 gap-3\">\n                  <FormField\n                    control={form.control}\n                    name=\"topic\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>{t(\"sources.dialog.topic\")}</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-source-topic\">\n                              <SelectValue placeholder={t(\"sources.dialog.topic\")} />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {TOPIC_VALUES.map((tv) => (\n                              <SelectItem key={tv} value={tv}>{t(`sources.topic.${tv}`)}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"trustLevel\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>{t(\"sources.dialog.trust\")}</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-source-trust\">\n                              <SelectValue placeholder={t(\"sources.dialog.trust\")} />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {TRUST_LEVELS.map((tl) => (\n                              <SelectItem key={tl.value} value={tl.value}>{tl.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"region\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>{t(\"sources.dialog.region\")}</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-source-region\">\n                              <SelectValue placeholder={t(\"sources.dialog.region\")} />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {REGIONS.map((r) => (\n                              <SelectItem key={r.value} value={r.value}>{r.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <DialogFooter>\n                  <Button\n                    type=\"submit\"\n                    disabled={createMutation.isPending}\n                    data-testid=\"button-submit-source\"\n                  >\n                    {createMutation.isPending ? t(\"sources.dialog.creating\") : t(\"sources.dialog.create\")}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <Rss className=\"h-5 w-5\" />\n            {t(\"sources.title\")} ({sources?.length ?? 0})\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-24 w-full\" />\n              ))}\n            </div>\n          ) : sources && sources.length > 0 ? (\n            <div className=\"space-y-3\">\n              {sources.map((source) => (\n                <div\n                  key={source.id}\n                  className=\"p-4 rounded-md border hover-elevate\"\n                  data-testid={`card-source-${source.id}`}\n                >\n                  <div className=\"flex items-start justify-between gap-4\">\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 flex-wrap\">\n                        <h3 className=\"font-medium text-sm\">{source.name}</h3>\n                        <Badge variant={source.enabled ? \"default\" : \"secondary\"}>\n                          {source.enabled ? t(\"sources.active\") : t(\"sources.disabled\")}\n                        </Badge>\n                        <Badge variant=\"outline\">{t(`sources.topic.${source.topic}`)}</Badge>\n                        <Badge variant=\"outline\">\n                          <Shield className=\"h-3 w-3 mr-1\" />\n                          {source.trustLevel}\n                        </Badge>\n                        <Badge variant=\"outline\">\n                          <Globe className=\"h-3 w-3 mr-1\" />\n                          {source.region}\n                        </Badge>\n                      </div>\n                      <div className=\"flex items-center gap-2 mt-1 text-xs text-muted-foreground\">\n                        <a\n                          href={source.url}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          className=\"flex items-center gap-1 hover:text-foreground truncate max-w-[300px]\"\n                        >\n                          <ExternalLink className=\"h-3 w-3 shrink-0\" />\n                          {source.url}\n                        </a>\n                      </div>\n                      <div className=\"flex items-center gap-3 mt-2 text-xs text-muted-foreground\">\n                        <span>{t(\"sources.itemsCollected\", { count: source.itemCount })}</span>\n                        <span>{t(\"sources.created2\", { date: format(new Date(source.createdAt), \"MMM d, yyyy\") })}</span>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Switch\n                        checked={source.enabled}\n                        onCheckedChange={(enabled) => toggleMutation.mutate({ id: source.id, enabled })}\n                        data-testid={`switch-source-${source.id}`}\n                      />\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        onClick={() => collectMutation.mutate(source.id)}\n                        disabled={collectMutation.isPending}\n                        data-testid={`button-collect-${source.id}`}\n                      >\n                        <RefreshCw className=\"h-4 w-4\" />\n                      </Button>\n                      <AlertDialog>\n                        <AlertDialogTrigger asChild>\n                          <Button\n                            size=\"icon\"\n                            variant=\"ghost\"\n                            className=\"text-destructive hover:text-destructive\"\n                            data-testid={`button-delete-${source.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </AlertDialogTrigger>\n                        <AlertDialogContent>\n                          <AlertDialogHeader>\n                            <AlertDialogTitle>{t(\"sources.delete.title\")}</AlertDialogTitle>\n                            <AlertDialogDescription>\n                              {t(\"sources.delete.desc\", { name: source.name })}\n                            </AlertDialogDescription>\n                          </AlertDialogHeader>\n                          <AlertDialogFooter>\n                            <AlertDialogCancel>{t(\"sources.delete.cancel\")}</AlertDialogCancel>\n                            <AlertDialogAction\n                              onClick={() => deleteMutation.mutate(source.id)}\n                              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                            >\n                              {t(\"sources.delete.confirm\")}\n                            </AlertDialogAction>\n                          </AlertDialogFooter>\n                        </AlertDialogContent>\n                      </AlertDialog>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Rss className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg font-medium\">{t(\"sources.noSources\")}</p>\n              <p className=\"text-sm mt-1\">{t(\"sources.noSourcesHint\")}</p>\n              <Button\n                className=\"mt-4\"\n                onClick={() => setIsDialogOpen(true)}\n                data-testid=\"button-add-first-source\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                {t(\"sources.addFirst\")}\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":19458,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/lib/theme-provider\";\n\nexport function ThemeToggle() {\n  const { theme, setTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={() => setTheme(theme === \"light\" ? \"dark\" : \"light\")}\n      data-testid=\"button-theme-toggle\"\n    >\n      {theme === \"dark\" ? (\n        <Sun className=\"h-4 w-4\" />\n      ) : (\n        <Moon className=\"h-4 w-4\" />\n      )}\n      <span className=\"sr-only\">Toggle theme</span>\n    </Button>\n  );\n}\n","path":null,"size_bytes":589,"size_tokens":null},"server/jobs/draft_replies.ts":{"content":"import { storage } from \"../storage\";\nimport { callLLMWithJsonParsing } from \"../llm/client\";\nimport { \n  buildDraftPrompt, \n  buildAiArtCommunityDraftPrompt,\n  type DraftResult, \n  type SourceRules \n} from \"../llm/prompts\";\n\nconst APP_BASE_URL = process.env.APP_BASE_URL || \"https://maker.am\";\n\nfunction shouldAllowLink(riskFlags: string[]): boolean {\n  if (riskFlags.includes(\"promo_ban\")) return false;\n  if (riskFlags.includes(\"link_ban\")) return false;\n  if (riskFlags.includes(\"heated_topic\")) return false;\n  return true;\n}\n\nfunction shouldGenerateDraft(analysis: {\n  recommendedAction: string;\n  relevanceScore: number;\n  replyWorthinessScore: number;\n  riskFlags?: string[];\n}): { shouldDraft: boolean; reason: string } {\n  // If any risk flags present, skip drafting (especially for community mode)\n  const riskFlags = analysis.riskFlags || [];\n  if (riskFlags.length > 0) {\n    return { shouldDraft: false, reason: `Risk flags detected: ${riskFlags.join(\", \")}` };\n  }\n\n  // If LLM explicitly recommends draft, always generate\n  if (analysis.recommendedAction === \"draft\") {\n    return { shouldDraft: true, reason: \"LLM recommended draft\" };\n  }\n\n  // If LLM says skip or observe, respect that\n  if (analysis.recommendedAction === \"skip\" || analysis.recommendedAction === \"observe\") {\n    return { shouldDraft: false, reason: `LLM recommended ${analysis.recommendedAction}` };\n  }\n\n  // Relaxed v1 conditions: high relevance + moderate reply worthiness\n  if (analysis.relevanceScore >= 75 && analysis.replyWorthinessScore >= 35) {\n    return { shouldDraft: true, reason: `High relevance (${analysis.relevanceScore}) + reply worthiness (${analysis.replyWorthinessScore})` };\n  }\n\n  // Very high relevance alone can trigger draft (info-only, no promo links)\n  if (analysis.relevanceScore >= 85) {\n    return { shouldDraft: true, reason: `Very high relevance (${analysis.relevanceScore})` };\n  }\n\n  return { shouldDraft: false, reason: `Low scores: relevance=${analysis.relevanceScore}, reply=${analysis.replyWorthinessScore}` };\n}\n\n// Validate ai_art community drafts - reject any with links or brand mentions\nfunction validateCommunityDraft(text: string): { valid: boolean; reason?: string } {\n  // Check for URLs\n  const urlPattern = /https?:\\/\\/[^\\s]+|www\\.[^\\s]+|\\.[a-z]{2,}\\/[^\\s]*/i;\n  if (urlPattern.test(text)) {\n    return { valid: false, reason: \"Contains URL/link\" };\n  }\n\n  // Strictly forbidden brand mentions (competitors only - aiartmarket is our service to promote)\n  const forbiddenBrands = [\n    /civitai/i,\n    /promptbase/i,\n    /artstation/i,\n    /deviantart/i,\n  ];\n\n  for (const pattern of forbiddenBrands) {\n    if (pattern.test(text)) {\n      return { valid: false, reason: \"Contains forbidden brand mention\" };\n    }\n  }\n\n  // Block promotional language patterns\n  const promoPatterns = [\n    /check\\s*out/i,\n    /try\\s*(using|out)?\\s+(this|my|our)/i,\n    /i\\s*recommend/i,\n    /you\\s*should\\s*(try|use|check)/i,\n    /sign\\s*up/i,\n    /free\\s*trial/i,\n    /discount/i,\n    /coupon/i,\n    /great\\s*(service|platform|tool)/i,\n    /best\\s*(place|site|platform)/i,\n  ];\n\n  for (const pattern of promoPatterns) {\n    if (pattern.test(text)) {\n      return { valid: false, reason: \"Contains promotional language\" };\n    }\n  }\n\n  return { valid: true };\n}\n\nexport async function draftForAnalyzed(): Promise<number> {\n  console.log(\"[DraftJob] Starting draft generation for analyzed items...\");\n  const items = await storage.getItemsByStatus(\"analyzed\", 10);\n  console.log(`[DraftJob] Found ${items.length} items in 'analyzed' status`);\n  let drafted = 0;\n\n  for (const item of items) {\n    const analysis = await storage.getAnalysisByItemId(item.id);\n\n    if (!analysis) {\n      console.log(`[DraftJob] No analysis found for item #${item.id}, skipping`);\n      continue;\n    }\n\n    const riskFlags = (analysis.riskFlagsJson as string[]) || [];\n    \n    const { shouldDraft, reason } = shouldGenerateDraft({\n      recommendedAction: analysis.recommendedAction,\n      relevanceScore: analysis.relevanceScore,\n      replyWorthinessScore: analysis.replyWorthinessScore,\n      riskFlags,\n    });\n\n    if (!shouldDraft) {\n      console.log(`[DraftJob] Item #${item.id} skipped: ${reason}`);\n      await storage.updateItemStatus(item.id, \"skipped\");\n      continue;\n    }\n\n    console.log(`[DraftJob] Item #${item.id} will get drafts: ${reason}`);\n\n    console.log(`Generating drafts for item #${item.id} (topic: ${item.sourceTopic}): ${item.title?.slice(0, 50)}...`);\n\n    const sourceRules = (item.rulesJson as SourceRules) || {};\n    const allowLink = shouldAllowLink(riskFlags) && (sourceRules.allowLinks !== false);\n\n    const isCommunityContribution = item.sourceTopic === \"ai_art\" || item.sourceTopic === \"community_research\";\n\n    const prompt = isCommunityContribution\n      ? buildAiArtCommunityDraftPrompt({\n          title: item.title ?? \"\",\n          body: item.contentText ?? \"\",\n          suggestedAngle: analysis.suggestedAngle || \"\",\n        })\n      : buildDraftPrompt({\n          title: item.title ?? \"\",\n          body: item.contentText ?? \"\",\n          analysisJson: JSON.stringify({\n            category: analysis.category,\n            risk_flags: riskFlags,\n            suggested_angle: analysis.suggestedAngle,\n          }),\n          allowLink,\n          baseUrl: APP_BASE_URL,\n          sourceRules,\n        });\n\n    try {\n      const result = await callLLMWithJsonParsing<DraftResult>(prompt);\n      let savedCount = 0;\n\n      for (const draft of result.drafts || []) {\n        if (isCommunityContribution) {\n          const validation = validateCommunityDraft(draft.text);\n          if (!validation.valid) {\n            console.log(`[DraftJob] Rejected ${item.sourceTopic} draft variant ${draft.variant}: ${validation.reason}`);\n            continue;\n          }\n          draft.includes_link = false;\n        }\n\n        await storage.createDraft({\n          itemId: item.id,\n          variant: draft.variant,\n          draftText: draft.text,\n          includesLink: draft.includes_link || false,\n          linkType: draft.includes_link ? \"homepage\" : \"none\",\n          tone: draft.tone || \"helpful\",\n          adminDecision: \"pending\",\n        });\n        savedCount++;\n      }\n\n      await storage.updateItemStatus(item.id, \"drafted\");\n      drafted++;\n      console.log(`✓ Generated ${savedCount} drafts for item #${item.id} (${result.drafts?.length || 0} total, filtered for community mode)`);\n    } catch (error) {\n      console.error(`✗ Failed to generate drafts for item #${item.id}:`, error);\n    }\n  }\n\n  return drafted;\n}\n","path":null,"size_bytes":6585,"size_tokens":null},"client/src/components/app-sidebar.tsx":{"content":"import { LayoutDashboard, FileText, Rss, CheckCircle, Settings, Eye, FileBarChart, MessageCircle, Bot, BookOpen, Shield } from \"lucide-react\";\nimport { Link, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\ninterface BotInfo {\n  id: number;\n  key: string;\n  name: string;\n  isEnabled: boolean;\n}\n\ntype MenuItem = {\n  title: string;\n  url: string;\n  icon: React.ComponentType<{ className?: string }>;\n  translationKey: string;\n};\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n  const { t } = useLanguage();\n\n  const menuItems: MenuItem[] = [\n    { title: t(\"sidebar.dashboard\"), url: \"/\", icon: LayoutDashboard, translationKey: \"sidebar.dashboard\" },\n    { title: t(\"sidebar.myBots\"), url: \"/bots\", icon: Bot, translationKey: \"sidebar.myBots\" },\n    { title: t(\"sidebar.sources\"), url: \"/sources\", icon: Rss, translationKey: \"sidebar.sources\" },\n    { title: t(\"sidebar.reports\"), url: \"/reports\", icon: FileBarChart, translationKey: \"sidebar.reports\" },\n    { title: t(\"sidebar.drafts\"), url: \"/drafts\", icon: CheckCircle, translationKey: \"sidebar.drafts\" },\n    { title: t(\"sidebar.items\"), url: \"/items\", icon: FileText, translationKey: \"sidebar.items\" },\n    { title: t(\"sidebar.observe\"), url: \"/observe\", icon: Eye, translationKey: \"sidebar.observe\" },\n    { title: t(\"sidebar.console\"), url: \"/chat\", icon: MessageCircle, translationKey: \"sidebar.console\" },\n    { title: t(\"sidebar.guide\"), url: \"/guide\", icon: BookOpen, translationKey: \"sidebar.guide\" },\n    { title: t(\"sidebar.permissions\"), url: \"/permissions\", icon: Shield, translationKey: \"sidebar.permissions\" },\n    { title: t(\"sidebar.settings\"), url: \"/settings\", icon: Settings, translationKey: \"sidebar.settings\" },\n  ];\n\n  const { data: botsResponse } = useQuery<{ bots: BotInfo[] }>({\n    queryKey: [\"/api/bots\"],\n    queryFn: () => fetch(\"/api/bots\", { credentials: \"include\" }).then(r => {\n      if (!r.ok) return { bots: [] };\n      return r.json();\n    }),\n  });\n\n  const activeBots = (botsResponse?.bots ?? []).filter(b => b.isEnabled);\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"p-4 border-b border-sidebar-border\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"w-8 h-8 rounded-md bg-primary flex items-center justify-center\">\n            <span className=\"text-primary-foreground font-bold text-sm\">M</span>\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"font-semibold text-sm\">Maker</span>\n            <span className=\"text-xs text-muted-foreground\">{t(\"sidebar.subtitle\")}</span>\n          </div>\n        </div>\n      </SidebarHeader>\n      <SidebarContent>\n        {activeBots.length > 0 && (\n          <SidebarGroup>\n            <SidebarGroupLabel>{t(\"sidebar.activeBots\")}</SidebarGroupLabel>\n            <SidebarGroupContent>\n              <div className=\"px-2 pb-1 flex flex-wrap gap-1\" data-testid=\"active-bots-list\">\n                {activeBots.map(bot => (\n                  <Link key={bot.id} href={`/bots/${bot.id}`}>\n                    <Badge\n                      variant=\"secondary\"\n                      className=\"cursor-pointer text-xs\"\n                      data-testid={`badge-bot-${bot.key}`}\n                    >\n                      {bot.key}\n                    </Badge>\n                  </Link>\n                ))}\n              </div>\n            </SidebarGroupContent>\n          </SidebarGroup>\n        )}\n        <SidebarGroup>\n          <SidebarGroupLabel>{t(\"sidebar.navigation\")}</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {menuItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url || (item.url !== \"/\" && location.startsWith(item.url))}\n                  >\n                    <Link href={item.url} data-testid={`link-${item.title.toLowerCase().replace(/\\s+/g, '-')}`}>\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n      <SidebarFooter className=\"p-4 border-t border-sidebar-border\">\n        <div className=\"text-xs text-muted-foreground\">\n          {t(\"sidebar.footer\")}\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":4881,"size_tokens":null},"server/llm/providers/openai.ts":{"content":"interface OpenAIResponse {\n  choices: Array<{\n    message: { role: string; content: string };\n    finish_reason: string;\n  }>;\n}\n\nexport async function generate(\n  prompt: string,\n  options: { apiKey: string; baseUrl?: string | null; model?: string | null; maxTokens?: number }\n): Promise<string> {\n  const url = (options.baseUrl || \"https://api.openai.com\") + \"/v1/chat/completions\";\n  const model = options.model || \"gpt-4o\";\n  const maxTokens = options.maxTokens || 1200;\n\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${options.apiKey}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      model,\n      max_tokens: maxTokens,\n      temperature: 0.2,\n      messages: [{ role: \"user\", content: prompt }],\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);\n  }\n\n  const data: OpenAIResponse = await response.json();\n  const text = data.choices?.[0]?.message?.content;\n\n  if (!text) throw new Error(\"Empty response from OpenAI API\");\n  return text;\n}\n","path":null,"size_bytes":1146,"size_tokens":null},"client/src/pages/drafts.tsx":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Edit, ThumbsUp, ThumbsDown, Copy, Check, ExternalLink, Filter } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { format } from \"date-fns\";\nimport { useState } from \"react\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\ninterface DraftItem {\n  id: number;\n  itemId: number;\n  variant: string;\n  draftText: string;\n  includesLink: boolean;\n  tone: string;\n  adminDecision: string;\n  finalText?: string;\n  createdAt: string;\n  itemTitle: string;\n  itemUrl: string;\n  sourceName: string;\n}\n\nconst decisionColors: Record<string, string> = {\n  pending: \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\",\n  approved: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  rejected: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n};\n\nexport default function Drafts() {\n  const { t } = useLanguage();\n  const { toast } = useToast();\n  const [decisionFilter, setDecisionFilter] = useState<string>(\"pending\");\n  const [copiedId, setCopiedId] = useState<number | null>(null);\n\n  const draftsUrl = decisionFilter === \"all\" \n    ? \"/api/drafts\" \n    : `/api/drafts?decision=${decisionFilter}`;\n  \n  const { data: drafts, isLoading } = useQuery<DraftItem[]>({\n    queryKey: [draftsUrl],\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async ({ draftId, finalText }: { draftId: number; finalText: string }) => {\n      return apiRequest(\"POST\", `/api/drafts/${draftId}/approve`, { finalText });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ predicate: (query) => \n        Boolean(query.queryKey[0]?.toString().startsWith(\"/api/drafts\"))\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      toast({ title: t(\"drafts.approved\") });\n    },\n  });\n\n  const rejectMutation = useMutation({\n    mutationFn: async (draftId: number) => {\n      return apiRequest(\"POST\", `/api/drafts/${draftId}/reject`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ predicate: (query) => \n        Boolean(query.queryKey[0]?.toString().startsWith(\"/api/drafts\"))\n      });\n      toast({ title: t(\"drafts.rejected\") });\n    },\n  });\n\n  const handleCopy = async (draft: DraftItem) => {\n    await navigator.clipboard.writeText(draft.draftText);\n    setCopiedId(draft.id);\n    setTimeout(() => setCopiedId(null), 2000);\n    toast({ title: t(\"drafts.copiedToClipboard\") });\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-drafts-title\">{t(\"drafts.title\")}</h1>\n        <p className=\"text-muted-foreground\">{t(\"drafts.subtitle\")}</p>\n      </div>\n\n      <div className=\"flex items-center gap-3\">\n        <Select value={decisionFilter} onValueChange={setDecisionFilter}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"select-decision-filter\">\n            <Filter className=\"h-4 w-4 mr-2\" />\n            <SelectValue placeholder={t(\"drafts.filterDecision\")} />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">{t(\"drafts.allDecisions\")}</SelectItem>\n            <SelectItem value=\"pending\">{t(\"drafts.decision.pending\")}</SelectItem>\n            <SelectItem value=\"approved\">{t(\"drafts.decision.approved\")}</SelectItem>\n            <SelectItem value=\"rejected\">{t(\"drafts.decision.rejected\")}</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <Edit className=\"h-5 w-5\" />\n            {t(\"drafts.count\", { count: String(drafts?.length ?? 0) })}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-40 w-full\" />\n              ))}\n            </div>\n          ) : drafts && drafts.length > 0 ? (\n            <div className=\"space-y-4\">\n              {drafts.map((draft) => (\n                <div\n                  key={draft.id}\n                  className=\"p-4 rounded-md border hover-elevate\"\n                  data-testid={`card-draft-${draft.id}`}\n                >\n                  <div className=\"flex items-start justify-between gap-4 mb-3\">\n                    <div className=\"flex-1 min-w-0\">\n                      <Link href={`/items/${draft.itemId}`}>\n                        <h3 className=\"font-medium text-sm line-clamp-1 hover:underline cursor-pointer\">\n                          {draft.itemTitle || t(\"common.untitled\")}\n                        </h3>\n                      </Link>\n                      <div className=\"flex flex-wrap items-center gap-2 mt-1 text-xs text-muted-foreground\">\n                        <span>{draft.sourceName}</span>\n                        <span>{t(\"drafts.variant\", { variant: draft.variant })}</span>\n                        <span>{format(new Date(draft.createdAt), \"MMM d, HH:mm\")}</span>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge className={decisionColors[draft.adminDecision]}>\n                        {t(`common.decision.${draft.adminDecision}`)}\n                      </Badge>\n                      <Badge variant=\"outline\">{draft.tone}</Badge>\n                      {draft.includesLink && (\n                        <Badge variant=\"outline\" className=\"flex items-center gap-1\">\n                          <ExternalLink className=\"h-3 w-3\" />\n                        </Badge>\n                      )}\n                    </div>\n                  </div>\n\n                  <div className=\"p-3 rounded-md bg-muted text-sm whitespace-pre-wrap line-clamp-4 mb-3\">\n                    {draft.draftText}\n                  </div>\n\n                  <div className=\"flex flex-wrap gap-2\">\n                    {draft.adminDecision === \"pending\" && (\n                      <>\n                        <Button\n                          size=\"sm\"\n                          onClick={() => approveMutation.mutate({ draftId: draft.id, finalText: draft.draftText })}\n                          disabled={approveMutation.isPending}\n                          data-testid={`button-approve-${draft.id}`}\n                        >\n                          <ThumbsUp className=\"h-3 w-3 mr-1\" />\n                          {t(\"drafts.approve\")}\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => rejectMutation.mutate(draft.id)}\n                          disabled={rejectMutation.isPending}\n                          data-testid={`button-reject-${draft.id}`}\n                        >\n                          <ThumbsDown className=\"h-3 w-3 mr-1\" />\n                          {t(\"drafts.reject\")}\n                        </Button>\n                      </>\n                    )}\n                    <Button\n                      size=\"sm\"\n                      variant=\"ghost\"\n                      onClick={() => handleCopy(draft)}\n                      data-testid={`button-copy-${draft.id}`}\n                    >\n                      {copiedId === draft.id ? (\n                        <Check className=\"h-3 w-3 mr-1\" />\n                      ) : (\n                        <Copy className=\"h-3 w-3 mr-1\" />\n                      )}\n                      {t(\"drafts.copy\")}\n                    </Button>\n                    <Link href={`/items/${draft.itemId}`}>\n                      <Button size=\"sm\" variant=\"ghost\" data-testid={`button-view-item-${draft.id}`}>\n                        {t(\"drafts.viewItem\")}\n                      </Button>\n                    </Link>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Edit className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n              <p className=\"text-lg font-medium\">{t(\"drafts.noDrafts\")}</p>\n              <p className=\"text-sm mt-1\">\n                {decisionFilter !== \"all\"\n                  ? t(\"drafts.noDraftsFilter\")\n                  : t(\"drafts.noDraftsDefault\")}\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8909,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"server/chat/command-parser.ts":{"content":"import { callLLMWithJsonParsing } from \"../llm/client\";\nimport { buildCommandParsePrompt, buildClarificationPrompt, type CommandParseContext } from \"../llm/prompts_chat\";\nimport type { ChatCommand, ChatCommandType } from \"@shared/chatCommand\";\n\nexport type { ChatCommand, ChatCommandType };\nexport type { CommandParseContext };\n\nfunction isKoreanInput(text: string): boolean {\n  const koreanChars = text.match(/[\\uAC00-\\uD7AF\\u1100-\\u11FF\\u3130-\\u318F]/g);\n  return (koreanChars?.length || 0) > text.length * 0.1;\n}\n\nconst COMMAND_HINT_KEYWORDS = [\n  \"add\", \"delete\", \"run\", \"now\", \"immediately\", \"schedule\",\n  \"pause\", \"resume\", \"status\", \"list\", \"switch\",\n  \"bot\", \"source\", \"collect\", \"analyze\", \"draft\", \"report\",\n  \"stop\", \"halt\", \"start\", \"enable\", \"disable\",\n  \"remove\",\n  \"봇\", \"상태\", \"목록\", \"리스트\", \"전환\", \"소스\", \"추가\", \"삭제\", \"제거\",\n  \"중지\", \"재개\", \"일시정지\", \"점검\", \"요약\", \"브리핑\", \"보여\",\n  \"수집\", \"분석\", \"리포트\", \"보고서\", \"제출\", \"모아\", \"정리\",\n  \"스케줄\", \"매일\", \"아침\", \"저녁\", \"오전\", \"오후\",\n  \"pipeline\", \"자동\", \"실행\", \"돌려\", \"작성\", \"파이프라인\",\n];\n\nfunction isCommandCandidate(message: string): boolean {\n  const lower = message.toLowerCase();\n  if (lower.includes(\"http://\") || lower.includes(\"https://\")) return true;\n  return COMMAND_HINT_KEYWORDS.some(kw => lower.includes(kw));\n}\n\nexport interface ParseResult {\n  command: ChatCommand;\n  clarificationNeeded: boolean;\n  clarificationText?: string;\n}\n\nfunction tryKeywordFallback(message: string, context: CommandParseContext): ChatCommand | null {\n  const lower = message.toLowerCase();\n  const botKey = context.activeBotKey;\n  const ko = isKoreanInput(message);\n\n  const hasPipelineIntent = (\n    (lower.includes(\"수집\") && (lower.includes(\"분석\") || lower.includes(\"리포트\") || lower.includes(\"보고서\") || lower.includes(\"작성\"))) ||\n    (lower.includes(\"collect\") && (lower.includes(\"analyz\") || lower.includes(\"report\"))) ||\n    (lower.includes(\"분석\") && (lower.includes(\"리포트\") || lower.includes(\"보고서\") || lower.includes(\"작성\"))) ||\n    (lower.includes(\"analyz\") && lower.includes(\"report\")) ||\n    (lower.includes(\"파이프라인\") || lower.includes(\"pipeline\"))\n  );\n\n  if (hasPipelineIntent) {\n    let scheduleRule: string | undefined;\n    let scheduleTimeLocal: string | undefined;\n\n    if (lower.includes(\"매일\") || lower.includes(\"daily\")) scheduleRule = \"DAILY\";\n    if (lower.includes(\"평일\") || lower.includes(\"weekday\")) scheduleRule = \"WEEKDAYS\";\n\n    const timeMatch = message.match(/(\\d{1,2})\\s*[시:]\\s*(\\d{0,2})/);\n    if (timeMatch) {\n      const hour = timeMatch[1].padStart(2, \"0\");\n      const minute = (timeMatch[2] || \"00\").padStart(2, \"0\");\n      scheduleTimeLocal = `${hour}:${minute}`;\n    }\n    if (lower.includes(\"아침\") && !scheduleTimeLocal) scheduleTimeLocal = \"09:00\";\n    if (lower.includes(\"저녁\") && !scheduleTimeLocal) scheduleTimeLocal = \"18:00\";\n    if (lower.includes(\"오전\") && !scheduleTimeLocal) scheduleTimeLocal = \"09:00\";\n    if (lower.includes(\"오후\") && !scheduleTimeLocal) scheduleTimeLocal = \"14:00\";\n\n    const args: Record<string, any> = { lang: ko ? \"ko\" : \"en\" };\n    if (scheduleRule) args.scheduleRule = scheduleRule;\n    if (scheduleTimeLocal) args.scheduleTimeLocal = scheduleTimeLocal;\n\n    const confirmText = ko\n      ? `자료 수집 → 분석 → 리포트 생성${scheduleTimeLocal ? ` (${scheduleTimeLocal})` : \"\"}${scheduleRule ? ` ${scheduleRule}` : \"\"}`\n      : `Collect → Analyze → Generate report${scheduleTimeLocal ? ` (${scheduleTimeLocal})` : \"\"}${scheduleRule ? ` ${scheduleRule}` : \"\"}`;\n\n    return {\n      type: \"pipeline_run\",\n      botKey: botKey,\n      args,\n      confidence: 0.8,\n      needsConfirm: true,\n      confirmText,\n    };\n  }\n\n  const hasCollectOnly = (\n    (lower.includes(\"수집\") || lower.includes(\"모아\") || lower.includes(\"collect\")) &&\n    !lower.includes(\"분석\") && !lower.includes(\"리포트\") && !lower.includes(\"보고서\") && !lower.includes(\"작성\")\n  );\n  if (hasCollectOnly) {\n    return {\n      type: \"run_now\",\n      botKey: botKey,\n      args: { job: \"collect\" },\n      confidence: 0.8,\n      needsConfirm: true,\n      confirmText: ko ? \"자료 수집 실행\" : \"Run data collection\",\n    };\n  }\n\n  const hasAnalyzeOnly = (\n    (lower.includes(\"분석\") || lower.includes(\"analyz\")) &&\n    !lower.includes(\"수집\") && !lower.includes(\"리포트\") && !lower.includes(\"보고서\") && !lower.includes(\"작성\")\n  );\n  if (hasAnalyzeOnly) {\n    return {\n      type: \"run_now\",\n      botKey: botKey,\n      args: { job: \"analyze\" },\n      confidence: 0.8,\n      needsConfirm: true,\n      confirmText: ko ? \"분석 실행\" : \"Run analysis\",\n    };\n  }\n\n  const hasReportOnly = (\n    (lower.includes(\"리포트\") || lower.includes(\"보고서\") || lower.includes(\"report\")) &&\n    !lower.includes(\"수집\") && !lower.includes(\"분석\")\n  );\n  if (hasReportOnly) {\n    return {\n      type: \"run_now\",\n      botKey: botKey,\n      args: { job: \"report\" },\n      confidence: 0.8,\n      needsConfirm: true,\n      confirmText: ko ? \"리포트 생성\" : \"Generate report\",\n    };\n  }\n\n  if (lower.includes(\"list\") && lower.includes(\"bot\") || lower.includes(\"봇 목록\") || lower.includes(\"봇 리스트\")) {\n    return {\n      type: \"list_bots\",\n      botKey: botKey,\n      args: {},\n      confidence: 0.9,\n      needsConfirm: false,\n      confirmText: ko ? \"봇 목록 조회\" : \"List bots\",\n    };\n  }\n\n  if ((lower.includes(\"status\") || lower.includes(\"상태\")) && (lower.includes(\"bot\") || lower.includes(\"봇\"))) {\n    return {\n      type: \"bot_status\",\n      botKey: botKey,\n      args: {},\n      confidence: 0.9,\n      needsConfirm: false,\n      confirmText: ko ? \"봇 상태 조회\" : \"Bot status\",\n    };\n  }\n\n  if (lower.includes(\"pause\") || lower.includes(\"일시정지\") || lower.includes(\"중지\")) {\n    return {\n      type: \"pause_bot\",\n      botKey: botKey,\n      args: {},\n      confidence: 0.8,\n      needsConfirm: true,\n      confirmText: ko ? \"봇 일시정지\" : \"Pause bot\",\n    };\n  }\n\n  if (lower.includes(\"resume\") || lower.includes(\"재개\") || lower.includes(\"다시 시작\")) {\n    return {\n      type: \"resume_bot\",\n      botKey: botKey,\n      args: {},\n      confidence: 0.8,\n      needsConfirm: true,\n      confirmText: ko ? \"봇 재개\" : \"Resume bot\",\n    };\n  }\n\n  if ((lower.includes(\"switch\") || lower.includes(\"전환\")) && (lower.includes(\"bot\") || lower.includes(\"봇\"))) {\n    const botNames = context.availableBotKeys || [];\n    const matchedKey = botNames.find(k => lower.includes(k.toLowerCase()));\n    return {\n      type: \"switch_bot\",\n      botKey: matchedKey || botKey,\n      args: { targetBotKey: matchedKey },\n      confidence: matchedKey ? 0.9 : 0.6,\n      needsConfirm: false,\n      confirmText: ko ? `봇 전환: ${matchedKey || \"?\"}` : `Switch to bot: ${matchedKey || \"?\"}`,\n    };\n  }\n\n  if ((lower.includes(\"소스\") || lower.includes(\"source\")) && (lower.includes(\"추가\") || lower.includes(\"add\"))) {\n    const urlMatch = message.match(/https?:\\/\\/[^\\s]+/);\n    return {\n      type: \"add_source\",\n      botKey: botKey,\n      args: { url: urlMatch?.[0] || \"\" },\n      confidence: urlMatch ? 0.9 : 0.6,\n      needsConfirm: true,\n      confirmText: ko ? `소스 추가: ${urlMatch?.[0] || \"URL\"}` : `Add source: ${urlMatch?.[0] || \"URL\"}`,\n    };\n  }\n\n  if ((lower.includes(\"소스\") || lower.includes(\"source\")) && (lower.includes(\"삭제\") || lower.includes(\"제거\") || lower.includes(\"remove\") || lower.includes(\"delete\"))) {\n    return {\n      type: \"remove_source\",\n      botKey: botKey,\n      args: {},\n      confidence: 0.6,\n      needsConfirm: true,\n      confirmText: ko ? \"소스 삭제\" : \"Remove source\",\n    };\n  }\n\n  if (lower.includes(\"목록\") || lower.includes(\"리스트\") || lower.includes(\"보여줘\")) {\n    if (lower.includes(\"봇\") || lower.includes(\"bot\")) {\n      return {\n        type: \"list_bots\",\n        botKey: botKey,\n        args: {},\n        confidence: 0.85,\n        needsConfirm: false,\n        confirmText: ko ? \"봇 목록 조회\" : \"List bots\",\n      };\n    }\n  }\n\n  if (lower.includes(\"상태\") || lower.includes(\"점검\") || lower.includes(\"브리핑\") || lower.includes(\"요약\")) {\n    return {\n      type: \"bot_status\",\n      botKey: botKey,\n      args: {},\n      confidence: 0.8,\n      needsConfirm: false,\n      confirmText: ko ? \"봇 상태 조회\" : \"Bot status\",\n    };\n  }\n\n  return null;\n}\n\nexport async function parseCommand(\n  userMessage: string,\n  context: CommandParseContext\n): Promise<ParseResult> {\n  if (!isCommandCandidate(userMessage)) {\n    return {\n      command: {\n        type: \"chat\",\n        botKey: null,\n        args: { reply: \"\" },\n        confidence: 1.0,\n        needsConfirm: false,\n        confirmText: \"\",\n      },\n      clarificationNeeded: false,\n    };\n  }\n\n  const prompt = buildCommandParsePrompt(userMessage, context);\n\n  try {\n    const parsed = await callLLMWithJsonParsing<ChatCommand>(prompt, 2);\n\n    if (!parsed.type || !isValidType(parsed.type)) {\n      parsed.type = \"chat\";\n    }\n    if (typeof parsed.confidence !== \"number\") {\n      parsed.confidence = 0.5;\n    }\n    if (typeof parsed.needsConfirm !== \"boolean\") {\n      parsed.needsConfirm = true;\n    }\n    if (!parsed.confirmText) {\n      parsed.confirmText = getDefaultConfirmText(parsed);\n    }\n    if (!parsed.args) parsed.args = {};\n    if (!parsed.botKey) parsed.botKey = context.activeBotKey;\n\n    if (parsed.confidence < 0.7 && parsed.type !== \"chat\") {\n      let clarificationText: string;\n      try {\n        const clarifyPrompt = buildClarificationPrompt(userMessage, context);\n        const raw = await callLLMWithJsonParsing<{ reply: string }>(clarifyPrompt, 1);\n        clarificationText = raw.reply || \"어떤 봇에서 어떤 작업을 실행할지 조금 더 구체적으로 말씀해 주세요.\";\n      } catch {\n        clarificationText = \"어떤 봇에서 어떤 작업을 실행할지 조금 더 구체적으로 말씀해 주세요.\";\n      }\n\n      return {\n        command: parsed,\n        clarificationNeeded: true,\n        clarificationText,\n      };\n    }\n\n    return { command: parsed, clarificationNeeded: false };\n  } catch (error) {\n    console.error(\"Command parsing via LLM failed, trying keyword fallback:\", error);\n\n    const fallbackCommand = tryKeywordFallback(userMessage, context);\n    if (fallbackCommand) {\n      console.log(\"[Fallback] Keyword parser matched:\", fallbackCommand.type);\n      return { command: fallbackCommand, clarificationNeeded: false };\n    }\n\n    return {\n      command: {\n        type: \"chat\",\n        botKey: null,\n        args: { reply: \"AI 파서가 일시적으로 응답하지 않습니다. 잠시 후 다시 시도해 주세요.\\n\\n직접 명령어를 입력할 수도 있습니다:\\n• \\\"자료 수집해줘\\\" — 소스에서 자료 수집\\n• \\\"분석해줘\\\" — 수집된 자료 분석\\n• \\\"리포트 작성해줘\\\" — 리포트 생성\\n• \\\"수집하고 분석해서 리포트 작성해줘\\\" — 전체 파이프라인 실행\" },\n        confidence: 0,\n        needsConfirm: false,\n        confirmText: \"\",\n      },\n      clarificationNeeded: false,\n    };\n  }\n}\n\nfunction isValidType(type: string): type is ChatCommandType {\n  return [\n    \"list_bots\", \"switch_bot\", \"bot_status\", \"run_now\",\n    \"pause_bot\", \"resume_bot\", \"add_source\", \"remove_source\",\n    \"pipeline_run\", \"chat\",\n  ].includes(type);\n}\n\nfunction getDefaultConfirmText(cmd: ChatCommand): string {\n  const bot = cmd.botKey || \"current bot\";\n  switch (cmd.type) {\n    case \"run_now\": return `${bot}: run ${cmd.args?.job || \"job\"}`;\n    case \"pipeline_run\": {\n      const schedule = cmd.args?.scheduleTimeLocal ? ` (${cmd.args.scheduleTimeLocal} schedule)` : \"\";\n      return `${bot}: 자료 수집 → 분석 → 리포트 생성${schedule}`;\n    }\n    case \"pause_bot\": return `Pause ${bot}`;\n    case \"resume_bot\": return `Resume ${bot}`;\n    case \"add_source\": return `Add source to ${bot}: ${cmd.args?.url || \"\"}`;\n    case \"remove_source\": return `Remove source from ${bot}: ${cmd.args?.sourceName || \"\"}`;\n    default: return \"\";\n  }\n}\n","path":null,"size_bytes":12218,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"/{*path}\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":554,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"server/replit_integrations/auth/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport MemoryStore from \"memorystore\";\nimport { authStorage } from \"./storage\";\nimport { driver } from \"../../db\";\n\nconst MemSession = MemoryStore(session);\n\nconst isLocalMode = driver === \"sqlite\" && (\n  process.env.NODE_ENV === \"development\" || !!process.env.MAKER_DESKTOP\n);\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n\n  let sessionStore: session.Store;\n\n  if (isLocalMode) {\n    sessionStore = new MemSession({\n      checkPeriod: 86400000,\n    });\n  } else {\n    const pgStore = connectPg(session);\n    sessionStore = new pgStore({\n      conString: process.env.DATABASE_URL,\n      createTableIfMissing: false,\n      ttl: sessionTtl,\n      tableName: \"sessions\",\n    });\n  }\n\n  return session({\n    secret: process.env.SESSION_SECRET || \"maker-local-session-secret\",\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: !isLocalMode,\n      sameSite: \"lax\",\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(claims: any) {\n  await authStorage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nconst LOCAL_USER_ID = \"local_desktop_user\";\n\nasync function ensureLocalUser() {\n  try {\n    const existing = await authStorage.getUser(LOCAL_USER_ID);\n    if (!existing) {\n      await authStorage.upsertUser({\n        id: LOCAL_USER_ID,\n        email: \"user@localhost\",\n        firstName: \"Local\",\n        lastName: \"User\",\n        profileImageUrl: null,\n      });\n    }\n  } catch (e) {\n    console.error(\"[Auth] Failed to create local user:\", e);\n  }\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  if (isLocalMode) {\n    await ensureLocalUser();\n\n    app.get(\"/api/login\", (req, res) => {\n      const localUser: any = {\n        claims: {\n          sub: LOCAL_USER_ID,\n          email: \"user@localhost\",\n          first_name: \"Local\",\n          last_name: \"User\",\n        },\n        expires_at: Math.floor(Date.now() / 1000) + 365 * 24 * 60 * 60,\n      };\n\n      req.login(localUser, (err: any) => {\n        if (err) {\n          console.error(\"[Auth] Local login error:\", err);\n          return res.status(500).json({ message: \"Login failed\" });\n        }\n        res.redirect(\"/\");\n      });\n    });\n\n    app.get(\"/api/callback\", (_req, res) => {\n      res.redirect(\"/\");\n    });\n\n    app.get(\"/api/logout\", (req, res) => {\n      req.logout(() => {\n        res.redirect(\"/\");\n      });\n    });\n\n    console.log(\"[Auth] Desktop/SQLite mode: local auto-login enabled\");\n    return;\n  }\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  const registeredStrategies = new Set<string>();\n\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  if (user.claims?.sub === LOCAL_USER_ID || user.claims?.sub?.startsWith(\"demo_\")) {\n    user.expires_at = now + 365 * 24 * 60 * 60;\n    req.session.save(() => {});\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    req.session.save((err) => {\n      if (err) {\n        console.error(\"[Auth] Session save after refresh failed:\", err);\n      }\n      return next();\n    });\n  } catch (error) {\n    console.error(\"[Auth] Token refresh failed:\", error);\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":6557,"size_tokens":null},"client/src/pages/profiles.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport { Plus, Bot as BotIcon, Trash2, Settings, Loader2, Newspaper, Eye, Scale, GraduationCap, ShoppingBag, MessageSquare, TrendingUp, Users, Sparkles, ArrowLeft, Rss, Clock, FileText, ChevronRight, Link2, Search, Briefcase, BookOpen, Building2, PenTool, Laptop, Store, ShoppingCart } from \"lucide-react\";\n\ninterface SuggestedSource {\n  name: string;\n  url: string;\n  type?: string;\n  topic: string;\n}\n\ninterface PresetConfig {\n  timezone?: string;\n  scheduleRule?: string;\n  scheduleTimeLocal?: string;\n  markdownLevel?: string;\n  verbosity?: string;\n  sections?: Record<string, boolean>;\n  filters?: Record<string, number>;\n  suggestedSources?: SuggestedSource[];\n  requireHumanApproval?: boolean;\n  promotionLevel?: string;\n  linkPolicy?: string;\n  sourceDisclaimer?: string;\n}\n\ninterface Preset {\n  id: number;\n  key: string;\n  name: string;\n  outputType: string;\n  description: string | null;\n  variantsJson: string[];\n  defaultConfigJson: PresetConfig;\n  icon: string | null;\n  category: string | null;\n}\n\ninterface BotSettings {\n  id: number;\n  botId: number;\n  timezone: string;\n  scheduleRule: string;\n  scheduleTimeLocal: string;\n  format: string;\n  markdownLevel: string;\n  verbosity: string;\n  sectionsJson: Record<string, boolean>;\n  filtersJson: Record<string, number>;\n}\n\ninterface BotData {\n  id: number;\n  userId: string;\n  key: string;\n  name: string;\n  isEnabled: boolean;\n  createdAt: string;\n  settings: BotSettings | null;\n}\n\nconst iconMap: Record<string, typeof Newspaper> = {\n  Newspaper, Eye, Scale, GraduationCap, ShoppingBag, MessageSquare, TrendingUp, Users, Search, Briefcase, BookOpen, Building2, PenTool, Laptop, Store, ShoppingCart,\n};\n\nconst topicColors: Record<string, string> = {\n  investing: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  ai_art: \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n  tech: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  crypto: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\",\n  creative: \"bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200\",\n  community_research: \"bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200\",\n  market_brief: \"bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200\",\n  research_watch: \"bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200\",\n  competitor_watch: \"bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200\",\n  content_research: \"bg-violet-100 text-violet-800 dark:bg-violet-900 dark:text-violet-200\",\n  work_productivity: \"bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200\",\n  online_business: \"bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200\",\n  korea_marketplace: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n};\n\nconst outputTypeColors: Record<string, string> = {\n  report: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  draft: \"bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200\",\n  alert: \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200\",\n};\n\nexport default function Profiles() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { t } = useLanguage();\n\n  const [wizardOpen, setWizardOpen] = useState(false);\n  const [wizardStep, setWizardStep] = useState<\"preset\" | \"topic\" | \"configure\">(\"preset\");\n  const [selectedPreset, setSelectedPreset] = useState<Preset | null>(null);\n  const [selectedTopic, setSelectedTopic] = useState(\"\");\n  const [botName, setBotName] = useState(\"\");\n  const [selectedSourceUrls, setSelectedSourceUrls] = useState<Set<string>>(new Set());\n  const [customSources, setCustomSources] = useState<SuggestedSource[]>([]);\n  const [customSourceUrl, setCustomSourceUrl] = useState(\"\");\n  const [customSourceName, setCustomSourceName] = useState(\"\");\n  const [customTopicInput, setCustomTopicInput] = useState(\"\");\n\n  const { data: botsResponse, isLoading: botsLoading } = useQuery<{ bots: BotData[] }>({\n    queryKey: [\"/api/bots\"],\n  });\n  const botsList = botsResponse?.bots ?? [];\n\n  const { data: presets = [], isLoading: presetsLoading } = useQuery<Preset[]>({\n    queryKey: [\"/api/presets\"],\n  });\n\n  const createFromPresetMutation = useMutation({\n    mutationFn: async (data: { presetId: number; name: string; topic: string; selectedSourceUrls: string[]; customSources?: SuggestedSource[] }) => {\n      return apiRequest(\"POST\", \"/api/bots/from-preset\", data);\n    },\n    onSuccess: async (response) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\"] });\n      const data = await response.json();\n      toast({ title: t(\"profiles.botCreated\") });\n      resetWizard();\n      if (data?.bot?.id) {\n        setLocation(`/bots/${data.bot.id}`);\n      }\n    },\n    onError: (error: any) => {\n      let msg = t(\"profiles.botCreateFailed\");\n      try {\n        const errStr = error?.message || \"\";\n        const jsonStart = errStr.indexOf(\"{\");\n        if (jsonStart >= 0) {\n          const parsed = JSON.parse(errStr.slice(jsonStart));\n          msg = parsed?.error || msg;\n        }\n      } catch {}\n      toast({ title: msg, variant: \"destructive\" });\n    },\n  });\n\n  const toggleBotMutation = useMutation({\n    mutationFn: async ({ id, isEnabled }: { id: number; isEnabled: boolean }) => {\n      return apiRequest(\"PATCH\", `/api/bots/${id}`, { isEnabled });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\"] });\n    },\n  });\n\n  const deleteBotMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/bots/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\"] });\n      toast({ title: t(\"profiles.botDeleted\") });\n    },\n  });\n\n  const resetWizard = () => {\n    setWizardOpen(false);\n    setWizardStep(\"preset\");\n    setSelectedPreset(null);\n    setSelectedTopic(\"\");\n    setBotName(\"\");\n    setSelectedSourceUrls(new Set());\n    setCustomSources([]);\n    setCustomSourceUrl(\"\");\n    setCustomSourceName(\"\");\n    setCustomTopicInput(\"\");\n  };\n\n  const pickDefaultSources = (allSources: SuggestedSource[], topic: string): Set<string> => {\n    const topicSources = allSources.filter(s => s.topic === topic);\n    return new Set(topicSources.map(s => s.url));\n  };\n\n  const addCustomSource = () => {\n    const url = customSourceUrl.trim();\n    if (!url) return;\n    if (selectedSourceUrls.has(url) || customSources.some(s => s.url === url)) {\n      toast({ title: t(\"profiles.urlAlreadyAdded\"), variant: \"destructive\" });\n      return;\n    }\n    try {\n      new URL(url);\n    } catch {\n      toast({ title: t(\"profiles.invalidUrl\"), variant: \"destructive\" });\n      return;\n    }\n    const name = customSourceName.trim() || new URL(url).hostname;\n    const newSource: SuggestedSource = { name, url, topic: selectedTopic };\n    setCustomSources(prev => [...prev, newSource]);\n    setSelectedSourceUrls(prev => new Set([...Array.from(prev), url]));\n    setCustomSourceUrl(\"\");\n    setCustomSourceName(\"\");\n  };\n\n  const handlePresetSelect = (preset: Preset) => {\n    setSelectedPreset(preset);\n    const variants = preset.variantsJson || [];\n    if (variants.length === 1) {\n      setSelectedTopic(variants[0]);\n      setBotName(`My ${preset.name}`);\n      const suggestedSources = preset.defaultConfigJson?.suggestedSources || [];\n      setSelectedSourceUrls(pickDefaultSources(suggestedSources, variants[0]));\n      setWizardStep(\"configure\");\n    } else if (variants.length > 1) {\n      setWizardStep(\"topic\");\n    } else {\n      setSelectedTopic(\"general\");\n      setBotName(`My ${preset.name}`);\n      setSelectedSourceUrls(new Set());\n      setWizardStep(\"configure\");\n    }\n  };\n\n  const handleTopicSelect = (topic: string) => {\n    setSelectedTopic(topic);\n    setBotName(`My ${selectedPreset?.name} - ${topic}`);\n    const suggestedSources = selectedPreset?.defaultConfigJson?.suggestedSources || [];\n    setSelectedSourceUrls(pickDefaultSources(suggestedSources, topic));\n    setWizardStep(\"configure\");\n  };\n\n  const handleCreate = () => {\n    if (!selectedPreset || !botName || !selectedTopic) return;\n    createFromPresetMutation.mutate({\n      presetId: selectedPreset.id,\n      name: botName,\n      topic: selectedTopic,\n      selectedSourceUrls: Array.from(selectedSourceUrls),\n      customSources: customSources.filter(s => selectedSourceUrls.has(s.url)),\n    });\n  };\n\n  const toggleSourceUrl = (url: string) => {\n    setSelectedSourceUrls(prev => {\n      const next = new Set(prev);\n      if (next.has(url)) next.delete(url);\n      else next.add(url);\n      return next;\n    });\n  };\n\n  const getPresetIcon = (iconName: string | null) => {\n    const IconComponent = iconName ? iconMap[iconName] : Sparkles;\n    return IconComponent || Sparkles;\n  };\n\n  const getCategoryLabel = (category: string): string => {\n    const categoryKey = `profiles.category.${category}`;\n    const translated = t(categoryKey);\n    if (translated !== categoryKey) return translated;\n    const fallback: Record<string, string> = {\n      information: \"Information\",\n      business: \"Business\",\n      compliance: \"Compliance\",\n      research: \"Research\",\n      commerce: \"Commerce\",\n      engagement: \"Engagement\",\n      finance: \"Finance\",\n      work: \"Work\",\n    };\n    return fallback[category] || category;\n  };\n\n  const uniqueCategories = Array.from(new Set(presets.map(p => p.category).filter((c): c is string => c !== null && c !== undefined)));\n\n  if (botsLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-6xl\">\n      {botsList.length > 0 && (\n        <div className=\"mb-8\">\n          <div className=\"flex items-center justify-between gap-4 mb-4 flex-wrap\">\n            <div>\n              <h1 className=\"text-2xl font-bold\" data-testid=\"text-page-title\">{t(\"profiles.title\")}</h1>\n              <p className=\"text-muted-foreground\">{t(\"profiles.subtitle\")}</p>\n            </div>\n          </div>\n\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            {botsList.map((bot) => (\n              <Card key={bot.id} className=\"overflow-visible\" data-testid={`bot-card-${bot.id}`}>\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div className=\"flex-1 min-w-0\">\n                      <CardTitle className=\"text-lg truncate\" data-testid={`text-bot-name-${bot.id}`}>{bot.name}</CardTitle>\n                      <CardDescription className=\"flex items-center gap-2 mt-1 flex-wrap\">\n                        <Badge className={topicColors[bot.key] || \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200\"} data-testid={`badge-bot-key-${bot.id}`}>{bot.key}</Badge>\n                      </CardDescription>\n                    </div>\n                    <Switch\n                      checked={bot.isEnabled}\n                      onCheckedChange={(checked) => toggleBotMutation.mutate({ id: bot.id, isEnabled: checked })}\n                      data-testid={`toggle-bot-${bot.id}`}\n                    />\n                  </div>\n                </CardHeader>\n                <CardContent className=\"pt-0\">\n                  {bot.settings && (\n                    <div className=\"text-sm text-muted-foreground mb-3 space-y-1\">\n                      <div className=\"flex items-center gap-1.5\">\n                        <Clock className=\"h-3.5 w-3.5\" />\n                        <span>{bot.settings.scheduleRule} at {bot.settings.scheduleTimeLocal}</span>\n                      </div>\n                      <div className=\"flex items-center gap-1.5\">\n                        <FileText className=\"h-3.5 w-3.5\" />\n                        <span>{bot.settings.markdownLevel === \"minimal\" ? \"Conversational\" : \"Structured\"} / {bot.settings.verbosity}</span>\n                      </div>\n                    </div>\n                  )}\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"flex-1\"\n                      onClick={() => setLocation(`/bots/${bot.id}`)}\n                      data-testid={`button-edit-bot-${bot.id}`}\n                    >\n                      <Settings className=\"h-4 w-4 mr-1\" />\n                      {t(\"sidebar.settings\")}\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => {\n                        if (confirm(t(\"profiles.deleteConfirm\"))) {\n                          deleteBotMutation.mutate(bot.id);\n                        }\n                      }}\n                      disabled={deleteBotMutation.isPending}\n                      data-testid={`button-delete-bot-${bot.id}`}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n\n            <Card\n              className=\"overflow-visible border-dashed hover-elevate cursor-pointer flex items-center justify-center min-h-[160px]\"\n              onClick={() => setWizardOpen(true)}\n              data-testid=\"card-add-bot\"\n            >\n              <div className=\"text-center p-6\">\n                <Plus className=\"h-8 w-8 mx-auto mb-2 text-muted-foreground\" />\n                <p className=\"font-medium text-sm\">{t(\"profiles.createNew\")}</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">{t(\"profiles.createNewDesc\")}</p>\n              </div>\n            </Card>\n          </div>\n        </div>\n      )}\n\n      {botsList.length === 0 && (\n        <div className=\"mb-8\">\n          <div className=\"text-center py-12\">\n            <BotIcon className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n            <h1 className=\"text-2xl font-bold mb-2\" data-testid=\"text-page-title\">{t(\"profiles.noBots\")}</h1>\n            <p className=\"text-muted-foreground mb-6 max-w-lg mx-auto\" data-testid=\"text-empty-state-message\">\n              {t(\"profiles.noBotsDesc\")}\n            </p>\n            <div className=\"flex items-center justify-center gap-3 flex-wrap\">\n              <Button onClick={() => setWizardOpen(true)} data-testid=\"button-start-from-template\">\n                <Sparkles className=\"h-4 w-4 mr-2\" />\n                {t(\"profiles.startTemplate\")}\n              </Button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <div className=\"mb-4\">\n        <h2 className=\"text-xl font-bold\" data-testid=\"text-gallery-title\">{t(\"profiles.galleryTitle\")}</h2>\n        <p className=\"text-muted-foreground text-sm\" data-testid=\"text-gallery-subtitle\">\n          {t(\"profiles.gallerySubtitle\")}\n        </p>\n      </div>\n\n      {presetsLoading && (\n        <div className=\"flex items-center justify-center h-32\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        </div>\n      )}\n\n      {!presetsLoading && presets.length === 0 && (\n        <Card className=\"overflow-visible\">\n          <CardContent className=\"p-8 text-center text-muted-foreground\">\n            {t(\"profiles.noTemplates\")}\n          </CardContent>\n        </Card>\n      )}\n\n      {uniqueCategories.map(category => {\n        const categoryPresets = presets.filter(p => p.category === category);\n        if (categoryPresets.length === 0) return null;\n        return (\n          <div key={category} className=\"mb-6\">\n            <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">\n              {getCategoryLabel(category)}\n            </h3>\n            <div className=\"grid gap-3 md:grid-cols-2 lg:grid-cols-3\">\n              {categoryPresets.map(preset => {\n                const Icon = getPresetIcon(preset.icon);\n                return (\n                  <Card\n                    key={preset.id}\n                    className=\"overflow-visible hover-elevate cursor-pointer\"\n                    onClick={() => { handlePresetSelect(preset); setWizardOpen(true); }}\n                    data-testid={`preset-card-${preset.key}`}\n                  >\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-start gap-3\">\n                        <div className=\"p-2 rounded-md bg-primary/10 shrink-0\">\n                          <Icon className=\"h-5 w-5 text-primary\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center justify-between gap-3\">\n                            <h4 className=\"font-medium text-sm\" data-testid={`text-preset-name-${preset.key}`}>{preset.name}</h4>\n                            <ChevronRight className=\"h-4 w-4 text-muted-foreground shrink-0\" />\n                          </div>\n                          <p className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">{preset.description}</p>\n                          <div className=\"mt-2 space-y-1 text-xs text-muted-foreground\">\n                            <div className=\"flex items-center gap-1.5\">\n                              <Rss className=\"h-3 w-3 shrink-0\" />\n                              <span>{t(\"profiles.sources\", { count: (preset.defaultConfigJson?.suggestedSources || []).length })}</span>\n                            </div>\n                            <div className=\"flex items-center gap-1.5\">\n                              <Clock className=\"h-3 w-3 shrink-0\" />\n                              <span>{t(\"profiles.output\", { type: preset.outputType })}</span>\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-1.5 mt-2 flex-wrap\">\n                            {(preset.variantsJson || []).slice(0, 3).map(v => (\n                              <Badge key={v} variant=\"outline\" className=\"text-xs\">{v}</Badge>\n                            ))}\n                          </div>\n                          <p className=\"text-xs text-primary font-medium mt-2\" data-testid={`link-preset-start-${preset.key}`}>\n                            {t(\"profiles.startWith\")} &rarr;\n                          </p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          </div>\n        );\n      })}\n\n      {presets.filter(p => !p.category).length > 0 && (\n        <div className=\"mb-6\">\n          <h3 className=\"text-sm font-medium text-muted-foreground uppercase tracking-wider mb-3\">{t(\"profiles.other\")}</h3>\n          <div className=\"grid gap-3 md:grid-cols-2 lg:grid-cols-3\">\n            {presets.filter(p => !p.category).map(preset => {\n              const Icon = getPresetIcon(preset.icon);\n              return (\n                <Card\n                  key={preset.id}\n                  className=\"overflow-visible hover-elevate cursor-pointer\"\n                  onClick={() => { handlePresetSelect(preset); setWizardOpen(true); }}\n                  data-testid={`preset-card-${preset.key}`}\n                >\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start gap-3\">\n                      <div className=\"p-2 rounded-md bg-primary/10 shrink-0\">\n                        <Icon className=\"h-5 w-5 text-primary\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center justify-between gap-3\">\n                          <h4 className=\"font-medium text-sm\">{preset.name}</h4>\n                          <ChevronRight className=\"h-4 w-4 text-muted-foreground shrink-0\" />\n                        </div>\n                        <p className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">{preset.description}</p>\n                        <div className=\"flex items-center gap-1.5 mt-2 flex-wrap\">\n                          <Badge className={`${outputTypeColors[preset.outputType]} text-xs`}>{preset.outputType}</Badge>\n                        </div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        </div>\n      )}\n\n      <Dialog open={wizardOpen} onOpenChange={(open) => open ? setWizardOpen(true) : resetWizard()}>\n        <DialogContent className=\"sm:max-w-lg max-h-[85vh] flex flex-col\">\n          <DialogHeader>\n            <DialogTitle>\n              {wizardStep === \"preset\" && t(\"profiles.wizard.chooseTemplate\")}\n              {wizardStep === \"topic\" && t(\"profiles.wizard.selectTopic\")}\n              {wizardStep === \"configure\" && t(\"profiles.wizard.configure\")}\n            </DialogTitle>\n            <DialogDescription>\n              {wizardStep === \"preset\" && t(\"profiles.wizard.chooseTemplateDesc\")}\n              {wizardStep === \"topic\" && t(\"profiles.wizard.selectTopicDesc\", { name: selectedPreset?.name || \"\" })}\n              {wizardStep === \"configure\" && t(\"profiles.wizard.configureDesc\")}\n            </DialogDescription>\n          </DialogHeader>\n\n          {wizardStep === \"preset\" && (\n            <div className=\"grid gap-3 py-2 max-h-[400px] overflow-y-auto\">\n              {presets.map((preset) => {\n                const Icon = getPresetIcon(preset.icon);\n                return (\n                  <div\n                    key={preset.id}\n                    className=\"p-3 rounded-md border border-border hover-elevate cursor-pointer\"\n                    onClick={() => handlePresetSelect(preset)}\n                    data-testid={`wizard-preset-${preset.key}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"p-2 rounded-md bg-primary/10 shrink-0\">\n                        <Icon className=\"h-4 w-4 text-primary\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <h4 className=\"font-medium text-sm\">{preset.name}</h4>\n                        <p className=\"text-xs text-muted-foreground truncate\">{preset.description}</p>\n                      </div>\n                      <Badge className={`${outputTypeColors[preset.outputType]} text-xs`}>{preset.outputType}</Badge>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n\n          {wizardStep === \"topic\" && selectedPreset && (\n            <div className=\"grid gap-3 py-2\">\n              {(selectedPreset.variantsJson || []).map((topic) => (\n                <Button\n                  key={topic}\n                  variant=\"outline\"\n                  className=\"justify-start\"\n                  onClick={() => handleTopicSelect(topic)}\n                  data-testid={`wizard-topic-${topic}`}\n                >\n                  <Badge className={`mr-2 ${topicColors[topic] || \"\"}`}>{topic}</Badge>\n                  {topic.charAt(0).toUpperCase() + topic.slice(1).replace(/_/g, \" \")}\n                </Button>\n              ))}\n\n              <div className=\"mt-2 pt-3 border-t border-border space-y-2\">\n                <Label className=\"text-xs text-muted-foreground\">{t(\"profiles.wizard.customTopicLabel\")}</Label>\n                <div className=\"flex gap-2\">\n                  <Input\n                    value={customTopicInput}\n                    onChange={(e) => {\n                      const sanitized = e.target.value\n                        .toLowerCase()\n                        .replace(/\\s+/g, \"_\")\n                        .replace(/[^a-z0-9_]/g, \"\")\n                        .replace(/_{2,}/g, \"_\")\n                        .replace(/^_+/, \"\");\n                      setCustomTopicInput(sanitized);\n                    }}\n                    placeholder={t(\"profiles.wizard.customTopicPlaceholder\")}\n                    data-testid=\"input-wizard-custom-topic\"\n                  />\n                  <Button\n                    variant=\"outline\"\n                    disabled={\n                      !customTopicInput ||\n                      customTopicInput.length < 2 ||\n                      (selectedPreset?.variantsJson || []).includes(customTopicInput) ||\n                      botsList.some(b => b.key === customTopicInput)\n                    }\n                    onClick={() => {\n                      const cleaned = customTopicInput.replace(/_+$/, \"\");\n                      if (cleaned.length >= 2) {\n                        handleTopicSelect(cleaned);\n                        setCustomTopicInput(\"\");\n                      }\n                    }}\n                    data-testid=\"button-wizard-custom-topic-add\"\n                  >\n                    {t(\"profiles.wizard.customTopicUse\")}\n                  </Button>\n                </div>\n                {customTopicInput && botsList.some(b => b.key === customTopicInput) && (\n                  <p className=\"text-xs text-destructive\">{t(\"profiles.wizard.customTopicDuplicate\")}</p>\n                )}\n                <p className=\"text-xs text-muted-foreground\">{t(\"profiles.wizard.customTopicHint\")}</p>\n              </div>\n\n              <Button variant=\"ghost\" size=\"sm\" onClick={() => setWizardStep(\"preset\")} data-testid=\"button-wizard-back\">\n                <ArrowLeft className=\"h-4 w-4 mr-1\" /> {t(\"profiles.wizard.back\")}\n              </Button>\n            </div>\n          )}\n\n          {wizardStep === \"configure\" && selectedPreset && (\n            <div className=\"flex flex-col min-h-0 flex-1\">\n            <div className=\"space-y-4 py-2 overflow-y-auto flex-1 min-h-0 pr-1\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"bot-name\">{t(\"profiles.wizard.botName\")}</Label>\n                <Input\n                  id=\"bot-name\"\n                  value={botName}\n                  onChange={(e) => setBotName(e.target.value)}\n                  placeholder=\"Enter bot name\"\n                  data-testid=\"input-wizard-bot-name\"\n                />\n              </div>\n\n              <div className=\"flex items-center gap-2\">\n                <Label>{t(\"profiles.wizard.topic\")}:</Label>\n                <Badge className={topicColors[selectedTopic] || \"\"} data-testid=\"badge-wizard-topic\">{selectedTopic}</Badge>\n                <Label className=\"text-muted-foreground text-xs\">|</Label>\n                <Label className=\"text-muted-foreground text-xs\">\n                  {t(\"profiles.output\", { type: selectedPreset.outputType })}\n                </Label>\n              </div>\n\n              {selectedPreset.defaultConfigJson && (\n                <div className=\"rounded-md bg-muted/50 p-3 space-y-1 text-sm\">\n                  <p className=\"font-medium text-xs text-muted-foreground uppercase tracking-wider mb-2\">Pre-filled Settings</p>\n                  <div className=\"flex items-center gap-1.5 text-muted-foreground\">\n                    <Clock className=\"h-3.5 w-3.5\" />\n                    <span>{selectedPreset.defaultConfigJson.scheduleRule || \"DAILY\"} at {selectedPreset.defaultConfigJson.scheduleTimeLocal || \"07:00\"}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1.5 text-muted-foreground\">\n                    <FileText className=\"h-3.5 w-3.5\" />\n                    <span>{selectedPreset.defaultConfigJson.markdownLevel === \"minimal\" ? \"Conversational\" : \"Structured\"} / {selectedPreset.defaultConfigJson.verbosity || \"normal\"}</span>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground italic mt-1\">You can change all settings after creation</p>\n                </div>\n              )}\n\n              {(() => {\n                const allSources = selectedPreset.defaultConfigJson?.suggestedSources || [];\n                const topicSources = allSources.filter(s => s.topic === selectedTopic);\n                const allDisplaySources = [...topicSources, ...customSources];\n                const renderSourceRow = (source: SuggestedSource, isCustom = false) => (\n                  <div\n                    key={source.url}\n                    className=\"flex items-center gap-3 p-2 rounded-md border border-border\"\n                    data-testid={`source-checkbox-${source.name.replace(/\\s/g, '-').toLowerCase()}`}\n                  >\n                    <Checkbox\n                      checked={selectedSourceUrls.has(source.url)}\n                      onCheckedChange={() => toggleSourceUrl(source.url)}\n                      id={`source-${source.url}`}\n                    />\n                    <label htmlFor={`source-${source.url}`} className=\"flex-1 cursor-pointer min-w-0\">\n                      <span className=\"text-sm font-medium\">{source.name}</span>\n                      {isCustom && <Badge variant=\"outline\" className=\"ml-2 text-xs\">custom</Badge>}\n                    </label>\n                    {isCustom && (\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-6 w-6 shrink-0\"\n                        onClick={(e) => {\n                          e.preventDefault();\n                          setCustomSources(prev => prev.filter(s => s.url !== source.url));\n                          setSelectedSourceUrls(prev => {\n                            const next = new Set(prev);\n                            next.delete(source.url);\n                            return next;\n                          });\n                        }}\n                        data-testid={`button-remove-custom-source-${source.name.replace(/\\s/g, '-').toLowerCase()}`}\n                      >\n                        <Trash2 className=\"h-3 w-3\" />\n                      </Button>\n                    )}\n                  </div>\n                );\n                return (\n                <div className=\"space-y-3\">\n                  <div className=\"space-y-2\">\n                    <Label className=\"flex items-center gap-1.5\">\n                      <Rss className=\"h-4 w-4\" />\n                      {t(\"profiles.wizard.defaultSources\")}\n                    </Label>\n                    <p className=\"text-xs text-muted-foreground\" data-testid=\"text-source-disclaimer\">\n                      {selectedPreset?.defaultConfigJson?.sourceDisclaimer || t(\"profiles.wizard.sourceDisclaimer\")}\n                    </p>\n                    {allDisplaySources.length > 0 ? (\n                      <div className=\"space-y-1.5\">\n                        {topicSources.map(s => renderSourceRow(s, false))}\n                        {customSources.map(s => renderSourceRow(s, true))}\n                      </div>\n                    ) : (\n                      <p className=\"text-xs text-muted-foreground italic\">No default sources for this topic. Add your own below.</p>\n                    )}\n                  </div>\n\n                  <div className=\"space-y-2 pt-1 border-t border-border\">\n                    <Label className=\"flex items-center gap-1.5 text-sm\">\n                      <Link2 className=\"h-4 w-4\" />\n                      {t(\"profiles.wizard.customSourceUrl\")}\n                    </Label>\n                    <div className=\"flex gap-2\">\n                      <Input\n                        placeholder={t(\"profiles.wizard.customSourceName\")}\n                        value={customSourceName}\n                        onChange={(e) => setCustomSourceName(e.target.value)}\n                        className=\"flex-1\"\n                        data-testid=\"input-custom-source-name\"\n                      />\n                    </div>\n                    <div className=\"flex gap-2\">\n                      <Input\n                        placeholder={t(\"profiles.wizard.customSourceUrlPlaceholder\")}\n                        value={customSourceUrl}\n                        onChange={(e) => setCustomSourceUrl(e.target.value)}\n                        onKeyDown={(e) => { if (e.key === \"Enter\") { e.preventDefault(); addCustomSource(); } }}\n                        className=\"flex-1\"\n                        data-testid=\"input-custom-source-url\"\n                      />\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={addCustomSource}\n                        disabled={!customSourceUrl.trim()}\n                        data-testid=\"button-add-custom-source\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-1\" />\n                        {t(\"profiles.wizard.addSource\")}\n                      </Button>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">You can also add more sources after creating the bot.</p>\n                  </div>\n                </div>\n                );\n              })()}\n            </div>\n\n              <div className=\"flex gap-2 justify-end pt-3 border-t border-border shrink-0\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => {\n                    if (selectedPreset.variantsJson.length > 1) setWizardStep(\"topic\");\n                    else setWizardStep(\"preset\");\n                  }}\n                  data-testid=\"button-wizard-back-configure\"\n                >\n                  <ArrowLeft className=\"h-4 w-4 mr-1\" /> {t(\"profiles.wizard.back\")}\n                </Button>\n                <Button\n                  onClick={handleCreate}\n                  disabled={!botName || createFromPresetMutation.isPending}\n                  data-testid=\"button-wizard-create\"\n                >\n                  {createFromPresetMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                  {createFromPresetMutation.isPending ? t(\"profiles.wizard.creating\") : t(\"profiles.wizard.createBot\")}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":35075,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"/{*path}\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1541,"size_tokens":null},"shared/chatCommand.ts":{"content":"export type ChatCommandType =\n  | \"list_bots\"\n  | \"switch_bot\"\n  | \"bot_status\"\n  | \"run_now\"\n  | \"pause_bot\"\n  | \"resume_bot\"\n  | \"add_source\"\n  | \"remove_source\"\n  | \"pipeline_run\"\n  | \"chat\";\n\nexport type RunNowTarget = \"collect\" | \"analyze\" | \"draft\" | \"report\";\n\nexport interface PipelineRunArgs {\n  scheduleTimeLocal?: string;\n  scheduleRule?: \"DAILY\" | \"WEEKDAYS\" | \"WEEKENDS\";\n  lookbackHours?: number;\n  maxItems?: number;\n  lang?: \"ko\" | \"en\";\n}\n\nexport type ChatCommand = {\n  type: ChatCommandType;\n  botKey: string | null;\n  args?: Record<string, any>;\n  confidence: number;\n  needsConfirm: boolean;\n  confirmText: string;\n};\n\nexport type MessageKind = \"text\" | \"pending_command\" | \"command_result\";\n","path":null,"size_bytes":712,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 0 0% 100%;\n  --foreground: 0 0% 9%;\n  --border: 0 0% 91%;\n  --card: 0 0% 98%;\n  --card-foreground: 0 0% 9%;\n  --card-border: 0 0% 95%;\n  --sidebar: 0 0% 96%;\n  --sidebar-foreground: 0 0% 9%;\n  --sidebar-border: 0 0% 93%;\n  --sidebar-primary: 217 91% 48%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 217 12% 86%;\n  --sidebar-accent-foreground: 0 0% 15%;\n  --sidebar-ring: 217 91% 48%;\n  --popover: 0 0% 94%;\n  --popover-foreground: 0 0% 9%;\n  --popover-border: 0 0% 90%;\n  --primary: 217 91% 48%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 217 8% 88%;\n  --secondary-foreground: 0 0% 12%;\n  --muted: 217 10% 90%;\n  --muted-foreground: 0 0% 38%;\n  --accent: 217 10% 92%;\n  --accent-foreground: 0 0% 12%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 0 0% 75%;\n  --ring: 217 91% 48%;\n  --chart-1: 217 91% 35%;\n  --chart-2: 197 84% 38%;\n  --chart-3: 280 65% 42%;\n  --chart-4: 45 93% 38%;\n  --chart-5: 142 76% 32%;\n  --font-sans: Open Sans, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 0 0% 9%;\n  --foreground: 0 0% 98%;\n  --border: 0 0% 18%;\n  --card: 0 0% 11%;\n  --card-foreground: 0 0% 98%;\n  --card-border: 0 0% 14%;\n  --sidebar: 0 0% 13%;\n  --sidebar-foreground: 0 0% 98%;\n  --sidebar-border: 0 0% 16%;\n  --sidebar-primary: 217 91% 58%;\n  --sidebar-primary-foreground: 0 0% 98%;\n  --sidebar-accent: 217 15% 20%;\n  --sidebar-accent-foreground: 0 0% 88%;\n  --sidebar-ring: 217 91% 58%;\n  --popover: 0 0% 15%;\n  --popover-foreground: 0 0% 98%;\n  --popover-border: 0 0% 18%;\n  --primary: 217 91% 48%;\n  --primary-foreground: 0 0% 98%;\n  --secondary: 217 12% 22%;\n  --secondary-foreground: 0 0% 92%;\n  --muted: 217 12% 18%;\n  --muted-foreground: 0 0% 68%;\n  --accent: 217 12% 16%;\n  --accent-foreground: 0 0% 92%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 0% 98%;\n  --input: 0 0% 35%;\n  --ring: 217 91% 58%;\n  --chart-1: 217 91% 68%;\n  --chart-2: 197 84% 65%;\n  --chart-3: 280 65% 72%;\n  --chart-4: 45 93% 68%;\n  --chart-5: 142 76% 65%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 1px 2px -1px hsl(0 0% 0% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 2px 4px -1px hsl(0 0% 0% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 4px 6px -1px hsl(0 0% 0% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00), 0px 8px 10px -1px hsl(0 0% 0% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(0 0% 0% / 0.00);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10552,"size_tokens":null},"client/src/lib/language-provider.tsx":{"content":"import { createContext, useContext, useCallback, useState, useEffect } from \"react\";\nimport { translations, type Language } from \"@/i18n\";\n\ntype LanguageContextType = {\n  language: Language;\n  setLanguage: (lang: Language) => void;\n  t: (key: string, params?: Record<string, string | number>) => string;\n};\n\nconst LanguageContext = createContext<LanguageContextType | undefined>(undefined);\n\nexport function LanguageProvider({\n  children,\n  defaultLanguage = \"en\",\n}: {\n  children: React.ReactNode;\n  defaultLanguage?: Language;\n}) {\n  const [language, setLanguageState] = useState<Language>(() => {\n    const stored = localStorage.getItem(\"language\") as Language;\n    return stored === \"en\" || stored === \"ko\" ? stored : defaultLanguage;\n  });\n\n  useEffect(() => {\n    localStorage.setItem(\"language\", language);\n    document.documentElement.lang = language;\n  }, [language]);\n\n  const setLanguage = useCallback((lang: Language) => {\n    setLanguageState(lang);\n  }, []);\n\n  const t = useCallback(\n    (key: string, params?: Record<string, string | number>): string => {\n      const dict = translations[language];\n      let value = dict[key] ?? translations[\"en\"][key] ?? key;\n      if (params) {\n        Object.entries(params).forEach(([k, v]) => {\n          value = value.replace(new RegExp(`\\\\{\\\\{${k}\\\\}\\\\}`, \"g\"), String(v));\n        });\n      }\n      return value;\n    },\n    [language]\n  );\n\n  return (\n    <LanguageContext.Provider value={{ language, setLanguage, t }}>\n      {children}\n    </LanguageContext.Provider>\n  );\n}\n\nexport const useLanguage = () => {\n  const context = useContext(LanguageContext);\n  if (context === undefined) {\n    throw new Error(\"useLanguage must be used within a LanguageProvider\");\n  }\n  return context;\n};\n","path":null,"size_bytes":1749,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/pages/chat.tsx":{"content":"import { useState, useRef, useEffect, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  MessageCircle, Send, Loader2, Bot, User, Check, X, Zap, CheckCircle2, AlertCircle,\n  Lightbulb, Clock, Rocket, ArrowRight, ChevronDown,\n  Search, Users, Target, MessageSquare, BarChart3, Eye, ShieldCheck,\n} from \"lucide-react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport type { MessageKind } from \"@shared/chatCommand\";\n\ninterface ChatThread {\n  id: number;\n  userId: string;\n  title: string | null;\n  activeBotId: number | null;\n  createdAt: string;\n}\n\ninterface ChatMessage {\n  id: number;\n  threadId: number | null;\n  userId: string;\n  role: \"user\" | \"assistant\";\n  contentText: string;\n  kind?: MessageKind;\n  commandJson?: any;\n  resultJson?: any;\n  status?: string;\n  createdAt: string;\n}\n\ninterface ActiveBotInfo {\n  id: number;\n  key: string;\n  name: string;\n}\n\ninterface ConsoleContext {\n  botCount: number;\n  activeBotId: number | null;\n  activeBotName: string | null;\n  activeBotTopic: string | null;\n  sourceCount: number;\n  lastCollectedAt: string | null;\n  scheduleRule: string | null;\n  scheduleTimeLocal: string | null;\n  isEnabled: boolean;\n  hasLlmProvider: boolean;\n  hasUserProviders: boolean;\n}\n\ntype ConsoleState = \"S0_NO_BOT\" | \"S1_NO_SOURCES\" | \"S2_NO_COLLECTION\" | \"S3_READY\" | \"S4_SCHEDULE_ISSUE\";\n\ntype HintCategory = \"first_run\" | \"schedule\";\ntype BotHintCategory = \"research\" | \"outreach\" | \"contribution\" | \"analysis\" | \"monitor\" | \"safety_promo\";\n\ninterface Hint {\n  key: string;\n  category: HintCategory;\n  states: ConsoleState[];\n}\n\ninterface BotHint {\n  key: string;\n  category: BotHintCategory;\n}\n\nconst CATEGORY_ICONS: Record<HintCategory, typeof Lightbulb> = {\n  first_run: Rocket,\n  schedule: Clock,\n};\n\nconst CATEGORY_LABEL_KEYS: Record<HintCategory, string> = {\n  first_run: \"chat.category.firstRun\",\n  schedule: \"chat.category.schedule\",\n};\n\nconst BOT_HINT_CATEGORY_ICONS: Record<BotHintCategory, typeof Lightbulb> = {\n  research: Search,\n  outreach: Target,\n  contribution: MessageSquare,\n  analysis: BarChart3,\n  monitor: Eye,\n  safety_promo: ShieldCheck,\n};\n\nconst BOT_HINT_CATEGORY_LABEL_KEYS: Record<BotHintCategory, string> = {\n  research: \"chat.botCategory.research\",\n  outreach: \"chat.botCategory.outreach\",\n  contribution: \"chat.botCategory.contribution\",\n  analysis: \"chat.botCategory.analysis\",\n  monitor: \"chat.botCategory.monitor\",\n  safety_promo: \"chat.botCategory.safetyPromo\",\n};\n\nconst COMMUNITY_RESEARCH_HINTS: BotHint[] = [\n  { key: \"chat.botHint.collectCommunity\", category: \"research\" },\n  { key: \"chat.botHint.findRedditNeeds\", category: \"research\" },\n  { key: \"chat.botHint.collectComplaints\", category: \"research\" },\n  { key: \"chat.botHint.analyzePatterns\", category: \"research\" },\n\n  { key: \"chat.botHint.organizeInvestor\", category: \"outreach\" },\n  { key: \"chat.botHint.collectQuestions\", category: \"outreach\" },\n  { key: \"chat.botHint.summarizeProblems\", category: \"outreach\" },\n\n  { key: \"chat.botHint.draftContribution\", category: \"contribution\" },\n  { key: \"chat.botHint.draftAutomationTip\", category: \"contribution\" },\n  { key: \"chat.botHint.draftRssTip\", category: \"contribution\" },\n\n  { key: \"chat.botHint.analyzeTrends\", category: \"analysis\" },\n  { key: \"chat.botHint.analyzeDemand\", category: \"analysis\" },\n  { key: \"chat.botHint.analyzePersonas\", category: \"analysis\" },\n\n  { key: \"chat.botHint.monitorReddit\", category: \"monitor\" },\n  { key: \"chat.botHint.trackCompetitors\", category: \"monitor\" },\n  { key: \"chat.botHint.dailyBriefing\", category: \"monitor\" },\n\n  { key: \"chat.botHint.noPromotion\", category: \"safety_promo\" },\n  { key: \"chat.botHint.authenticOnly\", category: \"safety_promo\" },\n  { key: \"chat.botHint.noLinksNoBrand\", category: \"safety_promo\" },\n];\n\nconst BOT_SPECIFIC_HINTS: Record<string, BotHint[]> = {\n  content_research: COMMUNITY_RESEARCH_HINTS,\n};\n\nconst ALL_HINTS: Hint[] = [\n  { key: \"chat.hint.listBots\", category: \"first_run\", states: [\"S0_NO_BOT\"] },\n  { key: \"chat.hint.switchBot\", category: \"first_run\", states: [\"S0_NO_BOT\"] },\n  { key: \"chat.hint.checkSetup\", category: \"first_run\", states: [\"S0_NO_BOT\", \"S1_NO_SOURCES\", \"S4_SCHEDULE_ISSUE\"] },\n\n  { key: \"chat.hint.addDefaultSources\", category: \"first_run\", states: [\"S1_NO_SOURCES\"] },\n  { key: \"chat.hint.addSourceUrl\", category: \"first_run\", states: [\"S1_NO_SOURCES\"] },\n\n  { key: \"chat.hint.botStatus\", category: \"first_run\", states: [\"S2_NO_COLLECTION\", \"S3_READY\"] },\n  { key: \"chat.hint.quickSummary\", category: \"first_run\", states: [\"S3_READY\"] },\n  { key: \"chat.hint.statusBriefing\", category: \"first_run\", states: [\"S3_READY\"] },\n\n  { key: \"chat.hint.scheduleDailyNine\", category: \"schedule\", states: [\"S2_NO_COLLECTION\", \"S3_READY\"] },\n  { key: \"chat.hint.changeScheduleEight\", category: \"schedule\", states: [\"S3_READY\", \"S4_SCHEDULE_ISSUE\"] },\n  { key: \"chat.hint.weekdaysOnly\", category: \"schedule\", states: [\"S3_READY\"] },\n\n  { key: \"chat.hint.checkReportIssue\", category: \"first_run\", states: [\"S4_SCHEDULE_ISSUE\"] },\n  { key: \"chat.hint.nextRunTime\", category: \"schedule\", states: [\"S4_SCHEDULE_ISSUE\"] },\n\n  { key: \"chat.hint.whatNext\", category: \"first_run\", states: [\"S0_NO_BOT\", \"S1_NO_SOURCES\", \"S2_NO_COLLECTION\", \"S3_READY\", \"S4_SCHEDULE_ISSUE\"] },\n  { key: \"chat.hint.pauseBot\", category: \"first_run\", states: [\"S3_READY\"] },\n];\n\nfunction computeConsoleState(ctx: ConsoleContext | undefined): ConsoleState {\n  if (!ctx) return \"S0_NO_BOT\";\n  if (ctx.botCount === 0 || !ctx.activeBotId) return \"S0_NO_BOT\";\n  if (ctx.sourceCount === 0) return \"S1_NO_SOURCES\";\n  if (!ctx.lastCollectedAt) return \"S2_NO_COLLECTION\";\n  const lastCollect = new Date(ctx.lastCollectedAt);\n  const hoursSince = (Date.now() - lastCollect.getTime()) / (1000 * 60 * 60);\n  if (hoursSince > 48) return \"S2_NO_COLLECTION\";\n  if (!ctx.hasLlmProvider || !ctx.isEnabled || !ctx.scheduleRule || !ctx.scheduleTimeLocal) return \"S4_SCHEDULE_ISSUE\";\n  return \"S3_READY\";\n}\n\nfunction getStateMessage(state: ConsoleState, t: (key: string) => string): string {\n  switch (state) {\n    case \"S0_NO_BOT\": return t(\"chat.state.noBot\");\n    case \"S1_NO_SOURCES\": return t(\"chat.state.noSources\");\n    case \"S2_NO_COLLECTION\": return t(\"chat.state.noCollection\");\n    case \"S3_READY\": return t(\"chat.state.ready\");\n    case \"S4_SCHEDULE_ISSUE\": return t(\"chat.state.scheduleIssue\");\n  }\n}\n\nfunction getPlaceholder(state: ConsoleState, t: (key: string) => string): string {\n  switch (state) {\n    case \"S0_NO_BOT\": return t(\"chat.placeholder.noBot\");\n    case \"S1_NO_SOURCES\": return t(\"chat.placeholder.noSources\");\n    case \"S2_NO_COLLECTION\": return t(\"chat.placeholder.noCollection\");\n    case \"S3_READY\": return t(\"chat.placeholder.ready\");\n    case \"S4_SCHEDULE_ISSUE\": return t(\"chat.placeholder.scheduleIssue\");\n  }\n}\n\nfunction getHintsForState(state: ConsoleState): Hint[] {\n  return ALL_HINTS.filter(h => h.states.includes(state));\n}\n\nfunction getPipelineStepLabel(step: string, t: (key: string) => string): string {\n  switch (step) {\n    case \"start\": return t(\"chat.pipeline.start\");\n    case \"collect\": return t(\"chat.pipeline.collect\");\n    case \"analyze\": return t(\"chat.pipeline.analyze\");\n    case \"report\": return t(\"chat.pipeline.report\");\n    case \"schedule\": return t(\"chat.pipeline.schedule\");\n    case \"timeout\": return t(\"chat.pipeline.timeout\");\n    default: return step;\n  }\n}\n\nfunction getPipelineProgressLabel(completedSteps: string[], ko: boolean): string {\n  const last = completedSteps[completedSteps.length - 1];\n  if (!last) return ko ? \"자료 수집 중...\" : \"Collecting data...\";\n  switch (last) {\n    case \"start\": return ko ? \"자료 수집 중...\" : \"Collecting data...\";\n    case \"schedule\": return ko ? \"자료 수집 중...\" : \"Collecting data...\";\n    case \"collect\": return ko ? \"브리핑 생성 중...\" : \"Generating briefing...\";\n    case \"analyze\": return ko ? \"브리핑 생성 중...\" : \"Generating briefing...\";\n    case \"report\": return ko ? \"마무리 중...\" : \"Finishing up...\";\n    case \"timeout\": return ko ? \"완료\" : \"Done\";\n    default: return ko ? \"처리 중...\" : \"Processing...\";\n  }\n}\n\nfunction ConfirmButtons({\n  messageId,\n  onConfirm,\n  onCancel,\n  isPending,\n}: {\n  messageId: number;\n  onConfirm: (id: number) => void;\n  onCancel: (id: number) => void;\n  isPending: boolean;\n}) {\n  const { t } = useLanguage();\n  return (\n    <div className=\"flex gap-2 mt-2\">\n      <Button\n        size=\"sm\"\n        onClick={() => onConfirm(messageId)}\n        disabled={isPending}\n        data-testid={`button-confirm-${messageId}`}\n      >\n        {isPending ? <Loader2 className=\"h-3 w-3 animate-spin mr-1\" /> : <Check className=\"h-3 w-3 mr-1\" />}\n        {t(\"chat.confirm\")}\n      </Button>\n      <Button\n        size=\"sm\"\n        variant=\"outline\"\n        onClick={() => onCancel(messageId)}\n        disabled={isPending}\n        data-testid={`button-cancel-${messageId}`}\n      >\n        <X className=\"h-3 w-3 mr-1\" />\n        {t(\"chat.cancel\")}\n      </Button>\n    </div>\n  );\n}\n\nfunction MessageBubble({\n  message,\n  onConfirm,\n  onCancel,\n  isConfirming,\n}: {\n  message: ChatMessage;\n  onConfirm: (id: number) => void;\n  onCancel: (id: number) => void;\n  isConfirming: boolean;\n}) {\n  const { t } = useLanguage();\n  const isUser = message.role === \"user\";\n  const isPending = message.status === \"pending_confirm\";\n  const kind = message.kind || \"text\";\n\n  return (\n    <div\n      className={`flex gap-3 ${isUser ? \"flex-row-reverse\" : \"\"}`}\n      data-testid={`message-${message.id}`}\n    >\n      <div\n        className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${\n          isUser\n            ? \"bg-primary text-primary-foreground\"\n            : \"bg-muted text-muted-foreground\"\n        }`}\n      >\n        {isUser ? <User className=\"h-4 w-4\" /> : <Bot className=\"h-4 w-4\" />}\n      </div>\n      <div\n        className={`max-w-[80%] rounded-lg px-4 py-2 ${\n          isUser\n            ? \"bg-primary text-primary-foreground\"\n            : \"bg-muted\"\n        }`}\n      >\n        <p className=\"text-sm whitespace-pre-wrap\">{message.contentText}</p>\n        {kind === \"command_result\" && message.commandJson && (\n          <Badge variant=\"outline\" className=\"mt-2 text-xs\">\n            {message.commandJson.type === \"pipeline_step\" ? (\n              <span className=\"flex items-center gap-1\">\n                {message.resultJson?.ok ? <CheckCircle2 className=\"h-3 w-3\" /> : <AlertCircle className=\"h-3 w-3\" />}\n                {getPipelineStepLabel(message.commandJson.step, t)}\n              </span>\n            ) : message.commandJson.type === \"pipeline_run\" ? (\n              <span className=\"flex items-center gap-1\">\n                <Zap className=\"h-3 w-3\" />\n                Pipeline\n              </span>\n            ) : (\n              message.commandJson.type || message.commandJson.action\n            )}\n          </Badge>\n        )}\n        {kind === \"pending_command\" && isPending && (\n          <div>\n            <Badge variant=\"secondary\" className=\"mt-2 text-xs\">\n              <Zap className=\"h-3 w-3 mr-1\" />\n              {message.commandJson?.type}\n            </Badge>\n            <ConfirmButtons\n              messageId={message.id}\n              onConfirm={onConfirm}\n              onCancel={onCancel}\n              isPending={isConfirming}\n            />\n          </div>\n        )}\n        {!kind && message.commandJson && !isPending && (\n          <Badge variant=\"outline\" className=\"mt-2 text-xs\">\n            {message.commandJson.type}\n          </Badge>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction HintChip({ hint, onClick, location, index }: { hint: Hint; onClick: (text: string) => void; location: string; index: number }) {\n  const Icon = CATEGORY_ICONS[hint.category];\n  const { t } = useLanguage();\n  const text = t(hint.key);\n  return (\n    <button\n      type=\"button\"\n      className=\"flex items-center gap-2 px-3 py-2 text-left text-sm rounded-md bg-muted/50 hover-elevate active-elevate-2 transition-colors w-full\"\n      onClick={() => onClick(text)}\n      data-testid={`hint-chip-${location}-${index}`}\n    >\n      <Icon className=\"h-3.5 w-3.5 text-muted-foreground shrink-0\" />\n      <span className=\"text-muted-foreground\">{text}</span>\n    </button>\n  );\n}\n\nfunction BotHintChip({ hint, onClick, index }: { hint: BotHint; onClick: (text: string) => void; index: number }) {\n  const Icon = BOT_HINT_CATEGORY_ICONS[hint.category];\n  const { t } = useLanguage();\n  const text = t(hint.key);\n  return (\n    <button\n      type=\"button\"\n      className=\"flex items-center gap-2 px-3 py-2 text-left text-sm rounded-md bg-muted/50 hover-elevate active-elevate-2 transition-colors w-full\"\n      onClick={() => onClick(text)}\n      data-testid={`bot-hint-chip-${index}`}\n    >\n      <Icon className=\"h-3.5 w-3.5 text-muted-foreground shrink-0\" />\n      <span className=\"text-muted-foreground\">{text}</span>\n    </button>\n  );\n}\n\nfunction OnboardingView({\n  state,\n  hints,\n  onHintClick,\n}: {\n  state: ConsoleState;\n  hints: Hint[];\n  onHintClick: (text: string) => void;\n}) {\n  const { t } = useLanguage();\n  const topHints = hints.slice(0, 6);\n  const stateMsg = getStateMessage(state, t);\n\n  return (\n    <div className=\"flex flex-col items-center justify-center h-full px-4\">\n      <div className=\"max-w-lg w-full\">\n        <div className=\"text-center mb-6\">\n          <Lightbulb className=\"h-10 w-10 text-muted-foreground mx-auto mb-3\" />\n          <h3 className=\"text-lg font-medium\" data-testid=\"text-onboarding-title\">\n            {stateMsg}\n          </h3>\n          <p className=\"text-sm text-muted-foreground mt-1\">\n            {t(\"chat.onboardingSubtitle\")}\n          </p>\n        </div>\n\n        <div className=\"space-y-2\" data-testid=\"onboarding-hints\">\n          {topHints.map((hint, i) => (\n            <HintChip key={i} hint={hint} onClick={onHintClick} location=\"onboarding\" index={i} />\n          ))}\n        </div>\n\n        <div className=\"mt-6 pt-4 border-t border-border text-center\">\n          <p className=\"text-xs text-muted-foreground\">\n            Type anything in plain language — Korean or English\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction HintDropdown({\n  hints,\n  visible,\n  onSelect,\n}: {\n  hints: Hint[];\n  visible: boolean;\n  onSelect: (text: string) => void;\n}) {\n  const { t } = useLanguage();\n  const grouped = hints.reduce((acc, h) => {\n    if (!acc[h.category]) acc[h.category] = [];\n    acc[h.category].push(h);\n    return acc;\n  }, {} as Record<HintCategory, Hint[]>);\n\n  const categories = Object.keys(grouped) as HintCategory[];\n\n  return (\n    <div\n      className=\"absolute bottom-full left-0 right-0 mb-1 bg-card border border-border rounded-md shadow-md max-h-72 overflow-y-auto z-50\"\n      style={{ visibility: visible && hints.length > 0 ? \"visible\" : \"hidden\" }}\n      data-testid=\"hint-dropdown\"\n    >\n      {categories.map(cat => (\n        <div key={cat}>\n          <div className=\"px-3 py-1.5 text-xs font-medium text-muted-foreground flex items-center gap-1.5 sticky top-0 bg-card border-b border-border\">\n            {(() => { const Icon = CATEGORY_ICONS[cat]; return <Icon className=\"h-3 w-3\" />; })()}\n            {t(CATEGORY_LABEL_KEYS[cat])}\n          </div>\n          {grouped[cat].map((hint, i) => (\n            <button\n              key={i}\n              type=\"button\"\n              className=\"w-full text-left px-3 py-2 text-sm hover-elevate active-elevate-2 transition-colors\"\n              onClick={() => onSelect(t(hint.key))}\n              data-testid={`hint-option-${cat}-${i}`}\n            >\n              {t(hint.key)}\n            </button>\n          ))}\n        </div>\n      ))}\n    </div>\n  );\n}\n\nexport default function Chat() {\n  const { toast } = useToast();\n  const { t } = useLanguage();\n  const [input, setInput] = useState(\"\");\n  const [confirmingId, setConfirmingId] = useState<number | null>(null);\n  const [threadId, setThreadId] = useState<number | null>(null);\n  const [pipelineRunning, setPipelineRunning] = useState(false);\n  const [showHints, setShowHints] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const hintDropdownRef = useRef<HTMLDivElement>(null);\n\n  const { data: threads, isLoading: threadsLoading } = useQuery<ChatThread[]>({\n    queryKey: [\"/api/chat/threads\"],\n  });\n\n  useEffect(() => {\n    if (threads && threads.length > 0 && !threadId) {\n      setThreadId(threads[0].id);\n    }\n  }, [threads, threadId]);\n\n  const createThreadMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/chat/threads\", {});\n      return res.json();\n    },\n    onSuccess: (data: ChatThread) => {\n      setThreadId(data.id);\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/threads\"] });\n    },\n  });\n\n  useEffect(() => {\n    if (threads && threads.length === 0 && !createThreadMutation.isPending) {\n      createThreadMutation.mutate();\n    }\n  }, [threads]);\n\n  const { data: messages, isLoading: messagesLoading } = useQuery<ChatMessage[]>({\n    queryKey: [\"/api/chat/threads\", threadId, \"messages\"],\n    queryFn: async () => {\n      if (!threadId) return [];\n      const res = await fetch(`/api/chat/threads/${threadId}/messages`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to load messages\");\n      return res.json();\n    },\n    enabled: !!threadId,\n    refetchInterval: pipelineRunning ? 1500 : 5000,\n  });\n\n  const [pipelineStartTime, setPipelineStartTime] = useState<number | null>(null);\n  const [pipelineElapsed, setPipelineElapsed] = useState(0);\n  const [lastProgressTime, setLastProgressTime] = useState<number>(0);\n  const isKo = useMemo(() => {\n    try { return t(\"chat.title\") !== \"Console\"; } catch { return false; }\n  }, [t]);\n\n  const pipelineProgressText = useMemo(() => {\n    if (!pipelineRunning || !messages) return isKo ? \"준비 중...\" : \"Preparing...\";\n    const completedSteps: string[] = [];\n    for (let i = messages.length - 1; i >= 0; i--) {\n      const m = messages[i];\n      if (m.commandJson?.type === \"pipeline_step\" && m.resultJson?.ok) {\n        completedSteps.unshift(m.commandJson.step);\n      }\n      if (m.commandJson?.type === \"pipeline_run\" && m.kind !== \"command_result\") break;\n    }\n    return getPipelineProgressLabel(completedSteps, isKo);\n  }, [messages, pipelineRunning, isKo]);\n\n  const endPipeline = () => {\n    setPipelineRunning(false);\n    setPipelineStartTime(null);\n    setLastProgressTime(0);\n    setPipelineElapsed(0);\n  };\n\n  useEffect(() => {\n    if (pipelineRunning && messages && messages.length > 0) {\n      const recentMsgs = messages.slice(-8);\n      const hasFinalPipelineMsg = recentMsgs.some(\n        m => m.commandJson?.type === \"pipeline_run\" && m.kind === \"command_result\"\n      );\n      const hasTimeoutStep = recentMsgs.some(\n        m => m.commandJson?.type === \"pipeline_step\" && m.commandJson?.step === \"timeout\"\n      );\n      const hasFailedStep = recentMsgs.some(\n        m => m.commandJson?.type === \"pipeline_step\" && m.resultJson?.ok === false\n      );\n      if (hasFinalPipelineMsg || hasTimeoutStep || hasFailedStep) {\n        endPipeline();\n      }\n    }\n  }, [messages, pipelineRunning]);\n\n  useEffect(() => {\n    if (!pipelineRunning || !messages) return;\n    const pipelineMsgs = messages.filter(\n      m => m.commandJson?.type === \"pipeline_step\" || m.commandJson?.type === \"pipeline_run\"\n    );\n    if (pipelineMsgs.length > 0) {\n      const lastMsg = pipelineMsgs[pipelineMsgs.length - 1];\n      const ts = new Date(lastMsg.createdAt).getTime();\n      if (ts > lastProgressTime) {\n        setLastProgressTime(ts);\n      }\n    }\n  }, [messages, pipelineRunning]);\n\n  useEffect(() => {\n    if (!pipelineRunning) return;\n    const STALL_THRESHOLD_MS = 12_000;\n    const interval = setInterval(() => {\n      if (lastProgressTime > 0) {\n        const stallDuration = Date.now() - lastProgressTime;\n        if (stallDuration > STALL_THRESHOLD_MS) {\n          endPipeline();\n          toast({\n            title: isKo ? \"파이프라인 완료\" : \"Pipeline finished\",\n            description: isKo\n              ? \"빠른 브리핑이 제공되었습니다. 심화 분석은 백그라운드에서 계속됩니다.\"\n              : \"Quick briefing delivered. Deep analysis continues in the background.\",\n          });\n        }\n      }\n    }, 2000);\n    return () => clearInterval(interval);\n  }, [pipelineRunning, lastProgressTime, isKo, toast]);\n\n  useEffect(() => {\n    if (!pipelineRunning) return;\n    const timeout = setTimeout(() => {\n      endPipeline();\n      toast({\n        title: isKo ? \"시간 초과\" : \"Timed out\",\n        description: isKo\n          ? \"파이프라인이 시간 초과되었습니다. Reports 페이지에서 결과를 확인하세요.\"\n          : \"Pipeline timed out. Check the Reports page for any results.\",\n      });\n    }, 30000);\n    return () => clearTimeout(timeout);\n  }, [pipelineRunning, isKo, toast]);\n\n  useEffect(() => {\n    if (!pipelineRunning) {\n      setPipelineElapsed(0);\n      return;\n    }\n    const interval = setInterval(() => {\n      if (pipelineStartTime) {\n        setPipelineElapsed(Math.floor((Date.now() - pipelineStartTime) / 1000));\n      }\n    }, 1000);\n    return () => clearInterval(interval);\n  }, [pipelineRunning, pipelineStartTime]);\n\n  const currentThread = threads?.find(t => t.id === threadId);\n  const currentActiveBotId = currentThread?.activeBotId ?? null;\n\n  const { data: activeBotInfo } = useQuery<ActiveBotInfo | null>({\n    queryKey: [\"/api/chat/threads\", threadId, \"activeBot\", currentActiveBotId],\n    queryFn: async () => {\n      if (!threadId || !currentActiveBotId) return null;\n      const res = await fetch(\"/api/bots\", { credentials: \"include\" });\n      if (!res.ok) return null;\n      const bots = await res.json();\n      return bots.find((b: any) => b.id === currentActiveBotId) || null;\n    },\n    enabled: !!threadId && !!currentActiveBotId,\n  });\n\n  const { data: consoleContext } = useQuery<ConsoleContext>({\n    queryKey: [\"/api/console/context\", threadId],\n    queryFn: async () => {\n      const url = threadId\n        ? `/api/console/context?threadId=${threadId}`\n        : \"/api/console/context\";\n      const res = await fetch(url, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to load context\");\n      return res.json();\n    },\n    refetchInterval: 15000,\n  });\n\n  const consoleState = useMemo(() => computeConsoleState(consoleContext), [consoleContext]);\n  const stateHints = useMemo(() => getHintsForState(consoleState), [consoleState]);\n  const placeholderText = useMemo(() => getPlaceholder(consoleState, t), [consoleState, t]);\n\n  const activeBotTopic = consoleContext?.activeBotTopic ?? null;\n  const botSpecificHints = useMemo(() => {\n    if (!activeBotTopic) return null;\n    return BOT_SPECIFIC_HINTS[activeBotTopic] ?? null;\n  }, [activeBotTopic]);\n\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  useEffect(() => {\n    function handleClickOutside(e: MouseEvent) {\n      if (hintDropdownRef.current && !hintDropdownRef.current.contains(e.target as Node) &&\n          inputRef.current && !inputRef.current.contains(e.target as Node)) {\n        setShowHints(false);\n      }\n    }\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  const sendMutation = useMutation({\n    mutationFn: async (text: string) => {\n      if (!threadId) throw new Error(\"No thread\");\n      const res = await apiRequest(\"POST\", `/api/chat/threads/${threadId}/message`, { text });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/threads\", threadId, \"messages\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/threads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/console/context\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/threads\", threadId, \"activeBot\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: t(\"chat.executionFailed\"),\n        description: error.message || t(\"chat.errorOccurred\"),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const confirmMutation = useMutation({\n    mutationFn: async ({ pendingMessageId, approve }: { pendingMessageId: number; approve: boolean }) => {\n      if (!threadId) throw new Error(\"No thread\");\n      const res = await apiRequest(\"POST\", `/api/chat/threads/${threadId}/confirm`, { pendingMessageId, approve });\n      return res.json();\n    },\n    onSuccess: (data: any) => {\n      setConfirmingId(null);\n      if (data?.mode === \"pipeline_started\") {\n        setPipelineRunning(true);\n        setPipelineStartTime(Date.now());\n        setLastProgressTime(Date.now());\n        setPipelineElapsed(0);\n      }\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/threads\", threadId, \"messages\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/threads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/console/context\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/chat/threads\", threadId, \"activeBot\"] });\n    },\n    onError: (error: any) => {\n      setConfirmingId(null);\n      toast({\n        title: t(\"chat.executionFailed\"),\n        description: error.message || t(\"chat.errorOccurred\"),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!input.trim() || sendMutation.isPending) return;\n    setShowHints(false);\n    sendMutation.mutate(input.trim());\n    setInput(\"\");\n  };\n\n  const handleHintClick = (text: string) => {\n    setInput(text);\n    setShowHints(false);\n    inputRef.current?.focus();\n  };\n\n  const handleConfirm = (messageId: number) => {\n    setConfirmingId(messageId);\n    confirmMutation.mutate({ pendingMessageId: messageId, approve: true });\n  };\n\n  const handleCancel = (messageId: number) => {\n    setConfirmingId(messageId);\n    confirmMutation.mutate({ pendingMessageId: messageId, approve: false });\n  };\n\n  const isLoading = threadsLoading || messagesLoading;\n\n  const lastCommandResult = useMemo(() => {\n    if (!messages?.length) return null;\n    for (let i = messages.length - 1; i >= 0; i--) {\n      const m = messages[i];\n      if (m.role === \"assistant\" && m.kind === \"command_result\" && m.commandJson) {\n        return m;\n      }\n    }\n    return null;\n  }, [messages]);\n\n  const nextActionHints = useMemo((): Hint[] => {\n    if (!lastCommandResult) return [];\n    const cmdType = lastCommandResult.commandJson?.type;\n    const ok = lastCommandResult.resultJson?.ok;\n    if (!ok) return [];\n\n    if (cmdType === \"pipeline_run\") {\n      return [\n        { key: \"chat.hint.scheduleDailyNine\", category: \"schedule\", states: [\"S3_READY\"] },\n        { key: \"chat.hint.botStatus\", category: \"first_run\", states: [\"S3_READY\"] },\n        { key: \"chat.hint.nextRunTime\", category: \"schedule\", states: [\"S3_READY\"] },\n      ];\n    }\n    if (cmdType === \"list_bots\" || cmdType === \"switch_bot\") {\n      return stateHints.slice(0, 3);\n    }\n    if (cmdType === \"add_source\") {\n      return [\n        { key: \"chat.hint.scheduleDailyNine\", category: \"schedule\", states: [\"S2_NO_COLLECTION\"] },\n        { key: \"chat.hint.botStatus\", category: \"first_run\", states: [\"S2_NO_COLLECTION\"] },\n      ];\n    }\n    return [];\n  }, [lastCommandResult, stateHints]);\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      <div className=\"p-4 border-b border-border shrink-0\">\n        <h1 className=\"text-xl font-bold flex items-center gap-2\" data-testid=\"text-chat-title\">\n          <MessageCircle className=\"h-5 w-5\" />\n          {t(\"chat.title\")}\n        </h1>\n        <div className=\"flex items-center gap-2 mt-1 flex-wrap\">\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-chat-description\">\n            {t(\"chat.subtitle\")}\n          </p>\n          {activeBotInfo ? (\n            <Badge variant=\"secondary\" data-testid=\"badge-active-bot\">\n              <Bot className=\"h-3 w-3 mr-1\" />\n              {activeBotInfo.name}\n            </Badge>\n          ) : (\n            <Badge variant=\"outline\" className=\"text-xs text-muted-foreground\" data-testid=\"badge-no-active-bot\">\n              {t(\"chat.noActiveBot\")}\n            </Badge>\n          )}\n        </div>\n      </div>\n\n      <div className=\"flex flex-1 overflow-hidden\">\n        <div className=\"flex-1 flex flex-col\">\n          <div className=\"flex-1 overflow-y-auto p-4 space-y-4\">\n            {isLoading ? (\n              <div className=\"space-y-4\">\n                {[...Array(3)].map((_, i) => (\n                  <Skeleton key={i} className=\"h-16 w-3/4\" />\n                ))}\n              </div>\n            ) : !messages?.length ? (\n              <OnboardingView\n                state={consoleState}\n                hints={stateHints}\n                onHintClick={handleHintClick}\n              />\n            ) : (\n              <>\n                {messages.map((msg) => (\n                  <MessageBubble\n                    key={msg.id}\n                    message={msg}\n                    onConfirm={handleConfirm}\n                    onCancel={handleCancel}\n                    isConfirming={confirmingId === msg.id}\n                  />\n                ))}\n\n                {nextActionHints.length > 0 && !pipelineRunning && (\n                  <div className=\"flex flex-col gap-1.5 ml-11 mt-2\" data-testid=\"next-action-hints\">\n                    <span className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                      <ArrowRight className=\"h-3 w-3\" />\n                      {t(\"chat.tryNext\")}\n                    </span>\n                    <div className=\"flex flex-wrap gap-1.5\">\n                      {nextActionHints.map((hint, i) => (\n                        <button\n                          key={i}\n                          type=\"button\"\n                          className=\"text-xs px-2.5 py-1.5 rounded-md bg-muted/50 text-muted-foreground hover-elevate active-elevate-2 transition-colors\"\n                          onClick={() => handleHintClick(t(hint.key))}\n                          data-testid={`next-action-${i}`}\n                        >\n                          {t(hint.key)}\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </>\n            )}\n            <div ref={messagesEndRef} />\n          </div>\n\n          {pipelineRunning && (\n            <div className=\"px-4 py-2 border-t border-border bg-muted/50 flex items-center gap-2 justify-between\" data-testid=\"pipeline-running-indicator\">\n              <div className=\"flex items-center gap-2\">\n                <Loader2 className=\"h-4 w-4 animate-spin text-primary\" />\n                <span className=\"text-sm text-muted-foreground\">{pipelineProgressText}</span>\n              </div>\n              {pipelineElapsed > 0 && (\n                <span className=\"text-xs text-muted-foreground tabular-nums\" data-testid=\"text-pipeline-elapsed\">\n                  {pipelineElapsed}s\n                </span>\n              )}\n            </div>\n          )}\n\n          <form onSubmit={handleSubmit} className=\"p-4 border-t border-border shrink-0\">\n            <div className=\"relative\" ref={hintDropdownRef}>\n              <HintDropdown\n                hints={stateHints.slice(0, 10)}\n                visible={showHints && !input.trim()}\n                onSelect={handleHintClick}\n              />\n              <div className=\"flex gap-2\">\n                <div className=\"relative flex-1\">\n                  <Input\n                    ref={inputRef}\n                    value={input}\n                    onChange={(e) => setInput(e.target.value)}\n                    onFocus={() => setShowHints(true)}\n                    placeholder={placeholderText}\n                    disabled={sendMutation.isPending || pipelineRunning}\n                    data-testid=\"input-chat-message\"\n                  />\n                  {!input.trim() && !pipelineRunning && (\n                    <button\n                      type=\"button\"\n                      className=\"absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground\"\n                      onClick={() => setShowHints(!showHints)}\n                      data-testid=\"button-toggle-hints\"\n                    >\n                      <ChevronDown className={`h-4 w-4 transition-transform ${showHints ? \"rotate-180\" : \"\"}`} />\n                    </button>\n                  )}\n                </div>\n                <Button\n                  type=\"submit\"\n                  disabled={!input.trim() || sendMutation.isPending}\n                  data-testid=\"button-send-message\"\n                >\n                  {sendMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  ) : (\n                    <Send className=\"h-4 w-4\" />\n                  )}\n                </Button>\n              </div>\n            </div>\n          </form>\n        </div>\n\n        <div className=\"w-64 border-l border-border p-4 hidden lg:block overflow-y-auto\">\n          {botSpecificHints ? (\n            <>\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Target className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-sm font-medium\">{consoleContext?.activeBotName || \"Bot\"} {t(\"chat.commands\")}</span>\n              </div>\n              <p className=\"text-xs text-muted-foreground mb-3\">\n                {t(\"chat.botHintsDesc\")}\n              </p>\n\n              {(Object.keys(BOT_HINT_CATEGORY_LABEL_KEYS) as BotHintCategory[]).map(cat => {\n                const hintsInCat = botSpecificHints.filter(h => h.category === cat);\n                if (hintsInCat.length === 0) return null;\n                const Icon = BOT_HINT_CATEGORY_ICONS[cat];\n                return (\n                  <div key={cat} className=\"mb-4\" data-testid={`bot-hint-group-${cat}`}>\n                    <div className=\"flex items-center gap-1.5 mb-1.5\">\n                      <Icon className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                      <span className=\"text-xs font-medium text-muted-foreground\">{t(BOT_HINT_CATEGORY_LABEL_KEYS[cat])}</span>\n                    </div>\n                    <div className=\"space-y-1\">\n                      {hintsInCat.map((hint, i) => (\n                        <BotHintChip\n                          key={`${cat}-${i}`}\n                          hint={hint}\n                          onClick={handleHintClick}\n                          index={botSpecificHints.indexOf(hint)}\n                        />\n                      ))}\n                    </div>\n                  </div>\n                );\n              })}\n            </>\n          ) : (\n            <>\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Lightbulb className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-sm font-medium\">{t(\"chat.suggestions\")}</span>\n              </div>\n\n              <div className=\"mb-3\">\n                <Badge variant=\"outline\" className=\"text-xs\" data-testid=\"badge-console-state\">\n                  {getStateMessage(consoleState, t)}\n                </Badge>\n              </div>\n\n              <div className=\"space-y-1.5\">\n                {stateHints.slice(0, 8).map((hint, i) => (\n                  <HintChip key={i} hint={hint} onClick={handleHintClick} location=\"sidebar\" index={i} />\n                ))}\n              </div>\n\n              <div className=\"mt-6 pt-4 border-t border-border\">\n                <p className=\"text-xs text-muted-foreground mb-2\">{t(\"chat.categories\")}</p>\n                <div className=\"flex flex-wrap gap-1\">\n                  {(Object.keys(CATEGORY_LABEL_KEYS) as HintCategory[]).map(cat => {\n                    const Icon = CATEGORY_ICONS[cat];\n                    return (\n                      <Badge key={cat} variant=\"secondary\" className=\"text-xs\">\n                        <Icon className=\"h-3 w-3 mr-1\" />\n                        {t(CATEGORY_LABEL_KEYS[cat])}\n                      </Badge>\n                    );\n                  })}\n                </div>\n              </div>\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":36886,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/pages/reports.tsx":{"content":"import { useState, useMemo, useCallback, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { FileText, Plus, Loader2, Bot, RefreshCw, Copy, Download, Check } from \"lucide-react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLanguage } from \"@/lib/language-provider\";\n\ninterface Report {\n  id: number;\n  profileId: number;\n  userId: string;\n  presetId: number;\n  topic: string;\n  outputType: string;\n  title: string;\n  contentText: string;\n  reportStage: string;\n  periodStart: string;\n  periodEnd: string;\n  createdAt: string;\n  updatedAt: string | null;\n}\n\ninterface Profile {\n  id: number;\n  name: string;\n  topic: string;\n  isActive: boolean;\n  presetName: string;\n}\n\ninterface BotInfo {\n  id: number;\n  key: string;\n  name: string;\n  isEnabled: boolean;\n  settings?: any;\n}\n\nfunction formatDateTime(iso: string) {\n  try {\n    return new Intl.DateTimeFormat(\"en-US\", {\n      year: \"numeric\",\n      month: \"short\",\n      day: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      hour12: false,\n    }).format(new Date(iso));\n  } catch {\n    return iso;\n  }\n}\n\nfunction getTopicColor(topic: string) {\n  const colors: Record<string, string> = {\n    investing: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n    ai_art: \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n    tech: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n    crypto: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\",\n  };\n  return colors[topic] || \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200\";\n}\n\nfunction getStageClassName(stage: string): string {\n  switch (stage) {\n    case \"fast\":\n      return \"bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200\";\n    case \"status\":\n      return \"bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200\";\n    case \"full\":\n      return \"bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200\";\n    default:\n      return \"\";\n  }\n}\n\nfunction getStageLabelKey(stage: string): string | null {\n  switch (stage) {\n    case \"fast\": return \"reports.stage.fast\";\n    case \"status\": return \"reports.stage.status\";\n    case \"full\": return \"reports.stage.full\";\n    default: return null;\n  }\n}\n\nexport default function Reports() {\n  const { t } = useLanguage();\n  const { toast } = useToast();\n  const [selectedReportId, setSelectedReportId] = useState<number | null>(null);\n  const [selectedFilter, setSelectedFilter] = useState<string>(\"all\");\n  const [copied, setCopied] = useState(false);\n\n  const { data: profiles = [] } = useQuery<Profile[]>({\n    queryKey: [\"/api/profiles\"],\n  });\n\n  const { data: botsData } = useQuery<{ bots: BotInfo[] }>({\n    queryKey: [\"/api/bots\"],\n  });\n  const bots = botsData?.bots || [];\n\n  const filterOptions = useMemo(() => {\n    const options: { value: string; label: string; type: \"profile\" | \"bot\" }[] = [];\n    \n    const profileTopics = new Set(profiles.map(p => p.topic));\n    \n    profiles.filter(p => p.isActive).forEach(profile => {\n      options.push({\n        value: `profile:${profile.id}`,\n        label: profile.name,\n        type: \"profile\",\n      });\n    });\n    \n    bots.filter(b => b.isEnabled && !profileTopics.has(b.key)).forEach(bot => {\n      options.push({\n        value: `bot:${bot.id}`,\n        label: bot.name,\n        type: \"bot\",\n      });\n    });\n    \n    return options;\n  }, [profiles, bots]);\n\n  const selectedProfileIdForQuery = useMemo(() => {\n    if (selectedFilter === \"all\") return undefined;\n    if (selectedFilter.startsWith(\"profile:\")) {\n      return parseInt(selectedFilter.split(\":\")[1]);\n    }\n    return undefined;\n  }, [selectedFilter]);\n\n  const hasFastReportRef = useRef(false);\n\n  const { data: reports, isLoading, refetch } = useQuery<Report[]>({\n    queryKey: [\"/api/reports\", selectedProfileIdForQuery],\n    queryFn: async () => {\n      const url = selectedProfileIdForQuery \n        ? `/api/reports?profileId=${selectedProfileIdForQuery}` \n        : \"/api/reports\";\n      const res = await fetch(url, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch reports\");\n      const data: Report[] = await res.json();\n      hasFastReportRef.current = data.some((r) => r.reportStage === \"fast\");\n      return data;\n    },\n    refetchInterval: () => hasFastReportRef.current ? 10000 : false,\n  });\n\n  const selectedReport = useMemo(() => {\n    if (!reports || selectedReportId == null) return null;\n    return reports.find((r) => r.id === selectedReportId) ?? null;\n  }, [reports, selectedReportId]);\n\n  const handleCopyReport = useCallback(() => {\n    if (!selectedReport) return;\n    const text = `${selectedReport.title}\\n\\n${selectedReport.contentText}`;\n    navigator.clipboard.writeText(text).then(() => {\n      setCopied(true);\n      toast({ title: t(\"reports.copied\") });\n      setTimeout(() => setCopied(false), 2000);\n    });\n  }, [selectedReport, toast]);\n\n  const handleDownloadReport = useCallback(() => {\n    if (!selectedReport) return;\n    const text = `# ${selectedReport.title}\\n\\n${t(\"reports.created\")} ${formatDateTime(selectedReport.createdAt)}\\n${t(\"reports.period\")} ${formatDateTime(selectedReport.periodStart)} ~ ${formatDateTime(selectedReport.periodEnd)}\\n\\n${selectedReport.contentText}`;\n    const blob = new Blob([text], { type: \"text/markdown;charset=utf-8\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `${selectedReport.title.replace(/[^a-zA-Z0-9-_ ]/g, \"\").trim().replace(/\\s+/g, \"_\")}.md`;\n    a.click();\n    URL.revokeObjectURL(url);\n    toast({ title: t(\"reports.downloaded\") });\n  }, [selectedReport, toast]);\n\n  const generateMutation = useMutation({\n    mutationFn: async (params: { profileId?: number; botId?: number }) => {\n      const CLIENT_ABSOLUTE_TIMEOUT_MS = 30000;\n      const CLIENT_STALL_TOAST_MS = 12000;\n\n      const controller = new AbortController();\n      const absoluteTimer = setTimeout(() => controller.abort(), CLIENT_ABSOLUTE_TIMEOUT_MS);\n      const stallTimer = setTimeout(() => {\n        toast({\n          title: t(\"reports.stallNotice\"),\n          description: t(\"reports.stallDesc\"),\n        });\n      }, CLIENT_STALL_TOAST_MS);\n\n      try {\n        const res = await fetch(\"/api/reports/generate\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(params),\n          credentials: \"include\",\n          signal: controller.signal,\n        });\n        const data = await res.json();\n        if (!res.ok || !data.ok) {\n          throw new Error(data.error || \"Report generation failed\");\n        }\n        return data;\n      } catch (err: any) {\n        if (err.name === \"AbortError\") {\n          return {\n            ok: true,\n            result: { timedOut: true },\n            message: t(\"reports.timeoutMessage\"),\n          };\n        }\n        throw err;\n      } finally {\n        clearTimeout(absoluteTimer);\n        clearTimeout(stallTimer);\n      }\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/reports\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/profiles\"] });\n      if (data.result?.timedOut) {\n        toast({\n          title: t(\"reports.fastDelivered\"),\n          description: t(\"reports.fullInBackground\"),\n        });\n      } else {\n        toast({\n          title: t(\"reports.generated\"),\n          description: data.result ? t(\"reports.generatedDesc\", { count: data.result.itemsCount }) : t(\"reports.generationComplete\"),\n        });\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: t(\"reports.generationFailed\"),\n        description: error.message || t(\"reports.generationFailedDesc\"),\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleGenerate = useCallback(() => {\n    if (selectedFilter === \"all\") return;\n    \n    if (selectedFilter.startsWith(\"profile:\")) {\n      generateMutation.mutate({ profileId: parseInt(selectedFilter.split(\":\")[1]) });\n    } else if (selectedFilter.startsWith(\"bot:\")) {\n      generateMutation.mutate({ botId: parseInt(selectedFilter.split(\":\")[1]) });\n    }\n  }, [selectedFilter, generateMutation]);\n\n  const canGenerate = selectedFilter !== \"all\";\n\n  const getProfileName = (profileId: number) => {\n    const profile = profiles.find(p => p.id === profileId);\n    if (profile) return profile.name;\n    return `Profile #${profileId}`;\n  };\n\n  return (\n    <div className=\"p-4 md:p-6 space-y-4\">\n      <div className=\"flex items-center justify-between flex-wrap gap-3\">\n        <div>\n          <h1 className=\"text-xl font-semibold flex items-center gap-2\" data-testid=\"text-reports-title\">\n            <FileText className=\"h-5 w-5\" />\n            {t(\"reports.title\")}\n          </h1>\n          <p className=\"text-sm text-muted-foreground\">\n            {t(\"reports.subtitle\")}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <Select value={selectedFilter} onValueChange={setSelectedFilter}>\n            <SelectTrigger className=\"w-48\" data-testid=\"select-profile\">\n              <SelectValue placeholder=\"Select bot\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">{t(\"reports.allReports\")}</SelectItem>\n              {filterOptions.map((opt) => (\n                <SelectItem key={opt.value} value={opt.value}>\n                  <div className=\"flex items-center gap-2\">\n                    <Bot className=\"h-3 w-3\" />\n                    {opt.label}\n                  </div>\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => refetch()}\n            data-testid=\"button-refresh-reports\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            onClick={handleGenerate}\n            disabled={generateMutation.isPending || !canGenerate}\n            data-testid=\"button-generate-report\"\n          >\n            {generateMutation.isPending ? (\n              <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n            ) : (\n              <Plus className=\"h-4 w-4 mr-2\" />\n            )}\n            {t(\"reports.generate\")}\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-[380px_1fr] gap-4\">\n        <Card className=\"h-[70vh] overflow-hidden\">\n          <CardHeader className=\"py-3 px-4 border-b\">\n            <CardTitle className=\"text-sm font-medium\">{t(\"reports.recentReports\")}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            <div className=\"h-[calc(70vh-52px)] overflow-auto\">\n              {isLoading && (\n                <div className=\"p-4 space-y-3\">\n                  {[...Array(5)].map((_, i) => (\n                    <Skeleton key={i} className=\"h-16 w-full\" />\n                  ))}\n                </div>\n              )}\n\n              {!isLoading && (!reports || reports.length === 0) && (\n                <div className=\"p-6 text-center\">\n                  <FileText className=\"h-10 w-10 mx-auto text-muted-foreground mb-3\" />\n                  <p className=\"text-sm text-muted-foreground\">{t(\"reports.noReports\")}</p>\n                  {canGenerate && (\n                    <Button\n                      size=\"sm\"\n                      className=\"mt-3\"\n                      onClick={handleGenerate}\n                      disabled={generateMutation.isPending}\n                      data-testid=\"button-generate-first-report\"\n                    >\n                      {generateMutation.isPending ? (\n                        <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\n                      ) : (\n                        <Plus className=\"h-4 w-4 mr-1\" />\n                      )}\n                      {t(\"reports.generateReport\")}\n                    </Button>\n                  )}\n                  {!canGenerate && bots.length > 0 && (\n                    <p className=\"text-xs text-muted-foreground mt-2\">\n                      {t(\"reports.selectBotHint\")}\n                    </p>\n                  )}\n                  {!canGenerate && bots.length === 0 && (\n                    <p className=\"text-xs text-muted-foreground mt-2\">\n                      {t(\"reports.createBotFirst\")}\n                    </p>\n                  )}\n                </div>\n              )}\n\n              {reports?.map((report) => {\n                const isActive = report.id === selectedReportId;\n                return (\n                  <button\n                    key={report.id}\n                    className={`w-full text-left px-4 py-3 border-b hover:bg-muted/50 transition-colors ${\n                      isActive ? \"bg-muted\" : \"\"\n                    }`}\n                    onClick={() => setSelectedReportId(report.id)}\n                    data-testid={`button-select-report-${report.id}`}\n                  >\n                    <div className=\"text-sm font-medium line-clamp-2\">{report.title}</div>\n                    <div className=\"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground\">\n                      <span>{formatDateTime(report.createdAt)}</span>\n                      {report.reportStage && report.reportStage !== \"full\" && (() => {\n                        const stageKey = getStageLabelKey(report.reportStage);\n                        const stageClass = getStageClassName(report.reportStage);\n                        return stageKey ? (\n                          <Badge variant=\"secondary\" className={`text-xs px-1.5 py-0 ${stageClass}`} data-testid={`badge-stage-${report.id}`}>\n                            {t(stageKey)}\n                          </Badge>\n                        ) : null;\n                      })()}\n                      {report.reportStage === \"full\" && report.updatedAt && (\n                        <Badge variant=\"secondary\" className=\"text-xs px-1.5 py-0 bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200\" data-testid={`badge-updated-${report.id}`}>\n                          {t(\"reports.stage.updated\")}\n                        </Badge>\n                      )}\n                      <Badge variant=\"secondary\" className={`text-xs px-1.5 py-0 ${getTopicColor(report.topic)}`}>\n                        {report.topic}\n                      </Badge>\n                      <span className=\"flex items-center gap-1\">\n                        <Bot className=\"h-3 w-3\" />\n                        {getProfileName(report.profileId)}\n                      </span>\n                    </div>\n                  </button>\n                );\n              })}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"h-[70vh] overflow-hidden\">\n          <CardHeader className=\"py-3 px-4 border-b\">\n            <div className=\"flex items-center justify-between gap-2\">\n              <CardTitle className=\"text-sm font-medium line-clamp-1 flex-1 min-w-0\">\n                {selectedReport ? selectedReport.title : t(\"reports.selectReport\")}\n              </CardTitle>\n              {selectedReport && (\n                <div className=\"flex items-center gap-1 shrink-0\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={handleCopyReport}\n                        data-testid=\"button-copy-report\"\n                      >\n                        {copied ? <Check className=\"h-4 w-4 text-green-500\" /> : <Copy className=\"h-4 w-4\" />}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>{t(\"reports.copyToClipboard\")}</TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={handleDownloadReport}\n                        data-testid=\"button-download-report\"\n                      >\n                        <Download className=\"h-4 w-4\" />\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>{t(\"reports.downloadMarkdown\")}</TooltipContent>\n                  </Tooltip>\n                </div>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent className=\"h-[calc(70vh-52px)] overflow-auto p-4\">\n            {selectedReportId == null && (\n              <div className=\"h-full flex flex-col items-center justify-center text-center\">\n                <FileText className=\"h-12 w-12 text-muted-foreground mb-3\" />\n                <p className=\"text-sm text-muted-foreground\">\n                  {t(\"reports.selectReportHint\")}\n                </p>\n              </div>\n            )}\n\n            {selectedReport && (\n              <div className=\"space-y-4\">\n                <div className=\"flex items-center gap-2 text-xs text-muted-foreground flex-wrap\">\n                  <span>{t(\"reports.created\")} {formatDateTime(selectedReport.createdAt)}</span>\n                  {selectedReport.updatedAt && (\n                    <>\n                      <span>·</span>\n                      <span>{t(\"reports.updated\")} {formatDateTime(selectedReport.updatedAt)}</span>\n                    </>\n                  )}\n                  <span>·</span>\n                  <span>{t(\"reports.period\")} {formatDateTime(selectedReport.periodStart)} ~ {formatDateTime(selectedReport.periodEnd)}</span>\n                  {selectedReport.reportStage && (() => {\n                    const stageKey = getStageLabelKey(selectedReport.reportStage);\n                    const stageClass = getStageClassName(selectedReport.reportStage);\n                    return stageKey ? (\n                      <Badge variant=\"secondary\" className={`text-xs px-1.5 py-0 ${stageClass}`} data-testid=\"badge-report-stage\">\n                        {t(stageKey)}\n                      </Badge>\n                    ) : null;\n                  })()}\n                </div>\n                <pre \n                  className=\"whitespace-pre-wrap text-sm leading-6 font-sans\"\n                  data-testid=\"text-report-content\"\n                >\n                  {selectedReport.contentText}\n                </pre>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19125,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/components/share-button.tsx":{"content":"import { useState } from \"react\";\nimport { Share2, Check, Link as LinkIcon } from \"lucide-react\";\nimport { SiX, SiLinkedin, SiReddit, SiYcombinator } from \"react-icons/si\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\n\nconst SHARE_URL = typeof window !== \"undefined\" ? window.location.origin : \"https://maker.am\";\nconst SHARE_TITLE = \"Maker — Design your own automation workflows\";\nconst SHARE_TEXT = \"Build personal automation bots: choose your sources, set schedules, and generate AI-powered reports. Your workflow, your rules.\";\n\nconst platforms = [\n  {\n    name: \"X (Twitter)\",\n    icon: SiX,\n    getUrl: () =>\n      `https://x.com/intent/tweet?text=${encodeURIComponent(SHARE_TITLE)}&url=${encodeURIComponent(SHARE_URL)}`,\n  },\n  {\n    name: \"LinkedIn\",\n    icon: SiLinkedin,\n    getUrl: () =>\n      `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(SHARE_URL)}`,\n  },\n  {\n    name: \"Reddit\",\n    icon: SiReddit,\n    getUrl: () =>\n      `https://www.reddit.com/submit?url=${encodeURIComponent(SHARE_URL)}&title=${encodeURIComponent(SHARE_TITLE)}`,\n  },\n  {\n    name: \"Hacker News\",\n    icon: SiYcombinator,\n    getUrl: () =>\n      `https://news.ycombinator.com/submitlink?u=${encodeURIComponent(SHARE_URL)}&t=${encodeURIComponent(SHARE_TITLE)}`,\n  },\n];\n\ninterface ShareButtonProps {\n  variant?: \"default\" | \"ghost\" | \"outline\";\n  size?: \"default\" | \"sm\" | \"icon\";\n  showLabel?: boolean;\n  className?: string;\n}\n\nexport function ShareButton({ variant = \"ghost\", size = \"icon\", showLabel = false, className }: ShareButtonProps) {\n  const [copied, setCopied] = useState(false);\n\n  const copyLink = async () => {\n    try {\n      await navigator.clipboard.writeText(SHARE_URL);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch {\n      const input = document.createElement(\"input\");\n      input.value = SHARE_URL;\n      document.body.appendChild(input);\n      input.select();\n      document.execCommand(\"copy\");\n      document.body.removeChild(input);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    }\n  };\n\n  return (\n    <Popover>\n      <PopoverTrigger asChild>\n        {showLabel ? (\n          <Button variant={variant} size={size} className={className} data-testid=\"button-share\">\n            <Share2 className=\"h-4 w-4\" />\n            <span className=\"ml-2\">Share</span>\n          </Button>\n        ) : (\n          <Button variant={variant} size=\"icon\" className={className} data-testid=\"button-share\">\n            <Share2 className=\"h-4 w-4\" />\n          </Button>\n        )}\n      </PopoverTrigger>\n      <PopoverContent className=\"w-56 p-2\" align=\"end\">\n        <div className=\"text-xs font-medium text-muted-foreground px-2 py-1.5\">Share on</div>\n        <div className=\"space-y-0.5\">\n          {platforms.map((platform) => (\n            <a\n              key={platform.name}\n              href={platform.getUrl()}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"flex items-center gap-3 px-2 py-2 rounded-md text-sm hover-elevate cursor-pointer\"\n              data-testid={`link-share-${platform.name.toLowerCase().replace(/[\\s()]/g, \"-\")}`}\n            >\n              <platform.icon className=\"h-4 w-4 shrink-0\" />\n              <span>{platform.name}</span>\n            </a>\n          ))}\n        </div>\n        <div className=\"border-t border-border mt-1 pt-1\">\n          <button\n            onClick={copyLink}\n            className=\"flex items-center gap-3 px-2 py-2 rounded-md text-sm w-full hover-elevate cursor-pointer\"\n            data-testid=\"button-copy-link\"\n          >\n            {copied ? (\n              <Check className=\"h-4 w-4 shrink-0 text-green-600\" />\n            ) : (\n              <LinkIcon className=\"h-4 w-4 shrink-0\" />\n            )}\n            <span>{copied ? \"Link copied!\" : \"Copy link\"}</span>\n          </button>\n        </div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n","path":null,"size_bytes":4128,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"server/replit_integrations/auth/index.ts":{"content":"export { setupAuth, isAuthenticated, getSession } from \"./replitAuth\";\nexport { authStorage, type IAuthStorage } from \"./storage\";\nexport { registerAuthRoutes } from \"./routes\";\n","path":null,"size_bytes":178,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/i18n/index.ts":{"content":"import { en } from \"./en\";\nimport { ko } from \"./ko\";\n\nexport type Language = \"en\" | \"ko\";\n\nexport const translations: Record<Language, Record<string, string>> = {\n  en,\n  ko,\n};\n","path":null,"size_bytes":179,"size_tokens":null},"client/src/pages/profile-detail.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useParams, useLocation } from \"wouter\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ArrowLeft, Save, Loader2 } from \"lucide-react\";\n\ninterface ProfileConfig {\n  scheduleRule?: \"DAILY\" | \"WEEKDAYS\" | \"WEEKENDS\";\n  sections?: {\n    tldr?: boolean;\n    drivers?: boolean;\n    risk?: boolean;\n    checklist?: boolean;\n    sources?: boolean;\n  };\n  verbosity?: \"short\" | \"normal\" | \"detailed\";\n  markdownLevel?: \"minimal\" | \"normal\";\n  filters?: {\n    minImportanceScore?: number;\n    maxRiskLevelAllowed?: number;\n    allowPromotionLinks?: boolean;\n  };\n}\n\ninterface Profile {\n  id: number;\n  userId: string;\n  presetId: number;\n  name: string;\n  topic: string;\n  variantKey: string | null;\n  timezone: string;\n  scheduleCron: string;\n  configJson: ProfileConfig;\n  isActive: boolean;\n  createdAt: string;\n  presetName: string;\n}\n\ninterface Source {\n  id: number;\n  name: string;\n  url: string;\n  topic: string;\n  enabled: boolean;\n  isDefault: boolean;\n  userId: string | null;\n}\n\nconst timezones = [\n  \"Asia/Seoul\",\n  \"America/New_York\",\n  \"America/Los_Angeles\",\n  \"Europe/London\",\n  \"Europe/Paris\",\n  \"Asia/Tokyo\",\n  \"Asia/Shanghai\",\n  \"UTC\",\n];\n\nconst scheduleTimePresets = [\n  { label: \"7:00 AM\", value: \"07:00\" },\n  { label: \"8:00 AM\", value: \"08:00\" },\n  { label: \"9:00 AM\", value: \"09:00\" },\n  { label: \"6:00 PM\", value: \"18:00\" },\n  { label: \"10:00 PM\", value: \"22:00\" },\n];\n\nconst defaultSections = {\n  tldr: true,\n  drivers: true,\n  risk: true,\n  checklist: true,\n  sources: true,\n};\n\nexport default function ProfileDetail() {\n  const { id } = useParams<{ id: string }>();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const [name, setName] = useState(\"\");\n  const [isActive, setIsActive] = useState(true);\n  const [timezone, setTimezone] = useState(\"Asia/Seoul\");\n  const [scheduleTime, setScheduleTime] = useState(\"07:00\");\n  const [scheduleRule, setScheduleRule] = useState<\"DAILY\" | \"WEEKDAYS\" | \"WEEKENDS\">(\"DAILY\");\n  const [verbosity, setVerbosity] = useState<\"short\" | \"normal\" | \"detailed\">(\"normal\");\n  const [markdownLevel, setMarkdownLevel] = useState<\"minimal\" | \"normal\">(\"minimal\");\n  const [sections, setSections] = useState(defaultSections);\n  const [minImportanceScore, setMinImportanceScore] = useState(30);\n  const [selectedSourceIds, setSelectedSourceIds] = useState<number[]>([]);\n\n  const { data: profile, isLoading: profileLoading } = useQuery<Profile>({\n    queryKey: [\"/api/profiles\", id],\n    enabled: !!id,\n  });\n\n  const { data: availableSources = [] } = useQuery<Source[]>({\n    queryKey: [\"/api/user-sources\", \"topic\", profile?.topic],\n    enabled: !!profile?.topic,\n    queryFn: async () => {\n      const res = await fetch(`/api/user-sources?topic=${profile?.topic}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch sources\");\n      return res.json();\n    },\n  });\n\n  const { data: profileSources = [] } = useQuery<Source[]>({\n    queryKey: [\"/api/profiles\", id, \"sources\"],\n    enabled: !!id,\n  });\n\n  useEffect(() => {\n    if (profile) {\n      setName(profile.name);\n      setIsActive(profile.isActive);\n      setTimezone(profile.timezone);\n      \n      // Parse cron to get time (format: \"0 H * * *\" or \"0 H * * 1-5\")\n      const cronParts = profile.scheduleCron.split(\" \");\n      if (cronParts.length >= 2) {\n        const hour = cronParts[1].padStart(2, \"0\");\n        setScheduleTime(`${hour}:00`);\n      }\n      \n      const config = profile.configJson || {};\n      setScheduleRule(config.scheduleRule || \"DAILY\");\n      setVerbosity(config.verbosity || \"normal\");\n      setMarkdownLevel(config.markdownLevel || \"minimal\");\n      setSections({ ...defaultSections, ...config.sections });\n      setMinImportanceScore(config.filters?.minImportanceScore ?? 30);\n    }\n  }, [profile]);\n\n  useEffect(() => {\n    if (profileSources.length > 0) {\n      setSelectedSourceIds(profileSources.map((s) => s.id));\n    }\n  }, [profileSources]);\n\n  // Build cron from scheduleTime and scheduleRule\n  const buildCron = () => {\n    const hour = parseInt(scheduleTime.split(\":\")[0]);\n    switch (scheduleRule) {\n      case \"WEEKDAYS\":\n        return `0 ${hour} * * 1-5`;\n      case \"WEEKENDS\":\n        return `0 ${hour} * * 0,6`;\n      default:\n        return `0 ${hour} * * *`;\n    }\n  };\n\n  const updateMutation = useMutation({\n    mutationFn: async () => {\n      const configJson: ProfileConfig = {\n        scheduleRule,\n        sections,\n        verbosity,\n        markdownLevel,\n        filters: {\n          minImportanceScore,\n        },\n      };\n      \n      await apiRequest(\"PUT\", `/api/profiles/${id}`, {\n        name,\n        isActive,\n        timezone,\n        scheduleCron: buildCron(),\n        configJson,\n      });\n      \n      await apiRequest(\"PUT\", `/api/profiles/${id}/sources`, {\n        sourceIds: selectedSourceIds,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/profiles\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/profiles\", id] });\n      toast({ title: \"Profile saved successfully\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to save profile\", variant: \"destructive\" });\n    },\n  });\n\n  const toggleSource = (sourceId: number) => {\n    setSelectedSourceIds((prev) =>\n      prev.includes(sourceId)\n        ? prev.filter((id) => id !== sourceId)\n        : [...prev, sourceId]\n    );\n  };\n\n  const toggleSection = (key: keyof typeof sections) => {\n    setSections((prev) => ({ ...prev, [key]: !prev[key] }));\n  };\n\n  const getTopicColor = (topic: string) => {\n    const colors: Record<string, string> = {\n      investing: \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n      ai_art: \"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200\",\n      tech: \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n      crypto: \"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200\",\n    };\n    return colors[topic] || \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200\";\n  };\n\n  if (profileLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!profile) {\n    return (\n      <div className=\"container mx-auto p-6 max-w-4xl\">\n        <p className=\"text-muted-foreground\">Bot not found</p>\n        <Button variant=\"ghost\" onClick={() => setLocation(\"/bots\")}>\n          <ArrowLeft className=\"h-4 w-4 mr-2\" />\n          Back to My Bots\n        </Button>\n      </div>\n    );\n  }\n\n  const filteredSources = availableSources.filter((s) => s.topic === profile.topic);\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-4xl\">\n      <div className=\"flex items-center gap-4 mb-6\">\n        <Button variant=\"ghost\" size=\"icon\" onClick={() => setLocation(\"/bots\")} data-testid=\"button-back\">\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n        <div className=\"flex-1\">\n          <h1 className=\"text-2xl font-bold\">Edit Bot</h1>\n          <div className=\"flex items-center gap-2 mt-1\">\n            <span className=\"text-muted-foreground\">{profile.presetName}</span>\n            <Badge className={getTopicColor(profile.topic)}>{profile.topic}</Badge>\n          </div>\n        </div>\n        <Button \n          onClick={() => updateMutation.mutate()}\n          disabled={updateMutation.isPending}\n          data-testid=\"button-save\"\n        >\n          {updateMutation.isPending ? (\n            <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n          ) : (\n            <Save className=\"h-4 w-4 mr-2\" />\n          )}\n          Save Changes\n        </Button>\n      </div>\n\n      <div className=\"grid gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Basic Settings</CardTitle>\n            <CardDescription>Configure your bot's name and activation status</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"name\">Bot Name</Label>\n              <Input\n                id=\"name\"\n                value={name}\n                onChange={(e) => setName(e.target.value)}\n                data-testid=\"input-name\"\n              />\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label>Active</Label>\n                <p className=\"text-sm text-muted-foreground\">Enable or disable this bot</p>\n              </div>\n              <Switch\n                checked={isActive}\n                onCheckedChange={setIsActive}\n                data-testid=\"toggle-active\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Schedule</CardTitle>\n            <CardDescription>When should this bot run?</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            <div className=\"grid gap-2\">\n              <Label>Timezone</Label>\n              <Select value={timezone} onValueChange={setTimezone}>\n                <SelectTrigger data-testid=\"select-timezone\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {timezones.map((tz) => (\n                    <SelectItem key={tz} value={tz}>{tz}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-2\">\n              <Label>Run Days</Label>\n              <Select value={scheduleRule} onValueChange={(v) => setScheduleRule(v as typeof scheduleRule)}>\n                <SelectTrigger data-testid=\"select-schedule-rule\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"DAILY\">Every Day</SelectItem>\n                  <SelectItem value=\"WEEKDAYS\">Weekdays Only (Mon-Fri)</SelectItem>\n                  <SelectItem value=\"WEEKENDS\">Weekends Only (Sat-Sun)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-2\">\n              <Label>Run Time</Label>\n              <Select value={scheduleTime} onValueChange={setScheduleTime}>\n                <SelectTrigger data-testid=\"select-schedule-time\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {scheduleTimePresets.map((preset) => (\n                    <SelectItem key={preset.value} value={preset.value}>\n                      {preset.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Report Format</CardTitle>\n            <CardDescription>Customize how your reports look</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-6\">\n            <div className=\"grid gap-2\">\n              <Label>Report Length</Label>\n              <Select value={verbosity} onValueChange={(v) => setVerbosity(v as typeof verbosity)}>\n                <SelectTrigger data-testid=\"select-verbosity\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"short\">Short (Brief summary)</SelectItem>\n                  <SelectItem value=\"normal\">Normal (Balanced)</SelectItem>\n                  <SelectItem value=\"detailed\">Detailed (Comprehensive)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-2\">\n              <Label>Markdown Style</Label>\n              <Select value={markdownLevel} onValueChange={(v) => setMarkdownLevel(v as typeof markdownLevel)}>\n                <SelectTrigger data-testid=\"select-markdown\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"minimal\">Minimal (Clean, less formatting)</SelectItem>\n                  <SelectItem value=\"normal\">Normal (Standard formatting)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-3\">\n              <Label>Report Sections</Label>\n              <div className=\"grid gap-2\">\n                {[\n                  { key: \"tldr\", label: \"TL;DR Summary\" },\n                  { key: \"drivers\", label: \"Market Drivers\" },\n                  { key: \"risk\", label: \"Risk Radar\" },\n                  { key: \"checklist\", label: \"Action Checklist\" },\n                  { key: \"sources\", label: \"Source References\" },\n                ].map(({ key, label }) => (\n                  <div key={key} className=\"flex items-center gap-2\">\n                    <Checkbox\n                      checked={sections[key as keyof typeof sections]}\n                      onCheckedChange={() => toggleSection(key as keyof typeof sections)}\n                      data-testid={`checkbox-section-${key}`}\n                    />\n                    <Label className=\"font-normal\">{label}</Label>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Filters</CardTitle>\n            <CardDescription>Set minimum criteria for items to be included</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            <div className=\"grid gap-2\">\n              <Label>Minimum Importance Score: {minImportanceScore}%</Label>\n              <Slider\n                value={[minImportanceScore]}\n                onValueChange={([v]) => setMinImportanceScore(v)}\n                min={0}\n                max={100}\n                step={10}\n                data-testid=\"slider-importance\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Items scoring below this threshold will be excluded from reports\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Sources</CardTitle>\n            <CardDescription>\n              Select which sources this bot should monitor (showing {profile.topic} sources only)\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {filteredSources.length === 0 ? (\n              <p className=\"text-muted-foreground text-sm\">\n                No sources available for {profile.topic}. Add some sources first.\n              </p>\n            ) : (\n              <div className=\"grid gap-3\">\n                {filteredSources.map((source) => (\n                  <div\n                    key={source.id}\n                    className=\"flex items-center gap-3 p-3 border rounded-md\"\n                    data-testid={`source-${source.id}`}\n                  >\n                    <Checkbox\n                      checked={selectedSourceIds.includes(source.id)}\n                      onCheckedChange={() => toggleSource(source.id)}\n                      data-testid={`checkbox-source-${source.id}`}\n                    />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"font-medium truncate\">{source.name}</span>\n                        {source.isDefault && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">Default</Badge>\n                        )}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground truncate\">{source.url}</p>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":16696,"size_tokens":null},"server/jobs/analyze_items.ts":{"content":"import { storage } from \"../storage\";\nimport { callLLMWithJsonParsing, callLLMWithTimeout } from \"../llm/client\";\nimport { \n  buildAnalyzePrompt, \n  buildAiArtCommunityAnalyzePrompt,\n  type AnalysisResult \n} from \"../llm/prompts\";\n\nconst MIN_TEXT_LENGTH = 50;\n\nfunction shouldAnalyzeItem(item: any): boolean {\n  const textLength = (item.title?.length ?? 0) + (item.contentText?.length ?? 0);\n  if (textLength < MIN_TEXT_LENGTH) return false;\n  return true;\n}\n\nasync function analyzeOneItem(item: any): Promise<boolean> {\n  if (!shouldAnalyzeItem(item)) {\n    console.log(`[AnalyzeJob] Skipping item #${item.id}: text too short (< ${MIN_TEXT_LENGTH} chars)`);\n    await storage.updateItemStatus(item.id, \"skipped\");\n    return false;\n  }\n  const prompt = item.sourceTopic === \"ai_art\"\n    ? buildAiArtCommunityAnalyzePrompt({\n        title: item.title ?? \"\",\n        body: item.contentText ?? \"\",\n        sourceName: item.sourceName ?? \"unknown\",\n      })\n    : buildAnalyzePrompt({\n        title: item.title ?? \"\",\n        body: item.contentText ?? \"\",\n        sourceName: item.sourceName ?? \"unknown\",\n        sourceRules: JSON.stringify(item.rulesJson ?? {}),\n        topic: item.sourceTopic ?? undefined,\n      });\n\n  try {\n    const result = await callLLMWithTimeout(\n      () => callLLMWithJsonParsing<AnalysisResult>(prompt),\n      30000\n    );\n\n    if (!result) {\n      console.warn(`[AnalyzeJob] LLM timed out for item #${item.id}, marking as skipped`);\n      await storage.updateItemStatus(item.id, \"skipped\");\n      return false;\n    }\n\n    await storage.createAnalysis({\n      itemId: item.id,\n      category: result.category || \"other\",\n      relevanceScore: result.relevance_score || 0,\n      replyWorthinessScore: result.reply_worthiness_score || 0,\n      linkFitScore: result.link_fit_score || 0,\n      riskFlagsJson: result.risk_flags || [],\n      recommendedAction: result.recommended_action || \"observe\",\n      suggestedAngle: result.suggested_angle || \"\",\n      summaryShort: result.summary_short || \"\",\n      summaryLong: result.summary_long || \"\",\n    });\n\n    await storage.updateItemStatus(item.id, \"analyzed\");\n    console.log(`✓ Analyzed item #${item.id}: ${result.recommended_action}`);\n    return true;\n  } catch (error) {\n    console.error(`✗ Failed to analyze item #${item.id}:`, error);\n    await storage.updateItemStatus(item.id, \"skipped\");\n    return false;\n  }\n}\n\nexport async function analyzeNewItemsBySourceIds(sourceIds: number[], limit: number = 50, concurrency: number = 1): Promise<number> {\n  console.log(`[AnalyzeJob] Starting bot-scoped analysis for ${sourceIds.length} sources (limit=${limit}, concurrency=${concurrency})...`);\n  const items = await storage.getItemsByStatusAndSourceIds(\"new\", sourceIds, limit);\n  console.log(`[AnalyzeJob] Found ${items.length} new items from bot sources`);\n  let analyzed = 0;\n\n  if (concurrency <= 1) {\n    for (const item of items) {\n      console.log(`[AnalyzeJob] Analyzing item #${item.id} (topic: ${item.sourceTopic}): ${item.title?.slice(0, 50)}...`);\n      if (await analyzeOneItem(item)) analyzed++;\n    }\n  } else {\n    for (let i = 0; i < items.length; i += concurrency) {\n      const batch = items.slice(i, i + concurrency);\n      console.log(`[AnalyzeJob] Processing batch ${Math.floor(i / concurrency) + 1} (${batch.length} items)...`);\n      const results = await Promise.allSettled(\n        batch.map(item => analyzeOneItem(item))\n      );\n      for (const r of results) {\n        if (r.status === \"fulfilled\" && r.value) analyzed++;\n      }\n    }\n  }\n\n  return analyzed;\n}\n\nexport async function analyzeNewItems(): Promise<number> {\n  console.log(\"[AnalyzeJob] Starting analysis for new items...\");\n  const items = await storage.getItemsByStatus(\"new\", 10);\n  console.log(`[AnalyzeJob] Found ${items.length} items in 'new' status`);\n  let analyzed = 0;\n\n  for (const item of items) {\n    console.log(`[AnalyzeJob] Analyzing item #${item.id} (topic: ${item.sourceTopic}): ${item.title?.slice(0, 50)}...`);\n    if (await analyzeOneItem(item)) analyzed++;\n  }\n\n  return analyzed;\n}\n","path":null,"size_bytes":4080,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport { Settings as SettingsIcon, Play, Pause, RefreshCw, Zap, Clock, Plus, Trash2, Key, Loader2, Pencil, MessageCircle, Copy, Unlink, ExternalLink, Check } from \"lucide-react\";\n\ninterface SchedulerStatus {\n  isRunning: boolean;\n  collectInterval: string;\n  analyzeInterval: string;\n  draftInterval: string;\n  lastCollect?: string;\n  lastAnalyze?: string;\n  lastDraft?: string;\n}\n\ninterface LlmProviderSafe {\n  id: number;\n  userId: string;\n  name: string;\n  providerType: string;\n  baseUrl: string | null;\n  defaultModel: string | null;\n  apiKeyHint: string;\n  createdAt: string;\n}\n\nexport default function Settings() {\n  const { toast } = useToast();\n  const { t } = useLanguage();\n  const [showAddProvider, setShowAddProvider] = useState(false);\n  const [editingProvider, setEditingProvider] = useState<LlmProviderSafe | null>(null);\n  const [providerName, setProviderName] = useState(\"\");\n  const [providerType, setProviderType] = useState(\"anthropic\");\n  const [apiKey, setApiKey] = useState(\"\");\n  const [baseUrl, setBaseUrl] = useState(\"\");\n  const [defaultModel, setDefaultModel] = useState(\"\");\n\n  const { data: status, isLoading } = useQuery<SchedulerStatus>({\n    queryKey: [\"/api/scheduler/status\"],\n  });\n\n  const { data: providersResponse, isLoading: providersLoading } = useQuery<{ providers: LlmProviderSafe[] }>({\n    queryKey: [\"/api/llm-providers\"],\n    queryFn: () => fetch(\"/api/llm-providers\", { credentials: \"include\" }).then(r => r.json()),\n  });\n\n  const providers = providersResponse?.providers ?? [];\n\n  const toggleSchedulerMutation = useMutation({\n    mutationFn: async (action: \"start\" | \"stop\") => {\n      return apiRequest(\"POST\", `/api/scheduler/${action}`);\n    },\n    onSuccess: (_, action) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scheduler/status\"] });\n      toast({ title: action === \"start\" ? t(\"settings.scheduler.started\") : t(\"settings.scheduler.stoppedMsg\") });\n    },\n    onError: () => {\n      toast({ title: t(\"settings.scheduler.toggleFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const runJobMutation = useMutation({\n    mutationFn: async (job: \"collect\" | \"analyze\" | \"draft\") => {\n      return apiRequest(\"POST\", `/api/scheduler/run/${job}`);\n    },\n    onSuccess: (_, job) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scheduler/status\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/items\"] });\n      toast({ title: t(\"settings.scheduler.jobStarted\", { job: job.charAt(0).toUpperCase() + job.slice(1) }) });\n    },\n    onError: () => {\n      toast({ title: t(\"settings.scheduler.jobFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const createProviderMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/llm-providers\", {\n        name: providerName,\n        providerType,\n        apiKey,\n        baseUrl: baseUrl || undefined,\n        defaultModel: defaultModel || undefined,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/llm-providers\"] });\n      toast({ title: t(\"settings.providers.added\") });\n      resetForm();\n    },\n    onError: (err: any) => {\n      const detail = err?.message || \"\";\n      const serverMsg = detail.includes(\":\") ? detail.split(\": \").slice(1).join(\": \") : \"\";\n      toast({ title: t(\"settings.providers.addFailed\"), description: serverMsg || undefined, variant: \"destructive\" });\n    },\n  });\n\n  const updateProviderMutation = useMutation({\n    mutationFn: async () => {\n      if (!editingProvider) return;\n      const body: Record<string, any> = {\n        name: providerName,\n        providerType,\n        baseUrl: baseUrl || null,\n        defaultModel: defaultModel || null,\n      };\n      if (apiKey) body.apiKey = apiKey;\n      return apiRequest(\"PUT\", `/api/llm-providers/${editingProvider.id}`, body);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/llm-providers\"] });\n      toast({ title: t(\"settings.providers.updated\") });\n      resetForm();\n    },\n    onError: () => {\n      toast({ title: t(\"settings.providers.updateFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const deleteProviderMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/llm-providers/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/llm-providers\"] });\n      toast({ title: t(\"settings.providers.deleted\") });\n    },\n    onError: () => {\n      toast({ title: t(\"settings.providers.deleteFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  function resetForm() {\n    setShowAddProvider(false);\n    setEditingProvider(null);\n    setProviderName(\"\");\n    setProviderType(\"anthropic\");\n    setApiKey(\"\");\n    setBaseUrl(\"\");\n    setDefaultModel(\"\");\n  }\n\n  function TelegramCard() {\n    const [linkCode, setLinkCode] = useState<string | null>(null);\n    const [copied, setCopied] = useState(false);\n\n    const { data: tgStatus, isLoading: tgLoading } = useQuery<{\n      linked: boolean;\n      telegramUsername: string | null;\n      linkedAt: string | null;\n      botConfigured: boolean;\n    }>({\n      queryKey: [\"/api/telegram/status\"],\n    });\n\n    const generateCodeMutation = useMutation({\n      mutationFn: () => apiRequest(\"POST\", \"/api/telegram/link-code\").then((r: any) => r.json()),\n      onSuccess: (data: any) => {\n        setLinkCode(data.code);\n      },\n      onError: () => {\n        toast({ title: t(\"settings.telegram.codeFailed\"), variant: \"destructive\" });\n      },\n    });\n\n    const unlinkMutation = useMutation({\n      mutationFn: () => apiRequest(\"DELETE\", \"/api/telegram/unlink\"),\n      onSuccess: () => {\n        queryClient.invalidateQueries({ queryKey: [\"/api/telegram/status\"] });\n        toast({ title: t(\"settings.telegram.unlinked\") });\n      },\n    });\n\n    const copyCode = () => {\n      if (linkCode) {\n        navigator.clipboard.writeText(`/link ${linkCode}`);\n        setCopied(true);\n        setTimeout(() => setCopied(false), 2000);\n      }\n    };\n\n    return (\n      <Card data-testid=\"card-telegram-settings\">\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <MessageCircle className=\"h-5 w-5\" />\n            {t(\"settings.telegram.title\")}\n          </CardTitle>\n          <CardDescription>{t(\"settings.telegram.subtitle\")}</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {tgLoading ? (\n            <Skeleton className=\"h-16 w-full\" />\n          ) : !tgStatus?.botConfigured ? (\n            <div className=\"space-y-3\">\n              <div className=\"p-4 rounded-md border\">\n                <p className=\"text-sm text-muted-foreground\">{t(\"settings.telegram.notConfigured\")}</p>\n              </div>\n              <div className=\"p-4 rounded-md border space-y-2\">\n                <h3 className=\"font-medium text-sm\">{t(\"settings.telegram.setupGuideTitle\")}</h3>\n                <div className=\"text-xs text-muted-foreground space-y-1\">\n                  <p>{t(\"settings.telegram.setupGuide1\")}</p>\n                  <p>{t(\"settings.telegram.setupGuide2\")}</p>\n                  <p>{t(\"settings.telegram.setupGuide3\")}</p>\n                  <p>{t(\"settings.telegram.setupGuide4\")}</p>\n                  <p>{t(\"settings.telegram.setupGuide5\")}</p>\n                </div>\n              </div>\n            </div>\n          ) : tgStatus?.linked ? (\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between gap-4 p-4 rounded-md border flex-wrap\">\n                <div>\n                  <h3 className=\"font-medium text-sm\">{t(\"settings.telegram.linked\")}</h3>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {tgStatus.telegramUsername && `@${tgStatus.telegramUsername}`}\n                    {tgStatus.linkedAt && ` · ${new Date(tgStatus.linkedAt).toLocaleDateString()}`}\n                  </p>\n                </div>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => unlinkMutation.mutate()}\n                  disabled={unlinkMutation.isPending}\n                  data-testid=\"button-unlink-telegram\"\n                >\n                  <Unlink className=\"h-4 w-4 mr-1\" />\n                  {t(\"settings.telegram.unlink\")}\n                </Button>\n              </div>\n              <div className=\"p-4 rounded-md border space-y-2\" data-testid=\"telegram-commands-guide\">\n                <h3 className=\"font-medium text-sm\">{t(\"settings.telegram.commands\")}</h3>\n                <div className=\"text-xs text-muted-foreground space-y-1\">\n                  <p><code className=\"bg-muted px-1 rounded\">{t(\"settings.telegram.cmdStart\")}</code></p>\n                  <p><code className=\"bg-muted px-1 rounded\">{t(\"settings.telegram.cmdHelp\")}</code></p>\n                  <p><code className=\"bg-muted px-1 rounded\">{t(\"settings.telegram.cmdUnlink\")}</code></p>\n                  <p className=\"pt-1\">{t(\"settings.telegram.cmdNatural\")}</p>\n                </div>\n              </div>\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              <div className=\"p-4 rounded-md border space-y-3\">\n                <h3 className=\"font-medium text-sm\">{t(\"settings.telegram.howToLink\")}</h3>\n                <ol className=\"text-xs text-muted-foreground space-y-1 list-decimal list-inside\">\n                  <li>{t(\"settings.telegram.step1\")}</li>\n                  <li>{t(\"settings.telegram.step2\")}</li>\n                  <li>{t(\"settings.telegram.step3\")}</li>\n                </ol>\n\n                {linkCode ? (\n                  <div className=\"flex items-center gap-2\">\n                    <code className=\"flex-1 p-2 rounded-md bg-muted text-sm font-mono\" data-testid=\"text-link-code\">\n                      /link {linkCode}\n                    </code>\n                    <Button size=\"sm\" variant=\"outline\" onClick={copyCode} data-testid=\"button-copy-link-code\">\n                      {copied ? <Check className=\"h-4 w-4\" /> : <Copy className=\"h-4 w-4\" />}\n                    </Button>\n                  </div>\n                ) : (\n                  <Button\n                    size=\"sm\"\n                    onClick={() => generateCodeMutation.mutate()}\n                    disabled={generateCodeMutation.isPending}\n                    data-testid=\"button-generate-link-code\"\n                  >\n                    {generateCodeMutation.isPending ? (\n                      <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\n                    ) : (\n                      <Key className=\"h-4 w-4 mr-1\" />\n                    )}\n                    {t(\"settings.telegram.generateCode\")}\n                  </Button>\n                )}\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  function startEdit(provider: LlmProviderSafe) {\n    setEditingProvider(provider);\n    setShowAddProvider(true);\n    setProviderName(provider.name);\n    setProviderType(provider.providerType);\n    setApiKey(\"\");\n    setBaseUrl(provider.baseUrl || \"\");\n    setDefaultModel(provider.defaultModel || \"\");\n  }\n\n  const providerTypeLabels: Record<string, string> = {\n    anthropic: \"Anthropic\",\n    openai: \"OpenAI\",\n    google: \"Google AI\",\n    custom: \"Custom\",\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold\" data-testid=\"text-settings-title\">{t(\"settings.title\")}</h1>\n        <p className=\"text-muted-foreground\">{t(\"settings.subtitle\")}</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <Key className=\"h-5 w-5\" />\n                {t(\"settings.providers.title\")}\n              </CardTitle>\n              <CardDescription className=\"mt-1\">\n                {t(\"settings.providers.subtitle\")}\n              </CardDescription>\n            </div>\n            <Button\n              size=\"sm\"\n              onClick={() => { resetForm(); setShowAddProvider(true); }}\n              data-testid=\"button-add-provider\"\n            >\n              <Plus className=\"h-4 w-4 mr-1\" />\n              {t(\"settings.providers.addButton\")}\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {showAddProvider && (\n            <div className=\"p-4 rounded-md border space-y-4\" data-testid=\"form-add-provider\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"provider-name\">{t(\"settings.providers.name\")}</Label>\n                <Input\n                  id=\"provider-name\"\n                  value={providerName}\n                  onChange={(e) => setProviderName(e.target.value)}\n                  placeholder={t(\"settings.providers.namePlaceholder\")}\n                  data-testid=\"input-provider-name\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label>{t(\"settings.providers.type\")}</Label>\n                <Select value={providerType} onValueChange={setProviderType}>\n                  <SelectTrigger data-testid=\"select-provider-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"anthropic\">Anthropic (Claude)</SelectItem>\n                    <SelectItem value=\"openai\">OpenAI (GPT)</SelectItem>\n                    <SelectItem value=\"google\">Google AI (Gemini)</SelectItem>\n                    <SelectItem value=\"custom\">Custom (OpenAI-compatible)</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"api-key\">\n                  {t(\"settings.providers.apiKey\")} {editingProvider && <span className=\"text-muted-foreground text-xs\">{t(\"settings.providers.apiKeyKeep\")}</span>}\n                </Label>\n                <Input\n                  id=\"api-key\"\n                  type=\"password\"\n                  value={apiKey}\n                  onChange={(e) => setApiKey(e.target.value)}\n                  placeholder={editingProvider ? t(\"settings.providers.apiKeyEditPlaceholder\") : t(\"settings.providers.apiKeyPlaceholder\")}\n                  data-testid=\"input-api-key\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"base-url\">{t(\"settings.providers.baseUrl\")} <span className=\"text-muted-foreground text-xs\">{t(\"settings.providers.baseUrlHint\")}</span></Label>\n                <Input\n                  id=\"base-url\"\n                  value={baseUrl}\n                  onChange={(e) => setBaseUrl(e.target.value)}\n                  placeholder=\"https://api.example.com\"\n                  data-testid=\"input-base-url\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"default-model\">{t(\"settings.providers.defaultModel\")} <span className=\"text-muted-foreground text-xs\">{t(\"settings.providers.defaultModelHint\")}</span></Label>\n                <Input\n                  id=\"default-model\"\n                  value={defaultModel}\n                  onChange={(e) => setDefaultModel(e.target.value)}\n                  placeholder=\"e.g. claude-sonnet-4-5-20250929\"\n                  data-testid=\"input-default-model\"\n                />\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  onClick={() => editingProvider ? updateProviderMutation.mutate() : createProviderMutation.mutate()}\n                  disabled={!providerName || (!apiKey && !editingProvider) || createProviderMutation.isPending || updateProviderMutation.isPending}\n                  data-testid=\"button-save-provider\"\n                >\n                  {(createProviderMutation.isPending || updateProviderMutation.isPending) && <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />}\n                  {editingProvider ? t(\"settings.providers.update\") : t(\"settings.providers.save\")}\n                </Button>\n                <Button variant=\"outline\" onClick={resetForm} data-testid=\"button-cancel-provider\">\n                  {t(\"settings.providers.cancel\")}\n                </Button>\n              </div>\n            </div>\n          )}\n\n          {providersLoading ? (\n            <div className=\"space-y-2\">\n              <Skeleton className=\"h-14 w-full\" />\n              <Skeleton className=\"h-14 w-full\" />\n            </div>\n          ) : providers.length === 0 && !showAddProvider ? (\n            <p className=\"text-sm text-muted-foreground py-4\" data-testid=\"text-no-providers\">\n              {t(\"settings.providers.noProviders\")}\n            </p>\n          ) : (\n            providers.map((provider) => (\n              <div key={provider.id} className=\"flex items-center justify-between gap-4 p-3 rounded-md border\" data-testid={`provider-card-${provider.id}`}>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <span className=\"font-medium text-sm\" data-testid={`text-provider-name-${provider.id}`}>{provider.name}</span>\n                    <Badge variant=\"secondary\" className=\"text-xs\">{providerTypeLabels[provider.providerType] || provider.providerType}</Badge>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {provider.defaultModel && <span>Model: {provider.defaultModel}</span>}\n                    {provider.baseUrl && <span className=\"ml-2\">URL: {provider.baseUrl}</span>}\n                  </p>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => startEdit(provider)}\n                    data-testid={`button-edit-provider-${provider.id}`}\n                  >\n                    <Pencil className=\"h-4 w-4\" />\n                  </Button>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => deleteProviderMutation.mutate(provider.id)}\n                    disabled={deleteProviderMutation.isPending}\n                    data-testid={`button-delete-provider-${provider.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            ))\n          )}\n        </CardContent>\n      </Card>\n\n      <TelegramCard />\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n            <div>\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                <Clock className=\"h-5 w-5\" />\n                {t(\"settings.scheduler.title\")}\n              </CardTitle>\n              <CardDescription className=\"mt-1\">\n                {t(\"settings.scheduler.subtitle\")}\n              </CardDescription>\n            </div>\n            {isLoading ? (\n              <Skeleton className=\"h-9 w-24\" />\n            ) : (\n              <div className=\"flex items-center gap-3\">\n                <Badge variant={status?.isRunning ? \"default\" : \"secondary\"}>\n                  {status?.isRunning ? t(\"settings.scheduler.running\") : t(\"settings.scheduler.stopped\")}\n                </Badge>\n                <Button\n                  variant={status?.isRunning ? \"outline\" : \"default\"}\n                  size=\"sm\"\n                  onClick={() => toggleSchedulerMutation.mutate(status?.isRunning ? \"stop\" : \"start\")}\n                  disabled={toggleSchedulerMutation.isPending}\n                  data-testid=\"button-toggle-scheduler\"\n                >\n                  {status?.isRunning ? (\n                    <>\n                      <Pause className=\"h-4 w-4 mr-1\" />\n                      {t(\"settings.scheduler.stop\")}\n                    </>\n                  ) : (\n                    <>\n                      <Play className=\"h-4 w-4 mr-1\" />\n                      {t(\"settings.scheduler.start\")}\n                    </>\n                  )}\n                </Button>\n              </div>\n            )}\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {isLoading ? (\n            <div className=\"space-y-3\">\n              {[1, 2, 3].map((i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : (\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between gap-4 p-4 rounded-md border flex-wrap\">\n                <div>\n                  <h3 className=\"font-medium text-sm\">{t(\"settings.scheduler.rssCollection\")}</h3>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {t(\"settings.scheduler.interval\")} {status?.collectInterval || \"10 minutes\"}\n                    {status?.lastCollect && (\n                      <span className=\"ml-2\">{t(\"settings.scheduler.last\")} {status.lastCollect}</span>\n                    )}\n                  </p>\n                </div>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => runJobMutation.mutate(\"collect\")}\n                  disabled={runJobMutation.isPending}\n                  data-testid=\"button-run-collect\"\n                >\n                  <RefreshCw className=\"h-4 w-4 mr-1\" />\n                  {t(\"settings.scheduler.runNow\")}\n                </Button>\n              </div>\n\n              <div className=\"flex items-center justify-between gap-4 p-4 rounded-md border flex-wrap\">\n                <div>\n                  <h3 className=\"font-medium text-sm\">{t(\"settings.scheduler.contentAnalysis\")}</h3>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {t(\"settings.scheduler.interval\")} {status?.analyzeInterval || \"5 minutes\"}\n                    {status?.lastAnalyze && (\n                      <span className=\"ml-2\">{t(\"settings.scheduler.last\")} {status.lastAnalyze}</span>\n                    )}\n                  </p>\n                </div>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => runJobMutation.mutate(\"analyze\")}\n                  disabled={runJobMutation.isPending}\n                  data-testid=\"button-run-analyze\"\n                >\n                  <Zap className=\"h-4 w-4 mr-1\" />\n                  {t(\"settings.scheduler.runNow\")}\n                </Button>\n              </div>\n\n              <div className=\"flex items-center justify-between gap-4 p-4 rounded-md border flex-wrap\">\n                <div>\n                  <h3 className=\"font-medium text-sm\">{t(\"settings.scheduler.draftGeneration\")}</h3>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {t(\"settings.scheduler.interval\")} {status?.draftInterval || \"5 minutes\"}\n                    {status?.lastDraft && (\n                      <span className=\"ml-2\">{t(\"settings.scheduler.last\")} {status.lastDraft}</span>\n                    )}\n                  </p>\n                </div>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => runJobMutation.mutate(\"draft\")}\n                  disabled={runJobMutation.isPending}\n                  data-testid=\"button-run-draft\"\n                >\n                  <Zap className=\"h-4 w-4 mr-1\" />\n                  {t(\"settings.scheduler.runNow\")}\n                </Button>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":24722,"size_tokens":null},"server/llm/providers/anthropic.ts":{"content":"interface AnthropicResponse {\n  content: Array<{ type: string; text?: string }>;\n  stop_reason: string;\n}\n\nexport async function generate(\n  prompt: string,\n  options: { apiKey: string; baseUrl?: string | null; model?: string | null; maxTokens?: number }\n): Promise<string> {\n  const url = (options.baseUrl || \"https://api.anthropic.com\") + \"/v1/messages\";\n  const model = options.model || \"claude-sonnet-4-5-20250929\";\n  const maxTokens = options.maxTokens || 1200;\n\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: {\n      \"x-api-key\": options.apiKey,\n      \"anthropic-version\": \"2023-06-01\",\n      \"content-type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      model,\n      max_tokens: maxTokens,\n      temperature: 0.2,\n      messages: [{ role: \"user\", content: prompt }],\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Anthropic API error: ${response.status} - ${errorText}`);\n  }\n\n  const data: AnthropicResponse = await response.json();\n  const text = data.content\n    .filter((c) => c.type === \"text\" && c.text)\n    .map((c) => c.text)\n    .join(\"\");\n\n  if (!text) throw new Error(\"Empty response from Anthropic API\");\n  return text;\n}\n","path":null,"size_bytes":1235,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/pages/bot-detail.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport { ArrowLeft, Save, Loader2, Brain, Clock, FileText, Filter, Rss, AlertTriangle, Layers, Plus, X, CheckCircle2, XCircle, Timer, SkipForward, Play, Activity, Info } from \"lucide-react\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from \"@/components/ui/sheet\";\nimport { PermissionDashboard } from \"@/components/permission-dashboard\";\nimport { MemoryCard } from \"@/components/memory-card\";\n\ninterface JobRunData {\n  id: number;\n  botId: number;\n  botKey: string;\n  jobType: string;\n  trigger: string;\n  status: string;\n  startedAt: string;\n  finishedAt: string | null;\n  durationMs: number | null;\n  itemsCollected: number | null;\n  errorCode: string | null;\n  errorMessage: string | null;\n}\n\ninterface DiagnosticItem {\n  rule: string;\n  severity: \"error\" | \"warning\" | \"info\";\n  messageEn: string;\n  messageKo: string;\n}\n\ninterface DiagnosisData {\n  health: \"healthy\" | \"warning\" | \"error\";\n  items: DiagnosticItem[];\n}\n\ninterface BotSettings {\n  id: number;\n  botId: number;\n  timezone: string;\n  scheduleRule: string;\n  scheduleTimeLocal: string;\n  format: string;\n  markdownLevel: string;\n  verbosity: string;\n  sectionsJson: Record<string, boolean>;\n  filtersJson: Record<string, number>;\n  llmProviderId: number | null;\n  modelOverride: string | null;\n}\n\ninterface LlmProviderSafe {\n  id: number;\n  name: string;\n  providerType: string;\n  defaultModel: string | null;\n}\n\ninterface BotData {\n  id: number;\n  userId: string;\n  key: string;\n  name: string;\n  isEnabled: boolean;\n  createdAt: string;\n  settings: BotSettings | null;\n}\n\ninterface SourceLink {\n  id: number;\n  name: string;\n  url: string;\n  topic: string;\n  weight: number;\n  isEnabled: boolean;\n}\n\nconst MODEL_HINTS: Record<string, string[]> = {\n  anthropic: [\"claude-sonnet-4-5-20250929\", \"claude-3-5-haiku-latest\", \"claude-3-5-sonnet-latest\"],\n  openai: [\"gpt-4o\", \"gpt-4o-mini\", \"gpt-4-turbo\", \"o1-mini\"],\n  google: [\"gemini-2.0-flash\", \"gemini-1.5-pro\", \"gemini-1.5-flash\"],\n  custom: [],\n};\n\nconst SCHEDULE_TIMES = [\n  { value: \"06:00\", label: \"6:00 AM\" },\n  { value: \"07:00\", label: \"7:00 AM\" },\n  { value: \"08:00\", label: \"8:00 AM\" },\n  { value: \"09:00\", label: \"9:00 AM\" },\n  { value: \"10:00\", label: \"10:00 AM\" },\n  { value: \"12:00\", label: \"12:00 PM\" },\n  { value: \"14:00\", label: \"2:00 PM\" },\n  { value: \"16:00\", label: \"4:00 PM\" },\n  { value: \"18:00\", label: \"6:00 PM\" },\n  { value: \"19:00\", label: \"7:00 PM\" },\n  { value: \"20:00\", label: \"8:00 PM\" },\n  { value: \"21:00\", label: \"9:00 PM\" },\n  { value: \"22:00\", label: \"10:00 PM\" },\n  { value: \"23:00\", label: \"11:00 PM\" },\n];\n\nexport default function BotDetail() {\n  const [, params] = useRoute(\"/bots/:id\");\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { t, language } = useLanguage();\n  const botId = params?.id ? parseInt(params.id) : null;\n\n  const [name, setName] = useState(\"\");\n  const [isEnabled, setIsEnabled] = useState(true);\n  const [timezone, setTimezone] = useState(\"Asia/Seoul\");\n  const [scheduleRule, setScheduleRule] = useState(\"DAILY\");\n  const [scheduleTimeLocal, setScheduleTimeLocal] = useState(\"21:00\");\n  const [verbosity, setVerbosity] = useState(\"normal\");\n  const [markdownLevel, setMarkdownLevel] = useState(\"minimal\");\n  const [sections, setSections] = useState({\n    tldr: true, drivers: true, risk: true, checklist: true, sources: true,\n  });\n  const [minImportanceScore, setMinImportanceScore] = useState(0);\n  const [llmProviderId, setLlmProviderId] = useState<string>(\"\");\n  const [modelOverride, setModelOverride] = useState(\"\");\n\n  const { data: botResponse, isLoading } = useQuery<{ bot: BotData }>({\n    queryKey: [\"/api/bots\", botId],\n    queryFn: () => fetch(`/api/bots/${botId}`, { credentials: \"include\" }).then(r => r.json()),\n    enabled: !!botId,\n  });\n\n  const { data: settingsResponse } = useQuery<{ settings: BotSettings | null }>({\n    queryKey: [\"/api/bots\", botId, \"settings\"],\n    queryFn: () => fetch(`/api/bots/${botId}/settings`, { credentials: \"include\" }).then(r => r.json()),\n    enabled: !!botId,\n  });\n\n  const { data: sourcesResponse } = useQuery<{ links: SourceLink[] }>({\n    queryKey: [\"/api/bots\", botId, \"sources\"],\n    queryFn: () => fetch(`/api/bots/${botId}/sources`, { credentials: \"include\" }).then(r => r.json()),\n    enabled: !!botId,\n  });\n\n  const { data: allSourcesResponse } = useQuery<{ id: number; name: string; url: string; topic: string }[]>({\n    queryKey: [\"/api/sources\"],\n  });\n\n  const { data: providersResponse } = useQuery<{ providers: LlmProviderSafe[] }>({\n    queryKey: [\"/api/llm-providers\"],\n    queryFn: () => fetch(\"/api/llm-providers\", { credentials: \"include\" }).then(r => r.json()),\n  });\n\n  const { data: runsData } = useQuery<JobRunData[]>({\n    queryKey: [\"/api/bots\", botId, \"runs\"],\n    queryFn: () => fetch(`/api/bots/${botId}/runs?limit=50`, { credentials: \"include\" }).then(r => r.json()),\n    enabled: !!botId,\n    refetchInterval: 30000,\n  });\n\n  const { data: diagnosisData } = useQuery<DiagnosisData>({\n    queryKey: [\"/api/bots\", botId, \"diagnosis\"],\n    queryFn: () => fetch(`/api/bots/${botId}/diagnosis`, { credentials: \"include\" }).then(r => r.json()),\n    enabled: !!botId,\n    refetchInterval: 60000,\n  });\n\n  const bot = botResponse?.bot;\n  const botSettings = settingsResponse?.settings;\n  const botSources = sourcesResponse?.links ?? [];\n  const allSources = allSourcesResponse ?? [];\n  const availableProviders = providersResponse?.providers ?? [];\n\n  const linkedSourceIds = new Set(botSources.map(s => s.id));\n  const unlinkedSources = allSources.filter(s => !linkedSourceIds.has(s.id));\n\n  const selectedProvider = availableProviders.find(p => String(p.id) === llmProviderId);\n  const providerType = selectedProvider?.providerType || \"anthropic\";\n  const modelHints = MODEL_HINTS[providerType] || [];\n\n  const providerWasDeleted = botSettings?.llmProviderId != null\n    && llmProviderId === \"\"\n    && !availableProviders.some(p => p.id === botSettings?.llmProviderId);\n\n  useEffect(() => {\n    if (bot) {\n      setName(bot.name);\n      setIsEnabled(bot.isEnabled);\n    }\n  }, [bot]);\n\n  useEffect(() => {\n    if (botSettings) {\n      setTimezone(botSettings.timezone);\n      setScheduleRule(botSettings.scheduleRule);\n      setScheduleTimeLocal(botSettings.scheduleTimeLocal);\n      setVerbosity(botSettings.verbosity);\n      setMarkdownLevel(botSettings.markdownLevel);\n      if (botSettings.sectionsJson) {\n        setSections(prev => ({ ...prev, ...botSettings.sectionsJson }));\n      }\n      if (botSettings.filtersJson?.minImportanceScore != null) {\n        setMinImportanceScore(botSettings.filtersJson.minImportanceScore);\n      }\n      if (botSettings.llmProviderId) {\n        const providerExists = availableProviders.some(p => p.id === botSettings.llmProviderId);\n        setLlmProviderId(providerExists ? String(botSettings.llmProviderId) : \"\");\n      } else {\n        setLlmProviderId(\"\");\n      }\n      setModelOverride(botSettings.modelOverride || \"\");\n    }\n  }, [botSettings, availableProviders]);\n\n  const addSourceMutation = useMutation({\n    mutationFn: async (sourceId: number) => {\n      const currentLinks = botSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }));\n      currentLinks.push({ sourceId, weight: 3, isEnabled: true });\n      await apiRequest(\"PUT\", `/api/bots/${botId}/sources`, { links: currentLinks });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\", botId, \"sources\"] });\n      toast({ title: t(\"botDetail.sources.linked\") });\n    },\n    onError: () => {\n      toast({ title: t(\"botDetail.sources.linkFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const removeSourceMutation = useMutation({\n    mutationFn: async (sourceId: number) => {\n      const currentLinks = botSources\n        .filter(s => s.id !== sourceId)\n        .map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }));\n      await apiRequest(\"PUT\", `/api/bots/${botId}/sources`, { links: currentLinks });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\", botId, \"sources\"] });\n      toast({ title: t(\"botDetail.sources.removed\") });\n    },\n    onError: () => {\n      toast({ title: t(\"botDetail.sources.removeFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const saveBotMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"PATCH\", `/api/bots/${botId}`, { name, isEnabled });\n      await apiRequest(\"PUT\", `/api/bots/${botId}/settings`, {\n        timezone,\n        scheduleRule,\n        scheduleTimeLocal,\n        verbosity,\n        markdownLevel,\n        sectionsJson: sections,\n        filtersJson: { minImportanceScore },\n        llmProviderId: llmProviderId ? parseInt(llmProviderId) : null,\n        modelOverride: modelOverride || null,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\", botId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/bots\", botId, \"settings\"] });\n      toast({ title: t(\"botDetail.saved\") });\n    },\n    onError: () => {\n      toast({ title: t(\"botDetail.saveFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!bot) {\n    return (\n      <div className=\"container mx-auto p-6 max-w-4xl\">\n        <p className=\"text-muted-foreground\">{t(\"botDetail.notFound\")}</p>\n        <Button variant=\"ghost\" onClick={() => setLocation(\"/bots\")} data-testid=\"button-back\">\n          <ArrowLeft className=\"h-4 w-4 mr-2\" /> {t(\"botDetail.back\")}\n        </Button>\n      </div>\n    );\n  }\n\n  const scheduleLabel = botSettings\n    ? `${botSettings.scheduleRule === \"DAILY\" ? t(\"botDetail.schedule.daily2\") : botSettings.scheduleRule === \"WEEKDAYS\" ? t(\"botDetail.schedule.weekdays2\") : t(\"botDetail.schedule.weekends2\")} ${botSettings.scheduleTimeLocal}`\n    : null;\n  const formatLabel = botSettings\n    ? `${botSettings.markdownLevel === \"minimal\" ? t(\"botDetail.format.conversational2\") : t(\"botDetail.format.structured2\")} / ${botSettings.verbosity === \"short\" ? t(\"botDetail.format.short2\") : botSettings.verbosity === \"detailed\" ? t(\"botDetail.format.detailed2\") : t(\"botDetail.format.normal2\")}`\n    : null;\n\n  const sectionLabelMap: Record<string, string> = {\n    tldr: t(\"botDetail.format.section.tldr\"),\n    drivers: t(\"botDetail.format.section.drivers\"),\n    risk: t(\"botDetail.format.section.risk\"),\n    checklist: t(\"botDetail.format.section.checklist\"),\n    sources: t(\"botDetail.format.section.sources\"),\n  };\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-4xl\">\n      <div className=\"flex items-center gap-4 mb-6 flex-wrap\">\n        <Button variant=\"ghost\" size=\"icon\" onClick={() => setLocation(\"/bots\")} data-testid=\"button-back\">\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n        <div className=\"flex-1 min-w-0\">\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-bot-title\">{name || t(\"botDetail.title\")}</h1>\n          <div className=\"flex items-center gap-2 mt-1\">\n            <Badge variant=\"outline\" data-testid=\"badge-bot-topic\">{bot.key}</Badge>\n            <span className=\"text-sm text-muted-foreground\">\n              {isEnabled ? t(\"botDetail.active\") : t(\"botDetail.paused\")}\n            </span>\n          </div>\n        </div>\n        <Button onClick={() => saveBotMutation.mutate()} disabled={saveBotMutation.isPending} data-testid=\"button-save\">\n          {saveBotMutation.isPending ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : <Save className=\"h-4 w-4 mr-2\" />}\n          {t(\"botDetail.saveChanges\")}\n        </Button>\n      </div>\n\n      <div className=\"grid gap-6\">\n        <Card className=\"border-primary/20\" data-testid=\"card-workflow-summary\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <Layers className=\"h-4 w-4 text-primary\" />\n              {t(\"botDetail.workflow.title\")}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"pt-0\">\n            <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm\">\n              <div className=\"flex items-start gap-2\">\n                <Rss className=\"h-4 w-4 text-muted-foreground mt-0.5 shrink-0\" />\n                <div>\n                  <span className=\"text-muted-foreground\">{t(\"botDetail.workflow.watching\")}</span>\n                  <span className=\"ml-1 font-medium\" data-testid=\"text-summary-sources\">{t(\"botDetail.workflow.sources\", { count: botSources.length })}</span>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <Clock className=\"h-4 w-4 text-muted-foreground mt-0.5 shrink-0\" />\n                <div>\n                  <span className=\"text-muted-foreground\">{t(\"botDetail.workflow.schedule\")}</span>\n                  <span className=\"ml-1 font-medium\" data-testid=\"text-summary-schedule\">{scheduleLabel || t(\"botDetail.workflow.notSet\")}</span>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <FileText className=\"h-4 w-4 text-muted-foreground mt-0.5 shrink-0\" />\n                <div>\n                  <span className=\"text-muted-foreground\">{t(\"botDetail.workflow.output\")}</span>\n                  <span className=\"ml-1 font-medium\" data-testid=\"text-summary-format\">{formatLabel || t(\"botDetail.workflow.notSet\")}</span>\n                </div>\n              </div>\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-3 pt-3 border-t border-border\" data-testid=\"text-summary-hint\">\n              {t(\"botDetail.workflow.hint\")}\n            </p>\n          </CardContent>\n        </Card>\n\n        {botId && <PermissionDashboard botId={botId} t={t} language={language} />}\n\n        {botId && <MemoryCard botId={botId} t={t} language={language} />}\n\n        <Card>\n          <CardHeader>\n            <CardTitle>{t(\"botDetail.general\")}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"bot-name\">{t(\"botDetail.botName\")}</Label>\n              <Input id=\"bot-name\" value={name} onChange={(e) => setName(e.target.value)} data-testid=\"input-bot-name\" />\n            </div>\n            <div className=\"flex items-center justify-between gap-2\">\n              <Label htmlFor=\"bot-enabled\">{t(\"botDetail.enabled\")}</Label>\n              <Switch id=\"bot-enabled\" checked={isEnabled} onCheckedChange={setIsEnabled} data-testid=\"toggle-bot-enabled\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Brain className=\"h-5 w-5\" />\n              {t(\"botDetail.aiModel.title\")}\n            </CardTitle>\n            <CardDescription>\n              {t(\"botDetail.aiModel.subtitle\")}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            {providerWasDeleted && (\n              <div className=\"flex items-start gap-2 p-3 rounded-md bg-destructive/10 text-destructive text-sm\" data-testid=\"warning-provider-deleted\">\n                <AlertTriangle className=\"h-4 w-4 mt-0.5 shrink-0\" />\n                <span>{t(\"botDetail.aiModel.providerDeleted\")}</span>\n              </div>\n            )}\n            <div className=\"grid gap-2\">\n              <Label>{t(\"botDetail.aiModel.provider\")}</Label>\n              <Select value={llmProviderId} onValueChange={setLlmProviderId}>\n                <SelectTrigger data-testid=\"select-llm-provider\">\n                  <SelectValue placeholder={t(\"botDetail.aiModel.providerPlaceholder\")} />\n                </SelectTrigger>\n                <SelectContent>\n                  {availableProviders.map((p) => (\n                    <SelectItem key={p.id} value={String(p.id)}>{p.name} ({p.providerType})</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              {availableProviders.length === 0 && (\n                <p className=\"text-xs text-muted-foreground\">\n                  {t(\"botDetail.aiModel.noProviders\")}\n                </p>\n              )}\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"model-override\">{t(\"botDetail.aiModel.modelOverride\")} <span className=\"text-xs text-muted-foreground\">{t(\"botDetail.aiModel.modelOverrideHint\")}</span></Label>\n              <Input\n                id=\"model-override\"\n                value={modelOverride}\n                onChange={(e) => setModelOverride(e.target.value)}\n                placeholder={t(\"botDetail.aiModel.modelOverridePlaceholder\")}\n                data-testid=\"input-model-override\"\n              />\n              {modelHints.length > 0 && (\n                <p className=\"text-xs text-muted-foreground\" data-testid=\"text-model-hints\">\n                  {t(\"botDetail.aiModel.availableModels\", { type: providerType, models: modelHints.join(\", \") })}\n                </p>\n              )}\n              {modelOverride && selectedProvider && !modelHints.includes(modelOverride) && modelHints.length > 0 && (\n                <p className=\"text-xs text-yellow-600 dark:text-yellow-400 flex items-center gap-1\" data-testid=\"warning-model-mismatch\">\n                  <AlertTriangle className=\"h-3 w-3\" />\n                  {t(\"botDetail.aiModel.modelMismatch\", { type: providerType })}\n                </p>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Clock className=\"h-5 w-5\" />\n              {t(\"botDetail.schedule.title\")}\n            </CardTitle>\n            <CardDescription>{t(\"botDetail.schedule.subtitle\")}</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            <div className=\"grid gap-2\">\n              <Label>{t(\"botDetail.schedule.runDays\")}</Label>\n              <Select value={scheduleRule} onValueChange={setScheduleRule}>\n                <SelectTrigger data-testid=\"select-schedule-rule\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"DAILY\">{t(\"botDetail.schedule.daily\")}</SelectItem>\n                  <SelectItem value=\"WEEKDAYS\">{t(\"botDetail.schedule.weekdays\")}</SelectItem>\n                  <SelectItem value=\"WEEKENDS\">{t(\"botDetail.schedule.weekends\")}</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-2\">\n              <Label>{t(\"botDetail.schedule.runTime\")}</Label>\n              <Select value={scheduleTimeLocal} onValueChange={setScheduleTimeLocal}>\n                <SelectTrigger data-testid=\"select-schedule-time\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {SCHEDULE_TIMES.map(st => (\n                    <SelectItem key={st.value} value={st.value}>{st.label}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-2\">\n              <Label>{t(\"botDetail.schedule.timezone\")}</Label>\n              <Select value={timezone} onValueChange={setTimezone}>\n                <SelectTrigger data-testid=\"select-timezone\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"Asia/Seoul\">Asia/Seoul (KST)</SelectItem>\n                  <SelectItem value=\"America/New_York\">America/New_York (ET)</SelectItem>\n                  <SelectItem value=\"America/Los_Angeles\">America/Los_Angeles (PT)</SelectItem>\n                  <SelectItem value=\"Europe/London\">Europe/London (GMT)</SelectItem>\n                  <SelectItem value=\"UTC\">UTC</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <FileText className=\"h-5 w-5\" />\n              {t(\"botDetail.format.title\")}\n            </CardTitle>\n            <CardDescription>{t(\"botDetail.format.subtitle\")}</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            <div className=\"grid gap-2\">\n              <Label>{t(\"botDetail.format.length\")}</Label>\n              <Select value={verbosity} onValueChange={setVerbosity}>\n                <SelectTrigger data-testid=\"select-verbosity\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"short\">{t(\"botDetail.format.short\")}</SelectItem>\n                  <SelectItem value=\"normal\">{t(\"botDetail.format.normal\")}</SelectItem>\n                  <SelectItem value=\"detailed\">{t(\"botDetail.format.detailed\")}</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-2\">\n              <Label>{t(\"botDetail.format.style\")}</Label>\n              <Select value={markdownLevel} onValueChange={setMarkdownLevel}>\n                <SelectTrigger data-testid=\"select-markdown\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"minimal\">{t(\"botDetail.format.conversational\")}</SelectItem>\n                  <SelectItem value=\"normal\">{t(\"botDetail.format.structured\")}</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"grid gap-2\">\n              <Label className=\"mb-2\">{t(\"botDetail.format.sections\")}</Label>\n              {Object.entries(sections).map(([key, value]) => (\n                <div key={key} className=\"flex items-center gap-2\">\n                  <Checkbox\n                    id={`section-${key}`}\n                    checked={value}\n                    onCheckedChange={(checked) => setSections(prev => ({ ...prev, [key]: !!checked }))}\n                    data-testid={`checkbox-section-${key}`}\n                  />\n                  <Label htmlFor={`section-${key}`} className=\"font-normal\">\n                    {sectionLabelMap[key] || key}\n                  </Label>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Filter className=\"h-5 w-5\" />\n              {t(\"botDetail.filters.title\")}\n            </CardTitle>\n            <CardDescription>{t(\"botDetail.filters.subtitle\")}</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            <div className=\"grid gap-2\">\n              <Label>{t(\"botDetail.filters.minImportance\", { score: minImportanceScore })}</Label>\n              <Slider\n                value={[minImportanceScore]}\n                onValueChange={([v]) => setMinImportanceScore(v)}\n                min={0}\n                max={100}\n                step={10}\n                data-testid=\"slider-importance\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                {t(\"botDetail.filters.hint\")}\n                {minImportanceScore > 0 && ` ${t(\"botDetail.filters.filtering\", { score: minImportanceScore })}`}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Rss className=\"h-5 w-5\" />\n              {t(\"botDetail.sources.title\", { count: botSources.length })}\n            </CardTitle>\n            <CardDescription>{t(\"botDetail.sources.subtitle\")}</CardDescription>\n          </CardHeader>\n          <CardContent className=\"grid gap-4\">\n            {botSources.length === 0 ? (\n              <div className=\"text-center py-4 text-muted-foreground\" data-testid=\"text-no-sources\">\n                <p>{t(\"botDetail.sources.none\")}</p>\n                <p className=\"text-xs mt-1\">{t(\"botDetail.sources.noneHint\")}</p>\n              </div>\n            ) : (\n              <div className=\"grid gap-2\">\n                {botSources.map((source: SourceLink) => (\n                  <div key={source.id} className=\"flex items-center justify-between gap-2 p-3 rounded-md border\" data-testid={`source-link-${source.id}`}>\n                    <div className=\"min-w-0 flex-1\">\n                      <span className=\"font-medium\">{source.name}</span>\n                      <Badge variant=\"secondary\" className=\"ml-2\">{source.topic}</Badge>\n                    </div>\n                    <div className=\"flex items-center gap-3 shrink-0\">\n                      <span className=\"text-xs text-muted-foreground\">{t(\"botDetail.sources.weight\", { weight: source.weight })}</span>\n                      <Button\n                        size=\"icon\"\n                        variant=\"ghost\"\n                        onClick={() => removeSourceMutation.mutate(source.id)}\n                        disabled={removeSourceMutation.isPending}\n                        data-testid={`button-unlink-source-${source.id}`}\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {unlinkedSources.length > 0 && (\n              <div className=\"grid gap-2\">\n                <p className=\"text-sm font-medium text-muted-foreground\">{t(\"botDetail.sources.available\")}</p>\n                {unlinkedSources.map(source => (\n                  <div key={source.id} className=\"flex items-center justify-between gap-2 p-3 rounded-md border border-dashed\" data-testid={`available-source-${source.id}`}>\n                    <div className=\"min-w-0 flex-1\">\n                      <span className=\"font-medium\">{source.name}</span>\n                      <Badge variant=\"secondary\" className=\"ml-2\">{source.topic}</Badge>\n                    </div>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => addSourceMutation.mutate(source.id)}\n                      disabled={addSourceMutation.isPending}\n                      data-testid={`button-link-source-${source.id}`}\n                    >\n                      <Plus className=\"h-4 w-4 mr-1\" />\n                      {t(\"botDetail.sources.add\")}\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {unlinkedSources.length === 0 && botSources.length === 0 && (\n              <div className=\"text-center py-2\">\n                <Button variant=\"outline\" onClick={() => setLocation(\"/sources\")} data-testid=\"button-go-to-sources\">\n                  {t(\"botDetail.sources.goToSources\")}\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {diagnosisData && diagnosisData.items.length > 0 && (\n          <Card data-testid=\"card-bot-diagnosis\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <Activity className=\"h-5 w-5\" />\n                {t(\"diag.title\")}\n              </CardTitle>\n              <Badge\n                variant={diagnosisData.health === \"healthy\" ? \"secondary\" : diagnosisData.health === \"warning\" ? \"outline\" : \"destructive\"}\n                data-testid=\"badge-bot-health\"\n              >\n                {diagnosisData.health === \"healthy\"\n                  ? t(\"diag.healthy\")\n                  : diagnosisData.health === \"warning\"\n                    ? t(\"diag.warnings\", { count: String(diagnosisData.items.filter(i => i.severity === \"warning\").length) })\n                    : t(\"diag.errors\", { count: String(diagnosisData.items.filter(i => i.severity === \"error\").length) })}\n              </Badge>\n            </CardHeader>\n            <CardContent className=\"grid gap-2\">\n              {diagnosisData.items.map((item, idx) => (\n                <div key={idx} className=\"flex items-start gap-2 p-2 rounded-md border\" data-testid={`diag-item-${item.rule}`}>\n                  {item.severity === \"error\" && <XCircle className=\"h-4 w-4 text-destructive shrink-0 mt-0.5\" />}\n                  {item.severity === \"warning\" && <AlertTriangle className=\"h-4 w-4 text-yellow-500 shrink-0 mt-0.5\" />}\n                  {item.severity === \"info\" && <Info className=\"h-4 w-4 text-muted-foreground shrink-0 mt-0.5\" />}\n                  <span className=\"text-sm\">{language === \"ko\" ? item.messageKo : item.messageEn}</span>\n                </div>\n              ))}\n            </CardContent>\n          </Card>\n        )}\n\n        <Card data-testid=\"card-execution-history\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Clock className=\"h-5 w-5\" />\n              {t(\"runs.title\")}\n            </CardTitle>\n            {runsData && runsData.length > 0 && (\n              <Sheet>\n                <SheetTrigger asChild>\n                  <Button variant=\"outline\" size=\"sm\" data-testid=\"button-view-all-runs\">\n                    {t(\"runs.viewAll\")}\n                  </Button>\n                </SheetTrigger>\n                <SheetContent className=\"w-full sm:max-w-lg overflow-y-auto\">\n                  <SheetHeader>\n                    <SheetTitle>{t(\"runs.title\")}</SheetTitle>\n                  </SheetHeader>\n                  <div className=\"grid gap-3 mt-4\">\n                    {runsData.map(run => (\n                      <RunRow key={run.id} run={run} t={t} language={language} />\n                    ))}\n                  </div>\n                </SheetContent>\n              </Sheet>\n            )}\n          </CardHeader>\n          <CardContent>\n            {!runsData || runsData.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-runs-empty\">{t(\"runs.empty\")}</p>\n            ) : (\n              <div className=\"grid gap-2\">\n                {runsData.slice(0, 5).map(run => (\n                  <RunRow key={run.id} run={run} t={t} language={language} />\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nfunction RunStatusIcon({ status }: { status: string }) {\n  switch (status) {\n    case \"ok\": return <CheckCircle2 className=\"h-4 w-4 text-green-500\" />;\n    case \"error\": return <XCircle className=\"h-4 w-4 text-destructive\" />;\n    case \"timeout\": return <Timer className=\"h-4 w-4 text-yellow-500\" />;\n    case \"skipped\": return <SkipForward className=\"h-4 w-4 text-muted-foreground\" />;\n    case \"started\": return <Play className=\"h-4 w-4 text-blue-500\" />;\n    default: return <Activity className=\"h-4 w-4 text-muted-foreground\" />;\n  }\n}\n\nfunction formatDuration(ms: number | null): string {\n  if (ms == null) return \"-\";\n  if (ms < 1000) return `${ms}ms`;\n  return `${(ms / 1000).toFixed(1)}s`;\n}\n\nfunction formatTimeAgo(dateStr: string, language: string): string {\n  const diffMs = Date.now() - new Date(dateStr).getTime();\n  const mins = Math.floor(diffMs / 60000);\n  if (mins < 1) return language === \"ko\" ? \"방금 전\" : \"just now\";\n  if (mins < 60) return language === \"ko\" ? `${mins}분 전` : `${mins}m ago`;\n  const hours = Math.floor(mins / 60);\n  if (hours < 24) return language === \"ko\" ? `${hours}시간 전` : `${hours}h ago`;\n  const days = Math.floor(hours / 24);\n  return language === \"ko\" ? `${days}일 전` : `${days}d ago`;\n}\n\nfunction RunRow({ run, t, language }: { run: JobRunData; t: (key: string) => string; language: string }) {\n  return (\n    <div className=\"flex items-center justify-between gap-2 p-2 rounded-md border\" data-testid={`run-row-${run.id}`}>\n      <div className=\"flex items-center gap-2 min-w-0\">\n        <RunStatusIcon status={run.status} />\n        <div className=\"min-w-0\">\n          <div className=\"flex items-center gap-1.5 flex-wrap\">\n            <Badge variant=\"secondary\">{t(`runs.jobType.${run.jobType}`) || run.jobType}</Badge>\n            <span className=\"text-xs text-muted-foreground\">{t(`runs.trigger.${run.trigger}`) || run.trigger}</span>\n          </div>\n          {run.status === \"error\" && run.errorMessage && (\n            <p className=\"text-xs text-destructive mt-0.5 truncate\">{run.errorMessage}</p>\n          )}\n          {run.status === \"skipped\" && run.errorCode && (\n            <p className=\"text-xs text-muted-foreground mt-0.5\">{run.errorCode}</p>\n          )}\n        </div>\n      </div>\n      <div className=\"text-right shrink-0\">\n        <p className=\"text-xs text-muted-foreground\">{formatTimeAgo(run.startedAt, language)}</p>\n        {run.durationMs != null && run.durationMs > 0 && (\n          <p className=\"text-xs text-muted-foreground\">{formatDuration(run.durationMs)}</p>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":34319,"size_tokens":null},"server/lib/crypto.ts":{"content":"import crypto from \"crypto\";\n\nconst ALGORITHM = \"aes-256-gcm\";\nconst IV_LENGTH = 16;\nconst TAG_LENGTH = 16;\n\nfunction getKey(): Buffer {\n  const secret = process.env.SESSION_SECRET || \"maker-local-session-secret\";\n  return crypto.createHash(\"sha256\").update(secret).digest();\n}\n\nexport function encrypt(plaintext: string): string {\n  const key = getKey();\n  const iv = crypto.randomBytes(IV_LENGTH);\n  const cipher = crypto.createCipheriv(ALGORITHM, key, iv);\n  const encrypted = Buffer.concat([cipher.update(plaintext, \"utf8\"), cipher.final()]);\n  const tag = cipher.getAuthTag();\n  return Buffer.concat([iv, tag, encrypted]).toString(\"base64\");\n}\n\nexport function decrypt(ciphertext: string): string {\n  const key = getKey();\n  const buf = Buffer.from(ciphertext, \"base64\");\n  const iv = buf.subarray(0, IV_LENGTH);\n  const tag = buf.subarray(IV_LENGTH, IV_LENGTH + TAG_LENGTH);\n  const encrypted = buf.subarray(IV_LENGTH + TAG_LENGTH);\n  const decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\n  decipher.setAuthTag(tag);\n  return decipher.update(encrypted) + decipher.final(\"utf8\");\n}\n","path":null,"size_bytes":1095,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"server/jobs/scheduler.ts":{"content":"import cron from \"node-cron\";\nimport { collectAllSources } from \"../services/rss\";\nimport { analyzeNewItems } from \"./analyze_items\";\nimport { draftForAnalyzed } from \"./draft_replies\";\nimport { generateDailyBrief } from \"./generate_daily_brief\";\nimport { generateReportsForDueProfiles, generateReportForProfile } from \"./report\";\nimport { hasSystemLLMKey, hasAnyLLMAvailable } from \"../llm/client\";\n\nlet collectTask: ReturnType<typeof cron.schedule> | null = null;\nlet analyzeTask: ReturnType<typeof cron.schedule> | null = null;\nlet draftTask: ReturnType<typeof cron.schedule> | null = null;\nlet dailyBriefTask: ReturnType<typeof cron.schedule> | null = null;\nlet reportTask: ReturnType<typeof cron.schedule> | null = null;\nlet isRunning = false;\n\nlet lastCollect: Date | null = null;\nlet lastAnalyze: Date | null = null;\nlet lastDraft: Date | null = null;\nlet lastDailyBrief: Date | null = null;\nlet lastReportRun: Date | null = null;\n\nexport function startScheduler() {\n  if (isRunning) {\n    console.log(\"Scheduler already running\");\n    return;\n  }\n\n  collectTask = cron.schedule(\"*/10 * * * *\", async () => {\n    console.log(\"🔄 Running RSS collection job...\");\n    try {\n      const result = await collectAllSources();\n      lastCollect = new Date();\n      console.log(`✓ Collected ${result.totalCollected} items from ${result.sourcesProcessed} sources`);\n    } catch (error) {\n      console.error(\"RSS collection failed:\", error);\n    }\n  });\n\n  analyzeTask = cron.schedule(\"*/5 * * * *\", async () => {\n    if (!hasAnyLLMAvailable()) return;\n    console.log(\"🔍 Running analysis job...\");\n    try {\n      const count = await analyzeNewItems();\n      lastAnalyze = new Date();\n      console.log(`✓ Analyzed ${count} items`);\n    } catch (error) {\n      console.error(\"Analysis job failed:\", error);\n    }\n  });\n\n  draftTask = cron.schedule(\"*/5 * * * *\", async () => {\n    if (!hasAnyLLMAvailable()) return;\n    console.log(\"✏️ Running draft generation job...\");\n    try {\n      const count = await draftForAnalyzed();\n      lastDraft = new Date();\n      console.log(`✓ Generated drafts for ${count} items`);\n    } catch (error) {\n      console.error(\"Draft generation failed:\", error);\n    }\n  });\n\n  const tz = process.env.REPORT_TZ || \"Asia/Seoul\";\n  const dailyBriefCron = process.env.DAILY_BRIEF_CRON || \"0 22 * * *\";\n  \n  console.log(`[Scheduler] Daily Brief scheduled: \"${dailyBriefCron}\" (${tz})`);\n  \n  dailyBriefTask = cron.schedule(dailyBriefCron, async () => {\n    if (!hasAnyLLMAvailable()) { console.log(\"[DailyBrief] Skipped: no LLM available\"); return; }\n    console.log(\"📊 Running Daily Brief generation job (delegated to profile-based report job)...\");\n    try {\n      const results = await generateReportsForDueProfiles();\n      lastDailyBrief = new Date();\n      console.log(`✓ Generated ${results.length} report(s) via profile-based system`);\n    } catch (error) {\n      console.error(\"Daily Brief generation failed:\", error);\n    }\n  }, { timezone: tz });\n\n  reportTask = cron.schedule(\"*/5 * * * *\", async () => {\n    if (!hasAnyLLMAvailable()) return;\n    try {\n      const results = await generateReportsForDueProfiles();\n      lastReportRun = new Date();\n      if (results.length > 0) {\n        console.log(`✓ Generated ${results.length} profile reports`);\n      }\n    } catch (error) {\n      console.error(\"Profile Report generation failed:\", error);\n    }\n  });\n\n  isRunning = true;\n  if (!hasAnyLLMAvailable()) {\n    console.log(\"[Scheduler] No LLM available. Collect job runs normally. Analyze/Draft/Report/DailyBrief jobs paused until a provider is configured.\");\n  }\n  console.log(\"🕒 Scheduler started\");\n}\n\nexport function stopScheduler() {\n  if (!isRunning) {\n    console.log(\"Scheduler not running\");\n    return;\n  }\n\n  collectTask?.stop();\n  analyzeTask?.stop();\n  draftTask?.stop();\n  dailyBriefTask?.stop();\n  reportTask?.stop();\n  isRunning = false;\n  console.log(\"🕒 Scheduler stopped\");\n}\n\nexport function getSchedulerStatus() {\n  const systemLLMAvailable = hasAnyLLMAvailable();\n  return {\n    isRunning,\n    systemLLMAvailable,\n    collectInterval: \"10 minutes\",\n    analyzeInterval: systemLLMAvailable ? \"5 minutes\" : \"paused (no LLM available)\",\n    draftInterval: systemLLMAvailable ? \"5 minutes\" : \"paused (no LLM available)\",\n    reportInterval: \"5 minutes (profile-based)\",\n    dailyBriefSchedule: systemLLMAvailable ? (process.env.DAILY_BRIEF_CRON || \"0 22 * * * (KST)\") : \"paused (no LLM available)\",\n    lastCollect: lastCollect?.toISOString(),\n    lastAnalyze: lastAnalyze?.toISOString(),\n    lastDraft: lastDraft?.toISOString(),\n    lastDailyBrief: lastDailyBrief?.toISOString(),\n    lastReportRun: lastReportRun?.toISOString(),\n  };\n}\n\nexport async function runCollectNow() {\n  console.log(\"🔄 Manual RSS collection triggered...\");\n  const result = await collectAllSources();\n  lastCollect = new Date();\n  return result;\n}\n\nexport async function runAnalyzeNow() {\n  if (!hasAnyLLMAvailable()) throw new Error(\"No LLM configured. Add an AI Provider in Settings or set LLM_API_KEY.\");\n  console.log(\"🔍 Manual analysis triggered...\");\n  const count = await analyzeNewItems();\n  lastAnalyze = new Date();\n  return count;\n}\n\nexport async function runDraftNow() {\n  if (!hasAnyLLMAvailable()) throw new Error(\"No LLM configured. Add an AI Provider in Settings or set LLM_API_KEY.\");\n  console.log(\"✏️ Manual draft generation triggered...\");\n  const count = await draftForAnalyzed();\n  lastDraft = new Date();\n  return count;\n}\n\nexport async function runDailyBriefNow(topic: string = \"general\", lookbackHours: number = 24, maxItems: number = 12) {\n  if (!hasAnyLLMAvailable()) throw new Error(\"No LLM configured. Add an AI Provider in Settings or set LLM_API_KEY.\");\n  console.log(`📊 Manual Daily Brief generation triggered for topic=${topic}, lookback=${lookbackHours}h, max=${maxItems}...`);\n  const result = await generateDailyBrief({\n    lookbackHours,\n    maxItems,\n    topic,\n    force: true,\n  });\n  lastDailyBrief = new Date();\n  return result;\n}\n\nexport async function runReportNow(profileId?: number, userId?: string) {\n  if (!hasAnyLLMAvailable()) throw new Error(\"No LLM configured. Add an AI Provider in Settings or set LLM_API_KEY.\");\n  console.log(`📊 Manual Report generation triggered${profileId ? ` for profile ${profileId}` : \" for all due profiles\"}...`);\n  if (profileId) {\n    const result = await generateReportForProfile(profileId, userId);\n    lastReportRun = new Date();\n    return result;\n  } else {\n    const results = await generateReportsForDueProfiles();\n    lastReportRun = new Date();\n    return results;\n  }\n}\n","path":null,"size_bytes":6640,"size_tokens":null},"server/jobs/generate_daily_brief.ts":{"content":"import { storage } from \"../storage\";\nimport { callLLM } from \"../llm/client\";\nimport { buildDailyBriefPrompt, getTopicLabel } from \"../llm/prompts\";\n\ninterface DailyBriefOptions {\n  lookbackHours?: number;\n  maxItems?: number;\n  topic?: string;\n  force?: boolean;\n}\n\ninterface DailyBriefResult {\n  id: number;\n  itemsCount: number;\n}\n\nexport async function generateDailyBrief(options: DailyBriefOptions = {}): Promise<DailyBriefResult> {\n  const { lookbackHours = 24, maxItems = 12, topic = \"general\" } = options;\n\n  console.log(`[DailyBrief] Generating report for topic=${topic}, lookback=${lookbackHours}h, maxItems=${maxItems}`);\n\n  const items = await storage.getAnalyzedItemsForBrief(lookbackHours, maxItems, topic);\n  \n  if (items.length === 0) {\n    console.log(\"[DailyBrief] No analyzed items found for the lookback period\");\n    const noDataLabel = getTopicLabel(topic);\n    const report = await storage.createReport({\n      topic,\n      title: `${noDataLabel} - No Data`,\n      content: `# ${noDataLabel}\\n\\n> No analyzed items found. Please try again after data collection.`,\n      itemsCount: 0,\n      itemIdsJson: [],\n    });\n    return { id: report.id, itemsCount: 0 };\n  }\n\n  const today = new Date().toLocaleDateString(\"en-US\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n    weekday: \"long\",\n    timeZone: \"Asia/Seoul\",\n  });\n\n  const prompt = buildDailyBriefPrompt(items, today, topic);\n\n  console.log(`[DailyBrief] Calling LLM with ${items.length} items...`);\n  \n  const content = await callLLM(prompt, 3, 4000);\n\n  const topicLabel = getTopicLabel(topic);\n\n  const report = await storage.createReport({\n    topic,\n    title: `${topicLabel} - ${today}`,\n    content,\n    itemsCount: items.length,\n    itemIdsJson: items.map((i) => i.id),\n  });\n\n  console.log(`[DailyBrief] Report created with ID=${report.id}`);\n\n  return { id: report.id, itemsCount: items.length };\n}\n","path":null,"size_bytes":1907,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/language-switcher.tsx":{"content":"import { useLanguage } from \"@/lib/language-provider\";\nimport { Button } from \"@/components/ui/button\";\nimport { Globe } from \"lucide-react\";\n\nexport function LanguageSwitcher() {\n  const { language, setLanguage, t } = useLanguage();\n\n  const toggle = () => {\n    setLanguage(language === \"en\" ? \"ko\" : \"en\");\n  };\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"sm\"\n      onClick={toggle}\n      data-testid=\"button-language-toggle\"\n      className=\"gap-1.5\"\n    >\n      <Globe className=\"h-4 w-4\" />\n      <span className=\"text-xs font-medium\">{language === \"en\" ? t(\"lang.en\") : t(\"lang.ko\")}</span>\n    </Button>\n  );\n}\n","path":null,"size_bytes":633,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"server/chat/commandRouter.ts":{"content":"import type { ChatCommand, PipelineRunArgs } from \"@shared/chatCommand\";\nimport { runCollectNow, runAnalyzeNow, runDraftNow, runReportNow } from \"../jobs/scheduler\";\nimport { collectFromSourceIds } from \"../services/rss\";\nimport { analyzeNewItemsBySourceIds } from \"../jobs/analyze_items\";\nimport { generateFastReport, upgradeToFullReport } from \"../jobs/report\";\nimport { hasSystemLLMKey } from \"../llm/client\";\nimport { storage } from \"../storage\";\nimport { startRun, endRunOk, endRunError, endRunTimeout } from \"../jobs/runLogger\";\n\nexport interface ExecutionResult {\n  ok: boolean;\n  assistantMessage: string;\n  executed: ChatCommand;\n  result: any;\n}\n\nfunction clamp(value: number, min: number, max: number): number {\n  return Math.max(min, Math.min(max, value));\n}\n\nasync function resolveBot(userId: string, botKey: string | null) {\n  if (!botKey) return null;\n  return storage.getBotByKey(userId, botKey);\n}\n\nasync function execListBots(userId: string, cmd: ChatCommand): Promise<ExecutionResult> {\n  const bots = await storage.listBots(userId);\n  if (bots.length === 0) {\n    return {\n      ok: true,\n      assistantMessage: \"No bots registered. Create one from the Template Gallery.\",\n      executed: cmd,\n      result: { bots: [] },\n    };\n  }\n\n  const lines = bots.map((b, i) => {\n    const status = b.isEnabled ? \"Active\" : \"Paused\";\n    const schedule = b.settings?.scheduleRule || \"DAILY\";\n    const time = b.settings?.scheduleTimeLocal || \"07:00\";\n    return `${i + 1}. ${b.name} (${b.key}) — ${status}, ${schedule} ${time}`;\n  });\n\n  return {\n    ok: true,\n    assistantMessage: `${bots.length} bot(s):\\n${lines.join(\"\\n\")}`,\n    executed: cmd,\n    result: { bots: bots.map(b => ({ id: b.id, key: b.key, name: b.name, isEnabled: b.isEnabled })) },\n  };\n}\n\nasync function execSwitchBot(userId: string, cmd: ChatCommand, threadId?: number): Promise<ExecutionResult> {\n  if (!cmd.botKey) {\n    return { ok: false, assistantMessage: \"Please specify the bot key to switch to. e.g. 'switch to investing'\", executed: cmd, result: null };\n  }\n\n  const bot = await resolveBot(userId, cmd.botKey);\n  if (!bot) {\n    return { ok: false, assistantMessage: `Bot '${cmd.botKey}' not found. Try 'list bots' to see available bots.`, executed: cmd, result: null };\n  }\n\n  if (threadId) {\n    await storage.setThreadActiveBot(threadId, userId, bot.id);\n  }\n  return {\n    ok: true,\n    assistantMessage: `Switched active bot to '${bot.name}' (${bot.key}).`,\n    executed: cmd,\n    result: { botId: bot.id, botKey: bot.key },\n  };\n}\n\nasync function execBotStatus(userId: string, cmd: ChatCommand): Promise<ExecutionResult> {\n  const bot = await resolveBot(userId, cmd.botKey);\n  if (!bot) {\n    return { ok: false, assistantMessage: cmd.botKey ? `Bot '${cmd.botKey}' not found.` : \"No active bot. Please switch to a bot first.\", executed: cmd, result: null };\n  }\n\n  const fullBot = await storage.getBot(bot.id, userId);\n  const botSources = await storage.getBotSources(bot.id);\n  const enabledSources = botSources.filter(s => s.isEnabled);\n\n  const status = fullBot?.isEnabled ? \"Active\" : \"Paused\";\n  const schedule = fullBot?.settings?.scheduleRule || \"DAILY\";\n  const time = fullBot?.settings?.scheduleTimeLocal || \"07:00\";\n  const format = fullBot?.settings?.format || \"clean\";\n  const verbosity = fullBot?.settings?.verbosity || \"normal\";\n\n  const sourceList = enabledSources.length > 0\n    ? enabledSources.map(s => `  - ${s.name}`).join(\"\\n\")\n    : \"  (no sources)\";\n\n  return {\n    ok: true,\n    assistantMessage: `${fullBot?.name} (${bot.key})\\nStatus: ${status}\\nSchedule: ${schedule} ${time}\\nFormat: ${format} / ${verbosity}\\n${enabledSources.length} source(s):\\n${sourceList}`,\n    executed: cmd,\n    result: { botId: bot.id, status, schedule, sources: enabledSources.length },\n  };\n}\n\nasync function execRunNow(userId: string, cmd: ChatCommand): Promise<ExecutionResult> {\n  const job = cmd.args?.job || \"collect\";\n\n  try {\n    let message: string;\n    let result: any;\n\n    const bot = cmd.botKey ? await resolveBot(userId, cmd.botKey) : null;\n    const botSources = bot ? await storage.getBotSources(bot.id) : [];\n    const botSourceIds = botSources.map(s => s.id);\n\n    switch (job) {\n      case \"collect\":\n        if (botSourceIds.length > 0) {\n          result = await collectFromSourceIds(botSourceIds);\n          message = `Collection complete: ${result.totalCollected} new item(s) from ${result.sourcesProcessed} bot sources.`;\n        } else {\n          result = await runCollectNow();\n          message = `Collection complete: ${result.totalCollected} new item(s).`;\n        }\n        break;\n      case \"analyze\":\n        if (botSourceIds.length > 0) {\n          result = await analyzeNewItemsBySourceIds(botSourceIds, 15, 5);\n          message = `Analysis complete: ${result} item(s) analyzed.`;\n        } else {\n          result = await runAnalyzeNow();\n          message = `Analysis complete: ${result} item(s) analyzed.`;\n        }\n        break;\n      case \"draft\":\n        result = await runDraftNow();\n        message = `Drafting complete: ${result} draft(s) generated.`;\n        break;\n      case \"report\": {\n        if (!cmd.botKey) {\n          return { ok: false, assistantMessage: \"No active bot. Please select a bot first.\\n\\nExample: 'switch to community_research'\", executed: cmd, result: null };\n        }\n        const topic = cmd.botKey;\n        const reportBot = await resolveBot(userId, topic);\n        if (!reportBot) {\n          return { ok: false, assistantMessage: `No bot found for topic '${topic}'. Create a bot first from the Template Gallery.`, executed: cmd, result: null };\n        }\n\n        let profile = await storage.getProfileByUserAndTopic(userId, topic);\n        if (!profile) {\n          const fullBot = await storage.getBot(reportBot.id, userId);\n          const allPresets = await storage.listPresets();\n          const reportPresets = allPresets.filter(p => p.outputType === \"report\");\n          const matchingPreset = reportPresets.find(p => {\n            const variants = (p.variantsJson as string[]) || [];\n            return variants.includes(topic) || p.key === topic;\n          }) || reportPresets[0];\n\n          if (!matchingPreset) {\n            return { ok: false, assistantMessage: `No report template found. Please create a bot from the Template Gallery first.`, executed: cmd, result: null };\n          }\n\n          const settings = fullBot?.settings;\n          const scheduleCron = settings\n            ? `${settings.scheduleTimeLocal?.split(\":\")[1] || \"0\"} ${settings.scheduleTimeLocal?.split(\":\")[0] || \"7\"} * * ${settings.scheduleRule === \"WEEKDAYS\" ? \"1-5\" : settings.scheduleRule === \"WEEKENDS\" ? \"0,6\" : \"*\"}`\n            : \"0 7 * * *\";\n\n          const defaultSections = { tldr: true, drivers: true, risk: true, checklist: true, sources: true };\n          const defaultFilters = { minImportanceScore: 0 };\n          profile = await storage.createProfile({\n            userId,\n            presetId: matchingPreset.id,\n            name: reportBot.name,\n            topic,\n            timezone: settings?.timezone || \"Asia/Seoul\",\n            scheduleCron,\n            configJson: {\n              sections: settings?.sectionsJson || defaultSections,\n              filters: settings?.filtersJson || defaultFilters,\n              verbosity: settings?.verbosity || \"normal\",\n              markdownLevel: settings?.markdownLevel || \"minimal\",\n              scheduleRule: settings?.scheduleRule || \"DAILY\",\n              scheduleTimeLocal: settings?.scheduleTimeLocal || \"07:00\",\n            },\n            isActive: reportBot.isEnabled,\n          });\n\n          const reportBotSources = await storage.getBotSources(reportBot.id);\n          if (reportBotSources.length > 0) {\n            await storage.setProfileSources(\n              profile.id,\n              userId,\n              reportBotSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }))\n            );\n          } else {\n            return { ok: false, assistantMessage: `Bot '${reportBot.name}' has no sources. Please add sources first.`, executed: cmd, result: null };\n          }\n        }\n\n        const reportSourceIds = await storage.getProfileSourceIds(profile.id);\n        const reportBotSourceList = await storage.getBotSources(reportBot.id);\n        const reportSourceNames = reportBotSourceList.length > 0\n          ? reportBotSourceList.map(s => s.name)\n          : botSources.map(s => s.name);\n        const fastResult = await generateFastReport({\n          profileId: profile.id,\n          userId,\n          presetId: profile.presetId,\n          topic,\n          profileName: profile.name,\n          sourceIds: reportSourceIds,\n          collectResult: { totalCollected: 0, sourcesProcessed: 0 },\n          sourceNames: reportSourceNames,\n          timezone: profile.timezone || \"Asia/Seoul\",\n        });\n\n        const topicLabel = topic.replace(/_/g, \" \").replace(/\\b\\w/g, c => c.toUpperCase());\n        message = fastResult.itemsCount > 0\n          ? `${topicLabel} 초기 브리핑이 제출되었습니다 (${fastResult.itemsCount}건).\\nReports 페이지에서 확인하세요.\\n\\n심화 분석은 백그라운드에서 자동으로 진행되며, 완료되면 리포트가 업데이트됩니다.`\n          : `${topicLabel} 초기 브리핑이 제출되었습니다.\\n수집된 자료가 없어 현황 리포트를 작성했습니다. '자료 수집하고 리포트 만들어줘'로 새 데이터를 먼저 수집해보세요.`;\n\n        if (fastResult.reportId && fastResult.itemsCount > 0 && hasSystemLLMKey()) {\n          const profileIdForUpgrade = profile.id;\n          const reportIdForUpgrade = fastResult.reportId;\n          (async () => {\n            try {\n              const analyzeCount = await analyzeNewItemsBySourceIds(reportSourceIds, 15, 5);\n              console.log(`[ReportOnly:Background] Analyzed ${analyzeCount} items. Upgrading...`);\n              await upgradeToFullReport(reportIdForUpgrade, profileIdForUpgrade, userId);\n            } catch (e) {\n              console.error(\"[ReportOnly:Background] Upgrade failed:\", e);\n            }\n          })();\n        }\n        break;\n      }\n      default:\n        return { ok: false, assistantMessage: `Unknown job: ${job}. Choose from: collect, analyze, draft, report.`, executed: cmd, result: null };\n    }\n\n    return { ok: true, assistantMessage: message, executed: cmd, result };\n  } catch (error: any) {\n    return { ok: false, assistantMessage: `Job execution failed: ${error?.message || String(error)}`, executed: cmd, result: null };\n  }\n}\n\nexport interface PipelineStepResult {\n  step: \"collect\" | \"analyze\" | \"report\" | \"schedule\" | \"start\" | \"timeout\";\n  ok: boolean;\n  message: string;\n  data?: any;\n}\n\nconst PIPELINE_HARD_TIMEOUT_MS = 25_000;\n\nclass PipelineTimeoutError extends Error {\n  constructor() { super(\"Pipeline timeout\"); this.name = \"PipelineTimeoutError\"; }\n}\n\nfunction withTimeout<T>(promise: Promise<T>, ms: number, label: string): Promise<T> {\n  return new Promise((resolve, reject) => {\n    const timer = setTimeout(() => reject(new PipelineTimeoutError()), ms);\n    promise.then(\n      (v) => { clearTimeout(timer); resolve(v); },\n      (e) => { clearTimeout(timer); reject(e); },\n    );\n  });\n}\n\nasync function execPipelineRunInner(\n  userId: string,\n  cmd: ChatCommand,\n  onStepComplete?: (step: PipelineStepResult) => Promise<void>\n): Promise<ExecutionResult> {\n  const args = (cmd.args || {}) as PipelineRunArgs;\n  const lang = (args.lang) || \"en\";\n  const ko = lang === \"ko\";\n\n  const bot = await resolveBot(userId, cmd.botKey);\n  if (!bot) {\n    return {\n      ok: false,\n      assistantMessage: cmd.botKey\n        ? ko\n          ? `'${cmd.botKey}' 봇을 찾을 수 없습니다.\\n\\n봇 목록을 확인하시거나, 템플릿 갤러리에서 새 봇을 만들어보세요.`\n          : `Bot '${cmd.botKey}' not found.\\n\\nCheck your bot list or create a new bot from the Template Gallery.`\n        : ko\n          ? \"활성 봇이 없습니다. 먼저 봇을 선택하거나 템플릿 갤러리에서 새 봇을 만들어주세요.\"\n          : \"No active bot. Please select a bot or create one from the Template Gallery.\",\n      executed: cmd,\n      result: null,\n    };\n  }\n\n  const botSources = await storage.getBotSources(bot.id);\n  if (botSources.length === 0) {\n    return {\n      ok: false,\n      assistantMessage: ko\n        ? `'${bot.name}' 봇에 연결된 소스가 없습니다.\\n\\n다음 중 하나를 시도해보세요:\\n• \"add source https://...\" 명령으로 소스 추가\\n• Sources 페이지에서 소스 관리\\n• 봇 설정에서 추천 소스 활성화`\n        : `Bot '${bot.name}' has no sources.\\n\\nTry one of these:\\n• Add a source with \"add source https://...\"\\n• Manage sources on the Sources page\\n• Enable recommended sources in bot settings`,\n      executed: cmd,\n      result: null,\n    };\n  }\n\n  const botLLM = await storage.resolveLLMForBot(bot.id);\n  if (!hasSystemLLMKey() && !botLLM) {\n    return {\n      ok: false,\n      assistantMessage: ko\n        ? \"AI Provider가 설정되지 않았습니다.\\n\\nSettings 페이지에서 AI Provider를 추가해주세요. (API 키가 필요합니다)\"\n        : \"No AI Provider configured.\\n\\nPlease add an AI Provider on the Settings page. (API key required)\",\n      executed: cmd,\n      result: null,\n    };\n  }\n\n  const steps: PipelineStepResult[] = [];\n  const botSourceIds = botSources.map(s => s.id);\n\n  if (onStepComplete) {\n    await onStepComplete({\n      step: \"start\",\n      ok: true,\n      message: ko\n        ? `'${bot.name}' 파이프라인을 시작합니다... (${botSources.length}개 소스)`\n        : `Starting '${bot.name}' pipeline... (${botSources.length} source(s))`,\n    });\n  }\n\n  if (args.scheduleTimeLocal) {\n    try {\n      const scheduleRule = args.scheduleRule || \"DAILY\";\n      await storage.updateBotSettings(bot.id, {\n        scheduleTimeLocal: args.scheduleTimeLocal,\n        scheduleRule,\n      });\n\n      const topic = bot.key;\n      let profile = await storage.getProfileByUserAndTopic(userId, topic);\n      if (profile) {\n        const [hour, minute] = args.scheduleTimeLocal.split(\":\");\n        const cronRule = scheduleRule === \"WEEKDAYS\" ? \"1-5\" : scheduleRule === \"WEEKENDS\" ? \"0,6\" : \"*\";\n        const newCron = `${minute || \"0\"} ${hour || \"7\"} * * ${cronRule}`;\n        await storage.updateProfile(profile.id, userId, { scheduleCron: newCron });\n      }\n\n      const scheduleStep: PipelineStepResult = {\n        step: \"schedule\",\n        ok: true,\n        message: ko\n          ? `스케줄 설정 완료 — 매일 ${args.scheduleTimeLocal}에 자동으로 실행됩니다.`\n          : `Schedule set — will run daily at ${args.scheduleTimeLocal}.`,\n      };\n      steps.push(scheduleStep);\n      if (onStepComplete) await onStepComplete(scheduleStep);\n    } catch (error: any) {\n      const scheduleStep: PipelineStepResult = {\n        step: \"schedule\",\n        ok: false,\n        message: ko\n          ? \"스케줄 저장에 실패했습니다. 봇 설정 페이지에서 직접 설정해주세요.\"\n          : \"Failed to save schedule. Please set it manually on the bot settings page.\",\n      };\n      steps.push(scheduleStep);\n      if (onStepComplete) await onStepComplete(scheduleStep);\n    }\n  }\n\n  let collectResult: { totalCollected: number; sourcesProcessed: number };\n  try {\n    collectResult = await collectFromSourceIds(botSourceIds);\n    const collectStep: PipelineStepResult = {\n      step: \"collect\",\n      ok: true,\n      message: ko\n        ? `자료 수집 완료 — ${collectResult.totalCollected}건의 새 자료를 ${collectResult.sourcesProcessed}개 소스에서 가져왔습니다.`\n        : `Collection complete: ${collectResult.totalCollected} new item(s) from ${collectResult.sourcesProcessed} source(s).`,\n      data: collectResult,\n    };\n    steps.push(collectStep);\n    if (onStepComplete) await onStepComplete(collectStep);\n  } catch (error: any) {\n    collectResult = { totalCollected: 0, sourcesProcessed: 0 };\n    const collectStep: PipelineStepResult = {\n      step: \"collect\",\n      ok: false,\n      message: ko\n        ? \"자료 수집 중 문제가 발생했습니다.\\n\\nSources 페이지에서 소스 URL이 올바른지 확인해주세요.\"\n        : \"Data collection failed.\\n\\nPlease check your source URLs on the Sources page.\",\n    };\n    steps.push(collectStep);\n    if (onStepComplete) await onStepComplete(collectStep);\n  }\n\n  const topic = bot.key;\n  let profile = await storage.getProfileByUserAndTopic(userId, topic);\n  if (!profile) {\n    const fullBot = await storage.getBot(bot.id, userId);\n    const allPresets = await storage.listPresets();\n    const reportPresets = allPresets.filter(p => p.outputType === \"report\");\n    const matchingPreset = reportPresets.find(p => {\n      const variants = (p.variantsJson as string[]) || [];\n      return variants.includes(topic) || p.key === topic;\n    }) || reportPresets[0];\n\n    if (!matchingPreset) {\n      return {\n        ok: false,\n        assistantMessage: ko\n          ? \"리포트 템플릿을 찾을 수 없습니다.\\n\\n템플릿 갤러리에서 봇을 다시 만들어주세요.\"\n          : \"No report template found.\\n\\nPlease create a bot from the Template Gallery.\",\n        executed: cmd,\n        result: { steps },\n      };\n    }\n\n    const settings = fullBot?.settings;\n    const scheduleCron = settings\n      ? `${settings.scheduleTimeLocal?.split(\":\")[1] || \"0\"} ${settings.scheduleTimeLocal?.split(\":\")[0] || \"7\"} * * ${settings.scheduleRule === \"WEEKDAYS\" ? \"1-5\" : settings.scheduleRule === \"WEEKENDS\" ? \"0,6\" : \"*\"}`\n      : \"0 7 * * *\";\n\n    const defaultSections = { tldr: true, drivers: true, risk: true, checklist: true, sources: true };\n    const defaultFilters = { minImportanceScore: 0 };\n    profile = await storage.createProfile({\n      userId,\n      presetId: matchingPreset.id,\n      name: bot.name,\n      topic,\n      timezone: settings?.timezone || \"Asia/Seoul\",\n      scheduleCron,\n      configJson: {\n        sections: settings?.sectionsJson || defaultSections,\n        filters: settings?.filtersJson || defaultFilters,\n        verbosity: settings?.verbosity || \"normal\",\n        markdownLevel: settings?.markdownLevel || \"minimal\",\n        scheduleRule: settings?.scheduleRule || \"DAILY\",\n        scheduleTimeLocal: settings?.scheduleTimeLocal || \"07:00\",\n      },\n      isActive: bot.isEnabled,\n    });\n\n    if (botSources.length > 0) {\n      await storage.setProfileSources(\n        profile.id,\n        userId,\n        botSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }))\n      );\n    }\n  }\n\n  let fastReportId: number | null = null;\n  try {\n    const fastResult = await generateFastReport({\n      profileId: profile.id,\n      userId,\n      presetId: profile.presetId,\n      topic,\n      profileName: profile.name,\n      sourceIds: botSourceIds,\n      collectResult,\n      sourceNames: botSources.map(s => s.name),\n      timezone: profile.timezone || \"Asia/Seoul\",\n    });\n    fastReportId = fastResult.reportId;\n\n    const reportStep: PipelineStepResult = {\n      step: \"report\",\n      ok: true,\n      message: ko\n        ? `초기 브리핑 제출 완료 — ${fastResult.itemsCount}건의 자료를 요약했습니다. Reports 페이지에서 확인하세요.`\n        : `Quick briefing delivered — summarized ${fastResult.itemsCount} item(s). Check the Reports page.`,\n      data: fastResult,\n    };\n    steps.push(reportStep);\n    if (onStepComplete) await onStepComplete(reportStep);\n  } catch (error: any) {\n    console.error(\"[Pipeline] Fast report generation failed:\", error);\n    const reportStep: PipelineStepResult = {\n      step: \"report\",\n      ok: false,\n      message: ko ? \"리포트 생성 중 문제가 발생했습니다.\" : \"Failed to generate report.\",\n    };\n    steps.push(reportStep);\n    if (onStepComplete) await onStepComplete(reportStep);\n  }\n\n  const profileIdForUpgrade = profile.id;\n  const reportIdForUpgrade = fastReportId;\n  if (reportIdForUpgrade) {\n    (async () => {\n      try {\n        console.log(`[Pipeline:Background] Starting analyze + full report upgrade for report ${reportIdForUpgrade}...`);\n        const analyzeCount = await analyzeNewItemsBySourceIds(botSourceIds, 15, 5);\n        console.log(`[Pipeline:Background] Analyzed ${analyzeCount} items. Upgrading report...`);\n        const upgraded = await upgradeToFullReport(reportIdForUpgrade, profileIdForUpgrade, userId);\n        if (upgraded) {\n          console.log(`[Pipeline:Background] Report ${reportIdForUpgrade} upgraded to full (${upgraded.itemsCount} items)`);\n        } else {\n          console.log(`[Pipeline:Background] Report ${reportIdForUpgrade} kept as status report (no analyzed items available)`);\n        }\n      } catch (error) {\n        console.error(\"[Pipeline:Background] Background upgrade failed:\", error);\n      }\n    })();\n  }\n\n  const summaryLines = steps\n    .filter(s => s.ok)\n    .map(s => s.message);\n  const hasSchedule = steps.some(s => s.step === \"schedule\" && s.ok);\n  const scheduleNote = hasSchedule && args.scheduleTimeLocal\n    ? ko\n      ? `\\n\\n앞으로 매일 ${args.scheduleTimeLocal}에 자동 실행됩니다.`\n      : `\\n\\nScheduled to run daily at ${args.scheduleTimeLocal}.`\n    : \"\";\n  const hasReport = steps.some(s => s.step === \"report\" && s.ok);\n  const checkReportsNote = hasReport\n    ? ko\n      ? \"\\n\\nReports 페이지에서 리포트를 확인하세요.\"\n      : \"\\n\\nYour report is ready — check the Reports page.\"\n    : \"\";\n\n  const briefingNote = hasReport\n    ? ko\n      ? \"\\n\\n초기 브리핑은 이미 제공되었습니다.\\n심화 분석은 백그라운드에서 자동으로 진행되며, 완료되면 리포트가 업데이트됩니다.\"\n      : \"\\n\\nYour quick briefing is ready.\\nDeep analysis runs in the background — the report will update automatically when done.\"\n    : \"\";\n\n  return {\n    ok: true,\n    assistantMessage: ko\n      ? `${hasReport ? \"초기 브리핑이 제출되었습니다.\" : \"완료!\"}\\n\\n${summaryLines.join(\"\\n\")}${scheduleNote}${checkReportsNote}${briefingNote}`\n      : `${hasReport ? \"Quick briefing delivered.\" : \"Done!\"}\\n\\n${summaryLines.join(\"\\n\")}${scheduleNote}${checkReportsNote}${briefingNote}`,\n    executed: cmd,\n    result: { steps },\n  };\n}\n\nasync function execPipelineRun(\n  userId: string,\n  cmd: ChatCommand,\n  onStepComplete?: (step: PipelineStepResult) => Promise<void>\n): Promise<ExecutionResult> {\n  const args = (cmd.args || {}) as PipelineRunArgs;\n  const lang = (args.lang) || \"en\";\n  const ko = lang === \"ko\";\n\n  const bot = await resolveBot(userId, cmd.botKey);\n  const runId = await startRun({\n    userId,\n    botId: bot?.id ?? null,\n    botKey: cmd.botKey || bot?.key || \"unknown\",\n    jobType: \"pipeline\",\n    trigger: \"console\",\n    meta: { scheduleTimeLocal: args.scheduleTimeLocal, lang },\n  });\n\n  try {\n    const result = await withTimeout(\n      execPipelineRunInner(userId, cmd, onStepComplete),\n      PIPELINE_HARD_TIMEOUT_MS,\n      \"pipeline_run\",\n    );\n\n    if (result.ok) {\n      const reportStep = result.result?.steps?.find((s: any) => s.step === \"report\" && s.ok);\n      await endRunOk(runId, {\n        outputId: reportStep?.data?.reportId,\n        reportStage: \"fast\",\n        itemsCollected: reportStep?.data?.itemsCount,\n      });\n    } else {\n      await endRunError(runId, {\n        errorCode: \"PIPELINE_FAILED\",\n        errorMessage: result.assistantMessage?.slice(0, 200) || \"Pipeline failed\",\n      });\n    }\n\n    return result;\n  } catch (error: any) {\n    if (error instanceof PipelineTimeoutError) {\n      await endRunTimeout(runId, \"Pipeline hard timeout (25s)\");\n      if (onStepComplete) {\n        await onStepComplete({\n          step: \"timeout\",\n          ok: true,\n          message: ko\n            ? \"시간이 초과되어 빠른 브리핑만 제공했습니다.\\n심화 분석은 백그라운드에서 계속 진행됩니다.\\n\\nReports 페이지에서 확인하세요.\"\n            : \"Pipeline timed out — quick briefing has been delivered.\\nDeep analysis continues in the background.\\n\\nCheck the Reports page for updates.\",\n        });\n      }\n      return {\n        ok: true,\n        assistantMessage: ko\n          ? \"시간이 초과되어 빠른 브리핑만 제공했습니다.\\n심화 분석은 백그라운드에서 계속 진행됩니다.\\n\\nReports 페이지에서 확인하세요.\"\n          : \"Pipeline timed out — quick briefing has been delivered.\\nDeep analysis continues in the background.\\n\\nCheck the Reports page for updates.\",\n        executed: cmd,\n        result: { timedOut: true },\n      };\n    }\n    await endRunError(runId, {\n      errorCode: \"PIPELINE_ERROR\",\n      errorMessage: String(error.message || error).slice(0, 200),\n      errorDetailJson: { stack: String(error.stack || \"\").slice(0, 500) },\n    });\n    throw error;\n  }\n}\n\nasync function execPauseBot(userId: string, cmd: ChatCommand): Promise<ExecutionResult> {\n  const bot = await resolveBot(userId, cmd.botKey);\n  if (!bot) {\n    return { ok: false, assistantMessage: cmd.botKey ? `Bot '${cmd.botKey}' not found.` : \"No active bot.\", executed: cmd, result: null };\n  }\n\n  if (!bot.isEnabled) {\n    return { ok: true, assistantMessage: `'${bot.name}' is already paused.`, executed: cmd, result: { botId: bot.id } };\n  }\n\n  await storage.updateBot(bot.id, userId, { isEnabled: false });\n  return {\n    ok: true,\n    assistantMessage: `'${bot.name}' has been paused. Scheduled jobs will be stopped.`,\n    executed: cmd,\n    result: { botId: bot.id },\n  };\n}\n\nasync function execResumeBot(userId: string, cmd: ChatCommand): Promise<ExecutionResult> {\n  const bot = await resolveBot(userId, cmd.botKey);\n  if (!bot) {\n    return { ok: false, assistantMessage: cmd.botKey ? `Bot '${cmd.botKey}' not found.` : \"No active bot.\", executed: cmd, result: null };\n  }\n\n  if (bot.isEnabled) {\n    return { ok: true, assistantMessage: `'${bot.name}' is already active.`, executed: cmd, result: { botId: bot.id } };\n  }\n\n  await storage.updateBot(bot.id, userId, { isEnabled: true });\n  return {\n    ok: true,\n    assistantMessage: `'${bot.name}' has been resumed. Scheduled jobs will restart.`,\n    executed: cmd,\n    result: { botId: bot.id },\n  };\n}\n\nasync function execAddSource(userId: string, cmd: ChatCommand): Promise<ExecutionResult> {\n  const url = cmd.args?.url;\n  if (!url || typeof url !== \"string\") {\n    return { ok: false, assistantMessage: \"Please provide a URL for the source to add.\", executed: cmd, result: null };\n  }\n\n  if (!url.startsWith(\"http://\") && !url.startsWith(\"https://\")) {\n    return { ok: false, assistantMessage: \"Invalid URL format. Must start with http:// or https://.\", executed: cmd, result: null };\n  }\n\n  const bot = await resolveBot(userId, cmd.botKey);\n  if (!bot) {\n    return { ok: false, assistantMessage: cmd.botKey ? `Bot '${cmd.botKey}' not found.` : \"No active bot. Please switch to a bot first.\", executed: cmd, result: null };\n  }\n\n  let source = await storage.findSourceByUrl(url);\n  if (!source) {\n    const name = cmd.args?.name || new URL(url).hostname;\n    source = await storage.createSource({\n      name,\n      url,\n      type: \"rss\",\n      topic: bot.key,\n      userId,\n    });\n  }\n\n  const existingSources = await storage.getBotSources(bot.id);\n  const alreadyLinked = existingSources.some(s => s.id === source!.id);\n  if (alreadyLinked) {\n    return { ok: true, assistantMessage: `'${source.name}' is already linked to '${bot.name}'.`, executed: cmd, result: { sourceId: source.id } };\n  }\n\n  const sourceData = [\n    ...existingSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled })),\n    { sourceId: source.id, weight: 3, isEnabled: true },\n  ];\n  await storage.setBotSources(bot.id, userId, sourceData);\n\n  return {\n    ok: true,\n    assistantMessage: `Source '${source.name}' has been added to '${bot.name}'. It will be included in the next collection.`,\n    executed: cmd,\n    result: { sourceId: source.id, sourceName: source.name },\n  };\n}\n\nasync function execRemoveSource(userId: string, cmd: ChatCommand): Promise<ExecutionResult> {\n  const sourceName = cmd.args?.sourceName;\n  if (!sourceName || typeof sourceName !== \"string\") {\n    return { ok: false, assistantMessage: \"Please provide the name or URL of the source to remove.\", executed: cmd, result: null };\n  }\n\n  const bot = await resolveBot(userId, cmd.botKey);\n  if (!bot) {\n    return { ok: false, assistantMessage: cmd.botKey ? `Bot '${cmd.botKey}' not found.` : \"No active bot.\", executed: cmd, result: null };\n  }\n\n  const existingSources = await storage.getBotSources(bot.id);\n  const lowerName = sourceName.toLowerCase();\n  const target = existingSources.find(\n    s => s.name.toLowerCase().includes(lowerName) || s.url.toLowerCase().includes(lowerName)\n  );\n\n  if (!target) {\n    return { ok: false, assistantMessage: `No source matching '${sourceName}' found in '${bot.name}'.`, executed: cmd, result: null };\n  }\n\n  const remaining = existingSources\n    .filter(s => s.id !== target.id)\n    .map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }));\n  await storage.setBotSources(bot.id, userId, remaining);\n\n  return {\n    ok: true,\n    assistantMessage: `Source '${target.name}' has been removed from '${bot.name}'.`,\n    executed: cmd,\n    result: { sourceId: target.id, sourceName: target.name },\n  };\n}\n\nexport async function routeCommand(userId: string, cmd: ChatCommand, threadId?: number): Promise<ExecutionResult> {\n  switch (cmd.type) {\n    case \"list_bots\":\n      return execListBots(userId, cmd);\n    case \"switch_bot\":\n      return execSwitchBot(userId, cmd, threadId);\n    case \"bot_status\":\n      return execBotStatus(userId, cmd);\n    case \"run_now\":\n      return execRunNow(userId, cmd);\n    case \"pause_bot\":\n      return execPauseBot(userId, cmd);\n    case \"resume_bot\":\n      return execResumeBot(userId, cmd);\n    case \"add_source\":\n      return execAddSource(userId, cmd);\n    case \"remove_source\":\n      return execRemoveSource(userId, cmd);\n    case \"pipeline_run\":\n      return execPipelineRun(userId, cmd);\n    case \"chat\":\n      return {\n        ok: true,\n        assistantMessage: cmd.args?.reply || \"How can I help? Try: list bots / bot status / run collect / run analyze / run report\\n\\n사용 가능한 명령어: 봇 목록 보여줘 / 봇 상태 보여줘 / 수집 실행 / 분석 실행 / 리포트 작성\",\n        executed: cmd,\n        result: null,\n      };\n    default:\n      return {\n        ok: false,\n        assistantMessage: \"Unknown command. Try: list bots / bot status / run collect\\n\\n사용 가능한 명령어: 봇 목록 보여줘 / 봇 상태 보여줘 / 수집 실행\",\n        executed: cmd,\n        result: null,\n      };\n  }\n}\n\nexport { routeCommand as executeCommand, execPipelineRun };\n","path":null,"size_bytes":30878,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/lib/theme-provider\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { LanguageProvider } from \"@/lib/language-provider\";\nimport { LanguageSwitcher } from \"@/components/language-switcher\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Loader2 } from \"lucide-react\";\nimport { ShareButton } from \"@/components/share-button\";\nimport { PermissionRequestProvider } from \"@/lib/permission-request-context\";\n\nimport Dashboard from \"@/pages/dashboard\";\nimport Items from \"@/pages/items\";\nimport ItemDetail from \"@/pages/item-detail\";\nimport Drafts from \"@/pages/drafts\";\nimport Observe from \"@/pages/observe\";\nimport Reports from \"@/pages/reports\";\nimport Sources from \"@/pages/sources\";\nimport Settings from \"@/pages/settings\";\nimport Chat from \"@/pages/chat\";\nimport Profiles from \"@/pages/profiles\";\nimport ProfileDetail from \"@/pages/profile-detail\";\nimport BotDetail from \"@/pages/bot-detail\";\nimport Landing from \"@/pages/landing\";\nimport Guide from \"@/pages/guide\";\nimport Permissions from \"@/pages/permissions\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/bots\" component={Profiles} />\n      <Route path=\"/profiles\" component={Profiles} />\n      <Route path=\"/profiles/:id\" component={ProfileDetail} />\n      <Route path=\"/bots/:id\" component={BotDetail} />\n      <Route path=\"/items\" component={Items} />\n      <Route path=\"/items/:id\" component={ItemDetail} />\n      <Route path=\"/drafts\" component={Drafts} />\n      <Route path=\"/observe\" component={Observe} />\n      <Route path=\"/reports\" component={Reports} />\n      <Route path=\"/sources\" component={Sources} />\n      <Route path=\"/settings\" component={Settings} />\n      <Route path=\"/permissions\" component={Permissions} />\n      <Route path=\"/chat\" component={Chat} />\n      <Route path=\"/guide\" component={Guide} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AuthenticatedApp() {\n  const { user } = useAuth();\n  const { t } = useLanguage();\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  const userInitials = user?.firstName && user?.lastName\n    ? `${user.firstName[0]}${user.lastName[0]}`\n    : user?.email?.[0]?.toUpperCase() || \"U\";\n\n  return (\n    <PermissionRequestProvider>\n      <SidebarProvider style={style as React.CSSProperties}>\n        <div className=\"flex h-screen w-full\">\n          <AppSidebar />\n          <div className=\"flex flex-col flex-1 overflow-hidden\">\n            <header className=\"flex items-center justify-between p-3 border-b border-border bg-background shrink-0\">\n              <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n              <div className=\"flex items-center gap-3\">\n                <ShareButton />\n                <LanguageSwitcher />\n                <ThemeToggle />\n                <div className=\"flex items-center gap-2\">\n                  <Avatar className=\"h-8 w-8\">\n                    <AvatarImage src={user?.profileImageUrl || undefined} />\n                    <AvatarFallback>{userInitials}</AvatarFallback>\n                  </Avatar>\n                  <Button variant=\"ghost\" size=\"sm\" asChild data-testid=\"button-logout\">\n                    <a href=\"/api/logout\">{t(\"header.logout\")}</a>\n                  </Button>\n                </div>\n              </div>\n            </header>\n            <main className=\"flex-1 overflow-auto bg-muted/30\">\n              <Router />\n            </main>\n          </div>\n        </div>\n      </SidebarProvider>\n    </PermissionRequestProvider>\n  );\n}\n\nfunction AppContent() {\n  const { isLoading, isAuthenticated } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!isAuthenticated) {\n    return <Landing />;\n  }\n\n  return <AuthenticatedApp />;\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"light\">\n        <LanguageProvider defaultLanguage=\"en\">\n          <TooltipProvider>\n            <AppContent />\n            <Toaster />\n          </TooltipProvider>\n        </LanguageProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":4963,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, serial, integer, timestamp, boolean, jsonb, primaryKey, uniqueIndex, index } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Re-export auth schema (users and sessions tables)\nexport * from \"./models/auth\";\nimport { users } from \"./models/auth\";\n\n// ============================================\n// PRESETS - Bot type templates\n// ============================================\nexport const presets = pgTable(\"presets\", {\n  id: serial(\"id\").primaryKey(),\n  key: text(\"key\").notNull().unique(),\n  name: text(\"name\").notNull(),\n  outputType: text(\"output_type\").notNull(), // \"report\" | \"draft\" | \"alert\"\n  description: text(\"description\"),\n  variantsJson: jsonb(\"variants_json\").notNull().default([]),\n  defaultConfigJson: jsonb(\"default_config_json\").notNull().default({}),\n  icon: text(\"icon\"),\n  category: text(\"category\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertPresetSchema = createInsertSchema(presets).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Preset = typeof presets.$inferSelect;\nexport type InsertPreset = z.infer<typeof insertPresetSchema>;\n\nexport interface PresetDefaultConfig {\n  timezone?: string;\n  scheduleRule?: \"DAILY\" | \"WEEKDAYS\" | \"WEEKENDS\";\n  scheduleTimeLocal?: string;\n  markdownLevel?: \"minimal\" | \"normal\";\n  verbosity?: \"short\" | \"normal\" | \"detailed\";\n  sections?: {\n    tldr?: boolean;\n    drivers?: boolean;\n    risk?: boolean;\n    checklist?: boolean;\n    sources?: boolean;\n    [key: string]: boolean | undefined;\n  };\n  filters?: {\n    minImportanceScore?: number;\n  };\n  suggestedSources?: Array<{\n    name: string;\n    url: string;\n    type?: string;\n    topic: string;\n  }>;\n  requireHumanApproval?: boolean;\n  promotionLevel?: \"none\" | \"subtle\" | \"moderate\";\n  linkPolicy?: \"no-links\" | \"allowed\" | \"cautious\" | \"optional\";\n  sourceDisclaimer?: string;\n}\n\n// ============================================\n// PROFILES - User's bot settings (core table)\n// ============================================\nexport const profiles = pgTable(\"profiles\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  presetId: integer(\"preset_id\").notNull().references(() => presets.id),\n  name: text(\"name\").notNull(),\n  topic: text(\"topic\").notNull(), // \"investing\" | \"ai_art\" | \"tech\"\n  variantKey: text(\"variant_key\"),\n  timezone: text(\"timezone\").notNull().default(\"Asia/Seoul\"),\n  scheduleCron: text(\"schedule_cron\").notNull().default(\"0 7 * * *\"),\n  configJson: jsonb(\"config_json\").notNull().default({}),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  lastRunAt: timestamp(\"last_run_at\"), // Last report generation time\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertProfileSchema = createInsertSchema(profiles).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Profile = typeof profiles.$inferSelect;\nexport type InsertProfile = z.infer<typeof insertProfileSchema>;\n\n// ProfileConfig - configuration stored in profile.configJson\nexport interface ProfileConfig {\n  scheduleRule?: \"DAILY\" | \"WEEKDAYS\" | \"WEEKENDS\";\n  sections?: {\n    tldr?: boolean;\n    drivers?: boolean;\n    risk?: boolean;\n    checklist?: boolean;\n    sources?: boolean;\n  };\n  verbosity?: \"short\" | \"normal\" | \"detailed\";\n  markdownLevel?: \"minimal\" | \"normal\";\n  filters?: {\n    minImportanceScore?: number;\n    maxRiskLevelAllowed?: number;\n    allowPromotionLinks?: boolean;\n  };\n}\n\n// ============================================\n// SOURCES - Content input sources\n// ============================================\nexport const sources = pgTable(\"sources\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id), // null = system default source\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull().default(\"rss\"),\n  url: text(\"url\").notNull().unique(),\n  topic: text(\"topic\").notNull().default(\"ai_art\"),\n  trustLevel: text(\"trust_level\").notNull().default(\"medium\"),\n  region: text(\"region\").notNull().default(\"global\"),\n  rulesJson: jsonb(\"rules_json\").notNull().default({}),\n  enabled: boolean(\"enabled\").notNull().default(true),\n  isDefault: boolean(\"is_default\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertSourceSchema = createInsertSchema(sources).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Source = typeof sources.$inferSelect;\nexport type InsertSource = z.infer<typeof insertSourceSchema>;\n\n// ============================================\n// BOTS - User's bot instances (Step 8-1)\n// ============================================\nexport const bots = pgTable(\"bots\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  key: text(\"key\").notNull(), // e.g., \"ai_art\", \"investing\"\n  name: text(\"name\").notNull(),\n  isEnabled: boolean(\"is_enabled\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  uniqueIndex(\"bots_user_key_unique\").on(table.userId, table.key)\n]);\n\nexport const insertBotSchema = createInsertSchema(bots).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Bot = typeof bots.$inferSelect;\nexport type InsertBot = z.infer<typeof insertBotSchema>;\n\n// ============================================\n// LLM_PROVIDERS - User's LLM API connections (Phase 3)\n// ============================================\nexport const llmProviders = pgTable(\"llm_providers\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  name: text(\"name\").notNull(),\n  providerType: text(\"provider_type\").notNull(), // \"openai\" | \"anthropic\" | \"google\" | \"custom\"\n  apiKeyEncrypted: text(\"api_key_encrypted\").notNull(),\n  baseUrl: text(\"base_url\"),\n  defaultModel: text(\"default_model\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertLlmProviderSchema = createInsertSchema(llmProviders).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type LlmProvider = typeof llmProviders.$inferSelect;\nexport type InsertLlmProvider = z.infer<typeof insertLlmProviderSchema>;\n\n// ============================================\n// BOT_SETTINGS - Bot settings 1:1 (Step 8-1 + Phase 3 LLM)\n// ============================================\nexport const botSettings = pgTable(\"bot_settings\", {\n  id: serial(\"id\").primaryKey(),\n  botId: integer(\"bot_id\").notNull().references(() => bots.id, { onDelete: \"cascade\" }).unique(), // 1:1 enforced\n  timezone: text(\"timezone\").notNull().default(\"Asia/Seoul\"),\n  scheduleRule: text(\"schedule_rule\").notNull().default(\"DAILY\"), // DAILY, WEEKDAYS, WEEKENDS\n  scheduleTimeLocal: text(\"schedule_time_local\").notNull().default(\"07:00\"), // HH:MM format\n  format: text(\"format\").notNull().default(\"clean\"),\n  markdownLevel: text(\"markdown_level\").notNull().default(\"minimal\"),\n  verbosity: text(\"verbosity\").notNull().default(\"normal\"), // short, normal, detailed\n  sectionsJson: jsonb(\"sections_json\").notNull().default({\n    tldr: true,\n    drivers: true,\n    risk: true,\n    checklist: true,\n    sources: true\n  }),\n  filtersJson: jsonb(\"filters_json\").notNull().default({\n    minImportanceScore: 0,\n    maxRiskLevel: 100\n  }),\n  llmProviderId: integer(\"llm_provider_id\").references(() => llmProviders.id, { onDelete: \"set null\" }),\n  modelOverride: text(\"model_override\"),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertBotSettingsSchema = createInsertSchema(botSettings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type BotSettings = typeof botSettings.$inferSelect;\nexport type InsertBotSettings = z.infer<typeof insertBotSettingsSchema>;\n\n// BotSettingsConfig - typed structure for sectionsJson and filtersJson\nexport interface BotSectionsConfig {\n  tldr?: boolean;\n  drivers?: boolean;\n  risk?: boolean;\n  checklist?: boolean;\n  sources?: boolean;\n}\n\nexport interface BotFiltersConfig {\n  minImportanceScore?: number;\n  maxRiskLevel?: number;\n}\n\n// ============================================\n// SOURCE_BOT_LINKS - Source ↔ Bot connection (Step 8-1)\n// ============================================\nexport const sourceBotLinks = pgTable(\"source_bot_links\", {\n  sourceId: integer(\"source_id\").notNull().references(() => sources.id, { onDelete: \"cascade\" }),\n  botId: integer(\"bot_id\").notNull().references(() => bots.id, { onDelete: \"cascade\" }),\n  isEnabled: boolean(\"is_enabled\").notNull().default(true),\n  weight: integer(\"weight\").notNull().default(3), // 1-5\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  primaryKey({ columns: [table.sourceId, table.botId] })\n]);\n\nexport type SourceBotLink = typeof sourceBotLinks.$inferSelect;\n\n// ============================================\n// PROFILE_SOURCES - Profile ↔ Source connection (legacy, kept for compatibility)\n// ============================================\nexport const profileSources = pgTable(\"profile_sources\", {\n  profileId: integer(\"profile_id\").notNull().references(() => profiles.id, { onDelete: \"cascade\" }),\n  sourceId: integer(\"source_id\").notNull().references(() => sources.id, { onDelete: \"cascade\" }),\n  weight: integer(\"weight\").notNull().default(3), // 1-5, higher = more priority\n  isEnabled: boolean(\"is_enabled\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  primaryKey({ columns: [table.profileId, table.sourceId] })\n]);\n\nexport type ProfileSource = typeof profileSources.$inferSelect;\n\n// Note: ProfileConfig is defined above after Profile type\n\n// ============================================\n// ITEMS - Collected content\n// ============================================\nexport const items = pgTable(\"items\", {\n  id: serial(\"id\").primaryKey(),\n  sourceId: integer(\"source_id\").references(() => sources.id),\n  topic: text(\"topic\").notNull().default(\"ai_art\"), // Must match source.topic\n  externalId: text(\"external_id\"),\n  url: text(\"url\").notNull().unique(),\n  title: text(\"title\"),\n  author: text(\"author\"),\n  contentText: text(\"content_text\").notNull(),\n  tagsJson: jsonb(\"tags_json\").notNull().default([]),\n  status: text(\"status\").notNull().default(\"new\"), // new | analyzed | processed\n  publishedAt: timestamp(\"published_at\"),\n  collectedAt: timestamp(\"collected_at\").notNull().defaultNow(), // renamed from insertedAt\n  insertedAt: timestamp(\"inserted_at\").notNull().defaultNow(), // keeping for backward compat\n});\n\nexport const insertItemSchema = createInsertSchema(items).omit({\n  id: true,\n  collectedAt: true,\n  insertedAt: true,\n});\n\nexport type Item = typeof items.$inferSelect;\nexport type InsertItem = z.infer<typeof insertItemSchema>;\n\n// ============================================\n// ANALYSIS - LLM analysis results\n// ============================================\nexport const analysis = pgTable(\"analysis\", {\n  id: serial(\"id\").primaryKey(),\n  itemId: integer(\"item_id\").notNull().references(() => items.id).unique(),\n  topic: text(\"topic\").notNull().default(\"ai_art\"), // Must match item.topic\n  category: text(\"category\").notNull(),\n  relevanceScore: integer(\"relevance_score\").notNull(),\n  importanceScore: integer(\"importance_score\").notNull().default(50), // Market/business impact\n  riskScore: integer(\"risk_score\").notNull().default(0),\n  replyWorthinessScore: integer(\"reply_worthiness_score\").notNull(),\n  linkFitScore: integer(\"link_fit_score\").notNull(),\n  riskFlagsJson: jsonb(\"risk_flags_json\").notNull().default([]),\n  recommendedAction: text(\"recommended_action\").notNull(),\n  suggestedAngle: text(\"suggested_angle\").notNull().default(\"\"),\n  summaryShort: text(\"summary_short\").notNull(),\n  summaryLong: text(\"summary_long\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertAnalysisSchema = createInsertSchema(analysis).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Analysis = typeof analysis.$inferSelect;\nexport type InsertAnalysis = z.infer<typeof insertAnalysisSchema>;\n\nexport const drafts = pgTable(\"drafts\", {\n  id: serial(\"id\").primaryKey(),\n  itemId: integer(\"item_id\").notNull().references(() => items.id),\n  variant: text(\"variant\").notNull(),\n  draftText: text(\"draft_text\").notNull(),\n  includesLink: boolean(\"includes_link\").notNull().default(false),\n  linkType: text(\"link_type\").notNull().default(\"none\"),\n  tone: text(\"tone\").notNull().default(\"helpful\"),\n  adminDecision: text(\"admin_decision\").notNull().default(\"pending\"),\n  finalText: text(\"final_text\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertDraftSchema = createInsertSchema(drafts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Draft = typeof drafts.$inferSelect;\nexport type InsertDraft = z.infer<typeof insertDraftSchema>;\n\nexport const posts = pgTable(\"posts\", {\n  id: serial(\"id\").primaryKey(),\n  draftId: integer(\"draft_id\").notNull().references(() => drafts.id),\n  postedAt: timestamp(\"posted_at\").notNull().defaultNow(),\n  resultJson: jsonb(\"result_json\").notNull().default({}),\n});\n\nexport const insertPostSchema = createInsertSchema(posts).omit({\n  id: true,\n  postedAt: true,\n});\n\nexport type Post = typeof posts.$inferSelect;\nexport type InsertPost = z.infer<typeof insertPostSchema>;\n\n// ============================================\n// REPORTS - Generated reports (outputs)\n// ============================================\nexport const reports = pgTable(\"reports\", {\n  id: serial(\"id\").primaryKey(),\n  profileId: integer(\"profile_id\").references(() => profiles.id), // nullable for backward compat\n  topic: text(\"topic\").notNull().default(\"ai_art\"),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  itemsCount: integer(\"items_count\").notNull().default(0),\n  itemIdsJson: jsonb(\"item_ids_json\").notNull().default([]),\n  periodStart: timestamp(\"period_start\"),\n  periodEnd: timestamp(\"period_end\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertReportSchema = createInsertSchema(reports).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Report = typeof reports.$inferSelect;\nexport type InsertReport = z.infer<typeof insertReportSchema>;\n\n// ============================================\n// OUTPUTS - Universal output storage (reports, drafts, alerts)\n// ============================================\nexport const outputs = pgTable(\n  \"outputs\",\n  {\n    id: serial(\"id\").primaryKey(),\n\n    userId: varchar(\"user_id\").notNull().references(() => users.id),\n    profileId: integer(\"profile_id\").notNull().references(() => profiles.id),\n    presetId: integer(\"preset_id\").notNull().references(() => presets.id),\n\n    topic: text(\"topic\").notNull(), // must match profile.topic\n    outputType: text(\"output_type\").notNull(), // \"report\" | \"draft\" | \"alert\"\n\n    title: text(\"title\").notNull(),\n    contentText: text(\"content_text\").notNull(),\n    reportStage: text(\"report_stage\").notNull().default(\"full\"),\n\n    periodStart: timestamp(\"period_start\", { withTimezone: true }).notNull(),\n    periodEnd: timestamp(\"period_end\", { withTimezone: true }).notNull(),\n\n    createdAt: timestamp(\"created_at\", { withTimezone: true })\n      .notNull()\n      .defaultNow(),\n    updatedAt: timestamp(\"updated_at\", { withTimezone: true }),\n  },\n  (t) => ({\n    // Prevent duplicate reports for the same profile + same period\n    uqProfilePeriod: uniqueIndex(\"outputs_uq_profile_period\").on(\n      t.profileId,\n      t.periodStart,\n      t.periodEnd\n    ),\n\n    idxProfile: index(\"outputs_idx_profile\").on(t.profileId),\n    idxUser: index(\"outputs_idx_user\").on(t.userId),\n    idxTopic: index(\"outputs_idx_topic\").on(t.topic),\n  })\n);\n\nexport const insertOutputSchema = createInsertSchema(outputs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Output = typeof outputs.$inferSelect;\nexport type InsertOutput = z.infer<typeof insertOutputSchema>;\n\n// ============================================\n// OUTPUT_ITEMS - Output ↔ Item link (for precise tracking)\n// ============================================\nexport const outputItems = pgTable(\n  \"output_items\",\n  {\n    outputId: integer(\"output_id\").notNull().references(() => outputs.id, { onDelete: \"cascade\" }),\n    itemId: integer(\"item_id\").notNull().references(() => items.id, { onDelete: \"cascade\" }),\n    createdAt: timestamp(\"created_at\", { withTimezone: true })\n      .notNull()\n      .defaultNow(),\n  },\n  (t) => ({\n    pk: primaryKey({ columns: [t.outputId, t.itemId] }),\n    idxOutput: index(\"output_items_idx_output\").on(t.outputId),\n    idxItem: index(\"output_items_idx_item\").on(t.itemId),\n  })\n);\n\nexport type OutputItem = typeof outputItems.$inferSelect;\n\nexport const conversations = pgTable(\"conversations\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const messages = pgTable(\"messages\", {\n  id: serial(\"id\").primaryKey(),\n  conversationId: integer(\"conversation_id\").notNull().references(() => conversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const chatThreads = pgTable(\"chat_threads\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  title: text(\"title\"),\n  activeBotId: integer(\"active_bot_id\").references(() => bots.id, { onDelete: \"set null\" }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertChatThreadSchema = createInsertSchema(chatThreads).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type ChatThread = typeof chatThreads.$inferSelect;\nexport type InsertChatThread = z.infer<typeof insertChatThreadSchema>;\n\nexport const chatMessages = pgTable(\"chat_messages\", {\n  id: serial(\"id\").primaryKey(),\n  threadId: integer(\"thread_id\").references(() => chatThreads.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  role: text(\"role\").notNull(),\n  contentText: text(\"content_text\").notNull(),\n  kind: text(\"kind\").default(\"text\"),\n  commandJson: jsonb(\"command_json\"),\n  resultJson: jsonb(\"result_json\"),\n  status: text(\"status\").default(\"done\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertChatMessageSchema = createInsertSchema(chatMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type ChatMessage = typeof chatMessages.$inferSelect;\nexport type InsertChatMessage = z.infer<typeof insertChatMessageSchema>;\n\nexport const settings = pgTable(\"settings\", {\n  id: serial(\"id\").primaryKey(),\n  key: text(\"key\").notNull().unique(),\n  value: text(\"value\").notNull(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport type Setting = typeof settings.$inferSelect;\n\n// ============================================\n// JOB RUNS - Execution log for all jobs\n// ============================================\nexport const jobRuns = pgTable(\"job_runs\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  botId: integer(\"bot_id\").references(() => bots.id),\n  botKey: text(\"bot_key\").notNull(),\n  jobType: text(\"job_type\").notNull(),\n  trigger: text(\"trigger\").notNull(),\n  status: text(\"status\").notNull(),\n  startedAt: timestamp(\"started_at\").notNull().defaultNow(),\n  finishedAt: timestamp(\"finished_at\"),\n  durationMs: integer(\"duration_ms\"),\n  itemsCollected: integer(\"items_collected\"),\n  itemsAnalyzed: integer(\"items_analyzed\"),\n  outputId: integer(\"output_id\"),\n  reportStage: text(\"report_stage\"),\n  errorCode: text(\"error_code\"),\n  errorMessage: text(\"error_message\"),\n  errorDetailJson: jsonb(\"error_detail_json\"),\n  metaJson: jsonb(\"meta_json\"),\n}, (table) => [\n  index(\"idx_job_runs_user_bot\").on(table.userId, table.botId, table.startedAt),\n  index(\"idx_job_runs_status\").on(table.status, table.startedAt),\n]);\n\nexport const insertJobRunSchema = createInsertSchema(jobRuns).omit({\n  id: true,\n});\n\nexport type JobRun = typeof jobRuns.$inferSelect;\nexport type InsertJobRun = z.infer<typeof insertJobRunSchema>;\n\n// ============================================\n// PERMISSIONS - Policy engine permission store\n// ============================================\nexport const permissions = pgTable(\"permissions\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  scope: text(\"scope\").notNull(),\n  scopeId: integer(\"scope_id\"),\n  permissionKey: text(\"permission_key\").notNull(),\n  valueJson: jsonb(\"value_json\").notNull(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n}, (table) => [\n  uniqueIndex(\"permissions_scope_key_unique\").on(table.userId, table.scope, table.scopeId, table.permissionKey),\n  index(\"idx_permissions_user_scope\").on(table.userId, table.scope, table.scopeId),\n]);\n\nexport const insertPermissionSchema = createInsertSchema(permissions).omit({\n  id: true,\n});\n\nexport type Permission = typeof permissions.$inferSelect;\nexport type InsertPermission = z.infer<typeof insertPermissionSchema>;\n\n// ============================================\n// AUDIT LOG - Permission/action audit trail\n// ============================================\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  botId: integer(\"bot_id\").references(() => bots.id),\n  threadId: text(\"thread_id\"),\n  eventType: text(\"event_type\").notNull(),\n  permissionKey: text(\"permission_key\"),\n  payloadJson: jsonb(\"payload_json\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  index(\"idx_audit_logs_user\").on(table.userId, table.createdAt),\n  index(\"idx_audit_logs_event\").on(table.eventType, table.createdAt),\n]);\n\n// ============================================\n// REPORT METRICS - Memory layer for trend tracking\n// ============================================\nexport const reportMetrics = pgTable(\"report_metrics\", {\n  id: serial(\"id\").primaryKey(),\n  reportId: integer(\"report_id\").notNull(),\n  profileId: integer(\"profile_id\").notNull(),\n  itemCount: integer(\"item_count\").notNull().default(0),\n  keywordSummary: jsonb(\"keyword_summary\").notNull().default({}),\n  sourceDistribution: jsonb(\"source_distribution\").notNull().default({}),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  index(\"idx_report_metrics_profile\").on(table.profileId, table.createdAt),\n]);\n\nexport const insertReportMetricSchema = createInsertSchema(reportMetrics).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type ReportMetric = typeof reportMetrics.$inferSelect;\nexport type InsertReportMetric = z.infer<typeof insertReportMetricSchema>;\n\n// ============================================\n// RULE MEMORIES - Long-term memory for user preferences/rules\n// ============================================\nexport const ruleMemories = pgTable(\"rule_memories\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  scope: text(\"scope\").notNull(), // \"global\" | \"bot\"\n  scopeId: integer(\"scope_id\"), // null for global, botId for bot scope\n  key: text(\"key\").notNull(), // e.g., \"REPORT_FORMAT\", \"WRITING_TONE\", \"NO_EGRESS_PATHS\"\n  valueJson: jsonb(\"value_json\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n}, (table) => [\n  uniqueIndex(\"rule_memories_scope_key_unique\").on(table.userId, table.scope, table.scopeId, table.key),\n  index(\"idx_rule_memories_user_scope\").on(table.userId, table.scope, table.scopeId),\n]);\n\nexport const insertRuleMemorySchema = createInsertSchema(ruleMemories).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type RuleMemory = typeof ruleMemories.$inferSelect;\nexport type InsertRuleMemory = z.infer<typeof insertRuleMemorySchema>;\n\n// ============================================\n// TELEGRAM LINKS - Connect Maker accounts to Telegram\n// ============================================\nexport const telegramLinks = pgTable(\"telegram_links\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  telegramChatId: text(\"telegram_chat_id\").notNull(),\n  telegramUsername: text(\"telegram_username\"),\n  threadId: integer(\"thread_id\").references(() => chatThreads.id),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  uniqueIndex(\"telegram_links_chat_id_unique\").on(table.telegramChatId),\n  index(\"idx_telegram_links_user\").on(table.userId),\n]);\n\nexport const insertTelegramLinkSchema = createInsertSchema(telegramLinks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type TelegramLink = typeof telegramLinks.$inferSelect;\nexport type InsertTelegramLink = z.infer<typeof insertTelegramLinkSchema>;\n\n// ============================================\n// LINK CODES - One-time codes for account linking\n// ============================================\nexport const linkCodes = pgTable(\"link_codes\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  code: text(\"code\").notNull().unique(),\n  platform: text(\"platform\").notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  usedAt: timestamp(\"used_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  index(\"idx_link_codes_code\").on(table.code),\n  index(\"idx_link_codes_user\").on(table.userId),\n]);\n","path":null,"size_bytes":25754,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport { startScheduler } from \"./jobs/scheduler\";\nimport { driver } from \"./db\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\nprocess.on(\"uncaughtException\", (err) => {\n  console.error(\"[FATAL] Uncaught exception (server kept alive):\", err?.message || err);\n});\nprocess.on(\"unhandledRejection\", (reason) => {\n  console.error(\"[FATAL] Unhandled rejection (server kept alive):\", reason);\n});\n\n(async () => {\n  if (driver === \"sqlite\") {\n    const { initSqliteTables } = await import(\"./init-sqlite\");\n    initSqliteTables();\n  }\n\n  await registerRoutes(httpServer, app);\n\n  app.use((err: any, _req: Request, res: Response, next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    console.error(\"Internal Server Error:\", err);\n\n    if (res.headersSent) {\n      return next(err);\n    }\n\n    return res.status(status).json({ message });\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  const isDesktop = process.env.MAKER_DESKTOP === \"true\";\n  const host = isDesktop ? \"127.0.0.1\" : \"0.0.0.0\";\n\n  function onListening() {\n    log(`serving on port ${port}`);\n    startScheduler();\n    log(\"Scheduler auto-started\");\n  }\n\n  if (isDesktop) {\n    httpServer.listen({ port, host }, onListening);\n  } else {\n    try {\n      httpServer.listen({ port, host, reusePort: true }, onListening);\n    } catch {\n      httpServer.listen({ port, host }, onListening);\n    }\n  }\n})();\n","path":null,"size_bytes":3452,"size_tokens":null},"server/chat/executor.ts":{"content":"export { routeCommand, routeCommand as executeCommand, type ExecutionResult } from \"./commandRouter\";\n","path":null,"size_bytes":102,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/i18n/en.ts":{"content":"export const en: Record<string, string> = {\n  \"sidebar.dashboard\": \"Dashboard\",\n  \"sidebar.myBots\": \"My Bots\",\n  \"sidebar.sources\": \"Sources\",\n  \"sidebar.reports\": \"Reports\",\n  \"sidebar.drafts\": \"Drafts\",\n  \"sidebar.items\": \"Items\",\n  \"sidebar.observe\": \"Observe\",\n  \"sidebar.console\": \"Console\",\n  \"sidebar.guide\": \"Guide\",\n  \"sidebar.settings\": \"Settings\",\n  \"sidebar.permissions\": \"Permissions\",\n  \"sidebar.activeBots\": \"Active Bots\",\n  \"sidebar.navigation\": \"Navigation\",\n  \"sidebar.subtitle\": \"Workflow Designer\",\n  \"sidebar.footer\": \"maker.am Bot v1.0\",\n\n  \"header.logout\": \"Logout\",\n\n  \"landing.nav.signIn\": \"Sign In\",\n  \"landing.hero.title1\": \"Build Your Automation,\",\n  \"landing.hero.title2\": \"Your Way\",\n  \"landing.hero.subtitle\": \"Choose your sources, set your schedule, and design your outputs. Your workflow, your rules.\",\n  \"landing.hero.getStarted\": \"Get Started\",\n  \"landing.hero.badge1\": \"Templates as starting points\",\n  \"landing.hero.badge2\": \"Fully customizable\",\n  \"landing.hero.badge3\": \"AI analysis & reports\",\n  \"landing.hero.chooseSources\": \"Choose Sources\",\n  \"landing.hero.chooseSourcesDesc\": \"RSS, news, communities — connect the sources you want\",\n  \"landing.hero.scheduleFormat\": \"Schedule & Format\",\n  \"landing.hero.scheduleFormatDesc\": \"Freely adjust run frequency and output format\",\n  \"landing.hero.aiAnalysis\": \"AI Analysis & Summary\",\n  \"landing.hero.aiAnalysisDesc\": \"AI analyzes collected content and generates reports\",\n  \"landing.howItWorks.title\": \"How It Works\",\n  \"landing.howItWorks.subtitle\": \"You decide the sources, schedule, and outputs. You own the workflow.\",\n  \"landing.howItWorks.step1Title\": \"Start from a Template\",\n  \"landing.howItWorks.step1Desc\": \"Templates are starting points, not answers. Quickly start workflows for news monitoring, market analysis, community engagement, and more.\",\n  \"landing.howItWorks.step2Title\": \"Customize Freely\",\n  \"landing.howItWorks.step2Desc\": \"Change everything to fit your purpose — sources, schedules, report format, and AI model. We provide the tools, you make the choices.\",\n  \"landing.howItWorks.step3Title\": \"Automated Operations\",\n  \"landing.howItWorks.step3Desc\": \"Once configured, your bot automatically collects, analyzes, and generates reports. Control your bots anytime via the chat console.\",\n  \"landing.useCases.title\": \"What Can You Build?\",\n  \"landing.useCases.subtitle\": \"Here are some workflows people create with Maker. Every template is a starting point — customize it to fit your needs.\",\n  \"landing.faq.title\": \"Frequently Asked Questions\",\n  \"landing.faq.subtitle\": \"Common questions about Maker and how it works.\",\n  \"landing.pricing.title\": \"Choose how you want to run Maker\",\n  \"landing.pricing.subtitle\": \"Flexible plans to fit your needs.\",\n  \"landing.pricing.web.name\": \"Personal (Web)\",\n  \"landing.pricing.web.price\": \"Free (Beta)\",\n  \"landing.pricing.web.desc\": \"Start right in your browser\",\n  \"landing.pricing.web.f1\": \"Personal workflow design\",\n  \"landing.pricing.web.f2\": \"BYO LLM\",\n  \"landing.pricing.web.f3\": \"Quick briefings & reports\",\n  \"landing.pricing.web.f4\": \"Data stored in cloud\",\n  \"landing.pricing.web.button\": \"Start Online\",\n  \"landing.pricing.local.name\": \"Local Edition — Personal\",\n  \"landing.pricing.local.price\": \"Local Edition\",\n  \"landing.pricing.local.desc\": \"Runs on your computer\",\n  \"landing.pricing.local.f1\": \"All data stays local\",\n  \"landing.pricing.local.f2\": \"Personal automation engine\",\n  \"landing.pricing.local.f3\": \"Manage API keys directly\",\n  \"landing.pricing.local.button\": \"Download\",\n  \"landing.pricing.teams.name\": \"Local Edition — Teams\",\n  \"landing.pricing.teams.price\": \"Local Edition\",\n  \"landing.pricing.teams.desc\": \"Internal team automation\",\n  \"landing.pricing.teams.f1\": \"Internal docs & reports\",\n  \"landing.pricing.teams.f2\": \"Team workflows\",\n  \"landing.pricing.teams.f3\": \"No external transmission\",\n  \"landing.pricing.teams.button\": \"Contact Us\",\n  \"landing.pricing.enterprise.name\": \"Enterprise\",\n  \"landing.pricing.enterprise.price\": \"Enterprise\",\n  \"landing.pricing.enterprise.desc\": \"Custom automation platform\",\n  \"landing.pricing.enterprise.f1\": \"On-premise deployment\",\n  \"landing.pricing.enterprise.f2\": \"Security, integration & SLA\",\n  \"landing.pricing.enterprise.f3\": \"Dedicated support\",\n  \"landing.pricing.enterprise.button\": \"Contact Sales\",\n\n  \"landing.philosophy.line1\": \"We don't sell bots.\",\n  \"landing.philosophy.line2\": \"We sell control over automation.\",\n\n  \"landing.cta.title\": \"Ready to Design Your Workflow?\",\n  \"landing.cta.subtitle\": \"Sign up, add your AI provider, and create your first bot in minutes.\",\n  \"landing.cta.button\": \"Get Started Free\",\n  \"landing.footer\": \"Maker Bot Manager\",\n\n  \"landing.useCase.dailyMarketBrief\": \"Daily Market Brief\",\n  \"landing.useCase.dailyMarketBriefDesc\": \"Collect market news from Reuters, Yahoo Finance, Reddit, and more. Get a concise AI-summarized briefing every morning before the market opens.\",\n  \"landing.useCase.researchPaperTracker\": \"Research Paper Tracker\",\n  \"landing.useCase.researchPaperTrackerDesc\": \"Monitor ArXiv, Google Research, and academic blogs. Stay on top of the latest AI/ML papers without manual searching.\",\n  \"landing.useCase.competitorSignalMonitor\": \"Competitor Signal Monitor\",\n  \"landing.useCase.competitorSignalMonitorDesc\": \"Track TechCrunch, Product Hunt, and industry news. Get alerts when competitors launch new features or raise funding.\",\n  \"landing.useCase.communityResearch\": \"Community Research\",\n  \"landing.useCase.communityResearchDesc\": \"Follow Reddit, Hacker News, and niche communities. Understand emerging trends and community sentiment in your space.\",\n  \"landing.useCase.contentIdeas\": \"Content Ideas & Research\",\n  \"landing.useCase.contentIdeasDesc\": \"Automatically collect trending topics, blog ideas, and content inspiration from Medium, Reddit, and more. Perfect for bloggers, newsletter writers, and content planners.\",\n  \"landing.useCase.workProductivity\": \"Work & Productivity Research\",\n  \"landing.useCase.workProductivityDesc\": \"Automatically gather productivity tips, business ideas, and practical tools from Reddit, Indie Hackers, and Medium. A daily research memo for marketers, planners, and solopreneurs.\",\n  \"landing.useCase.onlineBusiness\": \"Online Business Research\",\n  \"landing.useCase.onlineBusinessDesc\": \"Collect customer complaints, market signals, and competitor data from e-commerce communities. Get strategy reports focused on why customers hesitate — not just what to sell.\",\n  \"landing.useCase.koreaMarketplace\": \"Korea Marketplace Research\",\n  \"landing.useCase.koreaMarketplaceDesc\": \"A research workflow for Coupang and SmartStore sellers. Monitor customer complaints, pricing pressure, and review signals across Korean marketplace ecosystems to support sourcing and strategy decisions.\",\n  \"landing.useCase.chatControl\": \"Chat-Based Control\",\n  \"landing.useCase.chatControlDesc\": \"Manage all your bots through a natural language chat console. Switch bots, run jobs, add sources — just type a command.\",\n  \"landing.useCase.byoLlm\": \"Bring Your Own LLM\",\n  \"landing.useCase.byoLlmDesc\": \"Use your own API key from OpenAI, Anthropic, Google, or any OpenAI-compatible provider. No vendor lock-in, full control over AI costs.\",\n\n  \"landing.faq.q1\": \"Do I need to provide my own AI API key?\",\n  \"landing.faq.a1\": \"Yes. Maker uses a BYO (Bring Your Own) LLM model. You add your own API key from providers like OpenAI, Anthropic, or Google in Settings. This gives you full control over your AI usage and costs.\",\n  \"landing.faq.q2\": \"What sources can I connect?\",\n  \"landing.faq.a2\": \"Any public RSS feed. This includes news sites (Reuters, CNBC), tech blogs (TechCrunch, The Verge), research repositories (ArXiv), community platforms (Reddit, Hacker News), and any other site with an RSS feed.\",\n  \"landing.faq.q3\": \"Are templates mandatory?\",\n  \"landing.faq.a3\": \"No. Templates are starting points to help you get up and running quickly. You can fully customize every aspect — sources, schedule, report sections, format, and AI model — after creation.\",\n  \"landing.faq.q4\": \"How often do bots run?\",\n  \"landing.faq.a4\": \"You control the schedule. Options include daily, weekdays only, or weekly. You also pick the time of day. You can also trigger a manual run anytime from the chat console.\",\n  \"landing.faq.q5\": \"What kind of outputs do bots produce?\",\n  \"landing.faq.a5\": \"Bots generate structured reports from your sources. Reports include summaries, key insights, and trend analysis. You can customize which sections appear, the verbosity level, and the markdown formatting.\",\n  \"landing.faq.q6\": \"Is my data private?\",\n  \"landing.faq.a6\": \"Yes. Each user has their own bots, sources, and reports. Data is strictly isolated per user. Your API keys are encrypted and never shared.\",\n\n  \"landing.demo.title\": \"Reviewer Demo Login\",\n  \"landing.demo.id\": \"ID\",\n  \"landing.demo.password\": \"Password\",\n  \"landing.demo.idPlaceholder\": \"Enter test ID\",\n  \"landing.demo.passwordPlaceholder\": \"Enter password\",\n  \"landing.demo.loginButton\": \"Demo Login\",\n  \"landing.demo.loggingIn\": \"Logging in...\",\n  \"landing.demo.error\": \"ID or password is incorrect.\",\n  \"landing.demo.failed\": \"Login failed. Please try again.\",\n\n  \"dashboard.title\": \"Workflow Designer\",\n  \"dashboard.subtitle\": \"A tool for designing your automation workflows. Choose your sources, set your schedule, and design your outputs — you decide everything.\",\n  \"dashboard.systemWarning.title\": \"System AI key is not configured\",\n  \"dashboard.systemWarning.desc\": \"Analysis, drafting, and report generation are paused. Content collection continues normally.\",\n  \"dashboard.systemWarning.link\": \"Settings > Providers\",\n  \"dashboard.systemWarning.linkSuffix\": \" — Add a BYO LLM provider to enable AI features for each bot.\",\n  \"dashboard.onboarding.title\": \"Getting Started\",\n  \"dashboard.onboarding.subtitle\": \"Follow these steps to set up your first automation workflow.\",\n  \"dashboard.onboarding.step1\": \"1. Add AI Provider\",\n  \"dashboard.onboarding.step1Done\": \"Done\",\n  \"dashboard.onboarding.step1Desc\": \"Add your own API key (OpenAI, Anthropic, Google, etc.) to enable AI analysis and report generation.\",\n  \"dashboard.onboarding.step1Button\": \"Go to Settings\",\n  \"dashboard.onboarding.step2\": \"2. Create a Bot\",\n  \"dashboard.onboarding.step2Desc\": \"Pick a template below and customize the sources, schedule, and output format to your needs.\",\n  \"dashboard.onboarding.step2Button\": \"Browse Templates\",\n  \"dashboard.onboarding.step3\": \"3. View Reports\",\n  \"dashboard.onboarding.step3Desc\": \"Your bot will automatically collect, analyze, and generate reports on schedule. Check results in the Reports page.\",\n  \"dashboard.onboarding.step3Button\": \"View Reports\",\n  \"dashboard.startWorkflow.title\": \"Start a Workflow\",\n  \"dashboard.startWorkflow.subtitle\": \"Templates are starting points, not answers. You can freely customize sources, schedules, and outputs.\",\n  \"dashboard.startWorkflow.viewAll\": \"View All Templates\",\n  \"dashboard.startWorkflow.startWith\": \"Start with this setup\",\n  \"dashboard.myBots.title\": \"My Workflow Bots\",\n  \"dashboard.myBots.subtitle\": \"Your active bots. Change settings or run them instantly.\",\n  \"dashboard.myBots.manageAll\": \"Manage All\",\n  \"dashboard.myBots.open\": \"Open\",\n  \"dashboard.myBots.active\": \"Active\",\n  \"dashboard.myBots.paused\": \"Paused\",\n  \"dashboard.system.title\": \"System Status\",\n  \"dashboard.system.collect\": \"Collect:\",\n  \"dashboard.system.analyze\": \"Analyze:\",\n  \"dashboard.system.draft\": \"Draft:\",\n  \"dashboard.system.reports\": \"Reports:\",\n  \"dashboard.system.paused\": \"Paused\",\n  \"dashboard.system.lastCollect\": \"Last Collect:\",\n  \"dashboard.system.lastAnalyze\": \"Last Analyze:\",\n  \"dashboard.system.never\": \"Never\",\n  \"dashboard.stats.totalItems\": \"Total Items\",\n  \"dashboard.stats.new\": \"New\",\n  \"dashboard.stats.analyzed\": \"Analyzed\",\n  \"dashboard.stats.drafted\": \"Drafted\",\n  \"dashboard.stats.approved\": \"Approved\",\n  \"dashboard.stats.posted\": \"Posted\",\n  \"dashboard.stats.skipped\": \"Skipped\",\n  \"dashboard.recentItems\": \"Recent Items\",\n  \"dashboard.viewAll\": \"View All\",\n\n  \"reports.title\": \"Reports\",\n  \"reports.subtitle\": \"Bot-generated reports from analyzed content\",\n  \"reports.allReports\": \"All Reports\",\n  \"reports.generate\": \"Generate\",\n  \"reports.recentReports\": \"Recent Reports\",\n  \"reports.selectReport\": \"Select a report\",\n  \"reports.selectReportHint\": \"Pick a report from the left to view its contents.\",\n  \"reports.noReports\": \"No reports yet.\",\n  \"reports.generateReport\": \"Generate Report\",\n  \"reports.selectBotHint\": \"Select a bot from the dropdown above to generate a report.\",\n  \"reports.createBotFirst\": \"Create a bot first from the Template Gallery.\",\n  \"reports.copyToClipboard\": \"Copy to clipboard\",\n  \"reports.downloadMarkdown\": \"Download as Markdown\",\n  \"reports.copied\": \"Copied to clipboard\",\n  \"reports.downloaded\": \"Report downloaded\",\n  \"reports.generated\": \"Report Generated\",\n  \"reports.generatedDesc\": \"Report created successfully ({{count}} items analyzed)\",\n  \"reports.generationComplete\": \"Report generation complete\",\n  \"reports.generationFailed\": \"Generation Failed\",\n  \"reports.generationFailedDesc\": \"Failed to generate report\",\n  \"reports.stage.fast\": \"Quick Briefing\",\n  \"reports.stage.status\": \"Status Report\",\n  \"reports.stage.full\": \"Extended Report\",\n  \"reports.stage.updated\": \"Updated\",\n  \"reports.created\": \"Created:\",\n  \"reports.updated\": \"Updated:\",\n  \"reports.period\": \"Period:\",\n\n  \"chat.title\": \"Control Console\",\n  \"chat.subtitle\": \"Tell your bot what to do in one sentence. It handles the rest.\",\n  \"chat.noActiveBot\": \"No active bot\",\n  \"chat.tryNext\": \"Try next\",\n  \"chat.category.firstRun\": \"Getting Started\",\n  \"chat.category.schedule\": \"Schedule\",\n  \"chat.botCategory.research\": \"User Research\",\n  \"chat.botCategory.outreach\": \"Outreach\",\n  \"chat.botCategory.contribution\": \"Community\",\n  \"chat.botCategory.analysis\": \"Analysis\",\n  \"chat.botCategory.monitor\": \"Monitoring\",\n  \"chat.botCategory.safetyPromo\": \"Safety\",\n  \"chat.suggestions\": \"Suggestions\",\n  \"chat.categories\": \"Categories\",\n  \"chat.commands\": \"Commands\",\n  \"chat.botHintsDesc\": \"Pre-research, data collection, and community contribution commands for Maker promotion\",\n  \"chat.state.noBot\": \"Start by selecting or creating a bot\",\n  \"chat.state.noSources\": \"Add sources to start collecting data\",\n  \"chat.state.noCollection\": \"Ready to collect and analyze data\",\n  \"chat.state.ready\": \"All set! Tell your bot what to do\",\n  \"chat.state.scheduleIssue\": \"Check your settings — something needs attention\",\n  \"chat.pipeline.start\": \"Starting\",\n  \"chat.pipeline.collect\": \"Data Collection\",\n  \"chat.pipeline.analyze\": \"Analysis\",\n  \"chat.pipeline.report\": \"Report\",\n  \"chat.pipeline.schedule\": \"Schedule\",\n  \"chat.pipeline.timeout\": \"Timed Out\",\n  \"chat.executionFailed\": \"Execution failed\",\n  \"chat.errorOccurred\": \"An error occurred\",\n  \"chat.onboarding.welcome\": \"Welcome to your Control Console\",\n  \"chat.onboarding.welcomeDesc\": \"This is where you talk to your bots. Type a command or pick a suggestion below.\",\n  \"chat.onboarding.noBot\": \"No bot selected yet\",\n  \"chat.onboarding.noBotDesc\": \"Create or select a bot to get started.\",\n  \"chat.onboarding.readyTitle\": \"Your bot is ready\",\n  \"chat.onboarding.readyDesc\": \"Type a command below or pick from the suggestions.\",\n  \"chat.confirm\": \"Confirm\",\n  \"chat.cancel\": \"Cancel\",\n  \"chat.onboardingSubtitle\": \"Try one of these — just click to fill in, then press Enter\",\n\n  \"chat.placeholder.noBot\": \"\\\"list bots\\\" or \\\"bot status\\\"\",\n  \"chat.placeholder.noSources\": \"\\\"add source https://...\\\" or \\\"bot status\\\"\",\n  \"chat.placeholder.noCollection\": \"\\\"run collect\\\" or \\\"schedule daily 9:00\\\"\",\n  \"chat.placeholder.ready\": \"\\\"bot status\\\" or \\\"run collect, analyze, report\\\"\",\n  \"chat.placeholder.scheduleIssue\": \"\\\"bot status\\\" or \\\"schedule daily 9:00\\\"\",\n\n  \"chat.hint.listBots\": \"list bots\",\n  \"chat.hint.switchBot\": \"switch bot investing\",\n  \"chat.hint.checkSetup\": \"bot status\",\n  \"chat.hint.addDefaultSources\": \"add source https://news.ycombinator.com/rss\",\n  \"chat.hint.addSourceUrl\": \"add source https://\",\n  \"chat.hint.botStatus\": \"bot status\",\n  \"chat.hint.quickSummary\": \"run collect, analyze, report\",\n  \"chat.hint.statusBriefing\": \"bot status\",\n  \"chat.hint.scheduleDailyNine\": \"schedule daily 9:00\",\n  \"chat.hint.changeScheduleEight\": \"schedule daily 8:00\",\n  \"chat.hint.weekdaysOnly\": \"schedule weekdays 9:00\",\n  \"chat.hint.checkReportIssue\": \"bot status\",\n  \"chat.hint.nextRunTime\": \"bot status\",\n  \"chat.hint.whatNext\": \"bot status\",\n  \"chat.hint.pauseBot\": \"pause bot\",\n\n  \"chat.botHint.collectCommunity\": \"run collect — gather community posts about automation\",\n  \"chat.botHint.findRedditNeeds\": \"run collect — find Reddit posts about automation needs\",\n  \"chat.botHint.collectComplaints\": \"run collect — gather solo founder workflow complaints\",\n  \"chat.botHint.analyzePatterns\": \"run analyze — analyze user interest patterns\",\n  \"chat.botHint.organizeInvestor\": \"run collect — gather investor community posts\",\n  \"chat.botHint.collectQuestions\": \"run collect — gather productivity tool questions\",\n  \"chat.botHint.summarizeProblems\": \"run analyze — summarize problem reports\",\n  \"chat.botHint.draftContribution\": \"run draft — create helpful community reply (no promotion)\",\n  \"chat.botHint.draftAutomationTip\": \"run draft — write automation tip contribution\",\n  \"chat.botHint.draftRssTip\": \"run draft — write RSS usage tips article\",\n  \"chat.botHint.analyzeTrends\": \"run analyze — analyze this week's automation trends\",\n  \"chat.botHint.analyzeDemand\": \"run analyze — analyze tool demand by community\",\n  \"chat.botHint.analyzePersonas\": \"run analyze — identify user personas from collected data\",\n  \"chat.botHint.monitorReddit\": \"run collect — monitor automation mentions on Reddit/HN\",\n  \"chat.botHint.trackCompetitors\": \"run collect — track competitor tool mentions\",\n  \"chat.botHint.dailyBriefing\": \"run collect, analyze, report — daily community briefing\",\n  \"chat.botHint.noPromotion\": \"run draft — value-focused, no direct promotion\",\n  \"chat.botHint.authenticOnly\": \"run draft — authentic community contribution only\",\n  \"chat.botHint.noLinksNoBrand\": \"run draft — problem-solving focus, no links or brand names\",\n\n  \"settings.title\": \"Settings\",\n  \"settings.subtitle\": \"Configure scheduler, LLM providers, and bot settings\",\n  \"settings.providers.title\": \"LLM Providers\",\n  \"settings.providers.subtitle\": \"Connect your own AI provider API keys\",\n  \"settings.providers.addButton\": \"Add Provider\",\n  \"settings.providers.noProviders\": \"No LLM providers configured. Add one to start using AI features with your bots.\",\n  \"settings.providers.name\": \"Name\",\n  \"settings.providers.namePlaceholder\": \"e.g. My Anthropic Key\",\n  \"settings.providers.type\": \"Provider Type\",\n  \"settings.providers.apiKey\": \"API Key\",\n  \"settings.providers.apiKeyKeep\": \"(leave blank to keep current)\",\n  \"settings.providers.apiKeyPlaceholder\": \"sk-...\",\n  \"settings.providers.apiKeyEditPlaceholder\": \"Enter new key or leave blank\",\n  \"settings.providers.baseUrl\": \"Base URL\",\n  \"settings.providers.baseUrlHint\": \"(optional, for custom endpoints)\",\n  \"settings.providers.defaultModel\": \"Default Model\",\n  \"settings.providers.defaultModelHint\": \"(optional)\",\n  \"settings.providers.save\": \"Save\",\n  \"settings.providers.update\": \"Update\",\n  \"settings.providers.cancel\": \"Cancel\",\n  \"settings.providers.added\": \"LLM Provider added\",\n  \"settings.providers.updated\": \"LLM Provider updated\",\n  \"settings.providers.deleted\": \"LLM Provider deleted\",\n  \"settings.providers.addFailed\": \"Failed to add provider\",\n  \"settings.providers.updateFailed\": \"Failed to update provider\",\n  \"settings.providers.deleteFailed\": \"Failed to delete provider\",\n  \"settings.telegram.title\": \"Telegram Integration\",\n  \"settings.telegram.subtitle\": \"Control your bots from Telegram\",\n  \"settings.telegram.notConfigured\": \"Telegram bot is not configured. Set TELEGRAM_BOT_TOKEN to enable.\",\n  \"settings.telegram.linked\": \"Telegram Linked\",\n  \"settings.telegram.unlink\": \"Unlink\",\n  \"settings.telegram.unlinked\": \"Telegram account unlinked\",\n  \"settings.telegram.howToLink\": \"Link your Telegram account\",\n  \"settings.telegram.step1\": \"Click 'Generate Link Code' below\",\n  \"settings.telegram.step2\": \"Open the Maker bot in Telegram\",\n  \"settings.telegram.step3\": \"Send the /link command with your code\",\n  \"settings.telegram.generateCode\": \"Generate Link Code\",\n  \"settings.telegram.codeFailed\": \"Failed to generate link code\",\n  \"settings.telegram.setupGuideTitle\": \"How to set up Telegram\",\n  \"settings.telegram.setupGuide1\": \"1. Open Telegram and search for @BotFather\",\n  \"settings.telegram.setupGuide2\": \"2. Send /newbot and follow the prompts to create a bot\",\n  \"settings.telegram.setupGuide3\": \"3. Copy the bot token you receive\",\n  \"settings.telegram.setupGuide4\": \"4. Add it as TELEGRAM_BOT_TOKEN in your environment secrets\",\n  \"settings.telegram.setupGuide5\": \"5. Restart the app, then come back here to link your account\",\n  \"settings.telegram.commands\": \"Available commands in Telegram\",\n  \"settings.telegram.cmdStart\": \"/start — Introduction and setup instructions\",\n  \"settings.telegram.cmdLink\": \"/link CODE — Link your Maker account\",\n  \"settings.telegram.cmdUnlink\": \"/unlink — Unlink your account\",\n  \"settings.telegram.cmdHelp\": \"/help — Show available commands\",\n  \"settings.telegram.cmdNatural\": \"Or just type naturally, e.g. \\\"check my bot status\\\"\",\n  \"settings.scheduler.title\": \"Scheduler Status\",\n  \"settings.scheduler.subtitle\": \"Automated content collection and analysis\",\n  \"settings.scheduler.running\": \"Running\",\n  \"settings.scheduler.stopped\": \"Stopped\",\n  \"settings.scheduler.start\": \"Start\",\n  \"settings.scheduler.stop\": \"Stop\",\n  \"settings.scheduler.started\": \"Scheduler started\",\n  \"settings.scheduler.stoppedMsg\": \"Scheduler stopped\",\n  \"settings.scheduler.toggleFailed\": \"Failed to toggle scheduler\",\n  \"settings.scheduler.rssCollection\": \"RSS Collection\",\n  \"settings.scheduler.contentAnalysis\": \"Content Analysis\",\n  \"settings.scheduler.draftGeneration\": \"Draft Generation\",\n  \"settings.scheduler.interval\": \"Interval:\",\n  \"settings.scheduler.last\": \"Last:\",\n  \"settings.scheduler.runNow\": \"Run Now\",\n  \"settings.scheduler.jobStarted\": \"{{job}} job started\",\n  \"settings.scheduler.jobFailed\": \"Failed to run job\",\n\n  \"sources.title\": \"Sources\",\n  \"sources.subtitle\": \"Manage RSS feeds and content sources\",\n  \"sources.addSource\": \"Add Source\",\n  \"sources.addFirst\": \"Add Your First Source\",\n  \"sources.noSources\": \"No sources added\",\n  \"sources.noSourcesHint\": \"Add an RSS feed to start collecting content\",\n  \"sources.dialog.title\": \"Add New Source\",\n  \"sources.dialog.desc\": \"Add a new RSS feed to collect content from\",\n  \"sources.dialog.name\": \"Name\",\n  \"sources.dialog.namePlaceholder\": \"My Feed\",\n  \"sources.dialog.feedUrl\": \"Feed URL\",\n  \"sources.dialog.feedUrlPlaceholder\": \"https://example.com/feed.xml\",\n  \"sources.dialog.topic\": \"Topic\",\n  \"sources.dialog.trust\": \"Trust\",\n  \"sources.dialog.region\": \"Region\",\n  \"sources.dialog.creating\": \"Creating...\",\n  \"sources.dialog.create\": \"Create Source\",\n  \"sources.created\": \"Source created successfully\",\n  \"sources.createFailed\": \"Failed to create source\",\n  \"sources.deleted\": \"Source deleted\",\n  \"sources.deleteFailed\": \"Failed to delete source\",\n  \"sources.collectionStarted\": \"Collection started\",\n  \"sources.collectionFailed\": \"Failed to start collection\",\n  \"sources.delete.title\": \"Delete Source\",\n  \"sources.delete.desc\": \"Are you sure you want to delete \\\"{{name}}\\\"? This will not delete collected items.\",\n  \"sources.delete.cancel\": \"Cancel\",\n  \"sources.delete.confirm\": \"Delete\",\n  \"sources.active\": \"Active\",\n  \"sources.disabled\": \"Disabled\",\n  \"sources.itemsCollected\": \"{{count}} items collected\",\n  \"sources.created2\": \"Created {{date}}\",\n\n  \"profiles.title\": \"My Workflow Bots\",\n  \"profiles.subtitle\": \"Configure and manage your bots' sources, schedules, and outputs\",\n  \"profiles.noBots\": \"No bots created yet\",\n  \"profiles.noBotsDesc\": \"Start your first workflow from a template below. You can freely customize sources, schedules, and outputs.\",\n  \"profiles.startTemplate\": \"Start from Template\",\n  \"profiles.createNew\": \"Create New Bot\",\n  \"profiles.createNewDesc\": \"Choose from templates\",\n  \"profiles.galleryTitle\": \"Workflow Recipes\",\n  \"profiles.gallerySubtitle\": \"These templates are starting points for building your own workflows, not final answers.\",\n  \"profiles.noTemplates\": \"No templates available yet. They will appear here once configured.\",\n  \"profiles.sources\": \"Sources: {{count}} default channels\",\n  \"profiles.output\": \"Output: {{type}}\",\n  \"profiles.startWith\": \"Start with this setup\",\n  \"profiles.other\": \"Other\",\n  \"profiles.wizard.chooseTemplate\": \"Choose a Template\",\n  \"profiles.wizard.chooseTemplateDesc\": \"Pick a template to start with. You can customize everything later.\",\n  \"profiles.wizard.selectTopic\": \"Select Topic\",\n  \"profiles.wizard.selectTopicDesc\": \"This template supports multiple topics. Choose which area to focus on for {{name}}.\",\n  \"profiles.wizard.configure\": \"Configure Your Bot\",\n  \"profiles.wizard.configureDesc\": \"Set up your bot's workflow. Default sources are general public channels — add your own for more specialized coverage.\",\n  \"profiles.wizard.botName\": \"Bot Name\",\n  \"profiles.wizard.topic\": \"Topic\",\n  \"profiles.wizard.defaultSources\": \"Default Sources\",\n  \"profiles.wizard.customSourceUrl\": \"Custom Source URL\",\n  \"profiles.wizard.customSourceUrlPlaceholder\": \"https://example.com/rss\",\n  \"profiles.wizard.customSourceName\": \"Name (optional)\",\n  \"profiles.wizard.addSource\": \"Add\",\n  \"profiles.wizard.back\": \"Back\",\n  \"profiles.wizard.creating\": \"Creating...\",\n  \"profiles.wizard.createBot\": \"Create Bot\",\n  \"profiles.wizard.customTopicLabel\": \"Or enter your own topic\",\n  \"profiles.wizard.customTopicPlaceholder\": \"e.g. health, finance, education\",\n  \"profiles.wizard.customTopicUse\": \"Use\",\n  \"profiles.wizard.customTopicDuplicate\": \"You already have a bot with this topic.\",\n  \"profiles.wizard.customTopicHint\": \"Letters, numbers, and underscores only. The same topic key cannot be reused.\",\n  \"profiles.wizard.sourceDisclaimer\": \"Source Disclaimer\",\n  \"profiles.botCreated\": \"Bot created successfully\",\n  \"profiles.botCreateFailed\": \"Failed to create bot\",\n  \"profiles.botDeleted\": \"Bot deleted\",\n  \"profiles.urlAlreadyAdded\": \"This source URL is already added\",\n  \"profiles.invalidUrl\": \"Please enter a valid URL\",\n  \"profiles.deleteConfirm\": \"Are you sure you want to delete this bot?\",\n\n  \"botDetail.title\": \"Bot Settings\",\n  \"botDetail.notFound\": \"Bot not found\",\n  \"botDetail.back\": \"Back to My Bots\",\n  \"botDetail.saveChanges\": \"Save Changes\",\n  \"botDetail.saved\": \"Bot settings saved\",\n  \"botDetail.saveFailed\": \"Failed to save settings\",\n  \"botDetail.workflow.title\": \"This Bot's Workflow\",\n  \"botDetail.workflow.watching\": \"Watching:\",\n  \"botDetail.workflow.sources\": \"{{count}} sources\",\n  \"botDetail.workflow.schedule\": \"Schedule:\",\n  \"botDetail.workflow.notSet\": \"Not set\",\n  \"botDetail.workflow.output\": \"Output:\",\n  \"botDetail.workflow.hint\": \"You can change these settings anytime to fit your purpose.\",\n  \"botDetail.general\": \"General\",\n  \"botDetail.botName\": \"Bot Name\",\n  \"botDetail.enabled\": \"Enabled\",\n  \"botDetail.active\": \"Active\",\n  \"botDetail.paused\": \"Paused\",\n  \"botDetail.aiModel.title\": \"AI Model\",\n  \"botDetail.aiModel.subtitle\": \"Choose which AI provider this bot uses for analysis and reports\",\n  \"botDetail.aiModel.provider\": \"LLM Provider\",\n  \"botDetail.aiModel.providerPlaceholder\": \"Select your AI provider\",\n  \"botDetail.aiModel.noProviders\": \"No AI providers yet. Go to Settings to add your own API key first.\",\n  \"botDetail.aiModel.modelOverride\": \"Model Override\",\n  \"botDetail.aiModel.modelOverrideHint\": \"(optional)\",\n  \"botDetail.aiModel.modelOverridePlaceholder\": \"Leave blank to use provider's default\",\n  \"botDetail.aiModel.availableModels\": \"Available for {{type}}: {{models}}\",\n  \"botDetail.aiModel.modelMismatch\": \"This model name is not in the known list for {{type}}. Make sure it's correct.\",\n  \"botDetail.aiModel.providerDeleted\": \"The previously assigned provider was deleted. This bot has been reset to System Default. Save to confirm.\",\n  \"botDetail.schedule.title\": \"Schedule\",\n  \"botDetail.schedule.subtitle\": \"When this bot generates reports\",\n  \"botDetail.schedule.runDays\": \"Run Days\",\n  \"botDetail.schedule.daily\": \"Every Day\",\n  \"botDetail.schedule.weekdays\": \"Weekdays Only (Mon-Fri)\",\n  \"botDetail.schedule.weekends\": \"Weekends Only (Sat-Sun)\",\n  \"botDetail.schedule.runTime\": \"Run Time\",\n  \"botDetail.schedule.timezone\": \"Timezone\",\n  \"botDetail.format.title\": \"Report Format\",\n  \"botDetail.format.subtitle\": \"Control how reports are written\",\n  \"botDetail.format.length\": \"Report Length\",\n  \"botDetail.format.short\": \"Short (Brief summary)\",\n  \"botDetail.format.normal\": \"Normal (Standard detail)\",\n  \"botDetail.format.detailed\": \"Detailed (Full analysis)\",\n  \"botDetail.format.style\": \"Writing Style\",\n  \"botDetail.format.conversational\": \"Conversational (News anchor tone, minimal symbols)\",\n  \"botDetail.format.structured\": \"Structured (Markdown headers and formatting)\",\n  \"botDetail.format.sections\": \"Report Sections\",\n  \"botDetail.format.section.tldr\": \"TL;DR Summary\",\n  \"botDetail.format.section.drivers\": \"Market Drivers / Key Trends\",\n  \"botDetail.format.section.risk\": \"Risk Radar\",\n  \"botDetail.format.section.checklist\": \"Action Checklist\",\n  \"botDetail.format.section.sources\": \"Source References\",\n  \"botDetail.filters.title\": \"Filters\",\n  \"botDetail.filters.subtitle\": \"Control which content gets included\",\n  \"botDetail.filters.minImportance\": \"Minimum Importance Score: {{score}}\",\n  \"botDetail.filters.hint\": \"Items scoring below this threshold will be excluded from reports.\",\n  \"botDetail.filters.filtering\": \"Currently filtering out items below {{score}}/100.\",\n  \"botDetail.sources.title\": \"Linked Sources ({{count}})\",\n  \"botDetail.sources.subtitle\": \"Sources feeding data to this bot\",\n  \"botDetail.sources.none\": \"No sources linked yet.\",\n  \"botDetail.sources.noneHint\": \"Add sources below to start collecting data for this bot.\",\n  \"botDetail.sources.weight\": \"weight: {{weight}}\",\n  \"botDetail.sources.available\": \"Available Sources\",\n  \"botDetail.sources.add\": \"Add\",\n  \"botDetail.sources.goToSources\": \"Go to Sources Page\",\n  \"botDetail.sources.linked\": \"Source linked to bot\",\n  \"botDetail.sources.linkFailed\": \"Failed to link source\",\n  \"botDetail.sources.removed\": \"Source removed from bot\",\n  \"botDetail.sources.removeFailed\": \"Failed to remove source\",\n\n  \"botDetail.schedule.daily2\": \"Daily\",\n  \"botDetail.schedule.weekdays2\": \"Weekdays\",\n  \"botDetail.schedule.weekends2\": \"Weekends\",\n  \"botDetail.format.conversational2\": \"Conversational\",\n  \"botDetail.format.structured2\": \"Structured\",\n  \"botDetail.format.short2\": \"Short\",\n  \"botDetail.format.normal2\": \"Normal\",\n  \"botDetail.format.detailed2\": \"Detailed\",\n\n  \"sources.topic.tech\": \"Tech\",\n  \"sources.topic.investing\": \"Investing\",\n  \"sources.topic.crypto\": \"Crypto\",\n  \"sources.topic.ai_art\": \"AI Art\",\n  \"sources.topic.creative\": \"Creative\",\n  \"sources.topic.community_research\": \"Community Research\",\n  \"sources.topic.market_brief\": \"Market Brief\",\n  \"sources.topic.research_watch\": \"Research Watch\",\n  \"sources.topic.competitor_watch\": \"Competitor Watch\",\n  \"sources.topic.finance\": \"Finance\",\n  \"sources.topic.compliance\": \"Compliance\",\n  \"sources.topic.commerce\": \"Commerce\",\n  \"sources.topic.engagement\": \"Engagement\",\n  \"sources.topic.health\": \"Health\",\n  \"sources.topic.science\": \"Science\",\n  \"sources.topic.education\": \"Education\",\n  \"sources.topic.content_research\": \"Content Research\",\n  \"sources.topic.work_productivity\": \"Work & Productivity\",\n  \"sources.topic.online_business\": \"Online Business\",\n  \"sources.topic.korea_marketplace\": \"Korea Marketplace\",\n  \"sources.topic.gaming\": \"Gaming\",\n  \"sources.topic.sustainability\": \"Sustainability\",\n  \"sources.topic.other\": \"Other\",\n  \"sources.validation.nameRequired\": \"Name is required\",\n  \"sources.validation.validUrl\": \"Must be a valid URL\",\n\n  \"profiles.category.information\": \"Information\",\n  \"profiles.category.business\": \"Business\",\n  \"profiles.category.compliance\": \"Compliance\",\n  \"profiles.category.research\": \"Research\",\n  \"profiles.category.commerce\": \"Commerce\",\n  \"profiles.category.engagement\": \"Engagement\",\n  \"profiles.category.finance\": \"Finance\",\n  \"profiles.category.work\": \"Work\",\n\n  \"guide.title\": \"Getting Started Guide\",\n  \"guide.intro\": \"Maker is a tool for building your own AI automation assistant that handles tasks on your behalf. No coding required — just pick a template, click a few buttons, and create your own AI workflow.\",\n  \"guide.capabilities\": \"What Can You Do with Maker?\",\n  \"guide.capability1\": \"Automatically collect news, community posts, and market data every morning\",\n  \"guide.capability2\": \"Summarize, analyze, and organize collected content into reports\",\n  \"guide.capability3\": \"Auto-generate blog posts, briefings, and report drafts\",\n  \"guide.capability4\": \"Automate investment research, trend analysis, and content curation\",\n  \"guide.capability5\": \"Run your own \\\"AI assistant\\\" with your custom rules\",\n  \"guide.corePoint\": \"Key point:\",\n  \"guide.coreDesc\": \"Maker is not a service that lends you bots — it's a tool for designing your own automation.\",\n  \"guide.stepsHeading\": \"Get Started in 6 Simple Steps\",\n  \"guide.step1.title\": \"Sign Up & Login\",\n  \"guide.step1.p1\": \"Visit maker.am and sign up or log in.\",\n  \"guide.step1.p2\": \"Once you see the Dashboard, you're ready to go.\",\n  \"guide.step2.title\": \"Register Your LLM API\",\n  \"guide.step2.subtitle\": \"Claude, OpenAI, etc.\",\n  \"guide.step2.p1\": \"Maker uses your own API key to run AI tasks.\",\n  \"guide.step2.li1\": \"Click <strong>Settings</strong> in the sidebar\",\n  \"guide.step2.li2\": \"In the <strong>LLM Providers</strong> section, click <strong>Add Provider</strong>\",\n  \"guide.step2.li3\": \"Fill in the following fields:\",\n  \"guide.step2.fieldName\": \"Name:\",\n  \"guide.step2.fieldNameEx\": \"e.g. My Claude API\",\n  \"guide.step2.fieldType\": \"Provider Type:\",\n  \"guide.step2.fieldTypeEx\": \"Choose Anthropic (Claude) / OpenAI, etc.\",\n  \"guide.step2.fieldKey\": \"API Key:\",\n  \"guide.step2.fieldKeyEx\": \"Paste your issued key\",\n  \"guide.step2.fieldUrl\": \"Base URL:\",\n  \"guide.step2.fieldUrlEx\": \"Leave empty (uses default)\",\n  \"guide.step2.fieldModel\": \"Default Model:\",\n  \"guide.step2.fieldModelEx\": \"Leave empty or e.g. claude-3-5-sonnet-latest\",\n  \"guide.step2.done\": \"Click Save, and Maker can now use your AI model.\",\n  \"guide.step3.title\": \"Create a Bot from a Template\",\n  \"guide.step3.li1\": \"Go to <strong>Dashboard</strong> or <strong>My Bots</strong>\",\n  \"guide.step3.li2\": \"Click <strong>Create Bot / From Template</strong>\",\n  \"guide.step3.li3\": \"Choose a template (e.g. Community Research, Investing, etc.)\",\n  \"guide.step3.li4\": \"Name your bot and create it\",\n  \"guide.step3.hint1\": \"Templates are pre-designed automation recipes.\",\n  \"guide.step3.hint2\": \"We recommend starting with a template for your first bot.\",\n  \"guide.step4.title\": \"Add Your Sources\",\n  \"guide.step4.p1\": \"This is where you define where AI collects information from.\",\n  \"guide.step4.li1\": \"Click <strong>Sources</strong> in the sidebar\",\n  \"guide.step4.li2\": \"Add, edit, or remove sources as needed\",\n  \"guide.step4.li3\": \"Save your changes\",\n  \"guide.step4.hint1\": \"Examples: News sites, blog RSS feeds, Reddit, Hacker News, TechCrunch, etc.\",\n  \"guide.step4.hint2\": \"AI will collect content based on the sources you configure here.\",\n  \"guide.step5.title\": \"Command Your AI via Console\",\n  \"guide.step5.p1\": \"Go to <strong>Console</strong> in the sidebar.\",\n  \"guide.step5.p2\": \"Try typing commands like:\",\n  \"guide.step5.cmd1\": \"\\\"Summarize today's collected items\\\"\",\n  \"guide.step5.cmd2\": \"\\\"Analyze this from an investment perspective\\\"\",\n  \"guide.step5.cmd3\": \"\\\"Write a blog post draft\\\"\",\n  \"guide.step5.p3\": \"The key idea behind Maker: <strong>\\\"Put your AI to work.\\\"</strong>\",\n  \"guide.step6.title\": \"Review & Approve Results\",\n  \"guide.step6.li1\": \"Go to <strong>Drafts</strong> or <strong>Reports</strong>\",\n  \"guide.step6.li2\": \"Review AI-generated drafts\",\n  \"guide.step6.li3\": \"Edit or use them as-is\",\n  \"guide.step6.li4\": \"Approve or Export\",\n  \"guide.step6.hint\": \"AI does the work. You make the decisions.\",\n  \"guide.faq.title\": \"FAQ\",\n  \"guide.faq.q1\": \"Is Maker a chatbot service?\",\n  \"guide.faq.a1\": \"No. Maker is a workflow-based automation tool. The chat console is simply an interface for giving commands — the core value is in the automated workflows running behind the scenes.\",\n  \"guide.faq.q2\": \"Do I need to know how to code?\",\n  \"guide.faq.a2\": \"Not at all. Templates, a few clicks, and simple configuration are all you need to get started.\",\n  \"guide.faq.q3\": \"Is my API key safe?\",\n  \"guide.faq.a3\": \"Maker only uses your API key to make AI calls. Your key is never exposed externally, and you can replace or delete it anytime.\",\n  \"guide.faq.q4\": \"Can I use both Claude and GPT?\",\n  \"guide.faq.a4\": \"Yes. You can register multiple LLM providers in Settings and switch between them depending on your needs.\",\n  \"guide.faq.q5\": \"Who is Maker useful for?\",\n  \"guide.faq.a5\": \"Anyone who needs daily research, summaries, or analysis. Content creators, writers, and planners. Investors and market analysts looking to automate trend tracking. Anyone who wants to use AI as a productive assistant, not just a Q&A tool.\",\n  \"guide.philosophy\": \"\\\"Don't ask AI questions. Put it to work.\\\"\",\n  \"guide.philosophyDesc\": \"Maker is a tool for building an automation assistant that saves your time and focus.\",\n  \"guide.settingsButton\": \"Settings\",\n  \"guide.botsButton\": \"My Bots\",\n\n  \"observe.title\": \"Observe List\",\n  \"observe.subtitle\": \"High relevance but low reply worthiness - useful for market research and content ideas\",\n  \"observe.noItems\": \"No items to observe\",\n  \"observe.noItemsHint\": \"Items with high relevance but low reply worthiness will appear here\",\n  \"observe.relevance\": \"Relevance:\",\n  \"observe.reply\": \"Reply:\",\n  \"observe.viewOriginal\": \"View Original\",\n  \"observe.details\": \"Details\",\n\n  \"items.title\": \"Items\",\n  \"items.subtitle\": \"Collected content from RSS feeds\",\n  \"items.searchPlaceholder\": \"Search items...\",\n  \"items.filterStatus\": \"Filter by status\",\n  \"items.allStatus\": \"All Status\",\n  \"items.status.new\": \"New\",\n  \"items.status.analyzed\": \"Analyzed\",\n  \"items.status.drafted\": \"Drafted\",\n  \"items.status.approved\": \"Approved\",\n  \"items.status.posted\": \"Posted\",\n  \"items.status.skipped\": \"Skipped\",\n  \"items.count\": \"Items ({{count}})\",\n  \"items.noItems\": \"No items found\",\n  \"items.noItemsFilter\": \"Try changing the status filter\",\n  \"items.noItemsDefault\": \"Add RSS sources to start collecting content\",\n  \"items.relevance\": \"Relevance: {{score}}\",\n  \"items.replyScore\": \"Reply Score: {{score}}\",\n  \"items.by\": \"by {{author}}\",\n\n  \"drafts.title\": \"Drafts\",\n  \"drafts.subtitle\": \"Review and approve generated reply drafts\",\n  \"drafts.filterDecision\": \"Filter by decision\",\n  \"drafts.allDecisions\": \"All Decisions\",\n  \"drafts.decision.pending\": \"Pending\",\n  \"drafts.decision.approved\": \"Approved\",\n  \"drafts.decision.rejected\": \"Rejected\",\n  \"drafts.count\": \"Drafts ({{count}})\",\n  \"drafts.variant\": \"Variant {{variant}}\",\n  \"drafts.approve\": \"Approve\",\n  \"drafts.reject\": \"Reject\",\n  \"drafts.copy\": \"Copy\",\n  \"drafts.viewItem\": \"View Item\",\n  \"drafts.noDrafts\": \"No drafts found\",\n  \"drafts.noDraftsFilter\": \"Try changing the filter\",\n  \"drafts.noDraftsDefault\": \"Drafts will appear here after analysis\",\n  \"drafts.approved\": \"Draft approved\",\n  \"drafts.rejected\": \"Draft rejected\",\n  \"drafts.copiedToClipboard\": \"Copied to clipboard\",\n\n  \"itemDetail.notFound\": \"Item not found\",\n  \"itemDetail.backToItems\": \"Back to Items\",\n  \"itemDetail.by\": \"by {{author}}\",\n  \"itemDetail.original\": \"Original\",\n  \"itemDetail.originalContent\": \"Original Content\",\n  \"itemDetail.analysis\": \"Analysis\",\n  \"itemDetail.relevance\": \"Relevance\",\n  \"itemDetail.replyScore\": \"Reply Score\",\n  \"itemDetail.linkFit\": \"Link Fit\",\n  \"itemDetail.suggestedAngle\": \"Suggested Angle:\",\n  \"itemDetail.summary\": \"Summary:\",\n  \"itemDetail.draftReplies\": \"Draft Replies\",\n  \"itemDetail.skip\": \"Skip\",\n  \"itemDetail.reanalyze\": \"Re-analyze\",\n  \"itemDetail.variant\": \"Variant {{variant}}\",\n  \"itemDetail.includesLink\": \"Includes Link\",\n  \"itemDetail.editPlaceholder\": \"Edit the draft text...\",\n  \"itemDetail.approve\": \"Approve\",\n  \"itemDetail.reject\": \"Reject\",\n  \"itemDetail.copy\": \"Copy\",\n  \"itemDetail.copyNoLinks\": \"Copy w/o Links\",\n  \"itemDetail.approvedFinal\": \"Approved Final Text\",\n  \"itemDetail.noDrafts\": \"No drafts generated yet\",\n  \"itemDetail.draftsWillGenerate\": \"Drafts will be generated automatically\",\n  \"itemDetail.approvedSuccess\": \"Draft approved successfully\",\n  \"itemDetail.approveFailed\": \"Failed to approve draft\",\n  \"itemDetail.rejectedSuccess\": \"Draft rejected\",\n  \"itemDetail.rejectFailed\": \"Failed to reject draft\",\n  \"itemDetail.skipped\": \"Item skipped\",\n  \"itemDetail.skipFailed\": \"Failed to skip item\",\n  \"itemDetail.reanalysis\": \"Re-analysis started\",\n  \"itemDetail.reanalysisFailed\": \"Failed to start re-analysis\",\n  \"itemDetail.copiedToClipboard\": \"Copied to clipboard\",\n  \"itemDetail.riskFlag.promo_ban\": \"Promo Banned\",\n  \"itemDetail.riskFlag.link_ban\": \"Link Banned\",\n  \"itemDetail.riskFlag.heated_topic\": \"Heated Topic\",\n  \"itemDetail.riskFlag.new_account_risk\": \"New Account Risk\",\n  \"itemDetail.riskFlag.unknown_rules\": \"Unknown Rules\",\n\n  \"common.untitled\": \"Untitled\",\n  \"common.status.new\": \"New\",\n  \"common.status.analyzed\": \"Analyzed\",\n  \"common.status.drafted\": \"Drafted\",\n  \"common.status.approved\": \"Approved\",\n  \"common.status.posted\": \"Posted\",\n  \"common.status.skipped\": \"Skipped\",\n  \"common.decision.pending\": \"Pending\",\n  \"common.decision.approved\": \"Approved\",\n  \"common.decision.rejected\": \"Rejected\",\n\n  \"runs.title\": \"Execution History\",\n  \"runs.empty\": \"No runs yet\",\n  \"runs.viewAll\": \"View All Runs\",\n  \"runs.lastRun\": \"Last Run\",\n  \"runs.status\": \"Status\",\n  \"runs.trigger\": \"Trigger\",\n  \"runs.jobType\": \"Type\",\n  \"runs.duration\": \"Duration\",\n  \"runs.startedAt\": \"Started\",\n  \"runs.items\": \"Items\",\n  \"runs.error\": \"Error\",\n  \"runs.status.ok\": \"Success\",\n  \"runs.status.error\": \"Failed\",\n  \"runs.status.timeout\": \"Timeout\",\n  \"runs.status.skipped\": \"Skipped\",\n  \"runs.status.started\": \"Running\",\n  \"runs.trigger.schedule\": \"Scheduled\",\n  \"runs.trigger.console\": \"Console\",\n  \"runs.trigger.manual\": \"Manual\",\n  \"runs.jobType.report\": \"Report\",\n  \"runs.jobType.pipeline\": \"Pipeline\",\n  \"runs.jobType.collect\": \"Collect\",\n  \"runs.jobType.analyze\": \"Analyze\",\n  \"runs.neverRan\": \"Never ran\",\n  \"runs.ago\": \"{{time}} ago\",\n\n  \"diag.title\": \"Bot Health\",\n  \"diag.healthy\": \"All systems healthy\",\n  \"diag.warnings\": \"{{count}} warning(s)\",\n  \"diag.errors\": \"{{count}} issue(s) found\",\n  \"diag.noBotsYet\": \"Create a bot to see diagnostics\",\n  \"diag.checkAll\": \"View All Diagnostics\",\n\n  \"lang.en\": \"EN\",\n  \"lang.ko\": \"KO\",\n  \"lang.english\": \"English\",\n  \"lang.korean\": \"Korean\",\n\n  \"perm.title\": \"Permissions\",\n  \"perm.subtitle\": \"Control what your bots can access and do\",\n  \"perm.globalDefaults\": \"Global Defaults\",\n  \"perm.botOverrides\": \"Bot Overrides\",\n  \"perm.group.web_sources\": \"Web & Sources\",\n  \"perm.group.ai_data\": \"AI & Data\",\n  \"perm.group.files\": \"Files\",\n  \"perm.group.calendar\": \"Calendar\",\n  \"perm.group.scheduling\": \"Scheduling\",\n  \"perm.enabled\": \"Enabled\",\n  \"perm.disabled\": \"Disabled\",\n  \"perm.mode.AUTO_ALLOWED\": \"Auto-Allowed\",\n  \"perm.mode.APPROVAL_REQUIRED\": \"Requires Approval\",\n  \"perm.mode.AUTO_DENIED\": \"Denied\",\n  \"perm.egress.NO_EGRESS\": \"No Data Sent\",\n  \"perm.egress.METADATA_ONLY\": \"Metadata Only\",\n  \"perm.egress.FULL_CONTENT_ALLOWED\": \"Full Content\",\n  \"perm.risk.LOW\": \"Low Risk\",\n  \"perm.risk.MED\": \"Medium Risk\",\n  \"perm.risk.HIGH\": \"High Risk\",\n  \"perm.source.default\": \"Default\",\n  \"perm.source.global\": \"Global Override\",\n  \"perm.source.bot\": \"Bot Override\",\n  \"perm.resetToDefault\": \"Reset to Default\",\n  \"perm.saved\": \"Permission saved\",\n  \"perm.deleted\": \"Permission reset to default\",\n  \"perm.error\": \"Failed to update permission\",\n  \"perm.egressLevel\": \"Data Egress Level\",\n  \"perm.overrideForBot\": \"Override for this bot\",\n  \"perm.usingGlobal\": \"Using global setting\",\n  \"perm.noOverrides\": \"No bot-level overrides set\",\n\n  \"audit.title\": \"Audit Log\",\n  \"audit.subtitle\": \"Track permission changes and security events\",\n  \"audit.noLogs\": \"No audit events yet\",\n  \"audit.eventType\": \"Event\",\n  \"audit.permKey\": \"Permission\",\n  \"audit.time\": \"Time\",\n  \"audit.details\": \"Details\",\n  \"audit.PERMISSION_CHANGED\": \"Permission Changed\",\n  \"audit.PERMISSION_DELETED\": \"Permission Reset\",\n  \"audit.PERMISSION_DENIED\": \"Action Denied\",\n  \"audit.APPROVAL_REQUESTED\": \"Approval Requested\",\n  \"audit.APPROVAL_GRANTED_ONCE\": \"Approved (Once)\",\n  \"audit.APPROVAL_GRANTED_BOT\": \"Approved (Bot)\",\n  \"audit.APPROVAL_GRANTED_GLOBAL\": \"Approved (Global)\",\n\n  \"pd.title\": \"Permission Dashboard\",\n  \"pd.subtitle\": \"Control what this bot can access and do\",\n  \"pd.summary\": \"Permission Status\",\n  \"pd.totalPermissions\": \"permissions total\",\n  \"pd.active\": \"Active\",\n  \"pd.needsApproval\": \"Needs Approval\",\n  \"pd.blocked\": \"Blocked\",\n  \"pd.group.data_collection\": \"Data Collection\",\n  \"pd.group.ai_processing\": \"AI Processing\",\n  \"pd.group.local_system\": \"Local System\",\n  \"pd.group.automation\": \"Automation Control\",\n  \"pd.currentStatus\": \"Current Status\",\n  \"pd.description\": \"Description\",\n  \"pd.riskLevel\": \"Risk Level\",\n  \"pd.changeStatus\": \"Change Status\",\n  \"pd.applyScope\": \"Apply to\",\n  \"pd.thisBotOnly\": \"This bot only\",\n  \"pd.allBots\": \"All bots (global)\",\n  \"pd.highRisk\": \"High Risk\",\n  \"pd.recentHistory\": \"Recent Activity (7 days)\",\n  \"pd.noRecentHistory\": \"No recent activity\",\n  \"pd.approvedOnce\": \"Approved once\",\n  \"pd.approvedBot\": \"Approved for bot\",\n  \"pd.approvedGlobal\": \"Approved globally\",\n  \"pd.requested\": \"Requested\",\n  \"pd.denied\": \"Denied\",\n  \"pd.changed\": \"Changed\",\n  \"pd.reset\": \"Reset\",\n  \"pd.resetToGlobal\": \"Reset to global\",\n  \"pd.viewAll\": \"View all\",\n  \"pd.localOnly\": \"Local Only\",\n  \"pd.webHidden\": \"Desktop-only permissions are hidden on web\",\n  \"pd.egressWebNote\": \"Full content sharing is available only on desktop\",\n\n  \"approval.title\": \"Permission Required\",\n  \"approval.why\": \"Why is this needed?\",\n  \"approval.impact\": \"What happens if approved\",\n  \"approval.risk\": \"Potential risk\",\n  \"approval.scope\": \"Approval scope\",\n  \"approval.scopeOnce\": \"Just this once\",\n  \"approval.scopeBot\": \"Always allow for this bot\",\n  \"approval.scopeGlobal\": \"Allow globally (all bots)\",\n  \"approval.approve\": \"Approve\",\n  \"approval.deny\": \"Deny\",\n  \"approval.approved\": \"Permission approved\",\n  \"approval.denied\": \"Request denied\",\n  \"approval.youAreInControl\": \"You are in control. You can change this anytime in Settings.\",\n\n  \"pi.title\": \"Permission Intelligence\",\n  \"pi.subtitle\": \"AI activity monitoring and risk management\",\n  \"pi.riskOverview\": \"Risk Overview\",\n  \"pi.riskScore\": \"Risk Score\",\n  \"pi.riskLevel.low\": \"Low Risk\",\n  \"pi.riskLevel.moderate\": \"Moderate\",\n  \"pi.riskLevel.elevated\": \"Elevated\",\n  \"pi.riskLevel.high\": \"High Risk\",\n  \"pi.denials7d\": \"Denials (7d)\",\n  \"pi.events7d\": \"Events (7d)\",\n  \"pi.noRiskData\": \"Create bots to see risk scores\",\n  \"pi.timeline\": \"Activity Timeline\",\n  \"pi.timelineSub\": \"Permission events over the last 7 days\",\n  \"pi.denied\": \"Denied\",\n  \"pi.approved\": \"Approved\",\n  \"pi.changed\": \"Changed\",\n  \"pi.requested\": \"Requested\",\n  \"pi.noActivity\": \"No permission activity in this period\",\n  \"pi.totalEvents\": \"Total Events\",\n  \"pi.peakDay\": \"Peak Day\",\n  \"pi.auditSearch\": \"Search events...\",\n  \"pi.filterEventType\": \"Event Type\",\n  \"pi.filterPermKey\": \"Permission\",\n  \"pi.filterDateRange\": \"Date Range\",\n  \"pi.allEvents\": \"All Events\",\n  \"pi.allPermissions\": \"All Permissions\",\n  \"pi.last7days\": \"Last 7 Days\",\n  \"pi.last30days\": \"Last 30 Days\",\n  \"pi.last90days\": \"Last 90 Days\",\n  \"pi.showingResults\": \"Showing {{count}} events\",\n\n  \"dashboard.dailyReliability\": \"Daily Reliability\",\n  \"dashboard.lastRun\": \"Last Run\",\n  \"dashboard.noRuns\": \"No runs yet\",\n  \"dashboard.successRate7d\": \"7d Success\",\n  \"dashboard.avgTime\": \"Avg Time\",\n  \"dashboard.lastIssue\": \"Last Issue\",\n  \"dashboard.noIssues\": \"none\",\n\n  \"reports.stallNotice\": \"Taking longer than expected\",\n  \"reports.stallDesc\": \"Your report is still being generated. Please wait...\",\n  \"reports.fastDelivered\": \"Fast briefing delivered\",\n  \"reports.fullInBackground\": \"Full analysis will continue in background.\",\n  \"reports.timeoutMessage\": \"Fast briefing delivered. Full analysis will continue in background.\",\n\n  \"memory.title\": \"Memory\",\n  \"memory.subtitle\": \"Rules and preferences for this bot\",\n  \"memory.globalSubtitle\": \"Global rules and preferences\",\n  \"memory.empty\": \"No rules saved yet\",\n  \"memory.emptyHint\": \"Add rules to customize how this bot generates reports\",\n  \"memory.addRule\": \"Add Rule\",\n  \"memory.editRule\": \"Edit Rule\",\n  \"memory.deleteRule\": \"Delete Rule\",\n  \"memory.deleteConfirm\": \"Are you sure you want to delete this rule?\",\n  \"memory.scope.global\": \"Global\",\n  \"memory.scope.bot\": \"Bot\",\n  \"memory.key\": \"Rule Key\",\n  \"memory.value\": \"Rule Value\",\n  \"memory.keyPlaceholder\": \"e.g., REPORT_TONE, SUMMARY_LENGTH\",\n  \"memory.valuePlaceholder\": \"Enter the rule value...\",\n  \"memory.saved\": \"Rule saved\",\n  \"memory.deleted\": \"Rule deleted\",\n  \"memory.saveFailed\": \"Failed to save rule\",\n  \"memory.deleteFailed\": \"Failed to delete rule\",\n  \"memory.globalLabel\": \"Applies to all bots\",\n  \"memory.botLabel\": \"Applies to this bot only\",\n  \"memory.effectiveRules\": \"Effective Rules\",\n  \"memory.effectiveHint\": \"Combined rules (global + bot overrides)\",\n  \"memory.presetKeys.REPORT_TONE\": \"Report Tone\",\n  \"memory.presetKeys.SUMMARY_LENGTH\": \"Summary Length\",\n  \"memory.presetKeys.LANGUAGE_PREF\": \"Language Preference\",\n  \"memory.presetKeys.EXCLUDE_KEYWORDS\": \"Exclude Keywords\",\n  \"memory.presetKeys.FOCUS_TOPICS\": \"Focus Topics\",\n  \"memory.presetKeys.CUSTOM\": \"Custom Rule\",\n  \"memory.ruleCount\": \"{{count}} rules\",\n};\n","path":null,"size_bytes":50245,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"server/routes.ts":{"content":"import type { Express, Request, Response, NextFunction } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { db, driver } from \"./db\";\nimport { jobRuns } from \"@shared/schema\";\nimport { and, eq, desc, gte, inArray } from \"drizzle-orm\";\nimport { collectFromSource, collectAllSources } from \"./services/rss\";\nimport { startScheduler, stopScheduler, getSchedulerStatus, runCollectNow, runAnalyzeNow, runDraftNow, runDailyBriefNow, runReportNow } from \"./jobs/scheduler\";\nimport { parseCommand } from \"./chat/command-parser\";\nimport { routeCommand, execPipelineRun } from \"./chat/commandRouter\";\nimport { setupAuth, registerAuthRoutes, isAuthenticated } from \"./replit_integrations/auth\";\nimport { runAllSeeds } from \"./seed\";\nimport { NotImplementedError, handleApiError } from \"./lib/safe-storage\";\nimport { PERMISSION_REQUEST_MESSAGES } from \"@shared/permission-messages\";\nimport { encrypt, decrypt } from \"./lib/crypto\";\nimport { setUserHasProviders } from \"./llm/client\";\nimport { registerTelegramWebhook, setupTelegramWebhook } from \"./adapters/telegram\";\n\nfunction getUserId(req: Request): string | undefined {\n  const user = req.user as any;\n  return user?.claims?.sub;\n}\n\nconst oneTimeApprovals = new Map<string, number>();\n\nfunction getOneTimeKey(userId: string, permissionKey: string): string {\n  return `${userId}:${permissionKey}`;\n}\n\nfunction hasOneTimeApproval(userId: string, permissionKey: string): boolean {\n  const key = getOneTimeKey(userId, permissionKey);\n  const expiry = oneTimeApprovals.get(key);\n  if (!expiry) return false;\n  if (Date.now() > expiry) {\n    oneTimeApprovals.delete(key);\n    return false;\n  }\n  oneTimeApprovals.delete(key);\n  return true;\n}\n\nfunction grantOneTimeApproval(userId: string, permissionKey: string): void {\n  const key = getOneTimeKey(userId, permissionKey);\n  oneTimeApprovals.set(key, Date.now() + 60_000);\n}\n\nasync function enforcePermission(\n  req: Request,\n  res: Response,\n  permissionKey: string,\n  action: string,\n  botId?: number | null,\n): Promise<boolean> {\n  const userId = getUserId(req);\n  if (!userId) {\n    res.status(401).json({ error: \"Unauthorized\" });\n    return false;\n  }\n  const { checkPermission, logPermissionAction } = await import(\"./policy/engine\");\n  const ctx = { userId, botId };\n  const perm = await checkPermission(ctx, permissionKey as any);\n\n  if (perm.allowed) return true;\n\n  if (perm.requiresApproval && hasOneTimeApproval(userId, permissionKey)) {\n    return true;\n  }\n\n  if (perm.requiresApproval) {\n    const msg = PERMISSION_REQUEST_MESSAGES[permissionKey];\n    await logPermissionAction(ctx, \"APPROVAL_REQUESTED\", permissionKey, { action });\n    res.status(403).json({\n      error: perm.reason,\n      requiresApproval: true,\n      permissionKey,\n      action,\n      botId: botId ?? null,\n      message: msg || null,\n    });\n    return false;\n  }\n\n  await logPermissionAction(ctx, \"PERMISSION_DENIED\", permissionKey, { action });\n  res.status(403).json({ error: perm.reason, requiresApproval: false });\n  return false;\n}\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  \n  // Run seeds on startup\n  await runAllSeeds();\n\n  // Initialize BYO LLM provider status at startup (for desktop single-user mode)\n  try {\n    const allProviders = await storage.listAllLlmProviders?.() ?? [];\n    if (allProviders.length > 0) {\n      setUserHasProviders(true);\n      console.log(`[Init] Found ${allProviders.length} BYO LLM provider(s), marking LLM available`);\n    }\n  } catch {\n    // listAllLlmProviders may not exist - fall back to lazy detection\n  }\n\n  app.get(\"/api/health\", (_req, res) => {\n    res.json({ ok: true, status: \"ok\", timestamp: new Date().toISOString(), driver });\n  });\n\n  await setupAuth(app);\n  registerAuthRoutes(app);\n  \n  // All API routes below require authentication\n  app.get(\"/api/stats\", isAuthenticated, async (req, res) => {\n    try {\n      const stats = await storage.getStats();\n      res.json(stats);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get stats\");\n    }\n  });\n\n  app.get(\"/api/items/recent\", isAuthenticated, async (req, res) => {\n    try {\n      const items = await storage.getRecentItems(10);\n      res.json(items);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get recent items\");\n    }\n  });\n\n  app.get(\"/api/items/observe\", isAuthenticated, async (req, res) => {\n    try {\n      const items = await storage.getObserveItems(50);\n      res.json(items);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get observe items\");\n    }\n  });\n\n  app.get(\"/api/items\", isAuthenticated, async (req, res) => {\n    try {\n      const status = req.query.status as string | undefined;\n      const items = await storage.getItems(status);\n      res.json(items);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get items\");\n    }\n  });\n\n  app.get(\"/api/items/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const item = await storage.getItem(id);\n      if (!item) {\n        return res.status(404).json({ error: \"Item not found\" });\n      }\n      res.json(item);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get item\");\n    }\n  });\n\n  app.post(\"/api/items/:id/skip\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.updateItemStatus(id, \"skipped\");\n      res.json({ success: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to skip item\");\n    }\n  });\n\n  app.post(\"/api/items/:id/reanalyze\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.updateItemStatus(id, \"new\");\n      res.json({ success: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to set for reanalysis\");\n    }\n  });\n\n  app.get(\"/api/sources\", isAuthenticated, async (req, res) => {\n    try {\n      const sources = await storage.getSources();\n      res.json(sources);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get sources\");\n    }\n  });\n\n  app.post(\"/api/sources\", isAuthenticated, async (req, res) => {\n    try {\n      if (!(await enforcePermission(req, res, \"SOURCE_WRITE\", \"create_source\"))) return;\n      const { name, url, type = \"rss\", topic = \"general\", trustLevel = \"medium\", region = \"global\" } = req.body;\n      if (!name || !url) {\n        return res.status(400).json({ error: \"Name and URL are required\" });\n      }\n      const source = await storage.createSource({ name, url, type, topic, trustLevel, region });\n      res.status(201).json(source);\n    } catch (error: any) {\n      if (error.code === \"23505\") {\n        return res.status(400).json({ error: \"A source with this URL already exists\" });\n      }\n      console.error(\"Error creating source:\", error);\n      res.status(500).json({ error: \"Failed to create source\" });\n    }\n  });\n\n  app.patch(\"/api/sources/:id\", isAuthenticated, async (req, res) => {\n    try {\n      if (!(await enforcePermission(req, res, \"SOURCE_WRITE\", \"update_source\"))) return;\n      const id = parseInt(req.params.id);\n      const source = await storage.updateSource(id, req.body);\n      if (!source) {\n        return res.status(404).json({ error: \"Source not found\" });\n      }\n      res.json(source);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to update source\");\n    }\n  });\n\n  app.delete(\"/api/sources/:id\", isAuthenticated, async (req, res) => {\n    try {\n      if (!(await enforcePermission(req, res, \"SOURCE_WRITE\", \"delete_source\"))) return;\n      const id = parseInt(req.params.id);\n      await storage.deleteSource(id);\n      res.status(204).send();\n    } catch (error) {\n      handleApiError(res, error, \"Failed to delete source\");\n    }\n  });\n\n  app.post(\"/api/sources/:id/collect\", isAuthenticated, async (req, res) => {\n    try {\n      if (!(await enforcePermission(req, res, \"WEB_RSS\", \"collect_source\"))) return;\n      const id = parseInt(req.params.id);\n      const source = await storage.getSource(id);\n      if (!source) {\n        return res.status(404).json({ error: \"Source not found\" });\n      }\n      const count = await collectFromSource(id, source.url, source.topic);\n      res.json({ collected: count });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to collect from source\");\n    }\n  });\n\n  app.get(\"/api/drafts\", isAuthenticated, async (req, res) => {\n    try {\n      const decision = req.query.decision as string | undefined;\n      const drafts = await storage.getDrafts(decision);\n      res.json(drafts);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get drafts\");\n    }\n  });\n\n  app.post(\"/api/drafts/:id/approve\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { finalText } = req.body;\n      await storage.updateDraftDecision(id, \"approved\", finalText);\n      res.json({ success: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to approve draft\");\n    }\n  });\n\n  app.post(\"/api/drafts/:id/reject\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.updateDraftDecision(id, \"rejected\");\n      res.json({ success: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to reject draft\");\n    }\n  });\n\n  app.get(\"/api/scheduler/status\", isAuthenticated, async (req, res) => {\n    try {\n      const status = getSchedulerStatus();\n      res.json(status);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get scheduler status\");\n    }\n  });\n\n  app.post(\"/api/scheduler/start\", isAuthenticated, async (req, res) => {\n    try {\n      startScheduler();\n      res.json({ success: true, isRunning: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to start scheduler\");\n    }\n  });\n\n  app.post(\"/api/scheduler/stop\", isAuthenticated, async (req, res) => {\n    try {\n      stopScheduler();\n      res.json({ success: true, isRunning: false });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to stop scheduler\");\n    }\n  });\n\n  app.post(\"/api/scheduler/run/collect\", isAuthenticated, async (req, res) => {\n    try {\n      const result = await runCollectNow();\n      res.json(result);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to run collect\");\n    }\n  });\n\n  app.post(\"/api/scheduler/run/analyze\", isAuthenticated, async (req, res) => {\n    try {\n      if (!(await enforcePermission(req, res, \"LLM_USE\", \"analyze\"))) return;\n      const userId = getUserId(req);\n      const { checkEgress, logPermissionAction } = await import(\"./policy/engine\");\n      const egress = await checkEgress({ userId }, \"FULL_CONTENT_ALLOWED\");\n      if (!egress.allowed) {\n        const msg = PERMISSION_REQUEST_MESSAGES[\"LLM_EGRESS_LEVEL\"];\n        await logPermissionAction({ userId }, \"APPROVAL_REQUESTED\", \"LLM_EGRESS_LEVEL\", { action: \"analyze\", requiredLevel: \"FULL_CONTENT_ALLOWED\", effectiveLevel: egress.effectiveLevel });\n        return res.status(403).json({\n          error: egress.reason,\n          requiresApproval: true,\n          permissionKey: \"LLM_EGRESS_LEVEL\",\n          action: \"analyze\",\n          message: msg || null,\n        });\n      }\n      const count = await runAnalyzeNow();\n      res.json({ analyzed: count });\n    } catch (error: any) {\n      console.error(\"Error running analyze:\", error);\n      const msg = error?.message?.includes(\"LLM_API_KEY\")\n        ? \"AI key not configured. Please add an AI Provider in Settings.\"\n        : \"Analysis failed. Please try again later.\";\n      res.status(500).json({ error: msg });\n    }\n  });\n\n  app.post(\"/api/scheduler/run/draft\", isAuthenticated, async (req, res) => {\n    try {\n      const count = await runDraftNow();\n      res.json({ drafted: count });\n    } catch (error: any) {\n      console.error(\"Error running draft:\", error);\n      const msg = error?.message?.includes(\"LLM_API_KEY\")\n        ? \"AI key not configured. Please add an AI Provider in Settings.\"\n        : \"Draft generation failed. Please try again later.\";\n      res.status(500).json({ error: msg });\n    }\n  });\n\n  app.get(\"/api/reports\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = (req as any).user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n\n      const profileIdParam = req.query.profileId;\n      const fromParam = req.query.from;\n      const toParam = req.query.to;\n\n      const from = fromParam ? new Date(fromParam as string) : undefined;\n      const to = toParam ? new Date(toParam as string) : undefined;\n\n      if (profileIdParam) {\n        const profileId = parseInt(profileIdParam as string);\n        \n        const profile = await storage.getProfile(profileId, userId);\n        if (!profile) {\n          return res.status(404).json({ error: \"Profile not found\" });\n        }\n\n        const outputs = await storage.listOutputs({ userId, profileId, from, to });\n        return res.json(outputs);\n      }\n\n      const outputs = await storage.listOutputs({ userId, from, to });\n      res.json(outputs);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get reports\");\n    }\n  });\n\n  app.get(\"/api/reports/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = (req as any).user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ error: \"Unauthorized\" });\n      }\n\n      const outputId = parseInt(req.params.id);\n      const output = await storage.getOutputById({ userId, outputId });\n      \n      if (!output) {\n        return res.status(404).json({ error: \"Report not found\" });\n      }\n\n      res.json(output);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get report\");\n    }\n  });\n\n  app.post(\"/api/debug/generate-daily-brief\", isAuthenticated, async (req, res) => {\n    try {\n      const topic = req.body?.topic || \"general\";\n      const result = await runDailyBriefNow(topic);\n      res.json({ ok: true, reportId: result.id, itemsCount: result.itemsCount, topic });\n    } catch (error: any) {\n      console.error(\"Error generating daily brief:\", error);\n      const msg = error?.message?.includes(\"LLM_API_KEY\")\n        ? \"AI key not configured. Please add an AI Provider in Settings.\"\n        : `Daily brief generation failed: ${error?.message ?? \"Unknown error\"}`;\n      res.status(500).json({ ok: false, error: msg });\n    }\n  });\n\n  app.post(\"/api/reports/generate\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = (req as any).user?.claims?.sub;\n      if (!userId) {\n        return res.status(401).json({ ok: false, error: \"Unauthorized\" });\n      }\n\n      let profileId = req.body?.profileId ? parseInt(req.body.profileId) : undefined;\n      const botId = req.body?.botId ? parseInt(req.body.botId) : undefined;\n\n      if (!profileId && botId) {\n        const bot = await storage.getBot(botId, userId);\n        if (!bot) {\n          return res.status(404).json({ ok: false, error: \"Bot not found\" });\n        }\n        let profile = await storage.getProfileByUserAndTopic(userId, bot.key);\n        if (!profile) {\n          const allPresets = await storage.listPresets();\n          const reportPresets = allPresets.filter(p => p.outputType === \"report\");\n          const matchingPreset = reportPresets.find(p => {\n            const variants = (p.variantsJson as string[]) || [];\n            return variants.includes(bot.key) || p.key === bot.key;\n          }) || reportPresets[0];\n\n          if (!matchingPreset) {\n            return res.status(400).json({ ok: false, error: \"No report template found.\" });\n          }\n\n          const settings = bot.settings;\n          const scheduleCron = settings\n            ? `${settings.scheduleTimeLocal?.split(\":\")[1] || \"0\"} ${settings.scheduleTimeLocal?.split(\":\")[0] || \"7\"} * * ${settings.scheduleRule === \"WEEKDAYS\" ? \"1-5\" : settings.scheduleRule === \"WEEKENDS\" ? \"0,6\" : \"*\"}`\n            : \"0 7 * * *\";\n\n          profile = await storage.createProfile({\n            userId,\n            presetId: matchingPreset.id,\n            name: bot.name,\n            topic: bot.key,\n            timezone: settings?.timezone || \"Asia/Seoul\",\n            scheduleCron,\n            configJson: {\n              sections: settings?.sectionsJson || { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n              filters: settings?.filtersJson || { minImportanceScore: 0 },\n              verbosity: settings?.verbosity || \"normal\",\n              markdownLevel: settings?.markdownLevel || \"minimal\",\n              scheduleRule: settings?.scheduleRule || \"DAILY\",\n              scheduleTimeLocal: settings?.scheduleTimeLocal || \"07:00\",\n            },\n            isActive: bot.isEnabled,\n          });\n\n          const botSources = await storage.getBotSources(botId);\n          if (botSources.length === 0) {\n            await storage.deleteProfile(profile.id, userId);\n            return res.status(400).json({ ok: false, error: \"This bot has no sources. Please add sources first from the Sources page or using the Console.\" });\n          }\n          await storage.setProfileSources(\n            profile.id,\n            userId,\n            botSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }))\n          );\n        }\n        profileId = profile.id;\n      }\n      \n      if (!profileId) {\n        return res.status(400).json({ ok: false, error: \"profileId or botId is required\" });\n      }\n\n      const profile = await storage.getProfile(profileId, userId);\n      if (!profile) {\n        return res.status(404).json({ ok: false, error: \"Profile not found\" });\n      }\n\n      const SERVER_TIMEOUT_MS = 25000;\n      const resultPromise = runReportNow(profileId, userId);\n      const timeoutPromise = new Promise<null>((resolve) =>\n        setTimeout(() => resolve(null), SERVER_TIMEOUT_MS)\n      );\n\n      const result = await Promise.race([resultPromise, timeoutPromise]);\n\n      if (result === null) {\n        res.json({\n          ok: true,\n          result: { timedOut: true },\n          message: \"Fast briefing delivered. Full analysis will continue in background.\",\n        });\n      } else {\n        res.json({ ok: true, result });\n      }\n    } catch (error: any) {\n      console.error(\"Error generating report:\", error);\n      let msg = error?.message ?? \"Unknown error\";\n      if (msg.includes(\"LLM_API_KEY\")) {\n        msg = \"AI key not configured. Please add an AI Provider in Settings.\";\n      } else if (msg.includes(\"No sources linked\")) {\n        msg = \"This bot has no sources linked. Please add sources first from the Sources page.\";\n      }\n      const statusCode = msg.includes(\"sources\") || msg.includes(\"AI key\") ? 400 : 500;\n      res.status(statusCode).json({ ok: false, error: msg });\n    }\n  });\n\n  app.get(\"/api/console/context\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n\n      const threadIdParam = req.query.threadId as string | undefined;\n      const bots = await storage.listBots(userId);\n\n      let activeBotId: number | null = null;\n      let activeBotName: string | null = null;\n      let activeBotTopic: string | null = null;\n      let sourceCount = 0;\n      let lastCollectedAt: string | null = null;\n      let scheduleRule: string | null = null;\n      let scheduleTimeLocal: string | null = null;\n      let isEnabled = false;\n      let hasLlmProvider = false;\n\n      if (threadIdParam) {\n        const thread = await storage.getThread(Number(threadIdParam), userId);\n        if (thread?.activeBotId) {\n          activeBotId = thread.activeBotId;\n        }\n      }\n\n      if (!activeBotId && bots.length > 0) {\n        activeBotId = bots[0].id;\n      }\n\n      if (activeBotId) {\n        const bot = bots.find(b => b.id === activeBotId);\n        if (bot) {\n          activeBotName = bot.name;\n          activeBotTopic = bot.key;\n          isEnabled = bot.isEnabled;\n          if (bot.settings) {\n            scheduleRule = bot.settings.scheduleRule || null;\n            scheduleTimeLocal = bot.settings.scheduleTimeLocal || null;\n          }\n          const sources = await storage.getBotSources(bot.id);\n          sourceCount = sources.filter(s => s.isEnabled).length;\n\n          const botLlm = await storage.resolveLLMForBot(bot.id);\n          hasLlmProvider = !!botLlm || !!(process.env.LLM_API_KEY);\n        }\n      }\n\n      const stats = await storage.getStats();\n      lastCollectedAt = stats.lastCollectAt;\n\n      const providers = await storage.listLlmProviders(userId);\n      const userHasProviders = providers.length > 0;\n      setUserHasProviders(userHasProviders);\n\n      res.json({\n        botCount: bots.length,\n        activeBotId,\n        activeBotName,\n        activeBotTopic,\n        sourceCount,\n        lastCollectedAt,\n        scheduleRule,\n        scheduleTimeLocal,\n        isEnabled,\n        hasLlmProvider: hasLlmProvider || userHasProviders,\n        hasUserProviders: userHasProviders,\n      });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get console context\");\n    }\n  });\n\n  app.post(\"/api/chat/threads\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      const thread = await storage.createThread(userId);\n      res.json(thread);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to create thread\");\n    }\n  });\n\n  app.get(\"/api/chat/threads\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      const threads = await storage.getUserThreads(userId);\n      res.json(threads);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to list threads\");\n    }\n  });\n\n  app.get(\"/api/chat/threads/:threadId/messages\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      const threadId = parseInt(req.params.threadId, 10);\n      if (isNaN(threadId)) return res.status(400).json({ error: \"Invalid threadId\" });\n\n      const thread = await storage.getThread(threadId, userId);\n      if (!thread) return res.status(404).json({ error: \"Thread not found\" });\n\n      const messages = await storage.listThreadMessages(threadId, userId, 100);\n      res.json(messages.reverse());\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get thread messages\");\n    }\n  });\n\n  app.post(\"/api/chat/threads/:threadId/message\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      const threadId = parseInt(req.params.threadId, 10);\n      if (isNaN(threadId)) return res.status(400).json({ error: \"Invalid threadId\" });\n\n      const thread = await storage.getThread(threadId, userId);\n      if (!thread) return res.status(404).json({ error: \"Thread not found\" });\n\n      const { text } = req.body;\n      if (!text || typeof text !== \"string\") {\n        return res.status(400).json({ error: \"text is required\" });\n      }\n\n      await storage.addThreadMessage({\n        threadId,\n        userId,\n        role: \"user\",\n        contentText: text,\n        kind: \"text\",\n      });\n\n      const userBots = await storage.listBots(userId);\n      let activeBotKey: string | null = null;\n      if (thread.activeBotId) {\n        const activeBot = userBots.find(b => b.id === thread.activeBotId);\n        activeBotKey = activeBot?.key || null;\n      }\n\n      const parseResult = await parseCommand(text, {\n        activeBotKey,\n        availableBotKeys: userBots.map(b => b.key),\n      });\n\n      const { command, clarificationNeeded, clarificationText } = parseResult;\n\n      if (clarificationNeeded) {\n        await storage.addThreadMessage({\n          threadId,\n          userId,\n          role: \"assistant\",\n          contentText: clarificationText || \"Could you be more specific?\",\n          kind: \"text\",\n        });\n        return res.json({ ok: true, mode: \"clarification\", clarificationText });\n      }\n\n      if (command.needsConfirm && command.type !== \"chat\") {\n        const confirmMsg = await storage.addThreadMessage({\n          threadId,\n          userId,\n          role: \"assistant\",\n          contentText: command.confirmText || `Run '${command.type}'?`,\n          kind: \"pending_command\",\n          commandJson: command,\n          status: \"pending_confirm\",\n        });\n        return res.json({\n          ok: true,\n          mode: \"confirm\",\n          pendingMessageId: confirmMsg.id,\n          command,\n          confirmText: command.confirmText,\n        });\n      }\n\n      const result = await routeCommand(userId, command, threadId);\n\n      await storage.addThreadMessage({\n        threadId,\n        userId,\n        role: \"assistant\",\n        contentText: result.assistantMessage,\n        kind: \"command_result\",\n        commandJson: result.executed,\n        resultJson: result.result,\n      });\n\n      res.json({ ok: result.ok, mode: \"executed\", result });\n    } catch (error: any) {\n      console.error(\"Error processing chat message:\", error);\n      res.status(500).json({ ok: false, error: error?.message ?? String(error) });\n    }\n  });\n\n  app.post(\"/api/chat/threads/:threadId/confirm\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      const threadId = parseInt(req.params.threadId, 10);\n      if (isNaN(threadId)) return res.status(400).json({ error: \"Invalid threadId\" });\n\n      const thread = await storage.getThread(threadId, userId);\n      if (!thread) return res.status(404).json({ error: \"Thread not found\" });\n\n      const { pendingMessageId, approve } = req.body;\n      if (!pendingMessageId) return res.status(400).json({ error: \"pendingMessageId is required\" });\n\n      const messages = await storage.listThreadMessages(threadId, userId, 200);\n      const pendingMsg = messages.find(m => m.id === pendingMessageId && m.status === \"pending_confirm\");\n\n      if (!pendingMsg) {\n        return res.status(404).json({ error: \"Pending confirmation not found or already resolved\" });\n      }\n\n      await storage.updateChatMessageStatus(pendingMessageId, userId, approve ? \"confirmed\" : \"cancelled\");\n\n      if (!approve) {\n        await storage.addThreadMessage({\n          threadId,\n          userId,\n          role: \"assistant\",\n          contentText: \"Cancelled.\",\n          kind: \"text\",\n        });\n        return res.json({ ok: true, cancelled: true });\n      }\n\n      const command = pendingMsg.commandJson as any;\n\n      if (command.type === \"pipeline_run\") {\n        res.json({ ok: true, mode: \"pipeline_started\" });\n\n        const result = await execPipelineRun(userId, command, async (step) => {\n          await storage.addThreadMessage({\n            threadId,\n            userId,\n            role: \"assistant\",\n            contentText: step.message,\n            kind: \"command_result\",\n            commandJson: { type: \"pipeline_step\", step: step.step },\n            resultJson: { ok: step.ok, data: step.data },\n          });\n        });\n\n        await storage.addThreadMessage({\n          threadId,\n          userId,\n          role: \"assistant\",\n          contentText: result.assistantMessage,\n          kind: \"command_result\",\n          commandJson: result.executed,\n          resultJson: result.result,\n        });\n\n        await storage.clearPendingCommand(pendingMessageId, userId);\n        return;\n      }\n\n      const result = await routeCommand(userId, command, threadId);\n\n      await storage.addThreadMessage({\n        threadId,\n        userId,\n        role: \"assistant\",\n        contentText: result.assistantMessage,\n        kind: \"command_result\",\n        commandJson: result.executed,\n        resultJson: result.result,\n      });\n\n      await storage.clearPendingCommand(pendingMessageId, userId);\n\n      res.json({ ok: result.ok, result });\n    } catch (error: any) {\n      console.error(\"Error confirming chat command:\", error);\n      res.status(500).json({ ok: false, error: error?.message ?? String(error) });\n    }\n  });\n\n  // ============================================\n  // PRESETS API\n  // ============================================\n  app.get(\"/api/presets\", isAuthenticated, async (_req, res) => {\n    try {\n      const presetList = await storage.listPresets();\n      res.json(presetList);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get presets\");\n    }\n  });\n\n  // ============================================\n  // PROFILES API\n  // ============================================\n  app.get(\"/api/profiles\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const profileList = await storage.listProfiles(userId);\n      res.json(profileList);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get profiles\");\n    }\n  });\n\n  app.post(\"/api/profiles\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { presetId, name, topic, variantKey, timezone, scheduleCron, configJson, isActive } = req.body;\n      \n      if (!presetId || !name || !topic) {\n        return res.status(400).json({ error: \"presetId, name, and topic are required\" });\n      }\n\n      const profile = await storage.createProfile({\n        userId,\n        presetId,\n        name,\n        topic,\n        variantKey: variantKey || null,\n        timezone: timezone || \"Asia/Seoul\",\n        scheduleCron: scheduleCron || \"0 7 * * *\",\n        configJson: configJson || {},\n        isActive: isActive ?? true,\n      });\n      res.json(profile);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to create profile\");\n    }\n  });\n\n  app.get(\"/api/profiles/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const id = parseInt(req.params.id);\n      const profile = await storage.getProfile(id, userId);\n      \n      if (!profile) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n      \n      res.json(profile);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get profile\");\n    }\n  });\n\n  app.put(\"/api/profiles/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const id = parseInt(req.params.id);\n      const { name, isActive, timezone, scheduleCron, configJson } = req.body;\n      \n      const profile = await storage.updateProfile(id, userId, {\n        name,\n        isActive,\n        timezone,\n        scheduleCron,\n        configJson,\n      });\n      \n      if (!profile) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n      \n      res.json(profile);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to update profile\");\n    }\n  });\n\n  app.delete(\"/api/profiles/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const id = parseInt(req.params.id);\n      await storage.deleteProfile(id, userId);\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to delete profile\");\n    }\n  });\n\n  app.post(\"/api/profiles/:id/clone\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const id = parseInt(req.params.id);\n      const cloned = await storage.cloneProfile(id, userId);\n      \n      if (!cloned) {\n        return res.status(404).json({ error: \"Profile not found\" });\n      }\n      \n      res.json(cloned);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to clone profile\");\n    }\n  });\n\n  // ============================================\n  // PROFILE-SOURCES API\n  // ============================================\n  app.get(\"/api/profiles/:id/sources\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const profileId = parseInt(req.params.id);\n      const sources = await storage.getProfileSources(profileId, userId);\n      res.json(sources);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get profile sources\");\n    }\n  });\n\n  app.put(\"/api/profiles/:id/sources\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const profileId = parseInt(req.params.id);\n      const { sourceIds, sources: sourcesWithWeight } = req.body;\n      \n      // Support both formats: simple sourceIds array or sources with weight\n      let sourceData: Array<{ sourceId: number; weight?: number; isEnabled?: boolean }>;\n      \n      if (sourcesWithWeight && Array.isArray(sourcesWithWeight)) {\n        // New format: [{ sourceId, weight, isEnabled }]\n        sourceData = sourcesWithWeight;\n      } else if (sourceIds && Array.isArray(sourceIds)) {\n        // Legacy format: [1, 2, 3] - convert to new format with default weight\n        sourceData = sourceIds.map((id: number) => ({ sourceId: id }));\n      } else {\n        return res.status(400).json({ error: \"sourceIds or sources must be an array\" });\n      }\n      \n      await storage.setProfileSources(profileId, userId, sourceData);\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to set profile sources\");\n    }\n  });\n\n  // ============================================\n  // BOTS API (Step 8-2)\n  // ============================================\n\n  app.get(\"/api/bots\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botList = await storage.listBots(userId);\n      res.json({ bots: botList });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to list bots\");\n    }\n  });\n\n  app.post(\"/api/bots/from-preset\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n\n      const { presetId, name, topic, selectedSourceUrls, customSources } = req.body;\n      if (!presetId || !name || !topic) {\n        return res.status(400).json({ error: \"presetId, name, and topic are required.\" });\n      }\n\n      const preset = await storage.getPresetById(presetId);\n      if (!preset) return res.status(404).json({ error: \"Preset not found.\" });\n\n      const config = (preset.defaultConfigJson || {}) as any;\n\n      const validSourceUrls = Array.isArray(selectedSourceUrls) ? selectedSourceUrls : [];\n      const sourceData = validSourceUrls\n        .map((url: string) => config.suggestedSources?.find((s: any) => s.url === url))\n        .filter(Boolean)\n        .map((s: any) => ({ name: s.name, url: s.url, type: s.type || \"rss\", topic: s.topic || topic }));\n\n      if (Array.isArray(customSources)) {\n        for (const cs of customSources) {\n          if (cs.url && !sourceData.some((s: any) => s.url === cs.url)) {\n            try {\n              new URL(cs.url);\n              sourceData.push({ name: cs.name || new URL(cs.url).hostname, url: cs.url, type: \"rss\", topic: cs.topic || topic });\n            } catch {}\n          }\n        }\n      }\n\n      const botTimezone = config.timezone || \"Asia/Seoul\";\n      const botScheduleRule = config.scheduleRule || \"DAILY\";\n      const botScheduleTime = config.scheduleTimeLocal || \"07:00\";\n      const botFilters = {\n        ...(config.filters || { minImportanceScore: 0 }),\n        ...(config.requireHumanApproval !== undefined && { requireHumanApproval: config.requireHumanApproval }),\n        ...(config.promotionLevel && { promotionLevel: config.promotionLevel }),\n        ...(config.linkPolicy && { linkPolicy: config.linkPolicy }),\n      };\n\n      const bot = await storage.createBotFromPreset({\n        userId,\n        key: topic,\n        name: String(name).trim(),\n        settings: {\n          timezone: botTimezone,\n          scheduleRule: botScheduleRule,\n          scheduleTimeLocal: botScheduleTime,\n          format: \"clean\",\n          markdownLevel: config.markdownLevel || \"minimal\",\n          verbosity: config.verbosity || \"normal\",\n          sectionsJson: config.sections || { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n          filtersJson: botFilters,\n        },\n        sourceData,\n      });\n\n      const timeParts = botScheduleTime.split(\":\");\n      const cronMinute = timeParts[1] || \"0\";\n      const cronHour = timeParts[0] || \"7\";\n      const cronDow = botScheduleRule === \"WEEKDAYS\" ? \"1-5\" : botScheduleRule === \"WEEKENDS\" ? \"0,6\" : \"*\";\n      const scheduleCron = `${cronMinute} ${cronHour} * * ${cronDow}`;\n\n      const newProfile = await storage.createProfile({\n        userId,\n        presetId,\n        name: String(name).trim(),\n        topic,\n        timezone: botTimezone,\n        scheduleCron,\n        configJson: {\n          sections: config.sections || {},\n          filters: botFilters,\n          verbosity: config.verbosity || \"normal\",\n          markdownLevel: config.markdownLevel || \"minimal\",\n        },\n        isActive: true,\n      });\n\n      const botSources = await storage.getBotSources(bot.id);\n      if (botSources.length > 0) {\n        await storage.setProfileSources(\n          newProfile.id,\n          userId,\n          botSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }))\n        );\n      }\n\n      const full = await storage.getBot(bot.id, userId);\n      res.json({ bot: full });\n    } catch (error: any) {\n      if (error?.code === '23505') {\n        return res.status(409).json({ error: \"A bot with this topic already exists. Please choose a different topic.\" });\n      }\n      const msg = error?.message || String(error);\n      console.error(\"Error creating bot from preset:\", msg, error?.stack);\n      if (error?.code === 'SQLITE_CONSTRAINT_UNIQUE' || msg.includes('UNIQUE constraint')) {\n        return res.status(409).json({ error: \"A bot with this topic already exists. Please choose a different topic.\" });\n      }\n      res.status(500).json({ error: `Bot creation failed: ${msg}` });\n    }\n  });\n\n  app.post(\"/api/bots\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const { name, key, description } = req.body;\n      if (!name || !key) return res.status(400).json({ error: \"name and key are required\" });\n\n      const bot = await storage.createBot({ userId, key, name, isEnabled: true });\n      await storage.createBotSettings({ botId: bot.id } as any);\n      const full = await storage.getBot(bot.id, userId);\n      res.json({ bot: full });\n    } catch (error: any) {\n      if (error?.code === '23505') {\n        return res.status(409).json({ error: \"A bot with this key already exists\" });\n      }\n      console.error(\"Error creating bot:\", error);\n      res.status(500).json({ error: \"Failed to create bot\" });\n    }\n  });\n\n  app.get(\"/api/bots/:botId\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      const bot = await storage.getBot(botId, userId);\n      if (!bot) return res.status(404).json({ error: \"Bot not found\" });\n      res.json({ bot });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get bot\");\n    }\n  });\n\n  app.patch(\"/api/bots/:botId\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      const bot = await storage.updateBot(botId, userId, req.body);\n      if (!bot) return res.status(404).json({ error: \"Bot not found\" });\n      res.json({ bot });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to update bot\");\n    }\n  });\n\n  app.delete(\"/api/bots/:botId\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      await storage.deleteBot(botId, userId);\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to delete bot\");\n    }\n  });\n\n  // Bot Settings\n  app.get(\"/api/bots/:botId/settings\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      const bot = await storage.getBot(botId, userId);\n      if (!bot) return res.status(404).json({ error: \"Bot not found\" });\n\n      const settings = await storage.getBotSettings(botId);\n      res.json({ settings: settings ?? null });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get bot settings\");\n    }\n  });\n\n  app.put(\"/api/bots/:botId/settings\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      const settings = await storage.upsertBotSettings(userId, botId, req.body);\n      res.json({ settings });\n    } catch (error: any) {\n      if (error.message?.includes(\"not found\")) {\n        return res.status(404).json({ error: \"Bot not found.\" });\n      }\n      console.error(\"Error saving bot settings:\", error);\n      res.status(500).json({ error: \"Settings save failed. Please try again later.\" });\n    }\n  });\n\n  // Bot Sources\n  app.get(\"/api/bots/:botId/sources\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      const bot = await storage.getBot(botId, userId);\n      if (!bot) return res.status(404).json({ error: \"Bot not found\" });\n\n      const botSources = await storage.getBotSources(botId);\n      res.json({ links: botSources });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get bot sources\");\n    }\n  });\n\n  app.put(\"/api/bots/:botId/sources\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      const { links } = req.body;\n      if (!Array.isArray(links)) return res.status(400).json({ error: \"links must be an array\" });\n\n      await storage.setBotSources(botId, userId, links);\n      res.json({ ok: true });\n    } catch (error: any) {\n      if (error.message?.includes(\"not found\") || error.message?.includes(\"not accessible\")) {\n        return res.status(400).json({ error: error.message });\n      }\n      console.error(\"Error setting bot sources:\", error);\n      res.status(500).json({ error: \"Failed to set bot sources\" });\n    }\n  });\n\n  // ============================================\n  // LLM PROVIDERS API (Phase 3)\n  // ============================================\n  app.get(\"/api/llm-providers\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const providers = await storage.listLlmProviders(userId);\n      const safe = providers.map(p => ({ ...p, apiKeyEncrypted: undefined, apiKeyHint: p.apiKeyEncrypted ? \"****\" : \"\" }));\n      res.json({ providers: safe });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to list LLM providers\");\n    }\n  });\n\n  app.post(\"/api/llm-providers\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const { name, providerType, apiKey, baseUrl, defaultModel } = req.body;\n      if (!name || !providerType || !apiKey) {\n        return res.status(400).json({ error: \"name, providerType, and apiKey are required\" });\n      }\n      const validTypes = [\"openai\", \"anthropic\", \"google\", \"custom\"];\n      if (!validTypes.includes(providerType)) {\n        return res.status(400).json({ error: `providerType must be one of: ${validTypes.join(\", \")}` });\n      }\n\n      const { encrypt: enc } = await import(\"./lib/crypto\");\n      const encryptedKey = enc(apiKey);\n      const provider = await storage.createLlmProvider({\n        userId,\n        name,\n        providerType,\n        apiKeyEncrypted: encryptedKey,\n        baseUrl: baseUrl || null,\n        defaultModel: defaultModel || null,\n      });\n      setUserHasProviders(true);\n      res.json({ provider: { ...provider, apiKeyEncrypted: undefined, apiKeyHint: \"****\" } });\n    } catch (error: any) {\n      const msg = error?.message || String(error);\n      console.error(\"[llm-provider] Create error:\", msg, error?.stack);\n      res.status(500).json({ error: `Failed to create LLM provider: ${msg}` });\n    }\n  });\n\n  app.put(\"/api/llm-providers/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ error: \"Invalid provider id\" });\n\n      const { name, providerType, apiKey, baseUrl, defaultModel } = req.body;\n      const patch: Record<string, any> = {};\n      if (name !== undefined) patch.name = name;\n      if (providerType !== undefined) patch.providerType = providerType;\n      if (baseUrl !== undefined) patch.baseUrl = baseUrl;\n      if (defaultModel !== undefined) patch.defaultModel = defaultModel;\n      if (apiKey) {\n        patch.apiKeyEncrypted = encrypt(apiKey);\n      }\n\n      const provider = await storage.updateLlmProvider(id, userId, patch);\n      if (!provider) return res.status(404).json({ error: \"LLM provider not found\" });\n      res.json({ provider: { ...provider, apiKeyEncrypted: undefined, apiKeyHint: \"****\" } });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to update LLM provider\");\n    }\n  });\n\n  app.delete(\"/api/llm-providers/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ error: \"Invalid provider id\" });\n\n      await storage.deleteLlmProvider(id, userId);\n      const remaining = await storage.listLlmProviders(userId);\n      setUserHasProviders(remaining.length > 0);\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to delete LLM provider\");\n    }\n  });\n\n  // Bot LLM assignment\n  app.put(\"/api/bots/:botId/settings/llm\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n\n      const bot = await storage.getBot(botId, userId);\n      if (!bot) return res.status(404).json({ error: \"Bot not found\" });\n\n      const { llmProviderId, modelOverride } = req.body;\n\n      if (llmProviderId != null) {\n        const provider = await storage.getLlmProvider(llmProviderId, userId);\n        if (!provider) return res.status(400).json({ error: \"LLM provider not found or not yours\" });\n      }\n\n      const settings = await storage.upsertBotSettings(userId, botId, {\n        llmProviderId: llmProviderId ?? null,\n        modelOverride: modelOverride ?? null,\n      });\n      res.json({ settings });\n    } catch (error: any) {\n      if (error.message?.includes(\"not found\")) {\n        return res.status(404).json({ error: error.message });\n      }\n      console.error(\"Error setting bot LLM:\", error);\n      res.status(500).json({ error: \"Failed to set bot LLM\" });\n    }\n  });\n\n  // ============================================\n  // JOB RUNS / EXECUTION HISTORY API\n  // ============================================\n  app.get(\"/api/bots/:botId/runs\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n      const limit = Math.min(parseInt(req.query.limit as string) || 20, 100);\n      const runs = await storage.listJobRunsForBot(userId, botId, limit);\n      res.json(runs);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to list job runs\");\n    }\n  });\n\n  app.get(\"/api/bots/:botId/last-run\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n      const run = await storage.getLastJobRunForBot(userId, botId);\n      res.json(run || null);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get last run\");\n    }\n  });\n\n  app.get(\"/api/system/status\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const bots = await storage.listBots(userId);\n      const botStatuses = await Promise.all(\n        bots.map(async (bot) => {\n          const lastRun = await storage.getLastJobRunForBot(userId, bot.id);\n          return {\n            botId: bot.id,\n            botName: bot.name,\n            botKey: bot.key,\n            isEnabled: bot.isEnabled,\n            lastRun: lastRun ? {\n              id: lastRun.id,\n              status: lastRun.status,\n              jobType: lastRun.jobType,\n              trigger: lastRun.trigger,\n              startedAt: lastRun.startedAt,\n              finishedAt: lastRun.finishedAt,\n              durationMs: lastRun.durationMs,\n              itemsCollected: lastRun.itemsCollected,\n              errorCode: lastRun.errorCode,\n            } : null,\n          };\n        })\n      );\n      res.json({ bots: botStatuses, timestamp: new Date().toISOString() });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get system status\");\n    }\n  });\n\n  app.get(\"/api/bots/:botId/diagnosis\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const botId = parseInt(req.params.botId);\n      if (isNaN(botId)) return res.status(400).json({ error: \"Invalid botId\" });\n      const bot = await storage.getBot(botId, userId);\n      if (!bot) return res.status(404).json({ error: \"Bot not found\" });\n\n      const { diagnoseBot } = await import(\"./services/diagnostics\");\n      const diagnosis = await diagnoseBot(userId, bot);\n      res.json(diagnosis);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to diagnose bot\");\n    }\n  });\n\n  app.get(\"/api/diagnostics\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const bots = await storage.listBots(userId);\n      const { diagnoseBot } = await import(\"./services/diagnostics\");\n      const results = await Promise.all(\n        bots.map(async (bot) => ({\n          botId: bot.id,\n          botName: bot.name,\n          botKey: bot.key,\n          ...(await diagnoseBot(userId, bot)),\n        }))\n      );\n      res.json(results);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to run diagnostics\");\n    }\n  });\n\n  // ============================================\n  // DAILY LOOP RELIABILITY & TRENDS API\n  // ============================================\n  app.get(\"/api/diagnostics/daily-loop\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n\n      const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\n      const runs = await db.select().from(jobRuns)\n        .where(and(\n          eq(jobRuns.userId, userId),\n          gte(jobRuns.startedAt, sevenDaysAgo),\n          inArray(jobRuns.jobType, [\"report\", \"report_upgrade\", \"daily_brief\"]),\n        ))\n        .orderBy(desc(jobRuns.startedAt));\n\n      const fastRuns = runs.filter(r => r.reportStage === \"fast\" || r.jobType === \"report\" || r.jobType === \"daily_brief\");\n      const total = fastRuns.length;\n      const successes = fastRuns.filter(r => r.status === \"ok\" || r.status === \"success\").length;\n      const successRate7d = total > 0 ? Math.round((successes / total) * 100) : 100;\n\n      const durations = fastRuns.filter(r => r.durationMs != null && r.durationMs > 0).map(r => r.durationMs!);\n      const avgGenerationTimeMs = durations.length > 0 ? Math.round(durations.reduce((a, b) => a + b, 0) / durations.length) : 0;\n\n      const lastRun = runs[0];\n      const failedRuns = runs.filter(r => r.status === \"error\" || r.status === \"failed\" || r.status === \"timeout\");\n      const lastFailure = failedRuns[0];\n\n      res.json({\n        lastRunAt: lastRun?.startedAt || null,\n        successRate7d,\n        avgGenerationTimeMs,\n        lastFailureReason: lastFailure?.errorMessage || null,\n        totalRuns7d: total,\n      });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get daily loop diagnostics\");\n    }\n  });\n\n  app.get(\"/api/reports/:profileId/trends\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      const profileId = parseInt(req.params.profileId);\n      if (isNaN(profileId)) return res.status(400).json({ error: \"Invalid profileId\" });\n\n      const metrics = await storage.getReportMetricsForProfile(profileId, 7);\n\n      if (metrics.length < 2) {\n        return res.json({\n          trendingUp: [],\n          recurring: [],\n          sourceShift: {},\n          metrics,\n          insufficient: true,\n        });\n      }\n\n      const latest = metrics[0];\n      const previous = metrics.slice(1);\n\n      const latestKw = (latest.keywordSummary || {}) as Record<string, number>;\n      const prevKwAgg: Record<string, number[]> = {};\n      for (const m of previous) {\n        const kw = (m.keywordSummary || {}) as Record<string, number>;\n        for (const [k, v] of Object.entries(kw)) {\n          if (!prevKwAgg[k]) prevKwAgg[k] = [];\n          prevKwAgg[k].push(v);\n        }\n      }\n\n      const trendingUp: string[] = [];\n      const recurring: string[] = [];\n\n      for (const [kw, count] of Object.entries(latestKw)) {\n        const prev = prevKwAgg[kw];\n        if (prev && prev.length >= 1) {\n          const avg = prev.reduce((a, b) => a + b, 0) / prev.length;\n          if (count > avg * 1.2) trendingUp.push(kw);\n        }\n      }\n\n      const allKws: Record<string, number> = {};\n      for (const m of metrics) {\n        const kw = (m.keywordSummary || {}) as Record<string, number>;\n        for (const k of Object.keys(kw)) {\n          allKws[k] = (allKws[k] || 0) + 1;\n        }\n      }\n      for (const [kw, appearances] of Object.entries(allKws)) {\n        if (appearances >= Math.min(4, metrics.length)) {\n          recurring.push(kw);\n        }\n      }\n\n      const latestSrc = (latest.sourceDistribution || {}) as Record<string, number>;\n      const prevSrcAgg: Record<string, number[]> = {};\n      for (const m of previous) {\n        const src = (m.sourceDistribution || {}) as Record<string, number>;\n        for (const [k, v] of Object.entries(src)) {\n          if (!prevSrcAgg[k]) prevSrcAgg[k] = [];\n          prevSrcAgg[k].push(v);\n        }\n      }\n      const sourceShift: Record<string, boolean> = {};\n      for (const [src, count] of Object.entries(latestSrc)) {\n        const prev = prevSrcAgg[src];\n        if (prev && prev.length >= 1) {\n          const avg = prev.reduce((a, b) => a + b, 0) / prev.length;\n          sourceShift[`${src}Increase`] = count > avg * 1.15;\n        }\n      }\n\n      res.json({\n        trendingUp: trendingUp.slice(0, 5),\n        recurring: recurring.slice(0, 5),\n        sourceShift,\n        metrics,\n        insufficient: false,\n      });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get report trends\");\n    }\n  });\n\n  // ============================================\n  // SOURCES API (with userId support)\n  // ============================================\n  app.get(\"/api/user-sources\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const topic = req.query.topic as string | undefined;\n      const sourceList = await storage.listSources(userId, topic);\n      res.json(sourceList);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get sources\");\n    }\n  });\n\n  app.post(\"/api/user-sources\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const { name, url, type, topic, enabled } = req.body;\n      \n      if (!name || !url || !topic) {\n        return res.status(400).json({ error: \"name, url, and topic are required\" });\n      }\n\n      const source = await storage.createUserSource(userId, {\n        name,\n        url,\n        type: type || \"rss\",\n        topic,\n        enabled: enabled ?? true,\n      });\n      res.json(source);\n    } catch (error: any) {\n      console.error(\"Error creating source:\", error);\n      if (error.code === \"23505\") {\n        return res.status(400).json({ error: \"Source with this URL already exists\" });\n      }\n      res.status(500).json({ error: \"Failed to create source\" });\n    }\n  });\n\n  app.put(\"/api/user-sources/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const sourceId = parseInt(req.params.id);\n      const { name, url, topic, enabled } = req.body;\n      \n      const source = await storage.updateUserSource(userId, sourceId, {\n        name,\n        url,\n        topic,\n        enabled,\n      });\n      \n      if (!source) {\n        return res.status(404).json({ error: \"Source not found or not owned by user\" });\n      }\n      \n      res.json(source);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to update source\");\n    }\n  });\n\n  app.delete(\"/api/user-sources/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Unauthorized\" });\n      \n      const sourceId = parseInt(req.params.id);\n      await storage.deleteUserSource(userId, sourceId);\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to delete source\");\n    }\n  });\n\n  app.get(\"/api/permissions\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const scope = (req.query.scope as string) || \"global\";\n      const scopeId = req.query.scopeId ? parseInt(req.query.scopeId as string, 10) : null;\n      const perms = await storage.listPermissions(userId, scope, scopeId);\n      res.json(perms);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to list permissions\");\n    }\n  });\n\n  app.get(\"/api/permissions/effective\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const botId = req.query.botId ? parseInt(req.query.botId as string, 10) : null;\n      const { getEffectivePermissions } = await import(\"./policy/engine\");\n      const effective = await getEffectivePermissions(userId, botId);\n      res.json(effective);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get effective permissions\");\n    }\n  });\n\n  app.put(\"/api/permissions\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const { scope, scopeId, permissionKey, value } = req.body;\n      if (!scope || !permissionKey || !value) {\n        return res.status(400).json({ error: \"Missing required fields: scope, permissionKey, value\" });\n      }\n      const perm = await storage.upsertPermission(userId, scope, scopeId ?? null, permissionKey, value);\n      const { logPermissionAction } = await import(\"./policy/engine\");\n      await logPermissionAction(\n        { userId, botId: scopeId ?? null },\n        \"PERMISSION_CHANGED\",\n        permissionKey,\n        { scope, scopeId, newValue: value },\n      );\n      res.json(perm);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to update permission\");\n    }\n  });\n\n  app.delete(\"/api/permissions\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const { scope, scopeId, permissionKey } = req.body;\n      if (!scope || !permissionKey) {\n        return res.status(400).json({ error: \"Missing required fields: scope, permissionKey\" });\n      }\n      await storage.deletePermission(userId, scope, scopeId ?? null, permissionKey);\n      const { logPermissionAction } = await import(\"./policy/engine\");\n      await logPermissionAction(\n        { userId, botId: scopeId ?? null },\n        \"PERMISSION_DELETED\",\n        permissionKey,\n        { scope, scopeId },\n      );\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to delete permission\");\n    }\n  });\n\n  app.post(\"/api/permissions/check\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const { permissionKey, botId } = req.body;\n      if (!permissionKey) {\n        return res.status(400).json({ error: \"Missing permissionKey\" });\n      }\n      const { checkPermission } = await import(\"./policy/engine\");\n      const result = await checkPermission({ userId, botId: botId ?? null }, permissionKey);\n      res.json(result);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to check permission\");\n    }\n  });\n\n  app.post(\"/api/permissions/approve-once\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const { permissionKey, action, botId } = req.body;\n      if (!permissionKey || !action) {\n        return res.status(400).json({ error: \"Missing permissionKey or action\" });\n      }\n      grantOneTimeApproval(userId!, permissionKey);\n      const { logPermissionAction } = await import(\"./policy/engine\");\n      await logPermissionAction(\n        { userId, botId: botId ?? null },\n        \"APPROVAL_GRANTED_ONCE\",\n        permissionKey,\n        { action, scope: \"once\" },\n      );\n      res.json({ approved: true, scope: \"once\", permissionKey, action });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to approve permission\");\n    }\n  });\n\n  app.get(\"/api/audit-logs\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const filters: any = {};\n      if (req.query.botId) filters.botId = parseInt(req.query.botId as string, 10);\n      if (req.query.eventType) filters.eventType = req.query.eventType as string;\n      if (req.query.permissionKey) filters.permissionKey = req.query.permissionKey as string;\n      if (req.query.limit) filters.limit = parseInt(req.query.limit as string, 10);\n      if (req.query.days) {\n        const days = parseInt(req.query.days as string, 10);\n        if (days > 0) filters.since = new Date(Date.now() - days * 86400000);\n      }\n      if (req.query.since) {\n        const since = new Date(req.query.since as string);\n        if (!isNaN(since.getTime())) filters.since = since;\n      }\n      const logs = await storage.listAuditLogs(userId, filters);\n      res.json(logs);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to list audit logs\");\n    }\n  });\n\n  app.get(\"/api/audit-logs/timeline\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const days = parseInt(req.query.days as string, 10) || 7;\n      const since = new Date(Date.now() - days * 86400000);\n      const logs = await storage.listAuditLogs(userId, { since, limit: 1000 });\n\n      const dailyMap: Record<string, { date: string; denied: number; approved: number; changed: number; requested: number; total: number }> = {};\n      for (let i = 0; i < days; i++) {\n        const d = new Date(Date.now() - i * 86400000);\n        const key = d.toISOString().slice(0, 10);\n        dailyMap[key] = { date: key, denied: 0, approved: 0, changed: 0, requested: 0, total: 0 };\n      }\n\n      for (const log of logs) {\n        const key = new Date(log.createdAt).toISOString().slice(0, 10);\n        if (!dailyMap[key]) continue;\n        dailyMap[key].total++;\n        if (log.eventType === \"PERMISSION_DENIED\") dailyMap[key].denied++;\n        else if (log.eventType.startsWith(\"APPROVAL_GRANTED\")) dailyMap[key].approved++;\n        else if (log.eventType === \"PERMISSION_CHANGED\" || log.eventType === \"PERMISSION_DELETED\") dailyMap[key].changed++;\n        else if (log.eventType === \"APPROVAL_REQUESTED\") dailyMap[key].requested++;\n      }\n\n      const timeline = Object.values(dailyMap).sort((a, b) => a.date.localeCompare(b.date));\n      res.json({ days, timeline, totalEvents: logs.length });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to build audit timeline\");\n    }\n  });\n\n  app.get(\"/api/permissions/risk-scores\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      const bots = await storage.listBots(userId);\n      const last7days = new Date(Date.now() - 7 * 86400000);\n      const allLogs = await storage.listAuditLogs(userId, { since: last7days, limit: 5000 });\n      const { getEffectivePermissions: getEffPerms } = await import(\"./policy/engine\");\n\n      const HIGH_RISK_KEYS = [\"FS_DELETE\", \"LLM_EGRESS_LEVEL\", \"FS_WRITE\"];\n      const MED_RISK_KEYS = [\"WEB_FETCH\", \"LLM_USE\", \"FS_READ\", \"CAL_WRITE\"];\n\n      const botScores = await Promise.all(bots.map(async (bot) => {\n        const effective = await getEffPerms(userId, bot.id);\n        const botLogs = allLogs.filter((l: any) => l.botId === bot.id);\n        const denials = botLogs.filter((l: any) => l.eventType === \"PERMISSION_DENIED\").length;\n\n        let score = 0;\n        for (const [key, perm] of Object.entries(effective)) {\n          const p = perm as any;\n          if (!p.enabled) continue;\n          if (HIGH_RISK_KEYS.includes(key)) {\n            score += p.approvalMode === \"AUTO_ALLOWED\" ? 30 : p.approvalMode === \"APPROVAL_REQUIRED\" ? 15 : 0;\n          } else if (MED_RISK_KEYS.includes(key)) {\n            score += p.approvalMode === \"AUTO_ALLOWED\" ? 15 : p.approvalMode === \"APPROVAL_REQUIRED\" ? 5 : 0;\n          } else {\n            score += p.approvalMode === \"AUTO_ALLOWED\" ? 5 : 0;\n          }\n          if (key === \"LLM_EGRESS_LEVEL\" && p.egressLevel === \"FULL_CONTENT_ALLOWED\") score += 20;\n        }\n        score += denials * 5;\n        score = Math.min(score, 100);\n\n        let level: string;\n        if (score <= 25) level = \"low\";\n        else if (score <= 50) level = \"moderate\";\n        else if (score <= 75) level = \"elevated\";\n        else level = \"high\";\n\n        return {\n          botId: bot.id,\n          botName: bot.name,\n          score,\n          level,\n          denials7d: denials,\n          totalEvents7d: botLogs.length,\n        };\n      }));\n\n      res.json(botScores);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to compute risk scores\");\n    }\n  });\n\n  // ============================================\n  // RULE MEMORIES - Long-term memory for user preferences\n  // ============================================\n\n  app.get(\"/api/memory/rules\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req)!;\n      const scope = (req.query.scope as string) || \"global\";\n      const scopeId = req.query.scopeId ? parseInt(req.query.scopeId as string) : null;\n\n      if (scope === \"all\") {\n        const rules = await storage.listAllUserRuleMemories(userId);\n        res.json(rules);\n      } else {\n        const rules = await storage.listRuleMemories(userId, scope, scopeId);\n        res.json(rules);\n      }\n    } catch (error) {\n      handleApiError(res, error, \"Failed to list rule memories\");\n    }\n  });\n\n  app.get(\"/api/memory/rules/effective\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req)!;\n      const botId = req.query.botId ? parseInt(req.query.botId as string) : null;\n      const effective = await storage.getEffectiveRules(userId, botId);\n      res.json(effective);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get effective rules\");\n    }\n  });\n\n  app.put(\"/api/memory/rules\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req)!;\n      const { scope, scopeId, key, value } = req.body;\n\n      if (!scope || !key || value === undefined) {\n        res.status(400).json({ error: \"scope, key, and value are required\" });\n        return;\n      }\n\n      const allowed = await enforcePermission(req, res, \"MEMORY_WRITE\", \"upsert_rule\", scopeId);\n      if (!allowed) return;\n\n      const rule = await storage.upsertRuleMemory(userId, scope, scopeId ?? null, key, value);\n\n      await storage.createAuditLog({\n        userId,\n        botId: scope === \"bot\" ? scopeId : null,\n        eventType: \"MEMORY_RULE_UPSERT\",\n        permissionKey: \"MEMORY_WRITE\",\n        payloadJson: { key, scope, scopeId },\n      });\n\n      res.json(rule);\n    } catch (error) {\n      handleApiError(res, error, \"Failed to save rule memory\");\n    }\n  });\n\n  app.delete(\"/api/memory/rules\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req)!;\n      const { scope, scopeId, key } = req.body;\n\n      if (!scope || !key) {\n        res.status(400).json({ error: \"scope and key are required\" });\n        return;\n      }\n\n      const allowed = await enforcePermission(req, res, \"MEMORY_WRITE\", \"delete_rule\", scopeId);\n      if (!allowed) return;\n\n      await storage.deleteRuleMemory(userId, scope, scopeId ?? null, key);\n\n      await storage.createAuditLog({\n        userId,\n        botId: scope === \"bot\" ? scopeId : null,\n        eventType: \"MEMORY_RULE_DELETE\",\n        permissionKey: \"MEMORY_WRITE\",\n        payloadJson: { key, scope, scopeId },\n      });\n\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to delete rule memory\");\n    }\n  });\n\n  // ============================================\n  // TELEGRAM LINK MANAGEMENT\n  // ============================================\n  app.post(\"/api/telegram/link-code\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      const code = await storage.createLinkCode(userId, \"telegram\");\n      res.json({ code, expiresInSeconds: 600 });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to generate link code\");\n    }\n  });\n\n  app.get(\"/api/telegram/status\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      const link = await storage.getTelegramLinkByUserId(userId);\n      res.json({\n        linked: !!link,\n        telegramUsername: link?.telegramUsername || null,\n        linkedAt: link?.createdAt || null,\n        botConfigured: !!process.env.TELEGRAM_BOT_TOKEN,\n      });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to get Telegram status\");\n    }\n  });\n\n  app.delete(\"/api/telegram/unlink\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = getUserId(req);\n      if (!userId) return res.status(401).json({ error: \"Not authenticated\" });\n      await storage.deleteTelegramLink(userId);\n      res.json({ ok: true });\n    } catch (error) {\n      handleApiError(res, error, \"Failed to unlink Telegram\");\n    }\n  });\n\n  // Register Telegram webhook endpoint (no auth - Telegram calls this)\n  registerTelegramWebhook(app);\n\n  // Setup Telegram webhook URL on startup\n  setupTelegramWebhook().catch(err => console.error(\"[Telegram] webhook setup error:\", err));\n\n  app.use((err: Error, _req: Request, res: Response, next: NextFunction) => {\n    if (err instanceof NotImplementedError || err?.name === \"NotImplementedError\") {\n      console.warn(`[Route] ${err.message}`);\n      res.status(501).json({\n        error: err.message,\n        code: \"NOT_IMPLEMENTED_SQLITE\",\n        hint: \"이 기능은 로컬 MVP에서 아직 비활성입니다. Fast Report와 Console은 정상 작동합니다.\",\n      });\n      return;\n    }\n    next(err);\n  });\n\n  return httpServer;\n}\n","path":null,"size_bytes":74558,"size_tokens":null},"server/seed.ts":{"content":"import { db, driver } from \"./db\";\nimport { eq } from \"drizzle-orm\";\nimport type { PresetDefaultConfig } from \"@shared/schema\";\nimport * as pgSchema from \"@shared/schema\";\nimport * as sqliteSchema from \"../shared/schema.sqlite\";\n\nconst schema = driver === \"sqlite\" ? sqliteSchema : pgSchema;\nconst presets = schema.presets as any;\nconst sources = schema.sources as any;\n\nexport async function seedPresets() {\n  const existingPresets = await db.select().from(presets);\n  \n  if (existingPresets.length > 0) {\n    console.log(`[seed] Presets already exist (${existingPresets.length} found), checking for new presets...`);\n    const existingKeys = new Set(existingPresets.map(p => p.key));\n    const newPresets = presetData.filter(p => !existingKeys.has(p.key));\n    if (newPresets.length > 0) {\n      await db.insert(presets).values(newPresets);\n      console.log(`[seed] Added ${newPresets.length} new presets`);\n    }\n    for (const p of presetData) {\n      if (existingKeys.has(p.key)) {\n        await db.update(presets)\n          .set({ name: p.name, defaultConfigJson: p.defaultConfigJson, icon: p.icon, category: p.category, description: p.description, variantsJson: p.variantsJson })\n          .where(eq(presets.key, p.key));\n      }\n    }\n    return;\n  }\n\n  console.log(\"[seed] Seeding presets...\");\n  await db.insert(presets).values(presetData);\n  console.log(`[seed] Created ${presetData.length} presets`);\n}\n\nconst presetData: Array<{\n  key: string;\n  name: string;\n  outputType: string;\n  description: string;\n  variantsJson: string[];\n  defaultConfigJson: PresetDefaultConfig;\n  icon: string;\n  category: string;\n}> = [\n  {\n    key: \"news_briefing\",\n    name: \"News Briefing\",\n    outputType: \"report\",\n    description: \"Daily news digest from selected sources. Get a concise summary of key events and developments.\",\n    variantsJson: [\"tech\", \"investing\", \"crypto\"],\n    icon: \"Newspaper\",\n    category: \"information\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"07:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { tldr: true, drivers: true, risk: false, checklist: false, sources: true },\n      filters: { minImportanceScore: 30 },\n      suggestedSources: [\n        { name: \"Hacker News\", url: \"https://hnrss.org/newest\", topic: \"tech\" },\n        { name: \"TechCrunch\", url: \"https://techcrunch.com/feed/\", topic: \"tech\" },\n        { name: \"The Verge\", url: \"https://www.theverge.com/rss/index.xml\", topic: \"tech\" },\n        { name: \"Reuters Business\", url: \"https://www.reutersagency.com/feed/\", topic: \"investing\" },\n        { name: \"CNBC Top News\", url: \"https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114\", topic: \"investing\" },\n        { name: \"CoinDesk\", url: \"https://www.coindesk.com/arc/outboundfeeds/rss/\", topic: \"crypto\" },\n      ],\n    },\n  },\n  {\n    key: \"competitor_watch\",\n    name: \"Competitor Watch\",\n    outputType: \"report\",\n    description: \"Monitor competitor activities, product launches, and market positioning changes.\",\n    variantsJson: [\"tech\", \"investing\", \"ai_art\"],\n    icon: \"Eye\",\n    category: \"business\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"WEEKDAYS\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"normal\",\n      verbosity: \"detailed\",\n      sections: { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n      filters: { minImportanceScore: 40 },\n      suggestedSources: [\n        { name: \"TechCrunch\", url: \"https://techcrunch.com/feed/\", topic: \"tech\" },\n        { name: \"Product Hunt\", url: \"https://www.producthunt.com/feed\", topic: \"tech\" },\n        { name: \"Ars Technica\", url: \"https://feeds.arstechnica.com/arstechnica/index\", topic: \"tech\" },\n        { name: \"Reuters Business\", url: \"https://www.reutersagency.com/feed/\", topic: \"investing\" },\n        { name: \"CNBC Top News\", url: \"https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114\", topic: \"investing\" },\n      ],\n    },\n  },\n  {\n    key: \"legal_policy\",\n    name: \"Legal / Policy Monitor\",\n    outputType: \"report\",\n    description: \"Track regulatory changes, policy updates, and legal developments that may affect your industry.\",\n    variantsJson: [\"tech\", \"investing\", \"crypto\"],\n    icon: \"Scale\",\n    category: \"compliance\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"WEEKDAYS\",\n      scheduleTimeLocal: \"08:00\",\n      markdownLevel: \"normal\",\n      verbosity: \"detailed\",\n      sections: { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n      filters: { minImportanceScore: 50 },\n      suggestedSources: [\n        { name: \"EFF Updates\", url: \"https://www.eff.org/rss/updates.xml\", topic: \"tech\" },\n        { name: \"FTC News\", url: \"https://www.ftc.gov/feeds/press-releases.xml\", topic: \"tech\" },\n        { name: \"SEC EDGAR 8-K\", url: \"https://efts.sec.gov/LATEST/search-index?q=%228-K%22&dateRange=custom&startdt=2024-01-01&forms=8-K&rss_url=/cgi-bin/browse-edgar%3Faction%3Dgetcompany%26type%3D8-K%26dateb%3D%26owner%3Dinclude%26count%3D20%26search_text%3D%26action%3Dgetcompany%26output%3Datom\", topic: \"investing\" },\n        { name: \"Reuters Business\", url: \"https://www.reutersagency.com/feed/\", topic: \"investing\" },\n        { name: \"CoinDesk\", url: \"https://www.coindesk.com/arc/outboundfeeds/rss/\", topic: \"crypto\" },\n      ],\n    },\n  },\n  {\n    key: \"academic_research\",\n    name: \"Academic / Research\",\n    outputType: \"report\",\n    description: \"Follow the latest research papers, preprints, and academic discussions in your field.\",\n    variantsJson: [\"tech\", \"ai_art\"],\n    icon: \"GraduationCap\",\n    category: \"research\",\n    defaultConfigJson: {\n      timezone: \"America/New_York\",\n      scheduleRule: \"WEEKDAYS\",\n      scheduleTimeLocal: \"10:00\",\n      markdownLevel: \"normal\",\n      verbosity: \"detailed\",\n      sections: { tldr: true, drivers: true, risk: false, checklist: false, sources: true },\n      filters: { minImportanceScore: 20 },\n      suggestedSources: [\n        { name: \"ArXiv AI\", url: \"https://rss.arxiv.org/rss/cs.AI\", topic: \"tech\" },\n        { name: \"ArXiv Machine Learning\", url: \"https://rss.arxiv.org/rss/cs.LG\", topic: \"tech\" },\n        { name: \"ArXiv Computer Vision\", url: \"https://rss.arxiv.org/rss/cs.CV\", topic: \"ai_art\" },\n        { name: \"ArXiv Computation & Language\", url: \"https://rss.arxiv.org/rss/cs.CL\", topic: \"tech\" },\n      ],\n    },\n  },\n  {\n    key: \"shopping_trends\",\n    name: \"Shopping / Trend Watch\",\n    outputType: \"report\",\n    description: \"Track product trends, pricing changes, and consumer behavior insights.\",\n    variantsJson: [\"tech\", \"investing\"],\n    icon: \"ShoppingBag\",\n    category: \"commerce\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"19:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"short\",\n      sections: { tldr: true, drivers: true, risk: false, checklist: false, sources: true },\n      filters: { minImportanceScore: 25 },\n      suggestedSources: [\n        { name: \"Product Hunt\", url: \"https://www.producthunt.com/feed\", topic: \"tech\" },\n        { name: \"TechCrunch\", url: \"https://techcrunch.com/feed/\", topic: \"tech\" },\n        { name: \"The Verge\", url: \"https://www.theverge.com/rss/index.xml\", topic: \"tech\" },\n        { name: \"CNBC Top News\", url: \"https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114\", topic: \"investing\" },\n      ],\n    },\n  },\n  {\n    key: \"community_engagement\",\n    name: \"Community Engagement\",\n    outputType: \"draft\",\n    description: \"Draft thoughtful replies for community posts. Help you engage authentically without promotional content.\",\n    variantsJson: [\"ai_art\", \"tech\", \"creative\"],\n    icon: \"MessageSquare\",\n    category: \"engagement\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"21:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { tldr: false, drivers: false, risk: true, checklist: false, sources: false },\n      filters: { minImportanceScore: 0 },\n      suggestedSources: [\n        { name: \"Hacker News\", url: \"https://hnrss.org/newest\", topic: \"tech\" },\n        { name: \"The Verge\", url: \"https://www.theverge.com/rss/index.xml\", topic: \"tech\" },\n      ],\n    },\n  },\n  {\n    key: \"daily_market_brief\",\n    name: \"Daily Market Brief\",\n    outputType: \"report\",\n    description: \"Daily report from selected sources - summarizes key market movements and insights\",\n    variantsJson: [\"investing\", \"tech\", \"crypto\"],\n    icon: \"TrendingUp\",\n    category: \"finance\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"WEEKDAYS\",\n      scheduleTimeLocal: \"21:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n      filters: { minImportanceScore: 30 },\n      suggestedSources: [\n        { name: \"Reuters Business\", url: \"https://www.reutersagency.com/feed/\", topic: \"investing\" },\n        { name: \"CNBC Top News\", url: \"https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114\", topic: \"investing\" },\n        { name: \"Hacker News\", url: \"https://hnrss.org/newest\", topic: \"tech\" },\n        { name: \"TechCrunch\", url: \"https://techcrunch.com/feed/\", topic: \"tech\" },\n        { name: \"CoinDesk\", url: \"https://www.coindesk.com/arc/outboundfeeds/rss/\", topic: \"crypto\" },\n      ],\n    },\n  },\n  {\n    key: \"community_engagement_helper\",\n    name: \"Community Engagement Helper\",\n    outputType: \"draft\",\n    description: \"Draft replies for community posts - helps you engage authentically with your community\",\n    variantsJson: [\"ai_art\", \"tech\", \"creative\"],\n    icon: \"Users\",\n    category: \"engagement\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"21:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { tldr: false, drivers: false, risk: true, checklist: false, sources: false },\n      filters: { minImportanceScore: 0 },\n      suggestedSources: [\n        { name: \"Hacker News\", url: \"https://hnrss.org/newest\", topic: \"tech\" },\n      ],\n    },\n  },\n  {\n    key: \"community_research_helper\",\n    name: \"Community Research Helper\",\n    outputType: \"draft\",\n    description: \"A workflow starter template that monitors key community discussions and trends, and generates helpful summaries/drafts without promotion.\",\n    variantsJson: [\"community_research\"],\n    icon: \"Search\",\n    category: \"engagement\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { tldr: true, drivers: true, risk: true, checklist: false, sources: true },\n      filters: { minImportanceScore: 0 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"no-links\",\n      suggestedSources: [\n        { name: \"Reddit AI\", url: \"https://www.reddit.com/r/ArtificialInteligence/.rss\", topic: \"community_research\" },\n        { name: \"Hacker News\", url: \"https://news.ycombinator.com/rss\", topic: \"community_research\" },\n        { name: \"TechCrunch\", url: \"https://techcrunch.com/feed/\", topic: \"community_research\" },\n        { name: \"Ars Technica\", url: \"https://feeds.arstechnica.com/arstechnica/index\", topic: \"community_research\" },\n        { name: \"MIT Technology Review\", url: \"https://www.technologyreview.com/feed/\", topic: \"community_research\" },\n      ],\n    },\n  },\n  {\n    key: \"daily_market_brief_safe\",\n    name: \"Daily Market Brief Assistant\",\n    outputType: \"report\",\n    description: \"An AI assistant that automatically collects major market news on stocks, economy, and crypto, then creates a summary briefing so you can see what matters today at a glance. Use it to quickly grasp market trends every morning.\",\n    variantsJson: [\"market_brief\"],\n    icon: \"Briefcase\",\n    category: \"finance\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"08:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { tldr: true, marketHighlights: true, whyItMatters: true, watchlist: true, sources: true },\n      filters: { minImportanceScore: 30 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"optional\",\n      suggestedSources: [\n        { name: \"Reuters Business\", url: \"https://www.reutersagency.com/feed/\", topic: \"market_brief\" },\n        { name: \"Yahoo Finance\", url: \"https://finance.yahoo.com/news/rssindex\", topic: \"market_brief\" },\n        { name: \"Investing.com News\", url: \"https://www.investing.com/rss/news.rss\", topic: \"market_brief\" },\n        { name: \"Reddit r/investing\", url: \"https://www.reddit.com/r/investing/.rss\", topic: \"market_brief\" },\n        { name: \"Reddit r/stocks\", url: \"https://www.reddit.com/r/stocks/.rss\", topic: \"market_brief\" },\n        { name: \"CNBC Top News\", url: \"https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114\", topic: \"market_brief\" },\n      ],\n    },\n  },\n  {\n    key: \"work_productivity\",\n    name: \"Work & Productivity Research Assistant\",\n    outputType: \"report\",\n    description: \"A research assistant that automatically collects productivity tips, operational know-how, practical ideas, and tool use cases, then organizes them into actionable improvement hints for your day. Great for planning, marketing, operations, and solo business workflows.\",\n    variantsJson: [\"work_productivity\"],\n    icon: \"Laptop\",\n    category: \"business\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { todaysInsights: true, usefulIdeasTools: true, howToApply: true, quickSummary: true, sources: true },\n      filters: { minImportanceScore: 30 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"optional\",\n      suggestedSources: [\n        { name: \"Reddit r/productivity\", url: \"https://www.reddit.com/r/productivity/.rss\", topic: \"work_productivity\" },\n        { name: \"Reddit r/Entrepreneur\", url: \"https://www.reddit.com/r/Entrepreneur/.rss\", topic: \"work_productivity\" },\n        { name: \"Reddit r/smallbusiness\", url: \"https://www.reddit.com/r/smallbusiness/.rss\", topic: \"work_productivity\" },\n        { name: \"Reddit r/marketing\", url: \"https://www.reddit.com/r/marketing/.rss\", topic: \"work_productivity\" },\n        { name: \"Lifehacker\", url: \"https://lifehacker.com/rss\", topic: \"work_productivity\" },\n        { name: \"Zapier Blog\", url: \"https://zapier.com/blog/feeds/latest/\", topic: \"work_productivity\" },\n        { name: \"HubSpot Marketing Blog\", url: \"https://blog.hubspot.com/marketing/rss.xml\", topic: \"work_productivity\" },\n        { name: \"Medium Productivity\", url: \"https://medium.com/feed/tag/productivity\", topic: \"work_productivity\" },\n      ],\n    },\n  },\n  {\n    key: \"academic_watcher_research\",\n    name: \"Academic Watcher (Research)\",\n    outputType: \"report\",\n    description: \"A research workflow that tracks and summarizes paper/research trends. Maintains an academically neutral tone with no promotion or links. This template is a starting point.\",\n    variantsJson: [\"research_watch\"],\n    icon: \"BookOpen\",\n    category: \"research\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"WEEKDAYS\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"normal\",\n      verbosity: \"detailed\",\n      sections: { tldr: true, drivers: true, risk: false, checklist: false, sources: true },\n      filters: { minImportanceScore: 20 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"no-links\",\n      suggestedSources: [\n        { name: \"ArXiv AI/CL\", url: \"https://rss.arxiv.org/rss/cs.AI\", topic: \"research_watch\" },\n        { name: \"Google Research Blog\", url: \"https://blog.research.google/feeds/posts/default?alt=rss\", topic: \"research_watch\" },\n        { name: \"OpenAI Blog\", url: \"https://openai.com/blog/rss.xml\", topic: \"research_watch\" },\n        { name: \"DeepMind Blog\", url: \"https://deepmind.google/blog/rss.xml\", topic: \"research_watch\" },\n        { name: \"MIT Technology Review\", url: \"https://www.technologyreview.com/feed/\", topic: \"research_watch\" },\n      ],\n    },\n  },\n  {\n    key: \"content_research\",\n    name: \"Content Ideas & Research Assistant\",\n    outputType: \"report\",\n    description: \"A research assistant that automatically collects material for blogs, newsletters, and content planning, then summarizes what people are interested in right now. Automate finding topics, spotting trends, and preparing drafts.\",\n    variantsJson: [\"content_research\"],\n    icon: \"PenTool\",\n    category: \"research\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { tldr: true, drivers: true, risk: false, checklist: true, sources: true },\n      filters: { minImportanceScore: 0 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"no-links\",\n      suggestedSources: [\n        { name: \"Medium Writing\", url: \"https://medium.com/feed/tag/writing\", topic: \"content_research\" },\n        { name: \"Medium Content Marketing\", url: \"https://medium.com/feed/tag/content-marketing\", topic: \"content_research\" },\n        { name: \"Reddit Writing\", url: \"https://www.reddit.com/r/writing/.rss\", topic: \"content_research\" },\n        { name: \"Reddit Blogging\", url: \"https://www.reddit.com/r/Blogging/.rss\", topic: \"content_research\" },\n        { name: \"Reddit Content Marketing\", url: \"https://www.reddit.com/r/contentmarketing/.rss\", topic: \"content_research\" },\n        { name: \"Lifehacker\", url: \"https://lifehacker.com/rss\", topic: \"content_research\" },\n        { name: \"Zapier Blog\", url: \"https://zapier.com/blog/feeds/latest/\", topic: \"content_research\" },\n        { name: \"HubSpot Marketing Blog\", url: \"https://blog.hubspot.com/marketing/rss.xml\", topic: \"content_research\" },\n        { name: \"Google News Content\", url: \"https://news.google.com/rss/search?q=content+marketing+OR+writing\", topic: \"content_research\" },\n      ],\n    },\n  },\n  {\n    key: \"competitor_signal_monitor\",\n    name: \"Competitor Signal Monitor\",\n    outputType: \"report\",\n    description: \"A monitoring workflow that summarizes competitor and industry trend changes. Provides fact-based change summaries only — no promotion or links. This template is a starting point.\",\n    variantsJson: [\"competitor_watch\"],\n    icon: \"Building2\",\n    category: \"business\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"normal\",\n      verbosity: \"normal\",\n      sections: { tldr: true, drivers: true, risk: true, checklist: false, sources: true },\n      filters: { minImportanceScore: 30 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"no-links\",\n      suggestedSources: [\n        { name: \"TechCrunch\", url: \"https://techcrunch.com/feed/\", topic: \"competitor_watch\" },\n        { name: \"The Verge\", url: \"https://www.theverge.com/rss/index.xml\", topic: \"competitor_watch\" },\n        { name: \"Product Hunt\", url: \"https://www.producthunt.com/feed\", topic: \"competitor_watch\" },\n        { name: \"Hacker News\", url: \"https://news.ycombinator.com/rss\", topic: \"competitor_watch\" },\n        { name: \"Ars Technica\", url: \"https://feeds.arstechnica.com/arstechnica/index\", topic: \"competitor_watch\" },\n      ],\n    },\n  },\n  {\n    key: \"online_business_research\",\n    name: \"Online Business Market Research Assistant\",\n    outputType: \"report\",\n    description: \"A research assistant for online sellers and small brand owners. Automatically collects market signals, customer complaints, and trend data from communities and news, then organizes them into actionable strategy reports. Focuses on 'why customers hesitate' rather than 'what to sell.'\",\n    variantsJson: [\"online_business\"],\n    icon: \"Store\",\n    category: \"business\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { marketSummary: true, customerSignals: true, riskFlags: true, actionItems: true, contentDraft: true, sources: true },\n      filters: { minImportanceScore: 20 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"no-links\",\n      suggestedSources: [\n        { name: \"네이버 쇼핑 인사이트\", url: \"https://datalab.naver.com/shoppingInsight/sCategory.naver\", topic: \"online_business\" },\n        { name: \"네이버 카페 — 스마트스토어 셀러\", url: \"https://cafe.naver.com/smartstore\", topic: \"online_business\" },\n        { name: \"네이버 블로그 (상품 후기)\", url: \"https://section.blog.naver.com/ThemePost.naver?directoryNo=0&activeDirectorySeq=0&currentPage=1\", topic: \"online_business\" },\n        { name: \"쿠팡 (리뷰 참고)\", url: \"https://www.coupang.com/\", topic: \"online_business\" },\n        { name: \"당근마켓 (중고·거래 트렌드)\", url: \"https://www.daangn.com/\", topic: \"online_business\" },\n        { name: \"브런치 · Medium (사업 경험담)\", url: \"https://medium.com/feed/tag/ecommerce\", topic: \"online_business\" },\n        { name: \"Reddit (글로벌 비교)\", url: \"https://www.reddit.com/r/ecommerce/.rss\", topic: \"online_business\" },\n        { name: \"공정거래위원회 · 소비자원\", url: \"https://www.kca.go.kr/\", topic: \"online_business\" },\n      ],\n      sourceDisclaimer: \"기본 소스는 온라인 사업자가 일반적으로 참고하는 공개 채널입니다. 특정 플랫폼·전문 영역에 특화된 소스는 사용자가 직접 추가할 수 있습니다. Maker는 소스를 추천하지 않으며, 판단은 사용자 책임입니다.\",\n    },\n  },\n  {\n    key: \"korea_marketplace_research\",\n    name: \"Korea Marketplace Research Assistant\",\n    outputType: \"report\",\n    description: \"쿠팡·스마트스토어 판매자를 위한 시장 신호 기반 제품·전략 리서치 봇. 이 프리셋은 상품을 대신 판매하거나 자동 홍보하지 않습니다. 수요, 불만, 가격 압력, 리뷰 신호를 수집·정리하여 판단을 돕는 리서치 워크플로우입니다.\",\n    variantsJson: [\"korea_marketplace\"],\n    icon: \"ShoppingCart\",\n    category: \"commerce\",\n    defaultConfigJson: {\n      timezone: \"Asia/Seoul\",\n      scheduleRule: \"DAILY\",\n      scheduleTimeLocal: \"09:00\",\n      markdownLevel: \"minimal\",\n      verbosity: \"normal\",\n      sections: { marketSnapshot: true, customerSignals: true, sellerSignals: true, riskFlags: true, opportunityHints: true, actionItems: true, draftNotes: true },\n      filters: { minImportanceScore: 20 },\n      requireHumanApproval: true,\n      promotionLevel: \"none\",\n      linkPolicy: \"no-links\",\n      suggestedSources: [\n        { name: \"네이버 카페 — 스마트스토어 판매자\", url: \"https://cafe.naver.com/smartstore\", topic: \"korea_marketplace\" },\n        { name: \"네이버 카페 — 온라인 셀러/창업\", url: \"https://cafe.naver.com/sohochangup\", topic: \"korea_marketplace\" },\n        { name: \"Reddit r/ecommerce (글로벌 비교)\", url: \"https://www.reddit.com/r/ecommerce/.rss\", topic: \"korea_marketplace\" },\n        { name: \"네이버 스마트스토어 공식 블로그\", url: \"https://blog.naver.com/naver_commerce\", topic: \"korea_marketplace\" },\n        { name: \"쿠팡 뉴스룸\", url: \"https://www.aboutcoupang.com/\", topic: \"korea_marketplace\" },\n        { name: \"Google Trends (Korea)\", url: \"https://trends.google.co.kr/trending?geo=KR\", topic: \"korea_marketplace\" },\n        { name: \"통계청 KOSIS (소비 트렌드)\", url: \"https://kosis.kr/\", topic: \"korea_marketplace\" },\n      ],\n      sourceDisclaimer: \"기본 소스는 한국 오픈마켓 셀러가 일반적으로 참고하는 공개 채널입니다. 특정 플랫폼·전문 영역에 특화된 소스는 사용자가 직접 추가할 수 있습니다. Maker는 소스를 추천하지 않으며, 판단은 사용자 책임입니다.\",\n    },\n  },\n];\n\nexport async function seedDefaultSources() {\n  const existingSources = await db.select().from(sources);\n  const existingUrls = new Set(existingSources.map(s => s.url));\n\n  console.log(\"[seed] Checking default sources...\");\n\n  const defaultSources = [\n    {\n      name: \"Hacker News\",\n      type: \"rss\",\n      url: \"https://hnrss.org/newest\",\n      topic: \"tech\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"TechCrunch\",\n      type: \"rss\",\n      url: \"https://techcrunch.com/feed/\",\n      topic: \"tech\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"AI Art Weekly\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/aiart/.rss\",\n      topic: \"ai_art\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reuters Business\",\n      type: \"rss\",\n      url: \"https://www.reutersagency.com/feed/\",\n      topic: \"investing\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"CNBC Top News\",\n      type: \"rss\",\n      url: \"https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114\",\n      topic: \"investing\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Investing.com News\",\n      type: \"rss\",\n      url: \"https://www.investing.com/rss/news.rss\",\n      topic: \"investing\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Medium Writing\",\n      type: \"rss\",\n      url: \"https://medium.com/feed/tag/writing\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Medium Content Marketing\",\n      type: \"rss\",\n      url: \"https://medium.com/feed/tag/content-marketing\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit Writing\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/writing/.rss\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit Blogging\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/Blogging/.rss\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit Content Marketing\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/contentmarketing/.rss\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Lifehacker\",\n      type: \"rss\",\n      url: \"https://lifehacker.com/rss\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Zapier Blog\",\n      type: \"rss\",\n      url: \"https://zapier.com/blog/feeds/latest/\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"HubSpot Marketing Blog\",\n      type: \"rss\",\n      url: \"https://blog.hubspot.com/marketing/rss.xml\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Google News Content\",\n      type: \"rss\",\n      url: \"https://news.google.com/rss/search?q=content+marketing+OR+writing\",\n      topic: \"content_research\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit r/productivity\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/productivity/.rss\",\n      topic: \"work_productivity\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit r/Entrepreneur\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/Entrepreneur/.rss\",\n      topic: \"work_productivity\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit r/smallbusiness\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/smallbusiness/.rss\",\n      topic: \"work_productivity\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit r/marketing\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/marketing/.rss\",\n      topic: \"work_productivity\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Medium Productivity\",\n      type: \"rss\",\n      url: \"https://medium.com/feed/tag/productivity\",\n      topic: \"work_productivity\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"네이버 쇼핑 인사이트\",\n      type: \"rss\",\n      url: \"https://datalab.naver.com/shoppingInsight/sCategory.naver\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"네이버 카페 — 스마트스토어 셀러\",\n      type: \"rss\",\n      url: \"https://cafe.naver.com/smartstore\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"네이버 블로그 (상품 후기)\",\n      type: \"rss\",\n      url: \"https://section.blog.naver.com/ThemePost.naver?directoryNo=0&activeDirectorySeq=0&currentPage=1\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"쿠팡 (리뷰 참고)\",\n      type: \"rss\",\n      url: \"https://www.coupang.com/\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"당근마켓 (중고·거래 트렌드)\",\n      type: \"rss\",\n      url: \"https://www.daangn.com/\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"브런치 · Medium (사업 경험담)\",\n      type: \"rss\",\n      url: \"https://medium.com/feed/tag/ecommerce\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit (글로벌 비교)\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/ecommerce/.rss\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"공정거래위원회 · 소비자원\",\n      type: \"rss\",\n      url: \"https://www.kca.go.kr/\",\n      topic: \"online_business\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"네이버 카페 — 스마트스토어 판매자\",\n      type: \"rss\",\n      url: \"https://cafe.naver.com/smartstore\",\n      topic: \"korea_marketplace\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"네이버 카페 — 온라인 셀러/창업\",\n      type: \"rss\",\n      url: \"https://cafe.naver.com/sohochangup\",\n      topic: \"korea_marketplace\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Reddit r/ecommerce (글로벌 비교)\",\n      type: \"rss\",\n      url: \"https://www.reddit.com/r/ecommerce/.rss\",\n      topic: \"korea_marketplace\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"네이버 스마트스토어 공식 블로그\",\n      type: \"rss\",\n      url: \"https://blog.naver.com/naver_commerce\",\n      topic: \"korea_marketplace\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"쿠팡 뉴스룸\",\n      type: \"rss\",\n      url: \"https://www.aboutcoupang.com/\",\n      topic: \"korea_marketplace\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"Google Trends (Korea)\",\n      type: \"rss\",\n      url: \"https://trends.google.co.kr/trending?geo=KR\",\n      topic: \"korea_marketplace\",\n      isDefault: true,\n      enabled: true,\n    },\n    {\n      name: \"통계청 KOSIS (소비 트렌드)\",\n      type: \"rss\",\n      url: \"https://kosis.kr/\",\n      topic: \"korea_marketplace\",\n      isDefault: true,\n      enabled: true,\n    },\n  ];\n\n  const newSources = defaultSources.filter(s => !existingUrls.has(s.url));\n  \n  if (newSources.length === 0) {\n    console.log(`[seed] All ${defaultSources.length} default sources already exist, skipping`);\n    return;\n  }\n\n  for (const source of newSources) {\n    try {\n      await db.insert(sources).values(source);\n    } catch (err: any) {\n      if (err.code === \"23505\" || (err.message && err.message.includes(\"UNIQUE constraint\"))) {\n        console.log(`[seed] Source \"${source.name}\" already exists, skipping`);\n      } else {\n        throw err;\n      }\n    }\n  }\n  \n  console.log(`[seed] Added ${newSources.length} new default sources (total: ${defaultSources.length})`);\n}\n\nexport async function runAllSeeds() {\n  await seedPresets();\n  await seedDefaultSources();\n}\n","path":null,"size_bytes":32656,"size_tokens":null},"server/llm/providers/google.ts":{"content":"interface GoogleResponse {\n  candidates: Array<{\n    content: { parts: Array<{ text: string }> };\n    finishReason: string;\n  }>;\n}\n\nexport async function generate(\n  prompt: string,\n  options: { apiKey: string; baseUrl?: string | null; model?: string | null; maxTokens?: number }\n): Promise<string> {\n  const model = options.model || \"gemini-2.0-flash\";\n  const baseUrl = options.baseUrl || \"https://generativelanguage.googleapis.com\";\n  const url = `${baseUrl}/v1beta/models/${model}:generateContent?key=${options.apiKey}`;\n  const maxTokens = options.maxTokens || 1200;\n\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify({\n      contents: [{ parts: [{ text: prompt }] }],\n      generationConfig: {\n        temperature: 0.2,\n        maxOutputTokens: maxTokens,\n      },\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Google AI API error: ${response.status} - ${errorText}`);\n  }\n\n  const data: GoogleResponse = await response.json();\n  const text = data.candidates?.[0]?.content?.parts?.map(p => p.text).join(\"\");\n\n  if (!text) throw new Error(\"Empty response from Google AI API\");\n  return text;\n}\n","path":null,"size_bytes":1243,"size_tokens":null},"server/lib/safe-storage.ts":{"content":"import { driver } from \"../db\";\nimport type { Response } from \"express\";\n\nexport class NotImplementedError extends Error {\n  constructor(methodName: string) {\n    super(`[SQLite MVP] \"${methodName}\" is not yet available in local mode. Core features (Fast Report, Console, Bots) work normally.`);\n    this.name = \"NotImplementedError\";\n  }\n}\n\nexport function isSqliteMode(): boolean {\n  return driver === \"sqlite\";\n}\n\nexport function handleApiError(res: Response, error: unknown, fallbackMsg: string): void {\n  const err = error as Error;\n  if (err?.name === \"NotImplementedError\" || err instanceof NotImplementedError) {\n    console.warn(`[Route:501] ${err.message}`);\n    res.status(501).json({\n      error: err.message,\n      code: \"NOT_IMPLEMENTED_SQLITE\",\n      hint: \"이 기능은 로컬 MVP에서 아직 비활성입니다. Fast Report와 Console은 정상 작동합니다.\",\n    });\n    return;\n  }\n  console.error(fallbackMsg, error);\n  res.status(500).json({ error: fallbackMsg });\n}\n\nexport function safeStorageCall<T>(\n  fallback: T,\n  label: string,\n  fn: () => Promise<T>\n): Promise<T> {\n  return fn().catch((err: Error) => {\n    if (err instanceof NotImplementedError || err?.name === \"NotImplementedError\") {\n      console.warn(`[SafeStorage] ${label}: ${err.message}`);\n      return fallback;\n    }\n    throw err;\n  });\n}\n","path":null,"size_bytes":1339,"size_tokens":null},"electron/preload.ts":{"content":"import { contextBridge, ipcRenderer } from \"electron\";\n\nconst desktopApi = {\n  platform: process.platform,\n  isDesktop: true,\n  versions: {\n    electron: process.versions.electron,\n    node: process.versions.node,\n    chrome: process.versions.chrome,\n  },\n  openExternal: (url: string) => ipcRenderer.send(\"open-external\", url),\n};\n\ncontextBridge.exposeInMainWorld(\"maker\", desktopApi);\ncontextBridge.exposeInMainWorld(\"electronAPI\", desktopApi);\n","path":null,"size_bytes":447,"size_tokens":null},"server/storage-sqlite.ts":{"content":"import { db } from \"./db\";\nimport { encrypt, decrypt } from \"./lib/crypto\";\nimport {\n  sources, items, analysis, drafts, posts, reports, chatMessages, chatThreads, settings,\n  presets, profiles, profileSources, outputs, outputItems,\n  bots, botSettings, sourceBotLinks, llmProviders, jobRuns,\n  permissions, auditLogs, reportMetrics, ruleMemories,\n} from \"../shared/schema.sqlite\";\nimport type {\n  Source, Item, Analysis, Draft, Post, Report,\n  InsertSource, InsertItem, InsertAnalysis, InsertDraft, InsertReport,\n  ChatMessage, InsertChatMessage, ChatThread, InsertChatThread, Setting,\n  Preset, InsertPreset, Profile, InsertProfile,\n  Output, InsertOutput, OutputItem,\n  Bot, InsertBot, BotSettings, InsertBotSettings, SourceBotLink,\n  LlmProvider, InsertLlmProvider,\n  JobRun, InsertJobRun, Permission, RuleMemory,\n} from \"@shared/schema\";\nimport type { IStorage } from \"./storage\";\nimport { eq, desc, sql, and, count, gte, lt, lte, or, isNull, inArray } from \"drizzle-orm\";\n\nexport class SqliteStorage implements IStorage {\n  async getStats() {\n    const result = await db\n      .select({\n        status: items.status,\n        count: count(),\n      })\n      .from(items)\n      .groupBy(items.status);\n\n    const stats: {\n      total: number;\n      new: number;\n      analyzed: number;\n      drafted: number;\n      approved: number;\n      posted: number;\n      skipped: number;\n      lastCollectAt: string | null;\n      lastAnalyzeAt: string | null;\n    } = {\n      total: 0,\n      new: 0,\n      analyzed: 0,\n      drafted: 0,\n      approved: 0,\n      posted: 0,\n      skipped: 0,\n      lastCollectAt: null,\n      lastAnalyzeAt: null,\n    };\n\n    for (const row of result) {\n      const c = Number(row.count);\n      stats.total += c;\n      if (row.status in stats) {\n        (stats as any)[row.status] = c;\n      }\n    }\n\n    const lastCollect = await db\n      .select({ insertedAt: items.insertedAt })\n      .from(items)\n      .orderBy(desc(items.insertedAt))\n      .limit(1);\n\n    if (lastCollect.length > 0 && lastCollect[0].insertedAt) {\n      stats.lastCollectAt = lastCollect[0].insertedAt.toISOString();\n    }\n\n    const lastAnalyze = await db\n      .select({ createdAt: analysis.createdAt })\n      .from(analysis)\n      .orderBy(desc(analysis.createdAt))\n      .limit(1);\n\n    if (lastAnalyze.length > 0 && lastAnalyze[0].createdAt) {\n      stats.lastAnalyzeAt = lastAnalyze[0].createdAt.toISOString();\n    }\n\n    return stats;\n  }\n\n  async getSources(): Promise<(Source & { itemCount: number })[]> {\n    const result = await db\n      .select({\n        source: sources,\n        itemCount: sql<number>`COALESCE(COUNT(${items.id}), 0)`.as(\"item_count\"),\n      })\n      .from(sources)\n      .leftJoin(items, eq(items.sourceId, sources.id))\n      .groupBy(sources.id)\n      .orderBy(desc(sources.createdAt));\n\n    return result.map((r) => ({\n      ...r.source,\n      itemCount: Number(r.itemCount),\n    })) as any;\n  }\n\n  async getSource(id: number): Promise<Source | undefined> {\n    const [source] = await db.select().from(sources).where(eq(sources.id, id));\n    return source as any;\n  }\n\n  async createSource(data: InsertSource): Promise<Source> {\n    const [source] = await db.insert(sources).values(data as any).returning();\n    return source as any;\n  }\n\n  async updateSource(id: number, data: Partial<InsertSource>): Promise<Source | undefined> {\n    const [source] = await db.update(sources).set(data as any).where(eq(sources.id, id)).returning();\n    return source as any;\n  }\n\n  async deleteSource(id: number): Promise<void> {\n    await db.delete(sources).where(eq(sources.id, id));\n  }\n\n  async getItems(status?: string): Promise<(Item & { sourceName: string; relevanceScore?: number; replyWorthinessScore?: number })[]> {\n    let query = db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        relevanceScore: analysis.relevanceScore,\n        replyWorthinessScore: analysis.replyWorthinessScore,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .leftJoin(analysis, eq(analysis.itemId, items.id))\n      .orderBy(desc(items.insertedAt));\n\n    if (status && status !== \"all\") {\n      query = query.where(eq(items.status, status)) as any;\n    }\n\n    const result = await query;\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n      relevanceScore: r.relevanceScore ?? undefined,\n      replyWorthinessScore: r.replyWorthinessScore ?? undefined,\n    })) as any;\n  }\n\n  async getRecentItems(limit: number = 10): Promise<(Item & { sourceName: string })[]> {\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .orderBy(desc(items.insertedAt))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n    })) as any;\n  }\n\n  async getObserveItems(limit: number = 50): Promise<any[]> {\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        relevanceScore: analysis.relevanceScore,\n        replyWorthinessScore: analysis.replyWorthinessScore,\n        category: analysis.category,\n        summaryShort: analysis.summaryShort,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .leftJoin(analysis, eq(items.id, analysis.itemId))\n      .where(\n        and(\n          eq(items.status, \"skipped\"),\n          gte(analysis.relevanceScore, 60),\n          lt(analysis.replyWorthinessScore, 50)\n        )\n      )\n      .orderBy(desc(analysis.relevanceScore))\n      .limit(limit);\n\n    return result.map((r) => ({\n      id: r.item.id,\n      title: r.item.title,\n      url: r.item.url,\n      sourceName: r.sourceName || \"Unknown\",\n      status: r.item.status,\n      publishedAt: r.item.publishedAt,\n      relevanceScore: r.relevanceScore || 0,\n      replyWorthinessScore: r.replyWorthinessScore || 0,\n      category: r.category || \"other\",\n      summaryShort: r.summaryShort || \"\",\n    }));\n  }\n\n  async getItem(id: number): Promise<(Item & { sourceName: string; analysis?: Analysis; drafts: Draft[] }) | undefined> {\n    const [itemResult] = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .where(eq(items.id, id));\n\n    if (!itemResult) return undefined;\n\n    const [analysisResult] = await db.select().from(analysis).where(eq(analysis.itemId, id));\n    const draftsResult = await db.select().from(drafts).where(eq(drafts.itemId, id)).orderBy(drafts.variant);\n\n    return {\n      ...itemResult.item,\n      sourceName: itemResult.sourceName || \"Unknown\",\n      analysis: analysisResult,\n      drafts: draftsResult,\n    } as any;\n  }\n\n  async getItemsByStatus(status: string, limit: number = 10): Promise<(Item & { sourceName: string; sourceTopic: string; rulesJson?: unknown })[]> {\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        sourceTopic: sources.topic,\n        rulesJson: sources.rulesJson,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .where(eq(items.status, status))\n      .orderBy(desc(items.insertedAt))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n      sourceTopic: r.sourceTopic || \"general\",\n      rulesJson: r.rulesJson,\n    })) as any;\n  }\n\n  async getItemsByStatusAndSourceIds(status: string, sourceIds: number[], limit: number = 50): Promise<(Item & { sourceName: string; sourceTopic: string; rulesJson?: unknown })[]> {\n    if (sourceIds.length === 0) return [];\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        sourceTopic: sources.topic,\n        rulesJson: sources.rulesJson,\n      })\n      .from(items)\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(\n        eq(items.status, status),\n        inArray(items.sourceId, sourceIds)\n      ))\n      .orderBy(desc(items.insertedAt))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      sourceName: r.sourceName || \"Unknown\",\n      sourceTopic: r.sourceTopic || \"general\",\n      rulesJson: r.rulesJson,\n    })) as any;\n  }\n\n  async createItem(data: InsertItem): Promise<Item> {\n    const [item] = await db.insert(items).values(data as any).returning();\n    return item as any;\n  }\n\n  async findItemByDedupeKey(sourceId: number, url: string): Promise<Item | undefined> {\n    const [item] = await db.select().from(items)\n      .where(and(eq(items.sourceId, sourceId), eq(items.url, url)))\n      .limit(1);\n    return item as any;\n  }\n\n  async updateItemStatus(id: number, status: string): Promise<void> {\n    await db.update(items).set({ status }).where(eq(items.id, id));\n  }\n\n  async createAnalysis(data: InsertAnalysis): Promise<Analysis> {\n    const [result] = await db.insert(analysis).values(data as any).returning();\n    return result as any;\n  }\n\n  async getAnalysisByItemId(itemId: number): Promise<Analysis | undefined> {\n    const [result] = await db.select().from(analysis).where(eq(analysis.itemId, itemId));\n    return result as any;\n  }\n\n  async getDrafts(decision?: string): Promise<(Draft & { itemTitle: string; itemUrl: string; sourceName: string })[]> {\n    let query = db\n      .select({\n        draft: drafts,\n        itemTitle: items.title,\n        itemUrl: items.url,\n        sourceName: sources.name,\n      })\n      .from(drafts)\n      .innerJoin(items, eq(drafts.itemId, items.id))\n      .leftJoin(sources, eq(items.sourceId, sources.id))\n      .orderBy(desc(drafts.createdAt));\n\n    if (decision && decision !== \"all\") {\n      query = query.where(eq(drafts.adminDecision, decision)) as any;\n    }\n\n    const result = await query;\n    return result.map((r) => ({\n      ...r.draft,\n      itemTitle: r.itemTitle || \"Untitled\",\n      itemUrl: r.itemUrl,\n      sourceName: r.sourceName || \"Unknown\",\n    })) as any;\n  }\n\n  async getDraftsByItemId(itemId: number): Promise<Draft[]> {\n    return db.select().from(drafts).where(eq(drafts.itemId, itemId)).orderBy(drafts.variant) as any;\n  }\n\n  async createDraft(data: InsertDraft): Promise<Draft> {\n    const [draft] = await db.insert(drafts).values(data as any).returning();\n    return draft as any;\n  }\n\n  async updateDraftDecision(id: number, decision: string, finalText?: string): Promise<void> {\n    await db.update(drafts).set({ adminDecision: decision, finalText }).where(eq(drafts.id, id));\n\n    const [draft] = await db.select({ itemId: drafts.itemId }).from(drafts).where(eq(drafts.id, id));\n\n    if (draft && decision === \"approved\") {\n      await db.update(items).set({ status: \"approved\" }).where(eq(items.id, draft.itemId));\n    }\n  }\n\n  async getReports(limit: number = 20): Promise<Report[]> {\n    return db.select().from(reports).orderBy(desc(reports.createdAt)).limit(limit) as any;\n  }\n\n  async getReport(id: number): Promise<Report | undefined> {\n    const [report] = await db.select().from(reports).where(eq(reports.id, id));\n    return report as any;\n  }\n\n  async createReport(data: InsertReport): Promise<Report> {\n    const [report] = await db.insert(reports).values(data as any).returning();\n    return report as any;\n  }\n\n  async getAnalyzedItemsForBrief(lookbackHours: number, limit: number, topic?: string): Promise<any[]> {\n    const cutoff = new Date(Date.now() - lookbackHours * 60 * 60 * 1000);\n\n    const conditions = [gte(items.insertedAt, cutoff)];\n\n    if (topic) {\n      conditions.push(eq(sources.topic, topic));\n    }\n\n    const result = await db\n      .select({\n        item: items,\n        sourceName: sources.name,\n        sourceUrl: sources.url,\n        sourceTopic: sources.topic,\n        analysisData: analysis,\n      })\n      .from(items)\n      .innerJoin(analysis, eq(items.id, analysis.itemId))\n      .innerJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(...conditions))\n      .orderBy(desc(analysis.relevanceScore))\n      .limit(limit);\n\n    return result.map((r) => ({\n      id: r.item.id,\n      title: r.item.title,\n      url: r.item.url,\n      source: r.sourceName || \"Unknown\",\n      topic: r.sourceTopic,\n      key_takeaway: r.analysisData.summaryShort,\n      why_it_matters: r.analysisData.suggestedAngle,\n      impact_scope: {\n        equities: r.analysisData.relevanceScore,\n        rates_fx: Math.floor(r.analysisData.relevanceScore * 0.7),\n        commodities: Math.floor(r.analysisData.relevanceScore * 0.5),\n        crypto: Math.floor(r.analysisData.relevanceScore * 0.8),\n      },\n      risk_flags: r.analysisData.riskFlagsJson || [],\n      confidence: r.analysisData.relevanceScore,\n      category: r.analysisData.category,\n    }));\n  }\n\n  async createThread(userId: string, title?: string): Promise<ChatThread> {\n    const [thread] = await db.insert(chatThreads).values({\n      userId,\n      title: title || null,\n    }).returning();\n    return thread as any;\n  }\n\n  async getThread(threadId: number, userId: string): Promise<ChatThread | null> {\n    const [thread] = await db.select().from(chatThreads)\n      .where(and(eq(chatThreads.id, threadId), eq(chatThreads.userId, userId)));\n    return (thread as any) || null;\n  }\n\n  async getUserThreads(userId: string): Promise<ChatThread[]> {\n    return db.select().from(chatThreads)\n      .where(eq(chatThreads.userId, userId))\n      .orderBy(desc(chatThreads.createdAt)) as any;\n  }\n\n  async setThreadActiveBot(threadId: number, userId: string, botId: number | null): Promise<void> {\n    await db.update(chatThreads)\n      .set({ activeBotId: botId })\n      .where(and(eq(chatThreads.id, threadId), eq(chatThreads.userId, userId)));\n  }\n\n  async getOrCreateDefaultThread(userId: string): Promise<ChatThread> {\n    const threads = await this.getUserThreads(userId);\n    if (threads.length > 0) return threads[0];\n    return this.createThread(userId, \"Default Thread\");\n  }\n\n  async listThreadMessages(threadId: number, userId: string, limit: number = 100): Promise<ChatMessage[]> {\n    const thread = await this.getThread(threadId, userId);\n    if (!thread) return [];\n    return db.select().from(chatMessages)\n      .where(and(eq(chatMessages.threadId, threadId), eq(chatMessages.userId, userId)))\n      .orderBy(desc(chatMessages.createdAt)).limit(limit) as any;\n  }\n\n  async addThreadMessage(data: InsertChatMessage): Promise<ChatMessage> {\n    const [msg] = await db.insert(chatMessages).values(data as any).returning();\n    return msg as any;\n  }\n\n  async updateChatMessageStatus(id: number, userId: string, status: string): Promise<void> {\n    await db.update(chatMessages)\n      .set({ status })\n      .where(and(eq(chatMessages.id, id), eq(chatMessages.userId, userId)));\n  }\n\n  async savePendingCommand(messageId: number, userId: string, commandJson: any): Promise<void> {\n    await db.update(chatMessages)\n      .set({ commandJson, kind: \"pending_command\", status: \"pending_confirm\" })\n      .where(and(eq(chatMessages.id, messageId), eq(chatMessages.userId, userId)));\n  }\n\n  async clearPendingCommand(messageId: number, userId: string): Promise<void> {\n    await db.update(chatMessages)\n      .set({ status: \"done\" })\n      .where(and(eq(chatMessages.id, messageId), eq(chatMessages.userId, userId)));\n  }\n\n  async getChatMessages(userId: string, limit: number = 50): Promise<ChatMessage[]> {\n    return db.select().from(chatMessages)\n      .where(eq(chatMessages.userId, userId))\n      .orderBy(desc(chatMessages.createdAt)).limit(limit) as any;\n  }\n\n  async createChatMessage(data: InsertChatMessage): Promise<ChatMessage> {\n    const [msg] = await db.insert(chatMessages).values(data as any).returning();\n    return msg as any;\n  }\n\n  async getSetting(key: string): Promise<string | undefined> {\n    const [row] = await db.select().from(settings).where(eq(settings.key, key));\n    return row?.value;\n  }\n\n  async setSetting(key: string, value: string): Promise<void> {\n    await db.insert(settings).values({ key, value }).onConflictDoUpdate({\n      target: settings.key,\n      set: { value, updatedAt: new Date() }\n    });\n  }\n\n  async listPresets(): Promise<Preset[]> {\n    return db.select().from(presets).orderBy(presets.name) as any;\n  }\n\n  async getPresetById(id: number): Promise<Preset | undefined> {\n    const [preset] = await db.select().from(presets).where(eq(presets.id, id));\n    return preset as any;\n  }\n\n  async listProfiles(userId: string): Promise<(Profile & { presetName: string })[]> {\n    const result = await db\n      .select({\n        profile: profiles,\n        presetName: presets.name,\n      })\n      .from(profiles)\n      .leftJoin(presets, eq(profiles.presetId, presets.id))\n      .where(eq(profiles.userId, userId))\n      .orderBy(desc(profiles.createdAt));\n\n    return result.map((r) => ({\n      ...r.profile,\n      presetName: r.presetName || \"Unknown\",\n    })) as any;\n  }\n\n  async getProfile(id: number, userId: string): Promise<(Profile & { presetName: string }) | undefined> {\n    const [result] = await db\n      .select({\n        profile: profiles,\n        presetName: presets.name,\n      })\n      .from(profiles)\n      .leftJoin(presets, eq(profiles.presetId, presets.id))\n      .where(and(eq(profiles.id, id), eq(profiles.userId, userId)));\n\n    if (!result) return undefined;\n\n    return {\n      ...result.profile,\n      presetName: result.presetName || \"Unknown\",\n    } as any;\n  }\n\n  async getProfileById(id: number): Promise<Profile | undefined> {\n    const [result] = await db\n      .select()\n      .from(profiles)\n      .where(eq(profiles.id, id));\n    return result as any;\n  }\n\n  async getProfileByUserAndTopic(userId: string, topic: string): Promise<Profile | undefined> {\n    const [result] = await db\n      .select()\n      .from(profiles)\n      .where(and(eq(profiles.userId, userId), eq(profiles.topic, topic)))\n      .orderBy(desc(profiles.createdAt))\n      .limit(1);\n    return result as any;\n  }\n\n  async createProfile(data: InsertProfile): Promise<Profile> {\n    const [profile] = await db.insert(profiles).values(data as any).returning();\n    return profile as any;\n  }\n\n  async updateProfile(id: number, userId: string, patch: Partial<InsertProfile>): Promise<Profile | undefined> {\n    const [profile] = await db\n      .update(profiles)\n      .set(patch as any)\n      .where(and(eq(profiles.id, id), eq(profiles.userId, userId)))\n      .returning();\n    return profile as any;\n  }\n\n  async deleteProfile(id: number, userId: string): Promise<void> {\n    await db.delete(profiles).where(and(eq(profiles.id, id), eq(profiles.userId, userId)));\n  }\n\n  async cloneProfile(id: number, userId: string): Promise<Profile | undefined> {\n    const existing = await this.getProfile(id, userId);\n    if (!existing) return undefined;\n\n    const newProfile = await this.createProfile({\n      userId: existing.userId,\n      presetId: existing.presetId,\n      name: `${existing.name} (Copy)`,\n      topic: existing.topic,\n      variantKey: existing.variantKey,\n      timezone: existing.timezone,\n      scheduleCron: existing.scheduleCron,\n      configJson: existing.configJson as Record<string, unknown>,\n      isActive: existing.isActive,\n    });\n\n    const existingSources = await this.getProfileSourcesWithWeight(id, userId);\n    if (existingSources.length > 0) {\n      await this.setProfileSources(\n        newProfile.id,\n        userId,\n        existingSources.map(s => ({ sourceId: s.id, weight: s.weight, isEnabled: s.isEnabled }))\n      );\n    }\n\n    return newProfile;\n  }\n\n  async listSources(userId: string, topic?: string): Promise<Source[]> {\n    const conditions = [\n      or(isNull(sources.userId), eq(sources.userId, userId))\n    ];\n\n    if (topic) {\n      conditions.push(eq(sources.topic, topic));\n    }\n\n    return db\n      .select()\n      .from(sources)\n      .where(and(...conditions))\n      .orderBy(desc(sources.isDefault), sources.name) as any;\n  }\n\n  async getUserSource(id: number, userId: string): Promise<Source | undefined> {\n    const [source] = await db\n      .select()\n      .from(sources)\n      .where(and(eq(sources.id, id), eq(sources.userId, userId)));\n    return source as any;\n  }\n\n  async createUserSource(userId: string, data: Omit<InsertSource, 'userId'>): Promise<Source> {\n    const [source] = await db.insert(sources).values({ ...data, userId } as any).returning();\n    return source as any;\n  }\n\n  async updateUserSource(userId: string, sourceId: number, patch: Partial<InsertSource>): Promise<Source | undefined> {\n    const [source] = await db\n      .update(sources)\n      .set(patch as any)\n      .where(and(eq(sources.id, sourceId), eq(sources.userId, userId)))\n      .returning();\n    return source as any;\n  }\n\n  async deleteUserSource(userId: string, sourceId: number): Promise<void> {\n    await db.delete(sources).where(and(eq(sources.id, sourceId), eq(sources.userId, userId)));\n  }\n\n  async getProfileSources(profileId: number, userId: string): Promise<Source[]> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return [];\n\n    const result = await db\n      .select({ source: sources })\n      .from(profileSources)\n      .innerJoin(sources, eq(profileSources.sourceId, sources.id))\n      .where(eq(profileSources.profileId, profileId));\n\n    return result.map(r => r.source) as any;\n  }\n\n  async getProfileSourcesWithWeight(profileId: number, userId: string): Promise<(Source & { weight: number; isEnabled: boolean })[]> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return [];\n\n    const result = await db\n      .select({\n        source: sources,\n        weight: profileSources.weight,\n        isEnabled: profileSources.isEnabled\n      })\n      .from(profileSources)\n      .innerJoin(sources, eq(profileSources.sourceId, sources.id))\n      .where(eq(profileSources.profileId, profileId))\n      .orderBy(desc(profileSources.weight));\n\n    return result.map(r => ({ ...r.source, weight: r.weight, isEnabled: r.isEnabled })) as any;\n  }\n\n  async setProfileSources(\n    profileId: number,\n    userId: string,\n    sourceData: Array<{ sourceId: number; weight?: number; isEnabled?: boolean }>\n  ): Promise<void> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return;\n\n    await db.delete(profileSources).where(eq(profileSources.profileId, profileId));\n\n    if (sourceData.length > 0) {\n      const sourceIds = sourceData.map(s => s.sourceId);\n\n      const validSources = await db\n        .select({ id: sources.id })\n        .from(sources)\n        .where(and(\n          inArray(sources.id, sourceIds),\n          eq(sources.topic, profile.topic)\n        ));\n\n      const validSourceIds = new Set(validSources.map(s => s.id));\n\n      if (validSourceIds.size !== sourceIds.length) {\n        console.warn(`[setProfileSources] Topic mismatch: ${sourceIds.length - validSourceIds.size} sources filtered out for profile ${profileId} (topic: ${profile.topic})`);\n      }\n\n      const validData = sourceData.filter(s => validSourceIds.has(s.sourceId));\n\n      if (validData.length > 0) {\n        await db.insert(profileSources).values(\n          validData.map(s => ({\n            profileId,\n            sourceId: s.sourceId,\n            weight: s.weight ?? 3,\n            isEnabled: s.isEnabled ?? true\n          }))\n        );\n      }\n    }\n  }\n\n  async updateProfileSourceWeight(profileId: number, userId: string, sourceId: number, weight: number): Promise<void> {\n    const profile = await this.getProfile(profileId, userId);\n    if (!profile) return;\n\n    await db.update(profileSources)\n      .set({ weight: Math.min(5, Math.max(1, weight)) })\n      .where(and(\n        eq(profileSources.profileId, profileId),\n        eq(profileSources.sourceId, sourceId)\n      ));\n  }\n\n  async getActiveReportProfiles(): Promise<(Profile & { presetOutputType: string })[]> {\n    const result = await db\n      .select({\n        profile: profiles,\n        presetOutputType: presets.outputType,\n      })\n      .from(profiles)\n      .innerJoin(presets, eq(profiles.presetId, presets.id))\n      .where(and(\n        eq(profiles.isActive, true),\n        eq(presets.outputType, \"report\")\n      ));\n\n    return result.map((r) => ({\n      ...r.profile,\n      presetOutputType: r.presetOutputType,\n    })) as any;\n  }\n\n  async getProfileSourceIds(profileId: number): Promise<number[]> {\n    const result = await db\n      .select({ sourceId: profileSources.sourceId })\n      .from(profileSources)\n      .where(eq(profileSources.profileId, profileId));\n\n    return result.map((r) => r.sourceId);\n  }\n\n  async getItemsForReport(\n    topic: string | null,\n    sourceIds: number[],\n    lookbackHours: number,\n    limit: number\n  ): Promise<(Item & { importanceScore: number; sourceName: string })[]> {\n    if (sourceIds.length === 0) return [];\n\n    const cutoff = new Date(Date.now() - lookbackHours * 60 * 60 * 1000);\n\n    const conditions = [\n      inArray(items.status, [\"analyzed\", \"drafted\", \"approved\"]),\n      inArray(items.sourceId, sourceIds),\n      gte(items.publishedAt, cutoff),\n    ];\n    if (topic) {\n      conditions.push(eq(items.topic, topic));\n    }\n\n    const result = await db\n      .select({\n        item: items,\n        importanceScore: analysis.importanceScore,\n        sourceName: sources.name,\n      })\n      .from(items)\n      .innerJoin(analysis, eq(items.id, analysis.itemId))\n      .innerJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(...conditions))\n      .orderBy(desc(analysis.importanceScore))\n      .limit(limit);\n\n    return result.map((r) => ({\n      ...r.item,\n      importanceScore: r.importanceScore,\n      sourceName: r.sourceName,\n    })) as any;\n  }\n\n  async listAnalyzedItemsForReport(params: {\n    topic?: string | null;\n    sourceIds: number[];\n    periodStart: Date;\n    periodEnd: Date;\n    limit?: number;\n  }): Promise<Array<{\n    id: number;\n    title: string | null;\n    url: string;\n    sourceName: string;\n    publishedAt: Date | null;\n    relevanceScore: number | null;\n    replyWorthinessScore: number | null;\n    summaryShort: string;\n  }>> {\n    if (!params.sourceIds.length) return [];\n\n    const limit = params.limit ?? 50;\n\n    const rows = await db\n      .select({\n        id: items.id,\n        title: items.title,\n        url: items.url,\n        sourceName: sources.name,\n        publishedAt: items.publishedAt,\n        relevanceScore: analysis.relevanceScore,\n        replyWorthinessScore: analysis.replyWorthinessScore,\n        summaryShort: analysis.summaryShort,\n      })\n      .from(items)\n      .innerJoin(analysis, eq(analysis.itemId, items.id))\n      .innerJoin(sources, eq(sources.id, items.sourceId))\n      .where(\n        and(\n          ...(params.topic ? [eq(items.topic, params.topic)] : []),\n          inArray(items.sourceId, params.sourceIds),\n          eq(items.status, \"analyzed\"),\n          gte(items.publishedAt, params.periodStart),\n          lte(items.publishedAt, params.periodEnd)\n        )\n      )\n      .orderBy(desc(analysis.relevanceScore))\n      .limit(limit);\n\n    return rows as any;\n  }\n\n  async outputExists(profileId: number, periodStart: Date, periodEnd: Date): Promise<boolean> {\n    const windowStart = new Date(periodEnd.getTime() - 23 * 60 * 60 * 1000);\n    const rows = await db\n      .select({ id: outputs.id })\n      .from(outputs)\n      .where(and(\n        eq(outputs.profileId, profileId),\n        gte(outputs.createdAt, windowStart),\n      ))\n      .limit(1);\n\n    return rows.length > 0;\n  }\n\n  async createOutputRecord(data: InsertOutput): Promise<Output> {\n    const [output] = await db.insert(outputs).values(data as any).returning();\n    return output as any;\n  }\n\n  async linkOutputItems(outputId: number, itemIds: number[]): Promise<void> {\n    if (itemIds.length === 0) return;\n\n    await db.insert(outputItems).values(\n      itemIds.map((itemId) => ({\n        outputId,\n        itemId,\n      }))\n    );\n  }\n\n  async listOutputs(params: { userId: string; profileId?: number; from?: Date; to?: Date }): Promise<Output[]> {\n    const conditions = [\n      eq(outputs.userId, params.userId),\n      eq(outputs.outputType, \"report\")\n    ];\n\n    if (params.profileId) {\n      conditions.push(eq(outputs.profileId, params.profileId));\n    }\n    if (params.from) {\n      conditions.push(gte(outputs.createdAt, params.from));\n    }\n    if (params.to) {\n      conditions.push(lte(outputs.createdAt, params.to));\n    }\n\n    return db\n      .select()\n      .from(outputs)\n      .where(and(...conditions))\n      .orderBy(desc(outputs.createdAt))\n      .limit(50) as any;\n  }\n\n  async getOutputById(params: { userId: string; outputId: number }): Promise<Output | null> {\n    const rows = await db\n      .select()\n      .from(outputs)\n      .where(and(\n        eq(outputs.id, params.outputId),\n        eq(outputs.userId, params.userId),\n        eq(outputs.outputType, \"report\")\n      ))\n      .limit(1);\n\n    return (rows[0] as any) ?? null;\n  }\n\n  async updateOutputContent(outputId: number, patch: { contentText: string; title: string; reportStage: string }): Promise<Output | null> {\n    const [updated] = await db\n      .update(outputs)\n      .set({ ...patch, updatedAt: new Date() })\n      .where(eq(outputs.id, outputId))\n      .returning();\n    return (updated as any) ?? null;\n  }\n\n  async getRecentItemsBySourceIds(sourceIds: number[], lookbackHours: number, limit: number): Promise<{ id: number; title: string | null; url: string; status: string; sourceName: string; sourceTopic: string; publishedAt: Date | null }[]> {\n    if (sourceIds.length === 0) return [];\n    const cutoff = new Date(Date.now() - lookbackHours * 60 * 60 * 1000);\n    const result = await db\n      .select({\n        id: items.id,\n        title: items.title,\n        url: items.url,\n        status: items.status,\n        sourceName: sources.name,\n        sourceTopic: sources.topic,\n        publishedAt: items.publishedAt,\n      })\n      .from(items)\n      .innerJoin(sources, eq(items.sourceId, sources.id))\n      .where(and(\n        inArray(items.sourceId, sourceIds),\n        gte(items.publishedAt, cutoff),\n      ))\n      .orderBy(desc(items.publishedAt))\n      .limit(limit);\n    return result as any;\n  }\n\n  async updateProfileLastRunAt(profileId: number, runAt: Date): Promise<void> {\n    await db\n      .update(profiles)\n      .set({ lastRunAt: runAt })\n      .where(eq(profiles.id, profileId));\n  }\n\n  async listBots(userId: string): Promise<(Bot & { settings: BotSettings | null })[]> {\n    const botsData = await db\n      .select()\n      .from(bots)\n      .where(eq(bots.userId, userId))\n      .orderBy(desc(bots.createdAt));\n\n    const result: (Bot & { settings: BotSettings | null })[] = [];\n    for (const bot of botsData) {\n      const [s] = await db\n        .select()\n        .from(botSettings)\n        .where(eq(botSettings.botId, bot.id))\n        .limit(1);\n      result.push({ ...bot, settings: s ?? null } as any);\n    }\n    return result;\n  }\n\n  async getBot(id: number, userId: string): Promise<(Bot & { settings: BotSettings | null }) | undefined> {\n    const [bot] = await db\n      .select()\n      .from(bots)\n      .where(and(eq(bots.id, id), eq(bots.userId, userId)))\n      .limit(1);\n\n    if (!bot) return undefined;\n\n    const [s] = await db\n      .select()\n      .from(botSettings)\n      .where(eq(botSettings.botId, bot.id))\n      .limit(1);\n\n    return { ...bot, settings: s ?? null } as any;\n  }\n\n  async getBotByKey(userId: string, key: string): Promise<Bot | undefined> {\n    const [bot] = await db\n      .select()\n      .from(bots)\n      .where(and(eq(bots.userId, userId), eq(bots.key, key)))\n      .limit(1);\n    return bot as any;\n  }\n\n  async createBot(data: InsertBot): Promise<Bot> {\n    const [bot] = await db.insert(bots).values(data as any).returning();\n    return bot as any;\n  }\n\n  async updateBot(id: number, userId: string, patch: Partial<InsertBot>): Promise<Bot | undefined> {\n    const [updated] = await db\n      .update(bots)\n      .set(patch as any)\n      .where(and(eq(bots.id, id), eq(bots.userId, userId)))\n      .returning();\n    return updated as any;\n  }\n\n  async deleteBot(id: number, userId: string): Promise<void> {\n    await db.delete(bots).where(and(eq(bots.id, id), eq(bots.userId, userId)));\n  }\n\n  async getBotSettings(botId: number): Promise<BotSettings | undefined> {\n    const [s] = await db\n      .select()\n      .from(botSettings)\n      .where(eq(botSettings.botId, botId))\n      .limit(1);\n    return s as any;\n  }\n\n  async createBotSettings(data: InsertBotSettings): Promise<BotSettings> {\n    const [s] = await db.insert(botSettings).values(data as any).returning();\n    return s as any;\n  }\n\n  async updateBotSettings(botId: number, patch: Partial<Omit<InsertBotSettings, 'botId'>>): Promise<BotSettings | undefined> {\n    const [updated] = await db\n      .update(botSettings)\n      .set({ ...patch, updatedAt: new Date() } as any)\n      .where(eq(botSettings.botId, botId))\n      .returning();\n    return updated as any;\n  }\n\n  async upsertBotSettings(userId: string, botId: number, input: Partial<Omit<InsertBotSettings, 'botId'>>): Promise<BotSettings> {\n    const bot = await this.getBot(botId, userId);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    const existing = await this.getBotSettings(botId);\n    if (existing) {\n      const updated = await this.updateBotSettings(botId, input);\n      return updated!;\n    } else {\n      return this.createBotSettings({ botId, ...input } as InsertBotSettings);\n    }\n  }\n\n  async getBotSources(botId: number): Promise<(Source & { weight: number; isEnabled: boolean })[]> {\n    const links = await db\n      .select({\n        source: sources,\n        weight: sourceBotLinks.weight,\n        isEnabled: sourceBotLinks.isEnabled,\n      })\n      .from(sourceBotLinks)\n      .innerJoin(sources, eq(sourceBotLinks.sourceId, sources.id))\n      .where(eq(sourceBotLinks.botId, botId));\n\n    return links.map(({ source, weight, isEnabled }) => ({\n      ...source,\n      weight,\n      isEnabled,\n    })) as any;\n  }\n\n  async setBotSources(botId: number, userId: string, sourceData: Array<{ sourceId: number; weight?: number; isEnabled?: boolean }>): Promise<void> {\n    const [bot] = await db.select().from(bots).where(and(eq(bots.id, botId), eq(bots.userId, userId))).limit(1);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    if (sourceData.length > 0) {\n      const sourceIds = sourceData.map(s => s.sourceId);\n      const validSources = await db.select({ id: sources.id })\n        .from(sources)\n        .where(and(\n          inArray(sources.id, sourceIds),\n          or(eq(sources.userId, userId), isNull(sources.userId))\n        ));\n      const validIds = new Set(validSources.map(s => s.id));\n      const invalid = sourceIds.filter(id => !validIds.has(id));\n      if (invalid.length > 0) {\n        throw new Error(`Source IDs not accessible: ${invalid.join(', ')}`);\n      }\n    }\n\n    await db.delete(sourceBotLinks).where(eq(sourceBotLinks.botId, botId));\n\n    if (sourceData.length > 0) {\n      await db.insert(sourceBotLinks).values(\n        sourceData.map(({ sourceId, weight = 3, isEnabled = true }) => ({\n          botId,\n          sourceId,\n          weight,\n          isEnabled,\n        }))\n      );\n    }\n  }\n\n  async addSourceToBot(botId: number, userId: string, sourceId: number, weight: number = 3): Promise<void> {\n    const [bot] = await db.select().from(bots).where(and(eq(bots.id, botId), eq(bots.userId, userId))).limit(1);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    const [source] = await db.select().from(sources).where(and(\n      eq(sources.id, sourceId),\n      or(eq(sources.userId, userId), isNull(sources.userId))\n    )).limit(1);\n    if (!source) throw new Error(\"Source not found or access denied\");\n\n    const [existing] = await db.select().from(sourceBotLinks)\n      .where(and(eq(sourceBotLinks.botId, botId), eq(sourceBotLinks.sourceId, sourceId))).limit(1);\n    if (existing) return;\n\n    await db.insert(sourceBotLinks).values({ botId, sourceId, weight, isEnabled: true });\n  }\n\n  async removeSourceFromBot(botId: number, userId: string, sourceId: number): Promise<void> {\n    const [bot] = await db.select().from(bots).where(and(eq(bots.id, botId), eq(bots.userId, userId))).limit(1);\n    if (!bot) throw new Error(\"Bot not found or access denied\");\n\n    await db.delete(sourceBotLinks).where(and(\n      eq(sourceBotLinks.botId, botId),\n      eq(sourceBotLinks.sourceId, sourceId)\n    ));\n  }\n\n  async ensureDefaultBots(userId: string): Promise<Bot[]> {\n    const existingBots = await db.select().from(bots).where(eq(bots.userId, userId));\n    if (existingBots.length > 0) {\n      return existingBots as any;\n    }\n\n    const defaultBots = [\n      { key: \"ai_art\", name: \"AI Art Monitor\" },\n      { key: \"investing\", name: \"Investing Brief\" },\n    ];\n\n    const createdBots: Bot[] = [];\n    for (const botDef of defaultBots) {\n      const [bot] = await db.insert(bots).values({\n        userId,\n        key: botDef.key,\n        name: botDef.name,\n        isEnabled: true,\n      }).returning();\n\n      await db.insert(botSettings).values({\n        botId: bot.id,\n        timezone: \"Asia/Seoul\",\n        scheduleRule: \"DAILY\",\n        scheduleTimeLocal: \"07:00\",\n        format: \"clean\",\n        markdownLevel: \"minimal\",\n        verbosity: \"normal\",\n        sectionsJson: { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n        filtersJson: { minImportanceScore: 0, maxRiskLevel: 100 },\n      } as any);\n\n      const defaultSources = await db\n        .select()\n        .from(sources)\n        .where(and(eq(sources.isDefault, true), eq(sources.topic, botDef.key)));\n\n      if (defaultSources.length > 0) {\n        await db.insert(sourceBotLinks).values(\n          defaultSources.map(s => ({\n            botId: bot.id,\n            sourceId: s.id,\n            weight: 3,\n            isEnabled: true,\n          }))\n        );\n      }\n\n      const matchingPreset = await db.select().from(presets).where(eq(presets.key, botDef.key === \"investing\" ? \"daily_market_brief\" : botDef.key === \"ai_art\" ? \"news_briefing\" : botDef.key)).limit(1);\n      const presetId = matchingPreset[0]?.id ?? null;\n\n      await db.insert(profiles).values({\n        userId,\n        presetId,\n        name: botDef.name,\n        topic: botDef.key,\n        timezone: \"Asia/Seoul\",\n        scheduleCron: \"0 7 * * *\",\n        configJson: {\n          sections: { tldr: true, drivers: true, risk: true, checklist: true, sources: true },\n          filters: { minImportanceScore: 0, maxRiskLevel: 100 },\n          verbosity: \"normal\",\n          markdownLevel: \"minimal\",\n        },\n        isActive: true,\n      } as any);\n\n      createdBots.push(bot as any);\n    }\n\n    return createdBots;\n  }\n\n  async createLlmProvider(data: InsertLlmProvider): Promise<LlmProvider> {\n    const [provider] = await db.insert(llmProviders).values(data as any).returning();\n    return provider as any;\n  }\n\n  async listLlmProviders(userId: string): Promise<LlmProvider[]> {\n    return db.select().from(llmProviders).where(eq(llmProviders.userId, userId)).orderBy(desc(llmProviders.createdAt)) as any;\n  }\n\n  async listAllLlmProviders(): Promise<LlmProvider[]> {\n    return db.select().from(llmProviders).orderBy(desc(llmProviders.createdAt)) as any;\n  }\n\n  async getLlmProvider(id: number, userId: string): Promise<LlmProvider | undefined> {\n    const [provider] = await db.select().from(llmProviders).where(and(eq(llmProviders.id, id), eq(llmProviders.userId, userId)));\n    return provider as any;\n  }\n\n  async updateLlmProvider(id: number, userId: string, patch: Partial<Omit<InsertLlmProvider, 'userId'>>): Promise<LlmProvider | undefined> {\n    const [updated] = await db.update(llmProviders)\n      .set(patch as any)\n      .where(and(eq(llmProviders.id, id), eq(llmProviders.userId, userId)))\n      .returning();\n    return updated as any;\n  }\n\n  async deleteLlmProvider(id: number, userId: string): Promise<void> {\n    await db.delete(llmProviders).where(and(eq(llmProviders.id, id), eq(llmProviders.userId, userId)));\n  }\n\n  async resolveLLMForBot(botId: number): Promise<{ providerType: string; apiKey: string; baseUrl: string | null; model: string | null } | null> {\n    const [setting] = await db.select().from(botSettings).where(eq(botSettings.botId, botId));\n\n    if (setting?.llmProviderId) {\n      const [provider] = await db.select().from(llmProviders).where(eq(llmProviders.id, setting.llmProviderId));\n      if (provider) {\n        return {\n          providerType: provider.providerType,\n          apiKey: decrypt(provider.apiKeyEncrypted),\n          baseUrl: provider.baseUrl,\n          model: setting.modelOverride || provider.defaultModel,\n        };\n      }\n    }\n\n    const [bot] = await db.select().from(bots).where(eq(bots.id, botId));\n    if (bot?.userId) {\n      const userProviders = await db.select().from(llmProviders).where(eq(llmProviders.userId, bot.userId)).limit(1);\n      if (userProviders.length > 0) {\n        const provider = userProviders[0];\n        return {\n          providerType: provider.providerType,\n          apiKey: decrypt(provider.apiKeyEncrypted),\n          baseUrl: provider.baseUrl,\n          model: provider.defaultModel,\n        };\n      }\n    }\n\n    return null;\n  }\n\n  async findSourceByUrl(url: string): Promise<Source | undefined> {\n    const [source] = await db.select().from(sources).where(eq(sources.url, url));\n    return source as any;\n  }\n\n  async createBotFromPreset(params: {\n    userId: string;\n    key: string;\n    name: string;\n    settings: Partial<Omit<InsertBotSettings, 'botId'>>;\n    sourceData: Array<{ name: string; url: string; type?: string; topic: string }>;\n  }): Promise<Bot> {\n    return await db.transaction(async (tx: any) => {\n      const [bot] = await tx.insert(bots).values({\n        userId: params.userId,\n        key: params.key,\n        name: params.name,\n        isEnabled: true,\n      }).returning();\n\n      await tx.insert(botSettings).values({\n        botId: bot.id,\n        ...params.settings,\n      } as any);\n\n      if (params.sourceData.length > 0) {\n        const sourceLinks: Array<{ botId: number; sourceId: number; weight: number; isEnabled: boolean }> = [];\n        for (const sd of params.sourceData) {\n          const [existing] = await tx.select().from(sources).where(eq(sources.url, sd.url)).limit(1);\n          let sourceId: number;\n          if (existing) {\n            sourceId = existing.id;\n          } else {\n            const [created] = await tx.insert(sources).values({\n              userId: null,\n              name: sd.name,\n              type: sd.type || \"rss\",\n              url: sd.url,\n              topic: sd.topic,\n              isDefault: false,\n              enabled: true,\n            }).returning();\n            sourceId = created.id;\n          }\n          sourceLinks.push({ botId: bot.id, sourceId, weight: 3, isEnabled: true });\n        }\n        if (sourceLinks.length > 0) {\n          await tx.insert(sourceBotLinks).values(sourceLinks);\n        }\n      }\n\n      return bot as Bot;\n    });\n  }\n\n  async getBotByUserAndKey(userId: string, key: string): Promise<Bot | undefined> {\n    const [bot] = await db.select().from(bots)\n      .where(and(eq(bots.userId, userId), eq(bots.key, key)));\n    return bot as any;\n  }\n\n  async resolveLLMForProfile(userId: string, topic: string): Promise<{ providerType: string; apiKey: string; baseUrl: string | null; model: string | null } | null> {\n    const bot = await this.getBotByUserAndKey(userId, topic);\n    if (!bot) return null;\n    return this.resolveLLMForBot(bot.id);\n  }\n\n  async createJobRun(data: Omit<InsertJobRun, 'id'>): Promise<JobRun> {\n    const [run] = await db.insert(jobRuns).values(data as any).returning();\n    return run as any;\n  }\n\n  async finishJobRun(id: number, patch: Partial<InsertJobRun>): Promise<JobRun | null> {\n    const [run] = await db.update(jobRuns).set(patch as any).where(eq(jobRuns.id, id)).returning();\n    return (run as any) || null;\n  }\n\n  async listJobRunsForBot(userId: string, botId: number, limit: number = 20): Promise<JobRun[]> {\n    return db.select().from(jobRuns)\n      .where(and(eq(jobRuns.userId, userId), eq(jobRuns.botId, botId)))\n      .orderBy(desc(jobRuns.startedAt))\n      .limit(limit) as any;\n  }\n\n  async getLastJobRunForBot(userId: string, botId: number): Promise<JobRun | null> {\n    const [run] = await db.select().from(jobRuns)\n      .where(and(eq(jobRuns.userId, userId), eq(jobRuns.botId, botId)))\n      .orderBy(desc(jobRuns.startedAt))\n      .limit(1);\n    return (run as any) || null;\n  }\n\n  async getLastJobRunByBotKey(userId: string, botKey: string): Promise<JobRun | null> {\n    const [run] = await db.select().from(jobRuns)\n      .where(and(eq(jobRuns.userId, userId), eq(jobRuns.botKey, botKey)))\n      .orderBy(desc(jobRuns.startedAt))\n      .limit(1);\n    return (run as any) || null;\n  }\n\n  async listPermissions(userId: string, scope: string, scopeId: number | null): Promise<Permission[]> {\n    const conditions = [eq(permissions.userId, userId), eq(permissions.scope, scope)];\n    if (scopeId != null) {\n      conditions.push(eq(permissions.scopeId, scopeId));\n    } else {\n      conditions.push(isNull(permissions.scopeId));\n    }\n    return db.select().from(permissions).where(and(...conditions)) as any;\n  }\n\n  async upsertPermission(userId: string, scope: string, scopeId: number | null, permissionKey: string, valueJson: any): Promise<Permission> {\n    const existing = await db.select().from(permissions)\n      .where(and(\n        eq(permissions.userId, userId),\n        eq(permissions.scope, scope),\n        scopeId != null ? eq(permissions.scopeId, scopeId) : isNull(permissions.scopeId),\n        eq(permissions.permissionKey, permissionKey),\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const [updated] = await db.update(permissions)\n        .set({ valueJson, updatedAt: new Date() } as any)\n        .where(eq(permissions.id, existing[0].id))\n        .returning();\n      return updated as any;\n    }\n\n    const [created] = await db.insert(permissions)\n      .values({ userId, scope, scopeId, permissionKey, valueJson, updatedAt: new Date() } as any)\n      .returning();\n    return created as any;\n  }\n\n  async deletePermission(userId: string, scope: string, scopeId: number | null, permissionKey: string): Promise<void> {\n    await db.delete(permissions).where(and(\n      eq(permissions.userId, userId),\n      eq(permissions.scope, scope),\n      scopeId != null ? eq(permissions.scopeId, scopeId) : isNull(permissions.scopeId),\n      eq(permissions.permissionKey, permissionKey),\n    ));\n  }\n\n  async listAllUserPermissions(userId: string): Promise<Permission[]> {\n    return db.select().from(permissions)\n      .where(eq(permissions.userId, userId))\n      .orderBy(permissions.scope, permissions.permissionKey) as any;\n  }\n\n  async createAuditLog(entry: { userId: string; botId?: number | null; threadId?: string | null; eventType: string; permissionKey?: string | null; payloadJson?: any }): Promise<void> {\n    await db.insert(auditLogs).values({\n      userId: entry.userId,\n      botId: entry.botId ?? null,\n      threadId: entry.threadId ?? null,\n      eventType: entry.eventType,\n      permissionKey: entry.permissionKey ?? null,\n      payloadJson: entry.payloadJson ?? null,\n    } as any);\n  }\n\n  async listAuditLogs(userId: string, filters?: { botId?: number; eventType?: string; permissionKey?: string; limit?: number; since?: Date }): Promise<any[]> {\n    const conditions = [eq(auditLogs.userId, userId)];\n    if (filters?.botId) conditions.push(eq(auditLogs.botId, filters.botId));\n    if (filters?.eventType) conditions.push(eq(auditLogs.eventType, filters.eventType));\n    if (filters?.permissionKey) conditions.push(eq(auditLogs.permissionKey, filters.permissionKey));\n    if (filters?.since) conditions.push(gte(auditLogs.createdAt, filters.since));\n    return db.select().from(auditLogs)\n      .where(and(...conditions))\n      .orderBy(desc(auditLogs.createdAt))\n      .limit(filters?.limit ?? 50) as any;\n  }\n\n  async createReportMetric(data: { reportId: number; profileId: number; itemCount: number; keywordSummary: Record<string, number>; sourceDistribution: Record<string, number> }): Promise<any> {\n    const result = await db.insert(reportMetrics).values({\n      reportId: data.reportId,\n      profileId: data.profileId,\n      itemCount: data.itemCount,\n      keywordSummary: data.keywordSummary as any,\n      sourceDistribution: data.sourceDistribution as any,\n    }).returning();\n    return result[0];\n  }\n\n  async getReportMetricsForProfile(profileId: number, limit: number = 7): Promise<any[]> {\n    return db.select().from(reportMetrics)\n      .where(eq(reportMetrics.profileId, profileId))\n      .orderBy(desc(reportMetrics.createdAt))\n      .limit(limit);\n  }\n\n  async listRuleMemories(userId: string, scope: string, scopeId: number | null): Promise<RuleMemory[]> {\n    const conditions = [eq(ruleMemories.userId, userId), eq(ruleMemories.scope, scope)];\n    if (scopeId != null) {\n      conditions.push(eq(ruleMemories.scopeId, scopeId));\n    } else {\n      conditions.push(isNull(ruleMemories.scopeId));\n    }\n    return db.select().from(ruleMemories).where(and(...conditions)).orderBy(ruleMemories.key) as any;\n  }\n\n  async listAllUserRuleMemories(userId: string): Promise<RuleMemory[]> {\n    return db.select().from(ruleMemories)\n      .where(eq(ruleMemories.userId, userId))\n      .orderBy(ruleMemories.scope, ruleMemories.key) as any;\n  }\n\n  async upsertRuleMemory(userId: string, scope: string, scopeId: number | null, key: string, valueJson: any): Promise<RuleMemory> {\n    const existing = await db.select().from(ruleMemories)\n      .where(and(\n        eq(ruleMemories.userId, userId),\n        eq(ruleMemories.scope, scope),\n        scopeId != null ? eq(ruleMemories.scopeId, scopeId) : isNull(ruleMemories.scopeId),\n        eq(ruleMemories.key, key),\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const [updated] = await db.update(ruleMemories)\n        .set({ valueJson, updatedAt: new Date() } as any)\n        .where(eq(ruleMemories.id, existing[0].id))\n        .returning();\n      return updated as any;\n    }\n\n    const [created] = await db.insert(ruleMemories)\n      .values({ userId, scope, scopeId, key, valueJson, updatedAt: new Date() } as any)\n      .returning();\n    return created as any;\n  }\n\n  async deleteRuleMemory(userId: string, scope: string, scopeId: number | null, key: string): Promise<void> {\n    await db.delete(ruleMemories).where(and(\n      eq(ruleMemories.userId, userId),\n      eq(ruleMemories.scope, scope),\n      scopeId != null ? eq(ruleMemories.scopeId, scopeId) : isNull(ruleMemories.scopeId),\n      eq(ruleMemories.key, key),\n    ));\n  }\n\n  async getEffectiveRules(userId: string, botId: number | null): Promise<Record<string, any>> {\n    const globalRules = await this.listRuleMemories(userId, \"global\", null);\n    const botRules = botId ? await this.listRuleMemories(userId, \"bot\", botId) : [];\n\n    const merged: Record<string, any> = {};\n    for (const rule of globalRules) {\n      merged[rule.key] = rule.valueJson;\n    }\n    for (const rule of botRules) {\n      merged[rule.key] = rule.valueJson;\n    }\n    return merged;\n  }\n\n  async getTelegramLinkByUserId(_userId: string): Promise<any> { return null; }\n  async getTelegramLinkByChatId(_chatId: string): Promise<any> { return null; }\n  async createTelegramLink(_data: any): Promise<any> { throw new Error(\"Telegram linking not supported in local mode\"); }\n  async deleteTelegramLink(_userId: string): Promise<void> {}\n  async createLinkCode(_userId: string, _platform: string): Promise<string> { throw new Error(\"Link codes not supported in local mode\"); }\n  async consumeLinkCode(_code: string): Promise<any> { return null; }\n}\n","path":null,"size_bytes":51894,"size_tokens":null},"server/init-sqlite.ts":{"content":"import { sqliteRaw } from \"./db\";\nimport * as schema from \"../shared/schema.sqlite\";\n\nexport function initSqliteTables() {\n  if (!sqliteRaw) return;\n\n  const raw = sqliteRaw;\n\n  raw.exec(`\n    CREATE TABLE IF NOT EXISTS sessions (\n      sid TEXT PRIMARY KEY,\n      sess TEXT NOT NULL,\n      expire INTEGER NOT NULL\n    );\n    CREATE INDEX IF NOT EXISTS IDX_session_expire ON sessions(expire);\n\n    CREATE TABLE IF NOT EXISTS users (\n      id TEXT PRIMARY KEY,\n      email TEXT UNIQUE,\n      first_name TEXT,\n      last_name TEXT,\n      profile_image_url TEXT,\n      created_at INTEGER,\n      updated_at INTEGER\n    );\n\n    CREATE TABLE IF NOT EXISTS presets (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      key TEXT NOT NULL UNIQUE,\n      name TEXT NOT NULL,\n      output_type TEXT NOT NULL,\n      description TEXT,\n      variants_json TEXT NOT NULL DEFAULT '[]',\n      default_config_json TEXT NOT NULL DEFAULT '{}',\n      icon TEXT,\n      category TEXT,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS profiles (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      preset_id INTEGER NOT NULL REFERENCES presets(id),\n      name TEXT NOT NULL,\n      topic TEXT NOT NULL,\n      variant_key TEXT,\n      timezone TEXT NOT NULL DEFAULT 'Asia/Seoul',\n      schedule_cron TEXT NOT NULL DEFAULT '0 7 * * *',\n      config_json TEXT NOT NULL DEFAULT '{}',\n      is_active INTEGER NOT NULL DEFAULT 1,\n      last_run_at INTEGER,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS sources (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT REFERENCES users(id),\n      name TEXT NOT NULL,\n      type TEXT NOT NULL DEFAULT 'rss',\n      url TEXT NOT NULL UNIQUE,\n      topic TEXT NOT NULL DEFAULT 'ai_art',\n      trust_level TEXT NOT NULL DEFAULT 'medium',\n      region TEXT NOT NULL DEFAULT 'global',\n      rules_json TEXT NOT NULL DEFAULT '{}',\n      enabled INTEGER NOT NULL DEFAULT 1,\n      is_default INTEGER NOT NULL DEFAULT 0,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS bots (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      key TEXT NOT NULL,\n      name TEXT NOT NULL,\n      is_enabled INTEGER NOT NULL DEFAULT 1,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n    CREATE UNIQUE INDEX IF NOT EXISTS bots_user_key_unique ON bots(user_id, key);\n\n    CREATE TABLE IF NOT EXISTS llm_providers (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      name TEXT NOT NULL,\n      provider_type TEXT NOT NULL,\n      api_key_encrypted TEXT NOT NULL,\n      base_url TEXT,\n      default_model TEXT,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS bot_settings (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      bot_id INTEGER NOT NULL UNIQUE REFERENCES bots(id) ON DELETE CASCADE,\n      timezone TEXT NOT NULL DEFAULT 'Asia/Seoul',\n      schedule_rule TEXT NOT NULL DEFAULT 'DAILY',\n      schedule_time_local TEXT NOT NULL DEFAULT '07:00',\n      format TEXT NOT NULL DEFAULT 'clean',\n      markdown_level TEXT NOT NULL DEFAULT 'minimal',\n      verbosity TEXT NOT NULL DEFAULT 'normal',\n      sections_json TEXT NOT NULL DEFAULT '{\"tldr\":true,\"drivers\":true,\"risk\":true,\"checklist\":true,\"sources\":true}',\n      filters_json TEXT NOT NULL DEFAULT '{\"minImportanceScore\":0,\"maxRiskLevel\":100}',\n      llm_provider_id INTEGER REFERENCES llm_providers(id),\n      model_override TEXT,\n      updated_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS source_bot_links (\n      source_id INTEGER NOT NULL REFERENCES sources(id) ON DELETE CASCADE,\n      bot_id INTEGER NOT NULL REFERENCES bots(id) ON DELETE CASCADE,\n      is_enabled INTEGER NOT NULL DEFAULT 1,\n      weight INTEGER NOT NULL DEFAULT 3,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      PRIMARY KEY (source_id, bot_id)\n    );\n\n    CREATE TABLE IF NOT EXISTS profile_sources (\n      profile_id INTEGER NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,\n      source_id INTEGER NOT NULL REFERENCES sources(id) ON DELETE CASCADE,\n      weight INTEGER NOT NULL DEFAULT 3,\n      is_enabled INTEGER NOT NULL DEFAULT 1,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      PRIMARY KEY (profile_id, source_id)\n    );\n\n    CREATE TABLE IF NOT EXISTS items (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      source_id INTEGER REFERENCES sources(id),\n      topic TEXT NOT NULL DEFAULT 'ai_art',\n      external_id TEXT,\n      url TEXT NOT NULL UNIQUE,\n      title TEXT,\n      author TEXT,\n      content_text TEXT NOT NULL,\n      tags_json TEXT NOT NULL DEFAULT '[]',\n      status TEXT NOT NULL DEFAULT 'new',\n      published_at INTEGER,\n      collected_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      inserted_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS analysis (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      item_id INTEGER NOT NULL UNIQUE REFERENCES items(id),\n      topic TEXT NOT NULL DEFAULT 'ai_art',\n      category TEXT NOT NULL,\n      relevance_score INTEGER NOT NULL,\n      importance_score INTEGER NOT NULL DEFAULT 50,\n      risk_score INTEGER NOT NULL DEFAULT 0,\n      reply_worthiness_score INTEGER NOT NULL,\n      link_fit_score INTEGER NOT NULL,\n      risk_flags_json TEXT NOT NULL DEFAULT '[]',\n      recommended_action TEXT NOT NULL,\n      suggested_angle TEXT NOT NULL DEFAULT '',\n      summary_short TEXT NOT NULL,\n      summary_long TEXT NOT NULL,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS drafts (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      item_id INTEGER NOT NULL REFERENCES items(id),\n      variant TEXT NOT NULL,\n      draft_text TEXT NOT NULL,\n      includes_link INTEGER NOT NULL DEFAULT 0,\n      link_type TEXT NOT NULL DEFAULT 'none',\n      tone TEXT NOT NULL DEFAULT 'helpful',\n      admin_decision TEXT NOT NULL DEFAULT 'pending',\n      final_text TEXT,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS posts (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      draft_id INTEGER NOT NULL REFERENCES drafts(id),\n      posted_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      result_json TEXT NOT NULL DEFAULT '{}'\n    );\n\n    CREATE TABLE IF NOT EXISTS reports (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      profile_id INTEGER REFERENCES profiles(id),\n      topic TEXT NOT NULL DEFAULT 'ai_art',\n      title TEXT NOT NULL,\n      content TEXT NOT NULL,\n      items_count INTEGER NOT NULL DEFAULT 0,\n      item_ids_json TEXT NOT NULL DEFAULT '[]',\n      period_start INTEGER,\n      period_end INTEGER,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS outputs (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      profile_id INTEGER NOT NULL REFERENCES profiles(id),\n      preset_id INTEGER NOT NULL REFERENCES presets(id),\n      topic TEXT NOT NULL,\n      output_type TEXT NOT NULL,\n      title TEXT NOT NULL,\n      content_text TEXT NOT NULL,\n      report_stage TEXT NOT NULL DEFAULT 'full',\n      period_start INTEGER NOT NULL,\n      period_end INTEGER NOT NULL,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      updated_at INTEGER\n    );\n    CREATE UNIQUE INDEX IF NOT EXISTS outputs_uq_profile_period ON outputs(profile_id, period_start, period_end);\n    CREATE INDEX IF NOT EXISTS outputs_idx_profile ON outputs(profile_id);\n    CREATE INDEX IF NOT EXISTS outputs_idx_user ON outputs(user_id);\n    CREATE INDEX IF NOT EXISTS outputs_idx_topic ON outputs(topic);\n\n    CREATE TABLE IF NOT EXISTS output_items (\n      output_id INTEGER NOT NULL REFERENCES outputs(id) ON DELETE CASCADE,\n      item_id INTEGER NOT NULL REFERENCES items(id) ON DELETE CASCADE,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      PRIMARY KEY (output_id, item_id)\n    );\n    CREATE INDEX IF NOT EXISTS output_items_idx_output ON output_items(output_id);\n    CREATE INDEX IF NOT EXISTS output_items_idx_item ON output_items(item_id);\n\n    CREATE TABLE IF NOT EXISTS conversations (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      title TEXT NOT NULL,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS messages (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      conversation_id INTEGER NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,\n      role TEXT NOT NULL,\n      content TEXT NOT NULL,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS chat_threads (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      title TEXT,\n      active_bot_id INTEGER REFERENCES bots(id),\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS chat_messages (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      thread_id INTEGER REFERENCES chat_threads(id) ON DELETE CASCADE,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      role TEXT NOT NULL,\n      content_text TEXT NOT NULL,\n      kind TEXT DEFAULT 'text',\n      command_json TEXT,\n      result_json TEXT,\n      status TEXT DEFAULT 'done',\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS settings (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      key TEXT NOT NULL UNIQUE,\n      value TEXT NOT NULL,\n      updated_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n\n    CREATE TABLE IF NOT EXISTS job_runs (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      bot_id INTEGER REFERENCES bots(id),\n      bot_key TEXT NOT NULL,\n      job_type TEXT NOT NULL,\n      trigger TEXT NOT NULL,\n      status TEXT NOT NULL,\n      started_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      finished_at INTEGER,\n      duration_ms INTEGER,\n      items_collected INTEGER,\n      items_analyzed INTEGER,\n      output_id INTEGER,\n      report_stage TEXT,\n      error_code TEXT,\n      error_message TEXT,\n      error_detail_json TEXT DEFAULT '{}',\n      meta_json TEXT DEFAULT '{}'\n    );\n    CREATE INDEX IF NOT EXISTS idx_job_runs_user_bot ON job_runs(user_id, bot_id, started_at);\n    CREATE INDEX IF NOT EXISTS idx_job_runs_status ON job_runs(status, started_at);\n\n    CREATE TABLE IF NOT EXISTS permissions (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      scope TEXT NOT NULL,\n      scope_id INTEGER,\n      permission_key TEXT NOT NULL,\n      value_json TEXT NOT NULL,\n      updated_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n    CREATE UNIQUE INDEX IF NOT EXISTS permissions_scope_key_unique ON permissions(user_id, scope, scope_id, permission_key);\n    CREATE INDEX IF NOT EXISTS idx_permissions_user_scope ON permissions(user_id, scope, scope_id);\n\n    CREATE TABLE IF NOT EXISTS audit_logs (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      bot_id INTEGER REFERENCES bots(id),\n      thread_id TEXT,\n      event_type TEXT NOT NULL,\n      permission_key TEXT,\n      payload_json TEXT DEFAULT '{}',\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n    CREATE INDEX IF NOT EXISTS idx_audit_logs_user ON audit_logs(user_id, created_at);\n    CREATE INDEX IF NOT EXISTS idx_audit_logs_event ON audit_logs(event_type, created_at);\n\n    CREATE TABLE IF NOT EXISTS report_metrics (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      report_id INTEGER NOT NULL,\n      profile_id INTEGER NOT NULL,\n      item_count INTEGER NOT NULL DEFAULT 0,\n      keyword_summary TEXT NOT NULL DEFAULT '{}',\n      source_distribution TEXT NOT NULL DEFAULT '{}',\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n    CREATE INDEX IF NOT EXISTS idx_report_metrics_profile ON report_metrics(profile_id, created_at);\n\n    CREATE TABLE IF NOT EXISTS rule_memories (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      user_id TEXT NOT NULL REFERENCES users(id),\n      scope TEXT NOT NULL,\n      scope_id INTEGER,\n      key TEXT NOT NULL,\n      value_json TEXT NOT NULL,\n      created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000),\n      updated_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)\n    );\n    CREATE UNIQUE INDEX IF NOT EXISTS rule_memories_scope_key_unique ON rule_memories(user_id, scope, scope_id, key);\n    CREATE INDEX IF NOT EXISTS idx_rule_memories_user_scope ON rule_memories(user_id, scope, scope_id);\n  `);\n\n  console.log(\"[SQLite] All tables created successfully\");\n}\n","path":null,"size_bytes":12971,"size_tokens":null},"electron/main.ts":{"content":"import { app, BrowserWindow, shell, ipcMain } from \"electron\";\nimport path from \"path\";\nimport { spawn, fork, ChildProcess } from \"child_process\";\n\nlet mainWindow: BrowserWindow | null = null;\nlet serverProcess: ChildProcess | null = null;\n\nconst SERVER_PORT = 5000;\nconst HEALTH_URL = `http://127.0.0.1:${SERVER_PORT}/api/health`;\nconst isDev = !app.isPackaged;\n\nfunction getAppRoot(): string {\n  if (isDev) {\n    return path.join(__dirname, \"..\");\n  }\n  return app.getAppPath();\n}\n\nfunction getServerEntry(): string {\n  if (isDev) {\n    return path.join(__dirname, \"..\", \"server\", \"index.ts\");\n  }\n  return path.join(app.getAppPath(), \"dist\", \"server\", \"index.cjs\");\n}\n\nfunction getDataDir(): string {\n  return app.getPath(\"userData\");\n}\n\nfunction startServer(): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const entry = getServerEntry();\n    const dataDir = getDataDir();\n\n    const env: Record<string, string> = {\n      ...process.env as Record<string, string>,\n      MAKER_DB: \"sqlite\",\n      MAKER_DESKTOP: \"true\",\n      MAKER_SQLITE_PATH: path.join(dataDir, \"maker.db\"),\n      PORT: String(SERVER_PORT),\n      NODE_ENV: isDev ? \"development\" : \"production\",\n      SESSION_SECRET: process.env.SESSION_SECRET || \"maker-local-session-secret\",\n    };\n\n    console.log(`[electron] Server entry: ${entry}`);\n    console.log(`[electron] SQLite path: ${env.MAKER_SQLITE_PATH}`);\n\n    if (isDev) {\n      serverProcess = spawn(\"npx\", [\"tsx\", entry], {\n        env,\n        stdio: [\"pipe\", \"pipe\", \"pipe\"],\n        cwd: path.join(__dirname, \"..\"),\n      });\n    } else {\n      serverProcess = fork(entry, [], {\n        env,\n        stdio: [\"pipe\", \"pipe\", \"pipe\", \"ipc\"],\n      });\n    }\n\n    serverProcess.stdout?.on(\"data\", (data: Buffer) => {\n      const msg = data.toString();\n      console.log(`[server] ${msg}`);\n      if (msg.includes(\"serving on port\") || msg.includes(\"listening\")) {\n        resolve();\n      }\n    });\n\n    serverProcess.stderr?.on(\"data\", (data: Buffer) => {\n      console.error(`[server:err] ${data.toString()}`);\n    });\n\n    serverProcess.on(\"error\", (err: Error) => {\n      console.error(\"[server] Failed to start:\", err);\n      reject(err);\n    });\n\n    serverProcess.on(\"exit\", (code: number | null) => {\n      console.log(`[server] Exited with code ${code}`);\n      serverProcess = null;\n    });\n\n    setTimeout(() => resolve(), 8000);\n  });\n}\n\nasync function waitForHealth(maxRetries = 30, intervalMs = 500): Promise<boolean> {\n  for (let i = 0; i < maxRetries; i++) {\n    try {\n      const res = await fetch(HEALTH_URL);\n      if (res.ok) return true;\n    } catch {}\n    await new Promise((r) => setTimeout(r, intervalMs));\n  }\n  return false;\n}\n\nfunction createWindow(): void {\n  const preloadPath = isDev\n    ? path.join(__dirname, \"preload.js\")\n    : path.join(app.getAppPath(), \"dist\", \"electron\", \"preload.cjs\");\n\n  mainWindow = new BrowserWindow({\n    width: 1280,\n    height: 860,\n    minWidth: 900,\n    minHeight: 600,\n    title: \"Maker\",\n    webPreferences: {\n      preload: preloadPath,\n      contextIsolation: true,\n      nodeIntegration: false,\n    },\n  });\n\n  mainWindow.loadURL(`http://127.0.0.1:${SERVER_PORT}`);\n\n  mainWindow.webContents.setWindowOpenHandler(({ url }) => {\n    if (url.startsWith(\"http\")) {\n      shell.openExternal(url);\n    }\n    return { action: \"deny\" };\n  });\n\n  mainWindow.on(\"closed\", () => {\n    mainWindow = null;\n  });\n}\n\nipcMain.on(\"open-external\", (_event, url: string) => {\n  if (typeof url === \"string\" && url.startsWith(\"http\")) {\n    shell.openExternal(url);\n  }\n});\n\napp.whenReady().then(async () => {\n  console.log(\"[electron] Starting Maker desktop app...\");\n  console.log(`[electron] Data dir: ${getDataDir()}`);\n  console.log(`[electron] App path: ${app.getAppPath()}`);\n  console.log(`[electron] isDev: ${isDev}`);\n\n  try {\n    await startServer();\n    const healthy = await waitForHealth();\n    if (!healthy) {\n      console.warn(\"[electron] Server health check timed out, loading anyway...\");\n    }\n    createWindow();\n  } catch (err) {\n    console.error(\"[electron] Failed to start server:\", err);\n    app.quit();\n  }\n});\n\napp.on(\"window-all-closed\", () => {\n  if (serverProcess) {\n    serverProcess.kill(\"SIGTERM\");\n  }\n  app.quit();\n});\n\napp.on(\"before-quit\", () => {\n  if (serverProcess) {\n    serverProcess.kill(\"SIGTERM\");\n  }\n});\n","path":null,"size_bytes":4346,"size_tokens":null},"shared/schema.sqlite.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { sqliteTable, text, integer, uniqueIndex, index, primaryKey } from \"drizzle-orm/sqlite-core\";\n\nexport const sessions = sqliteTable(\"sessions\", {\n  sid: text(\"sid\").primaryKey(),\n  sess: text(\"sess\", { mode: \"json\" }).notNull(),\n  expire: integer(\"expire\", { mode: \"timestamp_ms\" }).notNull(),\n}, (table) => [index(\"IDX_session_expire\").on(table.expire)]);\n\nexport const users = sqliteTable(\"users\", {\n  id: text(\"id\").primaryKey(),\n  email: text(\"email\").unique(),\n  firstName: text(\"first_name\"),\n  lastName: text(\"last_name\"),\n  profileImageUrl: text(\"profile_image_url\"),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }),\n  updatedAt: integer(\"updated_at\", { mode: \"timestamp_ms\" }),\n});\n\nexport const presets = sqliteTable(\"presets\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  key: text(\"key\").notNull().unique(),\n  name: text(\"name\").notNull(),\n  outputType: text(\"output_type\").notNull(),\n  description: text(\"description\"),\n  variantsJson: text(\"variants_json\", { mode: \"json\" }).notNull().default(\"[]\"),\n  defaultConfigJson: text(\"default_config_json\", { mode: \"json\" }).notNull().default(\"{}\"),\n  icon: text(\"icon\"),\n  category: text(\"category\"),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const profiles = sqliteTable(\"profiles\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  presetId: integer(\"preset_id\").notNull().references(() => presets.id),\n  name: text(\"name\").notNull(),\n  topic: text(\"topic\").notNull(),\n  variantKey: text(\"variant_key\"),\n  timezone: text(\"timezone\").notNull().default(\"Asia/Seoul\"),\n  scheduleCron: text(\"schedule_cron\").notNull().default(\"0 7 * * *\"),\n  configJson: text(\"config_json\", { mode: \"json\" }).notNull().default(\"{}\"),\n  isActive: integer(\"is_active\", { mode: \"boolean\" }).notNull().default(true),\n  lastRunAt: integer(\"last_run_at\", { mode: \"timestamp_ms\" }),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const sources = sqliteTable(\"sources\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").references(() => users.id),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull().default(\"rss\"),\n  url: text(\"url\").notNull().unique(),\n  topic: text(\"topic\").notNull().default(\"ai_art\"),\n  trustLevel: text(\"trust_level\").notNull().default(\"medium\"),\n  region: text(\"region\").notNull().default(\"global\"),\n  rulesJson: text(\"rules_json\", { mode: \"json\" }).notNull().default(\"{}\"),\n  enabled: integer(\"enabled\", { mode: \"boolean\" }).notNull().default(true),\n  isDefault: integer(\"is_default\", { mode: \"boolean\" }).notNull().default(false),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const bots = sqliteTable(\"bots\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  key: text(\"key\").notNull(),\n  name: text(\"name\").notNull(),\n  isEnabled: integer(\"is_enabled\", { mode: \"boolean\" }).notNull().default(true),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (table) => [\n  uniqueIndex(\"bots_user_key_unique\").on(table.userId, table.key)\n]);\n\nexport const llmProviders = sqliteTable(\"llm_providers\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  name: text(\"name\").notNull(),\n  providerType: text(\"provider_type\").notNull(),\n  apiKeyEncrypted: text(\"api_key_encrypted\").notNull(),\n  baseUrl: text(\"base_url\"),\n  defaultModel: text(\"default_model\"),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const botSettings = sqliteTable(\"bot_settings\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  botId: integer(\"bot_id\").notNull().references(() => bots.id, { onDelete: \"cascade\" }).unique(),\n  timezone: text(\"timezone\").notNull().default(\"Asia/Seoul\"),\n  scheduleRule: text(\"schedule_rule\").notNull().default(\"DAILY\"),\n  scheduleTimeLocal: text(\"schedule_time_local\").notNull().default(\"07:00\"),\n  format: text(\"format\").notNull().default(\"clean\"),\n  markdownLevel: text(\"markdown_level\").notNull().default(\"minimal\"),\n  verbosity: text(\"verbosity\").notNull().default(\"normal\"),\n  sectionsJson: text(\"sections_json\", { mode: \"json\" }).notNull().default('{\"tldr\":true,\"drivers\":true,\"risk\":true,\"checklist\":true,\"sources\":true}'),\n  filtersJson: text(\"filters_json\", { mode: \"json\" }).notNull().default('{\"minImportanceScore\":0,\"maxRiskLevel\":100}'),\n  llmProviderId: integer(\"llm_provider_id\").references(() => llmProviders.id),\n  modelOverride: text(\"model_override\"),\n  updatedAt: integer(\"updated_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const sourceBotLinks = sqliteTable(\"source_bot_links\", {\n  sourceId: integer(\"source_id\").notNull().references(() => sources.id, { onDelete: \"cascade\" }),\n  botId: integer(\"bot_id\").notNull().references(() => bots.id, { onDelete: \"cascade\" }),\n  isEnabled: integer(\"is_enabled\", { mode: \"boolean\" }).notNull().default(true),\n  weight: integer(\"weight\").notNull().default(3),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (table) => [\n  primaryKey({ columns: [table.sourceId, table.botId] })\n]);\n\nexport const profileSources = sqliteTable(\"profile_sources\", {\n  profileId: integer(\"profile_id\").notNull().references(() => profiles.id, { onDelete: \"cascade\" }),\n  sourceId: integer(\"source_id\").notNull().references(() => sources.id, { onDelete: \"cascade\" }),\n  weight: integer(\"weight\").notNull().default(3),\n  isEnabled: integer(\"is_enabled\", { mode: \"boolean\" }).notNull().default(true),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (table) => [\n  primaryKey({ columns: [table.profileId, table.sourceId] })\n]);\n\nexport const items = sqliteTable(\"items\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  sourceId: integer(\"source_id\").references(() => sources.id),\n  topic: text(\"topic\").notNull().default(\"ai_art\"),\n  externalId: text(\"external_id\"),\n  url: text(\"url\").notNull().unique(),\n  title: text(\"title\"),\n  author: text(\"author\"),\n  contentText: text(\"content_text\").notNull(),\n  tagsJson: text(\"tags_json\", { mode: \"json\" }).notNull().default(\"[]\"),\n  status: text(\"status\").notNull().default(\"new\"),\n  publishedAt: integer(\"published_at\", { mode: \"timestamp_ms\" }),\n  collectedAt: integer(\"collected_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n  insertedAt: integer(\"inserted_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const analysis = sqliteTable(\"analysis\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  itemId: integer(\"item_id\").notNull().references(() => items.id).unique(),\n  topic: text(\"topic\").notNull().default(\"ai_art\"),\n  category: text(\"category\").notNull(),\n  relevanceScore: integer(\"relevance_score\").notNull(),\n  importanceScore: integer(\"importance_score\").notNull().default(50),\n  riskScore: integer(\"risk_score\").notNull().default(0),\n  replyWorthinessScore: integer(\"reply_worthiness_score\").notNull(),\n  linkFitScore: integer(\"link_fit_score\").notNull(),\n  riskFlagsJson: text(\"risk_flags_json\", { mode: \"json\" }).notNull().default(\"[]\"),\n  recommendedAction: text(\"recommended_action\").notNull(),\n  suggestedAngle: text(\"suggested_angle\").notNull().default(\"\"),\n  summaryShort: text(\"summary_short\").notNull(),\n  summaryLong: text(\"summary_long\").notNull(),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const drafts = sqliteTable(\"drafts\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  itemId: integer(\"item_id\").notNull().references(() => items.id),\n  variant: text(\"variant\").notNull(),\n  draftText: text(\"draft_text\").notNull(),\n  includesLink: integer(\"includes_link\", { mode: \"boolean\" }).notNull().default(false),\n  linkType: text(\"link_type\").notNull().default(\"none\"),\n  tone: text(\"tone\").notNull().default(\"helpful\"),\n  adminDecision: text(\"admin_decision\").notNull().default(\"pending\"),\n  finalText: text(\"final_text\"),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const posts = sqliteTable(\"posts\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  draftId: integer(\"draft_id\").notNull().references(() => drafts.id),\n  postedAt: integer(\"posted_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n  resultJson: text(\"result_json\", { mode: \"json\" }).notNull().default(\"{}\"),\n});\n\nexport const reports = sqliteTable(\"reports\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  profileId: integer(\"profile_id\").references(() => profiles.id),\n  topic: text(\"topic\").notNull().default(\"ai_art\"),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  itemsCount: integer(\"items_count\").notNull().default(0),\n  itemIdsJson: text(\"item_ids_json\", { mode: \"json\" }).notNull().default(\"[]\"),\n  periodStart: integer(\"period_start\", { mode: \"timestamp_ms\" }),\n  periodEnd: integer(\"period_end\", { mode: \"timestamp_ms\" }),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const outputs = sqliteTable(\"outputs\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  profileId: integer(\"profile_id\").notNull().references(() => profiles.id),\n  presetId: integer(\"preset_id\").notNull().references(() => presets.id),\n  topic: text(\"topic\").notNull(),\n  outputType: text(\"output_type\").notNull(),\n  title: text(\"title\").notNull(),\n  contentText: text(\"content_text\").notNull(),\n  reportStage: text(\"report_stage\").notNull().default(\"full\"),\n  periodStart: integer(\"period_start\", { mode: \"timestamp_ms\" }).notNull(),\n  periodEnd: integer(\"period_end\", { mode: \"timestamp_ms\" }).notNull(),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n  updatedAt: integer(\"updated_at\", { mode: \"timestamp_ms\" }),\n}, (t) => [\n  uniqueIndex(\"outputs_uq_profile_period\").on(t.profileId, t.periodStart, t.periodEnd),\n  index(\"outputs_idx_profile\").on(t.profileId),\n  index(\"outputs_idx_user\").on(t.userId),\n  index(\"outputs_idx_topic\").on(t.topic),\n]);\n\nexport const outputItems = sqliteTable(\"output_items\", {\n  outputId: integer(\"output_id\").notNull().references(() => outputs.id, { onDelete: \"cascade\" }),\n  itemId: integer(\"item_id\").notNull().references(() => items.id, { onDelete: \"cascade\" }),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (t) => [\n  primaryKey({ columns: [t.outputId, t.itemId] }),\n  index(\"output_items_idx_output\").on(t.outputId),\n  index(\"output_items_idx_item\").on(t.itemId),\n]);\n\nexport const conversations = sqliteTable(\"conversations\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  title: text(\"title\").notNull(),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const messages = sqliteTable(\"messages\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  conversationId: integer(\"conversation_id\").notNull().references(() => conversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(),\n  content: text(\"content\").notNull(),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const chatThreads = sqliteTable(\"chat_threads\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  title: text(\"title\"),\n  activeBotId: integer(\"active_bot_id\").references(() => bots.id),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const chatMessages = sqliteTable(\"chat_messages\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  threadId: integer(\"thread_id\").references(() => chatThreads.id, { onDelete: \"cascade\" }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  role: text(\"role\").notNull(),\n  contentText: text(\"content_text\").notNull(),\n  kind: text(\"kind\").default(\"text\"),\n  commandJson: text(\"command_json\", { mode: \"json\" }),\n  resultJson: text(\"result_json\", { mode: \"json\" }),\n  status: text(\"status\").default(\"done\"),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const settings = sqliteTable(\"settings\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  key: text(\"key\").notNull().unique(),\n  value: text(\"value\").notNull(),\n  updatedAt: integer(\"updated_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n});\n\nexport const jobRuns = sqliteTable(\"job_runs\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  botId: integer(\"bot_id\").references(() => bots.id),\n  botKey: text(\"bot_key\").notNull(),\n  jobType: text(\"job_type\").notNull(),\n  trigger: text(\"trigger\").notNull(),\n  status: text(\"status\").notNull(),\n  startedAt: integer(\"started_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n  finishedAt: integer(\"finished_at\", { mode: \"timestamp_ms\" }),\n  durationMs: integer(\"duration_ms\"),\n  itemsCollected: integer(\"items_collected\"),\n  itemsAnalyzed: integer(\"items_analyzed\"),\n  outputId: integer(\"output_id\"),\n  reportStage: text(\"report_stage\"),\n  errorCode: text(\"error_code\"),\n  errorMessage: text(\"error_message\"),\n  errorDetailJson: text(\"error_detail_json\", { mode: \"json\" }),\n  metaJson: text(\"meta_json\", { mode: \"json\" }),\n}, (table) => [\n  index(\"idx_job_runs_user_bot\").on(table.userId, table.botId, table.startedAt),\n  index(\"idx_job_runs_status\").on(table.status, table.startedAt),\n]);\n\nexport const permissions = sqliteTable(\"permissions\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  scope: text(\"scope\").notNull(),\n  scopeId: integer(\"scope_id\"),\n  permissionKey: text(\"permission_key\").notNull(),\n  valueJson: text(\"value_json\", { mode: \"json\" }).notNull(),\n  updatedAt: integer(\"updated_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (table) => [\n  uniqueIndex(\"permissions_scope_key_unique\").on(table.userId, table.scope, table.scopeId, table.permissionKey),\n  index(\"idx_permissions_user_scope\").on(table.userId, table.scope, table.scopeId),\n]);\n\nexport const auditLogs = sqliteTable(\"audit_logs\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  botId: integer(\"bot_id\").references(() => bots.id),\n  threadId: text(\"thread_id\"),\n  eventType: text(\"event_type\").notNull(),\n  permissionKey: text(\"permission_key\"),\n  payloadJson: text(\"payload_json\", { mode: \"json\" }),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (table) => [\n  index(\"idx_audit_logs_user\").on(table.userId, table.createdAt),\n  index(\"idx_audit_logs_event\").on(table.eventType, table.createdAt),\n]);\n\nexport const reportMetrics = sqliteTable(\"report_metrics\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  reportId: integer(\"report_id\").notNull(),\n  profileId: integer(\"profile_id\").notNull(),\n  itemCount: integer(\"item_count\").notNull().default(0),\n  keywordSummary: text(\"keyword_summary\", { mode: \"json\" }).notNull().default(\"{}\"),\n  sourceDistribution: text(\"source_distribution\", { mode: \"json\" }).notNull().default(\"{}\"),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (table) => [\n  index(\"idx_report_metrics_profile\").on(table.profileId, table.createdAt),\n]);\n\nexport const ruleMemories = sqliteTable(\"rule_memories\", {\n  id: integer(\"id\").primaryKey({ autoIncrement: true }),\n  userId: text(\"user_id\").notNull().references(() => users.id),\n  scope: text(\"scope\").notNull(),\n  scopeId: integer(\"scope_id\"),\n  key: text(\"key\").notNull(),\n  valueJson: text(\"value_json\", { mode: \"json\" }).notNull(),\n  createdAt: integer(\"created_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n  updatedAt: integer(\"updated_at\", { mode: \"timestamp_ms\" }).notNull().$defaultFn(() => new Date()),\n}, (table) => [\n  uniqueIndex(\"rule_memories_scope_key_unique\").on(table.userId, table.scope, table.scopeId, table.key),\n  index(\"idx_rule_memories_user_scope\").on(table.userId, table.scope, table.scopeId),\n]);\n","path":null,"size_bytes":17075,"size_tokens":null},"client/src/pages/permissions.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport { Shield, ShieldCheck, ShieldX, ShieldAlert, RotateCcw, Clock, Monitor, BarChart3, Search, Activity } from \"lucide-react\";\n\ntype ApprovalMode = \"AUTO_ALLOWED\" | \"APPROVAL_REQUIRED\" | \"AUTO_DENIED\";\ntype EgressLevel = \"NO_EGRESS\" | \"METADATA_ONLY\" | \"FULL_CONTENT_ALLOWED\";\n\nfunction useIsDesktop() {\n  return typeof window !== \"undefined\" && !!(window as any).electronAPI;\n}\n\ninterface EffectivePermission {\n  enabled: boolean;\n  approvalMode: ApprovalMode;\n  egressLevel?: EgressLevel;\n  source: \"default\" | \"global\" | \"bot\";\n  resourceScope?: Record<string, any>;\n}\n\ninterface PermissionKeyDef {\n  key: string;\n  labelEn: string;\n  labelKo: string;\n  descEn: string;\n  descKo: string;\n  risk: \"LOW\" | \"MED\" | \"HIGH\";\n  egressLevel?: EgressLevel;\n  localOnly?: boolean;\n}\n\ninterface PermissionGroupDef {\n  group: string;\n  keys: PermissionKeyDef[];\n}\n\nconst PERMISSION_GROUPS: PermissionGroupDef[] = [\n  {\n    group: \"web_sources\",\n    keys: [\n      { key: \"WEB_RSS\", labelEn: \"RSS Feed Collection\", labelKo: \"RSS 피드 수집\", descEn: \"Allow collecting content from RSS/Atom feeds\", descKo: \"RSS/Atom 피드에서 콘텐츠를 수집하도록 허용\", risk: \"LOW\" },\n      { key: \"WEB_FETCH\", labelEn: \"Web Page Fetching\", labelKo: \"웹 페이지 가져오기\", descEn: \"Allow fetching public web pages (including scraping/extraction)\", descKo: \"공개 웹 페이지 가져오기 허용 (스크래핑/본문 추출 포함)\", risk: \"MED\" },\n      { key: \"SOURCE_WRITE\", labelEn: \"Manage Sources\", labelKo: \"소스 관리\", descEn: \"Allow adding, editing, and deleting bot sources\", descKo: \"봇의 소스 추가/수정/삭제 허용\", risk: \"LOW\" },\n    ],\n  },\n  {\n    group: \"ai_data\",\n    keys: [\n      { key: \"LLM_USE\", labelEn: \"AI Provider Usage\", labelKo: \"AI 제공자 사용\", descEn: \"Allow using external AI/LLM APIs\", descKo: \"외부 AI/LLM API 사용 허용\", risk: \"MED\" },\n      { key: \"LLM_EGRESS_LEVEL\", labelEn: \"Data Sent to AI\", labelKo: \"AI로 전송되는 데이터\", descEn: \"Control what content is sent to AI providers\", descKo: \"AI 제공자에게 전송되는 콘텐츠 범위를 제어\", risk: \"HIGH\", egressLevel: \"METADATA_ONLY\" },\n    ],\n  },\n  {\n    group: \"files\",\n    keys: [\n      { key: \"FS_READ\", labelEn: \"Read Local Files\", labelKo: \"로컬 파일 읽기\", descEn: \"Allow reading files from selected folders\", descKo: \"선택한 폴더에서 파일 읽기 허용\", risk: \"MED\", localOnly: true },\n      { key: \"FS_WRITE\", labelEn: \"Write Local Files\", labelKo: \"로컬 파일 쓰기\", descEn: \"Allow creating and modifying files\", descKo: \"파일 생성/수정 허용\", risk: \"MED\", localOnly: true },\n      { key: \"FS_DELETE\", labelEn: \"Delete Files (Trash Only)\", labelKo: \"파일 삭제 (휴지통만)\", descEn: \"Allow moving files to trash\", descKo: \"파일을 휴지통으로 이동 허용\", risk: \"HIGH\", localOnly: true },\n    ],\n  },\n  {\n    group: \"calendar\",\n    keys: [\n      { key: \"CAL_READ\", labelEn: \"Read Calendar\", labelKo: \"캘린더 읽기\", descEn: \"Allow reading calendar events\", descKo: \"캘린더 이벤트 읽기 허용\", risk: \"LOW\", localOnly: true },\n      { key: \"CAL_WRITE\", labelEn: \"Create/Update Events\", labelKo: \"일정 생성/수정\", descEn: \"Allow creating and modifying events\", descKo: \"캘린더 이벤트 생성/수정 허용\", risk: \"MED\", localOnly: true },\n    ],\n  },\n  {\n    group: \"scheduling\",\n    keys: [\n      { key: \"SCHEDULE_WRITE\", labelEn: \"Modify Schedules\", labelKo: \"스케줄 변경\", descEn: \"Allow changing bot run schedules\", descKo: \"봇 실행 스케줄 변경 허용\", risk: \"LOW\" },\n    ],\n  },\n];\n\nconst APPROVAL_MODES: ApprovalMode[] = [\"AUTO_ALLOWED\", \"APPROVAL_REQUIRED\", \"AUTO_DENIED\"];\n\ninterface AuditLogEntry {\n  id: number;\n  userId: string;\n  botId: number | null;\n  threadId: string | null;\n  eventType: string;\n  permissionKey: string | null;\n  payloadJson: any;\n  createdAt: string;\n}\n\ninterface RiskScoreEntry {\n  botId: number;\n  botName: string;\n  score: number;\n  level: \"low\" | \"moderate\" | \"elevated\" | \"high\";\n  denials7d: number;\n  totalEvents7d: number;\n}\n\ninterface TimelineDay {\n  date: string;\n  denied: number;\n  approved: number;\n  changed: number;\n  requested: number;\n  total: number;\n}\n\ninterface TimelineData {\n  days: number;\n  timeline: TimelineDay[];\n  totalEvents: number;\n}\n\nfunction RiskBadge({ risk }: { risk: \"LOW\" | \"MED\" | \"HIGH\" }) {\n  const { t } = useLanguage();\n  const key = `perm.risk.${risk}` as any;\n  if (risk === \"HIGH\") return <Badge variant=\"destructive\" data-testid={`badge-risk-${risk}`}>{t(key)}</Badge>;\n  if (risk === \"MED\") return <Badge variant=\"secondary\" data-testid={`badge-risk-${risk}`}>{t(key)}</Badge>;\n  return <Badge variant=\"outline\" data-testid={`badge-risk-${risk}`}>{t(key)}</Badge>;\n}\n\nfunction SourceBadge({ source }: { source: \"default\" | \"global\" | \"bot\" }) {\n  const { t } = useLanguage();\n  const key = `perm.source.${source}` as any;\n  if (source === \"bot\") return <Badge variant=\"default\" data-testid={`badge-source-${source}`}>{t(key)}</Badge>;\n  if (source === \"global\") return <Badge variant=\"secondary\" data-testid={`badge-source-${source}`}>{t(key)}</Badge>;\n  return <Badge variant=\"outline\" data-testid={`badge-source-${source}`}>{t(key)}</Badge>;\n}\n\nfunction PermissionRow({\n  keyDef,\n  effective,\n  onUpdate,\n  onReset,\n  isUpdating,\n  isDesktop,\n}: {\n  keyDef: PermissionKeyDef;\n  effective: EffectivePermission | undefined;\n  onUpdate: (key: string, value: any) => void;\n  onReset: (key: string) => void;\n  isUpdating: boolean;\n  isDesktop: boolean;\n}) {\n  const { t, language } = useLanguage();\n  const label = language === \"ko\" ? keyDef.labelKo : keyDef.labelEn;\n  const desc = language === \"ko\" ? keyDef.descKo : keyDef.descEn;\n  const isEnabled = effective?.enabled ?? false;\n  const mode = effective?.approvalMode ?? \"AUTO_DENIED\";\n  const source = effective?.source ?? \"default\";\n  const isEgressKey = keyDef.key === \"LLM_EGRESS_LEVEL\";\n  const egressLevel = effective?.egressLevel ?? \"NO_EGRESS\";\n  const egressLevels: EgressLevel[] = isDesktop\n    ? [\"NO_EGRESS\", \"METADATA_ONLY\", \"FULL_CONTENT_ALLOWED\"]\n    : [\"NO_EGRESS\", \"METADATA_ONLY\"];\n\n  return (\n    <div className=\"flex flex-col gap-2 p-3 rounded-md border\" data-testid={`perm-row-${keyDef.key}`}>\n      <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n        <div className=\"flex items-center gap-2 min-w-0 flex-1 flex-wrap\">\n          <span className=\"font-medium text-sm\">{label}</span>\n          <RiskBadge risk={keyDef.risk} />\n          <SourceBadge source={source} />\n          {isDesktop && keyDef.localOnly && (\n            <Badge variant=\"outline\" className=\"text-[10px] gap-0.5\" data-testid={`local-badge-${keyDef.key}`}>\n              <Monitor className=\"w-2.5 h-2.5\" />\n              {t(\"pd.localOnly\")}\n            </Badge>\n          )}\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {source !== \"default\" && (\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={() => onReset(keyDef.key)}\n              disabled={isUpdating}\n              data-testid={`button-reset-${keyDef.key}`}\n            >\n              <RotateCcw className=\"w-3.5 h-3.5\" />\n            </Button>\n          )}\n          <Switch\n            checked={isEnabled}\n            onCheckedChange={(checked) =>\n              onUpdate(keyDef.key, {\n                enabled: checked,\n                approvalMode: checked ? \"AUTO_ALLOWED\" : \"AUTO_DENIED\",\n                ...(isEgressKey ? { egressLevel: checked ? \"METADATA_ONLY\" : \"NO_EGRESS\" } : {}),\n              })\n            }\n            disabled={isUpdating}\n            data-testid={`switch-${keyDef.key}`}\n          />\n        </div>\n      </div>\n      <p className=\"text-xs text-muted-foreground\">{desc}</p>\n      {isEnabled && !isEgressKey && (\n        <div className=\"flex items-center gap-2\">\n          <Select\n            value={mode}\n            onValueChange={(val: ApprovalMode) =>\n              onUpdate(keyDef.key, { enabled: true, approvalMode: val })\n            }\n            disabled={isUpdating}\n          >\n            <SelectTrigger className=\"w-[180px]\" data-testid={`select-mode-${keyDef.key}`}>\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {APPROVAL_MODES.map((m) => (\n                <SelectItem key={m} value={m} data-testid={`option-mode-${m}`}>\n                  {t(`perm.mode.${m}` as any)}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n      )}\n      {isEnabled && isEgressKey && (\n        <div className=\"flex flex-col gap-1\">\n          <div className=\"flex items-center gap-2\">\n            <Select\n              value={egressLevel}\n              onValueChange={(val: EgressLevel) =>\n                onUpdate(keyDef.key, { enabled: true, approvalMode: \"AUTO_ALLOWED\", egressLevel: val })\n              }\n              disabled={isUpdating}\n            >\n              <SelectTrigger className=\"w-[200px]\" data-testid={`select-egress-${keyDef.key}`}>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {egressLevels.map((lvl) => (\n                  <SelectItem key={lvl} value={lvl} data-testid={`option-egress-${lvl}`}>\n                    {t(`perm.egress.${lvl}` as any)}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          {!isDesktop && (\n            <p className=\"text-xs text-muted-foreground\">{t(\"pd.egressWebNote\")}</p>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction RiskScoreCircle({ score, level }: { score: number; level: string }) {\n  const circumference = 2 * Math.PI * 36;\n  const offset = circumference - (score / 100) * circumference;\n  const colorMap: Record<string, string> = {\n    low: \"stroke-green-500\",\n    moderate: \"stroke-yellow-500\",\n    elevated: \"stroke-orange-500\",\n    high: \"stroke-red-500\",\n  };\n  const textColorMap: Record<string, string> = {\n    low: \"text-green-500\",\n    moderate: \"text-yellow-500\",\n    elevated: \"text-orange-500\",\n    high: \"text-red-500\",\n  };\n\n  return (\n    <div className=\"relative w-20 h-20 flex items-center justify-center\">\n      <svg className=\"w-20 h-20 -rotate-90\" viewBox=\"0 0 80 80\">\n        <circle\n          cx=\"40\"\n          cy=\"40\"\n          r=\"36\"\n          fill=\"none\"\n          strokeWidth=\"6\"\n          className=\"stroke-muted\"\n        />\n        <circle\n          cx=\"40\"\n          cy=\"40\"\n          r=\"36\"\n          fill=\"none\"\n          strokeWidth=\"6\"\n          strokeLinecap=\"round\"\n          strokeDasharray={circumference}\n          strokeDashoffset={offset}\n          className={colorMap[level] || \"stroke-muted-foreground\"}\n        />\n      </svg>\n      <span className={`absolute text-base font-bold ${textColorMap[level] || \"text-muted-foreground\"}`}>\n        {score}\n      </span>\n    </div>\n  );\n}\n\nfunction RiskOverviewSection() {\n  const { t } = useLanguage();\n  const { data: riskScores, isLoading } = useQuery<RiskScoreEntry[]>({\n    queryKey: [\"/api/permissions/risk-scores\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"risk-overview\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">{t(\"pi.riskOverview\")}</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4\">\n            {[1, 2, 3].map((i) => (\n              <Skeleton key={i} className=\"h-32 w-40\" />\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!riskScores?.length) {\n    return (\n      <Card data-testid=\"risk-overview\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">{t(\"pi.riskOverview\")}</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-sm text-muted-foreground\" data-testid=\"text-no-risk-data\">\n            {t(\"pi.noRiskData\")}\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card data-testid=\"risk-overview\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-lg flex items-center gap-2\">\n          <Activity className=\"w-5 h-5\" />\n          {t(\"pi.riskOverview\")}\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"flex gap-4 overflow-x-auto pb-2\">\n          {riskScores.map((rs) => (\n            <div\n              key={rs.botId}\n              className=\"flex flex-col items-center gap-2 min-w-[140px] p-3 rounded-md border\"\n              data-testid={`risk-card-${rs.botId}`}\n            >\n              <span className=\"text-sm font-medium truncate max-w-[120px]\" data-testid={`text-risk-bot-${rs.botId}`}>\n                {rs.botName}\n              </span>\n              <RiskScoreCircle score={rs.score} level={rs.level} />\n              <Badge\n                variant={rs.level === \"high\" ? \"destructive\" : rs.level === \"elevated\" ? \"secondary\" : \"outline\"}\n                data-testid={`badge-risk-level-${rs.botId}`}\n              >\n                {t(`pi.riskLevel.${rs.level}`)}\n              </Badge>\n              <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\n                <span data-testid={`text-denials-${rs.botId}`}>\n                  {t(\"pi.denials7d\")}: {rs.denials7d}\n                </span>\n                <span data-testid={`text-events-${rs.botId}`}>\n                  {t(\"pi.events7d\")}: {rs.totalEvents7d}\n                </span>\n              </div>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction ActivityTimelineTab() {\n  const { t, language } = useLanguage();\n  const { data: timeline, isLoading } = useQuery<TimelineData>({\n    queryKey: [\"/api/audit-logs/timeline\"],\n    queryFn: () => fetch(\"/api/audit-logs/timeline?days=7\", { credentials: \"include\" }).then((r) => r.json()),\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"activity-timeline\">\n        <CardHeader>\n          <CardTitle>{t(\"pi.timeline\")}</CardTitle>\n          <CardDescription>{t(\"pi.timelineSub\")}</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-2\">\n            {[1, 2, 3, 4, 5, 6, 7].map((i) => (\n              <Skeleton key={i} className=\"h-8 w-full\" />\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const days = timeline?.timeline ?? [];\n  const maxTotal = Math.max(...days.map((d) => d.total), 1);\n  const totalEvents = timeline?.totalEvents ?? 0;\n\n  const peakDay = days.reduce<TimelineDay | null>((best, d) => {\n    if (!best || d.total > best.total) return d;\n    return best;\n  }, null);\n\n  const formatDayLabel = (dateStr: string) => {\n    const date = new Date(dateStr + \"T00:00:00\");\n    if (language === \"ko\") {\n      const dayNames = [\"일\", \"월\", \"화\", \"수\", \"목\", \"금\", \"토\"];\n      return dayNames[date.getDay()];\n    }\n    return date.toLocaleDateString(\"en-US\", { weekday: \"short\" });\n  };\n\n  const formatDateShort = (dateStr: string) => {\n    const date = new Date(dateStr + \"T00:00:00\");\n    return date.toLocaleDateString(language === \"ko\" ? \"ko-KR\" : \"en-US\", { month: \"short\", day: \"numeric\" });\n  };\n\n  if (totalEvents === 0) {\n    return (\n      <Card data-testid=\"activity-timeline\">\n        <CardHeader>\n          <CardTitle>{t(\"pi.timeline\")}</CardTitle>\n          <CardDescription>{t(\"pi.timelineSub\")}</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-sm text-muted-foreground text-center py-8\" data-testid=\"text-no-activity\">\n            {t(\"pi.noActivity\")}\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card data-testid=\"activity-timeline\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <BarChart3 className=\"w-5 h-5\" />\n          {t(\"pi.timeline\")}\n        </CardTitle>\n        <CardDescription>{t(\"pi.timelineSub\")}</CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        <div className=\"flex items-end gap-2 h-48\">\n          {days.map((day) => {\n            const heightPct = maxTotal > 0 ? (day.total / maxTotal) * 100 : 0;\n            const deniedPct = day.total > 0 ? (day.denied / day.total) * heightPct : 0;\n            const approvedPct = day.total > 0 ? (day.approved / day.total) * heightPct : 0;\n            const changedPct = day.total > 0 ? (day.changed / day.total) * heightPct : 0;\n            const requestedPct = day.total > 0 ? (day.requested / day.total) * heightPct : 0;\n\n            return (\n              <div\n                key={day.date}\n                className=\"flex-1 flex flex-col items-center gap-1\"\n                data-testid={`timeline-day-${day.date}`}\n              >\n                <div className=\"w-full flex flex-col justify-end h-40 relative\">\n                  <div className=\"w-full flex flex-col-reverse\">\n                    {deniedPct > 0 && (\n                      <div\n                        className=\"w-full bg-red-500 rounded-t-sm\"\n                        style={{ height: `${(deniedPct / 100) * 160}px` }}\n                      />\n                    )}\n                    {approvedPct > 0 && (\n                      <div\n                        className=\"w-full bg-green-500\"\n                        style={{ height: `${(approvedPct / 100) * 160}px` }}\n                      />\n                    )}\n                    {changedPct > 0 && (\n                      <div\n                        className=\"w-full bg-yellow-500\"\n                        style={{ height: `${(changedPct / 100) * 160}px` }}\n                      />\n                    )}\n                    {requestedPct > 0 && (\n                      <div\n                        className=\"w-full bg-blue-500 rounded-t-sm\"\n                        style={{ height: `${(requestedPct / 100) * 160}px` }}\n                      />\n                    )}\n                  </div>\n                </div>\n                <span className=\"text-xs font-medium\">{formatDayLabel(day.date)}</span>\n                <span className=\"text-[10px] text-muted-foreground\">{formatDateShort(day.date)}</span>\n              </div>\n            );\n          })}\n        </div>\n\n        <div className=\"flex items-center gap-4 flex-wrap\">\n          <div className=\"flex items-center gap-1.5\">\n            <div className=\"w-3 h-3 rounded-sm bg-red-500\" />\n            <span className=\"text-xs text-muted-foreground\">{t(\"pi.denied\")}</span>\n          </div>\n          <div className=\"flex items-center gap-1.5\">\n            <div className=\"w-3 h-3 rounded-sm bg-green-500\" />\n            <span className=\"text-xs text-muted-foreground\">{t(\"pi.approved\")}</span>\n          </div>\n          <div className=\"flex items-center gap-1.5\">\n            <div className=\"w-3 h-3 rounded-sm bg-yellow-500\" />\n            <span className=\"text-xs text-muted-foreground\">{t(\"pi.changed\")}</span>\n          </div>\n          <div className=\"flex items-center gap-1.5\">\n            <div className=\"w-3 h-3 rounded-sm bg-blue-500\" />\n            <span className=\"text-xs text-muted-foreground\">{t(\"pi.requested\")}</span>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-6 pt-2 border-t\">\n          <div data-testid=\"text-total-events\">\n            <span className=\"text-sm text-muted-foreground\">{t(\"pi.totalEvents\")}</span>\n            <p className=\"text-xl font-bold\">{totalEvents}</p>\n          </div>\n          {peakDay && (\n            <div data-testid=\"text-peak-day\">\n              <span className=\"text-sm text-muted-foreground\">{t(\"pi.peakDay\")}</span>\n              <p className=\"text-xl font-bold\">\n                {formatDayLabel(peakDay.date)} ({peakDay.total})\n              </p>\n            </div>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nconst EVENT_TYPES = [\n  \"PERMISSION_CHANGED\",\n  \"PERMISSION_DELETED\",\n  \"PERMISSION_DENIED\",\n  \"APPROVAL_REQUESTED\",\n  \"APPROVAL_GRANTED_ONCE\",\n  \"APPROVAL_GRANTED_BOT\",\n  \"APPROVAL_GRANTED_GLOBAL\",\n];\n\nconst PERM_KEYS = PERMISSION_GROUPS.flatMap((g) => g.keys.map((k) => k.key));\n\nfunction EnhancedAuditLogTab() {\n  const { t, language } = useLanguage();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterEventType, setFilterEventType] = useState(\"all\");\n  const [filterPermKey, setFilterPermKey] = useState(\"all\");\n  const [filterDateRange, setFilterDateRange] = useState(\"7\");\n\n  const queryParams = useMemo(() => {\n    const params = new URLSearchParams();\n    params.set(\"days\", filterDateRange);\n    params.set(\"limit\", \"200\");\n    if (filterEventType !== \"all\") params.set(\"eventType\", filterEventType);\n    if (filterPermKey !== \"all\") params.set(\"permissionKey\", filterPermKey);\n    return params.toString();\n  }, [filterEventType, filterPermKey, filterDateRange]);\n\n  const { data: auditLogs, isLoading } = useQuery<AuditLogEntry[]>({\n    queryKey: [\"/api/audit-logs\", queryParams],\n    queryFn: () => fetch(`/api/audit-logs?${queryParams}`, { credentials: \"include\" }).then((r) => r.json()),\n  });\n\n  const filteredLogs = useMemo(() => {\n    if (!auditLogs) return [];\n    if (!searchQuery.trim()) return auditLogs;\n    const q = searchQuery.toLowerCase();\n    return auditLogs.filter(\n      (log) =>\n        log.eventType.toLowerCase().includes(q) ||\n        (log.permissionKey && log.permissionKey.toLowerCase().includes(q))\n    );\n  }, [auditLogs, searchQuery]);\n\n  return (\n    <Card data-testid=\"card-audit-log\">\n      <CardHeader>\n        <CardTitle data-testid=\"text-audit-title\">{t(\"audit.title\")}</CardTitle>\n        <CardDescription data-testid=\"text-audit-subtitle\">{t(\"audit.subtitle\")}</CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n          <Input\n            placeholder={t(\"pi.auditSearch\")}\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"audit-search-input\"\n          />\n        </div>\n\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <Select value={filterEventType} onValueChange={setFilterEventType}>\n            <SelectTrigger className=\"w-[180px]\" data-testid=\"filter-event-type\">\n              <SelectValue placeholder={t(\"pi.filterEventType\")} />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">{t(\"pi.allEvents\")}</SelectItem>\n              {EVENT_TYPES.map((et) => (\n                <SelectItem key={et} value={et}>\n                  {t(`audit.${et}` as any) || et}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n\n          <Select value={filterPermKey} onValueChange={setFilterPermKey}>\n            <SelectTrigger className=\"w-[180px]\" data-testid=\"filter-perm-key\">\n              <SelectValue placeholder={t(\"pi.filterPermKey\")} />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">{t(\"pi.allPermissions\")}</SelectItem>\n              {PERM_KEYS.map((pk) => (\n                <SelectItem key={pk} value={pk}>\n                  {pk}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n\n          <Select value={filterDateRange} onValueChange={setFilterDateRange}>\n            <SelectTrigger className=\"w-[160px]\" data-testid=\"filter-date-range\">\n              <SelectValue placeholder={t(\"pi.filterDateRange\")} />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"7\">{t(\"pi.last7days\")}</SelectItem>\n              <SelectItem value=\"30\">{t(\"pi.last30days\")}</SelectItem>\n              <SelectItem value=\"90\">{t(\"pi.last90days\")}</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        {isLoading ? (\n          <div className=\"space-y-2\">\n            {[1, 2, 3].map((i) => (\n              <Skeleton key={i} className=\"h-12 w-full\" />\n            ))}\n          </div>\n        ) : !filteredLogs.length ? (\n          <p className=\"text-muted-foreground text-sm py-4 text-center\" data-testid=\"text-no-audit-logs\">\n            {t(\"audit.noLogs\")}\n          </p>\n        ) : (\n          <>\n            <p className=\"text-xs text-muted-foreground\" data-testid=\"text-showing-results\">\n              {t(\"pi.showingResults\", { count: filteredLogs.length })}\n            </p>\n            <div className=\"space-y-2\">\n              {filteredLogs.map((log) => (\n                <div\n                  key={log.id}\n                  className=\"flex items-start gap-3 p-3 rounded-md border text-sm\"\n                  data-testid={`audit-log-${log.id}`}\n                >\n                  <div className=\"mt-0.5\">\n                    {log.eventType === \"PERMISSION_DENIED\" ? (\n                      <ShieldX className=\"w-4 h-4 text-destructive\" />\n                    ) : log.eventType === \"PERMISSION_CHANGED\" ? (\n                      <ShieldAlert className=\"w-4 h-4 text-yellow-500\" />\n                    ) : (\n                      <RotateCcw className=\"w-4 h-4 text-muted-foreground\" />\n                    )}\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <Badge variant={log.eventType === \"PERMISSION_DENIED\" ? \"destructive\" : \"secondary\"}>\n                        {t(`audit.${log.eventType}` as any) || log.eventType}\n                      </Badge>\n                      {log.permissionKey && (\n                        <Badge variant=\"outline\">{log.permissionKey}</Badge>\n                      )}\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {new Date(log.createdAt).toLocaleString(language === \"ko\" ? \"ko-KR\" : \"en-US\")}\n                      {log.botId && ` | Bot #${log.botId}`}\n                    </p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function Permissions() {\n  const { toast } = useToast();\n  const { t, language } = useLanguage();\n  const isDesktop = useIsDesktop();\n  const [activeTab, setActiveTab] = useState<string>(\"permissions\");\n\n  const filteredGroups = PERMISSION_GROUPS.map(group => ({\n    ...group,\n    keys: group.keys.filter(k => isDesktop || !k.localOnly),\n  })).filter(group => group.keys.length > 0);\n  const hasHiddenPerms = !isDesktop && filteredGroups.flatMap(g => g.keys).length < PERMISSION_GROUPS.flatMap(g => g.keys).length;\n\n  const { data: effective, isLoading } = useQuery<Record<string, EffectivePermission>>({\n    queryKey: [\"/api/permissions/effective\"],\n    queryFn: () => fetch(\"/api/permissions/effective\", { credentials: \"include\" }).then((r) => r.json()),\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ permissionKey, value }: { permissionKey: string; value: any }) => {\n      return apiRequest(\"PUT\", \"/api/permissions\", {\n        scope: \"global\",\n        scopeId: null,\n        permissionKey,\n        value,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/permissions/effective\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audit-logs\"] });\n      toast({ title: t(\"perm.saved\") });\n    },\n    onError: (error: Error) => {\n      console.error(\"[Permissions] Update failed:\", error);\n      toast({ title: t(\"perm.error\") || \"Failed to update permission\", variant: \"destructive\" });\n    },\n  });\n\n  const resetMutation = useMutation({\n    mutationFn: async (permissionKey: string) => {\n      return apiRequest(\"DELETE\", \"/api/permissions\", {\n        scope: \"global\",\n        scopeId: null,\n        permissionKey,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/permissions/effective\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audit-logs\"] });\n      toast({ title: t(\"perm.deleted\") });\n    },\n    onError: (error: Error) => {\n      console.error(\"[Permissions] Reset failed:\", error);\n      toast({ title: t(\"perm.error\") || \"Failed to reset permission\", variant: \"destructive\" });\n    },\n  });\n\n  const isUpdating = updateMutation.isPending || resetMutation.isPending;\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-4\">\n        <Skeleton className=\"h-8 w-64\" />\n        <Skeleton className=\"h-4 w-96\" />\n        <div className=\"space-y-3\">\n          {[1, 2, 3, 4].map((i) => (\n            <Skeleton key={i} className=\"h-24 w-full\" />\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 max-w-4xl mx-auto space-y-6\" data-testid=\"page-permissions\">\n      <div>\n        <h1 className=\"text-2xl font-bold flex items-center gap-2\" data-testid=\"text-permissions-title\">\n          <Shield className=\"w-6 h-6\" />\n          {t(\"pi.title\")}\n        </h1>\n        <p className=\"text-muted-foreground mt-1\" data-testid=\"text-permissions-subtitle\">{t(\"pi.subtitle\")}</p>\n      </div>\n\n      <RiskOverviewSection />\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList data-testid=\"tabs-permissions\">\n          <TabsTrigger value=\"permissions\" data-testid=\"tab-permissions\">\n            <ShieldCheck className=\"w-4 h-4 mr-1\" />\n            {t(\"perm.globalDefaults\")}\n          </TabsTrigger>\n          <TabsTrigger value=\"timeline\" data-testid=\"tab-timeline\">\n            <BarChart3 className=\"w-4 h-4 mr-1\" />\n            {t(\"pi.timeline\")}\n          </TabsTrigger>\n          <TabsTrigger value=\"audit\" data-testid=\"tab-audit\">\n            <Clock className=\"w-4 h-4 mr-1\" />\n            {t(\"audit.title\")}\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"permissions\" className=\"space-y-4 mt-4\">\n          {hasHiddenPerms && (\n            <div className=\"flex items-center gap-2 px-3 py-2 rounded-md bg-muted/40 text-xs text-muted-foreground\" data-testid=\"web-hidden-notice-global\">\n              <Monitor className=\"w-3.5 h-3.5 shrink-0\" />\n              {t(\"pd.webHidden\")}\n            </div>\n          )}\n          {filteredGroups.map((group) => (\n            <Card key={group.group} data-testid={`card-group-${group.group}`}>\n              <CardHeader className=\"pb-2\">\n                <CardTitle className=\"text-lg\" data-testid={`text-group-title-${group.group}`}>\n                  {t(`perm.group.${group.group}` as any)}\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                {group.keys.map((keyDef) => (\n                  <PermissionRow\n                    key={keyDef.key}\n                    keyDef={keyDef}\n                    effective={effective?.[keyDef.key]}\n                    onUpdate={(key, value) => updateMutation.mutate({ permissionKey: key, value })}\n                    onReset={(key) => resetMutation.mutate(key)}\n                    isUpdating={isUpdating}\n                    isDesktop={isDesktop}\n                  />\n                ))}\n              </CardContent>\n            </Card>\n          ))}\n        </TabsContent>\n\n        <TabsContent value=\"timeline\" className=\"mt-4\">\n          <ActivityTimelineTab />\n        </TabsContent>\n\n        <TabsContent value=\"audit\" className=\"mt-4\">\n          <EnhancedAuditLogTab />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":32406,"size_tokens":null},"server/jobs/runLogger.ts":{"content":"import { storage } from \"../storage\";\n\ninterface StartRunParams {\n  userId: string;\n  botId: number | null;\n  botKey: string;\n  jobType: string;\n  trigger: string;\n  meta?: Record<string, any>;\n}\n\ninterface EndRunOkParams {\n  itemsCollected?: number;\n  itemsAnalyzed?: number;\n  outputId?: number;\n  reportStage?: string;\n  meta?: Record<string, any>;\n}\n\ninterface EndRunErrorParams {\n  errorCode: string;\n  errorMessage: string;\n  errorDetailJson?: Record<string, any>;\n  reportStage?: string;\n}\n\nconst runStartTimes = new Map<number, number>();\n\nexport async function startRun(params: StartRunParams): Promise<number> {\n  try {\n    const t = Date.now();\n    const run = await storage.createJobRun({\n      userId: params.userId,\n      botId: params.botId,\n      botKey: params.botKey,\n      jobType: params.jobType,\n      trigger: params.trigger,\n      status: \"started\",\n      startedAt: new Date(),\n      metaJson: params.meta || null,\n    });\n    runStartTimes.set(run.id, t);\n    return run.id;\n  } catch (e) {\n    console.error(\"[runLogger] Failed to start run:\", e);\n    return -1;\n  }\n}\n\nfunction popStartTime(runId: number): number {\n  const t = runStartTimes.get(runId);\n  runStartTimes.delete(runId);\n  return t ?? Date.now();\n}\n\nexport async function endRunOk(runId: number, params: EndRunOkParams): Promise<void> {\n  if (runId < 0) return;\n  try {\n    await storage.finishJobRun(runId, {\n      status: \"ok\",\n      finishedAt: new Date(),\n      durationMs: Date.now() - popStartTime(runId),\n      itemsCollected: params.itemsCollected ?? null,\n      itemsAnalyzed: params.itemsAnalyzed ?? null,\n      outputId: params.outputId ?? null,\n      reportStage: params.reportStage ?? null,\n      metaJson: params.meta ?? undefined,\n    });\n  } catch (e) {\n    console.error(\"[runLogger] Failed to end run ok:\", e);\n  }\n}\n\nexport async function endRunError(runId: number, params: EndRunErrorParams): Promise<void> {\n  if (runId < 0) return;\n  try {\n    await storage.finishJobRun(runId, {\n      status: \"error\",\n      finishedAt: new Date(),\n      durationMs: Date.now() - popStartTime(runId),\n      errorCode: params.errorCode,\n      errorMessage: params.errorMessage,\n      errorDetailJson: params.errorDetailJson ?? null,\n      reportStage: params.reportStage ?? null,\n    });\n  } catch (e) {\n    console.error(\"[runLogger] Failed to end run error:\", e);\n  }\n}\n\nexport async function endRunTimeout(runId: number, message?: string): Promise<void> {\n  if (runId < 0) return;\n  try {\n    await storage.finishJobRun(runId, {\n      status: \"timeout\",\n      finishedAt: new Date(),\n      durationMs: Date.now() - popStartTime(runId),\n      errorCode: \"TIMEOUT\",\n      errorMessage: message || \"Operation timed out\",\n    });\n  } catch (e) {\n    console.error(\"[runLogger] Failed to end run timeout:\", e);\n  }\n}\n\nexport async function endRunSkipped(runId: number, reason: string): Promise<void> {\n  if (runId < 0) return;\n  try {\n    await storage.finishJobRun(runId, {\n      status: \"skipped\",\n      finishedAt: new Date(),\n      durationMs: 0,\n      errorCode: reason,\n      errorMessage: reason,\n    });\n  } catch (e) {\n    console.error(\"[runLogger] Failed to end run skipped:\", e);\n  }\n}\n","path":null,"size_bytes":3192,"size_tokens":null},"server/policy/types.ts":{"content":"export type ApprovalMode = \"AUTO_ALLOWED\" | \"APPROVAL_REQUIRED\" | \"AUTO_DENIED\";\nexport type EgressLevel = \"NO_EGRESS\" | \"METADATA_ONLY\" | \"FULL_CONTENT_ALLOWED\";\n\nexport interface PermissionValue {\n  enabled: boolean;\n  approvalMode: ApprovalMode;\n  resourceScope?: Record<string, any>;\n}\n\nexport interface PermissionCheckResult {\n  allowed: boolean;\n  requiresApproval: boolean;\n  reason: string;\n  effectivePolicy: PermissionValue | null;\n}\n\nexport interface EgressCheckResult {\n  allowed: boolean;\n  reason: string;\n  effectiveLevel: EgressLevel;\n}\n\nexport interface PolicyContext {\n  userId: string;\n  botId?: number | null;\n  threadId?: string | null;\n  action?: string;\n}\n\nexport const PERMISSION_KEYS = [\n  \"WEB_RSS\",\n  \"WEB_FETCH\",\n  \"SOURCE_WRITE\",\n  \"LLM_USE\",\n  \"LLM_EGRESS_LEVEL\",\n  \"FS_READ\",\n  \"FS_WRITE\",\n  \"FS_DELETE\",\n  \"CAL_READ\",\n  \"CAL_WRITE\",\n  \"SCHEDULE_WRITE\",\n  \"MEMORY_WRITE\",\n  \"DATA_RETENTION\",\n] as const;\n\nexport type PermissionKey = typeof PERMISSION_KEYS[number];\n\nexport interface PermissionGroupDef {\n  group: string;\n  groupLabelEn: string;\n  groupLabelKo: string;\n  keys: {\n    key: PermissionKey;\n    labelEn: string;\n    labelKo: string;\n    descEn: string;\n    descKo: string;\n    risk: \"LOW\" | \"MED\" | \"HIGH\";\n    defaultValue: PermissionValue;\n    egressLevel?: EgressLevel;\n  }[];\n}\n\nexport const PERMISSION_GROUPS: PermissionGroupDef[] = [\n  {\n    group: \"web_sources\",\n    groupLabelEn: \"Web & Sources\",\n    groupLabelKo: \"웹 & 소스\",\n    keys: [\n      {\n        key: \"WEB_RSS\",\n        labelEn: \"RSS Feed Collection\",\n        labelKo: \"RSS 피드 수집\",\n        descEn: \"Allow collecting content from RSS/Atom feeds\",\n        descKo: \"RSS/Atom 피드에서 콘텐츠를 수집하도록 허용\",\n        risk: \"LOW\",\n        defaultValue: { enabled: true, approvalMode: \"AUTO_ALLOWED\" },\n      },\n      {\n        key: \"WEB_FETCH\",\n        labelEn: \"Web Page Fetching\",\n        labelKo: \"웹 페이지 가져오기\",\n        descEn: \"Allow fetching public web pages (including scraping/extraction)\",\n        descKo: \"공개 웹 페이지 가져오기 허용 (스크래핑/본문 추출 포함)\",\n        risk: \"MED\",\n        defaultValue: { enabled: false, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n      {\n        key: \"SOURCE_WRITE\",\n        labelEn: \"Manage Sources\",\n        labelKo: \"소스 관리\",\n        descEn: \"Allow adding, editing, and deleting bot sources\",\n        descKo: \"봇의 소스 추가/수정/삭제 허용\",\n        risk: \"LOW\",\n        defaultValue: { enabled: true, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n    ],\n  },\n  {\n    group: \"ai_data\",\n    groupLabelEn: \"AI & Data\",\n    groupLabelKo: \"AI & 데이터\",\n    keys: [\n      {\n        key: \"LLM_USE\",\n        labelEn: \"AI Provider Usage\",\n        labelKo: \"AI 제공자 사용\",\n        descEn: \"Allow using external AI/LLM APIs for analysis and reports\",\n        descKo: \"분석과 리포트를 위한 외부 AI/LLM API 사용 허용\",\n        risk: \"MED\",\n        defaultValue: { enabled: true, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n      {\n        key: \"LLM_EGRESS_LEVEL\",\n        labelEn: \"Data Sent to AI\",\n        labelKo: \"AI로 전송되는 데이터\",\n        descEn: \"Control what content is sent to external AI providers\",\n        descKo: \"외부 AI 제공자에게 전송되는 콘텐츠 범위를 제어\",\n        risk: \"HIGH\",\n        defaultValue: { enabled: true, approvalMode: \"AUTO_ALLOWED\" },\n        egressLevel: \"METADATA_ONLY\",\n      },\n    ],\n  },\n  {\n    group: \"files\",\n    groupLabelEn: \"Files\",\n    groupLabelKo: \"파일\",\n    keys: [\n      {\n        key: \"FS_READ\",\n        labelEn: \"Read Local Files\",\n        labelKo: \"로컬 파일 읽기\",\n        descEn: \"Allow reading files from selected folders\",\n        descKo: \"선택한 폴더에서 파일 읽기 허용\",\n        risk: \"MED\",\n        defaultValue: { enabled: false, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n      {\n        key: \"FS_WRITE\",\n        labelEn: \"Write Local Files\",\n        labelKo: \"로컬 파일 쓰기\",\n        descEn: \"Allow creating and modifying files in designated folders\",\n        descKo: \"지정된 폴더에서 파일 생성/수정 허용\",\n        risk: \"MED\",\n        defaultValue: { enabled: false, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n      {\n        key: \"FS_DELETE\",\n        labelEn: \"Delete Files (Trash Only)\",\n        labelKo: \"파일 삭제 (휴지통만)\",\n        descEn: \"Allow moving files to trash (permanent deletion is never allowed)\",\n        descKo: \"파일을 휴지통으로 이동 허용 (영구 삭제는 불가)\",\n        risk: \"HIGH\",\n        defaultValue: { enabled: false, approvalMode: \"AUTO_DENIED\" },\n      },\n    ],\n  },\n  {\n    group: \"calendar\",\n    groupLabelEn: \"Calendar\",\n    groupLabelKo: \"캘린더\",\n    keys: [\n      {\n        key: \"CAL_READ\",\n        labelEn: \"Read Calendar\",\n        labelKo: \"캘린더 읽기\",\n        descEn: \"Allow reading calendar events for briefings\",\n        descKo: \"브리핑을 위한 캘린더 이벤트 읽기 허용\",\n        risk: \"LOW\",\n        defaultValue: { enabled: false, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n      {\n        key: \"CAL_WRITE\",\n        labelEn: \"Create/Update Events\",\n        labelKo: \"일정 생성/수정\",\n        descEn: \"Allow creating and modifying calendar events\",\n        descKo: \"캘린더 이벤트 생성/수정 허용\",\n        risk: \"MED\",\n        defaultValue: { enabled: false, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n    ],\n  },\n  {\n    group: \"scheduling\",\n    groupLabelEn: \"Scheduling\",\n    groupLabelKo: \"스케줄링\",\n    keys: [\n      {\n        key: \"SCHEDULE_WRITE\",\n        labelEn: \"Modify Schedules\",\n        labelKo: \"스케줄 변경\",\n        descEn: \"Allow changing bot run schedules\",\n        descKo: \"봇 실행 스케줄 변경 허용\",\n        risk: \"LOW\",\n        defaultValue: { enabled: true, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n    ],\n  },\n  {\n    group: \"memory\",\n    groupLabelEn: \"Memory\",\n    groupLabelKo: \"메모리\",\n    keys: [\n      {\n        key: \"MEMORY_WRITE\",\n        labelEn: \"Save Rules & Preferences\",\n        labelKo: \"규칙/선호 저장\",\n        descEn: \"Allow saving and modifying user rules and preferences to long-term memory\",\n        descKo: \"사용자 규칙과 선호를 장기 메모리에 저장/수정 허용\",\n        risk: \"LOW\",\n        defaultValue: { enabled: true, approvalMode: \"AUTO_ALLOWED\" },\n      },\n      {\n        key: \"DATA_RETENTION\",\n        labelEn: \"Data Retention Policy\",\n        labelKo: \"데이터 보존 정책\",\n        descEn: \"Control how long collected data and memory are retained\",\n        descKo: \"수집된 데이터와 메모리의 보존 기간 관리\",\n        risk: \"MED\",\n        defaultValue: { enabled: true, approvalMode: \"APPROVAL_REQUIRED\" },\n      },\n    ],\n  },\n];\n\nexport function getDefaultPermissionValue(key: PermissionKey): PermissionValue {\n  for (const group of PERMISSION_GROUPS) {\n    const def = group.keys.find(k => k.key === key);\n    if (def) return { ...def.defaultValue };\n  }\n  return { enabled: false, approvalMode: \"AUTO_DENIED\" };\n}\n\nexport function getDefaultEgressLevel(key: PermissionKey): EgressLevel {\n  for (const group of PERMISSION_GROUPS) {\n    const def = group.keys.find(k => k.key === key);\n    if (def?.egressLevel) return def.egressLevel;\n  }\n  return \"NO_EGRESS\";\n}\n","path":null,"size_bytes":7413,"size_tokens":null},"client/src/lib/permission-request-context.tsx":{"content":"import { createContext, useContext, useCallback, useState } from \"react\";\nimport type { PermissionRequestMessage } from \"@shared/permission-messages\";\nimport { PermissionRequestModal } from \"@/components/permission-request-modal\";\nimport type { PermissionRequest } from \"@/hooks/use-permission-request\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport { queryClient } from \"@/lib/queryClient\";\n\ninterface ApprovalRequiredData {\n  requiresApproval: true;\n  permissionKey: string;\n  action: string;\n  botId?: number | null;\n  message: PermissionRequestMessage | null;\n}\n\ninterface PermissionRequestContextType {\n  requestApproval: (\n    data: ApprovalRequiredData,\n    retryFn: () => Promise<void>,\n  ) => void;\n  interceptResponse: (\n    res: Response,\n    retryFn: () => Promise<void>,\n  ) => Promise<boolean>;\n}\n\nconst PermissionRequestContext = createContext<PermissionRequestContextType | undefined>(undefined);\n\nexport function PermissionRequestProvider({ children }: { children: React.ReactNode }) {\n  const [request, setRequest] = useState<PermissionRequest | null>(null);\n  const { toast } = useToast();\n  const { t } = useLanguage();\n\n  const requestApproval = useCallback(\n    (data: ApprovalRequiredData, retryFn: () => Promise<void>) => {\n      setRequest({\n        permissionKey: data.permissionKey,\n        action: data.action,\n        botId: data.botId,\n        message: data.message,\n        onApprove: async (scope) => {\n          setRequest(null);\n          try {\n            if (scope === \"once\") {\n              await fetch(\"/api/permissions/approve-once\", {\n                method: \"POST\",\n                headers: { \"Content-Type\": \"application/json\" },\n                credentials: \"include\",\n                body: JSON.stringify({\n                  permissionKey: data.permissionKey,\n                  action: data.action,\n                  botId: data.botId,\n                }),\n              });\n            } else if (scope === \"bot\" && data.botId) {\n              await fetch(\"/api/permissions\", {\n                method: \"PUT\",\n                headers: { \"Content-Type\": \"application/json\" },\n                credentials: \"include\",\n                body: JSON.stringify({\n                  scope: \"bot\",\n                  scopeId: data.botId,\n                  permissionKey: data.permissionKey,\n                  value: { enabled: true, approvalMode: \"AUTO_ALLOWED\" },\n                }),\n              });\n            } else {\n              await fetch(\"/api/permissions\", {\n                method: \"PUT\",\n                headers: { \"Content-Type\": \"application/json\" },\n                credentials: \"include\",\n                body: JSON.stringify({\n                  scope: \"global\",\n                  scopeId: null,\n                  permissionKey: data.permissionKey,\n                  value: { enabled: true, approvalMode: \"AUTO_ALLOWED\" },\n                }),\n              });\n            }\n            toast({ title: t(\"approval.approved\") });\n            queryClient.invalidateQueries({ queryKey: [\"/api/permissions\"] });\n            queryClient.invalidateQueries({ queryKey: [\"/api/audit-logs\"] });\n            await retryFn();\n          } catch {\n            toast({ title: \"Error\", variant: \"destructive\" });\n          }\n        },\n        onDeny: () => {\n          setRequest(null);\n          toast({ title: t(\"approval.denied\") });\n        },\n      });\n    },\n    [toast, t],\n  );\n\n  const interceptResponse = useCallback(\n    async (res: Response, retryFn: () => Promise<void>): Promise<boolean> => {\n      if (res.status === 403) {\n        const cloned = res.clone();\n        try {\n          const body = await cloned.json();\n          if (body.requiresApproval) {\n            requestApproval(body as ApprovalRequiredData, retryFn);\n            return true;\n          }\n        } catch {}\n      }\n      return false;\n    },\n    [requestApproval],\n  );\n\n  return (\n    <PermissionRequestContext.Provider value={{ requestApproval, interceptResponse }}>\n      {children}\n      <PermissionRequestModal request={request} />\n    </PermissionRequestContext.Provider>\n  );\n}\n\nexport function usePermissionApproval() {\n  const ctx = useContext(PermissionRequestContext);\n  if (!ctx) throw new Error(\"usePermissionApproval must be used within PermissionRequestProvider\");\n  return ctx;\n}\n","path":null,"size_bytes":4383,"size_tokens":null},"client/src/hooks/use-permission-request.ts":{"content":"import { useState, useCallback } from \"react\";\nimport type { PermissionRequestMessage } from \"@shared/permission-messages\";\n\nexport interface PermissionRequest {\n  permissionKey: string;\n  action: string;\n  botId?: number | null;\n  message: PermissionRequestMessage | null;\n  onApprove: (scope: \"once\" | \"bot\" | \"global\") => void;\n  onDeny: () => void;\n}\n\nexport function usePermissionRequest() {\n  const [request, setRequest] = useState<PermissionRequest | null>(null);\n\n  const handleApprovalRequired = useCallback(\n    (\n      data: {\n        permissionKey: string;\n        action: string;\n        botId?: number | null;\n        message: PermissionRequestMessage | null;\n      },\n      retryFn: () => Promise<void>,\n    ) => {\n      return new Promise<boolean>((resolve) => {\n        setRequest({\n          permissionKey: data.permissionKey,\n          action: data.action,\n          botId: data.botId,\n          message: data.message,\n          onApprove: async (scope) => {\n            setRequest(null);\n            try {\n              if (scope === \"once\") {\n                await fetch(\"/api/permissions/approve-once\", {\n                  method: \"POST\",\n                  headers: { \"Content-Type\": \"application/json\" },\n                  credentials: \"include\",\n                  body: JSON.stringify({\n                    permissionKey: data.permissionKey,\n                    action: data.action,\n                    botId: data.botId,\n                  }),\n                });\n              } else if (scope === \"bot\" && data.botId) {\n                await fetch(\"/api/permissions\", {\n                  method: \"PUT\",\n                  headers: { \"Content-Type\": \"application/json\" },\n                  credentials: \"include\",\n                  body: JSON.stringify({\n                    scope: \"bot\",\n                    scopeId: data.botId,\n                    permissionKey: data.permissionKey,\n                    value: { enabled: true, approvalMode: \"AUTO_ALLOWED\" },\n                  }),\n                });\n              } else {\n                await fetch(\"/api/permissions\", {\n                  method: \"PUT\",\n                  headers: { \"Content-Type\": \"application/json\" },\n                  credentials: \"include\",\n                  body: JSON.stringify({\n                    scope: \"global\",\n                    scopeId: null,\n                    permissionKey: data.permissionKey,\n                    value: { enabled: true, approvalMode: \"AUTO_ALLOWED\" },\n                  }),\n                });\n              }\n              await retryFn();\n              resolve(true);\n            } catch {\n              resolve(false);\n            }\n          },\n          onDeny: () => {\n            setRequest(null);\n            resolve(false);\n          },\n        });\n      });\n    },\n    [],\n  );\n\n  const checkAndRetry = useCallback(\n    async (\n      apiFn: () => Promise<Response>,\n      retryFn: () => Promise<void>,\n    ): Promise<Response | null> => {\n      const res = await apiFn();\n      if (res.status === 403) {\n        const body = await res.json();\n        if (body.requiresApproval) {\n          const approved = await handleApprovalRequired(body, retryFn);\n          return approved ? null : null;\n        }\n      }\n      return res;\n    },\n    [handleApprovalRequired],\n  );\n\n  return { request, checkAndRetry, handleApprovalRequired, dismiss: () => setRequest(null) };\n}\n","path":null,"size_bytes":3412,"size_tokens":null},"server/services/diagnostics.ts":{"content":"import { storage } from \"../storage\";\nimport { hasSystemLLMKey } from \"../llm/client\";\nimport type { Bot } from \"@shared/schema\";\n\nexport interface DiagnosticItem {\n  rule: string;\n  severity: \"error\" | \"warning\" | \"info\";\n  messageEn: string;\n  messageKo: string;\n}\n\nexport interface DiagnosisResult {\n  health: \"healthy\" | \"warning\" | \"error\";\n  items: DiagnosticItem[];\n}\n\nexport async function diagnoseBot(userId: string, bot: Bot): Promise<DiagnosisResult> {\n  const items: DiagnosticItem[] = [];\n\n  if (!bot.isEnabled) {\n    items.push({\n      rule: \"BOT_DISABLED\",\n      severity: \"warning\",\n      messageEn: `Bot '${bot.name}' is paused. Scheduled jobs will not run.`,\n      messageKo: `'${bot.name}' 봇이 일시정지되어 있습니다. 예약된 작업이 실행되지 않습니다.`,\n    });\n  }\n\n  const botSources = await storage.getBotSources(bot.id);\n  let hasLinkedSources = botSources.length > 0;\n\n  if (!hasLinkedSources) {\n    const profile = await storage.getProfileByUserAndTopic(userId, bot.key);\n    if (profile) {\n      const profileSourceIds = await storage.getProfileSourceIds(profile.id);\n      hasLinkedSources = profileSourceIds.length > 0;\n    }\n  }\n\n  if (!hasLinkedSources) {\n    items.push({\n      rule: \"NO_SOURCES\",\n      severity: \"error\",\n      messageEn: `Bot '${bot.name}' has no sources linked. Add sources to start collecting content.`,\n      messageKo: `'${bot.name}' 봇에 연결된 소스가 없습니다. 콘텐츠 수집을 위해 소스를 추가하세요.`,\n    });\n  }\n\n  const botLLM = await storage.resolveLLMForBot(bot.id);\n  if (!hasSystemLLMKey() && !botLLM) {\n    items.push({\n      rule: \"NO_LLM\",\n      severity: \"error\",\n      messageEn: \"No AI provider configured. Go to Settings to add your API key.\",\n      messageKo: \"AI 제공자가 설정되지 않았습니다. Settings에서 API 키를 추가하세요.\",\n    });\n  }\n\n  let lastRun = await storage.getLastJobRunForBot(userId, bot.id);\n\n  if (!lastRun) {\n    const profile = await storage.getProfileByUserAndTopic(userId, bot.key);\n    if (profile) {\n      lastRun = await storage.getLastJobRunByBotKey(userId, `profile-${profile.id}`);\n    }\n  }\n\n  if (lastRun && lastRun.status === \"error\") {\n    const ago = lastRun.finishedAt\n      ? Math.round((Date.now() - new Date(lastRun.finishedAt).getTime()) / 60000)\n      : null;\n    const agoText = ago !== null ? (ago < 60 ? `${ago}m ago` : `${Math.round(ago / 60)}h ago`) : \"\";\n    const agoTextKo = ago !== null ? (ago < 60 ? `${ago}분 전` : `${Math.round(ago / 60)}시간 전`) : \"\";\n    items.push({\n      rule: \"LAST_RUN_FAILED\",\n      severity: \"error\",\n      messageEn: `Last run failed${agoText ? ` (${agoText})` : \"\"}: ${lastRun.errorMessage || lastRun.errorCode || \"Unknown error\"}`,\n      messageKo: `마지막 실행 실패${agoTextKo ? ` (${agoTextKo})` : \"\"}: ${lastRun.errorMessage || lastRun.errorCode || \"알 수 없는 오류\"}`,\n    });\n  }\n\n  if (!lastRun && bot.isEnabled && hasLinkedSources) {\n    items.push({\n      rule: \"NEVER_RAN\",\n      severity: \"info\",\n      messageEn: `Bot '${bot.name}' has never run. Try running it from the Console or wait for the next schedule.`,\n      messageKo: `'${bot.name}' 봇이 아직 한 번도 실행되지 않았습니다. Console에서 실행하거나 다음 예약 시간을 기다려주세요.`,\n    });\n  }\n\n  const errorCount = items.filter(i => i.severity === \"error\").length;\n  const warningCount = items.filter(i => i.severity === \"warning\").length;\n  const health: DiagnosisResult[\"health\"] = errorCount > 0 ? \"error\" : warningCount > 0 ? \"warning\" : \"healthy\";\n\n  return { health, items };\n}\n","path":null,"size_bytes":3633,"size_tokens":null},"client/src/components/permission-dashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Shield, Globe, Brain, HardDrive, Settings2, AlertTriangle, RotateCcw, Clock, ChevronRight, Monitor } from \"lucide-react\";\n\ntype ApprovalMode = \"AUTO_ALLOWED\" | \"APPROVAL_REQUIRED\" | \"AUTO_DENIED\";\ntype EgressLevel = \"NO_EGRESS\" | \"METADATA_ONLY\" | \"FULL_CONTENT_ALLOWED\";\ntype RiskLevel = \"LOW\" | \"MED\" | \"HIGH\";\n\nfunction useIsDesktop() {\n  return typeof window !== \"undefined\" && !!(window as any).electronAPI;\n}\n\ninterface EffPerm {\n  enabled: boolean;\n  approvalMode: ApprovalMode;\n  egressLevel?: EgressLevel;\n  source: \"default\" | \"global\" | \"bot\";\n}\n\ninterface AuditEntry {\n  id: number;\n  eventType: string;\n  permissionKey: string;\n  createdAt: string;\n  detailsJson: any;\n}\n\ninterface PermKeyDef {\n  key: string;\n  labelEn: string;\n  labelKo: string;\n  descEn: string;\n  descKo: string;\n  risk: RiskLevel;\n  isEgress?: boolean;\n  localOnly?: boolean;\n}\n\ninterface DashboardGroup {\n  id: string;\n  icon: typeof Globe;\n  keys: PermKeyDef[];\n}\n\nconst DASHBOARD_GROUPS: DashboardGroup[] = [\n  {\n    id: \"data_collection\",\n    icon: Globe,\n    keys: [\n      { key: \"WEB_RSS\", labelEn: \"RSS Feed Collection\", labelKo: \"RSS 피드 수집\", descEn: \"Allow collecting content from RSS/Atom feeds\", descKo: \"RSS/Atom 피드에서 콘텐츠를 수집하도록 허용\", risk: \"LOW\" },\n      { key: \"WEB_FETCH\", labelEn: \"Web Page Fetching\", labelKo: \"웹 페이지 가져오기\", descEn: \"Allow fetching public web pages (including scraping/extraction)\", descKo: \"공개 웹 페이지 가져오기 허용 (스크래핑/본문 추출 포함)\", risk: \"MED\" },\n      { key: \"SOURCE_WRITE\", labelEn: \"Manage Sources\", labelKo: \"소스 관리\", descEn: \"Allow adding, editing, and deleting bot sources\", descKo: \"봇의 소스 추가/수정/삭제 허용\", risk: \"LOW\" },\n    ],\n  },\n  {\n    id: \"ai_processing\",\n    icon: Brain,\n    keys: [\n      { key: \"LLM_USE\", labelEn: \"AI Provider Usage\", labelKo: \"AI 제공자 사용\", descEn: \"Allow using external AI/LLM APIs for analysis and reports\", descKo: \"분석과 리포트를 위한 외부 AI/LLM API 사용 허용\", risk: \"MED\" },\n      { key: \"LLM_EGRESS_LEVEL\", labelEn: \"Data Sent to AI\", labelKo: \"AI로 전송되는 데이터\", descEn: \"Control what content is sent to external AI providers\", descKo: \"외부 AI 제공자에게 전송되는 콘텐츠 범위를 제어\", risk: \"HIGH\", isEgress: true },\n    ],\n  },\n  {\n    id: \"local_system\",\n    icon: HardDrive,\n    keys: [\n      { key: \"FS_READ\", labelEn: \"Read Local Files\", labelKo: \"로컬 파일 읽기\", descEn: \"Allow reading files from selected folders\", descKo: \"선택한 폴더에서 파일 읽기 허용\", risk: \"MED\", localOnly: true },\n      { key: \"FS_WRITE\", labelEn: \"Write Local Files\", labelKo: \"로컬 파일 쓰기\", descEn: \"Allow creating and modifying files in designated folders\", descKo: \"지정된 폴더에서 파일 생성/수정 허용\", risk: \"MED\", localOnly: true },\n      { key: \"FS_DELETE\", labelEn: \"Delete Files (Trash Only)\", labelKo: \"파일 삭제 (휴지통만)\", descEn: \"Allow moving files to trash (permanent deletion is never allowed)\", descKo: \"파일을 휴지통으로 이동 허용 (영구 삭제는 불가)\", risk: \"HIGH\", localOnly: true },\n      { key: \"CAL_READ\", labelEn: \"Read Calendar\", labelKo: \"캘린더 읽기\", descEn: \"Allow reading calendar events for briefings\", descKo: \"브리핑을 위한 캘린더 이벤트 읽기 허용\", risk: \"LOW\", localOnly: true },\n      { key: \"CAL_WRITE\", labelEn: \"Create/Update Events\", labelKo: \"일정 생성/수정\", descEn: \"Allow creating and modifying calendar events\", descKo: \"캘린더 이벤트 생성/수정 허용\", risk: \"MED\", localOnly: true },\n    ],\n  },\n  {\n    id: \"automation\",\n    icon: Settings2,\n    keys: [\n      { key: \"SCHEDULE_WRITE\", labelEn: \"Modify Schedules\", labelKo: \"스케줄 변경\", descEn: \"Allow changing bot run schedules\", descKo: \"봇 실행 스케줄 변경 허용\", risk: \"LOW\" },\n    ],\n  },\n];\n\nfunction getStatusColor(mode: ApprovalMode): string {\n  switch (mode) {\n    case \"AUTO_ALLOWED\": return \"text-green-500\";\n    case \"APPROVAL_REQUIRED\": return \"text-yellow-500\";\n    case \"AUTO_DENIED\": return \"text-red-500\";\n  }\n}\n\nfunction getStatusDot(mode: ApprovalMode): string {\n  switch (mode) {\n    case \"AUTO_ALLOWED\": return \"bg-green-500\";\n    case \"APPROVAL_REQUIRED\": return \"bg-yellow-500\";\n    case \"AUTO_DENIED\": return \"bg-red-500\";\n  }\n}\n\nfunction getRiskVariant(risk: RiskLevel): \"default\" | \"secondary\" | \"destructive\" {\n  switch (risk) {\n    case \"HIGH\": return \"destructive\";\n    case \"MED\": return \"secondary\";\n    case \"LOW\": return \"default\";\n  }\n}\n\nfunction formatTimeAgo(dateStr: string, language: string): string {\n  const diffMs = Date.now() - new Date(dateStr).getTime();\n  const mins = Math.floor(diffMs / 60000);\n  if (mins < 1) return language === \"ko\" ? \"방금 전\" : \"just now\";\n  if (mins < 60) return language === \"ko\" ? `${mins}분 전` : `${mins}m ago`;\n  const hours = Math.floor(mins / 60);\n  if (hours < 24) return language === \"ko\" ? `${hours}시간 전` : `${hours}h ago`;\n  const days = Math.floor(hours / 24);\n  return language === \"ko\" ? `${days}일 전` : `${days}d ago`;\n}\n\ninterface PermissionDashboardProps {\n  botId: number;\n  t: (key: string, vars?: Record<string, any>) => string;\n  language: string;\n}\n\nexport function PermissionDashboard({ botId, t, language }: PermissionDashboardProps) {\n  const { toast } = useToast();\n  const isDesktop = useIsDesktop();\n  const [selectedPerm, setSelectedPerm] = useState<PermKeyDef | null>(null);\n  const [modalOpen, setModalOpen] = useState(false);\n  const [scope, setScope] = useState<\"bot\" | \"global\">(\"bot\");\n  const [pendingMode, setPendingMode] = useState<ApprovalMode>(\"AUTO_ALLOWED\");\n  const [pendingEgress, setPendingEgress] = useState<EgressLevel>(\"METADATA_ONLY\");\n\n  const { data: effective } = useQuery<Record<string, EffPerm>>({\n    queryKey: [\"/api/permissions/effective\", botId],\n    queryFn: () => fetch(`/api/permissions/effective?botId=${botId}`, { credentials: \"include\" }).then((r) => r.json()),\n    enabled: !!botId,\n  });\n\n  const { data: auditLogs } = useQuery<AuditEntry[]>({\n    queryKey: [\"/api/audit-logs\", botId, \"recent\"],\n    queryFn: () => fetch(`/api/audit-logs?botId=${botId}&days=7&limit=5`, { credentials: \"include\" }).then((r) => r.json()),\n    enabled: !!botId,\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async ({ permissionKey, value }: { permissionKey: string; value: any }) => {\n      return apiRequest(\"PUT\", \"/api/permissions\", {\n        scope,\n        scopeId: scope === \"bot\" ? botId : null,\n        permissionKey,\n        value,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/permissions/effective\", botId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audit-logs\", botId, \"recent\"] });\n      toast({ title: t(\"perm.saved\") });\n      setModalOpen(false);\n    },\n  });\n\n  const resetMutation = useMutation({\n    mutationFn: async (permissionKey: string) => {\n      return apiRequest(\"DELETE\", \"/api/permissions\", {\n        scope: \"bot\",\n        scopeId: botId,\n        permissionKey,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/permissions/effective\", botId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/audit-logs\", botId, \"recent\"] });\n      toast({ title: t(\"perm.deleted\") });\n    },\n  });\n\n  if (!effective) return null;\n\n  const filteredGroups = DASHBOARD_GROUPS.map(group => ({\n    ...group,\n    keys: group.keys.filter(k => isDesktop || !k.localOnly),\n  })).filter(group => group.keys.length > 0);\n\n  const allKeys = filteredGroups.flatMap(g => g.keys);\n  const hiddenCount = DASHBOARD_GROUPS.flatMap(g => g.keys).length - allKeys.length;\n  const activeCount = allKeys.filter(k => effective[k.key]?.approvalMode === \"AUTO_ALLOWED\").length;\n  const approvalCount = allKeys.filter(k => effective[k.key]?.approvalMode === \"APPROVAL_REQUIRED\").length;\n  const deniedCount = allKeys.filter(k => effective[k.key]?.approvalMode === \"AUTO_DENIED\").length;\n\n  const openDetail = (perm: PermKeyDef) => {\n    setSelectedPerm(perm);\n    const eff = effective[perm.key];\n    if (eff) {\n      setPendingMode(eff.approvalMode);\n      setPendingEgress(eff.egressLevel || \"METADATA_ONLY\");\n      setScope(eff.source === \"bot\" ? \"bot\" : \"bot\");\n    }\n    setModalOpen(true);\n  };\n\n  const handleSave = () => {\n    if (!selectedPerm) return;\n    if (selectedPerm.isEgress) {\n      saveMutation.mutate({\n        permissionKey: selectedPerm.key,\n        value: { enabled: true, approvalMode: \"AUTO_ALLOWED\", egressLevel: pendingEgress },\n      });\n    } else {\n      saveMutation.mutate({\n        permissionKey: selectedPerm.key,\n        value: { enabled: pendingMode !== \"AUTO_DENIED\", approvalMode: pendingMode },\n      });\n    }\n  };\n\n  const recentAudit = (auditLogs || []).slice(0, 5);\n\n  const isUpdating = saveMutation.isPending || resetMutation.isPending;\n\n  return (\n    <>\n      <Card data-testid=\"card-permission-dashboard\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"flex items-center gap-2\">\n            <Shield className=\"h-5 w-5 text-primary\" />\n            {t(\"pd.title\")}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"grid gap-5\">\n          <div className=\"flex items-center gap-4 p-3 rounded-md bg-muted/50 flex-wrap\" data-testid=\"perm-summary\">\n            <div className=\"text-sm text-muted-foreground\">\n              {allKeys.length} {t(\"pd.totalPermissions\")}\n            </div>\n            <div className=\"flex items-center gap-1.5\">\n              <span className=\"w-2.5 h-2.5 rounded-full bg-green-500 inline-block\" />\n              <span className=\"text-sm font-medium\" data-testid=\"count-active\">{activeCount}</span>\n              <span className=\"text-xs text-muted-foreground\">{t(\"pd.active\")}</span>\n            </div>\n            <div className=\"flex items-center gap-1.5\">\n              <span className=\"w-2.5 h-2.5 rounded-full bg-yellow-500 inline-block\" />\n              <span className=\"text-sm font-medium\" data-testid=\"count-approval\">{approvalCount}</span>\n              <span className=\"text-xs text-muted-foreground\">{t(\"pd.needsApproval\")}</span>\n            </div>\n            <div className=\"flex items-center gap-1.5\">\n              <span className=\"w-2.5 h-2.5 rounded-full bg-red-500 inline-block\" />\n              <span className=\"text-sm font-medium\" data-testid=\"count-blocked\">{deniedCount}</span>\n              <span className=\"text-xs text-muted-foreground\">{t(\"pd.blocked\")}</span>\n            </div>\n          </div>\n\n          {!isDesktop && hiddenCount > 0 && (\n            <div className=\"flex items-center gap-2 px-3 py-2 rounded-md bg-muted/40 text-xs text-muted-foreground\" data-testid=\"web-hidden-notice\">\n              <Monitor className=\"w-3.5 h-3.5 shrink-0\" />\n              {t(\"pd.webHidden\")}\n            </div>\n          )}\n\n          <div className=\"grid gap-4\">\n            {filteredGroups.map(group => {\n              const GroupIcon = group.icon;\n              return (\n                <div key={group.id} data-testid={`perm-group-${group.id}`}>\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <GroupIcon className=\"h-4 w-4 text-muted-foreground\" />\n                    <span className=\"text-sm font-medium\">{t(`pd.group.${group.id}`)}</span>\n                  </div>\n                  <div className=\"grid gap-1\">\n                    {group.keys.map(pk => {\n                      const perm = effective[pk.key];\n                      if (!perm) return null;\n                      const label = language === \"ko\" ? pk.labelKo : pk.labelEn;\n                      const isOverride = perm.source === \"bot\";\n                      const isEgress = pk.isEgress;\n\n                      return (\n                        <div\n                          key={pk.key}\n                          className=\"flex items-center justify-between gap-2 p-2 rounded-md border hover-elevate cursor-pointer\"\n                          onClick={() => openDetail(pk)}\n                          data-testid={`perm-row-${pk.key}`}\n                        >\n                          <div className=\"flex items-center gap-2 min-w-0 flex-1\">\n                            <span className={`w-2 h-2 rounded-full shrink-0 ${getStatusDot(perm.approvalMode)}`} />\n                            <span className=\"text-sm truncate\">{label}</span>\n                            {pk.risk === \"HIGH\" && (\n                              <Badge variant=\"destructive\" className=\"text-[10px] gap-0.5\" data-testid={`risk-badge-${pk.key}`}>\n                                <AlertTriangle className=\"w-2.5 h-2.5\" />\n                                {t(\"pd.highRisk\")}\n                              </Badge>\n                            )}\n                            {isDesktop && pk.localOnly && (\n                              <Badge variant=\"outline\" className=\"text-[10px] gap-0.5\" data-testid={`local-badge-${pk.key}`}>\n                                <Monitor className=\"w-2.5 h-2.5\" />\n                                {t(\"pd.localOnly\")}\n                              </Badge>\n                            )}\n                            {isOverride && (\n                              <Badge variant=\"outline\" className=\"text-[10px]\">{t(\"perm.source.bot\")}</Badge>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-1.5 shrink-0\">\n                            {isEgress ? (\n                              <Badge variant={perm.egressLevel === \"NO_EGRESS\" ? \"destructive\" : perm.egressLevel === \"FULL_CONTENT_ALLOWED\" ? \"default\" : \"secondary\"}>\n                                {t(`perm.egress.${perm.egressLevel}` as any) || perm.egressLevel}\n                              </Badge>\n                            ) : (\n                              <span className={`text-xs font-medium ${getStatusColor(perm.approvalMode)}`}>\n                                {t(`perm.mode.${perm.approvalMode}` as any)}\n                              </span>\n                            )}\n                            <ChevronRight className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          {recentAudit.length > 0 && (\n            <div data-testid=\"perm-audit-history\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-sm font-medium\">{t(\"pd.recentHistory\")}</span>\n              </div>\n              <div className=\"grid gap-1\">\n                {recentAudit.map(entry => (\n                  <div key={entry.id} className=\"flex items-center justify-between gap-2 px-2 py-1.5 text-xs\" data-testid={`audit-row-${entry.id}`}>\n                    <div className=\"flex items-center gap-2 min-w-0\">\n                      <Badge variant=\"outline\" className=\"text-[10px] shrink-0\">\n                        {t(`audit.${entry.eventType}` as any) || entry.eventType}\n                      </Badge>\n                      <span className=\"text-muted-foreground truncate\">{entry.permissionKey}</span>\n                    </div>\n                    <span className=\"text-muted-foreground shrink-0\">{formatTimeAgo(entry.createdAt, language)}</span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={modalOpen} onOpenChange={setModalOpen}>\n        <DialogContent className=\"max-w-md\" data-testid=\"dialog-permission-detail\">\n          {selectedPerm && effective[selectedPerm.key] && (() => {\n            const perm = effective[selectedPerm.key];\n            const label = language === \"ko\" ? selectedPerm.labelKo : selectedPerm.labelEn;\n            const desc = language === \"ko\" ? selectedPerm.descKo : selectedPerm.descEn;\n\n            return (\n              <>\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center gap-2\">\n                    <span className={`w-2.5 h-2.5 rounded-full ${getStatusDot(perm.approvalMode)}`} />\n                    {label}\n                  </DialogTitle>\n                </DialogHeader>\n                <div className=\"grid gap-4 py-2\">\n                  <div>\n                    <p className=\"text-sm font-medium mb-1\">{t(\"pd.currentStatus\")}</p>\n                    <div className=\"flex items-center gap-2\">\n                      <span className={`text-sm font-medium ${getStatusColor(perm.approvalMode)}`}>\n                        {t(`perm.mode.${perm.approvalMode}` as any)}\n                      </span>\n                      {perm.source !== \"default\" && (\n                        <Badge variant=\"outline\" className=\"text-[10px]\">{t(`perm.source.${perm.source}` as any)}</Badge>\n                      )}\n                    </div>\n                  </div>\n\n                  <div>\n                    <p className=\"text-sm font-medium mb-1\">{t(\"pd.description\")}</p>\n                    <p className=\"text-sm text-muted-foreground\">{desc}</p>\n                  </div>\n\n                  <div>\n                    <p className=\"text-sm font-medium mb-1\">{t(\"pd.riskLevel\")}</p>\n                    <Badge variant={getRiskVariant(selectedPerm.risk)}>\n                      {selectedPerm.risk === \"HIGH\" && <AlertTriangle className=\"w-3 h-3 mr-1\" />}\n                      {t(`perm.risk.${selectedPerm.risk}` as any)}\n                    </Badge>\n                  </div>\n\n                  <div className=\"border-t pt-3\">\n                    <p className=\"text-sm font-medium mb-2\">{t(\"pd.changeStatus\")}</p>\n                    {selectedPerm.isEgress ? (\n                      <>\n                        <Select value={pendingEgress} onValueChange={(v) => setPendingEgress(v as EgressLevel)}>\n                          <SelectTrigger data-testid=\"select-egress-level\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"NO_EGRESS\">{t(\"perm.egress.NO_EGRESS\")}</SelectItem>\n                            <SelectItem value=\"METADATA_ONLY\">{t(\"perm.egress.METADATA_ONLY\")}</SelectItem>\n                            {isDesktop && (\n                              <SelectItem value=\"FULL_CONTENT_ALLOWED\">{t(\"perm.egress.FULL_CONTENT_ALLOWED\")}</SelectItem>\n                            )}\n                          </SelectContent>\n                        </Select>\n                        {!isDesktop && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">{t(\"pd.egressWebNote\")}</p>\n                        )}\n                      </>\n                    ) : (\n                      <RadioGroup value={pendingMode} onValueChange={(v) => setPendingMode(v as ApprovalMode)} className=\"grid gap-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <RadioGroupItem value=\"AUTO_ALLOWED\" id=\"mode-allowed\" data-testid=\"radio-mode-allowed\" />\n                          <Label htmlFor=\"mode-allowed\" className=\"flex items-center gap-1.5 cursor-pointer\">\n                            <span className=\"w-2 h-2 rounded-full bg-green-500\" />\n                            {t(\"perm.mode.AUTO_ALLOWED\")}\n                          </Label>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <RadioGroupItem value=\"APPROVAL_REQUIRED\" id=\"mode-approval\" data-testid=\"radio-mode-approval\" />\n                          <Label htmlFor=\"mode-approval\" className=\"flex items-center gap-1.5 cursor-pointer\">\n                            <span className=\"w-2 h-2 rounded-full bg-yellow-500\" />\n                            {t(\"perm.mode.APPROVAL_REQUIRED\")}\n                          </Label>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <RadioGroupItem value=\"AUTO_DENIED\" id=\"mode-denied\" data-testid=\"radio-mode-denied\" />\n                          <Label htmlFor=\"mode-denied\" className=\"flex items-center gap-1.5 cursor-pointer\">\n                            <span className=\"w-2 h-2 rounded-full bg-red-500\" />\n                            {t(\"perm.mode.AUTO_DENIED\")}\n                          </Label>\n                        </div>\n                      </RadioGroup>\n                    )}\n                  </div>\n\n                  <div>\n                    <p className=\"text-sm font-medium mb-2\">{t(\"pd.applyScope\")}</p>\n                    <RadioGroup value={scope} onValueChange={(v) => setScope(v as \"bot\" | \"global\")} className=\"grid gap-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <RadioGroupItem value=\"bot\" id=\"scope-bot\" data-testid=\"radio-scope-bot\" />\n                        <Label htmlFor=\"scope-bot\" className=\"cursor-pointer\">{t(\"pd.thisBotOnly\")}</Label>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <RadioGroupItem value=\"global\" id=\"scope-global\" data-testid=\"radio-scope-global\" />\n                        <Label htmlFor=\"scope-global\" className=\"cursor-pointer\">{t(\"pd.allBots\")}</Label>\n                      </div>\n                    </RadioGroup>\n                  </div>\n\n                  <div className=\"flex items-center justify-between gap-2 pt-2 border-t\">\n                    {perm.source === \"bot\" && (\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          resetMutation.mutate(selectedPerm.key);\n                          setModalOpen(false);\n                        }}\n                        disabled={isUpdating}\n                        data-testid=\"button-reset-perm\"\n                      >\n                        <RotateCcw className=\"w-3.5 h-3.5 mr-1\" />\n                        {t(\"pd.resetToGlobal\")}\n                      </Button>\n                    )}\n                    <div className=\"flex items-center gap-2 ml-auto\">\n                      <Button variant=\"outline\" onClick={() => setModalOpen(false)} data-testid=\"button-cancel-perm\">\n                        {t(\"approval.deny\")}\n                      </Button>\n                      <Button onClick={handleSave} disabled={isUpdating} data-testid=\"button-save-perm\">\n                        {t(\"pd.changeStatus\")}\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              </>\n            );\n          })()}\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","path":null,"size_bytes":23717,"size_tokens":null},"shared/permission-messages.ts":{"content":"export interface PermissionRequestMessage {\n  titleEn: string;\n  titleKo: string;\n  whyEn: string;\n  whyKo: string;\n  impactEn: string;\n  impactKo: string;\n  riskEn: string;\n  riskKo: string;\n}\n\nexport const PERMISSION_REQUEST_MESSAGES: Record<string, PermissionRequestMessage> = {\n  SOURCE_WRITE: {\n    titleEn: \"Wants to modify sources\",\n    titleKo: \"소스를 변경하려고 합니다\",\n    whyEn: \"Permission is needed to add, edit, or delete sources.\",\n    whyKo: \"소스를 추가/수정/삭제하려면 권한이 필요합니다.\",\n    impactEn: \"The scope of information your bot collects will change.\",\n    impactKo: \"봇이 수집하는 정보의 범위가 달라집니다.\",\n    riskEn: \"Untrusted sources may be included.\",\n    riskKo: \"신뢰되지 않는 소스가 포함될 수 있습니다.\",\n  },\n  WEB_FETCH: {\n    titleEn: \"Wants to fetch web data\",\n    titleKo: \"웹 데이터를 수집하려고 합니다\",\n    whyEn: \"Needs to retrieve information from external web pages.\",\n    whyKo: \"외부 웹 페이지에서 정보를 가져오려 합니다.\",\n    impactEn: \"Data will be read from the internet.\",\n    impactKo: \"인터넷을 통해 데이터를 읽습니다.\",\n    riskEn: \"Unnecessary data collection may occur.\",\n    riskKo: \"불필요한 데이터 수집이 발생할 수 있습니다.\",\n  },\n  WEB_RSS: {\n    titleEn: \"Wants to collect RSS feeds\",\n    titleKo: \"RSS 피드를 수집하려고 합니다\",\n    whyEn: \"Needs to read registered RSS sources.\",\n    whyKo: \"등록된 RSS 소스를 읽기 위해 필요합니다.\",\n    impactEn: \"Content from RSS feeds will be collected and stored.\",\n    impactKo: \"RSS 피드의 콘텐츠를 수집하여 저장합니다.\",\n    riskEn: \"Feed volume may increase storage usage.\",\n    riskKo: \"피드 양에 따라 저장 공간이 증가할 수 있습니다.\",\n  },\n  LLM_USE: {\n    titleEn: \"Wants to use AI analysis\",\n    titleKo: \"AI 분석을 사용하려고 합니다\",\n    whyEn: \"AI provider access is needed for content analysis and reports.\",\n    whyKo: \"콘텐츠 분석과 리포트 생성을 위해 AI 제공자 접근이 필요합니다.\",\n    impactEn: \"Content will be sent to an external AI service for processing.\",\n    impactKo: \"콘텐츠가 외부 AI 서비스로 전송되어 처리됩니다.\",\n    riskEn: \"API usage costs may be incurred.\",\n    riskKo: \"API 사용 비용이 발생할 수 있습니다.\",\n  },\n  LLM_EGRESS_LEVEL: {\n    titleEn: \"Wants to send more data to AI\",\n    titleKo: \"AI에 더 많은 데이터를 전송하려고 합니다\",\n    whyEn: \"A higher data egress level is needed for full analysis.\",\n    whyKo: \"전체 분석을 위해 더 높은 수준의 데이터 전송이 필요합니다.\",\n    impactEn: \"More content (e.g., full article text) will be sent to the AI provider.\",\n    impactKo: \"더 많은 콘텐츠(예: 기사 전문)가 AI 제공자에게 전송됩니다.\",\n    riskEn: \"Sensitive information may be exposed to external services.\",\n    riskKo: \"민감한 정보가 외부 서비스에 노출될 수 있습니다.\",\n  },\n  SCHEDULE_WRITE: {\n    titleEn: \"Wants to modify schedules\",\n    titleKo: \"스케줄을 변경하려고 합니다\",\n    whyEn: \"Permission is needed to create or change run schedules.\",\n    whyKo: \"실행 스케줄을 생성/변경하려면 권한이 필요합니다.\",\n    impactEn: \"The bot's automated run times will change.\",\n    impactKo: \"봇의 자동 실행 시간이 변경됩니다.\",\n    riskEn: \"Frequent schedules may increase resource usage.\",\n    riskKo: \"빈번한 스케줄은 리소스 사용량을 증가시킬 수 있습니다.\",\n  },\n  FS_READ: {\n    titleEn: \"Wants to read local files\",\n    titleKo: \"로컬 파일을 읽으려고 합니다\",\n    whyEn: \"Permission is needed to read files from designated folders.\",\n    whyKo: \"지정된 폴더에서 파일을 읽으려면 권한이 필요합니다.\",\n    impactEn: \"The bot will access files on your local system.\",\n    impactKo: \"봇이 로컬 시스템의 파일에 접근합니다.\",\n    riskEn: \"Sensitive local files may be read.\",\n    riskKo: \"민감한 로컬 파일이 읽힐 수 있습니다.\",\n  },\n  FS_WRITE: {\n    titleEn: \"Wants to write local files\",\n    titleKo: \"로컬 파일을 쓰려고 합니다\",\n    whyEn: \"Permission is needed to create or modify files.\",\n    whyKo: \"파일을 생성하거나 수정하려면 권한이 필요합니다.\",\n    impactEn: \"New files will be created or existing files modified.\",\n    impactKo: \"새 파일이 생성되거나 기존 파일이 수정됩니다.\",\n    riskEn: \"Existing files may be overwritten.\",\n    riskKo: \"기존 파일이 덮어쓰여질 수 있습니다.\",\n  },\n  FS_DELETE: {\n    titleEn: \"Wants to delete files\",\n    titleKo: \"파일을 삭제하려고 합니다\",\n    whyEn: \"Permission is needed to move files to trash.\",\n    whyKo: \"파일을 휴지통으로 이동하려면 권한이 필요합니다.\",\n    impactEn: \"Files will be moved to the trash (not permanently deleted).\",\n    impactKo: \"파일이 휴지통으로 이동됩니다 (영구 삭제 아님).\",\n    riskEn: \"Important files may be accidentally removed.\",\n    riskKo: \"중요한 파일이 실수로 삭제될 수 있습니다.\",\n  },\n  CAL_READ: {\n    titleEn: \"Wants to read calendar\",\n    titleKo: \"캘린더를 읽으려고 합니다\",\n    whyEn: \"Calendar access is needed to include events in briefings.\",\n    whyKo: \"브리핑에 일정을 포함하려면 캘린더 접근이 필요합니다.\",\n    impactEn: \"Your calendar events will be visible to this bot.\",\n    impactKo: \"캘린더 일정이 이 봇에게 보이게 됩니다.\",\n    riskEn: \"Private schedule information may be accessed.\",\n    riskKo: \"비공개 일정 정보에 접근할 수 있습니다.\",\n  },\n  CAL_WRITE: {\n    titleEn: \"Wants to modify calendar\",\n    titleKo: \"캘린더를 수정하려고 합니다\",\n    whyEn: \"Permission is needed to create or update calendar events.\",\n    whyKo: \"캘린더 일정을 생성/수정하려면 권한이 필요합니다.\",\n    impactEn: \"New events may be added or existing ones changed.\",\n    impactKo: \"새 일정이 추가되거나 기존 일정이 변경됩니다.\",\n    riskEn: \"Calendar events may be unexpectedly modified.\",\n    riskKo: \"캘린더 일정이 예상치 않게 변경될 수 있습니다.\",\n  },\n  MEMORY_WRITE: {\n    titleEn: \"Wants to save rules & preferences\",\n    titleKo: \"규칙/선호를 저장하려고 합니다\",\n    whyEn: \"Permission is needed to save or modify user rules and preferences in long-term memory.\",\n    whyKo: \"장기 메모리에 사용자 규칙과 선호를 저장/수정하려면 권한이 필요합니다.\",\n    impactEn: \"Your saved rules will affect how reports are generated.\",\n    impactKo: \"저장된 규칙이 리포트 생성 방식에 영향을 줍니다.\",\n    riskEn: \"Rules may override default behavior.\",\n    riskKo: \"규칙이 기본 동작을 변경할 수 있습니다.\",\n  },\n  DATA_RETENTION: {\n    titleEn: \"Wants to change data retention policy\",\n    titleKo: \"데이터 보존 정책을 변경하려고 합니다\",\n    whyEn: \"Permission is needed to modify how long collected data and memory are retained.\",\n    whyKo: \"수집된 데이터와 메모리의 보존 기간을 변경하려면 권한이 필요합니다.\",\n    impactEn: \"Data retention periods will change, which may affect available history.\",\n    impactKo: \"데이터 보존 기간이 변경되어 사용 가능한 히스토리에 영향을 줄 수 있습니다.\",\n    riskEn: \"Shorter retention may result in data loss.\",\n    riskKo: \"보존 기간 단축 시 데이터가 손실될 수 있습니다.\",\n  },\n};\n\nexport type ApprovalScope = \"once\" | \"bot\" | \"global\";\n\nexport interface PermissionApprovalRequest {\n  permissionKey: string;\n  botId?: number | null;\n  action: string;\n  actionPayload?: any;\n}\n\nexport interface PermissionApprovalResponse {\n  requiresApproval: true;\n  permissionKey: string;\n  reason: string;\n  message: PermissionRequestMessage;\n}\n","path":null,"size_bytes":8010,"size_tokens":null},"client/src/components/permission-request-modal.tsx":{"content":"import { useState } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { ShieldAlert, AlertTriangle, Info, Zap } from \"lucide-react\";\nimport { useLanguage } from \"@/lib/language-provider\";\nimport type { PermissionRequest } from \"@/hooks/use-permission-request\";\n\ninterface PermissionRequestModalProps {\n  request: PermissionRequest | null;\n}\n\nexport function PermissionRequestModal({ request }: PermissionRequestModalProps) {\n  const { t, language } = useLanguage();\n  const [scope, setScope] = useState<\"once\" | \"bot\" | \"global\">(\"once\");\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  if (!request) return null;\n\n  const msg = request.message;\n  const title = msg ? (language === \"ko\" ? msg.titleKo : msg.titleEn) : request.permissionKey;\n  const why = msg ? (language === \"ko\" ? msg.whyKo : msg.whyEn) : \"\";\n  const impact = msg ? (language === \"ko\" ? msg.impactKo : msg.impactEn) : \"\";\n  const risk = msg ? (language === \"ko\" ? msg.riskKo : msg.riskEn) : \"\";\n\n  const hasBotContext = request.botId != null;\n\n  async function handleApprove() {\n    setIsSubmitting(true);\n    try {\n      await request.onApprove(scope);\n    } finally {\n      setIsSubmitting(false);\n    }\n  }\n\n  function handleDeny() {\n    request.onDeny();\n  }\n\n  return (\n    <Dialog open={true} onOpenChange={(open) => { if (!open) handleDeny(); }}>\n      <DialogContent className=\"sm:max-w-md\" data-testid=\"modal-permission-request\">\n        <DialogHeader>\n          <div className=\"flex items-center gap-2\">\n            <ShieldAlert className=\"h-5 w-5 text-amber-500 dark:text-amber-400 shrink-0\" />\n            <DialogTitle className=\"text-base\" data-testid=\"text-approval-title\">\n              {title}\n            </DialogTitle>\n          </div>\n          <p className=\"text-sm text-muted-foreground mt-1\" data-testid=\"text-approval-subtitle\">\n            {t(\"approval.title\")}\n          </p>\n        </DialogHeader>\n\n        <div className=\"space-y-3 py-2\">\n          {why && (\n            <div className=\"flex gap-2 text-sm\" data-testid=\"section-why\">\n              <Info className=\"h-4 w-4 text-blue-500 dark:text-blue-400 shrink-0 mt-0.5\" />\n              <div>\n                <span className=\"font-medium text-muted-foreground\">{t(\"approval.why\")}</span>\n                <p className=\"mt-0.5\">{why}</p>\n              </div>\n            </div>\n          )}\n\n          {impact && (\n            <div className=\"flex gap-2 text-sm\" data-testid=\"section-impact\">\n              <Zap className=\"h-4 w-4 text-green-500 dark:text-green-400 shrink-0 mt-0.5\" />\n              <div>\n                <span className=\"font-medium text-muted-foreground\">{t(\"approval.impact\")}</span>\n                <p className=\"mt-0.5\">{impact}</p>\n              </div>\n            </div>\n          )}\n\n          {risk && (\n            <div className=\"flex gap-2 text-sm\" data-testid=\"section-risk\">\n              <AlertTriangle className=\"h-4 w-4 text-amber-500 dark:text-amber-400 shrink-0 mt-0.5\" />\n              <div>\n                <span className=\"font-medium text-muted-foreground\">{t(\"approval.risk\")}</span>\n                <p className=\"mt-0.5\">{risk}</p>\n              </div>\n            </div>\n          )}\n\n          <div className=\"pt-2 border-t\" data-testid=\"section-scope\">\n            <p className=\"text-sm font-medium text-muted-foreground mb-2\">{t(\"approval.scope\")}</p>\n            <RadioGroup\n              value={scope}\n              onValueChange={(v) => setScope(v as \"once\" | \"bot\" | \"global\")}\n              className=\"space-y-2\"\n            >\n              <div className=\"flex items-center gap-2\">\n                <RadioGroupItem value=\"once\" id=\"scope-once\" data-testid=\"radio-scope-once\" />\n                <Label htmlFor=\"scope-once\" className=\"text-sm cursor-pointer\">\n                  {t(\"approval.scopeOnce\")}\n                </Label>\n              </div>\n              {hasBotContext && (\n                <div className=\"flex items-center gap-2\">\n                  <RadioGroupItem value=\"bot\" id=\"scope-bot\" data-testid=\"radio-scope-bot\" />\n                  <Label htmlFor=\"scope-bot\" className=\"text-sm cursor-pointer\">\n                    {t(\"approval.scopeBot\")}\n                  </Label>\n                </div>\n              )}\n              <div className=\"flex items-center gap-2\">\n                <RadioGroupItem value=\"global\" id=\"scope-global\" data-testid=\"radio-scope-global\" />\n                <Label htmlFor=\"scope-global\" className=\"text-sm cursor-pointer\">\n                  {t(\"approval.scopeGlobal\")}\n                </Label>\n              </div>\n            </RadioGroup>\n          </div>\n\n          <p className=\"text-xs text-muted-foreground pt-1\" data-testid=\"text-control-note\">\n            {t(\"approval.youAreInControl\")}\n          </p>\n        </div>\n\n        <DialogFooter className=\"flex flex-row gap-2 justify-end\">\n          <Button\n            variant=\"outline\"\n            onClick={handleDeny}\n            disabled={isSubmitting}\n            data-testid=\"button-approval-deny\"\n          >\n            {t(\"approval.deny\")}\n          </Button>\n          <Button\n            onClick={handleApprove}\n            disabled={isSubmitting}\n            data-testid=\"button-approval-approve\"\n          >\n            {isSubmitting ? t(\"approval.approve\") + \"...\" : t(\"approval.approve\")}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":5705,"size_tokens":null},"server/policy/engine.ts":{"content":"import { storage } from \"../storage\";\nimport type { Permission } from \"@shared/schema\";\nimport {\n  type PermissionKey,\n  type PermissionValue,\n  type ApprovalMode,\n  type EgressLevel,\n  type PolicyContext,\n  type PermissionCheckResult,\n  type EgressCheckResult,\n  getDefaultPermissionValue,\n  getDefaultEgressLevel,\n} from \"./types\";\n\nexport async function getEffectivePermissions(\n  userId: string,\n  botId?: number | null,\n): Promise<Record<string, PermissionValue & { egressLevel?: EgressLevel; source: \"default\" | \"global\" | \"bot\" }>> {\n  const globalPerms = await storage.listPermissions(userId, \"global\", null);\n  const botPerms = botId ? await storage.listPermissions(userId, \"bot\", botId) : [];\n\n  const result: Record<string, PermissionValue & { egressLevel?: EgressLevel; source: \"default\" | \"global\" | \"bot\" }> = {};\n\n  const allKeys: PermissionKey[] = [\n    \"WEB_RSS\", \"WEB_FETCH\", \"SOURCE_WRITE\",\n    \"LLM_USE\", \"LLM_EGRESS_LEVEL\",\n    \"FS_READ\", \"FS_WRITE\", \"FS_DELETE\",\n    \"CAL_READ\", \"CAL_WRITE\", \"SCHEDULE_WRITE\",\n    \"MEMORY_WRITE\", \"DATA_RETENTION\",\n  ];\n\n  for (const key of allKeys) {\n    const defaultVal = getDefaultPermissionValue(key);\n    const defaultEgress = key === \"LLM_EGRESS_LEVEL\" ? getDefaultEgressLevel(key) : undefined;\n\n    let effective: PermissionValue & { egressLevel?: EgressLevel; source: \"default\" | \"global\" | \"bot\" } = {\n      ...defaultVal,\n      egressLevel: defaultEgress,\n      source: \"default\",\n    };\n\n    const globalPerm = globalPerms.find(p => p.permissionKey === key);\n    if (globalPerm) {\n      const val = globalPerm.valueJson as any;\n      effective = {\n        enabled: val.enabled ?? defaultVal.enabled,\n        approvalMode: val.approvalMode ?? defaultVal.approvalMode,\n        resourceScope: val.resourceScope,\n        egressLevel: val.egressLevel ?? defaultEgress,\n        source: \"global\",\n      };\n    }\n\n    const botPerm = botPerms.find(p => p.permissionKey === key);\n    if (botPerm) {\n      const val = botPerm.valueJson as any;\n      effective = {\n        enabled: val.enabled ?? effective.enabled,\n        approvalMode: val.approvalMode ?? effective.approvalMode,\n        resourceScope: val.resourceScope ?? effective.resourceScope,\n        egressLevel: val.egressLevel ?? effective.egressLevel,\n        source: \"bot\",\n      };\n    }\n\n    result[key] = effective;\n  }\n\n  return result;\n}\n\nexport async function checkPermission(\n  ctx: PolicyContext,\n  permissionKey: PermissionKey,\n): Promise<PermissionCheckResult> {\n  const perms = await getEffectivePermissions(ctx.userId, ctx.botId);\n  const policy = perms[permissionKey];\n\n  if (!policy) {\n    return {\n      allowed: false,\n      requiresApproval: false,\n      reason: `Unknown permission: ${permissionKey}`,\n      effectivePolicy: null,\n    };\n  }\n\n  if (!policy.enabled) {\n    return {\n      allowed: false,\n      requiresApproval: false,\n      reason: `Permission '${permissionKey}' is disabled`,\n      effectivePolicy: policy,\n    };\n  }\n\n  if (policy.approvalMode === \"AUTO_DENIED\") {\n    return {\n      allowed: false,\n      requiresApproval: false,\n      reason: `Permission '${permissionKey}' is denied by policy`,\n      effectivePolicy: policy,\n    };\n  }\n\n  if (policy.approvalMode === \"APPROVAL_REQUIRED\") {\n    return {\n      allowed: false,\n      requiresApproval: true,\n      reason: `Permission '${permissionKey}' requires approval`,\n      effectivePolicy: policy,\n    };\n  }\n\n  return {\n    allowed: true,\n    requiresApproval: false,\n    reason: \"Allowed\",\n    effectivePolicy: policy,\n  };\n}\n\nexport async function checkEgress(\n  ctx: PolicyContext,\n  requiredLevel: EgressLevel,\n): Promise<EgressCheckResult> {\n  const perms = await getEffectivePermissions(ctx.userId, ctx.botId);\n  const llmUse = perms[\"LLM_USE\"];\n  const egressPolicy = perms[\"LLM_EGRESS_LEVEL\"];\n\n  if (!llmUse?.enabled) {\n    return {\n      allowed: false,\n      reason: \"LLM usage is disabled\",\n      effectiveLevel: \"NO_EGRESS\",\n    };\n  }\n\n  const effectiveLevel: EgressLevel = egressPolicy?.egressLevel || \"NO_EGRESS\";\n\n  const levelOrder: Record<EgressLevel, number> = {\n    \"NO_EGRESS\": 0,\n    \"METADATA_ONLY\": 1,\n    \"FULL_CONTENT_ALLOWED\": 2,\n  };\n\n  if (levelOrder[requiredLevel] > levelOrder[effectiveLevel]) {\n    return {\n      allowed: false,\n      reason: `Data egress level '${requiredLevel}' exceeds allowed level '${effectiveLevel}'`,\n      effectiveLevel,\n    };\n  }\n\n  return {\n    allowed: true,\n    reason: \"Egress allowed\",\n    effectiveLevel,\n  };\n}\n\nexport async function logPermissionAction(\n  ctx: PolicyContext,\n  eventType: string,\n  permissionKey: string | null,\n  payload: any,\n): Promise<void> {\n  try {\n    await storage.createAuditLog({\n      userId: ctx.userId,\n      botId: ctx.botId ?? null,\n      threadId: ctx.threadId ?? null,\n      eventType,\n      permissionKey,\n      payloadJson: payload,\n    });\n  } catch (e) {\n    console.error(\"[PolicyEngine] Failed to write audit log:\", e);\n  }\n}\n","path":null,"size_bytes":4949,"size_tokens":null},"script/build-desktop.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile, mkdir, cp } from \"fs/promises\";\nimport path from \"path\";\n\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"node-cron\",\n  \"nodemailer\",\n  \"passport\",\n  \"passport-local\",\n  \"rss-parser\",\n  \"ws\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildDesktop() {\n  console.log(\"=== Maker Desktop Build ===\\n\");\n\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"[1/5] Building client (Vite)...\");\n  await viteBuild();\n\n  console.log(\"[2/5] Bundling server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n  externals.push(\"better-sqlite3\");\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/server/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n\n  console.log(\"[3/5] Copying client assets to server/public...\");\n  await cp(\"dist/public\", \"dist/server/public\", { recursive: true });\n\n  console.log(\"[4/5] Compiling Electron main & preload...\");\n  await esbuild({\n    entryPoints: [\"electron/main.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/electron/main.cjs\",\n    external: [\"electron\", \"better-sqlite3\"],\n    logLevel: \"info\",\n  });\n\n  await esbuild({\n    entryPoints: [\"electron/preload.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/electron/preload.cjs\",\n    external: [\"electron\"],\n    logLevel: \"info\",\n  });\n\n  console.log(\"[5/5] Build complete!\");\n  console.log(\"\\nOutput:\");\n  console.log(\"  dist/server/public/ — Frontend assets\");\n  console.log(\"  dist/server/        — Bundled server\");\n  console.log(\"  dist/electron/      — Electron main + preload\");\n  console.log(\"\\nNext: npm run pack:desktop\");\n}\n\nbuildDesktop().catch((err) => {\n  console.error(\"Desktop build failed:\", err);\n  process.exit(1);\n});\n","path":null,"size_bytes":2439,"size_tokens":null},"LOCAL_SETUP.md":{"content":"# Maker Desktop - Setup & Run Guide\n\n---\n\n## Download Installers (Easiest Method)\n\nDownload the installer for your OS from GitHub Releases:\n\n**[https://github.com/Salepark/maker/releases](https://github.com/Salepark/maker/releases)**\n\n| OS | Download File | How to Install |\n|----|---------------|----------------|\n| Windows | `Maker.exe` (portable) or `Maker-Setup.exe` (installer) | Double-click to run |\n| Mac | `Maker.dmg` | Double-click > Drag Maker to Applications |\n| Linux | `Maker.AppImage` | `chmod +x Maker.AppImage` then run |\n\nInstallers are automatically updated with each new code release.\n\n### Mac: \"Cannot verify developer\" warning\n\nRight-click Maker.app > Select \"Open\" (only needed once).\n\n---\n\n## Build from Source (For Developers)\n\nBelow are instructions for cloning the code and running in development mode.\n\n`clone` -> `npm install` -> `npm run dev:desktop` — That's it, 3 steps.\n\n---\n\n## Prerequisites\n\n### Required Software\n\n| Item | Minimum Version | Check Command |\n|------|-----------------|---------------|\n| Node.js | 18+ | `node -v` |\n| npm | 9+ | `npm -v` |\n| Git | Latest | `git --version` |\n\n### OS-Specific Preparation\n\n**Mac:**\n```bash\nxcode-select --install\n```\n\n**Windows:**\n- Install [Visual Studio Build Tools](https://visualstudio.microsoft.com/visual-studio-build-tools/)\n- Select \"C++ Build Tools\" workload\n\n---\n\n## STEP 1 - Clone & Install\n\n```bash\ngit clone https://github.com/Salepark/maker.git\ncd maker\nnpm install\n```\n\nIf you get a `better-sqlite3` related error after `npm install`:\n```bash\nnpm rebuild better-sqlite3\n```\n\n---\n\n## STEP 2 - Run in Dev Mode\n\n```bash\nnpm run dev:desktop\n```\n\nThis single command works on Mac / Windows / Linux.\n(`cross-env` handles environment variables consistently across all OSes)\n\nUnder the hood, it runs:\n```\ncross-env MAKER_DB=sqlite MAKER_DESKTOP=true NODE_ENV=development electron -r tsx/register electron/main.ts\n```\n\n### What success looks like\n\n1. Terminal shows `[electron] Starting Maker desktop app...`\n2. Terminal shows `[server] serving on port 5000`\n3. Electron window opens\n4. Dashboard loads immediately **without a login screen** (local auto-login)\n\n### Basic Checks\n\n| Check | Expected Result |\n|-------|-----------------|\n| Electron window | Dashboard is displayed |\n| Login process | None (auto-login) |\n| Health check | Visit `http://localhost:5000/api/health` in browser — should show `driver: \"sqlite\"` |\n\n**If you've reached this point, you're 80% done.**\n\n---\n\n## STEP 3 - Test Basic Features\n\n### Add Sources & Test Fast Report\n\n1. Click \"Sources\" in the sidebar\n2. Add an RSS source (e.g., `https://news.ycombinator.com/rss`)\n3. Click \"Run Now\" on the bot detail page\n4. Confirm a Fast Report is generated within 2–3 seconds\n\n### Verify SQLite File\n\nAdding a source automatically creates the SQLite database file:\n\n**Mac:**\n```bash\nls ~/Library/Application\\ Support/Maker/maker.db\n```\n\n**Windows:**\n```powershell\ndir \"$env:APPDATA\\Maker\\maker.db\"\n```\n\n**Linux:**\n```bash\nls ~/.config/Maker/maker.db\n```\n\nIf the file exists, data is being saved correctly.\n\n---\n\n## STEP 4 - Production Build (Optional)\n\nTo create distributable executables (.app, .exe):\n\n```bash\n# 1. Bundle client + server\nnpm run build:desktop\n\n# 2. Package into executable\nnpm run pack:desktop\n```\n\nOutput is generated in the `dist-electron/` folder:\n\n| OS | Output Files |\n|----|-------------|\n| Mac | `Maker.app`, `Maker.dmg` |\n| Windows | `Maker.exe` (portable), `Maker Setup.exe` (installer) |\n| Linux | `Maker.AppImage`, `maker.deb` |\n\n---\n\n## Troubleshooting\n\n### 1. Electron window opens but screen is blank\n\n**Cause:** Page loaded before the server finished starting.\n\n**Fix:**\n- Check terminal for the `[server] serving on port 5000` log\n- Press `Cmd+R` (Mac) / `Ctrl+R` (Windows) to refresh\n\n### 2. `better-sqlite3` native module error\n\n```\nError: Module did not self-register\n```\n\n**Fix:**\n```bash\nnpm rebuild better-sqlite3\n```\n\nIf the error persists on Mac:\n```bash\nnpm rebuild better-sqlite3 --build-from-source\n```\n\n### 3. `npm run dev:desktop` doesn't work (manual run)\n\nRun directly without the script:\n\n**Mac / Linux:**\n```bash\nMAKER_DB=sqlite MAKER_DESKTOP=true NODE_ENV=development npx electron -r tsx/register electron/main.ts\n```\n\n**Windows (PowerShell):**\n```powershell\n$env:MAKER_DB=\"sqlite\"\n$env:MAKER_DESKTOP=\"true\"\n$env:NODE_ENV=\"development\"\nnpx electron -r tsx/register electron/main.ts\n```\n\n**Windows (CMD):**\n```cmd\nset MAKER_DB=sqlite\nset MAKER_DESKTOP=true\nset NODE_ENV=development\nnpx electron -r tsx/register electron/main.ts\n```\n\n### 4. Port 5000 already in use\n\n**Fix:**\n```bash\n# Mac/Linux\nlsof -i :5000 | grep LISTEN\nkill -9 <PID>\n\n# Windows\nnetstat -ano | findstr :5000\ntaskkill /PID <PID> /F\n```\n\n### 5. Code signing warning on Mac during packaging\n\nBuilding without code signing on Mac will trigger a \"Cannot verify developer\" warning.\n\n**Workaround for testing:**\n- Right-click `Maker.app` > Select \"Open\" (only needed once)\n\n**Or skip signing during build:**\n```bash\nCSC_IDENTITY_AUTO_DISCOVERY=false npm run pack:desktop\n```\n\n### 6. Server process remains running after app closes\n\n```bash\n# Mac/Linux\npkill -f \"tsx server/index.ts\"\n\n# Windows\ntaskkill /F /IM node.exe\n```\n\n---\n\n## Executable Testing Checklist\n\nAfter launching the built executable, verify the following:\n\n| Test Item | Pass |\n|-----------|------|\n| App launches (double-click) | |\n| Dashboard loads without login | |\n| Add RSS source | |\n| Fast Report generated (2–3 sec) | |\n| SQLite file created | |\n| Data persists after restart | |\n| Fast Report works offline | |\n\n---\n\n## npm Scripts Reference\n\n| Script | Purpose |\n|--------|---------|\n| `npm run dev:desktop` | Run Electron in dev mode (SQLite, auto-login) |\n| `npm run build:desktop` | Bundle client + server for production |\n| `npm run pack:desktop` | Package into .app / .exe / .AppImage |\n| `npm run dev` | Run cloud mode server (PostgreSQL) |\n\n---\n\n## Project Structure (Desktop-related)\n\n```\nmaker/\n├── electron/\n│   ├── main.ts               # Electron main process (starts server, creates window)\n│   ├── preload.ts            # Exposes window.maker / window.electronAPI to renderer\n│   └── electron-builder.yml  # Packaging configuration\n├── script/\n│   ├── build.ts              # Cloud build script\n│   └── build-desktop.ts      # Desktop build script (server + client + Electron)\n├── server/\n│   ├── db.ts                 # DB driver selector (PostgreSQL / SQLite)\n│   ├── init-sqlite.ts        # SQLite table initialization\n│   └── storage-sqlite.ts     # SQLite-specific storage implementation\n├── shared/\n│   ├── schema.ts             # PostgreSQL schema (Drizzle)\n│   └── schema.sqlite.ts      # SQLite schema (Drizzle)\n└── LOCAL_SETUP.md            # This document\n```\n\n---\n\n## Next Steps (After Testing)\n\n1. App icon & branding\n2. Auto-update (electron-updater)\n3. Code signing (Apple Developer / Windows Authenticode)\n4. Distribution channel setup (GitHub Releases)\n\n---\n\n## Need Help?\n\nCheck the terminal logs when running in dev mode:\n- `[electron]` — Electron main process logs\n- `[server]` — Express server logs\n- `[server:err]` — Server error logs\n\nInclude these logs when reporting issues for faster resolution.\n","path":null,"size_bytes":7309,"size_tokens":null},"INSTALL_GUIDE.md":{"content":"# Maker Desktop App - Installation & Troubleshooting Guide\n\n---\n\n## Download\n\nDownload the installer for your OS from **[GitHub Releases](https://github.com/Salepark/maker/releases)**.\n\n| OS | File | Size |\n|----|------|------|\n| Windows | `Maker-Setup.exe` (installer) or `Maker.exe` (portable) | ~280 MB |\n| Mac | `Maker.dmg` | ~280 MB |\n| Linux | `Maker.AppImage` or `maker.deb` | ~280 MB |\n\n---\n\n## Windows Installation\n\n### Install\n\n1. Download `Maker-Setup.exe`\n2. Double-click to run\n3. Choose install location (default recommended)\n4. After installation, launch **Maker** from the desktop or Start menu\n\n### Portable Version\n\nTo use without installing, download `Maker.exe` and run it directly.\n\n### Windows Troubleshooting\n\n#### \"Windows protected your PC\" warning (SmartScreen)\n\n> Windows Defender SmartScreen prevented an unrecognized app from starting.\n\n**Fix:**\n1. Click \"More info\"\n2. Click \"Run anyway\"\n\nThis warning appears for unsigned apps and only needs to be dismissed once.\n\n#### Blank Screen (White Screen)\n\n**Fix:**\n1. Fully close the app (right-click on taskbar > Close)\n2. Wait 10 seconds, then relaunch\n3. If it persists, run from Command Prompt to see error details:\n```cmd\n\"C:\\Users\\[YourUsername]\\AppData\\Local\\Programs\\Maker\\Maker.exe\"\n```\n\n#### Port 5000 Conflict\n\n> Error: listen EADDRINUSE: address already in use 127.0.0.1:5000\n\nThis occurs when a previous instance wasn't fully closed.\n\n**Fix (Command Prompt):**\n```cmd\nnetstat -ano | findstr :5000\ntaskkill /PID [displayed_PID] /F\n```\n\n**Or via Task Manager:**\n1. Press `Ctrl+Shift+Esc` to open Task Manager\n2. Find \"Maker\" or \"Node.js\" process\n3. Click \"End task\"\n4. Relaunch Maker\n\n---\n\n## Mac Installation\n\n### Install\n\n1. Download `Maker.dmg`\n2. Double-click to open the DMG\n3. Drag the Maker icon to the **Applications** folder\n4. Eject the DMG (right-click disk icon > Eject)\n\n### Mac Troubleshooting\n\n#### \"Cannot verify developer\" / \"Cannot confirm it is free from malware\"\n\n> \"Maker\" is from an unidentified developer and cannot be opened.\n\nThis is a macOS security warning for unsigned apps.\n\n**Fix (Method 1 — Terminal):**\n```bash\nsudo xattr -cr /Applications/Maker.app\n```\nEnter your password, then launch Maker.\n\n**Fix (Method 2 — Finder):**\n1. Open the Applications folder in Finder\n2. **Control-click** (or two-finger tap on trackpad) on Maker.app\n3. Select **\"Open\"** from the menu\n4. Click **\"Open\"** in the warning dialog\n\nThis only needs to be done once.\n\n#### App closes immediately after launch\n\n**Check the cause — run from Terminal:**\n```bash\n/Applications/Maker.app/Contents/MacOS/Maker\n```\nError messages will appear in the terminal.\n\n#### Blank Screen (White Screen)\n\nIf the server started but the screen is empty:\n\n**Fix 1 — Refresh:**\n- Press `Cmd + R` to reload the page\n\n**Fix 2 — Check for port conflict:**\n```bash\nlsof -ti:5000 | xargs kill -9\n```\nThen relaunch Maker.\n\n**Fix 3 — Verify server status from Terminal:**\n```bash\ncurl http://127.0.0.1:5000/api/health\n```\nIf you get a response, the server is running fine. Press `Cmd + R` to refresh.\n\n#### Port 5000 Conflict\n\n> Error: listen EADDRINUSE: address already in use 127.0.0.1:5000\n\nThis occurs when a previous instance wasn't fully closed.\n\n**Fix:**\n```bash\nlsof -ti:5000 | xargs kill -9\n```\nThen relaunch Maker.\n\n#### How to Fully Quit the App\n\nTo completely close Maker:\n- Click the **red X button** on the window, or\n- Press **Cmd + Q**\n\nThis also shuts down the server.\n\n---\n\n## Linux Installation\n\n### AppImage (Recommended)\n\n```bash\n# 1. Make the downloaded file executable\nchmod +x Maker.AppImage\n\n# 2. Run\n./Maker.AppImage\n```\n\n### Debian/Ubuntu (.deb)\n\n```bash\n# 1. Install\nsudo dpkg -i maker_amd64.deb\n\n# 2. Fix dependency issues (if any)\nsudo apt-get install -f\n\n# 3. Run\nmaker\n```\n\n### Linux Troubleshooting\n\n#### AppImage won't run\n\n```bash\n# Check execution permission\nchmod +x Maker.AppImage\n\n# FUSE may be required\nsudo apt-get install fuse libfuse2\n```\n\n#### Blank Screen\n\n```bash\n# Check port\nss -tlnp | grep 5000\n\n# Kill existing process if port is in use\nkill $(lsof -ti:5000)\n\n# Relaunch\n./Maker.AppImage\n```\n\n#### Sandbox Error\n\n> FATAL:setuid_sandbox_host.cc - The SUID sandbox helper binary was found...\n\n```bash\n# Run with --no-sandbox flag\n./Maker.AppImage --no-sandbox\n```\n\n---\n\n## Common Issues\n\n### Data Storage Location\n\nMaker stores its data in a local SQLite database:\n\n| OS | Path |\n|----|------|\n| Windows | `%AppData%\\maker\\maker.db` |\n| Mac | `~/Library/Application Support/maker/maker.db` |\n| Linux | `~/.config/maker/maker.db` |\n\n### Reset Data\n\nTo delete all data and start fresh, remove the `maker.db` file at the path above.\n\n**Mac:**\n```bash\nrm ~/Library/Application\\ Support/maker/maker.db\n```\n\n**Windows (PowerShell):**\n```powershell\nRemove-Item \"$env:APPDATA\\maker\\maker.db\"\n```\n\n### Checking Server Logs\n\nIf issues persist, run the app from the terminal to see detailed logs:\n\n| OS | Command |\n|----|---------|\n| Windows | `\"C:\\Users\\[YourUsername]\\AppData\\Local\\Programs\\Maker\\Maker.exe\"` |\n| Mac | `/Applications/Maker.app/Contents/MacOS/Maker` |\n| Linux | `./Maker.AppImage` (from terminal) |\n\nKey log messages to look for:\n- `[server] serving on port 5000` — Server started successfully\n- `[server:err]` — Server error\n- `EADDRINUSE` — Port conflict\n- `ENOTSUP` — Network error\n\n### LLM API Key Setup\n\nTo use AI analysis features, configure your LLM provider in the app:\n1. Launch Maker\n2. Click **Settings** in the sidebar\n3. Enter your API key in the **LLM Providers** section\n4. Supported services: OpenAI, Anthropic, Google AI, and more\n\n---\n\n## Version Info\n\n- Node.js: v20+ (bundled)\n- Electron: v33+\n- SQLite: better-sqlite3 (bundled)\n\n---\n\n## Need Help?\n\nReport issues with error messages on GitHub Issues:\n**[https://github.com/Salepark/maker/issues](https://github.com/Salepark/maker/issues)**\n\nWhen reporting, please include:\n1. OS type and version (e.g., macOS 15.3, Windows 11)\n2. Full error message (run from terminal to capture)\n3. Screenshots (if possible)\n","path":null,"size_bytes":6019,"size_tokens":null},"docs/PHILOSOPHY_EN.md":{"content":"# Maker Philosophy\n\n> **We don't trust AI. We trust the user's right to control it.**\n\n---\n\n## What is Maker?\n\nMaker is not another AI automation tool.\nIt is a **personal automation operating system for the AI era**.\n\nThere are plenty of AI tools. But there is no operating system for them yet.\nMaker fills that gap.\n\n---\n\n## 5 Core Principles\n\n### 1. Control always belongs to the user\nAI acts only with permission. Automation runs only with approval.\n\n### 2. Results are always guaranteed\nNo more staring at \"Running...\" screens. **Fast-first. Always.**\n\n### 3. Data belongs to the user\nSaaS absorbs your data. Maker keeps it right beside you.\n\n### 4. Automation assists, never replaces\nAutomation supports human decision-making. AI is a tool, not a boss.\n\n### 5. Nothing is hidden\nEverything collected, analyzed, and transmitted is recorded. That's why audit logs exist.\n\n---\n\n## 4 Design Principles\n\n| Principle | Meaning |\n|-----------|---------|\n| **Local First** | Your data stays on your machine |\n| **Permission by Design** | AI always asks before it acts |\n| **Fast-First Execution** | Results are delivered instantly |\n| **Human-in-Control** | Automated, but humans stay in charge |\n\n---\n\n## Why This Philosophy?\n\nThe AI market today has two extremes:\n- AI does everything autonomously\n- Tools that only connect services\n\nMaker is not in the middle. Maker says:\n\n> **AI is powerful. That's exactly why it must be controlled.**\n\nFeatures can be copied. Speed can be matched.\nBut the **\"control-first AI OS\"** position is not easy to replicate.\n\n---\n\n## Product Direction\n\n1. Push the local permission model to the end\n2. Maintain strong data egress controls\n3. Never run anything silently without approval\n4. Ensure 100% reliability on fast reports\n\n---\n\n> Maker doesn't make AI more powerful.\n> **Maker makes AI safe to use.**\n","path":null,"size_bytes":1838,"size_tokens":null},"README.md":{"content":"# Maker — Local-First Automation OS\n\n**Stop renting bots. Build your own.**\n\n[![License: AGPL-3.0](https://img.shields.io/badge/license-AGPL--3.0-blue)](LICENSE)\n[![Platform](https://img.shields.io/badge/platform-macOS%20%7C%20Windows%20%7C%20Linux-lightgrey)](https://github.com/Salepark/maker/releases)\n[![Release](https://img.shields.io/github/v/release/Salepark/maker)](https://github.com/Salepark/maker/releases)\n\n> We don't trust AI. We trust the user's right to control it.\n\nMaker is a personal automation operating system for the AI era.\nDesign your own workflows, control your own bots, own your own data.\n\n[Download from Releases](https://github.com/Salepark/maker/releases)\n\n---\n\n## Why Maker?\n\nOther tools say: *\"Use our bots.\"*\nMaker says: **\"Build your own system.\"**\n\n- **Local-first** — Your data stays on your machine. SQLite + Electron, no cloud required.\n- **Permission Engine** — 11 granular permissions. AI acts only with your approval.\n- **Fast-first reports** — Instant previews, never stuck on \"Running...\"\n- **Bring Your Own LLM** — Anthropic, OpenAI, Google AI, or any OpenAI-compatible endpoint.\n- **Full transparency** — Audit logs track everything: what was collected, analyzed, and sent.\n\n---\n\n## Features\n\n- Multi-bot management with strict topic isolation\n- Template Gallery with guided setup wizard\n- Fast-first report pipeline (instant previews, async full reports)\n- 11-permission policy engine with audit logging\n- Bring Your Own LLM (Anthropic, OpenAI, Google AI, custom endpoints)\n- Command Chat — natural language bot control\n- Bilingual interface (English / Korean)\n- Desktop app (Electron + SQLite) with auto-login\n- Cloud deployment (PostgreSQL) with Replit Auth\n\n---\n\n## Getting Started\n\n### Desktop (Recommended)\n\nPre-built installers for Windows, macOS, and Linux are available in [GitHub Releases](https://github.com/Salepark/maker/releases).\n\nSee [`LOCAL_SETUP.md`](LOCAL_SETUP.md) for detailed instructions.\n\n```bash\nMAKER_DB=sqlite npm run dev          # SQLite browser mode\nnpm run dev:desktop                   # Electron desktop app\nnpm run build:desktop && npm run pack:desktop  # Build installer\n```\n\n### Cloud (Replit)\n\n1. Fork this repository on Replit\n2. Set up a PostgreSQL database\n3. Configure environment variables (`DATABASE_URL`, `SESSION_SECRET`, `LLM_API_KEY`)\n4. Run `npm run dev`\n\n---\n\n## Philosophy\n\nMaker exists to help individuals design and control their own automation workflows.\n\nRead the full philosophy: [`docs/PHILOSOPHY_EN.md`](docs/PHILOSOPHY_EN.md)\n\n---\n\n## License\n\nMaker Core is licensed under the **GNU Affero General Public License v3.0 (AGPL-3.0)**.\n\n- You may use, study, modify, and redistribute Maker Core.\n- If you modify Maker and run it as a **network service (including SaaS)**,\n  you must provide the **complete corresponding source code**\n  of your running version to users under AGPL-3.0.\n\nThe full license text is available in the [`LICENSE`](LICENSE) file.\n\n---\n\n### Commercial Licensing\n\nIf you wish to:\n\n- Offer Maker as a hosted service **without AGPL source disclosure obligations**\n- Embed Maker into a closed-source commercial product\n- Obtain enterprise support or custom licensing terms\n\nPlease contact us for a separate commercial license.\n\n- Website: https://makelr.com\n- Issues: https://github.com/Salepark/maker/issues\n\n---\n\n### Trademarks\n\n\"Maker\", the Maker logo, and related brand assets are trademarks of the Maker project.\n\nForking and modifying the code is allowed under AGPL-3.0.\nHowever, use of the Maker name and branding in a way that implies official endorsement is not permitted without permission.\n\n---\n\nWe do not sell bots.\nWe build tools for people who build their own automation.\n","path":null,"size_bytes":3718,"size_tokens":null},"LICENSE.md":{"content":"# Maker — Licensing Overview (AGPL-3.0)\n\nCopyright (c) 2026 Maker\n\nMaker **Core** is free software licensed under the **GNU Affero General Public License v3.0 (AGPL-3.0)**.\n\nIn short:\n\n- You may use, study, modify, and redistribute Maker Core.\n- If you modify Maker Core and run it as a **network service (including SaaS)**, you must provide the **complete corresponding source code** of your running version to the users of that service under **AGPL-3.0**.\n\nThe full, official AGPL-3.0 license text is provided in **`LICENSE`** (verbatim).\n\n---\n\n## What this repository covers\n\nThis repository contains **Maker Core**.\n\nEverything inside this repository is covered by **AGPL-3.0**, unless a file explicitly states otherwise.\n\n---\n\n## Commercial licensing\n\nIf you want to do any of the following:\n\n- Offer Maker as a hosted service **without** meeting AGPL obligations,\n- Embed Maker into a closed-source/commercial product,\n- Receive commercial support, custom features, or enterprise terms,\n\nthen you need a **separate commercial license**.\n\nFor commercial licensing inquiries:\n\n- Website: https://makelr.com\n- Issues: https://github.com/Salepark/maker/issues\n\n---\n\n## Trademarks\n\nThe following are **trademarks** and are **not** automatically granted by the AGPL:\n\n- The name \"Maker\"\n- Maker logo and brand assets\n\nYou may not use trademarks in a way that suggests official endorsement or affiliation without permission.\n\nThis does **not** restrict your rights to fork and modify the code under AGPL.\nIt only governs brand usage.\n\n---\n\n## Project philosophy\n\nMaker exists to help individuals design and control their own automation workflows.\n\nWe do not sell bots.\nWe provide tools for people who build their own automation.\n\n---\n\n## See also\n\n- `LICENSE` — GNU Affero General Public License v3.0 (verbatim)\n- `docs/PHILOSOPHY_EN.md` — Maker philosophy document\n","path":null,"size_bytes":1871,"size_tokens":null},"client/src/components/memory-card.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { BookOpen, Plus, Trash2, Loader2, ChevronDown, ChevronUp } from \"lucide-react\";\n\ninterface RuleMemory {\n  id: number;\n  userId: string;\n  scope: string;\n  scopeId: number | null;\n  key: string;\n  valueJson: any;\n  createdAt: string;\n  updatedAt: string;\n}\n\nconst PRESET_KEYS = [\n  \"REPORT_TONE\",\n  \"SUMMARY_LENGTH\",\n  \"LANGUAGE_PREF\",\n  \"EXCLUDE_KEYWORDS\",\n  \"FOCUS_TOPICS\",\n  \"CUSTOM\",\n];\n\ninterface MemoryCardProps {\n  botId: number;\n  t: (key: string) => string;\n  language: string;\n}\n\nexport function MemoryCard({ botId, t, language }: MemoryCardProps) {\n  const { toast } = useToast();\n  const [isAdding, setIsAdding] = useState(false);\n  const [showEffective, setShowEffective] = useState(false);\n  const [editKey, setEditKey] = useState(\"\");\n  const [editValue, setEditValue] = useState(\"\");\n  const [editScope, setEditScope] = useState<\"bot\" | \"global\">(\"bot\");\n\n  const { data: botRules = [], isLoading: loadingBot } = useQuery<RuleMemory[]>({\n    queryKey: [\"/api/memory/rules\", \"bot\", botId],\n    queryFn: () => fetch(`/api/memory/rules?scope=bot&scopeId=${botId}`, { credentials: \"include\" }).then(r => r.json()),\n  });\n\n  const { data: globalRules = [] } = useQuery<RuleMemory[]>({\n    queryKey: [\"/api/memory/rules\", \"global\"],\n    queryFn: () => fetch(`/api/memory/rules?scope=global`, { credentials: \"include\" }).then(r => r.json()),\n  });\n\n  const { data: effectiveRules } = useQuery<Record<string, any>>({\n    queryKey: [\"/api/memory/rules/effective\", botId],\n    queryFn: () => fetch(`/api/memory/rules/effective?botId=${botId}`, { credentials: \"include\" }).then(r => r.json()),\n    enabled: showEffective,\n  });\n\n  const upsertMutation = useMutation({\n    mutationFn: (data: { scope: string; scopeId: number | null; key: string; value: any }) =>\n      apiRequest(\"PUT\", \"/api/memory/rules\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/memory/rules\"] });\n      toast({ title: t(\"memory.saved\") });\n      setIsAdding(false);\n      setEditKey(\"\");\n      setEditValue(\"\");\n    },\n    onError: () => {\n      toast({ title: t(\"memory.saveFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (data: { scope: string; scopeId: number | null; key: string }) =>\n      apiRequest(\"DELETE\", \"/api/memory/rules\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/memory/rules\"] });\n      toast({ title: t(\"memory.deleted\") });\n    },\n    onError: () => {\n      toast({ title: t(\"memory.deleteFailed\"), variant: \"destructive\" });\n    },\n  });\n\n  const handleSave = () => {\n    if (!editKey.trim()) return;\n    let parsedValue: any = editValue;\n    try {\n      parsedValue = JSON.parse(editValue);\n    } catch {\n      // keep as string\n    }\n    upsertMutation.mutate({\n      scope: editScope,\n      scopeId: editScope === \"bot\" ? botId : null,\n      key: editKey.trim().toUpperCase(),\n      value: parsedValue,\n    });\n  };\n\n  const handleDelete = (rule: RuleMemory) => {\n    if (!confirm(t(\"memory.deleteConfirm\"))) return;\n    deleteMutation.mutate({\n      scope: rule.scope,\n      scopeId: rule.scopeId,\n      key: rule.key,\n    });\n  };\n\n  const handleEdit = (rule: RuleMemory) => {\n    setEditKey(rule.key);\n    setEditValue(typeof rule.valueJson === \"string\" ? rule.valueJson : JSON.stringify(rule.valueJson, null, 2));\n    setEditScope(rule.scope as \"bot\" | \"global\");\n    setIsAdding(true);\n  };\n\n  const allRules = [\n    ...botRules.map(r => ({ ...r, _source: \"bot\" as const })),\n    ...globalRules.map(r => ({ ...r, _source: \"global\" as const })),\n  ];\n\n  const ruleKeyLabel = (key: string) => {\n    const i18nKey = `memory.presetKeys.${key}`;\n    const translated = t(i18nKey);\n    return translated !== i18nKey ? translated : key;\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n        <div>\n          <CardTitle className=\"flex items-center gap-2\">\n            <BookOpen className=\"h-5 w-5\" />\n            {t(\"memory.title\")}\n          </CardTitle>\n          <CardDescription className=\"mt-1\">\n            {t(\"memory.subtitle\")}\n          </CardDescription>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          {allRules.length > 0 && (\n            <Badge variant=\"secondary\" data-testid=\"badge-rule-count\">\n              {t(\"memory.ruleCount\").replace(\"{{count}}\", String(allRules.length))}\n            </Badge>\n          )}\n          <Button\n            size=\"icon\"\n            variant=\"ghost\"\n            onClick={() => { setIsAdding(!isAdding); setEditKey(\"\"); setEditValue(\"\"); }}\n            data-testid=\"button-add-rule\"\n          >\n            <Plus className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent className=\"grid gap-3\">\n        {isAdding && (\n          <div className=\"grid gap-3 p-3 rounded-md border\" data-testid=\"form-add-rule\">\n            <div className=\"grid gap-2\">\n              <Label>{t(\"memory.key\")}</Label>\n              <Select value={PRESET_KEYS.includes(editKey) ? editKey : \"CUSTOM\"} onValueChange={(v) => setEditKey(v === \"CUSTOM\" ? editKey : v)}>\n                <SelectTrigger data-testid=\"select-rule-key\">\n                  <SelectValue placeholder={t(\"memory.keyPlaceholder\")} />\n                </SelectTrigger>\n                <SelectContent>\n                  {PRESET_KEYS.map((k) => (\n                    <SelectItem key={k} value={k}>{ruleKeyLabel(k)}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              {(!PRESET_KEYS.includes(editKey) || editKey === \"CUSTOM\") && (\n                <Input\n                  value={editKey === \"CUSTOM\" ? \"\" : editKey}\n                  onChange={(e) => setEditKey(e.target.value)}\n                  placeholder={t(\"memory.keyPlaceholder\")}\n                  data-testid=\"input-custom-key\"\n                />\n              )}\n            </div>\n            <div className=\"grid gap-2\">\n              <Label>{t(\"memory.value\")}</Label>\n              <Textarea\n                value={editValue}\n                onChange={(e) => setEditValue(e.target.value)}\n                placeholder={t(\"memory.valuePlaceholder\")}\n                rows={3}\n                data-testid=\"input-rule-value\"\n              />\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Select value={editScope} onValueChange={(v) => setEditScope(v as \"bot\" | \"global\")}>\n                <SelectTrigger className=\"w-32\" data-testid=\"select-rule-scope\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"bot\">{t(\"memory.scope.bot\")}</SelectItem>\n                  <SelectItem value=\"global\">{t(\"memory.scope.global\")}</SelectItem>\n                </SelectContent>\n              </Select>\n              <span className=\"text-xs text-muted-foreground flex-1\">\n                {editScope === \"global\" ? t(\"memory.globalLabel\") : t(\"memory.botLabel\")}\n              </span>\n              <Button size=\"sm\" onClick={handleSave} disabled={upsertMutation.isPending || !editKey.trim()} data-testid=\"button-save-rule\">\n                {upsertMutation.isPending && <Loader2 className=\"h-4 w-4 animate-spin mr-1\" />}\n                {t(\"memory.addRule\")}\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {loadingBot ? (\n          <div className=\"flex justify-center p-4\">\n            <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n          </div>\n        ) : allRules.length === 0 && !isAdding ? (\n          <div className=\"text-center py-4\" data-testid=\"text-memory-empty\">\n            <p className=\"text-sm text-muted-foreground\">{t(\"memory.empty\")}</p>\n            <p className=\"text-xs text-muted-foreground mt-1\">{t(\"memory.emptyHint\")}</p>\n          </div>\n        ) : (\n          <div className=\"grid gap-2\">\n            {allRules.map((rule) => (\n              <div\n                key={`${rule.scope}-${rule.key}`}\n                className=\"flex items-start justify-between gap-2 p-2 rounded-md border\"\n                data-testid={`rule-item-${rule.key}`}\n              >\n                <div className=\"min-w-0 flex-1\">\n                  <div className=\"flex items-center gap-1.5 flex-wrap\">\n                    <span className=\"text-sm font-medium\">{ruleKeyLabel(rule.key)}</span>\n                    <Badge variant=\"secondary\">\n                      {t(`memory.scope.${rule._source}`)}\n                    </Badge>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-1 break-words\">\n                    {typeof rule.valueJson === \"string\" ? rule.valueJson : JSON.stringify(rule.valueJson)}\n                  </p>\n                </div>\n                <div className=\"flex items-center gap-1 shrink-0\">\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => handleEdit(rule)}\n                    data-testid={`button-edit-rule-${rule.key}`}\n                  >\n                    <BookOpen className=\"h-3.5 w-3.5\" />\n                  </Button>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => handleDelete(rule)}\n                    disabled={deleteMutation.isPending}\n                    data-testid={`button-delete-rule-${rule.key}`}\n                  >\n                    <Trash2 className=\"h-3.5 w-3.5\" />\n                  </Button>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"justify-start gap-1\"\n          onClick={() => setShowEffective(!showEffective)}\n          data-testid=\"button-toggle-effective\"\n        >\n          {showEffective ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n          {t(\"memory.effectiveRules\")}\n        </Button>\n\n        {showEffective && effectiveRules && (\n          <div className=\"p-3 rounded-md border\" data-testid=\"panel-effective-rules\">\n            <p className=\"text-xs text-muted-foreground mb-2\">{t(\"memory.effectiveHint\")}</p>\n            {Object.entries(effectiveRules).length === 0 ? (\n              <p className=\"text-xs text-muted-foreground\">{t(\"memory.empty\")}</p>\n            ) : (\n              <div className=\"grid gap-1\">\n                {Object.entries(effectiveRules).map(([key, val]) => (\n                  <div key={key} className=\"flex items-center gap-2 text-xs\">\n                    <span className=\"font-medium\">{ruleKeyLabel(key)}:</span>\n                    <span className=\"text-muted-foreground break-words\">\n                      {typeof val === \"string\" ? val : JSON.stringify(val)}\n                    </span>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":11704,"size_tokens":null},"server/adapters/telegram.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { storage } from \"../storage\";\nimport { processMessage, processConfirm } from \"../chat/chatEngine\";\n\nimport crypto from \"crypto\";\n\nconst TELEGRAM_API = \"https://api.telegram.org/bot\";\n\nfunction getBotToken(): string | null {\n  return process.env.TELEGRAM_BOT_TOKEN || null;\n}\n\nfunction getWebhookSecret(): string {\n  const token = getBotToken();\n  if (!token) return \"\";\n  return crypto.createHash(\"sha256\").update(token).digest(\"hex\").substring(0, 32);\n}\n\nasync function sendTelegramMessage(chatId: string, text: string, replyMarkup?: any): Promise<void> {\n  const token = getBotToken();\n  if (!token) return;\n\n  const body: any = {\n    chat_id: chatId,\n    text: text.substring(0, 4096),\n    parse_mode: \"Markdown\",\n  };\n  if (replyMarkup) {\n    body.reply_markup = JSON.stringify(replyMarkup);\n  }\n\n  try {\n    const resp = await fetch(`${TELEGRAM_API}${token}/sendMessage`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(body),\n    });\n    if (!resp.ok) {\n      const errBody = await resp.text();\n      console.error(\"[Telegram] sendMessage failed:\", resp.status, errBody);\n      const retryBody = { ...body, parse_mode: undefined };\n      await fetch(`${TELEGRAM_API}${token}/sendMessage`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(retryBody),\n      });\n    }\n  } catch (err) {\n    console.error(\"[Telegram] sendMessage error:\", err);\n  }\n}\n\nasync function answerCallbackQuery(callbackQueryId: string, text?: string): Promise<void> {\n  const token = getBotToken();\n  if (!token) return;\n\n  try {\n    await fetch(`${TELEGRAM_API}${token}/answerCallbackQuery`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ callback_query_id: callbackQueryId, text }),\n    });\n  } catch (err) {\n    console.error(\"[Telegram] answerCallbackQuery error:\", err);\n  }\n}\n\nconst pendingConfirmations = new Map<string, { userId: string; threadId: number; pendingMessageId: number; expiresAt: number }>();\n\nasync function handleLinkCommand(chatId: string, username: string | undefined, code: string): Promise<void> {\n  if (!code) {\n    await sendTelegramMessage(chatId,\n      \"Usage: `/link YOUR_CODE`\\n\\nGenerate a link code from Maker Settings page, then send it here.\");\n    return;\n  }\n\n  const result = await storage.consumeLinkCode(code.trim().toUpperCase());\n  if (!result) {\n    await sendTelegramMessage(chatId, \"Invalid or expired code. Please generate a new one from Maker Settings.\");\n    return;\n  }\n\n  if (result.platform !== \"telegram\") {\n    await sendTelegramMessage(chatId, \"This code is not for Telegram linking.\");\n    return;\n  }\n\n  const thread = await storage.createThread(result.userId, \"Telegram Chat\");\n\n  await storage.createTelegramLink({\n    userId: result.userId,\n    telegramChatId: chatId,\n    telegramUsername: username,\n    threadId: thread.id,\n  });\n\n  await sendTelegramMessage(chatId,\n    \"Account linked successfully! You can now control your Maker bots from here.\\n\\nTry: `봇 목록` or `list bots`\");\n}\n\nasync function handleUnlinkCommand(chatId: string): Promise<void> {\n  const link = await storage.getTelegramLinkByChatId(chatId);\n  if (!link) {\n    await sendTelegramMessage(chatId, \"No linked account found.\");\n    return;\n  }\n  await storage.deleteTelegramLink(link.userId);\n  await sendTelegramMessage(chatId, \"Account unlinked. Send `/link CODE` to link again.\");\n}\n\nasync function handleTextMessage(chatId: string, text: string): Promise<void> {\n  const link = await storage.getTelegramLinkByChatId(chatId);\n  if (!link) {\n    await sendTelegramMessage(chatId,\n      \"Please link your Maker account first.\\n\\n1. Go to Maker Settings → Telegram\\n2. Generate a link code\\n3. Send `/link YOUR_CODE` here\");\n    return;\n  }\n\n  try {\n    const response = await processMessage({\n      userId: link.userId,\n      threadId: link.threadId!,\n      text,\n    });\n\n    if (response.mode === \"confirm\" && response.pendingMessageId) {\n      const key = `${chatId}_${response.pendingMessageId}`;\n      pendingConfirmations.set(key, {\n        userId: link.userId,\n        threadId: link.threadId!,\n        pendingMessageId: response.pendingMessageId,\n        expiresAt: Date.now() + 5 * 60 * 1000,\n      });\n\n      await sendTelegramMessage(chatId, response.message, {\n        inline_keyboard: [[\n          { text: \"Confirm\", callback_data: `confirm_${response.pendingMessageId}` },\n          { text: \"Cancel\", callback_data: `cancel_${response.pendingMessageId}` },\n        ]],\n      });\n    } else {\n      await sendTelegramMessage(chatId, response.message);\n    }\n  } catch (err: any) {\n    console.error(\"[Telegram] processMessage error:\", err);\n    await sendTelegramMessage(chatId, \"An error occurred processing your message. Please try again.\");\n  }\n}\n\nasync function handleCallbackQuery(chatId: string, callbackQueryId: string, data: string): Promise<void> {\n  const link = await storage.getTelegramLinkByChatId(chatId);\n  if (!link) {\n    await answerCallbackQuery(callbackQueryId, \"Not linked\");\n    return;\n  }\n\n  const match = data.match(/^(confirm|cancel)_(\\d+)$/);\n  if (!match) {\n    await answerCallbackQuery(callbackQueryId, \"Unknown action\");\n    return;\n  }\n\n  const action = match[1];\n  const pendingMessageId = parseInt(match[2], 10);\n  const approve = action === \"confirm\";\n\n  const key = `${chatId}_${pendingMessageId}`;\n  const pending = pendingConfirmations.get(key);\n\n  if (!pending || pending.expiresAt < Date.now()) {\n    pendingConfirmations.delete(key);\n    await answerCallbackQuery(callbackQueryId, \"Expired or already handled\");\n    return;\n  }\n\n  pendingConfirmations.delete(key);\n\n  try {\n    const response = await processConfirm(link.userId, link.threadId!, pendingMessageId, approve);\n    await answerCallbackQuery(callbackQueryId, approve ? \"Confirmed\" : \"Cancelled\");\n    await sendTelegramMessage(chatId, response.message);\n  } catch (err: any) {\n    console.error(\"[Telegram] processConfirm error:\", err);\n    await answerCallbackQuery(callbackQueryId, \"Error processing\");\n    await sendTelegramMessage(chatId, \"An error occurred. Please try again.\");\n  }\n}\n\nexport function registerTelegramWebhook(app: Express): void {\n  const token = getBotToken();\n  if (!token) {\n    console.log(\"[Telegram] No TELEGRAM_BOT_TOKEN set, skipping webhook registration\");\n    return;\n  }\n\n  app.post(\"/api/telegram/webhook\", async (req: Request, res: Response) => {\n    try {\n      const secret = getWebhookSecret();\n      if (secret) {\n        const headerToken = req.headers[\"x-telegram-bot-api-secret-token\"];\n        if (headerToken !== secret) {\n          return res.sendStatus(403);\n        }\n      }\n\n      const update = req.body;\n\n      if (update.message) {\n        const msg = update.message;\n        const chatId = String(msg.chat.id);\n        const text = msg.text || \"\";\n        const username = msg.from?.username;\n\n        if (text.startsWith(\"/start\")) {\n          await sendTelegramMessage(chatId,\n            \"Welcome to Maker Bot Manager!\\n\\nLink your account:\\n1. Go to Maker Settings → Telegram\\n2. Click 'Generate Link Code'\\n3. Send `/link YOUR_CODE` here\");\n        } else if (text.startsWith(\"/link\")) {\n          const code = text.replace(\"/link\", \"\").trim();\n          await handleLinkCommand(chatId, username, code);\n        } else if (text.startsWith(\"/unlink\")) {\n          await handleUnlinkCommand(chatId);\n        } else if (text.startsWith(\"/help\")) {\n          await sendTelegramMessage(chatId,\n            \"*Maker Bot Commands*\\n\\n\" +\n            \"`/link CODE` — Link Maker account\\n\" +\n            \"`/unlink` — Unlink account\\n\" +\n            \"`/help` — Show this help\\n\\n\" +\n            \"*Bot commands (after linking):*\\n\" +\n            \"• `list bots` / `봇 목록`\\n\" +\n            \"• `run now` / `지금 실행`\\n\" +\n            \"• `status` / `상태`\\n\" +\n            \"• `pause` / `일시정지`\\n\" +\n            \"• `resume` / `재개`\\n\" +\n            \"• Any natural language command!\");\n        } else if (text.length > 0) {\n          await handleTextMessage(chatId, text);\n        }\n      }\n\n      if (update.callback_query) {\n        const cb = update.callback_query;\n        const chatId = String(cb.message?.chat?.id || \"\");\n        if (chatId) {\n          await handleCallbackQuery(chatId, cb.id, cb.data || \"\");\n        }\n      }\n\n      res.sendStatus(200);\n    } catch (err) {\n      console.error(\"[Telegram] webhook error:\", err);\n      res.sendStatus(200);\n    }\n  });\n\n  console.log(\"[Telegram] Webhook endpoint registered at /api/telegram/webhook\");\n}\n\nexport async function setupTelegramWebhook(): Promise<void> {\n  const token = getBotToken();\n  if (!token) return;\n\n  const baseUrl = process.env.APP_BASE_URL || process.env.REPLIT_DEV_DOMAIN;\n  if (!baseUrl) {\n    console.log(\"[Telegram] No APP_BASE_URL set, cannot register webhook with Telegram\");\n    return;\n  }\n\n  const url = baseUrl.startsWith(\"http\") ? baseUrl : `https://${baseUrl}`;\n  const webhookUrl = `${url}/api/telegram/webhook`;\n\n  try {\n    const resp = await fetch(`${TELEGRAM_API}${token}/setWebhook`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ url: webhookUrl, secret_token: getWebhookSecret() }),\n    });\n    const result = await resp.json();\n    console.log(\"[Telegram] Webhook setup result:\", result);\n  } catch (err) {\n    console.error(\"[Telegram] Failed to set webhook:\", err);\n  }\n}\n\nsetInterval(() => {\n  const now = Date.now();\n  for (const [key, val] of pendingConfirmations.entries()) {\n    if (val.expiresAt < now) {\n      pendingConfirmations.delete(key);\n    }\n  }\n}, 60 * 1000);\n","path":null,"size_bytes":9806,"size_tokens":null},"server/chat/chatEngine.ts":{"content":"import { parseCommand } from \"./command-parser\";\nimport { routeCommand, execPipelineRun } from \"./commandRouter\";\nimport { storage } from \"../storage\";\n\nexport interface ChatEngineRequest {\n  userId: string;\n  threadId: number;\n  text: string;\n}\n\nexport interface ChatEngineResponse {\n  ok: boolean;\n  mode: \"clarification\" | \"confirm\" | \"executed\";\n  message: string;\n  pendingMessageId?: number;\n  confirmText?: string;\n  command?: any;\n  result?: any;\n}\n\nexport async function processMessage(req: ChatEngineRequest): Promise<ChatEngineResponse> {\n  const { userId, threadId, text } = req;\n\n  await storage.addThreadMessage({\n    threadId,\n    userId,\n    role: \"user\",\n    contentText: text,\n    kind: \"text\",\n  });\n\n  const userBots = await storage.listBots(userId);\n  const thread = await storage.getThread(threadId, userId);\n  let activeBotKey: string | null = null;\n  if (thread?.activeBotId) {\n    const activeBot = userBots.find(b => b.id === thread.activeBotId);\n    activeBotKey = activeBot?.key || null;\n  }\n\n  const parseResult = await parseCommand(text, {\n    activeBotKey,\n    availableBotKeys: userBots.map(b => b.key),\n  });\n\n  const { command, clarificationNeeded, clarificationText } = parseResult;\n\n  if (clarificationNeeded) {\n    await storage.addThreadMessage({\n      threadId,\n      userId,\n      role: \"assistant\",\n      contentText: clarificationText || \"Could you be more specific?\",\n      kind: \"text\",\n    });\n    return {\n      ok: true,\n      mode: \"clarification\",\n      message: clarificationText || \"Could you be more specific?\",\n    };\n  }\n\n  if (command.needsConfirm && command.type !== \"chat\") {\n    const confirmMsg = await storage.addThreadMessage({\n      threadId,\n      userId,\n      role: \"assistant\",\n      contentText: command.confirmText || `Run '${command.type}'?`,\n      kind: \"pending_command\",\n      commandJson: command,\n      status: \"pending_confirm\",\n    });\n    return {\n      ok: true,\n      mode: \"confirm\",\n      message: command.confirmText || `Run '${command.type}'?`,\n      pendingMessageId: confirmMsg.id,\n      confirmText: command.confirmText,\n      command,\n    };\n  }\n\n  const result = await routeCommand(userId, command, threadId);\n\n  await storage.addThreadMessage({\n    threadId,\n    userId,\n    role: \"assistant\",\n    contentText: result.assistantMessage,\n    kind: \"command_result\",\n    commandJson: result.executed,\n    resultJson: result.result,\n  });\n\n  return {\n    ok: result.ok,\n    mode: \"executed\",\n    message: result.assistantMessage,\n    result: result.result,\n  };\n}\n\nexport async function processConfirm(userId: string, threadId: number, pendingMessageId: number, approve: boolean): Promise<ChatEngineResponse> {\n  const messages = await storage.listThreadMessages(threadId, userId, 200);\n  const pendingMsg = messages.find(m => m.id === pendingMessageId && m.status === \"pending_confirm\");\n\n  if (!pendingMsg) {\n    return { ok: false, mode: \"executed\", message: \"Pending confirmation not found or already resolved.\" };\n  }\n\n  await storage.updateChatMessageStatus(pendingMessageId, userId, approve ? \"confirmed\" : \"cancelled\");\n\n  if (!approve) {\n    await storage.addThreadMessage({\n      threadId,\n      userId,\n      role: \"assistant\",\n      contentText: \"Cancelled.\",\n      kind: \"text\",\n    });\n    return { ok: true, mode: \"executed\", message: \"Cancelled.\" };\n  }\n\n  const command = pendingMsg.commandJson as any;\n\n  if (command.type === \"pipeline_run\") {\n    const stepMessages: string[] = [];\n    const result = await execPipelineRun(userId, command, async (step) => {\n      await storage.addThreadMessage({\n        threadId,\n        userId,\n        role: \"assistant\",\n        contentText: step.message,\n        kind: \"pipeline_step\",\n        resultJson: step,\n      });\n      stepMessages.push(step.message);\n    });\n    return {\n      ok: result.ok,\n      mode: \"executed\",\n      message: stepMessages.length > 0 ? stepMessages.join(\"\\n\") : result.assistantMessage,\n      result: result.result,\n    };\n  }\n\n  const result = await routeCommand(userId, command, threadId);\n\n  await storage.addThreadMessage({\n    threadId,\n    userId,\n    role: \"assistant\",\n    contentText: result.assistantMessage,\n    kind: \"command_result\",\n    commandJson: result.executed,\n    resultJson: result.result,\n  });\n\n  return {\n    ok: result.ok,\n    mode: \"executed\",\n    message: result.assistantMessage,\n    result: result.result,\n  };\n}\n","path":null,"size_bytes":4417,"size_tokens":null}},"version":2}