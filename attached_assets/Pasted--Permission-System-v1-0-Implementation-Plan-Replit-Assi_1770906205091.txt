# Permission System v1.0 â€” Implementation Plan (Replit Assistant ë³µë¶™ìš©)
í”„ë¡œì íŠ¸: ë©”ì´ì»¤(=Makelr) ë¡œì»¬/ì›¹ ê³µí†µ ê¶Œí•œ ì‹œìŠ¤í…œ v1.0
ëª©í‘œ: ê¸°ì¡´ RSS/LLM/Console íŒŒì´í”„ë¼ì¸ì— â€œê¶Œí•œ ì •ì±… ì—”ì§„(Policy Engine)â€ì„ ì‚½ì…í•´
- ìµœì†Œ ê¶Œí•œ ì›ì¹™(ê¸°ë³¸ OFF)
- ìŠ¹ì¸ ê¸°ë°˜ ì‹¤í–‰(Approval Mode)
- ë°ì´í„° ì™¸ë¶€ ë°˜ì¶œ(LLM Egress) ì œì–´
- ê°ì‚¬ ë¡œê·¸(Audit Log)
ì„ ì¼ê´€ë˜ê²Œ ì ìš©í•œë‹¤.

---
## 0) ë²”ìœ„(ì´ë²ˆ v1.0ì—ì„œ í•˜ëŠ” ê²ƒ / í•˜ì§€ ì•ŠëŠ” ê²ƒ)
### v1.0ì— í¬í•¨ âœ…
- ì „ì—­(Global) + ë´‡(Bot) ë‹¨ìœ„ ê¶Œí•œ(override merge)
- Permission CRUD API + Settings UI(ê·¸ë£¹ ì¹´ë“œ/í† ê¸€)
- Policy Engine(ê¶Œí•œ ì²´í¬ ìœ í‹¸) + ê¸°ì¡´ ì‹¤í–‰ ê²½ë¡œ(RSS/LLM/íŒŒì´í”„ë¼ì¸)ì— ì²´í¬ ì‚½ì…
- Audit Log í…Œì´ë¸” + ê¸°ë¡(ê¶Œí•œ ë³€ê²½, ìŠ¹ì¸/ê±°ì ˆ, ê±°ë¶€/ì°¨ë‹¨)
- LLM_EGRESS_LEVEL: 3ë‹¨ê³„ë§Œ ì œê³µ
  - NO_EGRESS
  - METADATA_ONLY
  - FULL_CONTENT_ALLOWED

### v1.1ë¡œ ë¯¸ë£¸ â­
- ìŠ¤ë ˆë“œ ë‹¨ìœ„ ì„ì‹œ ê¶Œí•œ í† í°(time-limited)
- REDACTED_CONTENT_ONLY(ë§ˆìŠ¤í‚¹/NER í•„ìš”)
- â€œìˆ˜ì • í›„ ì‹¤í–‰(Edit then Run)â€ ìŠ¹ì¸ UX

### ê°•ì œ ì •ì±…(ì•ˆì „) ğŸ”’
- FS_DELETEëŠ” TRASH_ONLYë§Œ í—ˆìš© (PERMANENT_DELETEëŠ” ìŠ¤í‚¤ë§ˆ/ì½”ë“œ/UXì—ì„œ ì œê±°)

---
## 1) ë°ì´í„° ëª¨ë¸(ìŠ¤í‚¤ë§ˆ) â€” permissions + audit_log
### 1-1) permissions í…Œì´ë¸” ì„¤ê³„
- scope: "global" | "bot"
- scopeId: globalì´ë©´ null, botì´ë©´ botId
- permissionKey: ë¬¸ìì—´ í‚¤ (ì˜ˆ: "LLM_USE", "LLM_EGRESS", "WEB_RSS", "WEB_FETCH", "FS_READ", "FS_WRITE", "CAL_READ", "CAL_WRITE")
- valueJson: JSON (ê¶Œí•œê°’/ìŠ¹ì¸ëª¨ë“œ/ë¦¬ì†ŒìŠ¤ ë²”ìœ„ í¬í•¨)
- updatedAt

ê¶Œí•œ JSON í˜•íƒœ(í‘œì¤€):
{
  "enabled": boolean,
  "approvalMode": "AUTO_ALLOWED" | "APPROVAL_REQUIRED" | "AUTO_DENIED",
  "resourceScope": { ... } // ì„ íƒ: í—ˆìš© ê²½ë¡œ/ë„ë©”ì¸/ìº˜ë¦°ë”ID ë“±
}

### 1-2) audit_log í…Œì´ë¸”(ê¶Œì¥)
- id
- userId
- botId (nullable)
- threadId (nullable)
- eventType: "PERMISSION_UPDATED" | "APPROVAL_GRANTED" | "APPROVAL_DENIED" | "PERMISSION_BLOCKED" | "EGRESS_BLOCKED"
- permissionKey (nullable)
- payloadJson (json)  // before/after, reason, command, resource
- createdAt

### 1-3) Drizzle ìŠ¤í‚¤ë§ˆ íŒŒì¼ ìˆ˜ì •
- shared/schema.ts (pg) ë° shared/schema.sqlite.ts (sqlite) ëª¨ë‘ì— ë™ì¼í•˜ê²Œ ì¶”ê°€
- ë§ˆì´ê·¸ë ˆì´ì…˜/ì´ˆê¸°í™”/seedì— ë°˜ì˜

---
## 2) Policy Engine (ì„œë²„ ìœ í‹¸) â€” í•µì‹¬
### 2-1) íŒŒì¼ ì¶”ê°€
- server/policy/types.ts
- server/policy/engine.ts

### 2-2) í•µì‹¬ í•¨ìˆ˜ ì •ì˜
- getEffectivePermissions(userId, botId?): ì „ì—­+ë´‡ ê¶Œí•œì„ mergeí•´ì„œ ìµœì¢… ì •ì±… ìƒì„±
  - globalì„ ê¸°ë³¸ìœ¼ë¡œ, bot scopeê°€ ìˆìœ¼ë©´ ê°™ì€ permissionKeyë¥¼ override
- checkPermission(ctx, permissionKey, resource?): { allowed, requiresApproval, reason, effectivePolicy }
- checkEgress(ctx, egressLevelNeeded, contentKind): { allowed, reason }
  - egressLevelNeeded: "NO_EGRESS" | "METADATA_ONLY" | "FULL_CONTENT_ALLOWED"

ctx ìµœì†Œ êµ¬ì„±:
{
  userId,
  botId?,
  threadId?,
  commandId?,
  action: "collect" | "analyze" | "report" | "schedule" | "add_source" | "remove_source" | "fs_read" | ...
}

### 2-3) ê¸°ë³¸ ì •ì±…(Seed)
- ëª¨ë“  ë¯¼ê° ê¶Œí•œ ê¸°ë³¸ OFF / AUTO_DENIED
- WEB_RSSëŠ” ON + AUTO_ALLOWED (ê¸°ë³¸ ìˆ˜ì§‘ ê°€ëŠ¥)
- LLM_USEëŠ” ON but EGRESS=METADATA_ONLY + APPROVAL_REQUIRED (ê¸°ë³¸ ì•ˆì „)
- CAL_READëŠ” OFF
- FS_READ/WRITEëŠ” OFF

---
## 3) Storage ë ˆì´ì–´ í™•ì¥
### 3-1) IStorage ë©”ì„œë“œ ì¶”ê°€
- listPermissions(scope, scopeId, userId)
- upsertPermission(scope, scopeId, userId, permissionKey, valueJson)
- deletePermission(...)
- listAuditLogs(filter)
- createAuditLog(entry)

### 3-2) PostgresStorage + SqliteStorage êµ¬í˜„
- ê¸°ì¡´ íŒ¨í„´ ê·¸ëŒ€ë¡œ ì¶”ê°€ êµ¬í˜„
- SQLiteë„ ë™ì¼í•˜ê²Œ ë™ì‘í•´ì•¼ í•¨

---
## 4) API Routes ì¶”ê°€
### 4-1) Permissions API
- GET /api/permissions/global
- PUT /api/permissions/global/:permissionKey
- GET /api/bots/:botId/permissions
- PUT /api/bots/:botId/permissions/:permissionKey
- DELETE (optional) â€” override ì œê±°(=ì „ì—­ìœ¼ë¡œ fallback)

### 4-2) Audit API (ê´€ë¦¬/ë””ë²„ê·¸)
- GET /api/audit?botId=&threadId=&limit=

ëª¨ë“  ë³€ê²½ ìš”ì²­ì€ audit_logì— ê¸°ë¡:
- before/after diff í¬í•¨

---
## 5) ê¸°ì¡´ ì‹¤í–‰ ê²½ë¡œì— ê¶Œí•œ ì²´í¬ ì‚½ì…(ê°€ì¥ ì¤‘ìš”)
### 5-1) RSS ìˆ˜ì§‘(collect)
- WEB_RSS enabled ì²´í¬
- source ì¶”ê°€/ì‚­ì œ ì‹œ WEB_RSS + add/remove ìŠ¹ì¸ í•„ìš” ì—¬ë¶€ ë°˜ì˜
- ìŠ¹ì¸ í•„ìš”ë©´ â€œpending commandâ€ë¡œ ì „í™˜(ê¸°ì¡´ ì½˜ì†” ìŠ¹ì¸ ì‹œìŠ¤í…œ ì¬ì‚¬ìš©)

### 5-2) LLM í˜¸ì¶œ(analyze/report/draft)
- LLM_USE enabled ì²´í¬
- LLM_EGRESS_LEVELì— ë”°ë¼ payload êµ¬ì„± ë³€ê²½:
  - NO_EGRESS: AI í˜¸ì¶œ ê¸ˆì§€ â†’ ìƒíƒœ ë¦¬í¬íŠ¸/ëŒ€ì²´ ë¡œì§
  - METADATA_ONLY: title/url/sourceName/snippet(ì§§ê²Œ)ë§Œ ì „ë‹¬
  - FULL_CONTENT_ALLOWED: full contentText ì „ë‹¬ ê°€ëŠ¥
- EGRESS ì°¨ë‹¨/ê±°ë¶€ëŠ” audit_logì— EGRESS_BLOCKEDë¡œ ê¸°ë¡

### 5-3) schedule ë³€ê²½(ë§¤ì¼ 9ì‹œ ë¸Œë¦¬í•‘ ë“±)
- SCHEDULE_WRITE permissionKey (ìƒˆë¡œ ì •ì˜)ë¡œ ì œì–´
- approvalModeê°€ REQUIREDë©´ ìŠ¹ì¸ íë¦„ ì ìš©

### 5-4) Console command router
- ê¸°ì¡´ commandRouter.tsì— â€œpermission check wrapperâ€ë¥¼ ì¶”ê°€:
  - ê° action ì‹¤í–‰ ì „ì— checkPermission í˜¸ì¶œ
  - requiresApprovalë©´ pendingìœ¼ë¡œ ì „í™˜(ì´ë¯¸ êµ¬í˜„ëœ confirm UX ì‚¬ìš©)
  - deniedë©´ ì‚¬ìš©ìì—ê²Œ ì´ìœ ë¥¼ ì¹œì ˆí•˜ê²Œ ë°˜í™˜ + audit_log ê¸°ë¡

---
## 6) UI â€” Settings í˜ì´ì§€ì— ê¶Œí•œ ì¹´ë“œ ì¶”ê°€
### 6-1) UX ëª©í‘œ
- â€œê¸°ëŠ¥ ìŠ¤ìœ„ì¹˜ + ìŠ¹ì¸ ë°©ì‹ + ë²”ìœ„â€ë¥¼ í•œ í™”ë©´ì—ì„œ ì¡°ì ˆ
- ì „ì—­(Global) ê¸°ë³¸ê°’ + ë´‡ë³„ Override íƒ­(ë˜ëŠ” í† ê¸€)
- ê¸°ë³¸ì€ ë‹¨ìˆœ ëª¨ë“œ: On/Off + ìŠ¹ì¸(ìë™/ìŠ¹ì¸í•„ìš”/ì°¨ë‹¨)
- ê³ ê¸‰ì€ í¼ì¹˜ê¸°: resourceScope (í—ˆìš© í´ë”, ë„ë©”ì¸, ìº˜ë¦°ë”)

### 6-2) í˜ì´ì§€ êµ¬ì„± ì œì•ˆ
Settings > Permissions
- Group 1: Web & Sources (WEB_RSS, WEB_FETCH, SOURCE_WRITE)
- Group 2: AI & Data (LLM_USE, LLM_EGRESS_LEVEL)
- Group 3: Files (FS_READ, FS_WRITE, FS_DELETE[TRASH_ONLY])
- Group 4: Calendar (CAL_READ, CAL_WRITE)
- Group 5: Scheduling (SCHEDULE_WRITE)

ë´‡ ìƒì„¸(Bot Detail)ì— â€œì´ ë´‡ ê¶Œí•œ(Override)â€ ì¹´ë“œ ì¶”ê°€:
- ì „ì—­ê°’ í‘œì‹œ + override ì¼œë©´ bot-level ì €ì¥

---
## 7) í…ŒìŠ¤íŠ¸(í•„ìˆ˜)
- ê¶Œí•œ OFF ìƒíƒœì—ì„œ: collect/report ìˆ˜í–‰ â†’ ê±°ë¶€ + ì•ˆë‚´ + audit ê¸°ë¡
- METADATA_ONLYì—ì„œ: LLM payloadì— contentTextê°€ í¬í•¨ë˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
- FULL_CONTENT_ALLOWEDì—ì„œ: contentText í¬í•¨ í™•ì¸
- approval required ì‹œ: pending â†’ confirm í›„ ì‹¤í–‰ í™•ì¸
- SQLite/PG ë‘˜ ë‹¤ í†µê³¼

---
## 8) ì‹¤í–‰ ìˆœì„œ(ì´ ìˆœì„œ ê³ ì •)
1) ìŠ¤í‚¤ë§ˆ ì¶”ê°€: permissions + audit_log (pg/sqlite)
2) Storage ë©”ì„œë“œ ì¶”ê°€/êµ¬í˜„
3) Policy Engine êµ¬í˜„ + merge ë¡œì§
4) API routes êµ¬í˜„
5) ì‹¤í–‰ ê²½ë¡œ(RSS/LLM/Console)ì— policy check ì‚½ì…
6) Settings UI êµ¬í˜„(ì „ì—­ + ë´‡ override)
7) í…ŒìŠ¤íŠ¸ + ë¬¸ì„œ ì—…ë°ì´íŠ¸(replit.mdì— ê¶Œí•œ ì •ì±… ì„¹ì…˜ ì¶”ê°€)

---
## Done Definition
- ì „ì—­/ë´‡ ê¶Œí•œ ì €ì¥/ì¡°íšŒ/ë³€ê²½ ê°€ëŠ¥
- ì½˜ì†” ëª…ë ¹/ìŠ¤ì¼€ì¤„/ë¦¬í¬íŠ¸ê°€ ê¶Œí•œ ì •ì±…ì— ë”°ë¼
  - ì¦‰ì‹œ ì‹¤í–‰ / ìŠ¹ì¸ ìš”ì²­ / ì°¨ë‹¨
  ì„ ì •í™•íˆ ìˆ˜í–‰
- LLM egress ë ˆë²¨ì´ ì‹¤ì œ payloadì— ë°˜ì˜ë¨
- audit_logì— ì¤‘ìš”í•œ ì´ë²¤íŠ¸ê°€ ë‚¨ìŒ
- SQLite/PG ë‘˜ ë‹¤ ë™ì‘
